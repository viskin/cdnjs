define(["pattern-matcher","inpt-sel","utils"],function(patternMatcher,inptSel,utils){var defaults={persistent:false,repeat:false,placeholder:" "};var inptRegs={9:/[0-9]/,a:/[A-Za-z]/,"*":/[A-Za-z0-9]/};function Formatter(el,opts){var self=this;self.el=el;if(!self.el){throw new TypeError("Must provide an existing element")}self.opts=utils.extend({},defaults,opts);if(typeof self.opts.pattern!=="undefined"){self.opts.patterns=self._specFromSinglePattern(self.opts.pattern);delete self.opts.pattern}if(typeof self.opts.patterns==="undefined"){throw new TypeError("Must provide a pattern or array of patterns")}self.patternMatcher=patternMatcher(self.opts.patterns);self._updatePattern();self.hldrs={};self.focus=0;utils.addListener(self.el,"keydown",function(evt){self._keyDown(evt)});utils.addListener(self.el,"keypress",function(evt){self._keyPress(evt)});utils.addListener(self.el,"paste",function(evt){self._paste(evt)});if(self.opts.persistent){self._processKey("",false);self.el.blur();utils.addListener(self.el,"focus",function(evt){self._focus(evt)});utils.addListener(self.el,"click",function(evt){self._focus(evt)});utils.addListener(self.el,"touchstart",function(evt){self._focus(evt)})}}Formatter.addInptType=function(chr,reg){inptRegs[chr]=reg};Formatter.prototype.resetPattern=function(str){this.opts.patterns=str?this._specFromSinglePattern(str):this.opts.patterns;this.sel=inptSel.get(this.el);this.val=this.el.value;this.delta=0;this._removeChars();this.patternMatcher=patternMatcher(this.opts.patterns);var newPattern=this.patternMatcher.getPattern(this.val);this.mLength=newPattern.mLength;this.chars=newPattern.chars;this.inpts=newPattern.inpts;this._processKey("",false,true)};Formatter.prototype._updatePattern=function(){var newPattern=this.patternMatcher.getPattern(this.val);if(newPattern){this.mLength=newPattern.mLength;this.chars=newPattern.chars;this.inpts=newPattern.inpts}};Formatter.prototype._keyDown=function(evt){var k=evt.which||evt.keyCode;if(k&&utils.isDelKey(k)){this._processKey(null,k);return utils.preventDefault(evt)}};Formatter.prototype._keyPress=function(evt){var k,isSpecial;if(evt.which){k=evt.which}else{k=evt.keyCode;isSpecial=utils.isSpecialKey(k)}if(!utils.isDelKey(k)&&!isSpecial&&!utils.isModifier(evt)){this._processKey(String.fromCharCode(k),false);return utils.preventDefault(evt)}};Formatter.prototype._paste=function(evt){this._processKey(utils.getClip(evt),false);return utils.preventDefault(evt)};Formatter.prototype._focus=function(){var self=this;setTimeout(function(){var selection=inptSel.get(self.el);var isAfterStart=selection.end>self.focus,isFirstChar=selection.end===0;if(isAfterStart||isFirstChar){inptSel.set(self.el,self.focus)}},0)};Formatter.prototype._processKey=function(chars,delKey,ingoreCaret){this.sel=inptSel.get(this.el);this.val=this.el.value;this.delta=0;if(this.sel.begin!==this.sel.end){this.delta=-1*Math.abs(this.sel.begin-this.sel.end);this.val=utils.removeChars(this.val,this.sel.begin,this.sel.end)}else if(delKey&&delKey===46){this._delete()}else if(delKey&&this.sel.begin-1>=0){this.delta-=1;while(this.chars[this.focus-1]){this.delta--;this.focus--}this.val=utils.removeChars(this.val,this.sel.end+this.delta,this.sel.end)}else if(delKey){return true}if(!delKey){this.val=utils.addChars(this.val,chars,this.sel.begin);this.delta+=chars.length}this._formatValue(ingoreCaret)};Formatter.prototype._delete=function(){while(this.chars[this.sel.begin]){this._nextPos()}if(this.sel.begin<this.val.length){this._nextPos();this.val=utils.removeChars(this.val,this.sel.end-1,this.sel.end);this.delta=-1}};Formatter.prototype._nextPos=function(){this.sel.end++;this.sel.begin++};Formatter.prototype._formatValue=function(ignoreCaret){this.newPos=this.sel.end+this.delta;this._removeChars();this._updatePattern();this._validateInpts();this._addChars();this.el.value=this.val.substr(0,this.mLength);if(typeof ignoreCaret==="undefined"||ignoreCaret===false){inptSel.set(this.el,this.newPos)}};Formatter.prototype._removeChars=function(){if(this.sel.end>this.focus){this.delta+=this.sel.end-this.focus}var shift=0;for(var i=0;i<=this.mLength;i++){var curChar=this.chars[i],curHldr=this.hldrs[i],pos=i+shift,val;pos=i>=this.sel.begin?pos+this.delta:pos;val=this.val.charAt(pos);if(curChar&&curChar===val||curHldr&&curHldr===val){this.val=utils.removeChars(this.val,pos,pos+1);shift--}}this.hldrs={};this.focus=this.val.length};Formatter.prototype._validateInpts=function(){for(var i=0;i<this.val.length;i++){var inptType=this.inpts[i];var isBadType=!inptRegs[inptType],isInvalid=!isBadType&&!inptRegs[inptType].test(this.val.charAt(i)),inBounds=this.inpts[i];if((isBadType||isInvalid)&&inBounds){this.val=utils.removeChars(this.val,i,i+1);this.focusStart--;this.newPos--;this.delta--;i--}}};Formatter.prototype._addChars=function(){if(this.opts.persistent){for(var i=0;i<=this.mLength;i++){if(!this.val.charAt(i)){this.val=utils.addChars(this.val,this.opts.placeholder,i);this.hldrs[i]=this.opts.placeholder}this._addChar(i)}while(this.chars[this.focus]){this.focus++}}else{for(var j=0;j<=this.val.length;j++){if(this.delta<=0&&j===this.focus&&this.chars[j]===undefined||this.focus===0){return true}this._addChar(j)}}};Formatter.prototype._addChar=function(i){var chr=this.chars[i];if(!chr){return true}if(utils.isBetween(i,[this.sel.begin-1,this.newPos+1])){this.newPos++;this.delta++}if(i<=this.focus){this.focus++}if(this.hldrs[i]){delete this.hldrs[i];this.hldrs[i+1]=this.opts.placeholder}this.val=utils.addChars(this.val,chr,i)};Formatter.prototype._specFromSinglePattern=function(patternStr){return[{"*":patternStr}]};return Formatter});
