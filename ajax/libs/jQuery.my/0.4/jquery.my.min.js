/*
 * jQuery.my 0.4 beta minified. 
 * 
 * (c) ermouth
 * See details at jquerymy.com
 * 
 * Requires jQuery 1.7.1+, SugarJS 1.2.5+
 * 
 */

(function(a){var b=function(a){return a!==null&&a!==undefined};var c="en";var d={vals:{".hasDatepicker":function(a,c){if(b(c))a.datepicker("setDate",e.date8601(c));return e.date8601(a.datepicker("getDate")||new Date)},"input[type=date]":function(c,d){var f=c.val();if(b(d)){f=e.date8601(d);if(a.type(f)=="string"&&!f.has("Invalid")){c.val(f.to(10))}else if(a.type(f)=="date"){c.val(e.date8601(f).to(10))}}var g=f!=""?Date.create(f):Date.create("$@#");return g},"input,button":{"[type='text'],[type='number'],[type='hidden'],[type='password'],[type='button'],[type='range'],:not([type])":{".ui-slider-input":function(a,c){if(b(c))a.val(c).slider("refresh")},".tagstrip input.value":function(a,c){if(b(c))a.val(c).trigger("update")},"":function(a,c){if(b(c))a.val(c)}},":radio":function(c,d){var e=-1;if(b(d)){c.each(function(b){var c=a(this).val();if(String(d)===String(c))e=b});var f=c.eq(0).checkboxradio;if(f){c.each(function(b){var c=a(this);if(e!=b&&c.is(":checked"))c.attr("checked",false).checkboxradio("refresh")})}if(e>-1){var g=c.eq(e);if(!g.is(":checked")){g.attr("checked",true);if(f)g.checkboxradio("refresh")}}else if(!f){c.each(function(){a(this).attr("checked",false)})}}if(e==-1){for(var h=0;h<c.size();h++){if(c.eq(h).is(":checked"))e=h}}return e!=-1?c.eq(e).val():""},":checkbox":function(c,d){var e=-1,f=d,g=[],h={};if(b(f)){if(a.type(f)!="array")f=[d];c.each(function(b){var c=a(this);var d=c.val();if(f.indexOf(d)!=-1){g.push(d);if(!c.is(":checked"))c.attr("checked",true)}else if(c.is(":checked"))c.attr("checked",false)})}else{c.each(function(b){var c=a(this);if(c.is(":checked"))g.push(c.val())})}return g}},select:{".ui-slider-switch":function(a,c){if(b(c)){a.val(String(c||""));a.slider("refresh")}},"[multiple]":function(a,c){if(b(c)){a.val(c,[]);if(a.selectmenu)a.selectmenu("refresh",true)}},"":function(c,d){if(b(d)){c.val(String(d||""));if(c.selectmenu){if(c.selectmenu("option").theme!=null)c.selectmenu("refresh",true);else{c.find("option").each(function(b){var e=a(this);if((e.val()||e.text())==d)c.selectmenu("value",b)})}}}}},textarea:function(a,c){if(b(c))a.val(c)},"div,span,a,p,form,fieldset,li,td,th,h1,h2,h3,h4,h5,h6":{".ui-slider":function(a,c){if(b(c))a.slider("option",a.slider("option","values")?"values":"value",e.clone(c));return e.clone(a.slider("option","values")||a.slider("option","value")||"")},".ui-buttonset":function(c,d){if(!b(d)){var e=c.find(":radio:checked");if(e.size()&&e.button)return e.val()||e.button("option","label")}else if(d!=""){var f=null;c.find(":radio").each(function(){f=(a(this).val()||a(this).button("option","label"))==d?a(this):f});if(f){f.attr("checked",true);c.buttonset("refresh");return d}}c.find(":radio:checked").attr("checked",false);c.buttonset("refresh");return""},"":function(a,c){if(b(c))a.html(c);return a.html()}},"pre,code":function(a,c){if(b(c))a.html(c);return a.html()},img:function(a,c){if(b(c))a.attr("src",val);return a.attr("src")||""},"":function(a,c){if(b(c))a.html(c);return a.html()||a.text()||a.val()||""}},events:{".ui-slider":"slide.my check.my","img, a, .pseudolink, input[type=button], button, :radio, :checkbox":"click.my check.my ",".ui-buttonset,input, select, textarea":"blur.my input.my change.my check.my"+(a.browser.msie?" keyup.my":""),"":"check.my"},containers:{"*[data-role='fieldcontain'] *":{"input, textarea, select, button, :radio":function(a){return a.parents('[data-role="fieldcontain"]').eq(0)}},".tagstrip *.value":function(a){return a.parents(".tagstrip").eq(0)},".hasDatepicker, .ui-widget, input, textarea, select, button":function(a){return a.parents("div,span,a,p,form,fieldset,li,td,th,h1,h2,h3,h4,h5,h6").eq(0)},"":function(a){return a}}};var e={con:function(){try{console.log(arguments)}catch(a){}},clone:function(a){return a.clone?a.clone():a},field:function(a,b){if(!a.data("myval")){var c=e.traverse(a,d.vals);if(typeof c=="function"){var f=c(a,null);if(f===undefined){a.data("myval",function(a,b){if(b!=null)c(a,b);return a.val()}.fill(a,undefined))}else{a.data("myval",c.fill(a,undefined))}}}var g=a.data("myval");if(typeof g=="function"){var f=g();if(f!=b)f=g(b);return f}else return null},traverse:function(b,c){function g(c,h){for(var i in c){if(i!=""&&b.is(i)){f=f+(f?" ### ":"")+i;var j=a.type(c[i]);if(!/^(null|undefined|object)/.test(a.type(c[i]))&&h>e){d=c[i];e=h;return}else if(j=="object"){g(c[i],h+1)}}}if(c[""]!=null&&typeof c[""]!="object"&&h>e){d=c[""];e=h}}var d=null,e=0,f="";g(c,1);return d},bind:function(a,b,c,d){var e=c.bind;if(typeof e=="function"){return e(a,b,d)}else if(typeof e=="string"){if(b!=null)a[e]=b;else if(a[e]===undefined)a[e]=null;return a[e]}return null},date8601:function(b){if(typeof b=="number"||!isNaN(b)&&parseInt(b)==b)return new Date(parseInt(b));if(typeof b=="string")return Date.create(b,c);if(a.type(b)=="date"||b==null)return Date.create(b,c).format("{yyyy}-{MM}-{dd}T{HH}:{mm}{isotz}");return new Date},isOut:function(b,c,d,e){var f=d.check;if(f!=null){var g=d["error"]||e.data("my").root.data("my").params.errorMessage||"Error";switch(a.type(f)){case"function":return f(b,c,e);case"regexp":return f.test(String(c))?"":g;case"array":return f.indexOf(c)>-1?"":g;case"string":return c==f?"":g;case"object":return f[c]?"":g}return g}else{return""}},update:function(b,c,d){var f=b,g=f.data("my"),h="Unknown error";if(g){var i=g.root,j=g.container;var k=g.selector,l=g.data,m=g.ui;var n=g.params,o=i.data("my").ui;var p=i.find(k);if(c!=null){var q=c}else{q=e.field(p,e.bind(l,null,m,p))}try{var h=e.isOut(l,q,m,p)}catch(r){e.con("Error "+r.name+" validating "+k)}var s=n.errorCss;var t="ui-state-error";if(h==""){g.errors[k]="";if(c!=null){q=e.field(p,e.bind(l,c,m,p))}n.errorEffect(j.removeClass(s).find(n.errorTip),false,n.animate/2);f.removeClass(t);f.find(".ui-widget").removeClass(t)}else{g.errors[k]=h;n.errorEffect(j.addClass(s).find(n.errorTip).addClass(s).html(h),true,n.animate);if(f.is(".hasDatepicker")){if(f.is("input"))f.addClass(t);else f.find(".ui-widget").addClass(t)}if(f.is(".ui-slider"))f.addClass(t)}var u=c==null?q:c;if(m.css){for(var v in m.css){var w=m.css[v];if(Object.isRegExp(w)){if(w.test(u))j.addClass(v);else j.removeClass(v)}else if(Object.isFunction(w)){if(w(l,u,p))j.addClass(v);else j.removeClass(v)}}}if(d&&m.recalc){var x=m.recalc,y=[],z={};if(Object.isString(x))x=x.split(",");if(Object.isArray(x)){for(var A in x){if(x[A]&&a.type(x[A])=="string"){var B=x[A].compact();if(o[B]){if(o[B].recalc){if(y.indexOf(B)==-1)y.push(B)}else z[B]=true}}}for(var A=0;A<y.length;A++){z=a.extend(true,z,e.update(i.find(y[A]),null,d-1))}if(c!==null){for(A in z){if(z[A]===true&&A!=k)e.update(i.find(A),null,d-1)}return{}}}}return z||{}}},history:function(b,c,d){var e=c;if(a.type(e)!="object"||isNaN(e.remember)||a.type(e.history)!="object")return null;var f=e.history;var g=e.remember;if(a.type(b)=="object"){var h=Object.extended(a.extend(true,{},b));var i=(new Date).valueOf();var j=f.keys().sort();if(j.length>0&&i-j[j.length-1]<e.historyDelay)return null;if(j.length>0&&f[j[j.length-1]].equals(h))return null;e.history[i]=h;j.push(i);if(j.length>=g*2){var k=Object.extended();for(var l=g;l<g*2;l++){k[j[l]]=f[j[l]]}c.history=k}return e.history[j[j.length-1]]}if(!isNaN(b)||b===null){var m=parseInt(b)||0;if(m<0)return null;var j=f.keys().sort();if(m>=j.length)m=j.length-1;var n=e.history[j[j.length-m-1]].clone(true);if(d){var k=Object.extended();for(var l=0;l<j.length-m-1;l++){k[j[l]]=f[j[l]]}c.history=k}return n}}};var f={};var g={init:function(b){var c=this;if(!b)return c;if(Object.isObject(c.data("my"))&&c.data("my").id&&c.data("my").ui){e.con("$.my is already bind!");return c}var g=a.extend(true,{getContainer:function(a){return e.traverse(a,d.containers)(a)},change:function(){},recalcDepth:2,delay:0,animate:0,errorMessage:"Incorrect input!",errorTip:".my-error-tip",errorCss:"my-error",errorEffect:function(a,b,c){if(b){a.fadeIn(c);return}a.fadeOut(c)},oninit:function(){},remember:100,history:Object.extended(),historyDelay:100},b.params||{});var h=a.extend(true,{},b.ui||{});var i=b.id||"form"+Number.random(1e8,999999999);var j=b.data||{};c.data("my",{id:i,data:j,params:g,errors:Object.extended(),ui:Object.extended(h)});for(var k in h){var l=a(this).find(k);var m=h[k];if(l.size()>0){var n;l.each(function(){var b=a(this);var f=l;var h=e.traverse(b,d.events);b.data("my",{id:i,events:h,selector:k,ui:m,initial:n,previous:n,root:c,data:j,params:g,container:g.getContainer(b),errors:c.data("my").errors}).bind(h,function(){var d=b.data("my");if(!d.errors||d.errors.values().compact(true).length==0)c.data("my").lastCorrect=a.extend(true,{},d.data);e.history(d.data,d.params);var f=c.find(d.selector);var h=e.field(f,null);e.update(b,h,m.recalcDepth||g.recalcDepth);g.change()}.debounce(m.delay||g.delay))})}else{e.con("Not found "+k+" selector at form "+i)}}for(var k in h){var l=a(this).find(k);if(l.size()>0){var m=h[k];var n=e.bind(j,null,m,l);if(n!=null){e.field(l,n)}l.eq(0).trigger("check")}}if(!c.data("my"))return null;c.data("my").initial=a.extend(true,{},j);f[i]=c;if(a.mobile)a.mobile.changePage(a.mobile.activePage);return c},redraw:function(a){var b=this;b.data("my").ui.each(function(c){e.update(b.find(c),a?null:undefined,b.data("my").params.recalcDepth)})},data:function(b){if(b!=null){a.extend(true,this.data("my").data,b);this.my("redraw")}return a(this).data("my").data},errors:function(){var b=a(this).data("my").errors,c={};for(var d in b){if(b[d]&&typeof b[d]=="string")c[d]=b[d]}return c},reset:function(){try{a.extend(true,this.data("my").data,this.data("my").initial);this.my("redraw")}catch(b){return false}return true},id:function(a){if(typeof a=="string"){return f[a]||null}else{var b=this.data("my");if(b&&b.id){return b.id}else{return null}}},remove:function(){var a=this;a.data("my").ui.each(function(b){var c=a.find(b);c.unbind(c.data("my").events).removeData("my")});var b=a.data("my").data;a.removeData("my");return b},undo:function(a){var b=this;var c=b.data("my");var d=c.params.history;var f=d.keys().sort();var g=1*(parseInt(a)||0);if(f.length==0||g<0)return null;if(!c.params.errors||c.params.errors.values().compact(true).length==0){if(d[f[f.length-1]].equals(Object.extended(c.data)))g+=1}else{if(!Object.extended(c.data).equals(Object.extended(c.lastCorrect)))g+=1}b.data("my").data=Object.merge(b.data("my").data,e.history(g,c.params,true)||{});b.my("redraw");return b.data("my").data},history:function(a,b){return e.history(a,this.data("my").params,b)},val:function(a){return e.field(this,a)},cont:function(a){return e.traverse(a,d.containers)(a)}};a.fn.my=function(b){if(g[b]){return g[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return g.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.my")}}})(jQuery)