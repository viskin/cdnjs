/*
 * jQuery.my 0.3 beta. 
 * -- added undo
 * -- jQuery UI slider, buttonset and datepicker 
 *    are now recognized
 * 
 * (c) ermouth
 * See details at jquerymy.com
 * 
 * Requires jQuery 1.7.1+, SugarJS 1.2.5+
 * Minified with http://jscompress.com/
 * 
 */

(function(a){var b={i:/^number|text|hidden|password|button|range/,div:/^p|div|span|form|fieldset|pre|code|li|t[dh]|h[1-6]|a$/};var c={con:function(){try{console.log(arguments)}catch(a){}},field:function(d,e){var g=d[0].nodeName.toLowerCase();if(e!=null){var h=String(e);if(g=="input"){var i=d.eq(0).attr("type").toLowerCase();if(b.i.test(i)){if(d.val()!=h){if(d.hasClass("hasDatepicker")){if(c.mydate(d.datepicker("getDate")).to(10)!=c.mydate(c.mydate(h)).to(10))d.datepicker("setDate",c.mydate(h))}else{d.val(h);if(d.hasClass("ui-slider-input"))d.slider("refresh");if(d.data("tagstrip")&&d.data("tagstrip").root)d.trigger("update")}}}else if(i=="radio"){var j=-1;d.each(function(b){var c=a(this).val();if(c===h)j=b});d.each(function(){var b=a(this).eq(j);b.attr("checked",false);if(d.eq(j).checkboxradio)b.checkboxradio("refresh")});if(j>-1){var k=d.eq(j);k.attr("checked",true);if(d.eq(j).checkboxradio)k.checkboxradio("refresh")}}}else if(g=="select"){if(d.val()!=h){d.val(h);if(d.hasClass("ui-slider-switch"))d.slider("refresh");else{if(d.selectmenu)d.selectmenu("refresh",true)}}}else if(g=="textarea"){if(d.val()!=h)d.val(h)}else if(b.div.test(g)){if(d.hasClass("ui-slider"))d.slider("option","value",h);else if(d.hasClass("hasDatepicker"))d.datepicker("setDate",c.mydate(h));else if(d.hasClass("ui-buttonset")){var l;d.find(":radio").each(function(){l=a(this).button("option","label")==h?a(this):l});if(l){l.attr("checked","checked");d.buttonset("refresh")}}else d.html(h)}else if(g=="img"){d.attr("src",h)}return h}else{if(g=="input"){var i=(d.eq(0).attr("type")||"text").toLowerCase();if(b.i.test(i)){if(d.hasClass("hasDatepicker"))return c.mydate(d.datepicker("getDate")||new Date);return d.val()}else if(i=="radio"){var m="";d.each(function(){if(this.attributes["checked"])m=a(this).val()});return m}}else if(/^select|textarea$/.test(g)){return d.val()}else if(b.div.test(g)){if(d.hasClass("ui-slider"))return String(d.slider("option","value"))||"";if(d.hasClass("ui-buttonset")){var k=d.find(":radio:checked");if(k.size()&&k.button)return k.button("option","label");return""}if(d.hasClass("hasDatepicker"))return c.mydate(d.datepicker("getDate")||new Date);return d.html().compact()}else if(g=="img"){return d.attr("src")}}},bind:function(a,b,c,d){var e=c.bind;if(typeof e=="function"){return e(a,b,d)}else if(typeof e=="string"){if(b!=null){a[e]=String(b)}else{if(a[e]===undefined)a[e]=null}return a[e]}return null},mydate:function(b){if(typeof b=="number"||!isNaN(b)&&parseInt(b)==b){return new Date(parseInt(b))}if(typeof b=="string"){if(Date.create)return Date.create(b);return new Date(b)}if(a.type(b)=="date"||b==null){return Date.create?Date.create(b).format("{yyyy}-{MM}-{dd}T{HH}:{mm}{isotz}"):String(b)}return new Date},isOut:function(b,c,d,e){var f=d.check;if(f!=null){var g=d["error"]||e.data("my").root.data("my").params.errorMessage||"Error";var h=a.type(f);if(h=="function"){return f(b,c,e)}else if(h=="regexp"){return f.test(String(c))?"":g}else if(h=="array"){return f.indexOf(c)>-1?"":g}else if(h=="string"){return c==f?"":g}else if(h=="object"){return f[c]?"":g}return g}else{return""}},update:function(b,d,e){var g=b,h=g.data("my"),i="Unknown error";if(h){$root=h.root,$container=h.container;var j=h.selector,k=h.data,l=h.ui;var m=$root.data("my").params,n=$root.data("my").ui;var o=$root.find(j);if(d!=null){var p=d}else{p=c.field(o,c.bind(k,null,l,b))}try{var i=c.isOut(k,p,l,g)}catch(q){c.con("Error "+q.name+" validating "+j)}if(i==""){h.errors[j]="";if(d!=null){p=c.field(o,c.bind(k,d,l,b))}$container.removeClass(m.errorCss).find(m.errorTip).removeClass(m.errorCss).html("").hide(m.animate);g.removeClass("ui-state-error");g.find(".ui-widget").removeClass("ui-state-error")}else{h.errors[j]=i;$container.addClass(m.errorCss).find(m.errorTip).addClass(m.errorCss).show(m.animate).html(i);if(g.hasClass("hasDatepicker")){if(g.is("input"))g.addClass("ui-state-error");else g.find(".ui-widget").addClass("ui-state-error")}if(g.hasClass("ui-slider"))g.addClass("ui-state-error")}var r=d==null?p:d;if(l.css){for(var s in l.css){var t=l.css[s];if(Object.isRegExp(t)){if(t.test(r))$container.addClass(s);else $container.removeClass(s)}else if(Object.isFunction(t)){if(t(k,r,b))$container.addClass(s);else $container.removeClass(s)}}}if(e&&l.recalc){var u=l.recalc,v=[],w={};if(Object.isString(u))u=u.split(",");if(Object.isArray(u)){for(var x in u){if(u[x]&&Object.isString(u[x])){var y=u[x].compact();if(n[y]){if(n[y].recalc){if(v.indexOf(y)==-1)v.push(y)}else{w[y]=true}}}}for(var x=0;x<v.length;x++){w=a.extend(true,w,c.update($root.find(v[x]),null,e-1))}if(d!==null){for(x in w){if(w[x]===true&&x!=j)c.update($root.find(x),null,e-1)}return{}}}}return w||{}}},history:function(b,c,d){var e=c;if(a.type(e)!="object"||isNaN(e.remember)||a.type(e.history)!="object")return null;var f=e.history;var g=e.remember;if(a.type(b)=="object"){var h=Object.extended(a.extend(true,{},b));var i=(new Date).valueOf();var j=f.keys().sort();if(j.length>0&&i-j[j.length-1]<e.historyDelay)return null;if(j.length>0&&f[j[j.length-1]].equals(h))return null;e.history[i]=h;j.push(i);if(j.length>=g*2){var k=Object.extended();for(var l=g;l<g*2;l++){k[j[l]]=f[j[l]]}c.history=k}return e.history[j[j.length-1]]}if(!isNaN(b)||b===null){var m=parseInt(b)||0;if(m<0)return null;var j=f.keys().sort();if(m>=j.length)m=j.length-1;var n=e.history[j[j.length-m-1]].clone(true);if(d){var k=Object.extended();for(var l=0;l<j.length-m-1;l++){k[j[l]]=f[j[l]]}c.history=k}return n}}};var d={};var e={init:function(e){var g=this;if(!e)return g;if(Object.isObject(g.data("my"))&&g.data("my").id&&g.data("my").ui){c.con("$.my is already bind!");return g}var h=a.extend(true,{getContainer:function(c){if(!b.div.test(a(c)[0].tagName.toLowerCase())||c.hasClass("ui-widget")){var d=c.parents('*[data-role="fieldcontain"], *.tagstrip');if(d.size()==0){var e=c.parents("*");var f=false;for(var g=0;g<3;g++){if(!f&&b.div.test(e[g].tagName.toLowerCase())){f=e[g]}}if(!f)return c;else return a(f)}return a(d[0])}else{return c}},change:function(){},recalcDepth:2,delay:0,animate:0,errorMessage:"Incorrect input!",errorTip:".my-error-tip",errorCss:"my-error",oninit:function(){},remember:100,history:Object.extended(),historyDelay:10},e.params||{});var i=a.extend(true,{},e.ui||{});var j=e.id||"auto"+Math.random(1e8,999999999);var k=e.data||{};g.data("my",{id:j,data:k,params:h,errors:Object.extended(),ui:Object.extended(i),history:h.history});for(var l in i){var m=a(this).find(l);var n=i[l];if(m.size()>0){var o=c.bind(k,null,n,m);if(o!=null){c.field(m,o)}else{o=c.field(m,null);o=c.bind(k,o,n,m)}m.each(function(){var b=a(this);var d="blur.my input.my change.my check.my"+(a.browser.msie?" keyup.my":"");if(b.is('[type="button"]'))d="click.my check.my";else if(b.hasClass("ui-slider"))d="slide.my check.my";b.data("my",{id:j,events:d,selector:l,ui:n,initial:o,previous:o,root:g,data:k,params:h,container:h.getContainer(b),errors:g.data("my").errors}).bind(d,function(){var d=b.data("my");if(!d.errors||d.errors.values().compact(true).length==0)d.root.data("my").lastCorrect=a.extend(true,{},d.data);c.history(d.data,d.params);c.update(b,c.field(d.root.find(d.selector)),n.recalcDepth||h.recalcDepth);h.change()}.debounce(h.delay))})}else{c.con("Not found "+l+" selector at form "+j)}}for(var l in i){this.find(l).trigger("check")}g.data("my").initial=a.extend(true,{},k);d[j]=g;if(a.mobile)a.mobile.changePage(a.mobile.activePage);return g},redraw:function(a){var b=this;b.data("my").ui.each(function(d){c.update(b.find(d),a?null:undefined,b.data("my").params.reclcDepth)})},data:function(b){if(b!=null){a.extend(true,this.data("my").data,b);this.my("redraw")}return a(this).data("my").data},errors:function(){var b=a(this).data("my").errors,c={};for(var d in b){if(b[d]&&typeof b[d]=="string")c[d]=b[d]}return c},reset:function(){try{a.extend(true,this.data("my").data,this.data("my").initial);this.my("redraw")}catch(b){return false}return true},id:function(a){if(typeof a=="string"){return d[a]||null}else{var b=this.data("my");if(b&&b.id){return b.id}else{return null}}},remove:function(){var a=this;a.data("my").ui.each(function(b){var c=a.find(b);c.unbind(c.data("my").events).removeData("my")});var b=a.data("my").data;a.removeData("my");return b},undo:function(b){var d=this;var e=d.data("my");var g=e.params.history;var h=g.keys().sort();var i=1*(parseInt(b)||0);if(h.length==0||i<0)return null;if(!e.params.errors||e.params.errors.values().compact(true).length==0){if(g[h[h.length-1]].equals(Object.extended(e.data)))i+=1}else{if(!Object.extended(e.data).equals(Object.extended(e.lastCorrect)))i+=1}a.extend(true,d.data("my").data,c.history(i,e.params,true)||{});d.my("redraw");return d.data("my").data},history:function(a,b){return c.history(a,this.data("my").params,b)}};a.fn.my=function(b){if(e[b]){return e[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return e.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.my")}}})(jQuery)