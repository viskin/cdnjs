(function(root,factory){if(typeof define==="function"&&define.amd){define(["wavesurfer"],factory)}else{root.WaveSurfer.Microphone=factory(root.WaveSurfer)}})(this,function(WaveSurfer){"use strict";WaveSurfer.Microphone={init:function(params){this.params=params;var wavesurfer=this.wavesurfer=params.wavesurfer;if(!this.wavesurfer){throw new Error("No WaveSurfer instance provided")}this.active=false;this.paused=false;this.getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia).bind(navigator);this.bufferSize=this.params.bufferSize||4096;this.numberOfInputChannels=this.params.numberOfInputChannels||1;this.numberOfOutputChannels=this.params.numberOfOutputChannels||1;this.micContext=this.wavesurfer.backend.getAudioContext()},start:function(){this.getUserMedia({video:false,audio:true},this.gotStream.bind(this),this.deviceError.bind(this))},togglePlay:function(){if(!this.active){this.start()}else{this.paused=!this.paused;if(this.paused){this.disconnect()}else{this.connect()}}},stop:function(){if(this.active){this.active=false;if(this.stream){this.stream.stop()}this.disconnect();this.wavesurfer.empty()}},connect:function(){if(this.stream!==undefined){this.mediaStreamSource=this.micContext.createMediaStreamSource(this.stream);this.levelChecker=this.micContext.createScriptProcessor(this.bufferSize,this.numberOfInputChannels,this.numberOfOutputChannels);this.mediaStreamSource.connect(this.levelChecker);this.levelChecker.connect(this.micContext.destination);this.levelChecker.onaudioprocess=this.reloadBuffer.bind(this)}},disconnect:function(){if(this.mediaStreamSource!==undefined){this.mediaStreamSource.disconnect()}if(this.levelChecker!==undefined){this.levelChecker.disconnect()}},reloadBuffer:function(event){if(!this.paused){this.wavesurfer.loadDecodedBuffer(event.inputBuffer)}},gotStream:function(stream){this.stream=stream;this.active=true;this.connect();this.fireEvent("deviceReady",stream)},deviceError:function(code){this.fireEvent("deviceError",code)}};WaveSurfer.util.extend(WaveSurfer.Microphone,WaveSurfer.Observer);return WaveSurfer.Microphone});
