(function(root,factory){if(typeof define==="function"&&define.amd){define(["wavesurfer"],factory)}else{root.WaveSurfer.Microphone=factory(root.WaveSurfer)}})(this,function(WaveSurfer){"use strict";WaveSurfer.Microphone={init:function(params){this.params=params;var wavesurfer=this.wavesurfer=params.wavesurfer;if(!this.wavesurfer){throw Error("No WaveSurfer instance provided")}this.active=false;this.getUserMedia=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia).bind(navigator);this.micContext=this.wavesurfer.backend.getAudioContext()},start:function(){this.getUserMedia({video:false,audio:true},this.gotStream.bind(this),this.streamError.bind(this))},stop:function(){if(this.active){this.active=false;if(this.stream){this.stream.stop()}this.mediaStreamSource.disconnect();this.levelChecker.disconnect();this.wavesurfer.empty()}},reloadBuffer:function(event){this.wavesurfer.empty();this.wavesurfer.loadDecodedBuffer(event.inputBuffer)},gotStream:function(stream){this.stream=stream;this.active=true;this.mediaStreamSource=this.micContext.createMediaStreamSource(stream);this.levelChecker=this.micContext.createScriptProcessor(4096,1,1);this.mediaStreamSource.connect(this.levelChecker);this.levelChecker.connect(this.micContext.destination);this.levelChecker.onaudioprocess=this.reloadBuffer.bind(this)},streamError:function(error){console.warn("error",error)}};WaveSurfer.util.extend(WaveSurfer.Microphone,WaveSurfer.Observer);return WaveSurfer.Microphone});
