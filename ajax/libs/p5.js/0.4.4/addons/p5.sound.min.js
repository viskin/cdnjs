/*! p5.sound.js v0.1.7 2015-02-02 */
(function(a,b){if(typeof define==="function"&&define.amd){define("p5.sound",["p5"],function(c){(b(c))})}else{if(typeof exports==="object"){b(require("../p5"))}else{b(a.p5)}}}(this,function(C){var q;q=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;var D=new window.AudioContext();C.prototype.getAudioContext=function(){return D};if(typeof D.createGain!=="function"){window.audioContext.createGain=window.audioContext.createGainNode}if(typeof D.createDelay!=="function"){window.audioContext.createDelay=window.audioContext.createDelayNode}if(typeof window.AudioBufferSourceNode.prototype.start!=="function"){window.AudioBufferSourceNode.prototype.start=window.AudioBufferSourceNode.prototype.noteGrainOn}if(typeof window.AudioBufferSourceNode.prototype.stop!=="function"){window.AudioBufferSourceNode.prototype.stop=window.AudioBufferSourceNode.prototype.noteOff}if(typeof window.OscillatorNode.prototype.start!=="function"){window.OscillatorNode.prototype.start=window.OscillatorNode.prototype.noteOn}if(typeof window.OscillatorNode.prototype.stop!=="function"){window.OscillatorNode.prototype.stop=window.OscillatorNode.prototype.noteOff}if(!window.AudioContext.prototype.hasOwnProperty("createScriptProcessor")){window.AudioContext.prototype.createScriptProcessor=window.AudioContext.prototype.createJavaScriptNode}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var G=document.createElement("audio");C.prototype.isSupported=function(){return !!G.canPlayType};var E=function(){return !!G.canPlayType&&G.canPlayType('audio/ogg; codecs="vorbis"')};var J=function(){return !!G.canPlayType&&G.canPlayType("audio/mpeg;")};var I=function(){return !!G.canPlayType&&G.canPlayType('audio/wav; codecs="1"')};var K=function(){return !!G.canPlayType&&(G.canPlayType("audio/x-m4a;")||G.canPlayType("audio/aac;"))};var F=function(){return !!G.canPlayType&&G.canPlayType("audio/x-aiff;")};C.prototype.isFileSupported=function(L){switch(L.toLowerCase()){case"mp3":return J();case"wav":return I();case"ogg":return E();case"aac","m4a","mp4":return K();case"aif","aiff":return F();default:return false}};var H=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?true:false;if(H){window.addEventListener("touchstart",function(){var L=D.createBuffer(1,1,22050);var M=D.createBufferSource();M.buffer=L;M.connect(D.destination);M.start(0)},false)}}();var m;m=function(){var D=function(){var F=C.prototype.getAudioContext();this.input=F.createGain();this.output=F.createGain();this.limiter=F.createDynamicsCompressor();this.limiter.threshold.value=0;this.limiter.ratio.value=100;this.audiocontext=F;this.output.disconnect(this.audiocontext.destination);this.inputSources=[];this.input.connect(this.limiter);this.limiter.connect(this.output);this.meter=F.createGain();this.output.connect(this.meter);this.output.connect(this.audiocontext.destination);this.soundArray=[];this.parts=[];this.extensions=[]};var E=new D();C.soundOut=E;C.soundOut._silentNode=E.audiocontext.createGain();C.soundOut._silentNode.gain.value=0;C.soundOut._silentNode.connect(E.audiocontext.destination);return E}(q);var s;s=function(){var D=m;C.prototype.masterVolume=function(E){D.output.gain.value=E};C.prototype.sampleRate=function(){return D.audiocontext.sampleRate};C.prototype.getMasterVolume=function(){return D.output.gain.value};C.prototype.freqToMidi=function(F){var G=Math.log(F/440)/Math.log(2);var E=Math.round(12*G)+57;return E};C.prototype.midiToFreq=function(E){return 440*Math.pow(2,(E-69)/12)};C.prototype.soundFormats=function(){D.extensions=[];for(var E=0;E<arguments.length;E++){arguments[E]=arguments[E].toLowerCase();if(["mp3","wav","ogg","m4a","aac"].indexOf(arguments[E])>-1){D.extensions.push(arguments[E])}else{throw arguments[E]+" is not a valid sound format!"}}};C.prototype.disposeSound=function(){for(var E=0;E<D.soundArray.length;E++){D.soundArray[E].dispose()}};C.prototype.registerMethod("remove",C.prototype.disposeSound);C.prototype._checkFileFormats=function(L){var M;if(typeof L==="string"){M=L;var I=M.split(".").pop();if(["mp3","wav","ogg","m4a","aac"].indexOf(I)>-1){var E=C.prototype.isFileSupported(I);if(E){M=M}else{var G=M.split(".");var J=G[G.length-1];for(var H=0;H<D.extensions.length;H++){var K=D.extensions[H];var E=C.prototype.isFileSupported(K);if(E){J="";if(G.length===2){J+=G[0]}for(var H=1;H<=G.length-2;H++){var F=G[H];J+="."+F}M=J+=".";M=M+=K;break}}}}else{for(var H=0;H<D.extensions.length;H++){var K=D.extensions[H];var E=C.prototype.isFileSupported(K);if(E){M=M+"."+K;break}}}}else{if(typeof L==="object"){for(var H=0;H<L.length;H++){var K=L[H].split(".").pop();var E=C.prototype.isFileSupported(K);if(E){M=L[H];break}}}}return M};C.prototype._mathChain=function(J,H,I,E,G){for(var F in J.mathOps){if(J.mathOps[F] instanceof G){J.mathOps[F].dispose();I=F;if(I<J.mathOps.length-1){E=J.mathOps[F+1]}}}J.mathOps[I-1].disconnect();J.mathOps[I-1].connect(H);H.connect(E);J.mathOps[I]=H;return J}}(m);var w;w=function(){var E=m;var D=E.audiocontext;C.Panner=function(G,F,H){this.input=D.createGain();G.connect(this.input);this.left=D.createGain();this.right=D.createGain();this.left.channelInterpretation="discrete";this.right.channelInterpretation="discrete";if(H>1){this.splitter=D.createChannelSplitter(2);this.input.connect(this.splitter);this.splitter.connect(this.left,1);this.splitter.connect(this.right,0)}else{this.input.connect(this.left);this.input.connect(this.right)}this.output=D.createChannelMerger(2);this.left.connect(this.output,0,1);this.right.connect(this.output,0,0);this.output.connect(F)};C.Panner.prototype.pan=function(L,J){var K=J||0;var H=D.currentTime+K;var F=(L+1)/2;var G=Math.cos(F*Math.PI/2);var I=Math.sin(F*Math.PI/2);this.left.gain.linearRampToValueAtTime(G,H);this.right.gain.linearRampToValueAtTime(I,H)};C.Panner.prototype.inputChannels=function(F){if(F===1){this.input.disconnect();this.input.connect(this.left);this.input.connect(this.right)}else{if(F===2){if(typeof(this.splitter==="undefined")){this.splitter=D.createChannelSplitter(2)}this.input.disconnect();this.input.connect(this.splitter);this.splitter.connect(this.left,1);this.splitter.connect(this.right,0)}}};C.Panner.prototype.connect=function(F){this.output.connect(F)};C.Panner.prototype.disconnect=function(F){this.output.disconnect()};C.Panner3D=function(G,F){var H=D.createPanner();H.panningModel="HRTF";H.distanceModel="linear";H.setPosition(0,0,0);G.connect(H);H.connect(F);H.pan=function(K,J,I){H.setPosition(K,J,I)};return H}}(m);var d;d=function(){var D=m;C.SoundFile=function(H,G,E){var F=C.prototype._checkFileFormats(H);this.url=F;this.sources=[];this.source=null;this.buffer=null;this.playbackRate=1;this.gain=1;this.input=D.audiocontext.createGain();this.output=D.audiocontext.createGain();this.reversed=false;this.startTime=0;this.endTime=null;this.playing=false;this.paused=null;this.mode="sustain";this.startMillis=null;this.amplitude=new C.Amplitude();this.output.connect(this.amplitude.input);this.panPosition=0;this.panner=new C.Panner(this.output,D.input,2);if(this.url){this.load(G)}D.soundArray.push(this);if(typeof E==="function"){this.whileLoading=E}else{this.whileLoading=function(){}}};C.prototype.registerPreloadMethod("loadSound");C.prototype.loadSound=function(G,H,E){if(window.location.origin.indexOf("file://")>-1){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}var F=new C.SoundFile(G,H,E);return F};C.SoundFile.prototype.load=function(H){var G=this;var F=new XMLHttpRequest();F.addEventListener("progress",function(I){G._updateProgress(I)},false);F.open("GET",this.url,true);F.responseType="arraybuffer";var E=this;F.onload=function(){var I=C.prototype.getAudioContext();I.decodeAudioData(F.response,function(J){E.buffer=J;E.panner.inputChannels(J.numberOfChannels);if(H){H(E)}})};F.send()};C.SoundFile.prototype._updateProgress=function(E){if(E.lengthComputable){var F=Math.log(E.loaded/E.total*9.9);this.whileLoading(F)}else{console.log("size unknown")}};C.SoundFile.prototype.isLoaded=function(){if(this.buffer){return true}else{return false}};C.SoundFile.prototype.play=function(K,J,H,I,F){var G=D.audiocontext.currentTime;var K=K||0;if(K<0){K=0}if(this.buffer){if(this.mode==="restart"&&this.buffer&&this.source){var G=D.audiocontext.currentTime;this.source.stop(K)}if(I){if(I>=0&&I<this.buffer.duration){this.startTime=I}else{throw"start time out of range"}}if(F){if(F>=0&&F<=this.buffer.duration){this.endTime=F}else{throw"end time out of range"}}else{this.endTime=this.buffer.duration}this.source=D.audiocontext.createBufferSource();this.source.buffer=this.buffer;this.source.loop=this.looping;if(this.source.loop===true){this.source.loopStart=this.startTime;this.source.loopEnd=this.endTime}this.source.onended=function(){};if(!this.source.gain){this.source.gain=D.audiocontext.createGain();this.source.connect(this.source.gain);var E=H||1;this.source.gain.gain.setValueAtTime(E,D.audiocontext.currentTime);this.source.gain.connect(this.output)}else{this.source.gain.value=H||1;this.source.connect(this.output)}this.source.playbackRate.cancelScheduledValues(G);J=J||Math.abs(this.playbackRate);this.source.playbackRate.setValueAtTime(J,G);if(this.paused){this.wasUnpaused=true}if(this.paused&&this.wasUnpaused){this.source.start(K,this.pauseTime,this.endTime)}else{this.wasUnpaused=false;this.pauseTime=0;this.source.start(K,this.startTime,this.endTime)}this.startSeconds=K+G;this.playing=true;this.paused=false;this.sources.push(this.source)}else{throw"not ready to play file, buffer has yet to load. Try preload()"}};C.SoundFile.prototype.playMode=function(H){var G=H.toLowerCase();if(G==="restart"&&this.buffer&&this.source){for(var F=0;F<this.sources.length-1;F++){var E=D.audiocontext.currentTime;this.sources[F].stop(E)}}if(G==="restart"||G==="sustain"){this.mode=G}else{throw'Invalid play mode. Must be either "restart" or "sustain"'}};C.SoundFile.prototype.pause=function(H){var F=D.audiocontext.currentTime;var H=H||0;var G=H+F;var E=this.looping;if(this.isPlaying()&&this.buffer&&this.source){this.pauseTime=this.currentTime();this.source.stop(G);this.paused=true;this.wasUnpaused=false;this.playing=false}};C.SoundFile.prototype.loop=function(G,E,F,H){this.looping=true;this.play(G,E,F,H)};C.SoundFile.prototype.setLoop=function(E){if(E===true){this.looping=true}else{if(E===false){this.looping=false}else{throw"Error: setLoop accepts either true or false"}}if(this.source){this.source.loop=this.looping}};C.SoundFile.prototype.isLooping=function(){if(!this.source){return false}if(this.looping===true&&this.isPlaying()===true){return true}return false};C.SoundFile.prototype.isPlaying=function(){if(this.playing!==null){return this.playing}else{return false}};C.SoundFile.prototype.isPaused=function(){if(!this.paused){return false}return this.paused};C.SoundFile.prototype.stop=function(G){if(this.mode=="sustain"){this.stopAll();this.playing=false;this.pauseTime=0;this.wasUnpaused=false;this.paused=false}else{if(this.buffer&&this.source){var E=D.audiocontext.currentTime;var F=G||0;this.source.stop(E+F);this.playing=false;this.pauseTime=0;this.wasUnpaused=false;this.paused=false}}};C.SoundFile.prototype.stopAll=function(){if(this.buffer&&this.source){for(var F=0;F<this.sources.length;F++){if(this.sources[F]!==null){var E=D.audiocontext.currentTime;this.sources[F].stop(E)}}}};C.SoundFile.prototype.setVolume=function(F,I,G){if(typeof F==="number"){var I=I||0;var G=G||0;var E=D.audiocontext.currentTime;var H=this.output.gain.value;this.output.gain.cancelScheduledValues(E+G);this.output.gain.linearRampToValueAtTime(H,E+G);this.output.gain.linearRampToValueAtTime(F,E+G+I)}else{if(F){F.connect(this.output.gain)}else{return this.output.gain}}};C.SoundFile.prototype.amp=C.SoundFile.prototype.setVolume;C.SoundFile.prototype.fade=C.SoundFile.prototype.setVolume;C.SoundFile.prototype.getVolume=function(){return this.output.gain.value};C.SoundFile.prototype.pan=function(E,F){this.panPosition=E;this.panner.pan(E,F)};C.SoundFile.prototype.getPan=function(){return this.panPosition};C.SoundFile.prototype.rate=function(J){if(this.playbackRate===J&&this.source){if(this.source.playbackRate.value===J){return}}this.playbackRate=J;var H=J;if(this.playbackRate===0&&this.playing){this.pause()}if(this.playbackRate<0&&!this.reversed){var I=this.currentTime();var E=this.source.playbackRate.value;this.reverseBuffer();H=Math.abs(J);var G=(I-this.duration())/H;this.pauseTime=G}else{if(this.playbackRate>0&&this.reversed){this.reverseBuffer()}}if(this.source){var F=D.audiocontext.currentTime;this.source.playbackRate.cancelScheduledValues(F);this.source.playbackRate.linearRampToValueAtTime(Math.abs(H),F)}};C.SoundFile.prototype.getPlaybackRate=function(){return this.playbackRate};C.SoundFile.prototype.duration=function(){if(this.buffer){return this.buffer.duration}else{return 0}};C.SoundFile.prototype.currentTime=function(){var E;if(this.isPlaying()){var F=D.audiocontext.currentTime-this.startSeconds+this.startTime+this.pauseTime;E=F*this.playbackRate%(this.duration()*this.playbackRate);console.log("1");return E}else{if(this.paused){return this.pauseTime}else{return this.startTime}}};C.SoundFile.prototype.jump=function(G,E){if(G<0||G>this.buffer.duration){throw"jump time out of range"}if(E<G||E>this.buffer.duration){throw"end time out of range"}this.startTime=G||0;if(E){this.endTime=E}else{this.endTime=this.buffer.duration}if(this.isPlaying()){var F=D.audiocontext.currentTime;this.stop(F);this.play(G,this.endTime)}};C.SoundFile.prototype.channels=function(){return this.buffer.numberOfChannels};C.SoundFile.prototype.sampleRate=function(){return this.buffer.sampleRate};C.SoundFile.prototype.frames=function(){return this.buffer.length};C.SoundFile.prototype.getPeaks=function(F){if(this.buffer){if(!F){F=window.width*5}if(this.buffer){var K=this.buffer;var G=K.length/F;var M=~~(G/10)||1;var N=K.numberOfChannels;var Q=new Float32Array(Math.round(F));for(var O=0;O<N;O++){var H=K.getChannelData(O);for(var L=0;L<F;L++){var E=~~(L*G);var I=~~(E+G);var P=0;for(var J=E;J<I;J+=M){var R=H[J];if(R>P){P=R}else{if(-R>P){P=R}}}if(O===0||P>Q[L]){Q[L]=P}}}return Q}}else{throw"Cannot load peaks yet, buffer is not loaded"}};C.SoundFile.prototype.reverseBuffer=function(){var E=this.getVolume();this.setVolume(0,0.01,0);this.pause();if(this.buffer){Array.prototype.reverse.call(this.buffer.getChannelData(0));Array.prototype.reverse.call(this.buffer.getChannelData(1));this.reversed=!this.reversed}else{throw"SoundFile is not done loading"}this.setVolume(E,0.01,0.0101);this.play()};C.SoundFile.prototype._onEnded=function(E){E.onended=function(G){var F=D.audiocontext.currentTime;G.stop(F)}};C.SoundFile.prototype.add=function(){};C.SoundFile.prototype.dispose=function(){if(this.buffer&&this.source){for(var F=0;F<this.sources.length-1;F++){if(this.sources[F]!==null){var E=D.audiocontext.currentTime;this.sources[F].stop(E);this.sources[F]=null}}}if(this.output){this.output.disconnect();this.output=null}if(this.panner){this.panner.disconnect();this.panner=null}};C.SoundFile.prototype.connect=function(E){if(!E){this.panner.connect(D.input)}else{if(E.hasOwnProperty("input")){this.panner.connect(E.input)}else{this.panner.connect(E)}}};C.SoundFile.prototype.disconnect=function(E){this.panner.disconnect(E)};C.SoundFile.prototype.getLevel=function(E){if(E){this.amplitude.smoothing=E}return this.amplitude.getLevel()};C.SoundFile.prototype.setPath=function(F,G){var E=C.prototype._checkFileFormats(F);this.url=E;this.load(G)};C.SoundFile.prototype.setBuffer=function(F){var I=D.audiocontext;var E=I.createBuffer(2,F[0].length,I.sampleRate);var G=0;for(var J=0;J<F.length;J++){var H=E.getChannelData(J);H.set(F[J]);G++}this.buffer=E;this.panner.inputChannels(G)}}(q,m);var i;i=function(){var D=m;C.Amplitude=function(E){this.bufferSize=2048;this.audiocontext=D.audiocontext;this.processor=this.audiocontext.createScriptProcessor(this.bufferSize);this.input=this.processor;this.output=this.audiocontext.createGain();this.smoothing=E||0;this.volume=0;this.average=0;this.volMax=0.001;this.normalize=false;this.processor.onaudioprocess=this.volumeAudioProcess.bind(this);this.processor.connect(this.output);this.output.gain.value=0;this.output.connect(this.audiocontext.destination);D.meter.connect(this.processor)};C.Amplitude.prototype.setInput=function(F,E){D.meter.disconnect(this.processor);if(E){this.smoothing=E}if(F==null){console.log("Amplitude input source is not ready! Connecting to master output instead");D.meter.connect(this.processor)}else{if(F instanceof C.Signal){F.output.connect(this.processor)}else{if(F){F.connect(this.processor);this.processor.disconnect();this.processor.connect(this.output)}else{D.meter.connect(this.processor)}}}};C.Amplitude.prototype.connect=function(E){if(E){if(E.hasOwnProperty("input")){this.output.connect(E.input)}else{this.output.connect(E)}}else{this.output.connect(this.panner.connect(D.input))}};C.Amplitude.prototype.disconnect=function(E){this.output.disconnect()};C.Amplitude.prototype.volumeAudioProcess=function(E){var H=E.inputBuffer.getChannelData(0);var M=H.length;var J=0;var I=0;var K;for(var G=0;G<M;G++){K=H[G];if(this.normalize){J+=Math.max(Math.min(K/this.volMax,1),-1);I+=Math.max(Math.min(K/this.volMax,1),-1)*Math.max(Math.min(K/this.volMax,1),-1)}else{J+=K;I+=K*K}}var F=J/M;var L=Math.sqrt(I/M);this.volume=Math.max(L,this.volume*this.smoothing);this.volMax=Math.max(this.volume,this.volMax);this.volNorm=Math.max(Math.min(this.volume/this.volMax,1),0)};C.Amplitude.prototype.getLevel=function(){if(this.normalize){return this.volNorm}else{return this.volume}};C.Amplitude.prototype.toggleNormalize=function(E){if(typeof E==="boolean"){this.normalize=E}else{this.normalize=!this.normalize}};C.Amplitude.prototype.smooth=function(E){if(E>=0&&E<1){this.smoothing=E}else{console.log("Error: smoothing must be between 0 and 1")}}}(m);var r;r=function(){var D=m;C.FFT=function(E,F){var H=E||0.8;if(E===0){H=E}var G=F*2||2048;this.analyser=D.audiocontext.createAnalyser();D.output.connect(this.analyser);this.analyser.smoothingTimeConstant=H;this.analyser.fftSize=G;this.freqDomain=new Uint8Array(this.analyser.frequencyBinCount);this.timeDomain=new Uint8Array(this.analyser.frequencyBinCount);this.bass=[20,140];this.lowMid=[140,400];this.mid=[400,2600];this.highMid=[2600,5200];this.treble=[5200,14000]};C.FFT.prototype.setInput=function(F,E){if(E){this.analyser.fftSize=E*2}if(F.output){F.output.connect(this.analyser)}else{F.connect(this.analyser)}};C.FFT.prototype.waveform=function(F){if(F){this.analyser.fftSize=F*2}this.analyser.getByteTimeDomainData(this.timeDomain);var E=Array.apply([],this.timeDomain);E.length===this.analyser.fftSize;E.constructor===Array;return E};C.FFT.prototype.analyze=function(F){if(F){this.analyser.fftSize=F*2}this.analyser.getByteFrequencyData(this.freqDomain);var E=Array.apply([],this.freqDomain);E.length===this.analyser.fftSize;E.constructor===Array;return E};C.FFT.prototype.getEnergy=function(O,N){var G=D.audiocontext.sampleRate/2;if(O==="bass"){O=this.bass[0];N=this.bass[1]}else{if(O==="lowMid"){O=this.lowMid[0];N=this.lowMid[1]}else{if(O==="mid"){O=this.mid[0];N=this.mid[1]}else{if(O==="highMid"){O=this.highMid[0];N=this.highMid[1]}else{if(O==="treble"){O=this.treble[0];N=this.treble[1]}}}}}if(typeof O!=="number"){throw"invalid input for getEnergy()"}else{if(!N){var K=Math.round(O/G*this.freqDomain.length);return this.freqDomain[K]}else{if(O&&N){if(O>N){var F=N;N=O;O=F}var M=Math.round(O/G*this.freqDomain.length);var E=Math.round(N/G*this.freqDomain.length);var L=0;var H=0;for(var I=M;I<=E;I++){L+=this.freqDomain[I];H+=1}var J=L/H;return J}else{throw"invalid input for getEnergy()"}}}};C.FFT.prototype.getFreq=function(G,F){console.log("getFreq() is deprecated. Please use getEnergy() instead.");var E=this.getEnergy(G,F);return E};C.FFT.prototype.smooth=function(E){this.analyser.smoothingTimeConstant=E}}(m);var B;B=function(){function F(I){return I===void 0}var H;if(F(window.AudioContext)){window.AudioContext=window.webkitAudioContext}if(F(window.OfflineAudioContext)){window.OfflineAudioContext=window.webkitOfflineAudioContext}if(!F(AudioContext)){H=new AudioContext()}else{throw new Error("Web Audio is not supported in this browser")}if(typeof AudioContext.prototype.createGain!=="function"){AudioContext.prototype.createGain=AudioContext.prototype.createGainNode}if(typeof AudioContext.prototype.createDelay!=="function"){AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode}if(typeof AudioContext.prototype.createPeriodicWave!=="function"){AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable}if(typeof AudioBufferSourceNode.prototype.start!=="function"){AudioBufferSourceNode.prototype.start=AudioBufferSourceNode.prototype.noteGrainOn}if(typeof AudioBufferSourceNode.prototype.stop!=="function"){AudioBufferSourceNode.prototype.stop=AudioBufferSourceNode.prototype.noteOff}if(typeof OscillatorNode.prototype.start!=="function"){OscillatorNode.prototype.start=OscillatorNode.prototype.noteOn}if(typeof OscillatorNode.prototype.stop!=="function"){OscillatorNode.prototype.stop=OscillatorNode.prototype.noteOff}if(typeof OscillatorNode.prototype.setPeriodicWave!=="function"){OscillatorNode.prototype.setPeriodicWave=OscillatorNode.prototype.setWaveTable}AudioNode.prototype._nativeConnect=AudioNode.prototype.connect;AudioNode.prototype.connect=function(L,J,I){if(L.input){if(Array.isArray(L.input)){if(F(I)){I=0}this.connect(L.input[I])}else{this.connect(L.input,J,I)}}else{try{if(L instanceof AudioNode){this._nativeConnect(L,J,I)}else{this._nativeConnect(L,J)}}catch(K){throw new Error("error connecting to node: "+L)}}};var E=function(I,J){if(F(I)||I===1){this.input=this.context.createGain()}else{if(I>1){this.input=new Array(I)}}if(F(J)||J===1){this.output=this.context.createGain()}else{if(J>1){this.output=new Array(I)}}};E.context=H;E.prototype.context=E.context;E.prototype.bufferSize=2048;E.prototype.bufferTime=E.prototype.bufferSize/E.context.sampleRate;E.prototype.connect=function(J,I,K){if(Array.isArray(this.output)){I=this.defaultArg(I,0);this.output[I].connect(J,0,K)}else{this.output.connect(J,I,K)}};E.prototype.disconnect=function(I){if(Array.isArray(this.output)){I=this.defaultArg(I,0);this.output[I].disconnect()}else{this.output.disconnect()}};E.prototype.connectSeries=function(){if(arguments.length>1){var J=arguments[0];for(var I=1;I<arguments.length;I++){var K=arguments[I];J.connect(K);J=K}}};E.prototype.connectParallel=function(){var K=arguments[0];if(arguments.length>1){for(var I=1;I<arguments.length;I++){var J=arguments[I];K.connect(J)}}};E.prototype.chain=function(){if(arguments.length>0){var J=this;for(var I=0;I<arguments.length;I++){var K=arguments[I];J.connect(K);J=K}}};E.prototype.fan=function(){if(arguments.length>0){for(var I=1;I<arguments.length;I++){this.connect(arguments[I])}}};AudioNode.prototype.chain=E.prototype.chain;AudioNode.prototype.fan=E.prototype.fan;E.prototype.defaultArg=function(M,L){if(typeof M==="object"&&typeof L==="object"){var I={};for(var K in M){I[K]=this.defaultArg(M[K],M[K])}for(var J in L){I[J]=this.defaultArg(M[J],L[J])}return I}else{return F(M)?L:M}};E.prototype.optionsObject=function(I,L,M){var J={};if(I.length===1&&typeof I[0]==="object"){J=I[0]}else{for(var K=0;K<L.length;K++){J[L[K]]=I[K]}}if(!this.isUndef(M)){return this.defaultArg(J,M)}else{return J}};E.prototype.isUndef=F;E.prototype.equalPowerScale=function(J){var I=0.5*Math.PI;return Math.sin(J*I)};E.prototype.logScale=function(I){return Math.max(this.normalize(this.gainToDb(I),-100,0),0)};E.prototype.expScale=function(I){return this.dbToGain(this.interpolate(I,-100,0))};E.prototype.dbToGain=function(I){return Math.pow(2,I/6)};E.prototype.gainToDb=function(I){return 20*(Math.log(I)/Math.LN10)};E.prototype.interpolate=function(J,I,K){return J*(K-I)+I};E.prototype.normalize=function(I,L,K){if(L>K){var J=K;K=L;L=J}else{if(L==K){return 0}}return(I-L)/(K-L)};E.prototype.dispose=function(){if(!this.isUndef(this.input)){if(this.input instanceof AudioNode){this.input.disconnect()}this.input=null}if(!this.isUndef(this.output)){if(this.output instanceof AudioNode){this.output.disconnect()}this.output=null}};var G=null;E.prototype.noGC=function(){this.output.connect(G)};AudioNode.prototype.noGC=function(){this.connect(G)};E.prototype.now=function(){return this.context.currentTime};E.prototype.samplesToSeconds=function(I){return I/this.context.sampleRate};E.prototype.toSamples=function(I){var J=this.toSeconds(I);return Math.round(J*this.context.sampleRate)};E.prototype.toSeconds=function(K,I){I=this.defaultArg(I,this.now());if(typeof K==="number"){return K}else{if(typeof K==="string"){var J=0;if(K.charAt(0)==="+"){K=K.slice(1);J=I}return parseFloat(K)+J}else{return I}}};E.prototype.frequencyToSeconds=function(I){return 1/parseFloat(I)};E.prototype.secondsToFrequency=function(I){return 1/I};var D=[];E._initAudioContext=function(I){I(E.context);D.push(I)};E.setContext=function(I){E.prototype.context=I;E.context=I;for(var J=0;J<D.length;J++){D[J](I)}};E.extend=function(K,I){if(F(I)){I=E}function J(){}J.prototype=I.prototype;K.prototype=new J();K.prototype.constructor=K};E.startMobile=function(){var K=E.context.createOscillator();var I=E.context.createGain();I.gain.value=0;K.connect(I);I.connect(E.context.destination);var J=E.context.currentTime;K.start(J);K.stop(J+1)};E._initAudioContext(function(I){E.prototype.bufferTime=E.prototype.bufferSize/I.sampleRate;G=I.createGain();G.gain.value=0;G.connect(I.destination)});return E}();var j;j=function(D){D.SignalBase=function(){};D.extend(D.SignalBase);D.SignalBase.prototype.connect=function(F,G,E){if(F instanceof D.Signal){F.setValue(0)}else{if(F instanceof AudioParam){F.value=0}}D.prototype.connect.call(this,F,G,E)};D.SignalBase.prototype.dispose=function(){D.prototype.dispose.call(this)};return D.SignalBase}(B);var v;v=function(D){D.WaveShaper=function(E,F){this._shaper=this.input=this.output=this.context.createWaveShaper();this._curve=null;if(Array.isArray(E)){this.setCurve(E)}else{if(isFinite(E)||this.isUndef(E)){this._curve=new Float32Array(this.defaultArg(E,1024))}else{if(typeof E==="function"){this._curve=new Float32Array(this.defaultArg(F,1024));this.setMap(E)}}}};D.extend(D.WaveShaper,D.SignalBase);D.WaveShaper.prototype.setMap=function(G){for(var H=0,E=this._curve.length;H<E;H++){var I=H/E*2-1;var F=H/(E-1)*2-1;this._curve[H]=G(I,H,F)}this._shaper.curve=this._curve};D.WaveShaper.prototype.setCurve=function(E){if(this._isSafari()){var F=E[0];E.unshift(F)}this._curve=new Float32Array(E);this._shaper.curve=this._curve};D.WaveShaper.prototype.setOversample=function(E){this._shaper.oversample=E};D.WaveShaper.prototype._isSafari=function(){var E=navigator.userAgent.toLowerCase();return E.indexOf("safari")!==-1&&E.indexOf("chrome")===-1};D.WaveShaper.prototype.dispose=function(){D.prototype.dispose.call(this);this._shaper.disconnect();this._shaper=null;this._curve=null};return D.WaveShaper}(B);var k;k=function(D){D.Signal=function(E){this._scalar=this.context.createGain();this.input=this.output=this.context.createGain();this._syncRatio=1;this.value=this.defaultArg(E,0);D.Signal._constant.chain(this._scalar,this.output)};D.extend(D.Signal,D.SignalBase);D.Signal.prototype.getValue=function(){return this._scalar.gain.value};D.Signal.prototype.setValue=function(E){if(this._syncRatio===0){E=0}else{E*=this._syncRatio}this._scalar.gain.value=E};D.Signal.prototype.setValueAtTime=function(E,F){E*=this._syncRatio;this._scalar.gain.setValueAtTime(E,this.toSeconds(F))};D.Signal.prototype.setCurrentValueNow=function(F){F=this.defaultArg(F,this.now());var E=this.getValue();this.cancelScheduledValues(F);this._scalar.gain.setValueAtTime(E,F);return E};D.Signal.prototype.linearRampToValueAtTime=function(F,E){F*=this._syncRatio;this._scalar.gain.linearRampToValueAtTime(F,this.toSeconds(E))};D.Signal.prototype.exponentialRampToValueAtTime=function(F,E){F*=this._syncRatio;try{this._scalar.gain.exponentialRampToValueAtTime(F,this.toSeconds(E))}catch(G){this._scalar.gain.linearRampToValueAtTime(F,this.toSeconds(E))}};D.Signal.prototype.exponentialRampToValueNow=function(G,E){var F=this.now();this.setCurrentValueNow(F);if(E.toString().charAt(0)==="+"){E=E.substr(1)}this.exponentialRampToValueAtTime(G,F+this.toSeconds(E))};D.Signal.prototype.linearRampToValueNow=function(G,E){var F=this.now();this.setCurrentValueNow(F);G*=this._syncRatio;if(E.toString().charAt(0)==="+"){E=E.substr(1)}this._scalar.gain.linearRampToValueAtTime(G,F+this.toSeconds(E))};D.Signal.prototype.setTargetAtTime=function(G,E,F){G*=this._syncRatio;this._scalar.gain.setTargetAtTime(G,this.toSeconds(E),F)};D.Signal.prototype.setValueCurveAtTime=function(E,G,H){for(var F=0;F<E.length;F++){E[F]*=this._syncRatio}this._scalar.gain.setValueCurveAtTime(E,this.toSeconds(G),this.toSeconds(H))};D.Signal.prototype.cancelScheduledValues=function(E){this._scalar.gain.cancelScheduledValues(this.toSeconds(E))};D.Signal.prototype.sync=function(F,E){if(E){this._syncRatio=E}else{if(F.getValue()!==0){this._syncRatio=this.getValue()/F.getValue()}else{this._syncRatio=0}}this._scalar.disconnect();this._scalar=this.context.createGain();this.connectSeries(F,this._scalar,this.output);this._scalar.gain.value=this._syncRatio};D.Signal.prototype.unsync=function(){var E=this.getValue();this._scalar.disconnect();this._scalar=this.context.createGain();this._scalar.gain.value=E/this._syncRatio;this._syncRatio=1;D.Signal._constant.chain(this._scalar,this.output)};D.Signal.prototype.dispose=function(){D.prototype.dispose.call(this);this._scalar.disconnect();this._scalar=null};Object.defineProperty(D.Signal.prototype,"value",{get:function(){return this.getValue()},set:function(E){this.setValue(E)}});D.Signal._generator=null;D.Signal._constant=null;D._initAudioContext(function(E){D.Signal._generator=E.createOscillator();D.Signal._constant=new D.WaveShaper([1,1]);D.Signal._generator.connect(D.Signal._constant);D.Signal._generator.start(0);D.Signal._generator.noGC()});return D.Signal}(B);var g;g=function(D){D.Add=function(E){D.call(this,2,0);this._sum=this.input[0]=this.input[1]=this.output=this.context.createGain();this._value=null;if(isFinite(E)){this._value=new D.Signal(E);this._value.connect(this._sum)}};D.extend(D.Add,D.SignalBase);D.Add.prototype.setValue=function(E){if(this._value!==null){this._value.setValue(E)}else{throw new Error("cannot switch from signal to number")}};D.Add.prototype.dispose=function(){D.prototype.dispose.call(this);this._sum=null;if(this._value){this._value.dispose();this._value=null}};return D.Add}(B);var c;c=function(D){D.Multiply=function(E){D.call(this,2,0);this._mult=this.input[0]=this.output=this.context.createGain();this._factor=this.input[1]=this.output.gain;this._factor.value=this.defaultArg(E,0)};D.extend(D.Multiply,D.SignalBase);D.Multiply.prototype.setValue=function(E){this._factor.value=E};D.Multiply.prototype.dispose=function(){D.prototype.dispose.call(this);this._mult=null;this._factor=null};return D.Multiply}(B);var h;h=function(D){D.Scale=function(E,F){this._outputMin=this.defaultArg(E,0);this._outputMax=this.defaultArg(F,1);this._scale=this.input=new D.Multiply(1);this._add=this.output=new D.Add(0);this._scale.connect(this._add);this._setRange()};D.extend(D.Scale,D.SignalBase);D.Scale.prototype.setMin=function(E){this._outputMin=E;this._setRange()};D.Scale.prototype.setMax=function(E){this._outputMax=E;this._setRange()};D.Scale.prototype._setRange=function(){this._add.setValue(this._outputMin);this._scale.setValue(this._outputMax-this._outputMin)};D.Scale.prototype.dispose=function(){D.prototype.dispose.call(this);this._add.dispose();this._add=null;this._scale.dispose();this._scale=null};return D.Scale}(B,g,c);var y;y=function(){var H=k;var E=g;var G=c;var D=h;var F=B;var I=m;F.setContext(I.audiocontext);C.Signal=function(K){var J=new H(K);return J};H.prototype.fade=H.prototype.linearRampToValueAtTime;G.prototype.fade=H.prototype.fade;E.prototype.fade=H.prototype.fade;D.prototype.fade=H.prototype.fade;H.prototype.setInput=function(J){J.connect(this)};G.prototype.setInput=H.prototype.setInput;E.prototype.setInput=H.prototype.setInput;D.prototype.setInput=H.prototype.setInput;H.prototype.add=function(J){var K=new E(J);this.connect(K);return K};G.prototype.add=H.prototype.add;E.prototype.add=H.prototype.add;D.prototype.add=H.prototype.add;H.prototype.mult=function(J){var K=new G(J);this.connect(K);return K};G.prototype.mult=H.prototype.mult;E.prototype.mult=H.prototype.mult;D.prototype.mult=H.prototype.mult;H.prototype.scale=function(K,P,J,O){var N,L;if(arguments.length===4){N=C.prototype.map(J,K,P,0,1)-0.5;L=C.prototype.map(O,K,P,0,1)-0.5}else{N=arguments[0];L=arguments[1]}var M=new D(N,L);this.connect(M);return M};G.prototype.scale=H.prototype.scale;E.prototype.scale=H.prototype.scale;D.prototype.scale=H.prototype.scale}(k,g,c,h,B,m);var u;u=function(){var I=m;var G=k;var E=g;var F=c;var D=h;C.Oscillator=function(L,J){if(typeof L==="string"){var K=J;J=L;L=K}if(typeof J==="number"){var K=J;J=L;L=K}this.started=false;this.oscillator=I.audiocontext.createOscillator();this.f=L||440;this.oscillator.frequency.setValueAtTime(this.f,I.audiocontext.currentTime);this.oscillator.type=J||"sine";var M=this.oscillator;this.input=I.audiocontext.createGain();this.output=I.audiocontext.createGain();this._freqMods=[];this.output.gain.value=0.5;this.output.gain.setValueAtTime(0.5,I.audiocontext.currentTime);this.oscillator.connect(this.output);this.panPosition=0;this.connection=I.input;this.panner=new C.Panner(this.output,this.connection,1);this.mathOps=[this.output];I.soundArray.push(this)};C.Oscillator.prototype.start=function(O,M){if(this.started){var J=I.audiocontext.currentTime;this.stop(J)}if(!this.started){var N=M||this.f;var L=this.oscillator.type;this.oscillator=I.audiocontext.createOscillator();this.oscillator.frequency.exponentialRampToValueAtTime(Math.abs(N),I.audiocontext.currentTime);this.oscillator.type=L;this.oscillator.connect(this.output);O=O||0;this.oscillator.start(O+I.audiocontext.currentTime);this.freqNode=this.oscillator.frequency;for(var K in this._freqMods){if(typeof this._freqMods[K].connect!=="undefined"){this._freqMods[K].connect(this.oscillator.frequency)}}this.started=true}};C.Oscillator.prototype.stop=function(L){if(this.started){var K=L||0;var J=I.audiocontext.currentTime;this.oscillator.stop(K+J);this.started=false}};C.Oscillator.prototype.amp=function(L,O,M){var J=this;if(typeof L==="number"){var O=O||0;var M=M||0;var K=I.audiocontext.currentTime;var N=this.output.gain.value;this.output.gain.cancelScheduledValues(K);this.output.gain.linearRampToValueAtTime(N,K+M);this.output.gain.linearRampToValueAtTime(L,K+M+O)}else{if(L){console.log(L);L.connect(J.output.gain)}else{return this.output.gain}}};C.Oscillator.prototype.fade=C.Oscillator.prototype.amp;C.Oscillator.prototype.getAmp=function(){return this.output.gain.value};C.Oscillator.prototype.freq=function(M,N,L){if(typeof M==="number"&&!isNaN(M)){this.f=M;var J=I.audiocontext.currentTime;var N=N||0;var L=L||0;var K=this.oscillator.frequency.value;this.oscillator.frequency.cancelScheduledValues(J);this.oscillator.frequency.setValueAtTime(K,J+L);if(M>0){this.oscillator.frequency.exponentialRampToValueAtTime(M,L+N+J)}else{this.oscillator.frequency.linearRampToValueAtTime(M,L+N+J)}}else{if(M){if(M.output){M=M.output}M.connect(this.oscillator.frequency);this._freqMods.push(M)}else{return this.oscillator.frequency}}};C.Oscillator.prototype.getFreq=function(){return this.oscillator.frequency.value};C.Oscillator.prototype.setType=function(J){this.oscillator.type=J};C.Oscillator.prototype.getType=function(){return this.oscillator.type};C.Oscillator.prototype.connect=function(J){if(!J){this.panner.connect(I.input)}else{if(J.hasOwnProperty("input")){this.panner.connect(J.input);this.connection=J.input}else{this.panner.connect(J);this.connection=J}}};C.Oscillator.prototype.disconnect=function(J){this.output.disconnect();this.panner.disconnect();this.output.connect(this.panner);this.oscMods=[]};C.Oscillator.prototype.pan=function(J,K){this.panPosition=J;this.panner.pan(J,K)};C.Oscillator.prototype.getPan=function(){return this.panPosition};C.Oscillator.prototype.dispose=function(){if(this.oscillator){var J=I.audiocontext.currentTime;this.stop(J);this.disconnect();this.oscillator.disconnect();this.panner=null;this.oscillator=null}if(this.osc2){this.osc2.dispose()}};C.Oscillator.prototype.phase=function(K){if(!this.dNode){this.dNode=I.audiocontext.createDelay();this.output.disconnect();this.output.connect(this.dNode);this.dNode.connect(this.panner)}var J=I.audiocontext.currentTime;this.dNode.delayTime.linearRampToValueAtTime(C.prototype.map(K,0,1,0,1/this.oscillator.frequency.value),J)};var H=function(P,M,O,J,L){var N=P.oscillator;for(var K in P.mathOps){if(P.mathOps[K] instanceof L){N.disconnect();P.mathOps[K].dispose();O=K;if(O<P.mathOps.length-2){J=P.mathOps[K+1]}}}if(O==P.mathOps.length-1){P.mathOps.push(J)}if(K>0){N=P.mathOps[K-1]}N.disconnect();N.connect(M);M.connect(J);P.mathOps[O]=M;return P};C.Oscillator.prototype.add=function(K){var L=new E(K);var M=this.mathOps.length-1;var J=this.output;return H(this,L,M,J,E)};C.Oscillator.prototype.mult=function(K){var L=new F(K);var M=this.mathOps.length-1;var J=this.output;return H(this,L,M,J,F)};C.Oscillator.prototype.scale=function(O,R,J,M){var P,K;if(arguments.length===4){P=C.prototype.map(J,O,R,0,1)-0.5;K=C.prototype.map(M,O,R,0,1)-0.5}else{P=arguments[0];K=arguments[1]}var L=new D(P,K);var N=this.mathOps.length-1;var Q=this.output;return H(this,L,N,Q,D)};C.SinOsc=function(J){C.Oscillator.call(this,J,"sine")};C.SinOsc.prototype=Object.create(C.Oscillator.prototype);C.TriOsc=function(J){C.Oscillator.call(this,J,"triangle")};C.TriOsc.prototype=Object.create(C.Oscillator.prototype);C.SawOsc=function(J){C.Oscillator.call(this,J,"sawtooth")};C.SawOsc.prototype=Object.create(C.Oscillator.prototype);C.SqrOsc=function(J){C.Oscillator.call(this,J,"square")};C.SqrOsc.prototype=Object.create(C.Oscillator.prototype)}(m,k,g,c,h);var x;x=function(){var I=m;var F=g;var H=c;var E=h;var G=B;G.setContext(I.audiocontext);var D=null;C.Env=function(O,K,N,J,M,Q,L,P){this.aTime=O;this.aLevel=K;this.dTime=N||0;this.dLevel=J||0;this.sTime=M||0;this.sLevel=Q||0;this.rTime=L||0;this.rLevel=P||0;this.output=I.audiocontext.createGain();this.control=new C.Signal();this.control.connect(this.output);this.timeoutID=null;this.connection=null;this.mathOps=[this.control];I.soundArray.push(this)};C.Env.prototype.set=function(O,K,N,J,M,Q,L,P){this.aTime=O;this.aLevel=K;this.dTime=N||0;this.dLevel=J||0;this.sTime=M||0;this.sLevel=Q||0;this.rTime=L||0;this.rLevel=P||0};C.Env.prototype.setInput=function(J){this.connect(J)};C.Env.prototype.ctrl=function(J){this.connect(J)};C.Env.prototype.play=function(O,J){var L=I.audiocontext.currentTime;var N=J||0;var M=L+N+0.0001;if(typeof this.timeoutID==="number"){window.clearTimeout(this.timeoutID)}if(O){if(this.connection!==O){this.connect(O)}}this.control.cancelScheduledValues(M-0.0001);this.control.linearRampToValueAtTime(0,M-0.00005);this.control.linearRampToValueAtTime(this.aLevel,M+this.aTime);this.control.linearRampToValueAtTime(this.dLevel,M+this.aTime+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,M+this.aTime+this.dTime+this.sTime);this.control.linearRampToValueAtTime(this.rLevel,M+this.aTime+this.dTime+this.sTime+this.rTime);var K=M+this.aTime+this.dTime+this.sTime+this.rTime};C.Env.prototype.triggerAttack=function(O,J){var L=I.audiocontext.currentTime;var N=J||0;var M=L+N+0.0001;this.lastAttack=M;if(typeof this.timeoutID==="number"){window.clearTimeout(this.timeoutID)}var K=this.control.getValue();this.control.cancelScheduledValues(M-0.0001);this.control.linearRampToValueAtTime(K,M-0.00005);if(O){if(this.connection!==O){this.connect(O)}}this.control.linearRampToValueAtTime(this.aLevel,M+this.aTime);this.control.linearRampToValueAtTime(this.aLevel,M+this.aTime);this.control.linearRampToValueAtTime(this.dLevel,M+this.aTime+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,M+this.aTime+this.dTime+this.sTime)};C.Env.prototype.triggerRelease=function(P,S){var K=I.audiocontext.currentTime;var L=S||0;var Q=K+L+0.00001;var J;if(P){if(this.connection!==P){this.connect(P)}}this.control.cancelScheduledValues(Q-0.00001);if(K-this.lastAttack<this.aTime){var O=this.aTime-(Q-this.lastAttack);this.control.linearRampToValueAtTime(this.aLevel,Q+O);this.control.linearRampToValueAtTime(this.dLevel,Q+O+this.dTime);this.control.linearRampToValueAtTime(this.sLevel,Q+O+this.dTime+this.sTime);this.control.linearRampToValueAtTime(this.rLevel,Q+O+this.dTime+this.sTime+this.rTime);J=Q+this.dTime+this.sTime+this.rTime}else{if(K-this.lastAttack<this.aTime+this.dTime){var M=this.aTime+this.dTime-(K-this.lastAttack);this.control.linearRampToValueAtTime(this.dLevel,Q+M);this.control.linearRampToValueAtTime(this.sLevel,Q+M+0.01);this.control.linearRampToValueAtTime(this.rLevel,Q+M+0.01+this.rTime);J=Q+this.sTime+this.rTime}else{if(K-this.lastAttack<this.aTime+this.dTime+this.sTime){var R=this.aTime+this.dTime+this.sTime-(K-this.lastAttack);this.control.linearRampToValueAtTime(this.sLevel,Q+R);this.control.linearRampToValueAtTime(this.rLevel,Q+R+this.rTime);J=Q+this.rTime}else{this.control.linearRampToValueAtTime(this.sLevel,Q);this.control.linearRampToValueAtTime(this.rLevel,Q+this.rTime);J=Q+this.dTime+this.sTime+this.rTime}}}var N=Q+this.aTime+this.dTime+this.sTime+this.rTime;if(this.connection&&this.connection.hasOwnProperty("oscillator")){D=this.connection.oscillator;D.stop(N+0.01)}else{if(this.connect&&this.connection.hasOwnProperty("source")){D=this.connection.source;D.stop(N+0.01)}}};C.Env.prototype.connect=function(J){this.disconnect();this.connection=J;if(J instanceof C.Oscillator||J instanceof C.SoundFile||J instanceof C.AudioIn||J instanceof C.Reverb||J instanceof C.Noise||J instanceof C.Filter||J instanceof C.Delay){J=J.output.gain}if(J instanceof AudioParam){J.setValueAtTime(0,I.audiocontext.currentTime)}if(J instanceof C.Signal){J.setValue(0)}this.output.connect(J)};C.Env.prototype.disconnect=function(J){this.output.disconnect()};C.Env.prototype.add=function(K){var L=new F(K);var M=this.mathOps.length;var J=this.output;return C.prototype._mathChain(this,L,M,J,F)};C.Env.prototype.mult=function(K){var L=new H(K);var M=this.mathOps.length;var J=this.output;return C.prototype._mathChain(this,L,M,J,H)};C.Env.prototype.scale=function(L,P,K,O){var N=new E(L,P,K,O);var M=this.mathOps.length;var J=this.output;return C.prototype._mathChain(this,N,M,J,E)};C.Env.prototype.dispose=function(){var J=I.audiocontext.currentTime;this.disconnect();this.control.dispose();this.control=null;for(var K=1;K<this.mathOps.length;K++){mathOps[K].dispose()}}}(m,g,c,h,B);var f;f=function(){var E=m;C.Pulse=function(G,F){C.Oscillator.call(this,G,"sawtooth");this.w=F||0;this.osc2=new C.SawOsc(G);this.dNode=E.audiocontext.createDelay();this.dcOffset=D();this.dcGain=E.audiocontext.createGain();this.dcOffset.connect(this.dcGain);this.dcGain.connect(this.output);this.f=G||440;var H=this.w/this.oscillator.frequency.value;this.dNode.delayTime.value=H;this.dcGain.gain.value=1.7*(0.5-this.w);this.osc2.disconnect();this.osc2.output.gain.minValue=-10;this.osc2.output.gain.maxValue=10;this.osc2.panner.disconnect();this.osc2.amp(-1);this.osc2.output.connect(this.dNode);this.dNode.connect(this.output);this.output.gain.value=1;this.output.connect(this.panner)};C.Pulse.prototype=Object.create(C.Oscillator.prototype);C.Pulse.prototype.width=function(F){if(typeof F==="number"){if(F<=1&&F>=0){this.w=F;var H=this.w/this.oscillator.frequency.value;this.dNode.delayTime.value=H}this.dcGain.gain.value=1.7*(0.5-this.w)}else{F.connect(this.dNode.delayTime);var G=new C.SignalAdd(-0.5);G.setInput(F);G=G.mult(-1);G=G.mult(1.7);G.connect(this.dcGain.gain)}};C.Pulse.prototype.start=function(I,K){var F=E.audiocontext.currentTime;var G=K||0;if(!this.started){var J=I||this.f;var H=this.oscillator.type;this.oscillator=E.audiocontext.createOscillator();this.oscillator.frequency.setValueAtTime(J,F);this.oscillator.type=H;this.oscillator.connect(this.output);this.oscillator.start(G+F);this.osc2.oscillator=E.audiocontext.createOscillator();this.osc2.oscillator.frequency.setValueAtTime(J,G+F);this.osc2.oscillator.type=H;this.osc2.oscillator.connect(this.osc2.output);this.osc2.start(G+F);this.freqNode=[this.oscillator.frequency,this.osc2.oscillator.frequency];this.dcOffset=D();this.dcOffset.connect(this.dcGain);this.dcOffset.start(G+F);if(this.mods!==undefined&&this.mods.frequency!==undefined){this.mods.frequency.connect(this.freqNode[0]);this.mods.frequency.connect(this.freqNode[1])}this.started=true;this.osc2.started=true}};C.Pulse.prototype.stop=function(H){if(this.started){var G=H||0;var F=E.audiocontext.currentTime;this.oscillator.stop(G+F);this.osc2.oscillator.stop(G+F);this.dcOffset.stop(G+F);this.started=false;this.osc2.started=false}};C.Pulse.prototype.freq=function(I,J,H){if(typeof I==="number"){this.f=I;var F=E.audiocontext.currentTime;var J=J||0;var H=H||0;var G=this.oscillator.frequency.value;this.oscillator.frequency.cancelScheduledValues(F);this.oscillator.frequency.setValueAtTime(G,F+H);this.oscillator.frequency.exponentialRampToValueAtTime(I,H+J+F);this.osc2.oscillator.frequency.cancelScheduledValues(F);this.osc2.oscillator.frequency.setValueAtTime(G,F+H);this.osc2.oscillator.frequency.exponentialRampToValueAtTime(I,H+J+F);if(this.freqMod){this.freqMod.output.disconnect();this.freqMod=null}}else{if(I.output){I.output.disconnect();I.output.connect(this.oscillator.frequency);I.output.connect(this.osc2.oscillator.frequency);this.freqMod=I}}};function D(){var H=E.audiocontext;var F=H.createBuffer(1,2048,H.sampleRate);var I=F.getChannelData(0);for(var G=0;G<2048;G++){I[G]=1}var J=H.createBufferSource();J.buffer=F;J.loop=true;return J}}(m,u);var o;o=function(){var G=m;C.Noise=function(H){C.Oscillator.call(this);delete this.f;delete this.freq;delete this.oscillator;this.buffer=E};C.Noise.prototype=Object.create(C.Oscillator.prototype);var E=function(){var K=2*G.audiocontext.sampleRate;var H=G.audiocontext.createBuffer(1,K,G.audiocontext.sampleRate);var J=H.getChannelData(0);for(var I=0;I<K;I++){J[I]=Math.random()*2-1}H.type="white";return H}();var D=function(){var I=2*G.audiocontext.sampleRate;var H=G.audiocontext.createBuffer(1,I,G.audiocontext.sampleRate);var S=H.getChannelData(0);var R,Q,P,O,N,M,K;R=Q=P=O=N=M=K=0;for(var J=0;J<I;J++){var L=Math.random()*2-1;R=0.99886*R+L*0.0555179;Q=0.99332*Q+L*0.0750759;P=0.969*P+L*0.153852;O=0.8665*O+L*0.3104856;N=0.55*N+L*0.5329522;M=-0.7616*M-L*0.016898;S[J]=R+Q+P+O+N+M+K+L*0.5362;S[J]*=0.11;K=L*0.115926}H.type="pink";return H}();var F=function(){var M=2*G.audiocontext.sampleRate;var K=G.audiocontext.createBuffer(1,M,G.audiocontext.sampleRate);var L=K.getChannelData(0);var H=0;for(var J=0;J<M;J++){var I=Math.random()*2-1;L[J]=(H+0.02*I)/1.02;H=L[J];L[J]*=3.5}K.type="brown";return K}();C.Noise.prototype.setType=function(I){switch(I){case"white":this.buffer=E;break;case"pink":this.buffer=D;break;case"brown":this.buffer=F;break;default:this.buffer=E}if(this.started){var H=G.audiocontext.currentTime;this.stop(H);this.start(H+0.01)}};C.Noise.prototype.getType=function(){return this.buffer.type};C.Noise.prototype.start=function(){if(this.started){this.stop()}this.noise=G.audiocontext.createBufferSource();this.noise.buffer=this.buffer;this.noise.loop=true;this.noise.connect(this.output);var H=G.audiocontext.currentTime;this.noise.start(H);this.started=true};C.Noise.prototype.stop=function(){var H=G.audiocontext.currentTime;if(this.noise){this.noise.stop(H);this.started=false}};C.Noise.prototype.dispose=function(){var H=G.audiocontext.currentTime;if(this.noise){this.noise.disconnect();this.stop(H)}if(this.output){this.output.disconnect()}if(this.panner){this.panner.disconnect()}this.output=null;this.panner=null;this.buffer=null;this.noise=null}}(m);var e;e=function(){var D=m;C.AudioIn=function(){this.input=D.audiocontext.createGain();this.output=D.audiocontext.createGain();this.stream=null;this.mediaStream=null;this.currentSource=0;this.enabled=false;this.amplitude=new C.Amplitude();this.output.connect(this.amplitude.input);if(typeof window.MediaStreamTrack==="undefined"){window.alert("This browser does not support MediaStreamTrack")}else{if(typeof window.MediaStreamTrack.getSources!=="undefined"){window.MediaStreamTrack.getSources(this._gotSources)}else{}}D.soundArray.push(this)};C.AudioIn.prototype.start=function(){var E=this;if(D.inputSources[E.currentSource]){var F=D.inputSources[E.currentSource].id;var G={audio:{optional:[{sourceId:F}]}};navigator.getUserMedia(G,this._onStream=function(H){E.stream=H;E.enabled=true;E.mediaStream=D.audiocontext.createMediaStreamSource(H);E.mediaStream.connect(E.output);E.amplitude.setInput(E.output)},this._onStreamError=function(H){console.error(H)})}else{window.navigator.getUserMedia({audio:true},this._onStream=function(H){E.stream=H;E.enabled=true;E.mediaStream=D.audiocontext.createMediaStreamSource(H);E.mediaStream.connect(E.output);E.amplitude.setInput(E.output)},this._onStreamError=function(H){console.error(H)})}};C.AudioIn.prototype.stop=function(){if(this.stream){this.stream.stop()}};C.AudioIn.prototype.connect=function(E){if(E){if(E.hasOwnProperty("input")){this.output.connect(E.input)}else{if(E.hasOwnProperty("analyser")){this.output.connect(E.analyser)}else{this.output.connect(E)}}}else{this.output.connect(D.input)}};C.AudioIn.prototype.disconnect=function(E){this.output.disconnect(E);this.output.connect(this.amplitude.input)};C.AudioIn.prototype.getLevel=function(E){if(E){this.amplitude.smoothing=E}return this.amplitude.getLevel()};C.AudioIn.prototype._gotSources=function(F){for(var E=0;E!==F.length;E++){var G=F[E];if(G.kind==="audio"){D.inputSources.push(G)}}};C.AudioIn.prototype.amp=function(F,E){if(E){var H=E||0;var G=this.output.gain.value;this.output.gain.cancelScheduledValues(D.audiocontext.currentTime);this.output.gain.setValueAtTime(G,D.audiocontext.currentTime);this.output.gain.linearRampToValueAtTime(F,H+D.audiocontext.currentTime)}else{this.output.gain.cancelScheduledValues(D.audiocontext.currentTime);this.output.gain.setValueAtTime(F,D.audiocontext.currentTime)}};C.AudioIn.prototype.listSources=function(){console.log("input sources: ");console.log(D.inputSources);if(D.inputSources.length>0){return D.inputSources}else{return"This browser does not support MediaStreamTrack.getSources()"}};C.AudioIn.prototype.setSource=function(F){var E=this;if(D.inputSources.length>0&&F<D.inputSources.length){E.currentSource=F;console.log("set source to "+D.inputSources[E.currentSource].id)}else{console.log("unable to set input source")}};C.AudioIn.prototype.dispose=function(){this.stop();if(this.output){this.output.disconnect()}if(this.amplitude){this.amplitude.disconnect()}this.amplitude=null;this.output=null}}(m);var l;l=function(){var D=m;C.Filter=function(E){this.ac=D.audiocontext;this.input=this.ac.createGain();this.output=this.ac.createGain();this.biquad=this.ac.createBiquadFilter();this.input.connect(this.biquad);this.biquad.connect(this.output);this.connect();if(E){this.setType(E)}};C.Filter.prototype.process=function(G,F,E){G.connect(this.input);this.set(F,E)};C.Filter.prototype.set=function(G,E,F){if(G){this.freq(G,F)}if(E){this.res(E,F)}};C.Filter.prototype.freq=function(H,G){var E=this;var F=G||0;if(H<=0){H=1}if(typeof H==="number"){E.biquad.frequency.value=H;E.biquad.frequency.cancelScheduledValues(this.ac.currentTime+0.01+F);E.biquad.frequency.exponentialRampToValueAtTime(H,this.ac.currentTime+0.02+F)}else{if(H){H.connect(this.biquad.frequency)}}return E.biquad.frequency.value};C.Filter.prototype.res=function(G,H){var E=this;var F=H||0;if(typeof G=="number"){E.biquad.Q.value=G;E.biquad.Q.cancelScheduledValues(E.ac.currentTime+0.01+F);E.biquad.Q.linearRampToValueAtTime(G,E.ac.currentTime+0.02+F)}else{if(G){freq.connect(this.biquad.Q)}}return E.biquad.Q.value};C.Filter.prototype.setType=function(E){this.biquad.type=E};C.Filter.prototype.amp=function(F,I,G){var I=I||0;var G=G||0;var E=D.audiocontext.currentTime;var H=this.output.gain.value;this.output.gain.cancelScheduledValues(E);this.output.gain.linearRampToValueAtTime(H,E+G+0.001);this.output.gain.linearRampToValueAtTime(F,E+G+I+0.001)};C.Filter.prototype.connect=function(F){var E=F||C.soundOut.input;this.output.connect(E)};C.Filter.prototype.disconnect=function(){this.output.disconnect()};C.LowPass=function(){C.Filter.call(this,"lowpass")};C.LowPass.prototype=Object.create(C.Filter.prototype);C.HighPass=function(){C.Filter.call(this,"highpass")};C.HighPass.prototype=Object.create(C.Filter.prototype);C.BandPass=function(){C.Filter.call(this,"bandpass")};C.BandPass.prototype=Object.create(C.Filter.prototype)}(m);var A;A=function(){var E=m;var D=l;C.Delay=function(){this.ac=E.audiocontext;this.input=this.ac.createGain();this.output=this.ac.createGain();this._split=this.ac.createChannelSplitter(2);this._merge=this.ac.createChannelMerger(2);this._leftGain=this.ac.createGain();this._rightGain=this.ac.createGain();this.leftDelay=this.ac.createDelay();this.rightDelay=this.ac.createDelay();this._leftFilter=new C.Filter();this._rightFilter=new C.Filter();this._leftFilter.disconnect();this._rightFilter.disconnect();this.lowPass=this._leftFilter;this._leftFilter.biquad.frequency.setValueAtTime(1200,this.ac.currentTime);this._rightFilter.biquad.frequency.setValueAtTime(1200,this.ac.currentTime);this._leftFilter.biquad.Q.setValueAtTime(0.3,this.ac.currentTime);this._rightFilter.biquad.Q.setValueAtTime(0.3,this.ac.currentTime);this.input.connect(this._split);this.leftDelay.connect(this._leftGain);this.rightDelay.connect(this._rightGain);this._leftGain.connect(this._leftFilter.input);this._rightGain.connect(this._rightFilter.input);this._merge.connect(this.output);this.output.connect(C.soundOut.input);this._leftFilter.biquad.gain.setValueAtTime(1,this.ac.currentTime);this._rightFilter.biquad.gain.setValueAtTime(1,this.ac.currentTime);this.setType(0);this._maxDelay=this.leftDelay.delayTime.maxValue};C.Delay.prototype.process=function(K,F,H,J){var G=H||0;var I=F||0;if(G>=1){throw new Error("Feedback value will force a positive feedback loop.")}if(I>=this._maxDelay){throw new Error("Delay Time exceeds maximum delay time of "+this._maxDelay+" second.")}K.connect(this.input);this.leftDelay.delayTime.setValueAtTime(I,this.ac.currentTime);this.rightDelay.delayTime.setValueAtTime(I,this.ac.currentTime);this._leftGain.gain.setValueAtTime(G,this.ac.currentTime);this._rightGain.gain.setValueAtTime(G,this.ac.currentTime);if(J){this._leftFilter.freq(J);this._rightFilter.freq(J)}};C.Delay.prototype.delayTime=function(F){if(typeof F!=="number"){F.connect(this.leftDelay.delayTime);F.connect(this.rightDelay.delayTime)}else{this.leftDelay.delayTime.cancelScheduledValues(this.ac.currentTime);this.rightDelay.delayTime.cancelScheduledValues(this.ac.currentTime);this.leftDelay.delayTime.linearRampToValueAtTime(F,this.ac.currentTime);this.rightDelay.delayTime.linearRampToValueAtTime(F,this.ac.currentTime)}};C.Delay.prototype.feedback=function(F){if(typeof F!=="number"){F.connect(this._leftGain.gain);F.connect(this._rightGain.gain)}else{if(F>=1){throw new Error("Feedback value will force a positive feedback loop.")}else{this._leftGain.gain.exponentialRampToValueAtTime(F,this.ac.currentTime);this._rightGain.gain.exponentialRampToValueAtTime(F,this.ac.currentTime)}}};C.Delay.prototype.filter=function(G,F){this._leftFilter.set(G,F);this._rightFilter.set(G,F)};C.Delay.prototype.setType=function(F){if(F===1){F="pingPong"}this._split.disconnect();this._leftFilter.disconnect();this._rightFilter.disconnect();this._split.connect(this.leftDelay,0);this._split.connect(this.rightDelay,1);switch(F){case"pingPong":this._rightFilter.setType(this._leftFilter.biquad.type);this._leftFilter.output.connect(this._merge,0,0);this._rightFilter.output.connect(this._merge,0,1);this._leftFilter.output.connect(this.rightDelay);this._rightFilter.output.connect(this.leftDelay);break;default:this._leftFilter.output.connect(this._merge,0,0);this._leftFilter.output.connect(this._merge,0,1);this._leftFilter.output.connect(this.leftDelay);this._leftFilter.output.connect(this.rightDelay)}};C.Delay.prototype.amp=function(G,J,H){var J=J||0;var H=H||0;var F=E.audiocontext.currentTime;var I=this.output.gain.value;this.output.gain.cancelScheduledValues(F);this.output.gain.linearRampToValueAtTime(I,F+H+0.001);this.output.gain.linearRampToValueAtTime(G,F+H+J+0.001)};C.Delay.prototype.connect=function(G){var F=G||C.soundOut.input;this.output.connect(F)};C.Delay.prototype.disconnect=function(){this.output.disconnect()}}(m,l);var n;n=function(){var D=m;C.Reverb=function(){this.ac=D.audiocontext;this.convolverNode=this.ac.createConvolver();this.input=this.ac.createGain();this.output=this.ac.createGain();this.input.gain.value=0.5;this.input.connect(this.convolverNode);this.convolverNode.connect(this.output);this._seconds=3;this._decay=2;this._reverse=false;this._buildImpulse();this.connect();D.soundArray.push(this)};C.Reverb.prototype.process=function(I,H,G,F){I.connect(this.input);var E=false;if(H){this._seconds=H;E=true}if(G){this._decay=G}if(F){this._reverse=F}if(E){this._buildImpulse()}};C.Reverb.prototype.set=function(H,G,F){var E=false;if(H){this._seconds=H;E=true}if(G){this._decay=G}if(F){this._reverse=F}if(E){this._buildImpulse()}};C.Reverb.prototype.amp=function(F,I,G){var I=I||0;var G=G||0;var E=D.audiocontext.currentTime;var H=this.output.gain.value;this.output.gain.cancelScheduledValues(E);this.output.gain.linearRampToValueAtTime(H,E+G+0.001);this.output.gain.linearRampToValueAtTime(F,E+G+I+0.001)};C.Reverb.prototype.connect=function(F){var E=F||C.soundOut.input;this.output.connect(E.input?E.input:E)};C.Reverb.prototype.disconnect=function(){this.output.disconnect()};C.Reverb.prototype._buildImpulse=function(){var G=this.ac.sampleRate;var I=G*this._seconds;var H=this._decay;var K=this.ac.createBuffer(2,I,G);var E=K.getChannelData(0);var J=K.getChannelData(1);var L,F;for(F=0;F<I;F++){L=this.reverse?I-F:F;E[F]=(Math.random()*2-1)*Math.pow(1-L/I,H);J[F]=(Math.random()*2-1)*Math.pow(1-L/I,H)}this.convolverNode.buffer=K};C.Reverb.prototype.dispose=function(){this.convolverNode.buffer=null;this.convolverNode=null;if(typeof this.output!=="undefined"){this.output.disconnect();this.output=null}if(typeof this.panner!=="undefined"){this.panner.disconnect();this.panner=null}};C.Convolver=function(E,F){this.ac=D.audiocontext;this.convolverNode=this.ac.createConvolver();this.input=this.ac.createGain();this.output=this.ac.createGain();this.input.gain.value=0.5;this.input.connect(this.convolverNode);this.convolverNode.connect(this.output);if(E){this.impulses=[];this._loadBuffer(E,F)}else{this._seconds=3;this._decay=2;this._reverse=false;this._buildImpulse()}this.connect();D.soundArray.push(this)};C.Convolver.prototype=Object.create(C.Reverb.prototype);C.prototype.registerPreloadMethod("createConvolver");C.prototype.createConvolver=function(F,G){if(window.location.origin.indexOf("file://")>-1){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}var E=new C.Convolver(F,G);E.impulses=[];return E};C.Convolver.prototype._loadBuffer=function(G,H){G=C.prototype._checkFileFormats(G);var F=new XMLHttpRequest();F.open("GET",G,true);F.responseType="arraybuffer";var E=this;F.onload=function(){var I=C.prototype.getAudioContext();I.decodeAudioData(F.response,function(L){var J={};var K=G.split("/");J.name=K[K.length-1];J.audioBuffer=L;E.impulses.push(J);E.convolverNode.buffer=J.audioBuffer;if(H){H(J)}})};F.send()};C.Convolver.prototype.set=null;C.Convolver.prototype.process=function(E){E.connect(this.input)};C.Convolver.prototype.impulses=[];C.Convolver.prototype.addImpulse=function(E,F){if(window.location.origin.indexOf("file://")>-1){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}this._loadBuffer(E,F)};C.Convolver.prototype.resetImpulse=function(E,F){if(window.location.origin.indexOf("file://")>-1){alert("This sketch may require a server to load external files. Please see http://bit.ly/1qcInwS")}this.impulses=[];this._loadBuffer(E,F)};C.Convolver.prototype.toggleImpulse=function(F){if(typeof F==="number"&&F<this.impulses.length){this.convolverNode.buffer=this.impulses[F].audioBuffer}if(typeof F==="string"){for(var E=0;E<this.impulses.length;E++){if(this.impulses[E].name===F){this.convolverNode.buffer=this.impulses[E].audioBuffer;break}}}};C.Convolver.prototype.dispose=function(){for(var E in this.impulses){this.impulses[E]=null}this.convolverNode.disconnect();this.concolverNode=null;if(typeof this.output!=="undefined"){this.output.disconnect();this.output=null}if(typeof this.panner!=="undefined"){this.panner.disconnect();this.panner=null}}}(m,q);var p;p=function(D){D.Clock=function(E,F){this._oscillator=null;this._jsNode=this.context.createScriptProcessor(this.bufferSize,1,1);this._jsNode.onaudioprocess=this._processBuffer.bind(this);this._controlSignal=new D.Signal(1);this._upTick=false;this.tick=this.defaultArg(F,function(){});this._jsNode.noGC();this.setRate(E)};D.extend(D.Clock);D.Clock.prototype.setRate=function(E,G){var F=this.secondsToFrequency(this.toSeconds(E));if(!G){this._controlSignal.cancelScheduledValues(0);this._controlSignal.setValue(F)}else{this._controlSignal.exponentialRampToValueNow(F,G)}};D.Clock.prototype.getRate=function(){return this._controlSignal.getValue()};D.Clock.prototype.start=function(F){this._oscillator=this.context.createOscillator();this._oscillator.type="square";this._oscillator.connect(this._jsNode);this._controlSignal.connect(this._oscillator.frequency);this._upTick=false;var E=this.toSeconds(F);this._oscillator.start(E);this._oscillator.onended=function(){}};D.Clock.prototype.stop=function(G,F){var E=this.toSeconds(G);this._oscillator.onended=F;this._oscillator.stop(E)};D.Clock.prototype._processBuffer=function(J){var F=this.defaultArg(J.playbackTime,this.now());var L=this._jsNode.bufferSize;var I=J.inputBuffer.getChannelData(0);var K=this._upTick;var E=this;for(var G=0;G<L;G++){var H=I[G];if(H>0&&!K){K=true;setTimeout(function(){var M=F+E.samplesToSeconds(G+L*2);return function(){E.tick(M)}}(),0)}else{if(H<0&&K){K=false}}}this._upTick=K};D.Clock.prototype.dispose=function(){this._jsNode.disconnect();this._controlSignal.dispose();if(this._oscillator){this._oscillator.onended();this._oscillator.disconnect()}this._jsNode.onaudioprocess=function(){};this._jsNode=null;this._controlSignal=null;this._oscillator=null};return D.Clock}(B);var z;z=function(){var F=m;var H=p;var D=F.audiocontext;C.Metro=function(){this.clock=new H(D.sampleRate,this.ontick.bind(this));this.syncedParts=[];this.bpm=120;this._init();this.tickCallback=function(){}};var G=0;var E=0;C.Metro.prototype.ontick=function(N){var P=N-G;var Q=N-F.audiocontext.currentTime;if(P-E<=-0.02){return}else{G=N;for(var L in this.syncedParts){var J=this.syncedParts[L];J.incrementStep(Q);for(var K in J.phrases){var M=J.phrases[K];var I=M.sequence;var O=this.metroTicks%I.length;if(I[O]!==0&&(this.metroTicks<I.length||!M.looping)){M.callback(I[O],Q)}}}this.metroTicks+=1;this.tickCallback(Q)}};C.Metro.prototype.setBPM=function(K,L){var J=60/(K*this.tatums);E=J;var I=L||0;this.clock.setRate(J,L+F.audiocontext.currentTime);this.bpm=K};C.Metro.prototype.getBPM=function(I){return this.clock.getRate()/this.tatums*60};C.Metro.prototype._init=function(){this.metroTicks=0};C.Metro.prototype.resetSync=function(I){this.syncedParts=[I]};C.Metro.prototype.pushSync=function(I){this.syncedParts.push(I)};C.Metro.prototype.start=function(J){var I=J||0;this.clock.start(I);this.setBPM(this.bpm)};C.Metro.prototype.stop=function(J){var I=J||0;if(this.clock._oscillator){this.clock.stop(I)}};C.Metro.prototype.beatLength=function(I){this.tatums=1/I/4}}(m,p);var a;a=function(){var F=m;var E=120;C.prototype.setBPM=function(H,I){E=H;for(var G in F.parts){F.parts[G].setBPM(E,I)}};C.Phrase=function(G,I,H){this.phraseStep=0;this.name=G;this.callback=I;this.sequence=H};C.Part=function(G,H){this.length=G||0;this.partStep=0;this.phrases=[];this.looping=false;this.isPlaying=false;this.onended=function(){this.stop()};this.tatums=H||0.0625;this.metro=new C.Metro();this.metro._init();this.metro.beatLength(this.tatums);this.metro.setBPM(E);F.parts.push(this);this.callback=function(){}};C.Part.prototype.setBPM=function(G,H){this.metro.setBPM(G,H)};C.Part.prototype.getBPM=function(){return this.metro.getBPM()};C.Part.prototype.start=function(H){if(!this.isPlaying){this.isPlaying=true;this.metro.resetSync(this);var G=H||0;this.metro.start(G)}};C.Part.prototype.loop=function(H){this.looping=true;this.onended=function(){this.partStep=0};var G=H||0;this.start(G)};C.Part.prototype.noLoop=function(){this.looping=false;this.onended=function(){this.stop()}};C.Part.prototype.stop=function(G){this.partStep=0;this.pause(G)};C.Part.prototype.pause=function(H){this.isPlaying=false;var G=H||0;this.metro.stop(G)};C.Part.prototype.addPhrase=function(G,J,I){var H;if(arguments.length===3){H=new C.Phrase(G,J,I)}else{if(arguments[0] instanceof C.Phrase){H=arguments[0]}else{throw"invalid input. addPhrase accepts name, callback, array or a p5.Phrase"}}this.phrases.push(H);if(H.sequence.length>this.length){this.length=H.sequence.length}};C.Part.prototype.removePhrase=function(G){for(var H in this.phrases){if(this.phrases[H].name===G){this.phrases.split(H,1)}}};C.Part.prototype.getPhrase=function(G){for(var H in this.phrases){if(this.phrases[H].name===G){return this.phrases[H]}}};C.Part.prototype.replaceSequence=function(G,I){for(var H in this.phrases){if(this.phrases[H].name===G){this.phrases[H].sequence=I}}};C.Part.prototype.incrementStep=function(G){if(this.partStep<this.length-1){this.callback(G);this.partStep+=1}else{if(this.looping){this.callback(G)}this.onended();this.partStep=0}};C.Part.prototype.onStep=function(G){this.callback=G};C.Score=function(){this.parts=[];this.currentPart=0;var G=this;for(var H in arguments){this.parts[H]=arguments[H];this.parts[H].nextPart=this.parts[H+1];this.parts[H].onended=function(){G.resetPart(H);D(G)}}this.looping=false};C.Score.prototype.onended=function(){if(this.looping){this.parts[0].start()}else{this.parts[this.parts.length-1].onended=function(){this.stop();this.resetParts()}}this.currentPart=0};C.Score.prototype.start=function(){this.parts[this.currentPart].start();this.scoreStep=0};C.Score.prototype.stop=function(){this.parts[this.currentPart].stop();this.currentPart=0;this.scoreStep=0};C.Score.prototype.pause=function(){this.parts[this.currentPart].stop()};C.Score.prototype.loop=function(){this.looping=true;this.start()};C.Score.prototype.noLoop=function(){this.looping=false};C.Score.prototype.resetParts=function(){for(var G in this.parts){this.resetPart(G)}};C.Score.prototype.resetPart=function(G){this.parts[G].stop();this.parts[G].partStep=0;for(var H in this.parts[G].phrases){this.parts[G].phrases[H].phraseStep=0}};C.Score.prototype.setBPM=function(H,I){for(var G in this.parts){this.parts[G].setBPM(H,I)}};function D(G){G.currentPart++;if(G.currentPart>=G.parts.length){G.scoreStep=0;G.onended()}else{G.scoreStep=0;G.parts[G.currentPart-1].stop();G.parts[G.currentPart].start()}}}(m);var t;t=function(){var G=m;var F=G.audiocontext;C.SoundRecorder=function(){this.input=F.createGain();this.output=F.createGain();this.recording=false;this.bufferSize=1024;this._channels=2;this._clear();this._jsNode=F.createScriptProcessor(this.bufferSize,this._channels,2);this._jsNode.onaudioprocess=this._audioprocess.bind(this);this._callback=function(){};this._jsNode.connect(C.soundOut._silentNode);this.setInput();G.soundArray.push(this)};C.SoundRecorder.prototype.setInput=function(H){this.input.disconnect();this.input=null;this.input=F.createGain();this.input.connect(this._jsNode);this.input.connect(this.output);if(H){H.connect(this.input)}else{C.soundOut.output.connect(this.input)}};C.SoundRecorder.prototype.record=function(I,H,J){this.recording=true;if(H){this.sampleLimit=Math.round(H*F.sampleRate)}if(I&&J){this._callback=function(){this.buffer=this._getBuffer();I.setBuffer(this.buffer);J()}}else{if(I){this._callback=function(){this.buffer=this._getBuffer();I.setBuffer(this.buffer)}}}};C.SoundRecorder.prototype.stop=function(){this.recording=false;this._callback();this._clear()};C.SoundRecorder.prototype._clear=function(){this._leftBuffers=[];this._rightBuffers=[];this.recordedSamples=0;this.sampleLimit=null};C.SoundRecorder.prototype._audioprocess=function(I){if(this.recording===false){return}else{if(this.recording===true){if(this.sampleLimit&&this.recordedSamples>=this.sampleLimit){this.stop()}else{var J=I.inputBuffer.getChannelData(0);var H=I.inputBuffer.getChannelData(1);this._leftBuffers.push(new Float32Array(J));this._rightBuffers.push(new Float32Array(H));this.recordedSamples+=this.bufferSize}}}};C.SoundRecorder.prototype._getBuffer=function(){var H=[];H.push(this._mergeBuffers(this._leftBuffers));H.push(this._mergeBuffers(this._rightBuffers));return H};C.SoundRecorder.prototype._mergeBuffers=function(L){var H=new Float32Array(this.recordedSamples);var M=0;var J=L.length;for(var K=0;K<J;K++){var I=L[K];H.set(I,M);M+=I.length}return H};C.SoundRecorder.prototype.dispose=function(){this._clear();this._callback=function(){};if(this.input){this.input.disconnect()}this.input=null;this._jsNode=null};C.prototype.saveSound=function(H,I){var O=H.buffer.getChannelData(0);var J=H.buffer.getChannelData(1);var R=D(O,J);var K=new ArrayBuffer(44+R.length*2);var Q=new DataView(K);E(Q,0,"RIFF");Q.setUint32(4,44+R.length*2,true);E(Q,8,"WAVE");E(Q,12,"fmt ");Q.setUint32(16,16,true);Q.setUint16(20,1,true);Q.setUint16(22,2,true);Q.setUint32(24,44100,true);Q.setUint32(28,44100*4,true);Q.setUint16(32,4,true);Q.setUint16(34,16,true);E(Q,36,"data");Q.setUint32(40,R.length*2,true);var P=R.length;var N=44;var M=1;for(var L=0;L<P;L++){Q.setInt16(N,R[L]*(32767*M),true);N+=2}C.prototype.writeFile([Q],I,"wav")};function D(J,I){var L=J.length+I.length;var H=new Float32Array(L);var M=0;for(var K=0;K<L;){H[K++]=J[M];H[K++]=I[M];M++}return H}function E(H,L,J){var I=J.length;for(var K=0;K<I;K++){H.setUint8(L+K,J.charCodeAt(K))}}}(q,m);var b;b=function(){var D=q;return D}(q,m,s,w,d,i,r,y,u,x,f,o,e,l,A,n,z,a,t)}));