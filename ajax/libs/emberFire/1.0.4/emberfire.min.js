!function(){"use strict";if(void 0!==window.DS){var a=Ember.RSVP.Promise,b=Ember.EnumerableUtils.map,c=Ember.EnumerableUtils.forEach,d=Ember.String.fmt;DS.FirebaseSerializer=DS.JSONSerializer.extend(Ember.Evented,{normalize:function(a,b){return a.eachRelationship(function(c,e){if("hasMany"===e.kind)if("object"!=typeof b[c]||Ember.isArray(b[c])||e.options.embedded===!0){if(Ember.isArray(b[c]))throw new Error(d('%@ relationship %@(\'%@\') must be a key/value map in Firebase. Example: { "%@": { "%@_id": true } }',[a.toString(),e.kind,e.type.typeKey,e.key,e.type.typeKey]))}else b[c]=Ember.keys(b[c])}),this._super.apply(this,arguments)},extractSingle:function(a,b,c){var d=a.adapterFor(b),e=this.normalize(b,c);return b.eachRelationship(function(b,f){if(!Ember.isNone(c[b])&&f.options.embedded===!0){var g,h,i=e[b],j=[];for(g in i)h=i[g],null!==h&&"object"==typeof h&&(h.id=g),j.push(h);e[b]=Ember.keys(e[b]),d._enqueue?d._enqueue(function(){a.pushMany(f.type,j)}):a.pushMany(f.type,j)}}),e},extractArray:function(a,c,d){return b(d,function(b){return this.extractSingle(a,c,b)},this)}}),DS.FirebaseAdapter=DS.Adapter.extend(Ember.Evented,{defaultSerializer:"-firebase",init:function(){if(!this.firebase||"object"!=typeof this.firebase)throw new Error("Please set the `firebase` property on the adapter.");this._ref=this.firebase.ref(),this._findAllMapForType={},this._queue=[]},generateIdForRecord:function(){return this._ref.push().name()},_assignIdToPayload:function(a){var b=a.val();return null!==b&&"object"==typeof b&&"undefined"==typeof b.id&&(b.id=a.name()),b},find:function(b,c,e){var f=this,g=!1,h=this._getRef(c,e),i=b.serializerFor(c);return new a(function(a,j){h.on("value",function(k){var l=f._assignIdToPayload(k),m=b.getById(c,k.name());g?f._enqueue(null===l&&m&&!m.get("isDeleted")?function(){b.getById(c,k.name()).deleteRecord()}:function(){b.push(c,i.extractSingle(b,c,l))}):(g=!0,null===l?f._enqueue(j,[{message:d("no record was found at %@",[h.toString()]),recordId:e}]):f._enqueue(a,[l]))},function(a){g||f._enqueue(j,[a])})},d("DS: FirebaseAdapter#find %@ to %@",[c,h.toString()]))},findMany:function(a,d,e){var f=b(e,function(b){return this.find(a,d,b)},this);return Ember.RSVP.allSettled(f).then(function(b){return b=Ember.A(b),c(b.filterBy("state","rejected"),function(b){var c=b.reason.recordId;if(a.hasRecordForId(d,c)){var e=a.getById(d,c);e.transitionTo("loaded.created.uncommitted"),a.deleteRecord(e)}}),Ember.A(b.filterBy("state","fulfilled")).mapBy("value")})},findAll:function(b,c){var e=this,f=this._getRef(c);return new a(function(a,d){var g;e._findAllHasEventsForType(c)||(g=e._findAllAddEventListeners(b,c,f)),f.once("value",function(b){if(g&&Ember.run(null,g.resolve),null===b.val())e._enqueue(d);else{var c=[];b.forEach(function(a){var b=e._assignIdToPayload(a);c.push(b)}),e._enqueue(a,[c])}})},d("DS: FirebaseAdapter#findAll %@ to %@",[c,f.toString()]))},_findAllMapForType:void 0,_findAllHasEventsForType:function(a){return!Ember.isNone(this._findAllMapForType[a])},_findAllAddEventListeners:function(a,b,c){this._findAllMapForType[b]=!0;var d=Ember.RSVP.defer(),e=this,f=a.serializerFor(b),g=!1;return d.promise.then(function(){g=!0}),c.on("child_added",function(c){g&&e._handleChildValue(a,b,f,c)}),c.on("child_changed",function(c){g&&e._handleChildValue(a,b,f,c)}),c.on("child_removed",function(c){if(g){var d=a.getById(b,c.name());d&&!d.get("isDeleted")&&e._enqueue(function(){a.deleteRecord(d)})}}),d},_handleChildValue:function(a,b,c,d){var e=this._assignIdToPayload(d);this._enqueue(function(){a.push(b,c.extractSingle(a,b,e))})},createRecord:function(a,b,c){return this.updateRecord(a,b,c)},updateRecord:function(b,c,e){var f=this,g=e.serialize({includeId:!1}),h=this._getRef(c,e.id);return new a(function(a,i){var j=Ember.A();e.eachRelationship(function(a,c){switch(c.kind){case"hasMany":if(Ember.isArray(g[a])){var d=f._saveHasManyRelationship(b,c,g[a],h);j.push(d),delete g[a]}}}),Ember.RSVP.allSettled(j).then(function(b){b=Ember.A(b);var j=Ember.A(b.filterBy("state","rejected"));if(0!==j.get("length")){var k=new Error(d("Some errors were encountered while saving %@ %@",[c,e.id]));k.errors=j.mapBy("reason"),f._enqueue(i,[k])}h.update(g,function(b){b?f._enqueue(i,[b]):f._enqueue(a)})})},d("DS: FirebaseAdapter#updateRecord %@ to %@",[c,h.toString()]))},_saveHasManyRelationship:function(a,c,e,f){if(!Ember.isArray(e))throw new Error("hasMany relationships must must be an array");var g=b(e,function(b){return this._saveHasManyRelationshipRecord(a,c,f,b)},this);return Ember.RSVP.allSettled(g).then(function(a){var b=Ember.A(Ember.A(a).filterBy("state","rejected"));if(0===b.get("length"))return a;var e=new Error(d("Some errors were encountered while saving a hasMany relationship %@ -> %@",[c.parentType,c.type]));throw e.errors=Ember.A(b).mapBy("reason"),e})},_saveHasManyRelationshipRecord:function(b,c,d,e){var f=this,g=this._getRelationshipRef(d,c.key,e),h=b.hasRecordForId(c.type,e)?b.getById(c.type,e):!1,i=c.options.embedded===!0,j=h?h.get("isDirty"):!1,k=i?h.serialize({includeId:!1}):!0;return new a(function(a,b){if(i&&h&&j||!i&&(h&&j||!h)){var c=function(c){c?("object"==typeof c&&(c.location=g.toString()),f._enqueue(b,[c])):f._enqueue(a)};i?g.update(k,c):g.set(k,c)}else f._enqueue(a)})},deleteRecord:function(b,c,e){var f=this,g=this._getRef(c,e.id);return new a(function(a,b){g.remove(function(c){c?f._enqueue(b,[c]):f._enqueue(a)})},d("DS: FirebaseAdapter#deleteRecord %@ to %@",[c,g.toString()]))},pathForType:function(a){var b=Ember.String.camelize(a);return Ember.String.pluralize(b)},_getRef:function(a,b){var c=this._ref;return a&&(c=c.child(this.pathForType(a.typeKey))),b&&(c=c.child(b)),c},_getRelationshipRef:function(a,b,c){return a.child(b).child(c)},_queueFlushDelay:1e3/60,_queueScheduleFlush:function(){Ember.run.later(this,this._queueFlush,this._queueFlushDelay)},_queueFlush:function(){c(this._queue,function(a){var b=a[0],c=a[1];b.apply(null,c)}),this._queue.length=0},_enqueue:function(a,b){var c=this._queue.push([a,b]);1===c&&this._queueScheduleFlush()}}),Ember.onLoad("Ember.Application",function(a){a.initializer({name:"firebase",after:"store",initialize:function(a,b){b.register("adapter:-firebase",DS.FirebaseAdapter),b.register("serializer:-firebase",DS.FirebaseSerializer)}})})}}();