/*!
 * Cropper v0.3.0
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){"use strict";var b=a(window),c=a(document),d=function(b,c){c=a.isPlainObject(c)?c:{},this.$element=a(b),this.defaults=a.extend({},d.defaults,this.$element.data(),c),this.init()};d.prototype={construstor:d,init:function(){var b=this.defaults.aspectRatio;b=a.isNumeric(b)?b>0?b:1:0/0,this.defaults.aspectRatio=b,this.enable()},enable:function(){var b,c=this.$element;if(!this.active){if(b=c.prop("src"),!b)throw new Error("Invalid image!");this.url=b,this.$cropper=a(d.template),this.$dragger=this.$cropper.find(".cropper-dragger"),d.fn.toggle(c),c.after(this.$cropper),this.defaults.modal||d.fn.toggle(this.$cropper.find(".cropper-modal")),this.setPreview(),this.setImage(),this.addListener(),this.active=!0}},disable:function(){this.active&&(this.removeListener(),this.$cropper.empty().remove(),d.fn.toggle(this.$element),this.$cropper=null,this.$dragger=null,this.$preview=null,this.cropper=null,this.dragger=null,this.image=null,this.url="",this.active=!1)},addListener:function(){this.$element.on("load",a.proxy(this.load,this)),c.bind("mousedown touchstart",a.proxy(this.dragstart,this)),c.bind("mousemove touchmove",a.proxy(this.dragmove,this)),c.bind("mouseup touchend",a.proxy(this.dragend,this)),b.on("resize",a.proxy(this.resize,this))},removeListener:function(){this.$element.off("load",this.load),c.unbind("mousedown touchstart",this.dragstart),c.unbind("mousemove touchmove",this.dragmove),c.unbind("mouseup touchend",this.dragend),b.off("resize",this.resize)},load:function(){var a;return this.active?(a=this.$element.prop("src"),void(a&&a!==this.url&&this.rerender())):void this.enable()},rerender:function(){this.disable(),this.enable()},resize:function(){clearTimeout(this.resizing),this.resizing=setTimeout(a.proxy(this.rerender,this),200)},dragstart:function(b){var c,e,f=d.fn.getOriginalEvent(b).touches,g=b;f&&1===f.length&&(g=f[0],this.touchId=g.identifier,c=!0),e=a(g.target).data().direction,d.fn.isDirection(e)&&(this.startX=g.pageX,this.startY=g.pageY,this.direction=e,this.$element.trigger("dragstart"),c&&b.preventDefault())},dragmove:function(a){var b,c=d.fn.getOriginalEvent(a).changedTouches,e=a;c&&1===c.length&&(e=c[0],b=!0,e.identifier!==this.touchId)||this.direction&&(this.$element.trigger("dragmove"),b&&a.preventDefault(),this.endX=e.pageX,this.endY=e.pageY,this.dragging())},dragend:function(a){var b,c=d.fn.getOriginalEvent(a).changedTouches,e=a;c&&1===c.length&&(e=c[0],b=!0,e.identifier!==this.touchId)||this.direction&&(this.direction="",this.$element.trigger("dragend"),b&&a.preventDefault())},setAspectRatio:function(b){("auto"===b||a.isNumeric(b)&&b>0)&&(this.defaults.aspectRatio="auto"===b?0/0:b,this.active&&this.setDragger())},setImage:function(){var b=this,c=a('<img src="'+this.url+'">');c.on("load",function(){var c,e=a(this);this.naturalWidth&&this.naturalHeight?c={naturalHeight:this.naturalHeight,naturalWidth:this.naturalWidth}:(d.fn.size(e,{height:"auto",width:"auto"}),c=d.fn.size(e),c={naturalHeight:c.height,naturalWidth:c.width}),d.fn.size(e,{height:"100%",width:"100%"}),c.aspectRatio=c.naturalWidth/c.naturalHeight,b.image=c,b.setCropper()}),this.$cropper.prepend(c)},setImgSrc:function(a){"undefined"!=typeof a&&a!==this.url&&(this.$element.attr("src",a),this.rerender())},getImgInfo:function(){return this.image},setPreview:function(){var a=this.defaults.preview;this.$preview=this.$cropper.find(".cropper-preview"),"string"==typeof a&&a.length>0&&(this.$preview=this.$preview.add(a)),this.$preview.html('<img src="'+this.url+'">')},setCropper:function(){var b,c=this.$element.parent(),e=d.fn.size(c),f=this.image;f.naturalWidth*e.height/f.naturalHeight-e.width>=0?(b={height:e.width/f.aspectRatio,width:e.width,left:0},b.top=(e.height-b.height)/2):(b={height:e.height,width:e.height*f.aspectRatio,top:0},b.left=(e.width-b.width)/2),a.each(b,function(a,c){b[a]=Math.round(c)}),f.height=b.height,f.width=b.width,f.ratio=f.width/f.naturalWidth,d.fn.position(c),this.$cropper.css({height:b.height,left:b.left,top:b.top,width:b.width}),this.cropper=b,this.setDragger()},setDragger:function(){var a,b=this.cropper,c=this.defaults.aspectRatio||this.image.aspectRatio;a=b.height*c-b.width>=0?{height:b.width/c,width:b.width,left:0,top:(b.height-b.width/c)/2,maxWidth:b.width,maxHeight:b.width/c}:{height:b.height,width:b.height*c,left:(b.width-b.height*c)/2,top:0,maxHeight:b.height,maxWidth:b.height*c},a.height*=.8,a.width*=.8,a.left=(b.width-a.width)/2,a.top=(b.height-a.height)/2,this.dragger=d.fn.round(a),this.setData(this.defaults.data)},transformData:function(b,c){var e=this.image.ratio,f={};return e="set"===c?e:1/e,a.each(b,function(b,c){d.fn.isDataOption(b)&&a.isNumeric(c)&&(f[b]=Math.round(c*e))}),f},setData:function(b){var c=this.cropper,d=this.dragger,e=this.defaults.aspectRatio;this.active&&(a.isPlainObject(b)&&!a.isEmptyObject(b)&&(b=this.transformData(b,"set"),a.isNumeric(b.x1)&&b.x1>=0&&b.x1<=c.width&&(d.left=b.x1),a.isNumeric(b.y1)&&b.y1>=0&&b.y1<=c.height&&(d.top=b.y1),e?a.isNumeric(b.width)&&b.width>0&&b.width<=c.width?(d.width=b.width,d.height=d.width/e):a.isNumeric(b.height)&&b.height>0&&b.height<=c.height?(d.height=b.height,d.width=d.height*e):a.isNumeric(b.x2)&&b.x2>0&&b.x2<=c.width?(d.width=b.x2-d.left,d.height=d.width/e):a.isNumeric(b.y2)&&b.y2>0&&b.y2<=c.height&&(d.height=b.y2-d.top,d.width=d.height*e):(d.width=b.width,d.height=b.height)),this.dragger=d,this.resetDragger())},getData:function(){var a=this.dragger,b={};return this.active&&(b=this.transformData({x1:a.left,y1:a.top,width:a.width,height:a.height,x2:a.left+a.width,y2:a.top+a.height},"get")),b},resetDragger:function(){var a=this.dragger,b=this.cropper;a.width=a.width>a.maxWidth?a.maxWidth:Math.abs(a.width),a.height=a.height>a.maxHeight?a.maxHeight:Math.abs(a.height),a.maxLeft=b.width-a.width,a.maxTop=b.height-a.height,a.left=a.left<0?0:a.left>a.maxLeft?a.maxLeft:a.left,a.top=a.top<0?0:a.top>a.maxTop?a.maxTop:a.top,a=d.fn.round(a),this.$dragger.css({height:a.height,left:a.left,top:a.top,width:a.width}),this.dragger=a,this.preview(),this.output()},dragging:function(){var a=this.direction,b=this.dragger,c=this.defaults.aspectRatio,d={x:this.endX-this.startX,y:this.endY-this.startY};switch(c&&(d.X=d.y*c,d.Y=d.x/c),a){case"e":b.width+=d.x,c&&(b.height=b.width/c,b.top-=d.Y/2),b.width<0&&(this.direction="w",b.width=0);break;case"n":b.height-=d.y,b.top+=d.y,c&&(b.width=b.height*c,b.left+=d.X/2),b.height<0&&(this.direction="s",b.height=0);break;case"w":b.width-=d.x,b.left+=d.x,c&&(b.height=b.width/c,b.top+=d.Y/2),b.width<0&&(this.direction="e",b.width=0);break;case"s":b.height+=d.y,c&&(b.width=b.height*c,b.left-=d.X/2),b.height<0&&(this.direction="n",b.height=0);break;case"ne":b.height-=d.y,b.top+=d.y,c?b.width=b.height*c:b.width+=d.x,b.height<0&&(this.direction="sw",b.height=0,b.width=0);break;case"nw":b.height-=d.y,b.top+=d.y,c?(b.width=b.height*c,b.left+=d.X):(b.width-=d.x,b.left+=d.x),b.height<0&&(this.direction="se",b.height=0,b.width=0);break;case"sw":b.width-=d.x,b.left+=d.x,c?b.height=b.width/c:b.height+=d.y,b.width<0&&(this.direction="ne",b.height=0,b.width=0);break;case"se":b.width+=d.x,c?b.height=b.width/c:b.height+=d.y,b.width<0&&(this.direction="nw",b.height=0,b.width=0);break;default:b.left+=d.x,b.top+=d.y}this.resetDragger(),this.startX=this.endX,this.startY=this.endY},output:function(){this.defaults.done(this.getData())},preview:function(){var b=this,c=b.cropper,e=b.dragger;this.$preview.each(function(){var b=a(this),f=b.outerWidth()/e.width,g={height:c.height,marginLeft:-e.left,marginTop:-e.top,width:c.width};b.css({overflow:"hidden"}),b.find("img").css(d.fn.round(g,function(a){return a*f}))})}},d.fn={toggle:function(a){a.toggleClass("cropper-hidden")},position:function(a,b){var c=a.css("position");"static"===c&&a.css("position",b||"relative")},size:function(b,c){return a.isPlainObject(c)?void b.css(c):{height:b.height(),width:b.width()}},round:function(b,c){var d,e;for(e in b)d=b[e],b.hasOwnProperty(e)&&"number"==typeof d&&(b[e]=Math.round(a.isFunction(c)?c(d):d));return b},getOriginalEvent:function(a){return a&&"undefined"!=typeof a.originalEvent&&(a=a.originalEvent),a},isDataOption:function(a){return/^(x1|y1|x2|y2|width|height)$/i.test(a)},isDirection:function(a){return/^(\*|e|n|w|s|ne|nw|sw|se)$/i.test(a)}},d.template=['<div class="cropper-container">','<div class="cropper-modal"></div>','<div class="cropper-dragger">','<span class="cropper-preview"></span>','<span class="cropper-dashed dashed-h"></span>','<span class="cropper-dashed dashed-v"></span>','<span class="cropper-face" data-direction="*"></span>','<span class="cropper-line line-e" data-direction="e"></span>','<span class="cropper-line line-n" data-direction="n"></span>','<span class="cropper-line line-w" data-direction="w"></span>','<span class="cropper-line line-s" data-direction="s"></span>','<span class="cropper-point point-e" data-direction="e"></span>','<span class="cropper-point point-n" data-direction="n"></span>','<span class="cropper-point point-w" data-direction="w"></span>','<span class="cropper-point point-s" data-direction="s"></span>','<span class="cropper-point point-ne" data-direction="ne"></span>','<span class="cropper-point point-nw" data-direction="nw"></span>','<span class="cropper-point point-sw" data-direction="sw"></span>','<span class="cropper-point point-se" data-direction="se"></span>',"</div>","</div>"].join(""),d.defaults={aspectRatio:"auto",data:{},done:function(){},modal:!0,preview:""},d.setDefaults=function(b){a.extend(d.defaults,b)},a.fn.cropper=function(b,c){var e=this;return this.each(function(){var f=a(this),g=f.data("cropper");g||(g=new d(this,b),f.data("cropper",g)),"string"==typeof b&&a.isFunction(g[b])&&(e=g[b](c))}),"undefined"!=typeof e?e:this},a.fn.cropper.Constructor=d,a.fn.cropper.setDefaults=d.setDefaults,a(function(){a("img[cropper]").cropper()})});