/*!
 * Cropper v0.5.0
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){"use strict";var b=a(window),c=a(document),d=/^(\+|\*|e|n|w|s|ne|nw|sw|se)$/i,e=/^(x|y|width|height)$/i,f="cropper-hidden",g="cropper-invisible",h="mousedown touchstart",i="mousemove touchmove",j="mouseup mouseleave touchend touchleave",k="build.cropper",l="built.cropper",m="render.cropper",n="resize.cropper",o=function(a){return"number"==typeof a},p=function(b,c){this.$image=a(b),this.setDefaults(c),this.init()},q=Math.round,r=Math.min,s=Math.max,t=Math.abs,u=parseFloat;p.prototype={constructor:p,setDefaults:function(b){b=a.extend({},p.defaults,b),a.each(b,function(a,c){switch(a){case"aspectRatio":b[a]=t(u(c))||0/0;break;case"minWidth":case"minHeight":b[a]=t(u(c))||0;break;case"maxWidth":case"maxHeight":b[a]=t(u(c))||1/0}}),this.defaults=b},init:function(){var b=this,c=this.$image.attr("src"),d=a('<img src="'+c+'">'),e={};this.$clone&&this.$clone.remove(),this.$clone=d,d.one("load",function(){e.naturalWidth=this.naturalWidth||d.width(),e.naturalHeight=this.naturalHeight||d.height(),e.aspectRatio=e.naturalWidth/e.naturalHeight,b.active=!0,b.src=c,b.image=e,b.build()}),d.addClass(g).prependTo("body")},build:function(){var b,d,e=this.defaults;this.built&&this.unbuild(),b=a.Event(k),this.$image.trigger(b),b.isDefaultPrevented()||(this.$cropper=d=a(p.template),this.$image.addClass(f),this.$clone.removeClass(g).prependTo(d),this.$container=this.$image.parent(),this.$container.append(d),this.$modal=d.find(".cropper-modal"),this.$canvas=d.find(".cropper-canvas"),this.$dragger=d.find(".cropper-dragger"),this.$viewer=d.find(".cropper-viewer"),this.cropped=!0,e.autoCrop||(this.$dragger.addClass(f),this.cropped=!1),this.$modal.toggleClass(f,!e.modal),!e.dragCrop&&this.$canvas.addClass(f),!e.moveable&&this.$dragger.find(".cropper-face").addClass(f),!e.resizeable&&this.$dragger.find(".cropper-line, .cropper-point").addClass(f),this.$dragScope=e.multiple?this.$cropper:c,this.addListener(),this.initPreview(),this.built=!0,this.update(),this.$image.trigger(l))},unbuild:function(){this.built&&(this.built=!1,this.removeListener(),this.$preview.empty(),this.$preview=null,this.$dragger=null,this.$canvas=null,this.$modal=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},update:function(a){this.initContainer(),this.initCropper(),this.initDragger(),a?this.setData(a,!0):this.setData(this.defaults.data)},resize:function(){clearTimeout(this.resizing),this.resizing=setTimeout(a.proxy(this.update,this,this.getData()),200)},reset:function(a){this.cropped&&(a&&(this.defaults.data={}),this.dragger=this.cloneDragger(),this.setData(this.defaults.data))},release:function(){this.cropped&&(this.cropped=!1,this.defaults.done({x:0,y:0,width:0,height:0}),this.$dragger.addClass(f))},destroy:function(){this.active&&(this.unbuild(),this.$image.removeClass(f),this.$image.removeData("cropper"),this.$image=null)},preview:function(){var b=this.cropper,c=this.dragger;this.$viewer.find("img").css({height:q(b.height),marginLeft:-q(c.left),marginTop:-q(c.top),width:q(b.width)}),this.$preview.each(function(){var d=a(this),e=d.width()/c.width,f={height:q(b.height*e),marginLeft:-q(c.left*e),marginTop:-q(c.top*e),width:q(b.width*e)};d.find("img").css(f)})},addListener:function(){var c=this.defaults;this.$image.on(k,c.build).on(l,c.built).on(m,c.render),this.$cropper.on(h,a.proxy(this.dragstart,this)),this.$dragScope.on(i,a.proxy(this.dragmove,this)).on(j,a.proxy(this.dragend,this)),b.on(n,a.proxy(this.resize,this))},removeListener:function(){var a=this.defaults;this.$image.off(k,a.build).off(l,a.built).off(m,a.render),this.$cropper.off(h,this.dragstart),this.$dragScope.off(i,this.dragmove).on(j,this.dragend),b.off(n,this.resize)},initPreview:function(){var b='<img src="'+this.src+'">';this.$preview=a(this.defaults.preview),this.$preview.html(b),this.$viewer.html(b)},initContainer:function(){var a=this.$container;this.container={width:a.width(),height:a.height()}},initCropper:function(){var a,b=this.container,c=this.image;c.naturalWidth*b.height/c.naturalHeight-b.width>=0?(a={height:b.width/c.aspectRatio,width:b.width,left:0},a.top=(b.height-a.height)/2):(a={height:b.height,width:b.height*c.aspectRatio,top:0},a.left=(b.width-a.width)/2),c.ratio=a.width/c.naturalWidth,c.height=a.height,c.width=a.width,this.$cropper.css({height:q(a.height),left:q(a.left),top:q(a.top),width:q(a.width)}),this.cropper=a},initDragger:function(){var a,b=this.defaults,c=this.cropper,d=b.aspectRatio||this.image.aspectRatio,e=this.image.ratio;a=c.height*d-c.width>=0?{height:c.width/d,width:c.width,left:0,top:(c.height-c.width/d)/2,maxWidth:c.width,maxHeight:c.width/d}:{height:c.height,width:c.height*d,left:(c.width-c.height*d)/2,top:0,maxWidth:c.height*d,maxHeight:c.height},a.minWidth=0,a.minHeight=0,b.aspectRatio?(isFinite(b.maxWidth)?(a.maxWidth=r(a.maxWidth,b.maxWidth*e),a.maxHeight=a.maxWidth/d):isFinite(b.maxHeight)&&(a.maxHeight=r(a.maxHeight,b.maxHeight*e),a.maxWidth=a.maxHeight*d),b.minWidth>0?(a.minWidth=s(0,b.minWidth*e),a.minHeight=a.minWidth/d):b.minHeight>0&&(a.minHeight=s(0,b.minHeight*e),a.minWidth=a.minHeight*d)):(a.maxWidth=r(a.maxWidth,b.maxWidth*e),a.maxHeight=r(a.maxHeight,b.maxHeight*e),a.minWidth=s(0,b.minWidth*e),a.minHeight=s(0,b.minHeight*e)),a.minWidth=r(a.maxWidth,a.minWidth),a.minHeight=r(a.maxHeight,a.minHeight),a.height*=.8,a.width*=.8,a.left=(c.width-a.width)/2,a.top=(c.height-a.height)/2,this.defaultDragger=a,this.dragger=this.cloneDragger(),this.draggerLeft=a.left,this.draggerTop=a.top},cloneDragger:function(){return a.extend({},this.defaultDragger)},renderDragger:function(){var b,c,d,e=this.dragger,f=this.cropper,g=this.draggerLeft,h=this.draggerTop;e.width>e.maxWidth?(e.width=e.maxWidth,e.left=g):e.width<e.minWidth&&(e.width=e.minWidth,e.left=g),e.height>e.maxHeight?(e.height=e.maxHeight,e.top=h):e.height<e.minHeight&&(e.height=e.minHeight,e.top=h),b=f.width-e.width,c=f.height-e.height,e.left=e.left>b?b:e.left<0?0:e.left,e.top=e.top>c?c:e.top<0?0:e.top,d=a.Event(m),this.$image.trigger(d),d.isDefaultPrevented()||(this.dragger=e,this.draggerLeft=e.left,this.draggerTop=e.top,this.defaults.done(this.getData()),this.$dragger.css({height:q(e.height),left:q(e.left),top:q(e.top),width:q(e.width)}),this.preview())},setData:function(b,c){var d=this.cropper,e=this.dragger,f=this.defaults.aspectRatio;this.built&&"undefined"!=typeof b&&((null===b||a.isEmptyObject(b))&&(e=this.cloneDragger()),a.isPlainObject(b)&&!a.isEmptyObject(b)&&(c||(this.defaults.data=b),b=this.transformData(b),o(b.x)&&b.x<=d.width&&(e.left=b.x),o(b.y)&&b.y<=d.height&&(e.top=b.y),f?o(b.width)&&b.width<=e.maxWidth&&b.width>=e.minWidth?(e.width=b.width,e.height=e.width/f):o(b.height)&&b.height<=e.maxHeight&&b.height>=e.minHeight&&(e.height=b.height,e.width=e.height*f):(o(b.width)&&b.width<=e.maxWidth&&b.width>=e.minWidth&&(e.width=b.width),o(b.height)&&b.height<=e.maxHeight&&b.height>=e.minHeight&&(e.height=b.height))),this.dragger=e,this.renderDragger())},getData:function(){var a=this.dragger,b={};return this.built&&(b={x:a.left,y:a.top,width:a.width,height:a.height},b=this.transformData(b,!0)),b},transformData:function(b,c){var d=this.image.ratio,f={};return a.each(b,function(a,b){b=u(b),e.test(a)&&!isNaN(b)&&(f[a]=c?q(b/d):b*d)}),f},setAspectRatio:function(a){var b="auto"===a;a=u(a),(b||!isNaN(a)&&a>0)&&(this.defaults.aspectRatio=b?0/0:a,this.built&&(this.initDragger(),this.renderDragger()))},setImgSrc:function(a){a&&a!==this.src&&(this.$image.attr("src",a),this.init())},getImgInfo:function(){return this.image||{}},dragstart:function(b){var c,e=(b.originalEvent||b).touches,g=b;e&&1===e.length&&(g=e[0],this.touchId=g.identifier),c=a(g.target).data("direction"),d.test(c)&&(b.preventDefault(),this.direction=c,this.startX=g.pageX,this.startY=g.pageY,"+"===c&&(this.cropping=!0,this.$modal.removeClass(f)))},dragmove:function(a){var b=(a.originalEvent||a).changedTouches,c=a;b&&1===b.length&&(c=b[0],c.identifier!==this.touchId)||this.direction&&(a.preventDefault(),this.endX=c.pageX,this.endY=c.pageY,this.dragging())},dragend:function(a){var b=(a.originalEvent||a).changedTouches,c=a;b&&1===b.length&&(c=b[0],c.identifier!==this.touchId)||this.direction&&(a.preventDefault(),this.cropping&&(this.cropping=!1,this.$modal.toggleClass(f,!this.defaults.modal)),this.direction="")},dragging:function(){var a,b=this.direction,c=this.dragger,d=c.width,e=c.height,g=c.left,h=c.top,i=this.defaults.aspectRatio,j={x:this.endX-this.startX,y:this.endY-this.startY};switch(i&&(j.X=j.y*i,j.Y=j.x/i),b){case"+":j.x&&j.y&&(a=this.$cropper.offset(),g=this.startX-a.left,h=this.startY-a.top,d=c.minWidth,e=c.minHeight,j.x>0?j.y>0?b="se":(b="ne",h-=e):j.y>0?(b="sw",g-=d):(b="nw",g-=d,h-=e),this.cropped||(this.cropped=!0,this.$dragger.removeClass(f)));break;case"*":g+=j.x,h+=j.y;break;case"e":d+=j.x,i&&(e=d/i,h-=j.Y/2),0>d&&(b="w",d=0);break;case"n":e-=j.y,h+=j.y,i&&(d=e*i,g+=j.X/2),0>e&&(b="s",e=0);break;case"w":d-=j.x,g+=j.x,i&&(e=d/i,h+=j.Y/2),0>d&&(b="e",d=0);break;case"s":e+=j.y,i&&(d=e*i,g-=j.X/2),0>e&&(b="n",e=0);break;case"ne":e-=j.y,h+=j.y,i?d=e*i:d+=j.x,0>e&&(b="sw",e=0,d=0);break;case"nw":e-=j.y,h+=j.y,i?(d=e*i,g+=j.X):(d-=j.x,g+=j.x),0>e&&(b="se",e=0,d=0);break;case"sw":d-=j.x,g+=j.x,i?e=d/i:e+=j.y,0>d&&(b="ne",e=0,d=0);break;case"se":d+=j.x,i?e=d/i:e+=j.y,0>d&&(b="nw",e=0,d=0)}c.width=d,c.height=e,c.left=g,c.top=h,this.direction=b,this.renderDragger(),this.startX=this.endX,this.startY=this.endY}},p.template='<div class="cropper-container"><div class="cropper-modal"></div><div class="cropper-canvas" data-direction="+"></div><div class="cropper-dragger"><span class="cropper-viewer"></span><span class="cropper-dashed dashed-h"></span><span class="cropper-dashed dashed-v"></span><span class="cropper-face" data-direction="*"></span><span class="cropper-line line-e" data-direction="e"></span><span class="cropper-line line-n" data-direction="n"></span><span class="cropper-line line-w" data-direction="w"></span><span class="cropper-line line-s" data-direction="s"></span><span class="cropper-point point-e" data-direction="e"></span><span class="cropper-point point-n" data-direction="n"></span><span class="cropper-point point-w" data-direction="w"></span><span class="cropper-point point-s" data-direction="s"></span><span class="cropper-point point-ne" data-direction="ne"></span><span class="cropper-point point-nw" data-direction="nw"></span><span class="cropper-point point-sw" data-direction="sw"></span><span class="cropper-point point-se" data-direction="se"></span></div></div>',p.defaults={aspectRatio:"auto",data:{},done:a.noop,multiple:!1,autoCrop:!0,dragCrop:!0,modal:!0,moveable:!0,resizeable:!0,maxWidth:1/0,maxHeight:1/0,minWidth:0,minHeight:0},p.setDefaults=function(b){a.extend(p.defaults,b)},p.other=a.fn.cropper,a.fn.cropper=function(b,c){var d=this;return this.each(function(){var e=a(this),f=e.data("cropper");!f&&a.isPlainObject(b)&&e.data("cropper",f=new p(this,b)),"string"==typeof b&&a.isFunction(f[b])&&(d=f[b](c))}),"undefined"!=typeof d?d:this},a.fn.cropper.constructor=p,a.fn.cropper.setDefaults=p.setDefaults,a.fn.cropper.noConflict=function(){return a.fn.cropper=p.other,this}});