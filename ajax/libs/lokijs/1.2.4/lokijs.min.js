!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.loki=e()}(this,function(){return function(){"use strict";function t(t,e,i){return t===e?i?!0:!1:void 0===t?!0:void 0===e?!1:null===t?!0:null===e?!1:e>t}function e(t,e,i){return t===e?i?!0:!1:void 0===t?!1:void 0===e?!0:null===t?!1:null===e?!0:t>e}function i(i,n,r){return i===n?0:r?t(i,n)?1:-1:e(i,n)?1:-1}function n(t){return Array.isArray(t)?function(e){return-1!==t.indexOf(e)}:"string"==typeof t?function(e){return-1!==t.indexOf(e)}:t&&"object"==typeof t?function(e){return t.hasOwnProperty(e)}:void 0}function r(t,e){var i,n=e||"parse-stringify";return"parse-stringify"===n&&(i=JSON.parse(JSON.stringify(t))),i}function s(){try{return"localStorage"in window&&null!==window.localStorage}catch(t){return!1}}function o(){}function a(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.events={init:[],flushChanges:[],close:[],changes:[],warning:[]};var i=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=e&&e.hasOwnProperty("env")?e.env:i(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(e,!0),this.on("init",this.clearChanges)}function h(){this.fs=require("fs")}function l(){}function c(t,e,i,n){return this.collection=t,this.searchIsChained=!e&&!i,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof e&&null!==e?this.find(e,n):"undefined"!=typeof i&&null!==i?this.where(i):this}function u(t,e,i){this.collection=t,this.name=e,this.persistent=!1,"undefined"!=typeof i&&(this.persistent=i),this.resultset=new c(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function f(t,e){function i(t,e,i){u.changes.push({name:t,operation:e,obj:JSON.parse(JSON.stringify(i))})}function n(){u.changes=[]}function r(t){t&&(t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0)}function s(t){t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)}function o(t){i(u.name,"I",t)}function a(t){i(u.name,"U",t)}function h(t){r(t),o(t)}function l(t){s(t),a(t)}function c(){p=u.disableChangesApi?r:h,y=u.disableChangesApi?s:l}this.name=t,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var u=this;e=e||{},e.hasOwnProperty("unique")&&e.unique.forEach(function(t){u.constraints.unique[t]={}}),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){u.constraints.exact[t]={}}),this.transactional=e.hasOwnProperty("transactional")?e.transactional:!1,this.cloneObjects=e.hasOwnProperty("clone")?e.clone:!1,this.asyncListeners=e.hasOwnProperty("asyncListeners")?e.asyncListeners:!1,this.disableChangesApi=e.hasOwnProperty("disableChangesApi")?e.disableChangesApi:!0,this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]},this.changes=[],this.ensureId();var f=[];if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))f=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");f=[e.indices]}for(var d=0;d<f.length;d++)this.ensureIndex(f[d]);this.getChanges=function(){return u.changes},this.flushChanges=n;var p,y;c(),this.setChangesApi=function(t){u.disableChangesApi=!t,c()},this.on("insert",function(t){p(t)}),this.on("update",function(t){y(t)}),this.on("delete",function(t){u.disableChangesApi||i(u.name,"R",t)}),this.on("warning",console.warn),n()}function d(t){return-1!==t.indexOf(".")}function p(t){return parseFloat(t,10)}function y(t,e){return t+e}function v(t,e){return t-e}function w(t){return t.reduce(y,0)/t.length}function g(t){var e=w(t),i=t.map(function(t){var i=t-e,n=i*i;return n}),n=w(i),r=Math.sqrt(n);return r}function m(t,e,i){if(i===!1)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}function b(t,e,i){for(var n,r,s=0,o=t.length;o>s;){if(r=(s+o)/2|0,n=i.apply(null,[e,t[r]]),0===n)return{found:!0,index:r};0>n?o=r:s=r+1}return{found:!1,index:o}}function I(t){return function(e,i){return b(e,i,t)}}function D(){}var x={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]}},O={$eq:function(t,e){return t===e},$gt:function(t,i){return e(t,i)},$gte:function(t,i){return e(t,i,!0)},$lt:function(e,i){return t(e,i)},$lte:function(e,i){return t(e,i,!0)},$ne:function(t,e){return t!==e},$regex:function(t,e){return e.test(t)},$in:function(t,e){return e.indexOf(t)>-1},$containsAny:function(t,e){var i;return Array.isArray(e)||(e=[e]),i=n(t,e)||function(){return!1},e.reduce(function(t,e){return t?t:i(e)},!1)},$contains:function(t,e){var i;return Array.isArray(e)||(e=[e]),i=n(t,e)||function(){return!0},e.reduce(function(t,e){return t?i(e):t},!0)}},C={$eq:O.$eq,$gt:O.$gt,$gte:O.$gte,$lt:O.$lt,$lte:O.$lte,$ne:O.$ne,$regex:O.$regex,$in:O.$in,$contains:O.$contains,$containsAny:O.$containsAny};return o.prototype.events={},o.prototype.asyncListeners=!1,o.prototype.on=function(t,e){var i=this.events[t];return i||(i=this.events[t]=[]),i.push(e),e},o.prototype.emit=function(t,e){var i=this;if(!t||!this.events[t])throw new Error("No event "+t+" defined");this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t(e)},1):t(e)})},o.prototype.removeListener=function(t,e){if(this.events[t]){var i=this.events[t];i.splice(i.indexOf(e),1)}},a.prototype=new o,a.prototype.configureOptions=function(t,e){var i={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},n={fs:h,localStorage:l};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,"undefined"!=typeof t){if(this.options=t,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof n[t.persistenceMethod]&&(this.persistenceMethod=t.persistenceMethod,this.persistenceAdapter=new n[t.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=t.adapter),t.hasOwnProperty("autoload")&&"undefined"!=typeof e&&e){var r=this;setTimeout(function(){r.loadDatabase(t,t.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.autosaveEnable())}null===this.persistenceAdapter&&(this.persistenceMethod=i[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new n[this.persistenceMethod]))},a.prototype.anonym=function(t,e){var i=new f("anonym",e);return i.insert(t),i},a.prototype.addCollection=function(t,e){var i=new f(t,e);return this.collections.push(i),i},a.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must be have a name property to be loaded");this.collections.push(t)},a.prototype.getCollection=function(t){var e,i=this.collections.length;for(e=0;i>e;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null},a.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},a.prototype.removeCollection=function(t){var e,i=this.collections.length;for(e=0;i>e;e+=1)if(this.collections[e].name===t)return void this.collections.splice(e,1)},a.prototype.getName=function(){return this.name},a.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":return null;case"persistenceAdapter":return null;default:return e}},a.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer)},a.prototype.toJson=a.prototype.serialize,a.prototype.loadJSON=function(t,e){var i,n,r,s,o=JSON.parse(t),a=0,h=o.collections.length;for(this.name=o.name,this.databaseVersion=1,o.hasOwnProperty("databaseVersion")&&(this.databaseVersion=o.databaseVersion),this.collections=[],a;h>a;a+=1){if(i=o.collections[a],n=this.addCollection(i.name),r=i.data.length,s=0,e&&e.hasOwnProperty(i.name)){var l=e[i.name].inflate?e[i.name].inflate:x.copyProperties;for(s;r>s;s++){var c=new e[i.name].proto;l(i.data[s],c),n.data[s]=c}}else for(s;r>s;s++)n.data[s]=i.data[s];if(n.transactional=i.transactional,n.asyncListeners=i.asyncListeners,n.disableChangesApi=i.disableChangesApi,n.cloneObjects=i.cloneObjects,n.maxId=0===i.data.length?0:i.maxId,n.idIndex=i.idIndex,"undefined"!=typeof i.indices&&(n.idIndex=i.indices.id),"undefined"!=typeof i.binaryIndices&&(n.binaryIndices=i.binaryIndices),n.ensureId(),"undefined"!=typeof i.DynamicViews)for(var u=0;u<i.DynamicViews.length;u++){var f=i.DynamicViews[u],d=n.addDynamicView(f.name,f.persistent);d.resultdata=f.resultdata,d.resultsdirty=f.resultsdirty,d.filterPipeline=f.filterPipeline,d.sortCriteria=f.sortCriteria,d.sortFunction=null,d.sortDirty=f.sortDirty,d.resultset.filteredrows=f.resultset.filteredrows,d.resultset.searchIsChained=f.resultset.searchIsChained,d.resultset.filterInitialized=f.resultset.filterInitialized,d.rematerialize({removeWhereFilters:!0})}}},a.prototype.close=function(t){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&this.saveDatabase()),t&&this.on("close",t),this.emit("close")},a.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach(function(t){-1!==n.indexOf(e(t))&&(i=i.concat(t.getChanges()))}),i},a.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},a.prototype.clearChanges=function(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})},h.prototype.loadDatabase=function(t,e){this.fs.readFile(t,{encoding:"utf8"},function(t,i){e(t?new Error(t):i)})},h.prototype.saveDatabase=function(t,e,i){this.fs.writeFile(t,e,i)},l.prototype.loadDatabase=function(t,e){e(s()?localStorage.getItem(t):new Error("localStorage is not available"))},l.prototype.saveDatabase=function(t,e,i){s()?(localStorage.setItem(t,e),i(null)):i(new Error("localStorage is not available"))},a.prototype.loadDatabase=function(t,e){var i=e||function(t){if(t)throw t},n=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(e){"string"==typeof e?(n.loadJSON(e,t||{}),i(null)):(console.warn("lokijs loadDatabase : Database not found"),i("object"==typeof e?e:"Database not found"))}):i(new Error("persistenceAdapter not configured"))},a.prototype.saveDatabase=function(t){var e=t||function(t){if(t)throw t},i=this;null!==this.persistenceAdapter?this.persistenceAdapter.saveDatabase(this.filename,i.serialize(),function(){i.autosaveClearFlags(),e(null)}):e(new Error("persistenceAdapter not configured"))},a.prototype.save=a.prototype.saveDatabase,a.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},a.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},a.prototype.autosaveEnable=function(){this.autosave=!0;var t=5e3,e=this;"undefined"!=typeof this.autosaveInterval&&null!==this.autosaveInterval&&(t=this.autosaveInterval),this.autosaveHandle=setInterval(function(){e.autosaveDirty()&&e.saveDatabase()},t)},a.prototype.autosaveDisable=function(){"undefined"!=typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},c.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},c.prototype.limit=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=this.copy();return e.filteredrows=e.filteredrows.slice(0,t),e},c.prototype.offset=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=this.copy();return e.filteredrows=e.filteredrows.splice(t,e.filteredrows.length),e},c.prototype.copy=function(){var t=new c(this.collection,null,null);return t.filteredrows=this.filteredrows.slice(),t.filterInitialized=this.filterInitialized,t},c.prototype.branch=c.prototype.copy,c.prototype.sort=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=function(t,e){return function(i,n){var r=e.collection.data[i],s=e.collection.data[n];return t(r,s)}}(t,this);return this.filteredrows.sort(e),this},c.prototype.simplesort=function(t,e){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data)),"undefined"==typeof e&&(e=!1);var n=function(t,e,n){return function(r,s){var o=n.collection.data[r],a=n.collection.data[s];return i(o[t],a[t],e)}}(t,e,this);return this.filteredrows.sort(n),this},c.prototype.compoundeval=function(t,e,n){var r=t.length;if(0===r)throw new Error("Invalid call to compoundeval, need at least one property");var s=!1,o=t[0];return"string"!=typeof o&&Array.isArray(o)&&(s=o[1],o=o[0]),e[o]===n[o]?1===r?0:this.compoundeval(t.slice(1),e,n,s):i(e[o],n[o],s)},c.prototype.compoundsort=function(t){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var e=function(t,e){return function(i,n){var r=e.collection.data[i],s=e.collection.data[n];return e.compoundeval(t,r,s)}}(t,this);return this.filteredrows.sort(e),this},c.prototype.calculateRange=function(i,n,r){var s=this.collection.data,o=this.collection.binaryIndices[n].values,a=0,h=o.length-1,l=null,c=0,u=o.length-1;if(0===s.length)return[0,-1];var f=s[o[a]][n],d=s[o[h]][n];switch(i){case"$eq":if(t(r,f)||e(r,d))return[0,-1];break;case"$gt":if(e(r,d,!0))return[0,-1];break;case"$gte":if(e(r,d))return[0,-1];break;case"$lt":if(t(r,f,!0))return[0,-1];break;case"$lte":if(t(r,f))return[0,-1]}for(;h>a;)l=Math.floor((a+h)/2),t(s[o[l]][n],r)?a=l+1:h=l;for(c=a,a=0,h=o.length-1;h>a;)l=Math.floor((a+h)/2),t(r,s[o[l]][n])?h=l:a=l+1;u=h;var p=s[o[c]][n],y=s[o[u]][n];switch(i){case"$eq":return p!==r?[0,-1]:(y!==r&&u--,[c,u]);case"$gt":return t(y,r,!0)?[0,-1]:[u,s.length-1];case"$gte":return t(p,r)?[0,-1]:[c,s.length-1];case"$lt":return 0===c&&t(p,r)?[0,0]:[0,c-1];case"$lte":return y!==r&&u--,0===u&&t(y,r)?[0,0]:[0,u];default:return[0,s.length-1]}},c.prototype.findOr=function(t){var e=0,i=0,n=null,r=[],s=null;if(this.filterInitialized){for(r=[],i=0;i<t.length;i++)for(s=this.branch(),s.find(t[i]),s.data(),n=s.filteredrows,e=0;e<n.length;e++)-1===r.indexOf(n[e])&&r.push(n[e]);this.filteredrows=r}else for(i=0;i<t.length;i++)for(s=this.collection.chain(),s.find(t[i]),s.data(),n=s.filteredrows,e=0;e<n.length;e++)-1===this.filteredrows.indexOf(n[e])&&this.filteredrows.push(n[e]);return this.filterInitialized=!0,this},c.prototype.findAnd=function(t){for(var e=0;e<t.length;e++)this.find(t[e]);return this},c.prototype.dotSubScan=function(t,e,i,n){var r,s,o,a=null,h=e.split(".");for(r=0;r<h.length;r++)if(o=h[r],a){for(s=0;s<a.length;s++)if(i(a[s][o],n))return!0}else t=t[o],Array.isArray(t)&&(a=t);return i(t,n)},c.prototype.find=function(t,e){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var i,n,r,s,o,a,h,l,c=t||"getAll",u=!1,f=[],d=null,p=!0;e=e||!1;for(s in c){p=!1;break}if(p&&(c="getAll"),"getAll"===c)return this.searchIsChained?(this.filteredrows=Object.keys(this.collection.data),this):this.collection.data;var y=!1;for(s in c)if(c.hasOwnProperty(s)){if(i=s,"$and"===s)return this.searchIsChained?(this.findAnd(c[s]),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(f=this.collection.chain().findAnd(c[s]).data(),e?0===f.length?[]:f[0]:f);if("$or"===s)return this.searchIsChained?(this.findOr(c[s]),e&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(f=this.collection.chain().findOr(c[s]).data(),e?0===f.length?[]:f[0]:f);if(-1!=s.indexOf(".")&&(y=!0),"object"!=typeof c[s])r="$eq",n=c[s];else{if("object"!=typeof c[s])throw"Do not know what you want to do.";for(o in c[s])c[s].hasOwnProperty(o)&&(r=o,n=c[s][o])}break}if("$regex"===r&&(n=new RegExp(n)),null===this.collection.data)throw new TypeError;if((!this.searchIsChained||this.searchIsChained&&!this.filterInitialized)&&"$ne"!==r&&"$regex"!==r&&"$contains"!==r&&"$containsAny"!==r&&"$in"!==r&&this.collection.binaryIndices.hasOwnProperty(i)&&(this.collection.ensureIndex(i),u=!0,d=this.collection.binaryIndices[i]),a=C[r],this.searchIsChained){if(this.filterInitialized){if(u)for(h=d,l=this.filteredrows.length;l--;)a(h[this.filteredrows[l]],n)&&f.push(this.filteredrows[l]);else if(h=this.collection.data,l=this.filteredrows.length,y)for(;l--;)this.dotSubScan(h[this.filteredrows[l]],i,a,n)&&f.push(this.filteredrows[l]);else for(;l--;)a(h[this.filteredrows[l]][i],n)&&f.push(this.filteredrows[l]);return this.filteredrows=f,this}if(u){h=this.collection.data;for(var v=this.calculateRange(r,i,n,this),w=v[0];w<=v[1];w++)f.push(d.values[w]);this.filteredrows=f}else if(h=this.collection.data,l=h.length,y)for(;l--;)this.dotSubScan(h[l],i,a,n)&&f.push(l);else for(;l--;)a(h[l][i],n)&&f.push(l);return this.filteredrows=f,this.filterInitialized=!0,this}if(u){h=this.collection.data;var v=this.calculateRange(r,i,n,this);if(e)return-1!==v[1]?h[d.values[v[0]]]:[];for(l=v[0];l<=v[1];l++)f.push(h[d.values[l]]);this.filteredrows=f}else{if(h=this.collection.data,l=h.length,e){for(;l--;)if(a(h[l][i],n))return h[l];return[]}if(y)for(;l--;)this.dotSubScan(h[l],i,a,n)&&f.push(h[l]);else for(;l--;)a(h[l][i],n)&&f.push(h[l])}return f},c.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw"Argument is not a stored view or a function";e=t;try{if(this.searchIsChained){if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)e(this.collection.data[this.filteredrows[n]])===!0&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var n=this.collection.data.length;n--;)e(this.collection.data[n])===!0&&i.push(n);return this.filteredrows=i,this.filterInitialized=!0,this}for(var n=this.collection.data.length;n--;)e(this.collection.data[n])===!0&&i.push(this.collection.data[n]);return i}catch(r){throw r}},c.prototype.data=function(){var t=[];if(this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length)return this.collection.data;this.filterInitialized=!0}var e,i=this.collection.data,n=this.filteredrows,r=this.filteredrows.length;for(e=0;r>e;e++)t.push(i[n[e]]);return t},c.prototype.update=function(t){if("function"!=typeof t)throw"Argument is not a function";this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var e=this.filteredrows.length,i=this.collection.data,n=0;e>n;n++)t(i[this.filteredrows[n]]),this.collection.update(i[this.filteredrows[n]]);return this},c.prototype.remove=function(){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var t=this.filteredrows.length,e=0;t>e;e++)this.collection.remove(this.filteredrows[e]);return this.filteredrows=[],this},c.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},c.prototype.eqJoin=function(t,e,i,n){var r,s,o,a=[],h=[],l=[],u="function"==typeof e,d="function"==typeof i,p={};if(a=this.data(),r=a.length,t instanceof c)h=t.data();else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");h=t}s=h.length;for(var y=0;s>y;y++)o=d?i(h[y]):h[y][i],p[o]=h[y];n||(n=function(t,e){return{left:t,right:e}});for(var y=0;r>y;y++)o=u?e(a[y]):a[y][e],l.push(n(a[y],p[o]||{}));return this.collection=new f("joinData"),this.collection.insert(l),this.filteredrows=[],this.filterInitialized=!1,this},c.prototype.map=function(t){var e=this.data().map(t);return this.collection=new f("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this},u.prototype=new o,u.prototype.rematerialize=function(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new c(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(e=this.filterPipeline.length,i=e;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var r=this.filterPipeline;for(this.filterPipeline=[],e=r.length,n=0;e>n;n++)this.applyFind(r[n].val);return this.data(),this.emit("rebuild",this),this},u.prototype.branchResultset=function(){return this.resultset.copy()},u.prototype.toJSON=function(){var t=new u(this.collection,this.name,this.persistent);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortDirty=this.sortDirty,t.collection=null,t},u.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.queueSortPhase(),this},u.prototype.applySimpleSort=function(t,e){return"undefined"==typeof e&&(e=!1),this.sortCriteria=[[t,e]],this.sortFunction=null,this.queueSortPhase(),this},u.prototype.applySortCriteria=function(t){return this.sortCriterial=t,this.sortFunction=null,this.queueSortPhase(),this},u.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},u.prototype.commit=function(){return this.cachedresultset=null,this},u.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},u.prototype.applyFind=function(t){return this.filterPipeline.push({type:"find",val:t}),this.resultset.find(t),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},u.prototype.applyWhere=function(t){return this.filterPipeline.push({type:"where",val:t}),this.resultset.where(t),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},u.prototype.data=function(){return(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized)&&this.performSortPhase(),this.persistent?this.resultdata:this.resultset.data()},u.prototype.queueSortPhase=function(){var t=this;this.sortDirty||(this.sortDirty=!0,setTimeout(function(){t.performSortPhase()},1))},u.prototype.performSortPhase=function(){if(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized){if(this.sortFunction&&this.resultset.sort(this.sortFunction),this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),!this.persistent)return void(this.sortDirty=!1);this.resultdata=this.resultset.data(),this.resultsdirty=!1,this.sortDirty=!1,this.emit("rebuild",this)}},u.prototype.evaluateDocument=function(t){var e=this.resultset.filteredrows,i=e.indexOf(t),n=e.length,r=new c(this.collection);r.filteredrows=[t],r.filterInitialized=!0;for(var s=0;s<this.filterPipeline.length;s++)switch(this.filterPipeline[s].type){case"find":r.find(this.filterPipeline[s].val);break;case"where":r.where(this.filterPipeline[s].val)}var o=0===r.filteredrows.length?-1:0;return-1!=i||-1!=o?-1===i&&-1!==o?(e.push(t),this.persistent&&this.resultdata.push(this.collection.data[t]),void((this.sortFunction||this.sortCriteria)&&this.queueSortPhase())):-1!==i&&-1===o?(n-1>i?(e[i]=e[n-1],e.length=n-1,this.persistent&&(this.resultdata[i]=this.resultdata[n-1],this.resultdata.length=n-1)):(e.length=n-1,this.persistent&&(this.resultdata.length=n-1)),void((this.sortFunction||this.sortCriteria)&&this.queueSortPhase())):-1!==i&&-1!==o?(this.persistent&&(this.resultdata[i]=this.collection.data[t]),void((this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0))):void 0:void 0},u.prototype.removeDocument=function(t){var e,i=this.resultset.filteredrows,n=i.indexOf(t),r=i.length;for(-1!==n&&(r-1>n?(i[n]=i[r-1],i.length=r-1,this.persistent&&(this.resultdata[n]=this.resultdata[r-1],this.resultdata.length=r-1)):(i.length=r-1,this.persistent&&(this.resultdata.length=r-1)),(this.sortFunction||this.sortCriteria)&&this.queueSortPhase()),r=i.length,e=0;r>e;e++)i[e]>t&&i[e]--},u.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},f.prototype=new o,f.prototype.ensureIndex=function(i,n){if("undefined"==typeof n&&(n=!1),null===i||void 0===i)throw"Attempting to set index without an associated property";if(!this.binaryIndices.hasOwnProperty(i)||n||this.binaryIndices[i].dirty){this.binaryIndices[i]={name:i,dirty:!0,values:[]};var r,s=this.data.length,o=0;for(r=this.binaryIndices[i],o;s>o;o+=1)r.values.push(o);var a=function(i,n){return function(r,s){var o=n.data[r],a=n.data[s];return o[i]===a[i]?0:e(o[i],a[i])?1:t(o[i],a[i])?-1:void 0}}(i,this);r.values.sort(a),r.dirty=!1,this.dirty=!0}},f.prototype.ensureAllIndexes=function(t){for(var e=Object.keys(this.binaryIndices),i=e.length;i--;)this.ensureIndex(e[i],t)},f.prototype.flagBinaryIndexesDirty=function(){for(var t=Object.keys(this.binaryIndices),e=t.length;e--;)this.binaryIndices[t[e]].dirty=!0},f.prototype.ensureId=function(){var t=this.data.length,e=0;for(this.idIndex=[],e;t>e;e+=1)this.idIndex.push(this.data[e].$loki)},f.prototype.ensureIdAsync=function(t){this.async(function(){this.ensureId()},t)},f.prototype.addDynamicView=function(t,e){var i=new u(this,t,e);return this.DynamicViews.push(i),i},f.prototype.removeDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].name===t&&this.DynamicViews.splice(e,1)},f.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},f.prototype.findAndUpdate=function(t,e){var i,n=this.where(t),r=0;try{for(r;r<n.length;r++)i=e(n[r]),this.update(i)}catch(s){this.rollback(),console.error(s.message)}},f.prototype.insert=function(t){if(!t){var e=new Error("Object cannot be null");throw this.emit("error",e),e}var i,n=this,r=Array.isArray(t)?t:[t];return r.forEach(function(t){if("object"!=typeof t)throw new TypeError("Document needs to be an object");return i=n.clone?JSON.parse(JSON.stringify(t)):t,"undefined"==typeof i.meta&&(i.meta={revision:0,created:0}),n.emit("pre-insert",i),n.add(i)?void n.emit("insert",i):void 0}),i},f.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},f.prototype.update=function(t){if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.update(t[e])}else{if(!t.hasOwnProperty("$loki"))throw"Trying to update unsynced document. Please save the document first by using insert() or addMany()";try{this.startTransaction();var n,r,s=this.get(t.$loki,!0);if(!s)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",t),n=s[0],r=s[1],this.data[r]=t;for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].evaluateDocument(r);this.idIndex[r]=n.$loki,this.commit(),this.dirty=!0,this.emit("update",t)}catch(a){throw this.rollback(),console.error(a.message),this.emit("error",a),a}}},f.prototype.add=function(t){var e,i=this.DynamicViews.length;if("object"!=typeof t)throw"Object being added needs to be an object";if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),"undefined"!=typeof t.$loki)throw"Document is already in collection, please use update()";try{this.startTransaction(),this.maxId++;var e;isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),t.$loki=this.maxId,t.meta.version=0,this.data.push(t);var n=this;for(Object.keys(n.constraints.unique).forEach(function(e){if(t.hasOwnProperty(e)){if(n.constraints.unique[e][t[e]])throw n.emit("error","Duplicate key for key "+e+" (value "+t[e]+" + already in collection)"),n.data.pop(),new Error("Duplicate key for property "+e);n.constraints.unique[e][t[e]]=t}}),e=0;i>e;e++)this.DynamicViews[e].evaluateDocument(this.data.length-1);return this.idIndex.push(t.$loki),this.commit(),this.dirty=!0,t}catch(r){this.rollback(),console.error(r.message)}},f.prototype.removeWhere=function(t){var e;e="function"==typeof t?this.data.filter(t):new c(this,t);for(var i=e.length;i--;)this.remove(e[i])},f.prototype.removeDataOnly=function(){this.removeWhere(function(){return!0})},f.prototype.remove=function(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t)){var e=0,i=t.length;for(e;i>e;e+=1)this.remove(t[e])}else{if(!t.hasOwnProperty("$loki"))throw new Error("Object is not a document stored in the collection");Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty();try{this.startTransaction();var n=this.get(t.$loki,!0),r=n[1],s=this;Object.keys(this.constraints.unique).forEach(function(e){s.constraints.unique[e][t[e]]=null,delete s.constraints.unique[e][t[e]]});for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(r);this.data.splice(r,1),this.idIndex.splice(r,1),this.commit(),this.dirty=!0,this.emit("delete")}catch(a){this.rollback(),console.error(a.message),this.emit("error",a)}}},f.prototype.get=function(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=Math.floor(s+(r-s)/2);if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw"Passed id is not an integer";for(;n[s]<n[r];)o=Math.floor((s+r)/2),n[o]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null},f.prototype.by=function(t,e){var i;return e?this.constraints.unique[t]&&this.constraints.unique[t][e]?this.constraints.unique[t][e]:void 0:(i=this,function(e){return i.by(t,e)})},f.prototype.findOne=function(t){var e=new c(this,t,null,!0);return Array.isArray(e)&&0===e.length?null:e},f.prototype.chain=function(){return new c(this,null,null)},f.prototype.find=function(t){return"undefined"==typeof t&&(t="getAll"),new c(this,t,null)},f.prototype.findOneUnindexed=function(t,e){for(var i,n=this.data.length;n--;)if(this.data[n][t]===e)return i=this.data[n];return null},f.prototype.startTransaction=function(){if(this.transactional){this.cachedData=r(this.data,"parse-stringify"),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},f.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndices=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},f.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},f.prototype.async=function(t,e){setTimeout(function(){if("function"!=typeof t)throw"Argument passed for async execution is not a function";t(),e()},0)},f.prototype.where=function(t){return new c(this,null,t)},f.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(i){throw i}},f.prototype.eqJoin=function(t,e,i,n){return new c(this).eqJoin(t,e,i,n)},f.prototype.no_op=function(){},f.prototype.extract=function(t){var e=0,i=this.data.length,n=d(t),r=[];
for(e;i>e;e+=1)r.push(m(this.data[e],t,n));return r},f.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},f.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},f.prototype.maxRecord=function(t){var e=0,i=this.data.length,n=d(t),r={index:0,value:void 0},s=void 0;for(e;i>e;e+=1)void 0!==s?s<m(this.data[e],t,n)&&(s=m(this.data[e],t,n),r.index=this.data[e].$loki):(s=m(this.data[e],t,n),r.index=this.data[e].$loki);return r.value=s,r},f.prototype.minRecord=function(t){var e=0,i=this.data.length,n=d(t),r={index:0,value:void 0},s=void 0;for(e;i>e;e+=1)void 0!==s?s>m(this.data[e],t,n)&&(s=m(this.data[e],t,n),r.index=this.data[e].$loki):(s=m(this.data[e],t,n),r.index=this.data[e].$loki);return r.value=s,r},f.prototype.extractNumerical=function(t){return this.extract(t).map(p).filter(Number).filter(function(t){return!isNaN(t)})},f.prototype.avg=function(t){return w(this.extractNumerical(t))},f.prototype.stdDev=function(t){return g(this.extractNumerical(t))},f.prototype.mode=function(t){var e={},i=this.extract(t);i.forEach(function(t){e[t]?e[t]+=1:e[t]=1});var n,r,s=void 0;for(n in e)s?s<e[n]&&(r=n):(r=n,s=e[n]);return r},f.prototype.median=function(t){var e=this.extractNumerical(t);e.sort(v);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2},D.prototype={keys:[],values:[],sort:function(t,e){return e>t?-1:t>e?1:0},setSort:function(t){this.bs=new I(t)},bs:function(){return new I(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[b(this.keys,t,this.sort).index]}},a.Collection=f,a.KeyValueStore=D,a}()});