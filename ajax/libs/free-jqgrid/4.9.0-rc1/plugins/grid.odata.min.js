(function(a){String.prototype.format=function(){var b=arguments;return this.replace(/\{\{|\}\}|\{(\d+)\}/g,function(c,d){if(c==="{{"){return"{"}if(c==="}}"){return"}"}return b[d]})};a.jgrid.odataHelper={resolveJsonReferences:function(e,c){var d,g,b={};c=c||[];function f(i,l,h){if(typeof i!=="object"||!i){return i}if(Object.prototype.toString.call(i)==="[object Array]"){for(d=0;d<i.length;d++){if(typeof i[d]!=="object"||!i[d]){return i[d]}if(i[d].$ref){i[d]=f(i[d],d,i)}else{i[d]=f(i[d],l,i)}}return i}if(i.$ref){g=i.$ref;if(b[g]){return b[g]}c.push([h,l,g]);return}if(i.$id){var k=i.$id;delete i.$id;if(i.$values){i=i.$values.map(f)}else{var j;for(j in i){if(i.hasOwnProperty(j)){i[j]=f(i[j],j,i)}}}b[k]=i}return i}if(typeof e==="string"){e=JSON.parse(e)}e=f(e);for(d=0;d<c.length;d++){g=c[d];g[0][g[1]]=b[g[2]]}return e},convertXmlToJson:function(d){var h={},e,c,g,f,k,b;if(d.nodeType===1){if(d.attributes.length>0){h["@attributes"]={};for(c=0;c<d.attributes.length;c++){g=d.attributes.item(c);h["@attributes"][g.nodeName]=g.nodeValue}}}else{if(d.nodeType===3){h=d.nodeValue}else{if(!d.nodeType){h=d}}}if(d.hasChildNodes&&d.hasChildNodes()){for(e=0;e<d.childNodes.length;e++){f=d.childNodes.item(e);if(f.nodeType===3){return f.nodeValue}k=f.nodeName;if(h[k]===undefined){h[k]=a.jgrid.odataHelper.convertXmlToJson(f)}else{if(h[k].push===undefined){b=h[k];h[k]=[];h[k].push(b)}h[k].push(a.jgrid.odataHelper.convertXmlToJson(f))}}}return a.isEmptyObject(h)?null:h}};a.jgrid.cmTemplate.odataComplexType={editable:false,formatter:function(b,c,e){var d=e.innerHTML?a(this.p.xmlReader.id,e).html():e[this.p.jsonReader.id];return'<a href="{0}({1})/{2}" target="_self" data-id="{1}">{2}</a>'.format(this.p.url,d,c.colModel.name)}};a.jgrid.cmTemplate.odataNavigationProperty={editable:false,formatter:function(b,c,e){var d=e.innerHTML?a(this.p.xmlReader.id,e).html():e[this.p.jsonReader.id];return'<a href="{0}({1})/{2}" target="_self" data-id="{1}">{2}</a>'.format(this.p.url,d,c.colModel.name)}};a.jgrid.extend({odataInit:function(e){function c(m,l,h,k){var j,g;if(l&&(h||k==="nu"||k==="nn")){if(h){for(j=0;j<m.colModel.length;j++){g=m.colModel[j];if(g.name===l){if(g.odata===false){return}if(g.odataunformat){l=a.isFunction(g.odataunformat)?g.odataunformat(l,h,k):g.odataunformat;if(!l){return}}if(!g.searchrules||(!g.searchrules.integer&&!g.searchrules.number&&!g.searchrules.date)){h="'"+h+"'"}else{if(g.searchrules&&g.searchrules.date){h=(new Date(h)).toISOString()}}break}}}switch(k){case"in":case"cn":return"indexof("+l+",tolower("+h+")) gt -1";case"ni":case"nc":return"indexof("+l+",tolower("+h+")) eq -1";case"bw":return"startswith("+l+","+h+") eq true";case"bn":return"startswith("+l+","+h+") eq false";case"ew":return"endswith("+l+","+h+") eq true";case"en":return"endswith("+l+","+h+") eq false";case"nu":return l+" eq null";case"nn":return l+" ne null";default:return l+" "+k+" "+h}}}function f(g,l){var h,k,m="",j;if(g.groups){if(g.groups.length){for(h=0;h<g.groups.length;h++){m+="("+f(g.groups[h],l)+")";if(h<g.groups.length-1){m+=" "+g.groupOp.toLowerCase()+" "}}if(g.rules&&g.rules.length){m+=" "+g.groupOp.toLowerCase()+" "}}}if(g.rules.length){for(h=0;h<g.rules.length;h++){k=g.rules[h];j=c(l,k.field,k.data,k.op);if(j){m+=j+" "+g.groupOp.toLowerCase()+" "}}}m=m.trim().replace(/\s(and|or)$/,"").trim();return m}function d(j,l,h){var k={$top:h.rows,$skip:(parseInt(h.page,10)-1)*j.rowNum};if(l.datatype==="jsonp"){k.$callback=l.callback}if(l.count){k.$count=true}if(l.inlinecount){k.$inlinecount="allpages"}if(h.sidx){k.$orderby=h.sidx+" "+h.sord}if(!h._search){return k}if(h.filters){var g=a.parseJSON(h.filters);var i=f(g,j);if(i.length>0){k.$filter=i}}else{k.$filter=c(j,h.searchField,h.searchString,h.searchOper)}return k}function b(m,n){var j={datatype:n.datatype,jsonpCallback:n.callback};a.extend(m,{serializeGridData:function(o){o=d(m,n,o);this.p.odataPostData=o;return o},ajaxGridOptions:j,mtype:"GET",url:n.odataurl},j);var i={contentType:"application/"+(n.datatype==="jsonp"?"json":n.datatype)+";charset=utf-8",datatype:(n.datatype==="jsonp"?"json":n.datatype)};m.inlineEditing=a.extend(true,{beforeSaveRow:function(o,q,p){if(o.extraparam.oper==="edit"){o.url=n.odataurl;o.mtype=n.odataverbs.inlineEditingEdit;o.url+="("+q+")"}else{o.url=n.odataurl;o.mtype=n.odataverbs.inlineEditingAdd}return true},serializeSaveData:function(o){return JSON.stringify(o)},ajaxSaveOptions:i},m.inlineEditing||{});a.extend(m.formEditing,{onclickSubmit:function(o,q,p){if(p==="add"){o.url=n.odataurl;o.mtype=n.odataverbs.formEditingAdd}else{if(p==="edit"){o.url=n.odataurl+"("+q[m.id+"_id"]+")";o.mtype=n.odataverbs.formEditingEdit}}return q},ajaxEditOptions:i,serializeEditData:function(o){return JSON.stringify(o)}});a.extend(m.formDeleting,{url:n.odataurl,mtype:"DELETE",serializeDelData:function(o){return""},onclickSubmit:function(o,p){o.url+="("+p+")";return""},ajaxDelOptions:i});var k=m.colModel.filter(function(o){return !!o.key})[0];k=k?k.name:"id";if(n.datatype==="xml"){if(n.annotations){a.extend(true,m,{loadBeforeSend:function(o){o.setRequestHeader("Prefer",'odata.include-annotations="*"')}})}var g=n.useXmlSerializer?"feed":"ArrayOf"+n.entityType;var l=n.useXmlSerializer?"entry":n.entityType;var h=n.useXmlSerializer?"userdata":"ArrayOfUserData UserData";a.extend(true,m,{xmlReader:{root:g,row:l,records:function(o){return a(g+" "+l,o).length},page:function(p){var o=m.odataPostData.$skip+m.rowNum;return Math.ceil(o/m.rowNum)},total:function(q){var o=a(g+" "+l,q).length;var p=m.odataPostData.$skip+m.rowNum;return Math.ceil(p/m.rowNum)+(o>0?1:0)},repeatitems:false,userdata:h,id:k}})}else{if(n.annotations){a.extend(true,m,{loadBeforeSend:function(o){o.setRequestHeader("Prefer",'odata.include-annotations="*"')},jsonReader:{root:"value",repeatitems:false,records:function(o){return o[n.annotationName].records},page:function(o){return o[n.annotationName].page},total:function(o){return o[n.annotationName].total},userdata:function(o){return o[n.annotationName].userdata},id:k}})}else{a.extend(true,m,{jsonReader:{root:"value",repeatitems:false,records:function(o){return o["odata.count"]||o["@odata.count"]},page:function(q){var p;if(q["odata.nextLink"]){p=parseInt(q["odata.nextLink"].split("skip=")[1],10)}else{p=m.odataPostData.$skip+m.rowNum;var o=q["odata.count"]||q["@odata.count"];if(p>o){p=o}}return Math.ceil(p/m.rowNum)},total:function(p){var o=p["odata.count"]||p["@odata.count"];return Math.ceil(parseInt(o,10)/m.rowNum)},userdata:"userdata",id:k}})}}}return this.each(function(){var k=this,j=a(k),h=k.p;if(!k.grid||!h){return}var i=a.extend(true,{gencolumns:false,odataurl:h.url,datatype:"json",entityType:null,annotations:false,annotationName:"@jqgrid.GridModelAnnotate",useXmlSerializer:true,odataverbs:{inlineEditingAdd:"POST",inlineEditingEdit:"PATCH",formEditingAdd:"POST",formEditingEdit:"PUT"}},e||{});if(i.datatype==="jsonp"){i.callback="jsonpCallback"}if(!i.entityType){if(a.isFunction(i.errorfunc)){i.errorfunc({},"entityType cannot be empty",0)}return}if(!i.version||i.version<4){i=a.extend(true,{inlinecount:true,count:false},i||{})}else{i=a.extend(true,{inlinecount:false,count:true},i||{})}if(i.gencolumns){var g=a.extend(true,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,async:false,entityType:null,metadatatype:e.datatype||"xml",metadataurl:(e.odataurl||h.url)+"/$metadata"},e||{});if(g.async){g.successfunc=function(){if(k.grid.hDiv){k.grid.hDiv.loading=false}j.trigger("reloadGrid")};if(k.grid.hDiv){k.grid.hDiv.loading=true}}j.jqGrid("odataGenColModel",g)}b(h,i)})},odataGenColModel:function(c){function d(k,j){var o=[],n,s,q,p,i,m,r,l={};i=a("Schema",k).attr("Namespace")+".";n=a('EntityType[Name="'+j+'"]',k).find("Property,NavigationProperty");s=a('EntityType[Name="'+j+'"] Key PropertyRef',k);q=s&&s.length>0?s.first().attr("Name"):"";if(n){n.each(function(u,t){a.each(t.attributes,function(){l[this.name]=this.value});p=(l.Name===q);m=t.tagName==="Property"&&!!i&&l.Type.indexOf(i)>=0;r=t.tagName==="NavigationProperty";o.push(a.extend({iskey:p,isComplex:m,isNavigation:r},l))})}return o}function b(n,l){var t=[],q,w,u,j,r,o,s,m,p,v,k;for(m=0;m<n.SchemaElements.length;m++){if(n.SchemaElements[m].Name===l){q=n.SchemaElements[m].DeclaredProperties;if(n.SchemaElements[m].NavigationProperties){q=q.concat(n.SchemaElements[m].NavigationProperties)}w=n.SchemaElements[m].DeclaredKey;k=n.SchemaElements[m].Namespace;break}}u=w&&w.length>0?w[0].Name:"";if(q){for(m=0;m<q.length;m++){j=q[m].Name;s=(j===u);o=q[m].Type.IsNullable;r=q[m].Type.Definition.Namespace+"."+q[m].Type.Definition.Name;p=!!k&&r.indexOf(k)>=0;v=false;t.push({Name:j,Type:r,Nullable:o,iskey:s,isComplex:p,isNavigation:v})}}return t}var h=this[0],e=h.p,g=a(h);var f=a.extend(true,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,entityType:null,metadataurl:e.url+"/$metadata",metadatatype:"xml",async:false},c||{});if(f.metadatatype==="jsonp"){f.callback="jsonpCallback"}if(!f.entityType){if(a.isFunction(f.errorfunc)){f.errorfunc({},"entityType cannot be empty",0)}return}a.ajax({url:f.metadataurl,type:"GET",dataType:f.metadatatype,jsonpCallback:f.callback,async:f.async,cache:false}).done(function(q,y,x){var r=0,o=0,p,n,w,v,m;var u="Edm.Int16,Edm.Int32,Edm.Int64";var s="Edm.Decimal,Edm.Double,Edm.Single";var k="Edm.Byte,Edm.SByte";if(f.metadatatype!=="xml"){q=a.jgrid.odataHelper.resolveJsonReferences(q)}var l=g.triggerHandler("jqGridODataParseMetadata",q);if(l===undefined&&a.isFunction(f.parsemetadatafunc)){l=f.parsemetadatafunc(q,y,x)}if(l===undefined){var t=f.metadatatype==="xml"?d(q,f.entityType):b(q,f.entityType);if(t.length===0){if(a.isFunction(f.errorfunc)){f.errorfunc({data:q,status:y,xhr:x},"parse $metadata error",0)}}else{l=g.triggerHandler("jqGridODataParseColumns",t);if(l===undefined&&a.isFunction(f.parsecolfunc)){l=f.parsecolfunc(t)}if(l===undefined){l=[];for(r=0;r<t.length;r++){p=u.indexOf(t[r].Type)>=0;n=s.indexOf(t[r].Type)>=0;v=k.indexOf(t[r].Type)>=0;w=t[r].Type&&(t[r].Type.indexOf("Edm.")>=0&&(t[r].Type.indexOf("Date")>=0||t[r].Type.indexOf("Time")>=0));m=p?"integerStr":n?"numberStr":v?"booleanCheckbox":t[r].isComplex?"odataComplexType":t[r].isNavigation?"odataNavigationProperty":"text";l.push(a.extend({label:t[r].Name,name:t[r].Name,index:t[r].Name,editable:!t[r].isNavigation&&!t[r].iskey,searchrules:{integer:p,number:n,date:w,required:!t[r].Nullable||t[r].Nullable==="false"},editrules:this.searchrules,searchtype:p?"integer":n?"number":w?"datetime":v?"checkbox":"text",inputtype:this.searchtype,edittype:this.searchtype,key:t[r].iskey},a.jgrid.cmTemplate[m]))}}}}if(l){for(r=0;r<e.colModel.length;r++){for(o=0;o<l.length;o++){if(l[o].name===e.colModel[r].name){a.extend(true,l[o],e.colModel[r]);if(e.colModel[r].searchrules){l[o].searchrules=e.colModel[r].searchrules}if(e.colModel[r].editrules){l[o].editrules=e.colModel[r].editrules}break}}}e.colModel=l;if(a.isFunction(f.successfunc)){f.successfunc()}}else{if(a.isFunction(f.errorfunc)){f.errorfunc({data:q,status:y,xhr:x},"parse $metadata error",0)}}}).fail(function(k,j,i){if(a.isFunction(f.errorfunc)){f.errorfunc(k,j,i)}})}})}(jQuery));