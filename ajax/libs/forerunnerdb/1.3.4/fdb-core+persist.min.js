/*
 btree.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: http://github.com/dcodeIO/btree.js for details
*/
!function(A){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=A();else if("function"==typeof define&&define.amd)define([],A);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self);f.ForerunnerDB=A()}}(function(){return function f(n,l,b){function a(e,q){if(!l[e]){if(!n[e]){var d="function"==typeof require&&require;if(!q&&d)return d(e,!0);if(p)return p(e,!0);d=Error("Cannot find module '"+e+"'");throw d.code="MODULE_NOT_FOUND",
d;}d=l[e]={exports:{}};n[e][0].call(d.exports,function(c){var h=n[e][1][c];return a(h?h:c)},d,d.exports,f,n,l,b)}return l[e].exports}for(var p="function"==typeof require&&require,e=0;e<b.length;e++)a(b[e]);return a}({1:[function(f,n,l){l=f("../lib/Core");f("../lib/Persist");n.exports=l},{"../lib/Core":4,"../lib/Persist":20}],2:[function(f,n,l){var b,a,p,e,g,q;l=f("./Shared");var d=function(c){this.init.apply(this,arguments)};d.prototype.init=function(c){this._primaryKey="_id";this._primaryIndex=new a("primary");
this._primaryCrc=new a("primaryCrc");this._crcLookup=new a("crcLookup");this._name=c;this._data=[];this._groups=[];this._metrics=new b;this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};l.addModule("Collection",d);l.mixin(d.prototype,"Mixin.Common");l.mixin(d.prototype,"Mixin.Events");l.mixin(d.prototype,"Mixin.ChainReactor");l.mixin(d.prototype,"Mixin.CRUD");
l.mixin(d.prototype,"Mixin.Constants");l.mixin(d.prototype,"Mixin.Triggers");l.mixin(d.prototype,"Mixin.Sorting");b=f("./Metrics");a=f("./KeyValueStore");p=f("./Path");e=f("./IndexHashMap");g=f("./IndexBinaryTree");q=f("./Crc");f=l.modules.Core;d.prototype.crc=q;l.synthesize(d.prototype,"state");l.synthesize(d.prototype,"name");d.prototype.data=function(){return this._data};d.prototype.drop=function(){if("dropped"!==this._state){if(this._db&&this._db._collection&&this._name){this.debug()&&console.log("Dropping collection "+
this._name);this._state="dropped";this.emit("drop",this);delete this._db._collection[this._name];if(this._groups&&this._groups.length){var c=[],h;for(h=0;h<this._groups.length;h++)c.push(this._groups[h]);for(h=0;h<c.length;h++)this._groups[h].removeCollection(this)}delete this._primaryKey;delete this._primaryIndex;delete this._primaryCrc;delete this._crcLookup;delete this._name;delete this._data;delete this._groups;delete this._metrics;return!0}}else return!0;return!1};d.prototype.primaryKey=function(c){return void 0!==
c?(this._primaryKey!==c&&(this._primaryKey=c,this._primaryIndex.primaryKey(c),this.rebuildPrimaryKeyIndex()),this):this._primaryKey};d.prototype._onInsert=function(c,h){this.emit("insert",c,h)};d.prototype._onUpdate=function(c){this.emit("update",c)};d.prototype._onRemove=function(c){this.emit("remove",c)};l.synthesize(d.prototype,"db");d.prototype.setData=function(c,h,k){if(c){var a=this._metrics.create("setData");a.start();h=this.options(h);this.preSetData(c,h,k);h.$decouple&&(c=this.decouple(c));
c instanceof Array||(c=[c]);a.time("transformIn");c=this.transformIn(c);a.time("transformIn");var e=[].concat(this._data);this._dataReplace(c);a.time("Rebuild Primary Key Index");this.rebuildPrimaryKeyIndex(h);a.time("Rebuild Primary Key Index");a.time("Rebuild All Other Indexes");this._rebuildIndexes();a.time("Rebuild All Other Indexes");a.time("Resolve chains");this.chainSend("setData",c,{oldData:e});a.time("Resolve chains");a.stop();this.emit("setData",this._data,e)}k&&k(!1);return this};d.prototype.rebuildPrimaryKeyIndex=
function(c){var h=c&&void 0!==c.$ensureKeys?c.$ensureKeys:!0;c=c&&void 0!==c.$violationCheck?c.$violationCheck:!0;var k,a,e,d=this._primaryIndex,g=this._primaryCrc,p=this._crcLookup,b=this._primaryKey,q;d.truncate();g.truncate();p.truncate();k=this._data;for(a=k.length;a--;){e=k[a];h&&this.ensurePrimaryKey(e);if(c){if(!d.uniqueSet(e[b],e))throw'ForerunnerDB.Collection "'+this.name()+'": Call to setData on collection failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: '+
e[this._primaryKey];}else d.set(e[b],e);q=JSON.stringify(e);g.set(e[b],q);p.set(q,e)}};d.prototype.ensurePrimaryKey=function(c){void 0===c[this._primaryKey]&&(c[this._primaryKey]=this.objectId())};d.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this._primaryIndex=new a("primary");this._primaryCrc=new a("primaryCrc");this._crcLookup=new a("crcLookup");this.deferEmit("change",{type:"truncate"});return this};d.prototype.upsert=function(c,h){if(c){var k=this._deferQueue.upsert,
a=this._deferThreshold.upsert,e={},d;if(c instanceof Array){if(c.length>a)return this._deferQueue.upsert=k.concat(c),this.processQueue("upsert",h),{};e=[];for(k=0;k<c.length;k++)e.push(this.upsert(c[k]));h&&h();return e}c[this._primaryKey]?(d={},d[this._primaryKey]=c[this._primaryKey],this._primaryIndex.lookup(d)[0]?e.op="update":e.op="insert"):e.op="insert";switch(e.op){case "insert":e.result=this.insert(c);break;case "update":e.result=this.update(d,c)}return e}h&&h();return{}};d.prototype.update=
function(c,h,k){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var e=this,a=this._metrics.create("update"),d,g,p=function(d){var g=e.decouple(d),p,b;if(e.willTrigger(e.TYPE_UPDATE,e.PHASE_BEFORE)||e.willTrigger(e.TYPE_UPDATE,e.PHASE_AFTER)){p={type:"update",query:e.decouple(c),update:e.decouple(h),options:e.decouple(k),op:a};if(!1===e.processTrigger(p,e.TYPE_UPDATE,e.PHASE_BEFORE,g)||e.willTrigger(e.TYPE_UPDATE,
e.PHASE_BEFORE)&&(b=e.updateObject(g,p.update,p.query,p.options,""))&&!1===e.processTrigger(p,e.TYPE_UPDATE,e.PHASE_AFTER,d,g))return!1;b=e.updateObject(d,p.update,p.query,p.options,"")}else b=e.updateObject(d,h,c,k,"");return b};a.start();a.time("Retrieve documents to update");d=this.find(c,{$decouple:!1});a.time("Retrieve documents to update");d.length&&(a.time("Update documents"),g=d.filter(p),a.time("Update documents"),g.length&&(a.time("Resolve chains"),this.chainSend("update",{query:c,update:h,
dataSet:d},k),a.time("Resolve chains"),this._onUpdate(g),this.deferEmit("change",{type:"update",data:g})));a.stop();return g||[]};d.prototype._replaceObj=function(c,h){var k;this._removeFromIndexes(c);for(k in c)c.hasOwnProperty(k)&&delete c[k];for(k in h)h.hasOwnProperty(k)&&(c[k]=h[k]);if(!this._insertIntoIndexes(c))throw'ForerunnerDB.Collection "'+this.name()+'": Primary key violation in update! Key violated: '+c[this._primaryKey];return!0};d.prototype.updateById=function(c,h){var k={};k[this._primaryKey]=
c;return this.update(k,h)};d.prototype.updateObject=function(c,h,k,e,a,d){h=this.decouple(h);a=a||"";"."===a.substr(0,1)&&(a=a.substr(1,a.length-1));this.decouple(c);var g=!1,b=!1,q,f,l,m;for(m in h)if(h.hasOwnProperty(m)){q=!1;if("$"===m.substr(0,1))switch(m){case "$key":case "$index":q=!0;break;default:q=!0,b=this.updateObject(c,h[m],k,e,a,m),g=g||b}if(this._isPositionalKey(m)&&(q=!0,m=m.substr(0,m.length-2),b=new p(a+"."+m),c[m]&&c[m]instanceof Array&&c[m].length)){f=[];for(l=0;l<c[m].length;l++)this._match(c[m][l],
b.value(k)[0])&&f.push(l);for(l=0;l<f.length;l++)b=this.updateObject(c[m][f[l]],h[m+".$"],k,e,a+"."+m,d),g=g||b}if(!q)if(d||"object"!==typeof h[m])switch(d){case "$inc":this._updateIncrement(c,m,h[m]);g=!0;break;case "$push":void 0===c[m]&&this._updateProperty(c,m,[]);if(c[m]instanceof Array){if(void 0!==h[m].$position&&h[m].$each instanceof Array)for(b=h[m].$position,q=h[m].$each.length,l=0;l<q;l++)this._updateSplicePush(c[m],b+l,h[m].$each[l]);else if(h[m].$each instanceof Array)for(q=h[m].$each.length,
l=0;l<q;l++)this._updatePush(c[m],h[m].$each[l]);else this._updatePush(c[m],h[m]);g=!0}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot push to a key that is not an array! ('+m+")";break;case "$pull":if(c[m]instanceof Array){f=[];for(l=0;l<c[m].length;l++)this._match(c[m][l],h[m])&&f.push(l);for(q=f.length;q--;)this._updatePull(c[m],f[q]),g=!0}break;case "$pullAll":if(c[m]instanceof Array)if(h[m]instanceof Array){if(f=c[m],q=f.length,0<q)for(;q--;){for(b=0;b<h[m].length;b++)f[q]===h[m][b]&&
(this._updatePull(c[m],q),q--,g=!0);if(0>q)break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pullAll without being given an array of values to pull! ('+m+")";break;case "$addToSet":void 0===c[m]&&this._updateProperty(c,m,[]);if(c[m]instanceof Array){l=c[m];var t;f=l.length;var n;q=!0;t=e&&e.$addToSet;var v;h[m].$key?(b=!1,v=new p(h[m].$key),n=v.value(h[m])[0],delete h[m].$key):t&&t.key?(b=!1,v=new p(t.key),n=v.value(h[m])[0]):(n=JSON.stringify(h[m]),b=!0);for(t=0;t<f;t++)if(b){if(JSON.stringify(l[t])===
n){q=!1;break}}else if(n===v.value(l[t])[0]){q=!1;break}q&&(this._updatePush(c[m],h[m]),g=!0)}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot addToSet on a key that is not an array! (undefined)';break;case "$splicePush":void 0===c[m]&&this._updateProperty(c,m,[]);if(c[m]instanceof Array)if(b=h.$index,void 0!==b)delete h.$index,b>c[m].length&&(b=c[m].length),this._updateSplicePush(c[m],b,h[m]),g=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush without a $index integer value!';
else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush with a key that is not an array! ('+m+")";break;case "$move":if(c[m]instanceof Array)for(l=0;l<c[m].length;l++){if(this._match(c[m][l],h[m])){g=h.$index;if(void 0!==g)delete h.$index,this._updateSpliceMove(c[m],l,g),g=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move without a $index integer value!';break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move on a key that is not an array! ('+m+
")";break;case "$mul":this._updateMultiply(c,m,h[m]);g=!0;break;case "$rename":this._updateRename(c,m,h[m]);g=!0;break;case "$unset":this._updateUnset(c,m);g=!0;break;case "$pop":if(c[m]instanceof Array)this._updatePop(c[m],h[m])&&(g=!0);else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pop from a key that is not an array! ('+m+")";break;default:c[m]!==h[m]&&(this._updateProperty(c,m,h[m]),g=!0)}else if(null!==c[m]&&"object"===typeof c[m])if(l=c[m]instanceof Array,f=h[m]instanceof Array,
l||f)if(!f&&l)for(l=0;l<c[m].length;l++)b=this.updateObject(c[m][l],h[m],k,e,a+"."+m,d),g=g||b;else c[m]!==h[m]&&(this._updateProperty(c,m,h[m]),g=!0);else b=this.updateObject(c[m],h[m],k,e,a+"."+m,d),g=g||b;else c[m]!==h[m]&&(this._updateProperty(c,m,h[m]),g=!0)}return g};d.prototype._isPositionalKey=function(c){return".$"===c.substr(c.length-2,2)};d.prototype._updateProperty=function(c,h,k){c[h]=k;this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+h+
'" for collection "'+this.name()+'"')};d.prototype._updateIncrement=function(c,h,k){c[h]+=k};d.prototype._updateSpliceMove=function(c,h,k){c.splice(k,0,c.splice(h,1)[0]);this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+h+'" to "'+k+'" for collection "'+this.name()+'"')};d.prototype._updateSplicePush=function(c,h,k){c.length>h?c.splice(h,0,k):c.push(k)};d.prototype._updatePush=function(c,h){c.push(h)};d.prototype._updatePull=function(c,h){c.splice(h,
1)};d.prototype._updateMultiply=function(c,h,k){c[h]*=k};d.prototype._updateRename=function(c,h,k){c[k]=c[h];delete c[h]};d.prototype._updateUnset=function(c,h){delete c[h]};d.prototype._updatePop=function(c,h){var k=!1;0<c.length&&(1===h?(c.pop(),k=!0):-1===h&&(c.shift(),k=!0));return k};d.prototype.remove=function(c,h,k){var e,a;if(c instanceof Array){e=[];for(k=0;k<c.length;k++)e.push(this.remove(c[k],{noEmit:!0}));(!h||h&&!h.noEmit)&&this._onRemove(e);return e}k=this.find(c,{$decouple:!1});if(k.length){for(var g=
0;g<k.length;g++)a=k[g],this._removeFromIndexes(a),e=this._data.indexOf(a),this._dataRemoveAtIndex(e),this.processTrigger(this.TYPE_REMOVE,this.PHASE_AFTER,a,{});this.chainSend("remove",{query:c,dataSet:k},h);(!h||h&&!h.noEmit)&&this._onRemove(k);this.deferEmit("change",{type:"remove",data:k})}return k};d.prototype.removeById=function(c){var h={};h[this._primaryKey]=c;return this.remove(h)};d.prototype.deferEmit=function(){var c=this,h;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?
this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){c.debug()&&console.log("ForerunnerDB.Collection: Emitting "+h[0]);c.emit.apply(c,h)},100))};d.prototype.processQueue=function(c,h){var k=this._deferQueue[c],e=this._deferThreshold[c],a=this._deferTime[c];if(k.length){var g=this;k.length&&(k=k.length>e?k.splice(0,e):k.splice(0,k.length),this[c](k));setTimeout(function(){g.processQueue(c,h)},a)}else h&&h()};d.prototype.insert=
function(c,h,k){"function"===typeof h?(k=h,h=this._data.length):void 0===h&&(h=this._data.length);c=this.transformIn(c);return this._insertHandle(c,h,k)};d.prototype._insertHandle=function(c,h,k){var e=this._deferQueue.insert,a=this._deferThreshold.insert,g=[],d=[];if(c instanceof Array){if(c.length>a){this._deferQueue.insert=e.concat(c);this.processQueue("insert",k);return}for(a=0;a<c.length;a++)e=this._insert(c[a],h+a),!0===e?g.push(c[a]):d.push({doc:c[a],reason:e})}else e=this._insert(c,h),!0===
e?g.push(c):d.push({doc:c,reason:e});this.chainSend("insert",c,{index:h});this._onInsert(g,d);k&&k();this.deferEmit("change",{type:"insert",data:g});return{inserted:g,failed:d}};d.prototype._insert=function(c,h){if(c){var k;this.ensurePrimaryKey(c);if(k=this.insertIndexViolation(c))return"Index violation in index: "+k;this._insertIntoIndexes(c);h>this._data.length&&(h=this._data.length);this._dataInsertAtIndex(h,c);this.processTrigger(this.TYPE_INSERT,this.PHASE_AFTER,{},c);return!0}return"No document passed to insert"};
d.prototype._dataInsertAtIndex=function(c,h){this._data.splice(c,0,h)};d.prototype._dataRemoveAtIndex=function(c){this._data.splice(c,1)};d.prototype._dataReplace=function(c){for(;this._data.length;)this._data.pop();this._data=this._data.concat(c)};d.prototype._insertIntoIndexes=function(c){var h=this._indexByName,k,e,a=JSON.stringify(c);e=this._primaryIndex.uniqueSet(c[this._primaryKey],c);this._primaryCrc.uniqueSet(c[this._primaryKey],a);this._crcLookup.uniqueSet(a,c);for(k in h)h.hasOwnProperty(k)&&
h[k].insert(c);return e};d.prototype._removeFromIndexes=function(c){var h=this._indexByName,k,e=JSON.stringify(c);this._primaryIndex.unSet(c[this._primaryKey]);this._primaryCrc.unSet(c[this._primaryKey]);this._crcLookup.unSet(e);for(k in h)h.hasOwnProperty(k)&&h[k].remove(c)};d.prototype._rebuildIndexes=function(){var c=this._indexByName,h;for(h in c)c.hasOwnProperty(h)&&c[h].rebuild()};d.prototype.indexOfDocById=function(c){return this._data.indexOf(this._primaryIndex.get(c[this._primaryKey]))};
d.prototype.subset=function(c,h){var k=this.find(c,h);return(new d)._subsetOf(this).primaryKey(this._primaryKey).setData(k)};d.prototype.subsetOf=function(){return this.__subsetOf};d.prototype._subsetOf=function(c){this.__subsetOf=c;return this};d.prototype.distinct=function(c,h,k){h=this.find(h,k);c=new p(c);k={};var e=[],a,g;for(g=0;g<h.length;g++)(a=c.value(h[g])[0])&&!k[a]&&(k[a]=!0,e.push(a));return e};d.prototype.findById=function(c,h){var k={};k[this._primaryKey]=c;return this.find(k,h)[0]};
d.prototype.peek=function(c,h){var k=this._data,e=k.length,a,g,b=new d;if("string"===typeof c){for(a=0;a<e;a++)g=JSON.stringify(k[a]),-1<g.indexOf(c)&&b.insert(k[a]);return b.find({},h)}return this.find(c,h)};d.prototype.explain=function(c,h){return this.find(c,h).__fdbOp._data};d.prototype.options=function(c){c=c||{};c.$decouple=void 0!==c.$decouple?c.$decouple:!0;c.$explain=void 0!==c.$explain?c.$explain:!1;return c};d.prototype.find=function(c,h){c=c||{};h=this.options(h);var k=this._metrics.create("find"),
e=this,a,g=!0,d,b,q,f,l,m,t,n,v,z=[];b=function(h){return e._match(h,c,"and")};k.start();if(c){k.time("analyseQuery");a=this._analyseQuery(c,h,k);k.time("analyseQuery");k.data("analysis",a);if(a.hasJoin&&a.queriesJoin){k.time("joinReferences");for(q=0;q<a.joinsOn.length;q++)l=a.joinsOn[q],f=new p(a.joinQueries[l]),f=f.value(c)[0],this._db.collection(a.joinsOn[q]).subset(f);k.time("joinReferences")}a.indexMatch.length&&(!h||h&&!h.$skipIndex)?(k.data("index.potential",a.indexMatch),k.data("index.used",
a.indexMatch[0].index),k.time("indexLookup"),d=a.indexMatch[0].lookup,k.time("indexLookup"),a.indexMatch[0].keyData.totalKeyCount===a.indexMatch[0].keyData.score&&(g=!1)):k.flag("usedIndex",!1);g&&(d&&d.length?(a=d.length,k.time("tableScan: "+a),d=d.filter(b)):(a=this._data.length,k.time("tableScan: "+a),d=this._data.filter(b)),h.$orderBy&&(k.time("sort"),d=this.sort(h.$orderBy,d),k.time("sort")),k.time("tableScan: "+a));h.limit&&d&&d.length>h.limit&&(d.length=h.limit,k.data("limit",h.limit));h.$decouple&&
(k.time("decouple"),d=this.decouple(d),k.time("decouple"),k.data("flag.decouple",!0));if(h.join){for(b=0;b<h.join.length;b++)for(l in h.join[b])if(h.join[b].hasOwnProperty(l))for(n=l,a=this._db.collection(l),g=h.join[b][l],v=0;v<d.length;v++){t={};f=q=!1;for(m in g)if(g.hasOwnProperty(m))if("$"===m.substr(0,1))switch(m){case "$as":n=g[m];break;case "$multi":q=g[m];break;case "$require":f=g[m];break;default:m.substr(0,3)}else t[m]=(new p(g[m])).value(d[v])[0];t=a.find(t);!f||f&&t[0]?d[v][n]=!1===q?
t[0]:t:z.push(d[v])}k.data("flag.join",!0)}if(z.length){k.time("removalQueue");for(m=0;m<z.length;m++)l=d.indexOf(z[m]),-1<l&&d.splice(l,1);k.time("removalQueue")}if(h.transform){k.time("transform");for(m=0;m<d.length;m++)d.splice(m,1,h.transform(d[m]));k.time("transform");k.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(k.time("transformOut"),d=this.transformOut(d),k.time("transformOut"));k.data("results",d.length);k.stop()}else k.stop(),d=[];d.__fdbOp=k;return d};d.prototype.indexOf=
function(c){if(c=this.find(c,{$decouple:!1})[0])return this._data.indexOf(c)};d.prototype.transform=function(c){return void 0!==c?("object"===typeof c?(void 0!==c.enabled&&(this._transformEnabled=c.enabled),void 0!==c.dataIn&&(this._transformIn=c.dataIn),void 0!==c.dataOut&&(this._transformOut=c.dataOut)):this._transformEnabled=!1===c?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.transformIn=function(c){if(this._transformEnabled&&this._transformIn){if(c instanceof
Array){var h=[],k;for(k=0;k<c.length;k++)h[k]=this._transformIn(c[k]);return h}return this._transformIn(c)}return c};d.prototype.transformOut=function(c){if(this._transformEnabled&&this._transformOut){if(c instanceof Array){var h=[],k;for(k=0;k<c.length;k++)h[k]=this._transformOut(c[k]);return h}return this._transformOut(c)}return c};d.prototype.sort=function(c,h){h=h||[];var k=[],a,e;for(a in c)c.hasOwnProperty(a)&&(e={},e[a]=c[a],e.___fdbKey=a,k.push(e));return 2>k.length?this._sort(c,h):this._bucketSort(k,
h)};d.prototype._bucketSort=function(c,h){var k=c.shift(),a,e,g=[];if(0<c.length){h=this._sort(k,h);a=this.bucket(k.___fdbKey,h);for(e in a)a.hasOwnProperty(e)&&(k=[].concat(c),g=g.concat(this._bucketSort(k,a[e])));return g}return this._sort(k,h)};d.prototype._sort=function(c,h){var k=this,a,e=new p;a=e.parse(c,!0)[0];e.path(a.path);if(1===a.value)a=function(h,c){var a=e.value(h)[0],g=e.value(c)[0];return k.sortAsc(a,g)};else if(-1===a.value)a=function(h,c){var a=e.value(h)[0],g=e.value(c)[0];return k.sortDesc(a,
g)};else throw'ForerunnerDB.Collection "'+this.name()+'": $orderBy clause has invalid direction: '+a.value+", accepted values are 1 or -1 for ascending or descending!";return h.sort(a)};d.prototype.bucket=function(c,h){var k,a={};for(k=0;k<h.length;k++)a[h[k][c]]=a[h[k][c]]||[],a[h[k][c]].push(h[k]);return a};d.prototype._analyseQuery=function(c,h,k){var a={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:c,options:h},e,g=[],d=[],b,q,f,l,m,t;k.time("checkIndexes");
if(m=(new p).countKeys(c)){void 0!==c[this._primaryKey]&&(k.time("checkIndexMatch: Primary Key"),a.indexMatch.push({lookup:this._primaryIndex.lookup(c,h),keyData:{matchedKeys:[this._primaryKey],totalKeyCount:m,score:1},index:this._primaryIndex}),k.time("checkIndexMatch: Primary Key"));for(t in this._indexById)if(this._indexById.hasOwnProperty(t)&&(q=this._indexById[t],f=q.name(),k.time("checkIndexMatch: "+f),b=q.match(c,h),0<b.score&&(l=q.lookup(c,h),a.indexMatch.push({lookup:l,keyData:b,index:q})),
k.time("checkIndexMatch: "+f),b.score===m))break;k.time("checkIndexes");1<a.indexMatch.length&&(k.time("findOptimalIndex"),a.indexMatch.sort(function(h,c){if(h.keyData.score>c.keyData.score)return-1;if(h.keyData.score<c.keyData.score)return 1;if(h.keyData.score===c.keyData.score)return h.lookup.length-c.lookup.length}),k.time("findOptimalIndex"))}if(h.join){a.hasJoin=!0;for(k=0;k<h.join.length;k++)for(e in h.join[k])h.join[k].hasOwnProperty(e)&&(g.push(e),"$as"in h.join[k][e]?d.push(h.join[k][e].$as):
d.push(e));for(e=0;e<d.length;e++)if(h=this._queryReferencesCollection(c,d[e],""))a.joinQueries[g[e]]=h,a.queriesJoin=!0;a.joinsOn=g;a.queriesOn=a.queriesOn.concat(g)}return a};d.prototype._queryReferencesCollection=function(c,h,k){for(var a in c)if(c.hasOwnProperty(a)){if(a===h)return k&&(k+="."),k+a;if("object"===typeof c[a])return k&&(k+="."),k+=a,this._queryReferencesCollection(c[a],h,k)}return!1};d.prototype._match=function(c,h,k){var a,e;a=typeof c;e=typeof h;var g=!0,d;if(!("string"!==a&&"number"!==
a||"string"!==e&&"number"!==e))c!==h&&(g=!1);else for(d in h)if(h.hasOwnProperty(d)){a=!1;if("$"===d.substr(0,1)&&(e=this._matchOp(d,c,h[d]),-1<e)){if(e){if("or"===k)return!0}else g=e;a=!0}if(!a&&h[d]instanceof RegExp)if(a=!0,"object"===typeof c&&void 0!==c[d]&&h[d].test(c[d])){if("or"===k)return!0}else g=!1;if(!a)if("object"===typeof h[d])if(void 0!==c[d]){if(c[d]instanceof Array&&!(h[d]instanceof Array))for(a=!1,e=0;e<c[d].length&&!(a=this._match(c[d][e],h[d],void 0));e++);else if(!(c[d]instanceof
Array)&&h[d]instanceof Array)for(a=!1,e=0;e<h[d].length&&!(a=this._match(c[d],h[d][e],void 0));e++);else a="object"===typeof c?this._match(c[d],h[d],void 0):this._match(void 0,h[d],void 0);if(a){if("or"===k)return!0}else g=!1}else if(h[d]&&void 0!==h[d].$exists)if(a=this._match(void 0,h[d],void 0)){if("or"===k)return!0}else g=!1;else g=!1;else if(c&&c[d]===h[d]){if("or"===k)return!0}else if(c&&c[d]&&c[d]instanceof Array&&h[d]&&"object"!==typeof h[d]){a=!1;for(e=0;e<c[d].length&&!(a=this._match(c[d][e],
h[d],void 0));e++);if(a){if("or"===k)return!0}else g=!1}else g=!1;if("and"===k&&!g)return!1}return g};d.prototype._matchOp=function(a,h,k){switch(a){case "$gt":return h>k;case "$gte":return h>=k;case "$lt":return h<k;case "$lte":return h<=k;case "$exists":return void 0===h!==k;case "$ne":return h!=k;case "$or":for(a=0;a<k.length;a++)if(this._match(h,k[a],"and"))return!0;return!1;case "$and":for(a=0;a<k.length;a++)if(!this._match(h,k[a],"and"))return!1;return!0;case "$in":if(k instanceof Array){a=
k.length;var e;for(e=0;e<a;e++)if(k[e]===h)return!0;return!1}throw'ForerunnerDB.Collection "'+this.name()+'": Cannot use an $in operator on a non-array key: '+a;case "$nin":if(k instanceof Array){a=k.length;for(e=0;e<a;e++)if(k[e]===h)return!1;return!0}throw'ForerunnerDB.Collection "'+this.name()+'": Cannot use a $nin operator on a non-array key: '+a;}return-1};d.prototype.count=function(a,h){return a?this.find(a,h).length:this._data.length};d.prototype.findSub=function(a,h,k,e){var d=new p(h);a=
this.find(a);var g=a.length,b,q,f=this._db.collection("__FDB_temp_"+this.objectId()),l={parents:g,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(b=0;b<g;b++)if(q=d.value(a[b])[0]){f.setData(q);q=f.find(k,e);if(e.returnFirst&&q.length)return q[0];l.subDocs.push(q);l.subDocTotal+=q.length;l.pathFound=!0}f.drop();if(e.noStats)return l.subDocs;l.pathFound||(l.err="No objects found in the parent documents with a matching path of: "+h);return l};d.prototype.insertIndexViolation=function(a){var h,e=this._indexByName,
d,g;if(this._primaryIndex.get(a[this._primaryKey]))h=this._primaryIndex;else for(d in e)if(e.hasOwnProperty(d)&&(g=e[d],g.unique()&&g.violation(a))){h=g;break}return h?h.name():!1};d.prototype.ensureIndex=function(a,h){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var k,d={start:(new Date).getTime()};if(h)switch(h.type){case "hashed":k=new e(a,h,this);break;case "btree":k=new g(a,h,this);break;default:k=new e(a,h,this)}else k=new e(a,h,this);if(this._indexByName[k.name()])return{err:"Index with that name already exists"};
if(this._indexById[k.id()])return{err:"Index with those keys already exists"};k.rebuild();this._indexByName[k.name()]=k;this._indexById[k.id()]=k;d.end=(new Date).getTime();d.total=d.end-d.start;this._lastOp={type:"ensureIndex",stats:{time:d}};return{index:k,id:k.id(),name:k.name(),state:k.state()}};d.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};d.prototype.lastOp=function(){return this._metrics.list()};d.prototype.diff=function(a){var h={insert:[],update:[],remove:[]},
e=this.primaryKey(),d,g,b,p;if(e===a.primaryKey()){for(d=a._data;d&&!(d instanceof Array);)a=d,d=a._data;p=d.length;for(g=0;g<p;g++)b=d[g],this._primaryIndex.get(b[e])?this._primaryCrc.get(b[e])!==a._primaryCrc.get(b[e])&&h.update.push(b):h.insert.push(b);d=this._data;p=d.length;for(g=0;g<p;g++)b=d[g],a._primaryIndex.get(b[e])||h.remove.push(b)}else throw'ForerunnerDB.Collection "'+this.name()+'": Collection diffing requires that both collections have the same primary key!';return h};f.prototype.collection=
function(a,h){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new d(a)).db(this),void 0!==h&&this._collection[a].primaryKey(h),this._collection[a];throw'ForerunnerDB.Core "'+this.name()+'": Cannot get collection with undefined name!';};f.prototype.collectionExists=function(a){return Boolean(this._collection[a])};f.prototype.collections=function(a){var h=[],e;a&&(a instanceof RegExp||(a=RegExp(a)));for(e in this._collection)this._collection.hasOwnProperty(e)&&
(a?a.exec(e)&&h.push({name:e,count:this._collection[e].count()}):h.push({name:e,count:this._collection[e].count()}));return h};l.finishModule("Collection");n.exports=d},{"./Crc":5,"./IndexBinaryTree":6,"./IndexHashMap":7,"./KeyValueStore":8,"./Metrics":9,"./Path":19,"./Shared":21}],3:[function(f,n,l){var b,a;l=f("./Shared");var p=function(){this.init.apply(this,arguments)};p.prototype.init=function(e){this._name=e;this._data=new a("__FDB__cg_data_"+this._name);this._collections=[];this._view=[]};
l.addModule("CollectionGroup",p);l.mixin(p.prototype,"Mixin.Common");l.mixin(p.prototype,"Mixin.ChainReactor");l.mixin(p.prototype,"Mixin.Constants");l.mixin(p.prototype,"Mixin.Triggers");a=f("./Collection");f=l.modules.Core;b=l.modules.Core.prototype.init;p.prototype.on=function(){this._data.on.apply(this._data,arguments)};p.prototype.off=function(){this._data.off.apply(this._data,arguments)};p.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};p.prototype.primaryKey=function(a){return void 0!==
a?(this._primaryKey=a,this):this._primaryKey};l.synthesize(p.prototype,"state");l.synthesize(p.prototype,"db");p.prototype.addCollection=function(a){if(a&&-1===this._collections.indexOf(a)){if(this._collections.length){if(this._primaryKey!==a.primaryKey())throw'ForerunnerDB.CollectionGroup "'+this.name()+'": All collections in a collection group must have the same primary key!';}else this.primaryKey(a.primaryKey());this._collections.push(a);a._groups.push(this);a.chain(this);this._data.insert(a.find())}return this};
p.prototype.removeCollection=function(a){if(a){var g=this._collections.indexOf(a);-1!==g&&(a.unChain(this),this._collections.splice(g,1),g=a._groups.indexOf(this),-1!==g&&a._groups.splice(g,1));0===this._collections.length&&delete this._primaryKey}return this};p.prototype._chainHandler=function(a){switch(a.type){case "setData":a.data=this.decouple(a.data);this._data.remove(a.options.oldData);this._data.insert(a.data);break;case "insert":a.data=this.decouple(a.data);this._data.insert(a.data);break;
case "update":this._data.update(a.data.query,a.data.update,a.options);break;case "remove":this._data.remove(a.data.query,a.options)}};p.prototype.insert=function(){this._collectionsRun("insert",arguments)};p.prototype.update=function(){this._collectionsRun("update",arguments)};p.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};p.prototype.remove=function(){this._collectionsRun("remove",arguments)};p.prototype._collectionsRun=function(a,g){for(var b=0;b<this._collections.length;b++)this._collections[b][a].apply(this._collections[b],
g)};p.prototype.find=function(a,g){return this._data.find(a,g)};p.prototype.removeById=function(a){for(var g=0;g<this._collections.length;g++)this._collections[g].removeById(a)};p.prototype.subset=function(e,g){var b=this.find(e,g);return(new a)._subsetOf(this).primaryKey(this._primaryKey).setData(b)};p.prototype.drop=function(){if("dropped"!==this._state){var a,g;this._debug&&console.log("Dropping collection group "+this._name);this._state="dropped";if(this._collections&&this._collections.length)for(g=
[].concat(this._collections),a=0;a<g.length;a++)this.removeCollection(g[a]);if(this._view&&this._view.length)for(g=[].concat(this._view),a=0;a<g.length;a++)this._removeView(g[a]);this.emit("drop",this)}return!0};f.prototype.init=function(){this._collectionGroup={};b.apply(this,arguments)};f.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new p(a)).db(this),this._collectionGroup[a]):this._collectionGroup};f.prototype.collectionGroups=function(){var a=
[],g;for(g in this._collectionGroup)this._collectionGroup.hasOwnProperty(g)&&a.push({name:g});return a};n.exports=p},{"./Collection":2,"./Shared":21}],4:[function(f,n,l){var b,a,p;b=f("./Shared");p=f("./Overload");l=function(a){this.init.apply(this,arguments)};l.prototype.init=function(a){this._name=a;this._collection={};this._debug={}};l.prototype.moduleLoaded=p({string:function(a){if(void 0!==a){a=a.replace(/ /g,"");a=a.split(",");var g;for(g=0;g<a.length;g++)if(!b.modules[a[g]])return!1;return!0}return!1},
"string, function":function(a,g){if(void 0!==a){a=a.replace(/ /g,"");var p=a.split(","),d;for(d=0;d<p.length;d++)if(!b.modules[p[d]])return!1;g()}},"string, function, function":function(a,g,p){if(void 0!==a){a=a.replace(/ /g,"");a=a.split(",");var d;for(d=0;d<a.length;d++)if(!b.modules[a[d]])return p(),!1;g()}}});l.prototype.version=function(a,g){return void 0!==a?0===b.version.indexOf(a)?(g&&g(),!0):!1:b.version};l.moduleLoaded=l.prototype.moduleLoaded;l.version=l.prototype.version;l.shared=b;l.prototype.shared=
b;b.addModule("Core",l);b.mixin(l.prototype,"Mixin.Common");b.mixin(l.prototype,"Mixin.ChainReactor");b.mixin(l.prototype,"Mixin.Constants");a=f("./Collection.js");f("./Metrics.js");f=f("./Crc.js");l.prototype._isServer=!1;b.synthesize(l.prototype,"state");b.synthesize(l.prototype,"name");l.prototype.isClient=function(){return!this._isServer};l.prototype.isServer=function(){return this._isServer};l.prototype.crc=f;l.prototype.isClient=function(){return!this._isServer};l.prototype.isServer=function(){return this._isServer};
l.prototype.arrayToCollection=function(e){return(new a).setData(e)};l.prototype.on=function(a,g){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(g);return this};l.prototype.off=function(a,g){if(a in this._listeners){var b=this._listeners[a],d=b.indexOf(g);-1<d&&b.splice(d,1)}return this};l.prototype.emit=function(a,g){this._listeners=this._listeners||{};if(a in this._listeners){var b=this._listeners[a],d=b.length,c;for(c=0;c<d;c++)b[c].apply(this,
Array.prototype.slice.call(arguments,1))}return this};l.prototype.peek=function(a){var g,b,d=[],c=typeof a;for(g in this._collection)this._collection.hasOwnProperty(g)&&(b=this._collection[g],d="string"===c?d.concat(b.peek(a)):d.concat(b.find(a)));return d};l.prototype.peekCat=function(a){var g,b,d={},c,h=typeof a;for(g in this._collection)this._collection.hasOwnProperty(g)&&(b=this._collection[g],(c="string"===h?b.peek(a):b.find(a))&&c.length&&(d[b.name()]=c));return d};l.prototype.drop=function(a){if("dropped"!==
this._state){var g=this.collections(),b=g.length,d,c=0;this._state="dropped";for(d=0;d<b;d++)this.collection(g[d].name).drop(function(){c++;c===b&&a&&a()}),delete this._collection[g[d].name];this.emit("drop",this)}return!0};n.exports=l},{"./Collection.js":2,"./Crc.js":5,"./Metrics.js":9,"./Overload":18,"./Shared":21}],5:[function(f,n,l){var b=function(){var a=[],b,e,g;for(e=0;256>e;e++){b=e;for(g=0;8>g;g++)b=b&1?3988292384^b>>>1:b>>>1;a[e]=b}return a}();n.exports=function(a){var p=-1,e;for(e=0;e<
a.length;e++)p=p>>>8^b[(p^a.charCodeAt(e))&255];return(p^-1)>>>0}},{}],6:[function(f,n,l){l=f("./Shared");var b=f("./Path"),a=f("./vendor/btree");f=function(){this.init.apply(this,arguments)};f.prototype.init=function(b,e,g){this._btree=new (a.create(2,this.sortAsc));this._size=0;this._id=this._itemKeyHash(b,b);this.unique(e&&e.unique?e.unique:!1);void 0!==b&&this.keys(b);void 0!==g&&this.collection(g);this.name(e&&e.name?e.name:this._id)};l.addModule("IndexBinaryTree",f);l.mixin(f.prototype,"Mixin.ChainReactor");
l.mixin(f.prototype,"Mixin.Sorting");f.prototype.id=function(){return this._id};f.prototype.state=function(){return this._state};f.prototype.size=function(){return this._size};l.synthesize(f.prototype,"data");l.synthesize(f.prototype,"name");l.synthesize(f.prototype,"collection");l.synthesize(f.prototype,"type");l.synthesize(f.prototype,"unique");f.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,this):this._keys};f.prototype.rebuild=function(){if(this._collection){var b=
this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),e,g=b.length;this._btree=new (a.create(2,this.sortAsc));this._unique&&(this._uniqueLookup={});for(e=0;e<g;e++)this.insert(b[e])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};f.prototype.insert=function(a,e){var g=this._unique,b=this._itemKeyHash(a,this._keys);g&&(g=this._itemHash(a,this._keys),this._uniqueLookup[g]=a);g=this._btree.get(b);void 0===g&&(g=[],this._btree.put(b,
g));g.push(a);this._size++};f.prototype.remove=function(a,b){var g=this._unique,f=this._itemKeyHash(a,this._keys),d;g&&(g=this._itemHash(a,this._keys),delete this._uniqueLookup[g]);g=this._btree.get(f);void 0!==g&&(d=g.indexOf(a),-1<d&&(1===g.length?this._btree.del(f):g.splice(d,1),this._size--))};f.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};f.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};f.prototype.lookup=function(a){return this._data[this._itemHash(a,
this._keys)]||[]};f.prototype.match=function(a,e){var g=new b,f=g.parseArr(this._keys),g=g.parseArr(a),d=[],c=0,h;for(h=0;h<f.length;h++)if(g[h]===f[h])c++,d.push(g[h]);else return{matchedKeys:[],totalKeyCount:g.length,score:0};return{matchedKeys:d,totalKeyCount:g.length,score:c}};f.prototype._itemHash=function(a,e){var g=new b,f,d="",c;f=g.parse(e);for(c=0;c<f.length;c++)d&&(d+="_"),d+=g.value(a,f[c].path).join(":");return d};f.prototype._itemKeyHash=function(a,e){var g=new b,f,d="",c;f=g.parse(e);
for(c=0;c<f.length;c++)d&&(d+="_"),d+=g.keyValue(a,f[c].path);return d};f.prototype._itemHashArr=function(a,e){var g=new b,f,d=[],c,h,k,l;f=g.parse(e);for(k=0;k<f.length;k++)for(c=g.value(a,f[k].path),h=0;h<c.length;h++)if(0===k)d.push(c[h]);else for(l=0;l<d.length;l++)d[l]=d[l]+"_"+c[h];return d};l.finishModule("IndexBinaryTree");n.exports=f},{"./Path":19,"./Shared":21,"./vendor/btree":22}],7:[function(f,n,l){l=f("./Shared");var b=f("./Path");f=function(){this.init.apply(this,arguments)};f.prototype.init=
function(a,b,e){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(b&&b.unique?b.unique:!1);void 0!==a&&this.keys(a);void 0!==e&&this.collection(e);this.name(b&&b.name?b.name:this._id)};l.addModule("IndexHashMap",f);l.mixin(f.prototype,"Mixin.ChainReactor");f.prototype.id=function(){return this._id};f.prototype.state=function(){return this._state};f.prototype.size=function(){return this._size};l.synthesize(f.prototype,"data");l.synthesize(f.prototype,"name");
l.synthesize(f.prototype,"collection");l.synthesize(f.prototype,"type");l.synthesize(f.prototype,"unique");f.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,this):this._keys};f.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),b,e=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(b=0;b<e;b++)this.insert(a[b])}this._state={name:this._name,keys:this._keys,
indexSize:this._size,built:new Date,updated:new Date,ok:!0}};f.prototype.insert=function(a,b){var e,g;this._unique&&(e=this._itemHash(a,this._keys),this._uniqueLookup[e]=a);e=this._itemHashArr(a,this._keys);for(g=0;g<e.length;g++)this.pushToPathValue(e[g],a)};f.prototype.remove=function(a,b){var e,g;this._unique&&(e=this._itemHash(a,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(a,this._keys);for(g=0;g<e.length;g++)this.pullFromPathValue(e[g],a)};f.prototype.violation=function(a){a=
this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};f.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};f.prototype.pushToPathValue=function(a,b){var e=this._data[a]=this._data[a]||[];-1===e.indexOf(b)&&(e.push(b),this._size++,this.pushToCrossRef(b,e))};f.prototype.pullFromPathValue=function(a,b){var e=this._data[a],g;g=e.indexOf(b);-1<g&&(e.splice(g,1),this._size--,this.pullFromCrossRef(b,e));e.length||delete this._data[a]};f.prototype.pull=function(a){var b=
a[this._collection.primaryKey()],e=this._crossRef[b],g,f=e.length,d;for(g=0;g<f;g++)d=e[g],this._pullFromArray(d,a);this._size--;delete this._crossRef[b]};f.prototype._pullFromArray=function(a,b){for(var e=a.length;e--;)a[e]===b&&a.splice(e,1)};f.prototype.pushToCrossRef=function(a,b){var e=a[this._collection.primaryKey()];this._crossRef[e]=this._crossRef[e]||[];e=this._crossRef[e];-1===e.indexOf(b)&&e.push(b)};f.prototype.pullFromCrossRef=function(a,b){var e=a[this._collection.primaryKey()];delete this._crossRef[e]};
f.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};f.prototype.match=function(a,p){var e=new b,g=e.parseArr(this._keys),e=e.parseArr(a),f=[],d=0,c;for(c=0;c<g.length;c++)if(e[c]===g[c])d++,f.push(e[c]);else return{matchedKeys:[],totalKeyCount:e.length,score:0};return{matchedKeys:f,totalKeyCount:e.length,score:d}};f.prototype._itemHash=function(a,p){var e=new b,g,f="",d;g=e.parse(p);for(d=0;d<g.length;d++)f&&(f+="_"),f+=e.value(a,g[d].path).join(":");return f};f.prototype._itemKeyHash=
function(a,p){var e=new b,g,f="",d;g=e.parse(p);for(d=0;d<g.length;d++)f&&(f+="_"),f+=e.keyValue(a,g[d].path);return f};f.prototype._itemHashArr=function(a,p){var e=new b,g,f=[],d,c,h,k;g=e.parse(p);for(h=0;h<g.length;h++)for(d=e.value(a,g[h].path),c=0;c<d.length;c++)if(0===h)f.push(d[c]);else for(k=0;k<f.length;k++)f[k]=f[k]+"_"+d[c];return f};l.finishModule("IndexHashMap");n.exports=f},{"./Path":19,"./Shared":21}],8:[function(f,n,l){f=f("./Shared");l=function(b){this.init.apply(this,arguments)};
l.prototype.init=function(b){this._name=b;this._data={};this._primaryKey="_id"};f.addModule("KeyValueStore",l);f.mixin(l.prototype,"Mixin.ChainReactor");f.synthesize(l.prototype,"name");l.prototype.primaryKey=function(b){return void 0!==b?(this._primaryKey=b,this):this._primaryKey};l.prototype.truncate=function(){this._data={};return this};l.prototype.set=function(b,a){this._data[b]=a?a:!0;return this};l.prototype.get=function(b){return this._data[b]};l.prototype.lookup=function(b){b=b[this._primaryKey];
var a,p,e,g;if(b instanceof Array){p=b.length;g=[];for(a=0;a<p;a++)(e=this._data[b[a]])&&g.push(e);return g}if(b instanceof RegExp){g=[];for(a in this._data)this._data.hasOwnProperty(a)&&b.test(a)&&g.push(this._data[a]);return g}if("object"===typeof b){if(b.$ne){g=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==b.$ne&&g.push(this._data[a]);return g}if(b.$in&&b.$in instanceof Array){g=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<b.$in.indexOf(a)&&g.push(this._data[a]);return g}if(b.$nin&&
b.$nin instanceof Array){g=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===b.$nin.indexOf(a)&&g.push(this._data[a]);return g}if(b.$or&&b.$or instanceof Array){g=[];for(a=0;a<b.$or.length;a++)g=g.concat(this.lookup(b.$or[a]));return g}}else return e=this._data[b],void 0!==e?[e]:[]};l.prototype.unSet=function(b){delete this._data[b];return this};l.prototype.uniqueSet=function(b,a){return void 0===this._data[b]?(this._data[b]=a,!0):!1};f.finishModule("KeyValueStore");n.exports=l},{"./Shared":21}],
9:[function(f,n,l){l=f("./Shared");var b=f("./Operation");f=function(){this.init.apply(this,arguments)};f.prototype.init=function(){this._data=[]};l.addModule("Metrics",f);l.mixin(f.prototype,"Mixin.ChainReactor");f.prototype.create=function(a){a=new b(a);this._enabled&&this._data.push(a);return a};f.prototype.start=function(){this._enabled=!0;return this};f.prototype.stop=function(){this._enabled=!1;return this};f.prototype.clear=function(){this._data=[];return this};f.prototype.list=function(){return this._data};
l.finishModule("Metrics");n.exports=f},{"./Operation":17,"./Shared":21}],10:[function(f,n,l){n.exports={preSetData:function(){},postSetData:function(){}}},{}],11:[function(f,n,l){n.exports={chain:function(b){this._chain=this._chain||[];-1===this._chain.indexOf(b)&&this._chain.push(b)},unChain:function(b){this._chain&&(b=this._chain.indexOf(b),-1<b&&this._chain.splice(b,1))},chainSend:function(b,a,p){if(this._chain){var e=this._chain,g=e.length,f;for(f=0;f<g;f++)e[f].chainReceive(this,b,a,p)}},chainReceive:function(b,
a,f,e){b={sender:b,type:a,data:f,options:e};(!this._chainHandler||this._chainHandler&&!this._chainHandler(b))&&this.chainSend(b.type,b.data,b.options)}}},{}],12:[function(f,n,l){var b=0;f={decouple:function(a,b){if(void 0!==a){if(b){var e,g=JSON.stringify(a),f=[];for(e=0;e<b;e++)f.push(JSON.parse(g));return f}return JSON.parse(JSON.stringify(a))}},objectId:function(a){var f=Math.pow(10,17);if(a){var e=0,g=a.length,l;for(l=0;l<g;l++)e+=a.charCodeAt(l)*f;a=e.toString(16)}else b++,a=(b+(Math.random()*
f+Math.random()*f+Math.random()*f+Math.random()*f)).toString(16);return a},debug:f("./Overload")([function(){return this._debug&&this._debug.all},function(a){return void 0!==a?"boolean"===typeof a?(this._debug=this._debug||{},this._debug.all=a,this.chainSend("debug",this._debug),this):this._debug&&this._debug[a]||this._db&&this._db._debug&&this._db._debug[a]||this._debug&&this._debug.all:this._debug&&this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug=this._debug||{},this._debug[a]=
b,this.chainSend("debug",this._debug),this):this._debug&&this._debug[b]||this._db&&this._db._debug&&this._db._debug[a]:this._debug&&this._debug.all}])};n.exports=f},{"./Overload":18}],13:[function(f,n,l){n.exports={TYPE_INSERT:0,TYPE_UPDATE:1,TYPE_REMOVE:2,PHASE_BEFORE:0,PHASE_AFTER:1}},{}],14:[function(f,n,l){f={on:new Overload({"string, function":function(b,a){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b]["*"]=this._listeners[b]["*"]||[];this._listeners[b]["*"].push(a);
return this},"string, *, function":function(b,a,f){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b][a]=this._listeners[b][a]||[];this._listeners[b][a].push(f);return this}}),off:new Overload({string:function(b){this._listeners&&this._listeners[b]&&b in this._listeners&&delete this._listeners[b];return this},"string, function":function(b,a){var f,e;"string"===typeof a?this._listeners&&this._listeners[b]&&this._listeners[b][a]&&delete this._listeners[b][a]:
b in this._listeners&&(f=this._listeners[b]["*"],e=f.indexOf(a),-1<e&&f.splice(e,1));return this},"string, *, function":function(b,a,f){this._listeners&&b in this._listeners&&a in this.listeners[b]&&(b=this._listeners[b][a],f=b.indexOf(f),-1<f&&b.splice(f,1))},"string, *":function(b,a){this._listeners&&b in this._listeners&&a in this._listeners[b]&&delete this._listeners[b][a]}}),emit:function(b,a){this._listeners=this._listeners||{};if(b in this._listeners){if(this._listeners[b]["*"]){var f=this._listeners[b]["*"],
e=f.length,g;for(g=0;g<e;g++)f[g].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&a[0][this._primaryKey]){var f=this._listeners[b],l,d,e=a.length;for(g=0;g<e;g++)if(f[a[g][this._primaryKey]])for(l=f[a[g][this._primaryKey]].length,d=0;d<l;d++)f[a[g][this._primaryKey]][d].apply(this,Array.prototype.slice.call(arguments,1))}}return this}};n.exports=f},{}],15:[function(f,n,l){n.exports={sortAsc:function(b,a){return"string"===typeof b&&"string"===typeof a?b.localeCompare(a):
b>a?1:b<a?-1:0},sortDesc:function(b,a){return"string"===typeof b&&"string"===typeof a?a.localeCompare(b):b>a?-1:b<a?1:0}}},{}],16:[function(f,n,l){n.exports={addTrigger:function(b,a,f,e){return-1===this._triggerIndex(b,a,f)?(this._trigger=this._trigger||{},this._trigger[a]=this._trigger[a]||{},this._trigger[a][f]=this._trigger[a][f]||[],this._trigger[a][f].push({id:b,method:e}),!0):!1},removeTrigger:function(b,a,f){b=this._triggerIndex(b,a,f);-1<b&&this._trigger[a][f].splice(b,1);return!1},willTrigger:function(b,
a){return this._trigger&&this._trigger[b]&&this._trigger[b][a]&&this._trigger[b][a].length},processTrigger:function(b,a,f,e,g){var l,d,c,h;if(this._trigger&&this._trigger[a]&&this._trigger[a][f]){l=this._trigger[a][f];c=l.length;for(d=0;d<c;d++){h=l[d];if(this.debug()){var k,r;switch(a){case this.TYPE_INSERT:k="insert";break;case this.TYPE_UPDATE:k="update";break;case this.TYPE_REMOVE:k="remove";break;default:k=""}switch(f){case this.PHASE_BEFORE:r="before";break;case this.PHASE_AFTER:r="after";break;
default:r=""}console.log('Triggers: Processing trigger "'+id+'" for '+k+' in phase "'+r+'"')}h=h.method.call(this,b,e,g);if(!1===h)return!1;if(void 0!==h&&!0!==h&&!1!==h)throw"ForerunnerDB.Mixin.Triggers: Trigger error: "+h;}return!0}},_triggerIndex:function(b,a,f){var e;if(this._trigger&&this._trigger[a]&&this._trigger[a][f])for(a=this._trigger[a][f],f=a.length,e=0;e<f;e++)if(a[e].id===b)return e;return-1}}},{}],17:[function(f,n,l){l=f("./Shared");var b=f("./Path");f=function(a){this.pathSolver=
new b;this.counter=0;this.init.apply(this,arguments)};f.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};l.addModule("Operation",f);l.mixin(f.prototype,"Mixin.ChainReactor");f.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};f.prototype.log=function(a){if(a){var b=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};
this._data.log.push(a);b&&(a.delta=a.time-b);return this}return this._data.log};f.prototype.time=function(a){if(void 0!==a){var b=this._data.time.process,b=b[a]=b[a]||{};b.startMs?(b.stopMs=(new Date).getTime(),b.totalMs=b.stopMs-b.startMs,b.stepObj.totalMs=b.totalMs,delete b.stepObj):(b.startMs=(new Date).getTime(),b.stepObj={name:a},this._data.steps.push(b.stepObj));return this}return this._data.time};f.prototype.flag=function(a,b){if(void 0!==a&&void 0!==b)this._data.flag[a]=b;else return void 0!==
a?this._data.flag[a]:this._data.flag};f.prototype.data=function(a,b,e){return void 0!==b?(this.pathSolver.set(this._data,a,b),this):this.pathSolver.get(this._data,a)};f.prototype.pushData=function(a,b,e){this.pathSolver.push(this._data,a,b)};f.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};l.finishModule("Operation");n.exports=f},{"./Path":19,"./Shared":21}],18:[function(f,n,l){Overload=function(b){if(b){var a,
f,e,g,l;if(!(b instanceof Array)){e={};for(a in b)if(b.hasOwnProperty(a))if(g=a.replace(/ /g,""),-1===g.indexOf("*"))e[g]=b[a];else for(l=generateSignaturePermutations(g),g=0;g<l.length;g++)e[l[g]]||(e[l[g]]=b[a]);b=e}return function(){if(b instanceof Array)for(f=b.length,a=0;a<f;a++){if(b[a].length===arguments.length)return b[a].apply(this,arguments)}else{var d=[],c;for(a=0;a<arguments.length;a++)c=typeof arguments[a],"object"===c&&arguments[a]instanceof Array&&(c="array"),d.push(c);c=d.join(",");
if(b[c])return b[c].apply(this,arguments);for(a=d.length;0<=a;a--)if(c=d.slice(0,a).join(","),b[c+",..."])return b[c+",..."].apply(this,arguments)}throw'ForerunnerDB.Overload "'+this.name()+'": Overloaded method does not have a matching signature for the passed arguments: '+JSON.stringify(d);}}return function(){}};generateSignaturePermutations=function(b){var a=[],f,e=["string","object","number","function","undefined"],g;if(-1<b.indexOf("*"))for(g=0;g<e.length;g++)f=b.replace("*",e[g]),a=a.concat(generateSignaturePermutations(f));
else a.push(b);return a};n.exports=Overload},{}],19:[function(f,n,l){f=f("./Shared");l=function(b){this.init.apply(this,arguments)};l.prototype.init=function(b){b&&this.path(b)};f.addModule("Path",l);f.mixin(l.prototype,"Mixin.ChainReactor");l.prototype.path=function(b){return void 0!==b?(this._path=this.clean(b),this._pathParts=this._path.split("."),this):this._path};l.prototype.hasObjectPaths=function(b,a){var f=!0,e;for(e in b)if(b.hasOwnProperty(e)&&(void 0===a[e]||"object"===typeof b[e]&&(f=
this.hasObjectPaths(b[e],a[e]),!f)))return!1;return f};l.prototype.countKeys=function(b){var a=0,f;for(f in b)b.hasOwnProperty(f)&&void 0!==b[f]&&("object"!==typeof b[f]?a++:a+=this.countKeys(b[f]));return a};l.prototype.countObjectPaths=function(b,a){var f,e={},g=0,l=0,d;for(d in a)a.hasOwnProperty(d)&&("object"===typeof a[d]?(f=this.countObjectPaths(b[d],a[d]),e[d]=f.matchedKeys,l+=f.totalKeyCount,g+=f.matchedKeyCount):(l++,b&&b[d]&&"object"!==typeof b[d]?(e[d]=!0,g++):e[d]=!1));return{matchedKeys:e,
matchedKeyCount:g,totalKeyCount:l}};l.prototype.parse=function(b,a){var f=[],e="",g,l,d;for(l in b)if(b.hasOwnProperty(l))if(e=l,"object"===typeof b[l])if(a)for(g=this.parse(b[l],a),d=0;d<g.length;d++)f.push({path:e+"."+g[d].path,value:g[d].value});else for(g=this.parse(b[l]),d=0;d<g.length;d++)f.push({path:e+"."+g[d].path});else a?f.push({path:e,value:b[l]}):f.push({path:e});return f};l.prototype.parseArr=function(b,a){a=a||{};return this._parseArr(b,"",[],a)};l.prototype._parseArr=function(b,a,
f,e){var g,l="";a=a||"";f=f||[];for(g in b)b.hasOwnProperty(g)&&(!e.ignore||e.ignore&&!e.ignore.test(g))&&(l=a?a+"."+g:g,"object"===typeof b[g]?this._parseArr(b[g],l,f,e):f.push(l));return f};l.prototype.value=function(b,a){if(void 0!==b&&"object"===typeof b){var f,e,g,l,d=[],c;void 0!==a&&(a=this.clean(a),f=a.split("."));f=f||this._pathParts;e=f.length;g=b;for(c=0;c<e;c++){g=g[f[c]];if(l instanceof Array){for(e=0;e<l.length;e++)d=d.concat(this.value(l,e+"."+f[c]));return d}if(!g||"object"!==typeof g)break;
l=g}return[g]}return[]};l.prototype.set=function(b,a,f){if(void 0!==b&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();a.length?(b[e]=b[e]||{},this.set(b[e],a.join("."),f)):b[e]=f}return b};l.prototype.get=function(b,a){return this.value(b,a)[0]};l.prototype.push=function(b,a,f){if(void 0!==b&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();if(a.length)b[e]=b[e]||{},this.set(b[e],a.join("."),f);else if(b[e]=b[e]||[],b[e]instanceof Array)b[e].push(f);else throw"ForerunnerDB.Path: Cannot push to a path whose endpoint is not an array!";
}return b};l.prototype.keyValue=function(b,a){var f,e,g,l,d;void 0!==a&&(a=this.clean(a),f=a.split("."));f=f||this._pathParts;e=f.length;g=b;for(d=0;d<e;d++)if(g=g[f[d]],!g||"object"!==typeof g){l=f[d]+":"+g;break}return l};l.prototype.clean=function(b){"."===b.substr(0,1)&&(b=b.substr(1,b.length-1));return b};f.finishModule("Path");n.exports=l},{"./Shared":21}],20:[function(f,n,l){l=f("./Shared");var b=f("localforage"),a,p,e,g,q;q=function(){this.init.apply(this,arguments)};q.prototype.init=function(a){a.isClient()&&
void 0!==Storage&&(this.mode("localforage"),b.config({driver:[b.INDEXEDDB,b.WEBSQL,b.LOCALSTORAGE],name:"ForerunnerDB",storeName:"FDB"}))};l.addModule("Persist",q);l.mixin(q.prototype,"Mixin.ChainReactor");a=l.modules.Core;p=f("./Collection");e=p.prototype.drop;f("./CollectionGroup");g=a.prototype.init;f=l.overload;q.prototype.mode=function(a){return void 0!==a?(this._mode=a,this):this._mode};q.prototype.driver=function(a){if(void 0!==a){switch(a.toUpperCase()){case "LOCALSTORAGE":b.setDriver(b.LOCALSTORAGE);
break;case "WEBSQL":b.setDriver(b.WEBSQL);break;case "INDEXEDDB":b.setDriver(b.INDEXEDDB);break;default:throw"ForerunnerDB.Persist: The persistence driver you have specified is not found. Please use either IndexedDB, WebSQL or LocalStorage!";}return this}return b.driver()};q.prototype.save=function(a,c,h){var k;k=function(a,h){a="object"===typeof a?"json::fdb::"+JSON.stringify(a):"raw::fdb::"+a;h&&h(!1,a)};switch(this.mode()){case "localforage":k(c,function(k,c){b.setItem(a,c).then(function(a){h(!1,
a)},function(a){h(a)})});break;default:h&&h("No data handler.")}};q.prototype.load=function(a,c){var h,k,g;g=function(a,b){if(a){h=a.split("::fdb::");switch(h[0]){case "json":k=JSON.parse(h[1]);break;case "raw":k=h[1]}b&&b(!1,k)}else b(!1,a)};switch(this.mode()){case "localforage":b.getItem(a).then(function(a){g(a,c)},function(a){c(a)});break;default:c&&c("No data handler or unrecognised data type.")}};q.prototype.drop=function(a,c){switch(this.mode()){case "localforage":b.removeItem(a).then(function(){c(!1)},
function(a){c(a)});break;default:c&&c("No data handler or unrecognised data type.")}};p.prototype.drop=new f({"":function(){"dropped"!==this._state&&this.drop(!0)},"function":function(a){"dropped"!==this._state&&this.drop(!0,a)},"boolean":function(a){if("dropped"!==this._state){if(a)if(this._name)if(this._db)this._db.persist.drop(this._name);else throw"ForerunnerDB.Persist: Cannot drop a collection's persistent storage when the collection is not attached to a database!";else throw"ForerunnerDB.Persist: Cannot drop a collection's persistent storage when no name assigned to collection!";
e.apply(this,arguments)}},"boolean, function":function(a,b){"dropped"!==this._state&&(a&&(this._name?this._db?this._db.persist.drop(this._name,b):b&&b("Cannot drop a collection's persistent storage when the collection is not attached to a database!"):b&&b("Cannot drop a collection's persistent storage when no name assigned to collection!")),e.apply(this,arguments))}});p.prototype.save=function(a){this._name?this._db?this._db.persist.save(this._name,this._data,a):a&&a("Cannot save a collection that is not attached to a database!"):
a&&a("Cannot save a collection with no assigned name!")};p.prototype.load=function(a){var b=this;this._name?this._db?this._db.persist.load(this._name,function(h,k){h?a&&a(h):(k&&b.setData(k),a&&a(!1))}):a&&a("Cannot load a collection that is not attached to a database!"):a&&a("Cannot load a collection with no assigned name!")};a.prototype.init=function(){this.persist=new q(this);g.apply(this,arguments)};a.prototype.load=function(a){var b=this._collection,h=b.keys().length,k;for(k in b)b.hasOwnProperty(k)&&
b[k].load(function(b){b?a(b):(h--,0===h&&a(!1))})};a.prototype.save=function(a){var b=this._collection,h=b.keys().length,k;for(k in b)b.hasOwnProperty(k)&&b[k].save(function(b){b?a(b):(h--,0===h&&a(!1))})};l.finishModule("Persist");n.exports=q},{"./Collection":2,"./CollectionGroup":3,"./Shared":21,localforage:29}],21:[function(f,n,l){f={version:"1.3.4",modules:{},_synth:{},addModule:function(b,a){this.modules[b]=a;this.emit("moduleLoad",[b,a])},finishModule:function(b){if(this.modules[b])this.modules[b]._fdbFinished=
!0,this.emit("moduleFinished",[b,this.modules[b]]);else throw"ForerunnerDB.Shared: finishModule called on a module that has not been registered with addModule(): "+b;},moduleFinished:function(b,a){if(this.modules[b]&&this.modules[b]._fdbFinished)a(b,this.modules[b]);else this.on("moduleFinished",a)},moduleExists:function(b){return Boolean(this.modules[b])},mixin:function(b,a){var f=this.mixins[a];if(f)for(var e in f)f.hasOwnProperty(e)&&(b[e]=f[e]);else throw"ForerunnerDB.Shared: Cannot find mixin named: "+
a;},synthesize:function(b,a,f){this._synth[a]=this._synth[a]||function(b){return void 0!==b?(this["_"+a]=b,this):this["_"+a]};if(f){var e=this;b[a]=function(){var b=this.$super,l;this.$super=e._synth[a];l=f.apply(this,arguments);this.$super=b;return l}}else b[a]=this._synth[a]},overload:f("./Overload"),mixins:{"Mixin.Common":f("./Mixin.Common"),"Mixin.Events":f("./Mixin.Events"),"Mixin.ChainReactor":f("./Mixin.ChainReactor"),"Mixin.CRUD":f("./Mixin.CRUD"),"Mixin.Constants":f("./Mixin.Constants"),
"Mixin.Triggers":f("./Mixin.Triggers"),"Mixin.Sorting":f("./Mixin.Sorting")}};f.mixin(f,"Mixin.Events");n.exports=f},{"./Mixin.CRUD":10,"./Mixin.ChainReactor":11,"./Mixin.Common":12,"./Mixin.Constants":13,"./Mixin.Events":14,"./Mixin.Sorting":15,"./Mixin.Triggers":16,"./Overload":18}],22:[function(f,n,l){f=function(){function b(a){for(var b=[],g=0;g<arguments.length;g++)b=b.concat(arguments[g]);return b}var a={strcmp:function(a,b){for(var g,f,d=0;d<a.length;d++){if(d>=b.length)return 1;if((g=a.charCodeAt(d))<
(f=b.charCodeAt(d)))return-1;if(g>f)return 1}return a.length==b.length?0:-1},numcmp:function(a,b){return a<b?-1:a>b?1:0},create:function(f,e){function g(){this.root=new d(this)}f="undefined"==typeof f?52:"number"==typeof f?Math.floor(f):parseInt(f,10);1>f&&(f=1);var l=1<f?Math.floor(f/2):1;"function"!=typeof e&&(e=a.numcmp);var d=function(a,b,c){this.parent=a;this.leaves=b||[];this.leaves.forEach(function(a){a.parent=this},this);this.nodes=c||[null];this.nodes.forEach(function(a){null!==a&&(a.parent=
this)},this)};d.prototype.search=function(a){if(0<this.leaves.length){var b=this.leaves[0];if(0==e(b.key,a))return{leaf:b,index:0};if(0>e(a,b.key))return null!==this.nodes[0]?this.nodes[0].search(a):{node:this,index:0};for(b=1;b<this.leaves.length;b++){var c=this.leaves[b];if(0==e(c.key,a))return{leaf:c,index:b};if(0>e(a,c.key))break}return null!==this.nodes[b]?this.nodes[b].search(a):{node:this,index:b}}return{node:this,index:0}};d.prototype.get=function(a){a=this.search(a);if(a.leaf)return a.leaf.value};
d.prototype.put=function(a,b,g){var e=this.search(a);if(e.leaf){if("undefined"!==typeof g&&!g)return!1;e.leaf.value=b;return!0}g=e.node;e=e.index;g.leaves.splice(e,0,new c(g,a,b));g.nodes.splice(e+1,0,null);g.leaves.length>f&&g.split();return!0};d.prototype.del=function(a){var b=this.search(a);if(!b.leaf)return!1;a=b.leaf.parent;var b=b.index,c=a.nodes[b];if(null===c)a.leaves.splice(b,1),a.nodes.splice(b,1),a.balance();else{var g=c.leaves[c.leaves.length-1];c.del(g.key);g.parent=a;a.leaves.splice(b,
1,g)}return!0};d.prototype.balance=function(){if(this.parent instanceof g)0==this.leaves.length&&null!==this.nodes[0]&&(this.parent.root=this.nodes[0],this.parent.root.parent=this.parent);else if(!(this.leaves.length>=l)){var a=this.parent.nodes.indexOf(this),k=0<a?this.parent.nodes[a-1]:null,c=this.parent.nodes.length>a+1?this.parent.nodes[a+1]:null,e;if(null!==c&&c.leaves.length>l)e=this.parent.leaves[a],e.parent=this,this.leaves.push(e),e=c.leaves.shift(),e.parent=this.parent,this.parent.leaves[a]=
e,a=c.nodes.shift(),null!==a&&(a.parent=this),this.nodes.push(a);else if(null!==k&&k.leaves.length>l)e=this.parent.leaves[a-1],e.parent=this,this.leaves.unshift(e),e=k.leaves.pop(),e.parent=this.parent,this.parent.leaves[a-1]=e,a=k.nodes.pop(),null!==a&&(a.parent=this),this.nodes.unshift(a);else{if(null!==c)e=this.parent.leaves[a],k=new d(this.parent,b(this.leaves,[e],c.leaves),b(this.nodes,c.nodes)),this.parent.leaves.splice(a,1),this.parent.nodes.splice(a,2,k);else if(null!==k)e=this.parent.leaves[a-
1],k=new d(this.parent,b(k.leaves,[e],this.leaves),b(k.nodes,this.nodes)),this.parent.leaves.splice(a-1,1),this.parent.nodes.splice(a-1,2,k);else throw Error("Internal error: "+this.toString(!0)+" has neither a left nor a right sibling");this.parent.balance()}}};d.prototype.unsplit=function(a,b){a.parent=this;b.parent=this;if(0>e(a.key,this.leaves[0].key))this.leaves.unshift(a),this.nodes.splice(1,0,b);else{for(var c=1;c<this.leaves.length;c++)if(0>e(a.key,this.leaves[c].key)){this.leaves.splice(c,
0,a);this.nodes.splice(c+1,0,b);break}c==this.leaves.length&&(this.leaves.push(a),this.nodes.push(b))}this.leaves.length>f&&this.split()};d.prototype.split=function(){var a=Math.floor(this.leaves.length/2);if(this.parent instanceof g)this.nodes=[new d(this,this.leaves.slice(0,a),this.nodes.slice(0,a+1)),new d(this,this.leaves.slice(a+1),this.nodes.slice(a+1))],this.leaves=[this.leaves[a]];else{var b=this.leaves[a],c=new d(this.parent,this.leaves.slice(a+1),this.nodes.slice(a+1));this.leaves=this.leaves.slice(0,
a);this.nodes=this.nodes.slice(0,a+1);this.parent.unsplit(b,c)}};d.prototype.toString=function(a){for(var b=[],c=0;c<this.leaves.length;c++)b.push(this.leaves[c].key);b="["+b.toString()+"]"+(this.parent instanceof g?":*":":"+this.parent);if(a)for(c=0;c<this.nodes.length;c++)b+=" -> "+this.nodes[c];return b};d.prototype.print=function(a){for(var b="",c=0;c<a;c++)b+=" ";for(c=this.leaves.length-1;0<=c;c--)null!==this.nodes[c+1]&&this.nodes[c+1].print(a+2),console.log(b+this.leaves[c].key+(this.parent instanceof
g?"*":""));null!==this.nodes[0]&&this.nodes[0].print(a+2)};var c=function(a,b,c){this.parent=a;this.key=b;this.value=c};c.prototype.toString=function(){return""+this.key};g.prototype.put=function(a,b,c){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);if("undefined"===typeof b)throw Error("Illegal value: "+b);return this.root.put(a,b,c)};g.prototype.get=function(a){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);return this.root.get(a)};g.prototype.del=function(a){if("undefined"===
typeof a||null===a)throw Error("Illegal key: "+a);return this.root.del(a)};g.prototype.walkAsc=function(a,b,c){if(0!=this.root.leaves.length){"function"==typeof a?(c=a,a=b=null):"function"==typeof b&&(c=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var d;if(null===a){for(a=this.root;null!==a.nodes[0];)a=a.nodes[0];d=0}else if(d=this.root.search(a),d.leaf)a=d.leaf.parent,d=a.leaves.indexOf(d.leaf);else if(a=d.node,d=d.index,d>=a.leaves.length){if(a.parent instanceof g)return;
d=a.parent.nodes.indexOf(a);if(d>=a.parent.leaves.length)return;a=a.parent}for(;!(null!==b&&0<e(a.leaves[d].key,b)||c(a.leaves[d].key,a.leaves[d].value));)if(null!==a.nodes[d+1])for(a=a.nodes[d+1],d=0;null!==a.nodes[0];)a=a.nodes[0];else if(a.leaves.length>d+1)d++;else{do{if(a.parent instanceof g)return;d=a.parent.nodes.indexOf(a);a=a.parent}while(d>=a.leaves.length)}}};g.prototype.walk=g.prototype.walkAsc;g.prototype.walkDesc=function(a,b,c){"function"==typeof a?(c=a,a=b=null):"function"==typeof b&&
(c=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var d;if(null===b){for(b=this.root;null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];d=b.leaves.length-1}else if(d=this.root.search(b),d.leaf)b=d.leaf.parent,d=b.leaves.indexOf(d.leaf);else for(b=d.node,d=d.index-1;0>d;){if(b.parent instanceof g)return;d=b.parent.nodes.indexOf(b)-1;if(0>d)return;b=b.parent}for(;!(null!==a&&0>e(b.leaves[d].key,a)||c(b.leaves[d].key,b.leaves[d].value));)if(null!==b.nodes[d]){for(b=
b.nodes[d];null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];d=b.leaves.length-1}else if(0<d)d--;else{do{if(b.parent instanceof g)return;d=b.parent.nodes.indexOf(b)-1;b=b.parent}while(0>d)}};g.prototype.count=function(a,b){var c=0;this.walk("undefined"!=typeof a?a:null,"undefined"!=typeof b?b:null,function(a,b){c++});return c};g.prototype.print=function(){this.root.print(0)};g.prototype.toString=function(){return"Tree("+f+") "+this.root.toString()};return g}};return a}();n.exports=f},
{}],23:[function(f,n,l){function b(g){function f(a){null===k?n.push(a):e(function(){var b=k?a.onFulfilled:a.onRejected;if(null===b)(k?a.resolve:a.reject)(l);else{var c;try{c=b(l)}catch(d){a.reject(d);return}a.resolve(c)}})}function d(a){try{if(a===s)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"===typeof a||"function"===typeof a)){var b=a.then;if("function"===typeof b){p(b.bind(a),d,c);return}}k=!0;l=a;h()}catch(g){c(g)}}function c(a){k=!1;l=a;h()}function h(){for(var a=
0,b=n.length;a<b;a++)f(n[a]);n=null}if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");if("function"!==typeof g)throw new TypeError("not a function");var k=null,l=null,n=[],s=this;this.then=function(c,d){return new b(function(b,g){f(new a(c,d,b,g))})};p(g,d,c)}function a(a,b,d,c){this.onFulfilled="function"===typeof a?a:null;this.onRejected="function"===typeof b?b:null;this.resolve=d;this.reject=c}function p(a,b,d){var c=!1;try{a(function(a){c||(c=!0,b(a))},function(a){c||
(c=!0,d(a))})}catch(e){c||(c=!0,d(e))}}var e=f("asap");n.exports=b},{asap:25}],24:[function(f,n,l){function b(b){this.then=function(c){return"function"!==typeof c?this:new a(function(a,d){p(function(){try{a(c(b))}catch(g){d(g)}})})}}var a=f("./core.js"),p=f("asap");n.exports=a;b.prototype=Object.create(a.prototype);var e=new b(!0),g=new b(!1),q=new b(null),d=new b(void 0),c=new b(0),h=new b("");a.resolve=function(f){if(f instanceof a)return f;if(null===f)return q;if(void 0===f)return d;if(!0===f)return e;
if(!1===f)return g;if(0===f)return c;if(""===f)return h;if("object"===typeof f||"function"===typeof f)try{var l=f.then;if("function"===typeof l)return new a(l.bind(f))}catch(p){return new a(function(a,b){b(p)})}return new b(f)};a.from=a.cast=function(b){var c=Error("Promise.from and Promise.cast are deprecated, use Promise.resolve instead");c.name="Warning";console.warn(c.stack);return a.resolve(b)};a.denodeify=function(b,c){c=c||Infinity;return function(){var d=this,g=Array.prototype.slice.call(arguments);
return new a(function(a,e){for(;g.length&&g.length>c;)g.pop();g.push(function(b,c){b?e(b):a(c)});b.apply(d,g)})}};a.nodeify=function(b){return function(){var c=Array.prototype.slice.call(arguments),d="function"===typeof c[c.length-1]?c.pop():null;try{return b.apply(this,arguments).nodeify(d)}catch(g){if(null===d||"undefined"==typeof d)return new a(function(a,b){b(g)});p(function(){d(g)})}}};a.all=function(){var b=1===arguments.length&&Array.isArray(arguments[0]),c=Array.prototype.slice.call(b?arguments[0]:
arguments);b||(b=Error("Promise.all should be called with a single array, calling it with multiple arguments is deprecated"),b.name="Warning",console.warn(b.stack));return new a(function(a,b){function d(e,f){try{if(f&&("object"===typeof f||"function"===typeof f)){var h=f.then;if("function"===typeof h){h.call(f,function(a){d(e,a)},b);return}}c[e]=f;0===--g&&a(c)}catch(k){b(k)}}if(0===c.length)return a([]);for(var g=c.length,e=0;e<c.length;e++)d(e,c[e])})};a.reject=function(b){return new a(function(a,
c){c(b)})};a.race=function(b){return new a(function(c,d){b.forEach(function(b){a.resolve(b).then(c,d)})})};a.prototype.done=function(a,b){(arguments.length?this.then.apply(this,arguments):this).then(null,function(a){p(function(){throw a;})})};a.prototype.nodeify=function(a){if("function"!=typeof a)return this;this.then(function(b){p(function(){a(null,b)})},function(b){p(function(){a(b)})})};a.prototype["catch"]=function(a){return this.then(null,a)}},{"./core.js":23,asap:25}],25:[function(f,n,l){(function(b){function a(){for(;f.next;){f=
f.next;var b=f.task;f.task=void 0;var c=f.domain;c&&(f.domain=void 0,c.enter());try{b()}catch(e){if(d)throw c&&c.exit(),setTimeout(a,0),c&&c.enter(),e;setTimeout(function(){throw e;},0)}c&&c.exit()}g=!1}var f={task:void 0,next:null},e=f,g=!1,l=void 0,d=!1;if("undefined"!==typeof b&&b.nextTick)d=!0,l=function(){b.nextTick(a)};else if("function"===typeof setImmediate)l="undefined"!==typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!==typeof MessageChannel){var c=
new MessageChannel;c.port1.onmessage=a;l=function(){c.port2.postMessage(0)}}else l=function(){setTimeout(a,0)};n.exports=function(a){e=e.next={task:a,domain:d&&b.domain,next:null};g||(g=!0,l())}}).call(this,f("_process"))},{_process:31}],26:[function(f,n,l){(function(){function b(a){var b=this,c={db:null};if(a)for(var d in a)c[d]=a[d];return new s(function(a,d){var g=u.open(c.name,c.version);g.onerror=function(){d(g.error)};g.onupgradeneeded=function(){g.result.createObjectStore(c.storeName)};g.onsuccess=
function(){c.db=g.result;b._dbInfo=c;a()}})}function a(a,b){var c=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));var d=new s(function(b,d){c.ready().then(function(){var g=c._dbInfo,e=g.db.transaction(g.storeName,"readonly").objectStore(g.storeName).get(a);e.onsuccess=function(){var a=e.result;void 0===a&&(a=null);b(a)};e.onerror=function(){d(e.error)}})["catch"](d)});r(d,b);return d}function l(a,b){var c=this,d=new s(function(b,d){c.ready().then(function(){var g=
c._dbInfo,e=g.db.transaction(g.storeName,"readonly").objectStore(g.storeName).openCursor(),f=1;e.onsuccess=function(){var c=e.result;if(c){var d=a(c.value,c.key,f++);void 0!==d?b(d):c["continue"]()}else b()};e.onerror=function(){d(e.error)}})["catch"](d)});r(d,b);return d}function e(a,b,c){var d=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));var g=new s(function(c,g){d.ready().then(function(){var e=d._dbInfo,f=e.db.transaction(e.storeName,
"readwrite"),e=f.objectStore(e.storeName);null===b&&(b=void 0);var h=e.put(b,a);f.oncomplete=function(){void 0===b&&(b=null);c(b)};f.onabort=f.onerror=function(){g(h.error)}})["catch"](g)});r(g,c);return g}function g(a,b){var c=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));var d=new s(function(b,d){c.ready().then(function(){var g=c._dbInfo,e=g.db.transaction(g.storeName,"readwrite"),f=e.objectStore(g.storeName)["delete"](a);e.oncomplete=function(){b()};
e.onerror=function(){d(f.error)};e.onabort=function(a){a=a.target.error;"QuotaExceededError"===a&&d(a)}})["catch"](d)});r(d,b);return d}function q(a){var b=this,c=new s(function(a,c){b.ready().then(function(){var d=b._dbInfo,g=d.db.transaction(d.storeName,"readwrite"),e=g.objectStore(d.storeName).clear();g.oncomplete=function(){a()};g.onabort=g.onerror=function(){c(e.error)}})["catch"](c)});r(c,a);return c}function d(a){var b=this,c=new s(function(a,c){b.ready().then(function(){var d=b._dbInfo,g=
d.db.transaction(d.storeName,"readonly").objectStore(d.storeName).count();g.onsuccess=function(){a(g.result)};g.onerror=function(){c(g.error)}})["catch"](c)});k(c,a);return c}function c(a,b){var c=this,d=new s(function(b,d){0>a?b(null):c.ready().then(function(){var g=c._dbInfo,e=!1,f=g.db.transaction(g.storeName,"readonly").objectStore(g.storeName).openCursor();f.onsuccess=function(){var c=f.result;c?0===a?b(c.key):e?b(c.key):(e=!0,c.advance(a)):b(null)};f.onerror=function(){d(f.error)}})["catch"](d)});
k(d,b);return d}function h(a){var b=this,c=new s(function(a,c){b.ready().then(function(){var d=b._dbInfo,g=d.db.transaction(d.storeName,"readonly").objectStore(d.storeName).openCursor(),e=[];g.onsuccess=function(){var b=g.result;b?(e.push(b.key),b["continue"]()):a(e)};g.onerror=function(){c(g.error)}})["catch"](c)});k(c,a);return c}function k(a,b){b&&a.then(function(a){b(null,a)},function(a){b(a)})}function r(a,b){b&&a.then(function(a){y(b,a)},function(a){b(a)})}function y(a,b){if(a)return setTimeout(function(){return a(null,
b)},0)}var s="undefined"!==typeof n&&n.exports?f("promise"):this.Promise,u=u||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(u){var w={_driver:"asyncStorage",_initStorage:b,iterate:l,getItem:a,setItem:e,removeItem:g,clear:q,length:d,key:c,keys:h};"undefined"!==typeof n&&n.exports?n.exports=w:this.asyncStorage=w}}).call(window)},{promise:24}],27:[function(f,n,l){(function(){function b(a,b){b&&a.then(function(a){b(null,a)},function(a){b(a)})}var a="undefined"!==
typeof n&&n.exports?f("promise"):this.Promise,l=this,e=null,g=null;try{if(!(this.localStorage&&"setItem"in this.localStorage))return;g=this.localStorage}catch(q){return}var d=3;"undefined"!==typeof n&&n.exports&&(d=2);var c={_driver:"localStorageWrapper",_initStorage:function(b){var c={};if(b)for(var g in b)c[g]=b[g];c.keyPrefix=c.name+"/";this._dbInfo=c;return(new a(function(a){1===d?f(["localforageSerializer"],a):2===d?a(f("./../utils/serializer")):a(l.localforageSerializer)})).then(function(b){e=
b;return a.resolve()})},iterate:function(a,c){var d=this,f=d.ready().then(function(){for(var b=d._dbInfo.keyPrefix.length,c=g.length,f=0;f<c;f++){var k=g.key(f),l=g.getItem(k);l&&(l=e.deserialize(l));l=a(l,k.substring(b),f+1);if(void 0!==l)return l}});b(f,c);return f},getItem:function(a,c){var d=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));var f=d.ready().then(function(){var b=g.getItem(d._dbInfo.keyPrefix+a);b&&(b=e.deserialize(b));return b});
b(f,c);return f},setItem:function(c,d,f){var l=this;"string"!==typeof c&&(window.console.warn(c+" used as a key, but it is not a string."),c=String(c));var q=l.ready().then(function(){void 0===d&&(d=null);var b=d;return new a(function(a,f){e.serialize(d,function(d,e){if(e)f(e);else try{g.setItem(l._dbInfo.keyPrefix+c,d),a(b)}catch(k){"QuotaExceededError"!==k.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==k.name||f(k),f(k)}})})});b(q,f);return q},removeItem:function(a,c){var d=this;"string"!==typeof a&&(window.console.warn(a+
" used as a key, but it is not a string."),a=String(a));var e=d.ready().then(function(){g.removeItem(d._dbInfo.keyPrefix+a)});b(e,c);return e},clear:function(a){var c=this,d=c.ready().then(function(){for(var a=c._dbInfo.keyPrefix,b=g.length-1;0<=b;b--){var d=g.key(b);0===d.indexOf(a)&&g.removeItem(d)}});b(d,a);return d},length:function(a){var c=this.keys().then(function(a){return a.length});b(c,a);return c},key:function(a,c){var d=this,e=d.ready().then(function(){var b=d._dbInfo,c;try{c=g.key(a)}catch(e){c=
null}c&&(c=c.substring(b.keyPrefix.length));return c});b(e,c);return e},keys:function(a){var c=this,d=c.ready().then(function(){for(var a=c._dbInfo,b=g.length,d=[],e=0;e<b;e++)0===g.key(e).indexOf(a.keyPrefix)&&d.push(g.key(e).substring(a.keyPrefix.length));return d});b(d,a);return d}};2===d?n.exports=c:1===d?(void 0)("localStorageWrapper",function(){return c}):this.localStorageWrapper=c}).call(window)},{"./../utils/serializer":30,promise:24}],28:[function(f,n,l){(function(){function b(a){var b=this,
c={db:null};if(a)for(var d in a)c[d]="string"!==typeof a[d]?a[d].toString():a[d];d=new r(function(a){x===w.DEFINE?f(["localforageSerializer"],a):x===w.EXPORT?a(f("./../utils/serializer")):a(y.localforageSerializer)});var g=new r(function(d,g){try{c.db=u(c.name,String(c.version),c.description,c.size)}catch(e){return b.setDriver(b.LOCALSTORAGE).then(function(){return b._initStorage(a)}).then(d)["catch"](g)}c.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS "+c.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",
[],function(){b._dbInfo=c;d()},function(a,b){g(b)})})});return d.then(function(a){s=a;return g})}function a(a,b){var c=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));var d=new r(function(b,d){c.ready().then(function(){var g=c._dbInfo;g.db.transaction(function(c){c.executeSql("SELECT * FROM "+g.storeName+" WHERE key = ? LIMIT 1",[a],function(a,c){var d=c.rows.length?c.rows.item(0).value:null;d&&(d=s.deserialize(d));b(d)},function(a,b){d(b)})})})["catch"](d)});
k(d,b);return d}function l(a,b){var c=this,d=new r(function(b,d){c.ready().then(function(){var g=c._dbInfo;g.db.transaction(function(c){c.executeSql("SELECT * FROM "+g.storeName,[],function(c,d){for(var g=d.rows,e=g.length,f=0;f<e;f++){var h=g.item(f),k=h.value;k&&(k=s.deserialize(k));k=a(k,h.key,f+1);if(void 0!==k){b(k);return}}b()},function(a,b){d(b)})})})["catch"](d)});k(d,b);return d}function e(a,b,c){var d=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),
a=String(a));var g=new r(function(c,g){d.ready().then(function(){void 0===b&&(b=null);var e=b;s.serialize(b,function(b,f){if(f)g(f);else{var h=d._dbInfo;h.db.transaction(function(d){d.executeSql("INSERT OR REPLACE INTO "+h.storeName+" (key, value) VALUES (?, ?)",[a,b],function(){c(e)},function(a,b){g(b)})},function(a){a.code===a.QUOTA_ERR&&g(a)})}})})["catch"](g)});k(g,c);return g}function g(a,b){var c=this;"string"!==typeof a&&(window.console.warn(a+" used as a key, but it is not a string."),a=String(a));
var d=new r(function(b,d){c.ready().then(function(){var g=c._dbInfo;g.db.transaction(function(c){c.executeSql("DELETE FROM "+g.storeName+" WHERE key = ?",[a],function(){b()},function(a,b){d(b)})})})["catch"](d)});k(d,b);return d}function q(a){var b=this,c=new r(function(a,c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){b.executeSql("DELETE FROM "+d.storeName,[],function(){a()},function(a,b){c(b)})})})["catch"](c)});k(c,a);return c}function d(a){var b=this,c=new r(function(a,
c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){b.executeSql("SELECT COUNT(key) as c FROM "+d.storeName,[],function(b,c){var d=c.rows.item(0).c;a(d)},function(a,b){c(b)})})})["catch"](c)});k(c,a);return c}function c(a,b){var c=this,d=new r(function(b,d){c.ready().then(function(){var g=c._dbInfo;g.db.transaction(function(c){c.executeSql("SELECT key FROM "+g.storeName+" WHERE id = ? LIMIT 1",[a+1],function(a,c){var d=c.rows.length?c.rows.item(0).key:null;b(d)},function(a,b){d(b)})})})["catch"](d)});
k(d,b);return d}function h(a){var b=this,c=new r(function(a,c){b.ready().then(function(){var d=b._dbInfo;d.db.transaction(function(b){b.executeSql("SELECT key FROM "+d.storeName,[],function(b,c){for(var d=[],g=0;g<c.rows.length;g++)d.push(c.rows.item(g).key);a(d)},function(a,b){c(b)})})})["catch"](c)});k(c,a);return c}function k(a,b){b&&a.then(function(a){b(null,a)},function(a){b(a)})}var r="undefined"!==typeof n&&n.exports?f("promise"):this.Promise,y=this,s=null,u=this.openDatabase;if(u){var w={DEFINE:1,
EXPORT:2,WINDOW:3},x=w.WINDOW;"undefined"!==typeof n&&n.exports&&(x=w.EXPORT);var B={_driver:"webSQLStorage",_initStorage:b,iterate:l,getItem:a,setItem:e,removeItem:g,clear:q,length:d,key:c,keys:h};x===w.DEFINE?(void 0)("webSQLStorage",function(){return B}):x===w.EXPORT?n.exports=B:this.webSQLStorage=B}}).call(window)},{"./../utils/serializer":30,promise:24}],29:[function(f,n,l){(function(){function b(a,b){a[b]=function(){var c=arguments;return a.ready().then(function(){return a[b].apply(a,c)})}}
function a(){for(var a=1;a<arguments.length;a++){var b=arguments[a];if(b)for(var c in b)b.hasOwnProperty(c)&&(y(b[c])?arguments[0][c]=b[c].slice():arguments[0][c]=b[c])}return arguments[0]}function l(a){for(var b in d)if(d.hasOwnProperty(b)&&d[b]===a)return!0;return!1}function e(d){this._config=a({},h,d);this._driverSet=null;this._ready=!1;this._dbInfo=null;for(d=0;d<c.length;d++)b(this,c[d]);this.setDriver(this._config.driver)}var g="undefined"!==typeof n&&n.exports?f("promise"):this.Promise,q={},
d={INDEXEDDB:"asyncStorage",LOCALSTORAGE:"localStorageWrapper",WEBSQL:"webSQLStorage"},c="clear getItem iterate key keys length removeItem setItem".split(" "),h={description:"",driver:[d.INDEXEDDB,d.WEBSQL,d.LOCALSTORAGE].slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},k=3;"undefined"!==typeof n&&n.exports&&(k=2);var r=function(a){var b=b||a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.OIndexedDB||a.msIndexedDB,c={};c[d.WEBSQL]=!!a.openDatabase;c[d.INDEXEDDB]=!!function(){if("undefined"!==
typeof a.openDatabase&&a.navigator&&a.navigator.userAgent&&/Safari/.test(a.navigator.userAgent)&&!/Chrome/.test(a.navigator.userAgent))return!1;try{return b&&"function"===typeof b.open&&"undefined"!==typeof a.IDBKeyRange}catch(c){return!1}}();var g=d.LOCALSTORAGE,e;try{e=a.localStorage&&"setItem"in a.localStorage&&a.localStorage.setItem}catch(f){e=!1}c[g]=!!e;return c}(this),y=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},s=this;e.prototype.INDEXEDDB=d.INDEXEDDB;
e.prototype.LOCALSTORAGE=d.LOCALSTORAGE;e.prototype.WEBSQL=d.WEBSQL;e.prototype.config=function(a){if("object"===typeof a){if(this._ready)return Error("Can't call config() after localforage has been used.");for(var b in a)"storeName"===b&&(a[b]=a[b].replace(/\W/g,"_")),this._config[b]=a[b];"driver"in a&&a.driver&&this.setDriver(this._config.driver);return!0}return"string"===typeof a?this._config[a]:this._config};e.prototype.defineDriver=function(a,b,d){var e=new g(function(b,d){try{var e=a._driver,
f=Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver"),h=Error("Custom driver name already in use: "+a._driver);if(a._driver)if(l(a._driver))d(h);else{for(var k=c.concat("_initStorage"),h=0;h<k.length;h++){var n=k[h];if(!n||!a[n]||"function"!==typeof a[n]){d(f);return}}var s=g.resolve(!0);"_support"in a&&(s=a._support&&"function"===typeof a._support?a._support():g.resolve(!!a._support));s.then(function(c){r[e]=c;q[e]=a;b()},d)}else d(f)}catch(x){d(x)}});e.then(b,
d);return e};e.prototype.driver=function(){return this._driver||null};e.prototype.ready=function(a){var b=this,c=new g(function(a,c){b._driverSet.then(function(){null===b._ready&&(b._ready=b._initStorage(b._config));b._ready.then(a,c)})["catch"](c)});c.then(a,a);return c};e.prototype.setDriver=function(a,b,c){function d(){e._config.driver=e.driver()}var e=this;"string"===typeof a&&(a=[a]);this._driverSet=new g(function(b,c){var d=e._getFirstSupportedDriver(a),h=Error("No available storage method found.");
if(d){e._dbInfo=null;e._ready=null;if(l(d)){if(1===k){f([d],function(a){e._extend(a);b()});return}if(2===k){var n;switch(d){case e.INDEXEDDB:n=f("./drivers/indexeddb");break;case e.LOCALSTORAGE:n=f("./drivers/localstorage");break;case e.WEBSQL:n=f("./drivers/websql")}e._extend(n)}else e._extend(s[d])}else if(q[d])e._extend(q[d]);else{e._driverSet=g.reject(h);c(h);return}b()}else e._driverSet=g.reject(h),c(h)});this._driverSet.then(d,d);this._driverSet.then(b,c);return this._driverSet};e.prototype.supports=
function(a){return!!r[a]};e.prototype._extend=function(b){a(this,b)};e.prototype._getFirstSupportedDriver=function(a){if(a&&y(a))for(var b=0;b<a.length;b++){var c=a[b];if(this.supports(c))return c}return null};e.prototype.createInstance=function(a){return new e(a)};var u=new e;1===k?(void 0)("localforage",function(){return u}):2===k?n.exports=u:this.localforage=u}).call(window)},{"./drivers/indexeddb":26,"./drivers/localstorage":27,"./drivers/websql":28,promise:24}],30:[function(f,n,l){(function(){function b(a){var b=
0.75*a.length,d=a.length,c=0,e,k,l,n;"="===a[a.length-1]&&(b--,"="===a[a.length-2]&&b--);for(var s=new ArrayBuffer(b),u=new Uint8Array(s),b=0;b<d;b+=4)e=f.indexOf(a[b]),k=f.indexOf(a[b+1]),l=f.indexOf(a[b+2]),n=f.indexOf(a[b+3]),u[c++]=e<<2|k>>4,u[c++]=(k&15)<<4|l>>2,u[c++]=(l&3)<<6|n&63;return s}function a(a){a=new Uint8Array(a);var b="",d;for(d=0;d<a.length;d+=3)b+=f[a[d]>>2],b+=f[(a[d]&3)<<4|a[d+1]>>4],b+=f[(a[d+1]&15)<<2|a[d+2]>>6],b+=f[a[d+2]&63];2===a.length%3?b=b.substring(0,b.length-1)+"=":
1===a.length%3&&(b=b.substring(0,b.length-2)+"==");return b}var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e={serialize:function(b,e){var d="";b&&(d=b.toString());if(b&&("[object ArrayBuffer]"===b.toString()||b.buffer&&"[object ArrayBuffer]"===b.buffer.toString())){var c,f="__lfsc__:";b instanceof ArrayBuffer?(c=b,f+="arbf"):(c=b.buffer,"[object Int8Array]"===d?f+="si08":"[object Uint8Array]"===d?f+="ui08":"[object Uint8ClampedArray]"===d?f+="uic8":"[object Int16Array]"===
d?f+="si16":"[object Uint16Array]"===d?f+="ur16":"[object Int32Array]"===d?f+="si32":"[object Uint32Array]"===d?f+="ui32":"[object Float32Array]"===d?f+="fl32":"[object Float64Array]"===d?f+="fl64":e(Error("Failed to get type for BinaryArray")));e(f+a(c))}else if("[object Blob]"===d)d=new FileReader,d.onload=function(){var b=a(this.result);e("__lfsc__:blob"+b)},d.readAsArrayBuffer(b);else try{e(JSON.stringify(b))}catch(k){window.console.error("Couldn't convert value into a JSON string: ",b),e(null,
k)}},deserialize:function(a){if("__lfsc__:"!==a.substring(0,9))return JSON.parse(a);var e=a.substring(13);a=a.substring(9,13);e=b(e);switch(a){case "arbf":return e;case "blob":return new Blob([e]);case "si08":return new Int8Array(e);case "ui08":return new Uint8Array(e);case "uic8":return new Uint8ClampedArray(e);case "si16":return new Int16Array(e);case "ur16":return new Uint16Array(e);case "si32":return new Int32Array(e);case "ui32":return new Uint32Array(e);case "fl32":return new Float32Array(e);
case "fl64":return new Float64Array(e);default:throw Error("Unkown type: "+a);}},stringToBuffer:b,bufferToString:a};"undefined"!==typeof n&&n.exports?n.exports=e:this.localforageSerializer=e}).call(window)},{}],31:[function(f,n,l){function b(){}f=n.exports={};f.nextTick=function(){if("undefined"!==typeof window&&window.setImmediate)return function(a){return window.setImmediate(a)};if("undefined"!==typeof window&&window.postMessage&&window.addEventListener){var a=[];window.addEventListener("message",
function(b){var e=b.source;e!==window&&null!==e||"process-tick"!==b.data||(b.stopPropagation(),0<a.length&&a.shift()())},!0);return function(b){a.push(b);window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}();f.title="browser";f.browser=!0;f.env={};f.argv=[];f.on=b;f.addListener=b;f.once=b;f.off=b;f.removeListener=b;f.removeAllListeners=b;f.emit=b;f.binding=function(a){throw Error("process.binding is not supported");};f.cwd=function(){return"/"};f.chdir=function(a){throw Error("process.chdir is not supported");
}},{}]},{},[1])(1)});
