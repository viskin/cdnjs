!function(x){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=x();else if("function"==typeof define&&define.amd)define([],x);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.ForerunnerDB=x()}}(function(){return function k(p,m,f){function a(b,d){if(!m[b]){if(!p[b]){var g="function"==typeof require&&require;if(!d&&g)return g(b,!0);if(e)return e(b,!0);g=Error("Cannot find module '"+b+"'");throw g.code="MODULE_NOT_FOUND",
g;}g=m[b]={exports:{}};p[b][0].call(g.exports,function(c){var h=p[b][1][c];return a(h?h:c)},g,g.exports,k,p,m,f)}return m[b].exports}for(var e="function"==typeof require&&require,d=0;d<f.length;d++)a(f[d]);return a}({1:[function(k,p,m){m=k("../lib/Core");k("../lib/View");p.exports=m},{"../lib/Core":3,"../lib/View":12}],2:[function(k,p,m){var f,a,e,d,b,l;f=k("./Shared");var g=function(c){this.init.apply(this,arguments)};g.prototype.init=function(c){this._primaryKey="_id";this._primaryIndex=new e("primary");
this._primaryCrc=new e("primaryCrc");this._crcLookup=new e("crcLookup");this._name=c;this._data=[];this._groups=[];this._metrics=new a;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};f.modules.Collection=g;m=k("./Overload");a=k("./Metrics");e=k("./KeyValueStore");d=k("./Path");b=k("./Index");l=k("./Crc");k=f.modules.Core;
g.prototype.debug=new m([function(){return this._debug.all},function(c){if(void 0!==c){if("boolean"===typeof c){this._debug.all=c;for(var h=0;h<this._views.length;h++)this._views[h].debug(c);return this}return this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]||this._debug.all}return this._debug.all},function(c,h){if(void 0!==c){if(void 0!==h){this._debug[c]=h;for(var r=0;r<this._views.length;r++)this._views[r].debug(c,h);return this}return this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]}return this._debug.all}]);
g.prototype.crc=l;g.prototype.name=function(c){return void 0!==c?(this._name=c,this):this._name};g.prototype.on=new m([function(c,h){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c]["*"]=this._listeners[c]["*"]||[];this._listeners[c]["*"].push(h);return this},function(c,h,r){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c][h]=this._listeners[c][h]||[];this._listeners[c][h].push(r);return this}]);g.prototype.off=
new m([function(c){this._listeners&&this._listeners[c]&&c in this._listeners&&delete this._listeners[c];return this},function(c,h){var r,b;"string"===typeof h?this._listeners&&this._listeners[c]&&this._listeners[c][h]&&delete this._listeners[c][h]:c in this._listeners&&(r=this._listeners[c]["*"],b=r.indexOf(h),-1<b&&r.splice(b,1));return this},function(c,h,r){this._listeners&&c in this._listeners&&(c=this._listeners[c][h],r=c.indexOf(r),-1<r&&c.splice(r,1))}]);g.prototype.emit=function(c,h){this._listeners=
this._listeners||{};if(c in this._listeners){if(this._listeners[c]["*"]){var r=this._listeners[c]["*"],b=r.length,a;for(a=0;a<b;a++)r[a].apply(this,Array.prototype.slice.call(arguments,1))}if(h instanceof Array&&h[0]&&h[0][this._primaryKey]){var r=this._listeners[c],d,g,b=h.length;for(a=0;a<b;a++)if(r[h[a][this._primaryKey]])for(d=r[h[a][this._primaryKey]].length,g=0;g<d;g++)r[h[a][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this};g.prototype.drop=function(){if(this._db&&
this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var c=[],h;for(h=0;h<this._groups.length;h++)c.push(this._groups[h]);for(h=0;h<c.length;h++)this._groups[h].removeCollection(this);return!0}return!1};g.prototype.primaryKey=function(c){return void 0!==c?(this._primaryKey=c,this._primaryIndex.primaryKey(c),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};g.prototype._onInsert=function(c,h){this.emit("insert",c,h)};
g.prototype._onUpdate=function(c){this.emit("update",c)};g.prototype._onRemove=function(c){this.emit("remove",c)};g.prototype.db=function(c){return void 0!==c?(this._db=c,this):this._db};g.prototype.setData=function(c,h,b){if(c){var a=this._metrics.create("setData");a.start();c instanceof Array||(c=[c]);a.time("transformIn");c=this.transformIn(c);a.time("transformIn");var d=this._data;this._data=[];c.length&&(this._data=this._data.concat(c));a.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(h);
a.time("_rebuildPrimaryKeyIndex");a.stop();this.emit("setData",this._data,d)}b&&b(!1);return this};g.prototype._rebuildPrimaryKeyIndex=function(c){var h=c&&void 0!==c.ensureKeys?c.ensureKeys:!0;c=c&&void 0!==c.violationCheck?c.violationCheck:!0;var b,a,d,g=this._primaryIndex,e=this._primaryCrc,f=this._crcLookup,l=this._primaryKey,k;g.truncate();e.truncate();f.truncate();b=this._data;for(a=b.length;a--;)if(d=b[a],h&&this._ensurePrimaryKey(d),c){if(!g.uniqueSet(d[l],d))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+
d[this._primaryKey];}else k=JSON.stringify(d),g.set(d[l],d),e.set(d[l],k),f.set(k,d)};g.prototype._ensurePrimaryKey=function(c){void 0===c[this._primaryKey]&&(c[this._primaryKey]=this.objectId())};g.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};g.prototype.upsert=function(c,h){if(c){var b=this._deferQueue.upsert,a=this._deferThreshold.upsert,d={},g;if(c instanceof Array){if(c.length>a){this._deferQueue.upsert=b.concat(c);this.processQueue("upsert",
h);return}d=[];for(b=0;b<c.length;b++)d.push(this.upsert(c[b]));h&&h();return d}c[this._primaryKey]?(g={},g[this._primaryKey]=c[this._primaryKey],this.count(g)?d.op="update":d.op="insert"):d.op="insert";switch(d.op){case "insert":d.result=this.insert(c);break;case "update":d.result=this.update(g,c)}return d}h&&h()};g.prototype.update=function(c,h,b){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var d=this,a=this._metrics.create("update"),
g=this._primaryKey,e,f,l=function(a){if(h&&void 0!==h[g]&&h[g]!=a[g]){d._primaryIndex.unSet(a[g]);var e=d._updateObject(a,h,c,b,"");if(d._primaryIndex.uniqueSet(a[g],a))return e;throw"Primary key violation in update! Key violated: "+a[g];}return d._updateObject(a,h,c,b,"")},k=this._views;a.start();a.time("Retrieve documents to update");e=this.find(c,{decouple:!1});a.time("Retrieve documents to update");if(e.length&&(a.time("Update documents"),f=e.filter(l),a.time("Update documents"),f.length)){if(k&&
k.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());a.time("Inform views of update");for(e=0;e<k.length;e++)k[e].update(c,h);a.time("Inform views of update")}this._onUpdate(f);this.deferEmit("change",{type:"update",data:f})}a.stop();return f||[]};g.prototype.updateById=function(c,h){var b={};b[this._primaryKey]=c;return this.update(b,h)};g.prototype._updateObject=function(c,h,b,a,g,e){h=this.decouple(h);g=g||"";"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));
var f=!1,l=!1,k,m,q,n;for(n in h)if(h.hasOwnProperty(n)){k=!1;if("$"===n.substr(0,1))switch(n){case "$index":break;default:k=!0,(l=this._updateObject(c,h[n],b,a,g,n))&&(f=!0)}if(this._isPositionalKey(n)&&(k=!0,n=n.substr(0,n.length-2),l=new d(g+"."+n),c[n]&&c[n]instanceof Array&&c[n].length)){m=[];for(q=0;q<c[n].length;q++)this._match(c[n][q],l.value(b)[0])&&m.push(q);for(q=0;q<m.length;q++)(l=this._updateObject(c[n][m[q]],h[n+".$"],b,a,g+"."+n,e))&&(f=!0)}if(!k)if(e||"object"!==typeof h[n])switch(e){case "$inc":this._updateIncrement(c,
n,h[n]);f=!0;break;case "$push":void 0===c[n]&&(c[n]=[]);if(c[n]instanceof Array)this._updatePush(c[n],h[n]),f=!0;else throw"Cannot push to a key that is not an array! ("+n+")!";break;case "$pull":if(c[n]instanceof Array){m=[];for(q=0;q<c[n].length;q++)this._match(c[n][q],h[n])&&m.push(q);for(q=m.length;q--;)this._updatePull(c[n],m[q]),f=!0}else throw"Cannot pull from a key that is not an array! ("+n+")!";break;case "$addToSet":void 0===c[n]&&(c[n]=[]);if(c[n]instanceof Array){m=c[n];var p;q=m.length;
var u;k=!0;p=a&&a.$addToSet;var s;p&&p.key?(l=!1,s=new d(p.key),u=s.value(h[n])[0]):(u=JSON.stringify(h[n]),l=!0);for(p=0;p<q;p++)if(l){if(JSON.stringify(m[p])===u){k=!1;break}}else if(u===s.value(m[p])[0]){k=!1;break}k&&(this._updatePush(c[n],h[n]),f=!0)}else throw"Cannot push to a key that is not an array! (undefined)!";break;case "$splicePush":void 0===c[n]&&(c[n]=[]);if(c[n]instanceof Array)if(f=h.$index,void 0!==f)delete h.$index,this._updateSplicePush(c[n],f,h[n]),f=!0;else throw"Cannot splicePush without a $index integer value!";
else throw"Cannot splicePush with a key that is not an array! ("+n+")!";break;case "$move":if(c[n]instanceof Array)for(q=0;q<c[n].length;q++){if(this._match(c[n][q],h[n])){f=h[n].$index;if(void 0!==f)this._updateSpliceMove(c[n],q,f),f=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+n+")!";break;default:c[n]!==h[n]&&(this._updateProperty(c,n,h[n]),f=!0)}else if(null!==c[n]&&"object"===typeof c[n])if(m=c[n]instanceof Array,
q=h[n]instanceof Array,m||q)if(!q&&m)for(q=0;q<c[n].length;q++)(l=this._updateObject(c[n][q],h[n],b,a,g+"."+n,e))&&(f=!0);else c[n]!==h[n]&&(this._updateProperty(c,n,h[n]),f=!0);else(l=this._updateObject(c[n],h[n],b,a,g+"."+n,e))&&(f=!0);else c[n]!==h[n]&&(this._updateProperty(c,n,h[n]),f=!0)}return f};g.prototype._isPositionalKey=function(c){return".$"===c.substr(c.length-2,2)};g.prototype._updateProperty=function(c,h,b){this._linked?($.observable(c).setProperty(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+
h+'" for collection "'+this.name()+'"')):(c[h]=b,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+h+'" for collection "'+this.name()+'"'))};g.prototype._updateIncrement=function(c,h,b){this._linked?$.observable(c).setProperty(h,c[h]+b):c[h]+=b};g.prototype._updateSpliceMove=function(c,h,b){this._linked?($.observable(c).move(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+h+'" to "'+b+'" for collection "'+
this.name()+'"')):(c.splice(b,0,c.splice(h,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+h+'" to "'+b+'" for collection "'+this.name()+'"'))};g.prototype._updateSplicePush=function(c,h,b){c.length>h?this._linked?$.observable(c).insert(h,b):c.splice(h,0,b):this._linked?$.observable(c).insert(b):c.push(b)};g.prototype._updatePush=function(c,h){this._linked?$.observable(c).insert(h):c.push(h)};g.prototype._updatePull=function(c,h){this._linked?
$.observable(c).remove(h):c.splice(h,1)};g.prototype.remove=function(c){var h,b,a=this._views,d;if(c instanceof Array){a=[];for(h=0;h<c.length;h++)a.push(this.remove(c[h]));return a}h=this.find(c,{decouple:!1});if(h.length){for(d=0;d<h.length;d++)b=h[d],this._removeIndex(b),b=this._data.indexOf(b),this._linked?$.observable(this._data).remove(b):this._data.splice(b,1);if(a&&a.length)for(d=0;d<a.length;d++)a[d].remove(c);this._onRemove(h);this.deferEmit("change",{type:"remove",data:h})}return h};g.prototype.removeById=
function(c){var h={};h[this._primaryKey]=c;return this.remove(h)};g.prototype.deferEmit=function(){var c=this,h;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){c.debug()&&console.log("ForerunnerDB.Collection: Emitting "+h[0]);c.emit.apply(c,h)},100))};g.prototype.processQueue=function(c,h){var b=this._deferQueue[c],a=this._deferThreshold[c],
d=this._deferTime[c];if(b.length){var g=this;b.length&&(b=b.length>a?b.splice(0,a):b.splice(0,b.length),this[c](b));setTimeout(function(){g.processQueue(c,h)},d)}else h&&h()};g.prototype.insert=function(c,h,b){"function"===typeof h?(b=h,h=this._data.length):void 0===h&&(h=this._data.length);c=this.transformIn(c);return this._insertHandle(c,h,b)};g.prototype._insertHandle=function(c,h,b){var a=this._deferQueue.insert,d=this._deferThreshold.insert,g=[],f=[],e=this._views;if(c instanceof Array){if(c.length>
d){this._deferQueue.insert=a.concat(c);this.processQueue("insert",b);return}for(d=0;d<c.length;d++)a=this._insert(c[d],h+d),!0===a?g.push(c[d]):f.push({doc:c[d],reason:a})}else a=this._insert(c,h),!0===a?g.push(c):f.push({doc:c,reason:a});if(e&&e.length)for(a=0;a<e.length;a++)e[a].insert(c,h);this._onInsert(g,f);b&&b();this.deferEmit("change",{type:"insert",data:g});return{inserted:g,failed:f}};g.prototype._insert=function(c,h){if(c){var b;this._ensurePrimaryKey(c);if(b=this.insertIndexViolation(c))return"Index violation in index: "+
b;this._insertIndex(c);this._linked?$.observable(this._data).insert(h,c):this._data.splice(h,0,c);return!0}return"No document passed to insert"};g.prototype._insertIndex=function(c){var h=this._indexByName,b,a=JSON.stringify(c);this._primaryIndex.uniqueSet(c[this._primaryKey],c);this._primaryCrc.uniqueSet(c[this._primaryKey],a);this._crcLookup.uniqueSet(a,c);for(b in h)h.hasOwnProperty(b)&&h[b].insert(c)};g.prototype._removeIndex=function(c){var h=this._indexByName,b,a=JSON.stringify(c);this._primaryIndex.unSet(c[this._primaryKey]);
this._primaryCrc.unSet(c[this._primaryKey]);this._crcLookup.unSet(a);for(b in h)h.hasOwnProperty(b)&&h[b].remove(c)};g.prototype.subset=function(c,b){var a=this.find(c,b);return(new g)._subsetOf(this).primaryKey(this._primaryKey).setData(a)};g.prototype.subsetOf=function(){return this.__subsetOf};g.prototype._subsetOf=function(c){this.__subsetOf=c;return this};g.prototype.distinct=function(c,b,a){b=this.find(b,a);c=new d(c);a={};var g=[],f,e;for(e=0;e<b.length;e++)(f=c.value(b[e])[0])&&!a[f]&&(a[f]=
!0,g.push(f));return g};g.prototype.decouple=function(c){return JSON.parse(JSON.stringify(c))};g.prototype.findById=function(c,b){var a={};a[this._primaryKey]=c;return this.find(a,b)[0]};g.prototype.peek=function(c,b){var a=this._data,d=a.length,f,e,l=new g;if("string"===typeof c){for(f=0;f<d;f++)e=JSON.stringify(a[f]),-1<e.indexOf(c)&&l.insert(a[f]);return l.find({},b)}return this.find(c,b)};g.prototype.explain=function(c,b){return this.find(c,b).__fdbOp._data};g.prototype.find=function(c,b){c=c||
{};b=b||{};b.decouple=void 0!==b.decouple?b.decouple:!0;var a=this._metrics.create("find"),g=this,f,e=!0,l,k,m,p,q,n,v,u,s,w=[];k=function(b){return g._match(b,c,"and")};a.start();if(c){a.time("analyseQuery");f=this._analyseQuery(c,b,a);a.time("analyseQuery");a.data("analysis",f);if(f.hasJoin&&f.queriesJoin){a.time("joinReferences");for(m=0;m<f.joinsOn.length;m++)q=f.joinsOn[m],p=new d(f.joinQueries[q]),p=p.value(c)[0],this._db.collection(f.joinsOn[m]).subset(p);a.time("joinReferences")}f.indexMatch.length&&
(!b||b&&!b.skipIndex)?(a.data("index.potential",f.indexMatch),a.data("index.used",f.indexMatch[0].index),a.time("indexLookup"),l=f.indexMatch[0].lookup,a.time("indexLookup"),f.indexMatch[0].keyData.totalKeyCount===f.indexMatch[0].keyData.matchedKeyCount&&(e=!1)):a.flag("usedIndex",!1);e&&(l&&l.length?(f=l.length,a.time("tableScan: "+f),l=l.filter(k)):(f=this._data.length,a.time("tableScan: "+f),l=this._data.filter(k)),b.sort&&(a.time("sort"),l=this.sort(b.sort,l),a.time("sort")),a.time("tableScan: "+
f));b.limit&&l&&l.length>b.limit&&(l.length=b.limit,a.data("limit",b.limit));b.decouple&&(a.time("decouple"),l=this.decouple(l),a.time("decouple"),a.data("flag.decouple",!0));if(b.join){for(k=0;k<b.join.length;k++)for(q in b.join[k])if(b.join[k].hasOwnProperty(q))for(u=q,f=this._db.collection(q),e=b.join[k][q],s=0;s<l.length;s++){v={};p=m=!1;for(n in e)if(e.hasOwnProperty(n))if("$"===n.substr(0,1))switch(n){case "$as":u=e[n];break;case "$multi":m=e[n];break;case "$require":p=e[n];break;default:n.substr(0,
3)}else v[n]=(new d(e[n])).value(l[s])[0];v=f.find(v);!p||p&&v[0]?l[s][u]=!1===m?v[0]:v:w.push(l[s])}a.data("flag.join",!0)}if(w.length){a.time("removalQueue");for(n=0;n<w.length;n++)q=l.indexOf(w[n]),-1<q&&l.splice(q,1);a.time("removalQueue")}if(b.transform){a.time("transform");for(n=0;n<l.length;n++)l.splice(n,1,b.transform(l[n]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),l=this.transformOut(l),a.time("transformOut"));a.data("results",
l.length);a.stop()}else a.stop(),l=[];l.__fdbOp=a;return l};g.prototype.transform=function(c){return void 0!==c?("object"===typeof c?(void 0!==c.enabled&&(this._transformEnabled=c.enabled),void 0!==c.dataIn&&(this._transformIn=c.dataIn),void 0!==c.dataOut&&(this._transformOut=c.dataOut)):this._transformEnabled=!1===c?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};g.prototype.transformIn=function(c){if(this._transformEnabled&&this._transformIn){if(c instanceof
Array){var b=[],a;for(a=0;a<c.length;a++)b[a]=this._transformIn(c[a]);return b}return this._transformIn(c)}return c};g.prototype.transformOut=function(c){if(this._transformEnabled&&this._transformOut){if(c instanceof Array){var b=[],a;for(a=0;a<c.length;a++)b[a]=this._transformOut(c[a]);return b}return this._transformOut(c)}return c};g.prototype.sort=function(c,b){b=b||[];var a=[],d,g;for(d in c)c.hasOwnProperty(d)&&(g={},g[d]=c[d],g.___fdbKey=d,a.push(g));return 2>a.length?this._sort(c,b):this._bucketSort(a,
b)};g.prototype._bucketSort=function(c,b){var a=c.shift(),d,g,f=[];if(0<c.length){b=this._sort(a,b);d=this.bucket(a.___fdbKey,b);for(g in d)d.hasOwnProperty(g)&&(a=[].concat(c),f=f.concat(this._bucketSort(a,d[g])));return f}return this._sort(a,b)};g.prototype._sort=function(c,b){var a=new d,g=a.parse(c,!0)[0];a.path(g.path);return b.sort(1===g.value?function(c,b){var h=a.value(c)[0],d=a.value(b)[0];return"string"===typeof h&&"string"===typeof d?h.localeCompare(d):h>d?1:h<d?-1:0}:function(c,b){var h=
a.value(c)[0],d=a.value(b)[0];return"string"===typeof h&&"string"===typeof d?1===h.localeCompare(d)?-1:1:h>d?-1:h<d?1:0})};g.prototype.bucket=function(c,b){var a,d={};for(a=0;a<b.length;a++)d[b[a][c]]=d[b[a][c]]||[],d[b[a][c]].push(b[a]);return d};g.prototype._analyseQuery=function(c,b,a){var g={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:c,options:b},f,e=[],l=[],k,m,p,q,n;a.time("checkIndexes");void 0!==c[this._primaryKey]&&(a.time("checkIndexMatch: Primary Key"),
k=new d,g.indexMatch.push({lookup:this._primaryIndex.lookup(c,b),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:k.countKeys(c)},index:this._primaryIndex}),a.time("checkIndexMatch: Primary Key"));for(n in this._indexById)if(this._indexById.hasOwnProperty(n)&&(m=this._indexById[n],p=m.name(),a.time("checkIndexMatch: "+p),k=m.match(c,b),q=m.lookup(c,b),0<k.matchedKeyCount&&g.indexMatch.push({lookup:q,keyData:k,index:m}),a.time("checkIndexMatch: "+p),k.totalKeyCount===k.matchedKeyCount))break;
a.time("checkIndexes");1<g.indexMatch.length&&(a.time("findOptimalIndex"),g.indexMatch.sort(function(c,b){return c.keyData.totalKeyCount===c.keyData.matchedKeyCount?-1:b.keyData.totalKeyCount===b.keyData.matchedKeyCount?1:c.keyData.matchedKeyCount===b.keyData.matchedKeyCount?c.lookup.length-b.lookup.length:b.keyData.matchedKeyCount-c.keyData.matchedKeyCount}),a.time("findOptimalIndex"));if(b.join){g.hasJoin=!0;for(a=0;a<b.join.length;a++)for(f in b.join[a])b.join[a].hasOwnProperty(f)&&(e.push(f),
"$as"in b.join[a][f]?l.push(b.join[a][f].$as):l.push(f));for(f=0;f<l.length;f++)if(b=this._queryReferencesCollection(c,l[f],""))g.joinQueries[e[f]]=b,g.queriesJoin=!0;g.joinsOn=e;g.queriesOn=g.queriesOn.concat(e)}return g};g.prototype._queryReferencesCollection=function(c,b,a){for(var d in c)if(c.hasOwnProperty(d)){if(d===b)return a&&(a+="."),a+d;if("object"===typeof c[d])return a&&(a+="."),a+=d,this._queryReferencesCollection(c[d],b,a)}return!1};g.prototype._match=function(c,b,a){var d,g;d=typeof c;
g=typeof b;var f=!0,e;if(!("string"!==d&&"number"!==d||"string"!==g&&"number"!==g))c!==b&&(f=!1);else for(e in b)if(b.hasOwnProperty(e)){d=!1;if("$"===e.substr(0,1))switch(e){case "$gt":if(c>b[e]){if("or"===a)return!0}else f=!1;d=!0;break;case "$gte":if(c>=b[e]){if("or"===a)return!0}else f=!1;d=!0;break;case "$lt":if(c<b[e]){if("or"===a)return!0}else f=!1;d=!0;break;case "$lte":if(c<=b[e]){if("or"===a)return!0}else f=!1;d=!0;break;case "$exists":if(void 0===c!==b[e]){if("or"===a)return!0}else f=!1;
d=!0;break;case "$or":d=!0;for(g=0;g<b[e].length;g++){if(this._match(c,b[e][g],"and"))return!0;f=!1}break;case "$and":d=!0;for(g=0;g<b[e].length;g++)if(!this._match(c,b[e][g],"and"))return!1;break;case "$in":if(b[e]instanceof Array){d=b[e];g=d.length;var l,k=!1;for(l=0;l<g;l++)if(d[l]===c){k=!0;break}if(k){if("or"===a)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+e;d=!0;break;case "$nin":if(b[e]instanceof Array){d=b[e];g=d.length;k=!0;for(l=0;l<g;l++)if(d[l]===c){k=
!1;break}if(k){if("or"===a)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+e;d=!0;break;case "$ne":if(c!=b[e]){if("or"===a)return!0}else f=!1;d=!0}if(!d&&b[e]instanceof RegExp)if(d=!0,"object"===typeof c&&void 0!==c[e]&&b[e].test(c[e])){if("or"===a)return!0}else f=!1;if(!d)if("object"===typeof b[e])if(void 0!==c[e]){if(c[e]instanceof Array&&!(b[e]instanceof Array))for(d=!1,g=0;g<c[e].length&&!(d=this._match(c[e][g],b[e],void 0));g++);else if(!(c[e]instanceof Array)&&
b[e]instanceof Array)for(d=!1,g=0;g<b[e].length&&!(d=this._match(c[e],b[e][g],void 0));g++);else d="object"===typeof c?this._match(c[e],b[e],void 0):this._match(void 0,b[e],void 0);if(d){if("or"===a)return!0}else f=!1}else if(b[e]&&void 0!==b[e].$exists)if(d=this._match(void 0,b[e],void 0)){if("or"===a)return!0}else f=!1;else f=!1;else if(c&&c[e]===b[e]){if("or"===a)return!0}else if(c&&c[e]&&c[e]instanceof Array&&b[e]&&"object"!==typeof b[e]){d=!1;for(g=0;g<c[e].length&&!(d=this._match(c[e][g],b[e],
void 0));g++);if(d){if("or"===a)return!0}else f=!1}else f=!1;if("and"===a&&!f)return!1}return f};g.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};g.prototype.link=function(b,a){this._links=this._links||{};if(!this._links[a]){if($(b).length){if(!$.templates[a]){var d=$(a);if(d.length)$.views.templates(a,$(d[0]).html());else throw"Unable to bind collection to target because template does not exist: "+a;}$.templates[a].link(b,this._data);this._links[a]=b;this._linked++;
this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+a;};g.prototype.unlink=function(b,a){this._links=this._links||{};if(this._links[a])return $.templates[a].unlink(b),delete this._links[a],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+
this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)};g.prototype.findSub=function(b,a,g,e){var f=new d(a);b=this.find(b);var l=b.length,k,m,p=this._db.collection("__FDB_temp_"+this.objectId()),t={parents:l,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(k=0;k<l;k++)if(m=f.value(b[k])[0]){p.setData(m);m=p.find(g,e);if(e.returnFirst&&m.length)return m[0];t.subDocs.push(m);t.subDocTotal+=m.length;t.pathFound=!0}p.drop();
if(e.noStats)return t.subDocs;t.pathFound||(t.err="No objects found in the parent documents with a matching path of: "+a);return t};g.prototype.insertIndexViolation=function(b){var a,d=this._indexByName,g,e;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(g in d)if(d.hasOwnProperty(g)&&(e=d[g],e.unique()&&e.violation(b))){a=e;break}return a?a.name():!1};g.prototype.ensureIndex=function(a,d){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var g=
new b(a,d,this),e={start:(new Date).getTime()};if(this._indexByName[g.name()])return{err:"Index with that name already exists"};if(this._indexById[g.id()])return{err:"Index with those keys already exists"};g.rebuild();this._indexByName[g.name()]=g;this._indexById[g.id()]=g;e.end=(new Date).getTime();e.total=e.end-e.start;this._lastOp={type:"ensureIndex",stats:{time:e}};return{index:g,id:g.id(),name:g.name(),state:g.state()}};g.prototype.index=function(b){if(this._indexByName)return this._indexByName[b]};
g.prototype.lastOp=function(){return this._metrics.list()};g.prototype.objectId=function(b){var a=Math.pow(10,17);if(b){var d=0,g=b.length,e;for(e=0;e<g;e++)d+=b.charCodeAt(e)*a;b=d.toString(16)}else f.idCounter++,b=(f.idCounter+(Math.random()*a+Math.random()*a+Math.random()*a+Math.random()*a)).toString(16);return b};g.prototype.diff=function(b){var a={insert:[],update:[],remove:[]},d=this.primaryKey(),g,e,f,l;if(d===b.primaryKey()){g=b._data;l=g.length;for(e=0;e<l;e++)f=g[e],this._primaryIndex.get(f[d])?
this._primaryCrc.get(f[d])!==b._primaryCrc.get(f[d])&&a.update.push(f):a.insert.push(f);g=this._data;l=g.length;for(e=0;e<l;e++)f=g[e],b._primaryIndex.get(f[d])||a.remove.push(f)}return a};k.prototype.collection=function(b,a){if(b)return this._collection[b]||this.debug()&&console.log("Creating collection "+b),this._collection[b]=this._collection[b]||(new g(b)).db(this),void 0!==a&&this._collection[b].primaryKey(a),this._collection[b];throw"Cannot get collection with undefined name!";};k.prototype.collectionExists=
function(b){return Boolean(this._collection[b])};k.prototype.collections=function(){var b=[],a;for(a in this._collection)this._collection.hasOwnProperty(a)&&b.push({name:a,count:this._collection[a].count()});return b};p.exports=g},{"./Crc":4,"./Index":5,"./KeyValueStore":6,"./Metrics":7,"./Overload":9,"./Path":10,"./Shared":11}],3:[function(k,p,m){var f,a;f=k("./Shared.js");var e=function(){this.init.apply(this,arguments)};e.prototype.init=function(){this._collection={};this._debug={}};f.modules.Core=
e;m=k("./Overload.js");a=k("./Collection.js");k("./Metrics.js");k=k("./Crc.js");e.prototype._isServer=!1;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.crc=k;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};e.prototype.debug=new m([function(){return this._debug.all},function(a){return void 0!==
a&&"boolean"===typeof a?(this._debug.all=a,this):this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug[a]=b,this):this._debug[a]:this._debug.all}]);e.prototype.arrayToCollection=function(d){return(new a).setData(d)};e.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(b);return this};e.prototype.off=function(a,b){if(a in this._listeners){var e=this._listeners[a],g=e.indexOf(b);-1<g&&e.splice(g,1)}return this};
e.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var e=this._listeners[a],g=e.length,c;for(c=0;c<g;c++)e[c].apply(this,Array.prototype.slice.call(arguments,1))}return this};e.prototype.objectId=function(a){var b,e,g=Math.pow(10,17),c;if(a){b=0;e=a.length;for(c=0;c<e;c++)b+=a.charCodeAt(c)*g;a=b.toString(16)}else f.idCounter++,a=(f.idCounter+(Math.random()*g+Math.random()*g+Math.random()*g+Math.random()*g)).toString(16);return a};e.prototype.peek=function(a){var b,
e,g=[],c=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(e=this._collection[b],g="string"===c?g.concat(e.peek(a)):g.concat(e.find(a)));return g};e.prototype.peekCat=function(a){var b,e,g={},c,f=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(e=this._collection[b],(c="string"===f?e.peek(a):e.find(a))&&c.length&&(g[e.name()]=c));return g};p.exports=e},{"./Collection.js":2,"./Crc.js":4,"./Metrics.js":7,"./Overload.js":9,"./Shared.js":11}],4:[function(k,
p,m){var f=function(){var a=[],e,d,b;for(d=0;256>d;d++){e=d;for(b=0;8>b;b++)e=e&1?3988292384^e>>>1:e>>>1;a[d]=e}return a}();p.exports=function(a){var e=-1,d;for(d=0;d<a.length;d++)e=e>>>8^f[(e^a.charCodeAt(d))&255];return(e^-1)>>>0}},{}],5:[function(k,p,m){m=k("./Shared");var f=k("./Path");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(a,e,d){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(e&&e.unique?e.unique:!1);void 0!==a&&this.keys(a);
void 0!==d&&this.collection(d);this.name(e&&e.name?e.name:this._id)};m.modules.Index=k;k.prototype.id=function(){return this._id};k.prototype.state=function(){return this._state};k.prototype.size=function(){return this._size};k.prototype.data=function(a){return void 0!==a?(this._data=a,this):this._data};k.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};k.prototype.collection=function(a){return void 0!==a?(this._collection=a,this):this._collection};k.prototype.keys=function(a){return void 0!==
a?(this._keys=a,this._keyCount=(new f).parse(this._keys).length,this):this._keys};k.prototype.type=function(a){return void 0!==a?(this._type=a,this):this._type};k.prototype.unique=function(a){return void 0!==a?(this._unique=a,this):this._unique};k.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),e,d=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(e=0;e<d;e++)this.insert(a[e])}this._state={name:this._name,keys:this._keys,
indexSize:this._size,built:new Date,updated:new Date,ok:!0}};k.prototype.insert=function(a,e){var d,b;this._unique&&(d=this._itemHash(a,this._keys),this._uniqueLookup[d]=a);d=this._itemHashArr(a,this._keys);for(b=0;b<d.length;b++)this.pushToPathValue(d[b],a)};k.prototype.remove=function(a,e){var d,b;this._unique&&(d=this._itemHash(a,this._keys),delete this._uniqueLookup[d]);d=this._itemHashArr(a,this._keys);for(b=0;b<d.length;b++)this.pullFromPathValue(d[b],a)};k.prototype.violation=function(a){a=
this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};k.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};k.prototype.pushToPathValue=function(a,e){var d=this._data[a]=this._data[a]||[];-1===d.indexOf(e)&&(d.push(e),this._size++,this.pushToCrossRef(e,d))};k.prototype.pullFromPathValue=function(a,e){var d=this._data[a],b;b=d.indexOf(e);-1<b&&(d.splice(b,1),this._size--,this.pullFromCrossRef(e,d));d.length||delete this._data[a]};k.prototype.pull=function(a){var e=
a[this._collection.primaryKey()],d=this._crossRef[e],b,f=d.length,g;for(b=0;b<f;b++)g=d[b],this._pullFromArray(g,a);this._size--;delete this._crossRef[e]};k.prototype._pullFromArray=function(a,e){for(var d=a.length;d--;)a[d]===e&&a.splice(d,1)};k.prototype.pushToCrossRef=function(a,e){var d=a[this._collection.primaryKey()];this._crossRef[d]=this._crossRef[d]||[];d=this._crossRef[d];-1===d.indexOf(e)&&d.push(e)};k.prototype.pullFromCrossRef=function(a,e){var d=a[this._collection.primaryKey()];delete this._crossRef[d]};
k.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};k.prototype.match=function(a,e){return(new f).countObjectPaths(this._keys,a)};k.prototype._itemHash=function(a,e){var d=new f,b,l="",g;b=d.parse(e);for(g=0;g<b.length;g++)l&&(l+="_"),l+=d.value(a,b[g].path).join(":");return l};k.prototype._itemKeyHash=function(a,e){var d=new f,b,l="",g;b=d.parse(e);for(g=0;g<b.length;g++)l&&(l+="_"),l+=d.keyValue(a,b[g].path);return l};k.prototype._itemHashArr=function(a,e){var d=
new f,b,l=[],g,c,h,k;b=d.parse(e);for(h=0;h<b.length;h++)for(g=d.value(a,b[h].path),c=0;c<g.length;c++)if(0===h)l.push(g[c]);else for(k=0;k<l.length;k++)l[k]=l[k]+"_"+g[c];return l};p.exports=k},{"./Path":10,"./Shared":11}],6:[function(k,p,m){k=k("./Shared");m=function(f){this.init.apply(this,arguments)};m.prototype.init=function(f){this._name=f;this._data={};this._primaryKey="_id"};k.modules.KeyValueStore=m;m.prototype.name=function(f){return void 0!==f?(this._name=f,this):this._name};m.prototype.primaryKey=
function(f){return void 0!==f?(this._primaryKey=f,this):this._primaryKey};m.prototype.truncate=function(){this._data={};return this};m.prototype.set=function(f,a){this._data[f]=a?a:!0;return this};m.prototype.get=function(f){return this._data[f]};m.prototype.lookup=function(f){f=f[this._primaryKey];var a,e,d,b;if(f instanceof Array){e=f.length;b=[];for(a=0;a<e;a++)(d=this._data[f[a]])&&b.push(d);return b}if(f instanceof RegExp){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&f.test(a)&&b.push(this._data[a]);
return b}if("object"===typeof f){if(f.$ne){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==f.$ne&&b.push(this._data[a]);return b}if(f.$in&&f.$in instanceof Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<f.$in.indexOf(a)&&b.push(this._data[a]);return b}if(f.$nin&&f.$nin instanceof Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===f.$nin.indexOf(a)&&b.push(this._data[a]);return b}if(f.$or&&f.$or instanceof Array){b=[];for(a=0;a<f.$or.length;a++)b=b.concat(this.lookup(f.$or[a]));
return b}}else return d=this._data[f],void 0!==d?[d]:[]};m.prototype.unSet=function(f){delete this._data[f];return this};m.prototype.uniqueSet=function(f,a){return void 0===this._data[f]?(this._data[f]=a,!0):!1};p.exports=m},{"./Shared":11}],7:[function(k,p,m){m=k("./Shared");var f=k("./Operation");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._data=[]};m.modules.Metrics=k;k.prototype.create=function(a){a=new f(a);this._enabled&&this._data.push(a);return a};k.prototype.start=
function(){this._enabled=!0;return this};k.prototype.stop=function(){this._enabled=!1;return this};k.prototype.clear=function(){this._data=[];return this};k.prototype.list=function(){return this._data};p.exports=k},{"./Operation":8,"./Shared":11}],8:[function(k,p,m){m=k("./Shared");var f=k("./Path");k=function(a){this.pathSolver=new f;this.counter=0;this.init.apply(this,arguments)};k.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,
totalMs:0,process:{}},flag:{},log:[]}};m.modules.Operation=k;k.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};k.prototype.log=function(a){if(a){var e=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);e&&(a.delta=a.time-e);return this}return this._data.log};k.prototype.time=function(a){if(void 0!==a){var e=this._data.time.process,e=e[a]=e[a]||{};e.startMs?(e.stopMs=(new Date).getTime(),e.totalMs=
e.stopMs-e.startMs,e.stepObj.totalMs=e.totalMs,delete e.stepObj):(e.startMs=(new Date).getTime(),e.stepObj={name:a},this._data.steps.push(e.stepObj));return this}return this._data.time};k.prototype.flag=function(a,e){if(void 0!==a&&void 0!==e)this._data.flag[a]=e;else return void 0!==a?this._data.flag[a]:this._data.flag};k.prototype.data=function(a,e,d){return void 0!==e?(this.pathSolver.set(this._data,a,e),this):this.pathSolver.get(this._data,a)};k.prototype.pushData=function(a,e,d){this.pathSolver.push(this._data,
a,e)};k.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};p.exports=k},{"./Path":10,"./Shared":11}],9:[function(k,p,m){m=function(f){if(f){var a,e=f.length;return function(){for(a=0;a<e;a++)if(f[a].length===arguments.length)return f[a].apply(this,arguments);return null}}return function(){}};k("./Shared").modules.Overload=m;p.exports=m},{"./Shared":11}],10:[function(k,p,m){k=k("./Shared");m=function(f){this.init.apply(this,
arguments)};m.prototype.init=function(f){f&&this.path(f)};k.modules.Path=m;m.prototype.path=function(f){return void 0!==f?(this._path=this.clean(f),this._pathParts=this._path.split("."),this):this._path};m.prototype.hasObjectPaths=function(f,a){var e=!0,d;for(d in f)if(f.hasOwnProperty(d)&&(void 0===a[d]||"object"===typeof f[d]&&(e=this.hasObjectPaths(f[d],a[d]),!e)))return!1;return e};m.prototype.countKeys=function(f){var a=0,e;for(e in f)f.hasOwnProperty(e)&&void 0!==f[e]&&("object"!==typeof f[e]?
a++:a+=this.countKeys(f[e]));return a};m.prototype.countObjectPaths=function(f,a){var e,d={},b=0,l=0,g;for(g in a)a.hasOwnProperty(g)&&("object"===typeof a[g]?(e=this.countObjectPaths(f[g],a[g]),d[g]=e.matchedKeys,l+=e.totalKeyCount,b+=e.matchedKeyCount):(l++,f&&f[g]&&"object"!==typeof f[g]?(d[g]=!0,b++):d[g]=!1));return{matchedKeys:d,matchedKeyCount:b,totalKeyCount:l}};m.prototype.parse=function(f,a){var e=[],d="",b,l,g;for(l in f)if(f.hasOwnProperty(l))if(d=l,"object"===typeof f[l])if(a)for(b=this.parse(f[l],
a),g=0;g<b.length;g++)e.push({path:d+"."+b[g].path,value:b[g].value});else for(b=this.parse(f[l]),g=0;g<b.length;g++)e.push({path:d+"."+b[g].path});else a?e.push({path:d,value:f[l]}):e.push({path:d});return e};m.prototype.parseArr=function(f,a){a=a||{};return this._parseArr(f,"",[],a)};m.prototype._parseArr=function(f,a,e,d){var b,l="";a=a||"";e=e||[];for(b in f)f.hasOwnProperty(b)&&(!d.ignore||d.ignore&&!d.ignore.test(b))&&(l=a?a+"."+b:b,"object"===typeof f[b]?this._parseArr(f[b],l,e,d):e.push(l));
return e};m.prototype.value=function(f,a){if(void 0!==f&&"object"===typeof f){var e,d,b,l,g=[],c;void 0!==a&&(a=this.clean(a),e=a.split("."));e=e||this._pathParts;d=e.length;b=f;for(c=0;c<d;c++){b=b[e[c]];if(l instanceof Array){for(d=0;d<l.length;d++)g=g.concat(this.value(l,d+"."+e[c]));return g}if(!b||"object"!==typeof b)break;l=b}return[b]}return[]};m.prototype.set=function(f,a,e){if(void 0!==f&&void 0!==a){var d;a=this.clean(a);a=a.split(".");d=a.shift();a.length?(f[d]=f[d]||{},this.set(f[d],a.join("."),
e)):f[d]=e}return f};m.prototype.get=function(f,a){return this.value(f,a)[0]};m.prototype.push=function(f,a,e){if(void 0!==f&&void 0!==a){var d;a=this.clean(a);a=a.split(".");d=a.shift();if(a.length)f[d]=f[d]||{},this.set(f[d],a.join("."),e);else if(f[d]=f[d]||[],f[d]instanceof Array)f[d].push(e);else throw"Cannot push to a path whose endpoint is not an array!";}return f};m.prototype.keyValue=function(f,a){var e,d,b,l,g;void 0!==a&&(a=this.clean(a),e=a.split("."));e=e||this._pathParts;d=e.length;
b=f;for(g=0;g<d;g++)if(b=b[e[g]],!b||"object"!==typeof b){l=e[g]+":"+b;break}return l};m.prototype.clean=function(f){"."===f.substr(0,1)&&(f=f.substr(1,f.length-1));return f};p.exports=m},{"./Shared":11}],11:[function(k,p,m){p.exports={idCounter:0,modules:{},prototypes:{}}},{}],12:[function(k,p,m){var f,a,e;m=k("./Shared");var d=function(b,a,d){this.init.apply(this,arguments)};d.prototype.init=function(b,a,d){this._name=b;this._collections=[];this._groups=[];this._listeners={};this._querySettings=
{query:a,options:d};this._debug={};this._privateData=new f("__FDB__view_privateData_"+this._name)};m.modules.View=d;f=k("./Collection");k=k("./Overload");a=f.prototype.init;m=m.modules.Core;e=m.prototype.init;d.prototype.debug=new k([function(){return this._debug.all},function(b){return void 0!==b&&"boolean"===typeof b?(this._debug.all=b,this.privateData().debug(b),this.publicData().debug(b),this):this._debug.all},function(b,a){return void 0!==b?void 0!==a?(this._debug[b]=a,this.privateData().debug(b,
a),this.publicData().debug(b,a),this):this._debug[b]:this._debug.all}]);d.prototype.name=function(b){return void 0!==b?(this._name=b,this):this._name};d.prototype.find=function(b,a){return this.publicData().find(b,a)};d.prototype.insert=function(b,a,d){b=this._privateData.decouple(b);"function"===typeof a?(d=a,a=this._privateData.length):void 0===a&&(a=this._privateData.length);this._transformInsert(b,a);this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+
this._privateData.name()+'"');return this._privateData._insertHandle(b,a,d)};d.prototype.update=function(b,a){this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');var d=this._privateData.update(b,a),c,e,f;if(this._transformEnabled&&this._transformIn){c=this._publicData.primaryKey();for(var k=0;k<d.length;k++)e={},f=d[k],e[c]=f[c],this._transformUpdate(e,f)}return d};d.prototype.remove=function(b){this._transformRemove(b);
this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData.remove(b)};d.prototype.link=function(b,a){var d=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+b);return d.link(b,a)};d.prototype.unlink=function(b,a){var d=this.publicData();
this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+b);return d.unlink(b,a)};d.prototype.from=function(b){void 0!==b&&("string"===typeof b&&(b=this._db.collection(b)),this._addCollection(b));return this};d.prototype._addCollection=function(b){if(-1===this._collections.indexOf(b)){this._collections.push(b);b._addView(this);var a=b.find(this._querySettings.query,this._querySettings.options);
this._transformPrimaryKey(b.primaryKey());this._transformInsert(a);this._privateData.primaryKey(b.primaryKey());this._privateData.insert(a)}return this};d.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options)));return this};d.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};d.prototype.off=function(){this._privateData.off.apply(this._privateData,
arguments)};d.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};d.prototype.drop=function(){if(this._collections&&this._collections.length){(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);this._privateData.drop();return!0}return!1};d.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),
this.publicData().db(a),this):this._db};d.prototype.primaryKey=function(){return this._privateData.primaryKey()};d.prototype.queryData=function(a,d,e){void 0!==a&&(this._querySettings.query=a);void 0!==d&&(this._querySettings.options=d);return void 0!==a||void 0!==d?(void 0!==e&&!0!==e||this.refresh(),this):this._querySettings};d.prototype.queryAdd=function(a,d,e){var c=this._querySettings.query,f;if(void 0!==a)for(f in a)a.hasOwnProperty(f)&&(void 0===c[f]||void 0!==c[f]&&d)&&(c[f]=a[f]);void 0!==
e&&!0!==e||this.refresh()};d.prototype.queryRemove=function(a,d){var e=this._querySettings.query,c;if(void 0!==a)for(c in a)a.hasOwnProperty(c)&&delete e[c];void 0!==d&&!0!==d||this.refresh()};d.prototype.query=function(a,d){return void 0!==a?(this._querySettings.query=a,void 0!==d&&!0!==d||this.refresh(),this):this._querySettings.query};d.prototype.queryOptions=function(a,d){return void 0!==a?(this._querySettings.options=a,void 0===a.decouple&&(a.decouple=!0),void 0!==d&&!0!==d||this.refresh(),this):
this._querySettings.options};d.prototype.refresh=function(a){var d;a=this.publicData();var e;this._privateData.remove();a.remove();for(e=0;e<this._collections.length;e++)d=this._collections[e],this._privateData.insert(d.find(this._querySettings.query,this._querySettings.options));d=this._privateData.find({},this._querySettings.options);a._linked?$.observable(a._data).refresh(d):(this._privateData._data.length=0,this._privateData._data=this._privateData._data.concat(d));return this};d.prototype.count=
function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};d.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,
dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.privateData=function(){return this._privateData};d.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};d.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new f("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};
d.prototype._transformInsert=function(a,d){this._transformEnabled&&this._publicData&&this._publicData.insert(a,d)};d.prototype._transformUpdate=function(a,d){this._transformEnabled&&this._publicData&&this._publicData.update(a,d)};d.prototype._transformRemove=function(a){this._transformEnabled&&this._publicData&&this._publicData.remove(a)};d.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};f.prototype.init=function(){this._views=[];
a.apply(this,arguments)};f.prototype.view=function(a,e,f){a=(new d(a,e,f)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a};f.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};f.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};m.prototype.init=function(){this._views={};e.apply(this,arguments)};m.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&
this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new d(a)).db(this);return this._views[a]};m.prototype.viewExists=function(a){return Boolean(this._views[a])};m.prototype.views=function(){var a=[],d;for(d in this._views)this._views.hasOwnProperty(d)&&a.push({name:d,count:this._views[d].count()});return a};p.exports=d},{"./Collection":2,"./Overload":9,"./Shared":11}]},{},[1])(1)});
