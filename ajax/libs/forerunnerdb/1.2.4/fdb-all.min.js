!function(y){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=y();else if("function"==typeof define&&define.amd)define([],y);else{var h;"undefined"!=typeof window?h=window:"undefined"!=typeof global?h=global:"undefined"!=typeof self&&(h=self);h.ForerunnerDB=y()}}(function(){return function h(n,l,f){function b(a,d){if(!l[a]){if(!n[a]){var c="function"==typeof require&&require;if(!d&&c)return c(a,!0);if(e)return e(a,!0);c=Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=l[a]={exports:{}};n[a][0].call(c.exports,function(k){var z=n[a][1][k];return b(z?z:k)},c,c.exports,h,n,l,f)}return l[a].exports}for(var e="function"==typeof require&&require,d=0;d<f.length;d++)b(f[d]);return b}({1:[function(h,n,l){l=h("../lib/Core");h("../lib/CollectionGroup");h("../lib/View");h("../lib/OldView");h("../lib/OldView.Bind");h("../lib/Highcharts");h("../lib/Persist");n.exports=l;window.ForerunnerDB=l},{"../lib/CollectionGroup":3,"../lib/Core":4,"../lib/Highcharts":6,"../lib/OldView":11,
"../lib/OldView.Bind":10,"../lib/Persist":15,"../lib/View":17}],2:[function(h,n,l){var f,b,e,d,a,g;f=h("./Shared");var c=function(k){this.init.apply(this,arguments)};c.prototype.init=function(k){this._primaryKey="_id";this._primaryIndex=new e("primary");this._primaryCrc=new e("primaryCrc");this._crcLookup=new e("crcLookup");this._name=k;this._data=[];this._groups=[];this._metrics=new b;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,
update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};f.modules.Collection=c;l=h("./Overload");b=h("./Metrics");e=h("./KeyValueStore");d=h("./Path");a=h("./Index");g=h("./Crc");h=f.modules.Core;c.prototype.debug=new l([function(){return this._debug.all},function(k){if(void 0!==k){if("boolean"===typeof k){this._debug.all=k;for(var a=0;a<this._views.length;a++)this._views[a].debug(k);return this}return this._debug[k]||this._db&&this._db._debug&&
this._db._debug[k]||this._debug.all}return this._debug.all},function(k,a){if(void 0!==k){if(void 0!==a){this._debug[k]=a;for(var c=0;c<this._views.length;c++)this._views[c].debug(k,a);return this}return this._debug[k]||this._db&&this._db._debug&&this._db._debug[k]}return this._debug.all}]);c.prototype.crc=g;c.prototype.name=function(k){return void 0!==k?(this._name=k,this):this._name};c.prototype.on=new l([function(k,a){this._listeners=this._listeners||{};this._listeners[k]=this._listeners[k]||{};
this._listeners[k]["*"]=this._listeners[k]["*"]||[];this._listeners[k]["*"].push(a);return this},function(k,a,c){this._listeners=this._listeners||{};this._listeners[k]=this._listeners[k]||{};this._listeners[k][a]=this._listeners[k][a]||[];this._listeners[k][a].push(c);return this}]);c.prototype.off=new l([function(k){this._listeners&&this._listeners[k]&&k in this._listeners&&delete this._listeners[k];return this},function(k,a){var c,d;"string"===typeof a?this._listeners&&this._listeners[k]&&this._listeners[k][a]&&
delete this._listeners[k][a]:k in this._listeners&&(c=this._listeners[k]["*"],d=c.indexOf(a),-1<d&&c.splice(d,1));return this},function(k,a,c){this._listeners&&k in this._listeners&&(k=this._listeners[k][a],c=k.indexOf(c),-1<c&&k.splice(c,1))}]);c.prototype.emit=function(k,a){this._listeners=this._listeners||{};if(k in this._listeners){if(this._listeners[k]["*"]){var c=this._listeners[k]["*"],d=c.length,b;for(b=0;b<d;b++)c[b].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&
a[0]&&a[0][this._primaryKey]){var c=this._listeners[k],g,e,d=a.length;for(b=0;b<d;b++)if(c[a[b][this._primaryKey]])for(g=c[a[b][this._primaryKey]].length,e=0;e<g;e++)c[a[b][this._primaryKey]][e].apply(this,Array.prototype.slice.call(arguments,1))}}return this};c.prototype.drop=function(){if(this._db&&this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var k=[],a;for(a=0;a<this._groups.length;a++)k.push(this._groups[a]);
for(a=0;a<k.length;a++)this._groups[a].removeCollection(this);return!0}return!1};c.prototype.primaryKey=function(k){return void 0!==k?(this._primaryKey=k,this._primaryIndex.primaryKey(k),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};c.prototype._onInsert=function(k,a){this.emit("insert",k,a)};c.prototype._onUpdate=function(k){this.emit("update",k)};c.prototype._onRemove=function(k){this.emit("remove",k)};c.prototype.db=function(k){return void 0!==k?(this._db=k,this):this._db};c.prototype.setData=
function(k,a,c){if(k){var d=this._metrics.create("setData");d.start();k instanceof Array||(k=[k]);d.time("transformIn");k=this.transformIn(k);d.time("transformIn");var b=this._data;this._data=[];k.length&&(this._data=this._data.concat(k));d.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(a);d.time("_rebuildPrimaryKeyIndex");d.stop();this.emit("setData",this._data,b)}c&&c(!1);return this};c.prototype._rebuildPrimaryKeyIndex=function(k){var a=k&&void 0!==k.ensureKeys?k.ensureKeys:!0;k=
k&&void 0!==k.violationCheck?k.violationCheck:!0;var c,d,b,g=this._primaryIndex,e=this._primaryCrc,f=this._crcLookup,h=this._primaryKey,l;g.truncate();e.truncate();f.truncate();c=this._data;for(d=c.length;d--;)if(b=c[d],a&&this._ensurePrimaryKey(b),k){if(!g.uniqueSet(b[h],b))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+b[this._primaryKey];}else l=JSON.stringify(b),g.set(b[h],b),e.set(b[h],l),f.set(l,
b)};c.prototype._ensurePrimaryKey=function(k){void 0===k[this._primaryKey]&&(k[this._primaryKey]=this.objectId())};c.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};c.prototype.upsert=function(k,a){if(k){var c=this._deferQueue.upsert,d=this._deferThreshold.upsert,b={},g;if(k instanceof Array){if(k.length>d){this._deferQueue.upsert=c.concat(k);this.processQueue("upsert",a);return}b=[];for(c=0;c<k.length;c++)b.push(this.upsert(k[c]));
a&&a();return b}k[this._primaryKey]?(g={},g[this._primaryKey]=k[this._primaryKey],this.count(g)?b.op="update":b.op="insert"):b.op="insert";switch(b.op){case "insert":b.result=this.insert(k);break;case "update":b.result=this.update(g,k)}return b}a&&a()};c.prototype.update=function(k,a,c){a=this.decouple(a);a=this.transformIn(a);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var d=this,b=this._metrics.create("update"),g=this._primaryKey,e,f,h=function(b){if(a&&
void 0!==a[g]&&a[g]!=b[g]){d._primaryIndex.unSet(b[g]);var e=d._updateObject(b,a,k,c,"");if(d._primaryIndex.uniqueSet(b[g],b))return e;throw"Primary key violation in update! Key violated: "+b[g];}return d._updateObject(b,a,k,c,"")},l=this._views;b.start();b.time("Retrieve documents to update");e=this.find(k,{decouple:!1});b.time("Retrieve documents to update");if(e.length&&(b.time("Update documents"),f=e.filter(h),b.time("Update documents"),f.length)){if(l&&l.length){this.debug("views")&&console.log("Updating views from collection: "+
this.name());b.time("Inform views of update");for(e=0;e<l.length;e++)l[e].update(k,a);b.time("Inform views of update")}this._onUpdate(f);this.deferEmit("change",{type:"update",data:f})}b.stop();return f||[]};c.prototype.updateById=function(k,a){var c={};c[this._primaryKey]=k;return this.update(c,a)};c.prototype._updateObject=function(k,a,c,b,g,e){a=this.decouple(a);g=g||"";"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));var f=!1,h=!1,l,p,q,m;for(m in a)if(a.hasOwnProperty(m)){l=!1;if("$"===m.substr(0,
1))switch(m){case "$index":break;default:l=!0,(h=this._updateObject(k,a[m],c,b,g,m))&&(f=!0)}if(this._isPositionalKey(m)&&(l=!0,m=m.substr(0,m.length-2),h=new d(g+"."+m),k[m]&&k[m]instanceof Array&&k[m].length)){p=[];for(q=0;q<k[m].length;q++)this._match(k[m][q],h.value(c)[0])&&p.push(q);for(q=0;q<p.length;q++)(h=this._updateObject(k[m][p[q]],a[m+".$"],c,b,g+"."+m,e))&&(f=!0)}if(!l)if(e||"object"!==typeof a[m])switch(e){case "$inc":this._updateIncrement(k,m,a[m]);f=!0;break;case "$push":void 0===
k[m]&&(k[m]=[]);if(k[m]instanceof Array)this._updatePush(k[m],a[m]),f=!0;else throw"Cannot push to a key that is not an array! ("+m+")!";break;case "$pull":if(k[m]instanceof Array){p=[];for(q=0;q<k[m].length;q++)this._match(k[m][q],a[m])&&p.push(q);for(q=p.length;q--;)this._updatePull(k[m],p[q]),f=!0}else throw"Cannot pull from a key that is not an array! ("+m+")!";break;case "$addToSet":void 0===k[m]&&(k[m]=[]);if(k[m]instanceof Array){p=k[m];var n;q=p.length;var s;l=!0;n=b&&b.$addToSet;var r;n&&
n.key?(h=!1,r=new d(n.key),s=r.value(a[m])[0]):(s=JSON.stringify(a[m]),h=!0);for(n=0;n<q;n++)if(h){if(JSON.stringify(p[n])===s){l=!1;break}}else if(s===r.value(p[n])[0]){l=!1;break}l&&(this._updatePush(k[m],a[m]),f=!0)}else throw"Cannot push to a key that is not an array! (undefined)!";break;case "$splicePush":void 0===k[m]&&(k[m]=[]);if(k[m]instanceof Array)if(f=a.$index,void 0!==f)delete a.$index,this._updateSplicePush(k[m],f,a[m]),f=!0;else throw"Cannot splicePush without a $index integer value!";
else throw"Cannot splicePush with a key that is not an array! ("+m+")!";break;case "$move":if(k[m]instanceof Array)for(q=0;q<k[m].length;q++){if(this._match(k[m][q],a[m])){f=a[m].$index;if(void 0!==f)this._updateSpliceMove(k[m],q,f),f=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+m+")!";break;default:k[m]!==a[m]&&(this._updateProperty(k,m,a[m]),f=!0)}else if(null!==k[m]&&"object"===typeof k[m])if(p=k[m]instanceof Array,
q=a[m]instanceof Array,p||q)if(!q&&p)for(q=0;q<k[m].length;q++)(h=this._updateObject(k[m][q],a[m],c,b,g+"."+m,e))&&(f=!0);else k[m]!==a[m]&&(this._updateProperty(k,m,a[m]),f=!0);else(h=this._updateObject(k[m],a[m],c,b,g+"."+m,e))&&(f=!0);else k[m]!==a[m]&&(this._updateProperty(k,m,a[m]),f=!0)}return f};c.prototype._isPositionalKey=function(k){return".$"===k.substr(k.length-2,2)};c.prototype._updateProperty=function(k,a,c){this._linked?($.observable(k).setProperty(a,c),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+
a+'" for collection "'+this.name()+'"')):(k[a]=c,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+a+'" for collection "'+this.name()+'"'))};c.prototype._updateIncrement=function(k,a,c){this._linked?$.observable(k).setProperty(a,k[a]+c):k[a]+=c};c.prototype._updateSpliceMove=function(k,a,c){this._linked?($.observable(k).move(a,c),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+a+'" to "'+c+'" for collection "'+
this.name()+'"')):(k.splice(c,0,k.splice(a,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+a+'" to "'+c+'" for collection "'+this.name()+'"'))};c.prototype._updateSplicePush=function(k,a,c){k.length>a?this._linked?$.observable(k).insert(a,c):k.splice(a,0,c):this._linked?$.observable(k).insert(c):k.push(c)};c.prototype._updatePush=function(k,a){this._linked?$.observable(k).insert(a):k.push(a)};c.prototype._updatePull=function(a,c){this._linked?
$.observable(a).remove(c):a.splice(c,1)};c.prototype.remove=function(a){var c,b,d=this._views,g;if(a instanceof Array){d=[];for(c=0;c<a.length;c++)d.push(this.remove(a[c]));return d}c=this.find(a,{decouple:!1});if(c.length){for(g=0;g<c.length;g++)b=c[g],this._removeIndex(b),b=this._data.indexOf(b),this._linked?$.observable(this._data).remove(b):this._data.splice(b,1);if(d&&d.length)for(g=0;g<d.length;g++)d[g].remove(a);this._onRemove(c);this.deferEmit("change",{type:"remove",data:c})}return c};c.prototype.removeById=
function(a){var c={};c[this._primaryKey]=a;return this.remove(c)};c.prototype.deferEmit=function(){var a=this,c;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(c=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){a.debug()&&console.log("ForerunnerDB.Collection: Emitting "+c[0]);a.emit.apply(a,c)},100))};c.prototype.processQueue=function(a,c){var b=this._deferQueue[a],d=this._deferThreshold[a],
g=this._deferTime[a];if(b.length){var e=this;b.length&&(b=b.length>d?b.splice(0,d):b.splice(0,b.length),this[a](b));setTimeout(function(){e.processQueue(a,c)},g)}else c&&c()};c.prototype.insert=function(a,c,b){"function"===typeof c?(b=c,c=this._data.length):void 0===c&&(c=this._data.length);a=this.transformIn(a);return this._insertHandle(a,c,b)};c.prototype._insertHandle=function(a,c,b){var d=this._deferQueue.insert,g=this._deferThreshold.insert,e=[],f=[],h=this._views;if(a instanceof Array){if(a.length>
g){this._deferQueue.insert=d.concat(a);this.processQueue("insert",b);return}for(g=0;g<a.length;g++)d=this._insert(a[g],c+g),!0===d?e.push(a[g]):f.push({doc:a[g],reason:d})}else d=this._insert(a,c),!0===d?e.push(a):f.push({doc:a,reason:d});if(h&&h.length)for(d=0;d<h.length;d++)h[d].insert(a,c);this._onInsert(e,f);b&&b();this.deferEmit("change",{type:"insert",data:e});return{inserted:e,failed:f}};c.prototype._insert=function(a,c){if(a){var b;this._ensurePrimaryKey(a);if(b=this.insertIndexViolation(a))return"Index violation in index: "+
b;this._insertIndex(a);this._linked?$.observable(this._data).insert(c,a):this._data.splice(c,0,a);return!0}return"No document passed to insert"};c.prototype._insertIndex=function(a){var c=this._indexByName,b,d=JSON.stringify(a);this._primaryIndex.uniqueSet(a[this._primaryKey],a);this._primaryCrc.uniqueSet(a[this._primaryKey],d);this._crcLookup.uniqueSet(d,a);for(b in c)c.hasOwnProperty(b)&&c[b].insert(a)};c.prototype._removeIndex=function(a){var c=this._indexByName,b,d=JSON.stringify(a);this._primaryIndex.unSet(a[this._primaryKey]);
this._primaryCrc.unSet(a[this._primaryKey]);this._crcLookup.unSet(d);for(b in c)c.hasOwnProperty(b)&&c[b].remove(a)};c.prototype.subset=function(a,b){var d=this.find(a,b);return(new c)._subsetOf(this).primaryKey(this._primaryKey).setData(d)};c.prototype.subsetOf=function(){return this.__subsetOf};c.prototype._subsetOf=function(a){this.__subsetOf=a;return this};c.prototype.distinct=function(a,c,b){c=this.find(c,b);a=new d(a);b={};var g=[],e,f;for(f=0;f<c.length;f++)(e=a.value(c[f])[0])&&!b[e]&&(b[e]=
!0,g.push(e));return g};c.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};c.prototype.findById=function(a,c){var b={};b[this._primaryKey]=a;return this.find(b,c)[0]};c.prototype.peek=function(a,b){var d=this._data,g=d.length,e,f,h=new c;if("string"===typeof a){for(e=0;e<g;e++)f=JSON.stringify(d[e]),-1<f.indexOf(a)&&h.insert(d[e]);return h.find({},b)}return this.find(a,b)};c.prototype.explain=function(a,c){return this.find(a,c).__fdbOp._data};c.prototype.find=function(a,c){a=a||
{};c=c||{};c.decouple=void 0!==c.decouple?c.decouple:!0;var b=this._metrics.create("find"),g=this,e,f=!0,h,l,n,p,q,m,u,s,r,x=[];l=function(c){return g._match(c,a,"and")};b.start();if(a){b.time("analyseQuery");e=this._analyseQuery(a,c,b);b.time("analyseQuery");b.data("analysis",e);if(e.hasJoin&&e.queriesJoin){b.time("joinReferences");for(n=0;n<e.joinsOn.length;n++)q=e.joinsOn[n],p=new d(e.joinQueries[q]),p=p.value(a)[0],this._db.collection(e.joinsOn[n]).subset(p);b.time("joinReferences")}e.indexMatch.length&&
(!c||c&&!c.skipIndex)?(b.data("index.potential",e.indexMatch),b.data("index.used",e.indexMatch[0].index),b.time("indexLookup"),h=e.indexMatch[0].lookup,b.time("indexLookup"),e.indexMatch[0].keyData.totalKeyCount===e.indexMatch[0].keyData.matchedKeyCount&&(f=!1)):b.flag("usedIndex",!1);f&&(h&&h.length?(e=h.length,b.time("tableScan: "+e),h=h.filter(l)):(e=this._data.length,b.time("tableScan: "+e),h=this._data.filter(l)),c.sort&&(b.time("sort"),h=this.sort(c.sort,h),b.time("sort")),b.time("tableScan: "+
e));c.limit&&h&&h.length>c.limit&&(h.length=c.limit,b.data("limit",c.limit));c.decouple&&(b.time("decouple"),h=this.decouple(h),b.time("decouple"),b.data("flag.decouple",!0));if(c.join){for(l=0;l<c.join.length;l++)for(q in c.join[l])if(c.join[l].hasOwnProperty(q))for(s=q,e=this._db.collection(q),f=c.join[l][q],r=0;r<h.length;r++){u={};p=n=!1;for(m in f)if(f.hasOwnProperty(m))if("$"===m.substr(0,1))switch(m){case "$as":s=f[m];break;case "$multi":n=f[m];break;case "$require":p=f[m];break;default:m.substr(0,
3)}else u[m]=(new d(f[m])).value(h[r])[0];u=e.find(u);!p||p&&u[0]?h[r][s]=!1===n?u[0]:u:x.push(h[r])}b.data("flag.join",!0)}if(x.length){b.time("removalQueue");for(m=0;m<x.length;m++)q=h.indexOf(x[m]),-1<q&&h.splice(q,1);b.time("removalQueue")}if(c.transform){b.time("transform");for(m=0;m<h.length;m++)h.splice(m,1,c.transform(h[m]));b.time("transform");b.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(b.time("transformOut"),h=this.transformOut(h),b.time("transformOut"));b.data("results",
h.length);b.stop()}else b.stop(),h=[];h.__fdbOp=b;return h};c.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};c.prototype.transformIn=function(a){if(this._transformEnabled&&this._transformIn){if(a instanceof
Array){var c=[],b;for(b=0;b<a.length;b++)c[b]=this._transformIn(a[b]);return c}return this._transformIn(a)}return a};c.prototype.transformOut=function(a){if(this._transformEnabled&&this._transformOut){if(a instanceof Array){var c=[],b;for(b=0;b<a.length;b++)c[b]=this._transformOut(a[b]);return c}return this._transformOut(a)}return a};c.prototype.sort=function(a,c){c=c||[];var b=[],d,g;for(d in a)a.hasOwnProperty(d)&&(g={},g[d]=a[d],g.___fdbKey=d,b.push(g));return 2>b.length?this._sort(a,c):this._bucketSort(b,
c)};c.prototype._bucketSort=function(a,c){var b=a.shift(),d,g,e=[];if(0<a.length){c=this._sort(b,c);d=this.bucket(b.___fdbKey,c);for(g in d)d.hasOwnProperty(g)&&(b=[].concat(a),e=e.concat(this._bucketSort(b,d[g])));return e}return this._sort(b,c)};c.prototype._sort=function(a,c){var b=new d,g=b.parse(a,!0)[0];b.path(g.path);return c.sort(1===g.value?function(a,c){var k=b.value(a)[0],d=b.value(c)[0];return"string"===typeof k&&"string"===typeof d?k.localeCompare(d):k>d?1:k<d?-1:0}:function(a,c){var k=
b.value(a)[0],d=b.value(c)[0];return"string"===typeof k&&"string"===typeof d?1===k.localeCompare(d)?-1:1:k>d?-1:k<d?1:0})};c.prototype.bucket=function(a,c){var b,d={};for(b=0;b<c.length;b++)d[c[b][a]]=d[c[b][a]]||[],d[c[b][a]].push(c[b]);return d};c.prototype._analyseQuery=function(a,c,b){var g={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:a,options:c},e,f=[],h=[],l,n,p,q,m;b.time("checkIndexes");void 0!==a[this._primaryKey]&&(b.time("checkIndexMatch: Primary Key"),
l=new d,g.indexMatch.push({lookup:this._primaryIndex.lookup(a,c),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:l.countKeys(a)},index:this._primaryIndex}),b.time("checkIndexMatch: Primary Key"));for(m in this._indexById)if(this._indexById.hasOwnProperty(m)&&(n=this._indexById[m],p=n.name(),b.time("checkIndexMatch: "+p),l=n.match(a,c),q=n.lookup(a,c),0<l.matchedKeyCount&&g.indexMatch.push({lookup:q,keyData:l,index:n}),b.time("checkIndexMatch: "+p),l.totalKeyCount===l.matchedKeyCount))break;
b.time("checkIndexes");1<g.indexMatch.length&&(b.time("findOptimalIndex"),g.indexMatch.sort(function(a,c){return a.keyData.totalKeyCount===a.keyData.matchedKeyCount?-1:c.keyData.totalKeyCount===c.keyData.matchedKeyCount?1:a.keyData.matchedKeyCount===c.keyData.matchedKeyCount?a.lookup.length-c.lookup.length:c.keyData.matchedKeyCount-a.keyData.matchedKeyCount}),b.time("findOptimalIndex"));if(c.join){g.hasJoin=!0;for(b=0;b<c.join.length;b++)for(e in c.join[b])c.join[b].hasOwnProperty(e)&&(f.push(e),
"$as"in c.join[b][e]?h.push(c.join[b][e].$as):h.push(e));for(e=0;e<h.length;e++)if(c=this._queryReferencesCollection(a,h[e],""))g.joinQueries[f[e]]=c,g.queriesJoin=!0;g.joinsOn=f;g.queriesOn=g.queriesOn.concat(f)}return g};c.prototype._queryReferencesCollection=function(a,c,b){for(var d in a)if(a.hasOwnProperty(d)){if(d===c)return b&&(b+="."),b+d;if("object"===typeof a[d])return b&&(b+="."),b+=d,this._queryReferencesCollection(a[d],c,b)}return!1};c.prototype._match=function(a,c,b){var d,g;d=typeof a;
g=typeof c;var e=!0,f;if(!("string"!==d&&"number"!==d||"string"!==g&&"number"!==g))a!==c&&(e=!1);else for(f in c)if(c.hasOwnProperty(f)){d=!1;if("$"===f.substr(0,1))switch(f){case "$gt":if(a>c[f]){if("or"===b)return!0}else e=!1;d=!0;break;case "$gte":if(a>=c[f]){if("or"===b)return!0}else e=!1;d=!0;break;case "$lt":if(a<c[f]){if("or"===b)return!0}else e=!1;d=!0;break;case "$lte":if(a<=c[f]){if("or"===b)return!0}else e=!1;d=!0;break;case "$exists":if(void 0===a!==c[f]){if("or"===b)return!0}else e=!1;
d=!0;break;case "$or":d=!0;for(g=0;g<c[f].length;g++){if(this._match(a,c[f][g],"and"))return!0;e=!1}break;case "$and":d=!0;for(g=0;g<c[f].length;g++)if(!this._match(a,c[f][g],"and"))return!1;break;case "$in":if(c[f]instanceof Array){d=c[f];g=d.length;var h,l=!1;for(h=0;h<g;h++)if(d[h]===a){l=!0;break}if(l){if("or"===b)return!0}else e=!1}else throw"Cannot use a $nin operator on a non-array key: "+f;d=!0;break;case "$nin":if(c[f]instanceof Array){d=c[f];g=d.length;l=!0;for(h=0;h<g;h++)if(d[h]===a){l=
!1;break}if(l){if("or"===b)return!0}else e=!1}else throw"Cannot use a $nin operator on a non-array key: "+f;d=!0;break;case "$ne":if(a!=c[f]){if("or"===b)return!0}else e=!1;d=!0}if(!d&&c[f]instanceof RegExp)if(d=!0,"object"===typeof a&&void 0!==a[f]&&c[f].test(a[f])){if("or"===b)return!0}else e=!1;if(!d)if("object"===typeof c[f])if(void 0!==a[f]){if(a[f]instanceof Array&&!(c[f]instanceof Array))for(d=!1,g=0;g<a[f].length&&!(d=this._match(a[f][g],c[f],void 0));g++);else if(!(a[f]instanceof Array)&&
c[f]instanceof Array)for(d=!1,g=0;g<c[f].length&&!(d=this._match(a[f],c[f][g],void 0));g++);else d="object"===typeof a?this._match(a[f],c[f],void 0):this._match(void 0,c[f],void 0);if(d){if("or"===b)return!0}else e=!1}else if(c[f]&&void 0!==c[f].$exists)if(d=this._match(void 0,c[f],void 0)){if("or"===b)return!0}else e=!1;else e=!1;else if(a&&a[f]===c[f]){if("or"===b)return!0}else if(a&&a[f]&&a[f]instanceof Array&&c[f]&&"object"!==typeof c[f]){d=!1;for(g=0;g<a[f].length&&!(d=this._match(a[f][g],c[f],
void 0));g++);if(d){if("or"===b)return!0}else e=!1}else e=!1;if("and"===b&&!e)return!1}return e};c.prototype.count=function(a,c){return a?this.find(a,c).length:this._data.length};c.prototype.link=function(a,c){this._links=this._links||{};if(!this._links[c]){if($(a).length){if(!$.templates[c]){var b=$(c);if(b.length)$.views.templates(c,$(b[0]).html());else throw"Unable to bind collection to target because template does not exist: "+c;}$.templates[c].link(a,this._data);this._links[c]=a;this._linked++;
this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+a);return this}throw'Cannot bind view data to output target selector "'+a+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+a+" with the template: "+c;};c.prototype.unlink=function(a,c){this._links=this._links||{};if(this._links[c])return $.templates[c].unlink(a),delete this._links[c],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+
this.name()+'" to output target: '+a),this;console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+c)};c.prototype.findSub=function(a,c,b,g){var e=new d(c);a=this.find(a);var f=a.length,h,l,n=this._db.collection("__FDB_temp_"+this.objectId()),p={parents:f,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(h=0;h<f;h++)if(l=e.value(a[h])[0]){n.setData(l);l=n.find(b,g);if(g.returnFirst&&l.length)return l[0];p.subDocs.push(l);p.subDocTotal+=l.length;p.pathFound=!0}n.drop();
if(g.noStats)return p.subDocs;p.pathFound||(p.err="No objects found in the parent documents with a matching path of: "+c);return p};c.prototype.insertIndexViolation=function(a){var c,b=this._indexByName,d,g;if(this._primaryIndex.get(a[this._primaryKey]))c=this._primaryIndex;else for(d in b)if(b.hasOwnProperty(d)&&(g=b[d],g.unique()&&g.violation(a))){c=g;break}return c?c.name():!1};c.prototype.ensureIndex=function(c,b){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var d=
new a(c,b,this),g={start:(new Date).getTime()};if(this._indexByName[d.name()])return{err:"Index with that name already exists"};if(this._indexById[d.id()])return{err:"Index with those keys already exists"};d.rebuild();this._indexByName[d.name()]=d;this._indexById[d.id()]=d;g.end=(new Date).getTime();g.total=g.end-g.start;this._lastOp={type:"ensureIndex",stats:{time:g}};return{index:d,id:d.id(),name:d.name(),state:d.state()}};c.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};
c.prototype.lastOp=function(){return this._metrics.list()};c.prototype.objectId=function(a){var c=Math.pow(10,17);if(a){var b=0,d=a.length,g;for(g=0;g<d;g++)b+=a.charCodeAt(g)*c;a=b.toString(16)}else f.idCounter++,a=(f.idCounter+(Math.random()*c+Math.random()*c+Math.random()*c+Math.random()*c)).toString(16);return a};c.prototype.diff=function(a){var c={insert:[],update:[],remove:[]},b=this.primaryKey(),d,g,e,f;if(b===a.primaryKey()){d=a._data;f=d.length;for(g=0;g<f;g++)e=d[g],this._primaryIndex.get(e[b])?
this._primaryCrc.get(e[b])!==a._primaryCrc.get(e[b])&&c.update.push(e):c.insert.push(e);d=this._data;f=d.length;for(g=0;g<f;g++)e=d[g],a._primaryIndex.get(e[b])||c.remove.push(e)}return c};h.prototype.collection=function(a,b){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new c(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),this._collection[a];throw"Cannot get collection with undefined name!";};h.prototype.collectionExists=
function(a){return Boolean(this._collection[a])};h.prototype.collections=function(){var a=[],c;for(c in this._collection)this._collection.hasOwnProperty(c)&&a.push({name:c,count:this._collection[c].count()});return a};n.exports=c},{"./Crc":5,"./Index":7,"./KeyValueStore":8,"./Metrics":9,"./Overload":13,"./Path":14,"./Shared":16}],3:[function(h,n,l){var f,b,e;l=h("./Shared");var d=function(){this.init.apply(this,arguments)};d.prototype.init=function(a){var b=this;this._name=a;this._collectionArr=[];
this._views=[];this._onCollectionInsert=function(){b._onInsert.apply(b,arguments)};this._onCollectionUpdate=function(){b._onUpdate.apply(b,arguments)};this._onCollectionRemove=function(){b._onRemove.apply(b,arguments)};this._onCollectionChange=function(){b._onChange.apply(b,arguments)}};l.modules.CollectionGroup=d;b=h("./Collection");e=h("./Overload");h=l.modules.Core;f=l.modules.Core.prototype.init;d.prototype.on=new e([function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||
{};this._listeners[a]["*"]=this._listeners[a]["*"]||[];this._listeners[a]["*"].push(b);return this},function(a,b,c){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||{};this._listeners[a][b]=this._listeners[a][b]||[];this._listeners[a][b].push(c);return this}]);d.prototype.off=new e([function(a){this._listeners&&this._listeners[a]&&a in this._listeners&&delete this._listeners[a];return this},function(a,b){var c,d;"string"===typeof b?this._listeners&&this._listeners[a]&&this._listeners[a][b]&&
delete this._listeners[a][b]:a in this._listeners&&(c=this._listeners[a]["*"],d=c.indexOf(b),-1<d&&c.splice(d,1));return this},function(a,b,c){this._listeners&&a in this._listeners&&(a=this._listeners[a][b],c=a.indexOf(c),-1<c&&a.splice(c,1))}]);d.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){if(this._listeners[a]["*"]){var c=this._listeners[a]["*"],d=c.length,e;for(e=0;e<d;e++)c[e].apply(this,Array.prototype.slice.call(arguments,1))}if(b instanceof Array&&
b[0]&&b[0][this._primaryKey]){var c=this._listeners[a],f,h,d=b.length;for(e=0;e<d;e++)if(c[b[e][this._primaryKey]])for(f=c[b[e][this._primaryKey]].length,h=0;h<f;h++)c[b[e][this._primaryKey]][h].apply(this,Array.prototype.slice.call(arguments,1))}}return this};d.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};d.prototype.addCollection=function(a){if(a&&-1===this._collectionArr.indexOf(a)){if(this._collectionArr.length){if(this._primaryKey!==a.primaryKey())throw"All collections in a collection group must have the same primary key!";
}else this._primaryKey=a.primaryKey();this._collectionArr.push(a);a._groups.push(this);a.on("insert",this._onCollectionInsert);a.on("update",this._onCollectionUpdate);a.on("remove",this._onCollectionRemove);a.on("change",this._onCollectionChange)}return this};d.prototype.removeCollection=function(a){if(a){var b=this._collectionArr.indexOf(a);-1!==b&&(a.off("insert",this._onCollectionInsert),a.off("update",this._onCollectionUpdate),a.off("remove",this._onCollectionRemove),a.off("change",this._onCollectionChange),
this._collectionArr.splice(b,1),b=a._groups.indexOf(this),-1!==b&&a._groups.splice(b,1));0===this._collectionArr.length&&delete this._primaryKey}return this};d.prototype.find=function(a,d){var c=(new b).primaryKey(this._collectionArr[0].primaryKey()),e;for(e=0;e<this._collectionArr.length;e++)c.insert(this._collectionArr[e].find(a));return c.find(a,d)};d.prototype.insert=function(a,b){for(var c=0;c<this._collectionArr.length;c++)this._collectionArr[c].insert(a,b)};d.prototype.update=function(a,b){for(var c=
0;c<this._collectionArr.length;c++)this._collectionArr[c].update(a,b)};d.prototype.updateById=function(a,b){for(var c=0;c<this._collectionArr.length;c++)this._collectionArr[c].updateById(a,b)};d.prototype.remove=function(a){for(var b=0;b<this._collectionArr.length;b++)this._collectionArr[b].remove(a)};d.prototype.removeById=function(a){for(var b=0;b<this._collectionArr.length;b++)this._collectionArr[b].removeById(a)};d.prototype._onInsert=function(a,b){this.emit("insert",a,b)};d.prototype._onUpdate=
function(a,b){this.emit("update",a,b)};d.prototype._onRemove=function(a,b){this.emit("remove",a,b)};d.prototype._onChange=function(){this.emit("change")};d.prototype.subset=function(a,d){var c=this.find(a,d);return(new b)._subsetOf(this).primaryKey(this._primaryKey).setData(c)};d.prototype.drop=function(){var a,b=[].concat(this._collectionArr),c=[].concat(this._views);this._debug&&console.log("Dropping collection group "+this._name);for(a=0;a<b.length;a++)this.removeCollection(b[a]);for(a=0;a<c.length;a++)this._removeView(c[a]);
this.emit("drop");return!0};h.prototype.init=function(){this._collectionGroup={};f.apply(this,arguments)};h.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new d(a)).db(this),this._collectionGroup[a]):this._collectionGroup};n.exports=d},{"./Collection":2,"./Overload":13,"./Shared":16}],4:[function(h,n,l){var f,b;f=h("./Shared.js");var e=function(){this.init.apply(this,arguments)};e.prototype.init=function(){this._collection={};this._debug={}};f.modules.Core=
e;l=h("./Overload.js");b=h("./Collection.js");h("./Metrics.js");h=h("./Crc.js");e.prototype._isServer=!1;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.crc=h;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.decouple=function(b){return JSON.parse(JSON.stringify(b))};e.prototype.debug=new l([function(){return this._debug.all},function(b){return void 0!==
b&&"boolean"===typeof b?(this._debug.all=b,this):this._debug.all},function(b,a){return void 0!==b?void 0!==a?(this._debug[b]=a,this):this._debug[b]:this._debug.all}]);e.prototype.arrayToCollection=function(d){return(new b).setData(d)};e.prototype.on=function(b,a){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||[];this._listeners[b].push(a);return this};e.prototype.off=function(b,a){if(b in this._listeners){var e=this._listeners[b],c=e.indexOf(a);-1<c&&e.splice(c,1)}return this};
e.prototype.emit=function(b,a){this._listeners=this._listeners||{};if(b in this._listeners){var e=this._listeners[b],c=e.length,k;for(k=0;k<c;k++)e[k].apply(this,Array.prototype.slice.call(arguments,1))}return this};e.prototype.objectId=function(b){var a,e,c=Math.pow(10,17),k;if(b){a=0;e=b.length;for(k=0;k<e;k++)a+=b.charCodeAt(k)*c;b=a.toString(16)}else f.idCounter++,b=(f.idCounter+(Math.random()*c+Math.random()*c+Math.random()*c+Math.random()*c)).toString(16);return b};e.prototype.peek=function(b){var a,
e,c=[],k=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(e=this._collection[a],c="string"===k?c.concat(e.peek(b)):c.concat(e.find(b)));return c};e.prototype.peekCat=function(b){var a,e,c={},k,f=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(e=this._collection[a],(k="string"===f?e.peek(b):e.find(b))&&k.length&&(c[e.name()]=k));return c};n.exports=e},{"./Collection.js":2,"./Crc.js":5,"./Metrics.js":9,"./Overload.js":13,"./Shared.js":16}],5:[function(h,
n,l){var f=function(){var b=[],e,d,a;for(d=0;256>d;d++){e=d;for(a=0;8>a;a++)e=e&1?3988292384^e>>>1:e>>>1;b[d]=e}return b}();n.exports=function(b){var e=-1,d;for(d=0;d<b.length;d++)e=e>>>8^f[(e^b.charCodeAt(d))&255];return(e^-1)>>>0}},{}],6:[function(h,n,l){var f;h=h("./Shared");var b=function(b,d){this.init.apply(this,arguments)};b.prototype.init=function(b,d){this._options=d;this._selector=$(this._options.selector);this._listeners={};this._collection=b;this._options.series=[];var a,g;switch(this._options.type){case "pie":this._selector.highcharts(this._options.chartOptions);
this._chart=this._selector.highcharts();a=this._collection.find();g={allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {y} ({point.percentage:.0f}%)",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}};a=this.pieDataFromCollectionData(a,this._options.keyField,this._options.valField);$.extend(g,this._options.seriesOptions);$.extend(g,{type:"pie",name:this._options.seriesName,data:a});this._chart.addSeries(g);break;case "line":a=this.lineDataFromCollectionData(this._options.seriesField,
this._options.keyField,this._options.valField,this._options.orderBy),this._options.chartOptions.xAxis=a.xAxis,this._options.chartOptions.series=a.series,this._selector.highcharts(this._options.chartOptions),this._chart=this._selector.highcharts()}this._hookEvents()};h=h.modules.Collection;f=h.prototype.init;b.prototype.pieDataFromCollectionData=function(b,d,a){var g=[],c;for(c=0;c<b.length;c++)g.push([b[c][d],b[c][a]]);return g};b.prototype.lineDataFromCollectionData=function(b,d,a,g){var c=this._collection.distinct(b),
k=[],f={categories:[]},h,l,n,w,v;for(w=0;w<c.length;w++){h=c[w];l={};l[b]=h;n=[];l=this._collection.find(l,{orderBy:g});for(v=0;v<l.length;v++)f.categories.push(l[v][d]),n.push(l[v][a]);k.push({name:h,data:n})}return{xAxis:f,series:k}};b.prototype._hookEvents=function(){this._collection.on("change",this._changeListener);this._collection.on("drop",this._dropListener)};b.prototype._changeListener=function(){if("undefined"!==typeof this._collection&&this._chart){var b=this._collection.find();switch(this._options.type){case "pie":this._chart.series[0].setData(this.pieDataFromCollectionData(b,
this._options.keyField,this._options.valField));break;case "line":b=this.lineDataFromCollectionData(this._options.seriesField,this._options.keyField,this._options.valField,this._options.orderBy);this._chart.xAxis[0].setCategories(b.xAxis.categories);for(var d=0;d<b.series.length;d++)this._chart.series[d].setData(b.series[d].data)}}};b.prototype._dropListener=function(){this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener)};b.prototype.drop=function(){this._chart.destroy();
this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener);delete this._collection._highcharts[this._options.selector];delete this._chart;delete this._options;delete this._collection;return this};h.prototype.init=function(){this._highcharts={};f.apply(this,arguments)};h.prototype.chart=function(e){this._highcharts[e.selector]||(this._highcharts[e.selector]=new b(this,e));return this._highcharts[e.selector]};h.prototype.dropChart=function(b){this._highcharts[b]&&
this._highcharts[b].drop()};n.exports=b},{"./Shared":16}],7:[function(h,n,l){l=h("./Shared");var f=h("./Path");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(b,e,d){this._crossRef={};this._size=0;this._id=this._itemKeyHash(b,b);this.data({});this.unique(e&&e.unique?e.unique:!1);void 0!==b&&this.keys(b);void 0!==d&&this.collection(d);this.name(e&&e.name?e.name:this._id)};l.modules.Index=h;h.prototype.id=function(){return this._id};h.prototype.state=function(){return this._state};
h.prototype.size=function(){return this._size};h.prototype.data=function(b){return void 0!==b?(this._data=b,this):this._data};h.prototype.name=function(b){return void 0!==b?(this._name=b,this):this._name};h.prototype.collection=function(b){return void 0!==b?(this._collection=b,this):this._collection};h.prototype.keys=function(b){return void 0!==b?(this._keys=b,this._keyCount=(new f).parse(this._keys).length,this):this._keys};h.prototype.type=function(b){return void 0!==b?(this._type=b,this):this._type};
h.prototype.unique=function(b){return void 0!==b?(this._unique=b,this):this._unique};h.prototype.rebuild=function(){if(this._collection){var b=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),e,d=b.length;this._data={};this._unique&&(this._uniqueLookup={});for(e=0;e<d;e++)this.insert(b[e])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};h.prototype.insert=function(b,e){var d,a;this._unique&&(d=this._itemHash(b,this._keys),this._uniqueLookup[d]=
b);d=this._itemHashArr(b,this._keys);for(a=0;a<d.length;a++)this.pushToPathValue(d[a],b)};h.prototype.remove=function(b,e){var d,a;this._unique&&(d=this._itemHash(b,this._keys),delete this._uniqueLookup[d]);d=this._itemHashArr(b,this._keys);for(a=0;a<d.length;a++)this.pullFromPathValue(d[a],b)};h.prototype.violation=function(b){b=this._itemHash(b,this._keys);return Boolean(this._uniqueLookup[b])};h.prototype.hashViolation=function(b){return Boolean(this._uniqueLookup[b])};h.prototype.pushToPathValue=
function(b,e){var d=this._data[b]=this._data[b]||[];-1===d.indexOf(e)&&(d.push(e),this._size++,this.pushToCrossRef(e,d))};h.prototype.pullFromPathValue=function(b,e){var d=this._data[b],a;a=d.indexOf(e);-1<a&&(d.splice(a,1),this._size--,this.pullFromCrossRef(e,d));d.length||delete this._data[b]};h.prototype.pull=function(b){var e=b[this._collection.primaryKey()],d=this._crossRef[e],a,g=d.length,c;for(a=0;a<g;a++)c=d[a],this._pullFromArray(c,b);this._size--;delete this._crossRef[e]};h.prototype._pullFromArray=
function(b,e){for(var d=b.length;d--;)b[d]===e&&b.splice(d,1)};h.prototype.pushToCrossRef=function(b,e){var d=b[this._collection.primaryKey()];this._crossRef[d]=this._crossRef[d]||[];d=this._crossRef[d];-1===d.indexOf(e)&&d.push(e)};h.prototype.pullFromCrossRef=function(b,e){var d=b[this._collection.primaryKey()];delete this._crossRef[d]};h.prototype.lookup=function(b){return this._data[this._itemHash(b,this._keys)]||[]};h.prototype.match=function(b,e){return(new f).countObjectPaths(this._keys,b)};
h.prototype._itemHash=function(b,e){var d=new f,a,g="",c;a=d.parse(e);for(c=0;c<a.length;c++)g&&(g+="_"),g+=d.value(b,a[c].path).join(":");return g};h.prototype._itemKeyHash=function(b,e){var d=new f,a,g="",c;a=d.parse(e);for(c=0;c<a.length;c++)g&&(g+="_"),g+=d.keyValue(b,a[c].path);return g};h.prototype._itemHashArr=function(b,e){var d=new f,a,g=[],c,k,h,l;a=d.parse(e);for(h=0;h<a.length;h++)for(c=d.value(b,a[h].path),k=0;k<c.length;k++)if(0===h)g.push(c[k]);else for(l=0;l<g.length;l++)g[l]=g[l]+
"_"+c[k];return g};n.exports=h},{"./Path":14,"./Shared":16}],8:[function(h,n,l){h=h("./Shared");l=function(f){this.init.apply(this,arguments)};l.prototype.init=function(f){this._name=f;this._data={};this._primaryKey="_id"};h.modules.KeyValueStore=l;l.prototype.name=function(f){return void 0!==f?(this._name=f,this):this._name};l.prototype.primaryKey=function(f){return void 0!==f?(this._primaryKey=f,this):this._primaryKey};l.prototype.truncate=function(){this._data={};return this};l.prototype.set=function(f,
b){this._data[f]=b?b:!0;return this};l.prototype.get=function(f){return this._data[f]};l.prototype.lookup=function(f){f=f[this._primaryKey];var b,e,d,a;if(f instanceof Array){e=f.length;a=[];for(b=0;b<e;b++)(d=this._data[f[b]])&&a.push(d);return a}if(f instanceof RegExp){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&f.test(b)&&a.push(this._data[b]);return a}if("object"===typeof f){if(f.$ne){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&b!==f.$ne&&a.push(this._data[b]);return a}if(f.$in&&
f.$in instanceof Array){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&-1<f.$in.indexOf(b)&&a.push(this._data[b]);return a}if(f.$nin&&f.$nin instanceof Array){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&-1===f.$nin.indexOf(b)&&a.push(this._data[b]);return a}if(f.$or&&f.$or instanceof Array){a=[];for(b=0;b<f.$or.length;b++)a=a.concat(this.lookup(f.$or[b]));return a}}else return d=this._data[f],void 0!==d?[d]:[]};l.prototype.unSet=function(f){delete this._data[f];return this};l.prototype.uniqueSet=
function(f,b){return void 0===this._data[f]?(this._data[f]=b,!0):!1};n.exports=l},{"./Shared":16}],9:[function(h,n,l){l=h("./Shared");var f=h("./Operation");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(){this._data=[]};l.modules.Metrics=h;h.prototype.create=function(b){b=new f(b);this._enabled&&this._data.push(b);return b};h.prototype.start=function(){this._enabled=!0;return this};h.prototype.stop=function(){this._enabled=!1;return this};h.prototype.clear=function(){this._data=
[];return this};h.prototype.list=function(){return this._data};n.exports=h},{"./Operation":12,"./Shared":16}],10:[function(h,n,l){var f;h=h("./Shared").modules.OldView;f=h.prototype.init;h.prototype.init=function(){var b=this;this._binds=[];this._renderEnd=this._renderStart=0;this._deferQueue={insert:[],update:[],remove:[],upsert:[],_bindInsert:[],_bindUpdate:[],_bindRemove:[],_bindUpsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100,_bindInsert:100,_bindUpdate:100,_bindRemove:100,
_bindUpsert:100};this._deferTime={insert:100,update:1,remove:1,upsert:1,_bindInsert:100,_bindUpdate:1,_bindRemove:1,_bindUpsert:1};f.apply(this,arguments);this.on("insert",function(e,d){b._bindEvent("insert",e,d)});this.on("update",function(e,d){b._bindEvent("update",e,d)});this.on("remove",function(e,d){b._bindEvent("remove",e,d)});this.on("change",b._bindChange)};h.prototype.bind=function(b,e){if(e&&e.template)this._binds[b]=e;else throw"Cannot bind data to element, missing options information!";
return this};h.prototype.unBind=function(b){delete this._binds[b];return this};h.prototype.isBound=function(b){return Boolean(this._binds[b])};h.prototype.bindSortDom=function(b,e){var d=$(b),a,g,c;this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting data in DOM...",e);for(a=0;a<e.length;a++)g=e[a],c=d.find("#"+g[this._primaryKey]),c.length?0===a?(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index 0...",c),d.prepend(c)):(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index "+
a+"...",c),c.insertAfter(d.children(":eq("+(a-1)+")"))):this.debug()&&console.log("ForerunnerDB.OldView.Bind: Warning, element for array item not found!",g)};h.prototype.bindRefresh=function(b){var e=this._binds,d,a;b||(b={data:this.find()});for(d in e)e.hasOwnProperty(d)&&(a=e[d],this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting DOM..."),this.bindSortDom(d,b.data),a.afterOperation&&a.afterOperation(),a.refresh&&a.refresh())};h.prototype.bindRender=function(b,e){var d=this._binds[b],a=
$(b),g,c,k=$("<ul></ul>"),f;if(d){g=this._data.find();for(f=0;f<g.length;f++)c=g[f],d.template(c,function(a){k.append(a)});e?e(b,k.html()):a.append(k.html())}};h.prototype.processQueue=function(b,e){var d=this._deferQueue[b],a=this._deferThreshold[b],g=this._deferTime[b];if(d.length){var c=this;d.length&&(d=d.length>a?d.splice(0,a):d.splice(0,d.length),this._bindEvent(b,d,[]));setTimeout(function(){c.processQueue(b,e)},g)}else e&&e(),this.emit("bindQueueComplete")};h.prototype._bindEvent=function(b,
e,d){var a=this._binds,g=this.find({}),c,k;for(k in a)if(a.hasOwnProperty(k))switch(c=a[k].reduce?this.find(a[k].reduce.query,a[k].reduce.options):g,b){case "insert":this._bindInsert(k,a[k],e,d,c);break;case "update":this._bindUpdate(k,a[k],e,d,c);break;case "remove":this._bindRemove(k,a[k],e,d,c)}};h.prototype._bindChange=function(b){this.debug()&&console.log("ForerunnerDB.OldView.Bind: Bind data change, refreshing bind...",b);this.bindRefresh(b)};h.prototype._bindInsert=function(b,e,d,a,g){var c=
$(b),k;for(k=0;k<d.length;k++)b=c.find("#"+d[k][this._primaryKey]),b.length||e.template(d[k],function(a,b,d,k){return function(a){e.insert?e.insert(a,b,d,k):e.prependInsert?c.prepend(a):c.append(a);e.afterInsert&&e.afterInsert(a,b,d,k)}}(b,d[k],a,g))};h.prototype._bindUpdate=function(b,e,d,a,g){var c=$(b);for(a=0;a<d.length;a++)b=c.find("#"+d[a][this._primaryKey]),e.template(d[a],function(a,b){return function(d){e.update?e.update(d,b,g,a.length?"update":"append"):a.length?a.replaceWith(d):e.prependUpdate?
c.prepend(d):c.append(d);e.afterUpdate&&e.afterUpdate(d,b,g)}}(b,d[a]))};h.prototype._bindRemove=function(b,e,d,a,g){b=$(b);var c;for(c=0;c<d.length;c++)a=b.find("#"+d[c][this._primaryKey]),a.length&&(e.beforeRemove?e.beforeRemove(a,d[c],g,function(a,c,b){return function(){e.remove?e.remove(a,c,b):(a.remove(),e.afterRemove&&e.afterRemove(a,c,b))}}(a,d[c],g)):e.remove?e.remove(a,d[c],g):(a.remove(),e.afterRemove&&e.afterRemove(a,d[c],g)))}},{"./Shared":16}],11:[function(h,n,l){var f,b,e,d,a;f=h("./Shared");
var g=function(){this.init.apply(this,arguments)};g.prototype.init=function(a){var b=this;this._name=a;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromSetData=function(){b._onSetData.apply(b,arguments)};this._onFromInsert=function(){b._onInsert.apply(b,arguments)};this._onFromUpdate=function(){b._onUpdate.apply(b,arguments)};this._onFromRemove=function(){b._onRemove.apply(b,arguments)};this._onFromChange=function(){b.debug()&&console.log("ForerunnerDB.OldView: Received change");
b._onChange.apply(b,arguments)}};f.modules.OldView=g;l=h("./CollectionGroup");b=h("./Collection");e=b.prototype.init;d=l.prototype.init;h=h("./Overload");f=f.modules.Core;a=f.prototype.init;g.prototype.on=new h([function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||{};this._listeners[a]["*"]=this._listeners[a]["*"]||[];this._listeners[a]["*"].push(b);return this},function(a,b,d){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||{};this._listeners[a][b]=
this._listeners[a][b]||[];this._listeners[a][b].push(d);return this}]);g.prototype.off=new h([function(a){this._listeners&&this._listeners[a]&&a in this._listeners&&delete this._listeners[a];return this},function(a,b){var d,e;"string"===typeof b?this._listeners&&this._listeners[a]&&this._listeners[a][b]&&delete this._listeners[a][b]:a in this._listeners&&(d=this._listeners[a]["*"],e=d.indexOf(b),-1<e&&d.splice(e,1));return this},function(a,b,d){this._listeners&&a in this._listeners&&(a=this._listeners[a][b],
d=a.indexOf(d),-1<d&&a.splice(d,1))}]);g.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){if(this._listeners[a]["*"]){var d=this._listeners[a]["*"],e=d.length,g;for(g=0;g<e;g++)d[g].apply(this,Array.prototype.slice.call(arguments,1))}if(b instanceof Array&&b[0]&&b[0][this._primaryKey]){var d=this._listeners[a],f,h,e=b.length;for(g=0;g<e;g++)if(d[b[g][this._primaryKey]])for(f=d[b[g][this._primaryKey]].length,h=0;h<f;h++)d[b[g][this._primaryKey]][h].apply(this,
Array.prototype.slice.call(arguments,1))}}return this};g.prototype.drop=function(){return(this._db||this._from)&&this._name?(this.debug()&&console.log("ForerunnerDB.OldView: Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._oldViews[this._name],this._from&&delete this._from._oldViews[this._name],!0):!1};g.prototype.debug=function(){return!1};g.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};g.prototype.from=function(a){if(void 0!==a){if("string"===typeof a)if(this._db.collectionExists(a))a=
this._db.collection(a);else throw"Invalid collection in view.from() call.";this._from!==a&&(this._from&&this.removeFrom(),this.addFrom(a));return this}return this._from};g.prototype.addFrom=function(a){if(this._from=a)return this._from.on("setData",this._onFromSetData),this._from.on("change",this._onFromChange),this._from._addOldView(this),this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";};g.prototype.removeFrom=function(){this._from.off("setData",
this._onFromSetData);this._from.off("change",this._onFromChange);this._from._removeOldView(this)};g.prototype.primaryKey=function(){if(this._from)return this._from.primaryKey()};g.prototype.queryData=function(a,b,d){void 0!==a&&(this._query.query=a);void 0!==b&&(this._query.options=b);return void 0!==a||void 0!==b?(void 0!==d&&!0!==d||this.refresh(),this):this._query};g.prototype.queryAdd=function(a,b,d){var e=this._query.query,g;if(void 0!==a)for(g in a)a.hasOwnProperty(g)&&(void 0===e[g]||void 0!==
e[g]&&b)&&(e[g]=a[g]);void 0!==d&&!0!==d||this.refresh()};g.prototype.queryRemove=function(a,b){var d=this._query.query,e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&delete d[e];void 0!==b&&!0!==b||this.refresh()};g.prototype.query=function(a,b){return void 0!==a?(this._query.query=a,void 0!==b&&!0!==b||this.refresh(),this):this._query.query};g.prototype.queryOptions=function(a,b){return void 0!==a?(this._query.options=a,void 0!==b&&!0!==b||this.refresh(),this):this._query.options};g.prototype.refresh=
function(a){if(this._from){var b=this._data,d,e,g,f,h,l=[],n=[],t=[],p;this.debug()&&(console.log("ForerunnerDB.OldView: Refreshing view "+this._name),console.log("ForerunnerDB.OldView: Existing data: "+("undefined"!==typeof this._data)),"undefined"!==typeof this._data&&console.log("ForerunnerDB.OldView: Current data rows: "+this._data.find().length));this._query?(this.debug()&&console.log("ForerunnerDB.OldView: View has query and options, getting subset..."),this._data=this._from.subset(this._query.query,
this._query.options)):this._query.options?(this.debug()&&console.log("ForerunnerDB.OldView: View has options, getting subset..."),this._data=this._from.subset({},this._query.options)):(this.debug()&&console.log("ForerunnerDB.OldView: View has no query or options, getting subset..."),this._data=this._from.subset({}));if(!a&&b)if(this.debug()&&console.log("ForerunnerDB.OldView: Refresh not forced, old data detected..."),e=this._data,b.subsetOf()===e.subsetOf()){this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from same collection...");
g=e.find();a=b.find();f=e._primaryKey;for(p=0;p<g.length;p++)h=g[p],d={},d[f]=h[f],(d=b.find(d)[0])?JSON.stringify(d)!==JSON.stringify(h)&&n.push(h):l.push(h);for(p=0;p<a.length;p++)h=a[p],d={},d[f]=h[f],e.find(d)[0]||t.push(h);this.debug()&&(console.log("ForerunnerDB.OldView: Removed "+t.length+" rows"),console.log("ForerunnerDB.OldView: Inserted "+l.length+" rows"),console.log("ForerunnerDB.OldView: Updated "+n.length+" rows"));l.length&&this._onInsert(l,[]);n.length&&this._onUpdate(n,[]);t.length&&
this._onRemove(t,[])}else this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from different collections..."),t=b.find(),t.length&&this._onRemove(t),l=e.find(),l.length&&this._onInsert(l);else this.debug()&&console.log("ForerunnerDB.OldView: Forcing data update",g),this._data=this._from.subset(this._query.query,this._query.options),g=this._data.find(),this.debug()&&console.log("ForerunnerDB.OldView: Emitting change event with data",g),this._onInsert(g,[]);this.debug()&&console.log("ForerunnerDB.OldView: Emitting change");
this.emit("change")}return this};g.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};g.prototype.find=function(){return this._data?(this.debug()&&console.log("ForerunnerDB.OldView: Finding data in view collection...",this._data),this._data.find.apply(this._data,arguments)):[]};g.prototype.insert=function(){return this._from?this._from.insert.apply(this._from,arguments):[]};g.prototype.update=function(){return this._from?this._from.update.apply(this._from,arguments):
[]};g.prototype.remove=function(){return this._from?this._from.remove.apply(this._from,arguments):[]};g.prototype._onSetData=function(a,b){this.emit("remove",b,[]);this.emit("insert",a,[])};g.prototype._onInsert=function(a,b){this.emit("insert",a,b)};g.prototype._onUpdate=function(a,b){this.emit("update",a,b)};g.prototype._onRemove=function(a,b){this.emit("remove",a,b)};g.prototype._onChange=function(){this.debug()&&console.log("ForerunnerDB.OldView: Refreshing data");this.refresh()};b.prototype.init=
function(){this._oldViews=[];e.apply(this,arguments)};b.prototype._addOldView=function(a){void 0!==a&&(this._oldViews[a._name]=a);return this};b.prototype._removeOldView=function(a){void 0!==a&&delete this._oldViews[a._name];return this};l.prototype.init=function(){this._oldViews=[];d.apply(this,arguments)};l.prototype._addOldView=function(a){void 0!==a&&(this._oldViews[a._name]=a);return this};l.prototype._removeOldView=function(a){void 0!==a&&delete this._oldViews[a._name];return this};f.prototype.init=
function(){this._oldViews={};a.apply(this,arguments)};f.prototype.oldView=function(a){this._oldViews[a]||this.debug()&&console.log("ForerunnerDB.OldView: Creating view "+a);this._oldViews[a]=this._oldViews[a]||(new g(a)).db(this);return this._oldViews[a]};f.prototype.oldViewExists=function(a){return Boolean(this._oldViews[a])};f.prototype.oldViews=function(){var a=[],b;for(b in this._oldViews)this._oldViews.hasOwnProperty(b)&&a.push({name:b,count:this._oldViews[b].count()});return a};n.exports=g},
{"./Collection":2,"./CollectionGroup":3,"./Overload":13,"./Shared":16}],12:[function(h,n,l){l=h("./Shared");var f=h("./Path");h=function(b){this.pathSolver=new f;this.counter=0;this.init.apply(this,arguments)};h.prototype.init=function(b){this._data={operation:b,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};l.modules.Operation=h;h.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};h.prototype.log=function(b){if(b){var e=
0<this._log.length?this._data.log[this._data.log.length-1].time:0;b={event:b,time:(new Date).getTime(),delta:0};this._data.log.push(b);e&&(b.delta=b.time-e);return this}return this._data.log};h.prototype.time=function(b){if(void 0!==b){var e=this._data.time.process,e=e[b]=e[b]||{};e.startMs?(e.stopMs=(new Date).getTime(),e.totalMs=e.stopMs-e.startMs,e.stepObj.totalMs=e.totalMs,delete e.stepObj):(e.startMs=(new Date).getTime(),e.stepObj={name:b},this._data.steps.push(e.stepObj));return this}return this._data.time};
h.prototype.flag=function(b,e){if(void 0!==b&&void 0!==e)this._data.flag[b]=e;else return void 0!==b?this._data.flag[b]:this._data.flag};h.prototype.data=function(b,e,d){return void 0!==e?(this.pathSolver.set(this._data,b,e),this):this.pathSolver.get(this._data,b)};h.prototype.pushData=function(b,e,d){this.pathSolver.push(this._data,b,e)};h.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};n.exports=h},{"./Path":14,
"./Shared":16}],13:[function(h,n,l){l=function(f){if(f){var b,e=f.length;return function(){for(b=0;b<e;b++)if(f[b].length===arguments.length)return f[b].apply(this,arguments);return null}}return function(){}};h("./Shared").modules.Overload=l;n.exports=l},{"./Shared":16}],14:[function(h,n,l){h=h("./Shared");l=function(f){this.init.apply(this,arguments)};l.prototype.init=function(f){f&&this.path(f)};h.modules.Path=l;l.prototype.path=function(f){return void 0!==f?(this._path=this.clean(f),this._pathParts=
this._path.split("."),this):this._path};l.prototype.hasObjectPaths=function(f,b){var e=!0,d;for(d in f)if(f.hasOwnProperty(d)&&(void 0===b[d]||"object"===typeof f[d]&&(e=this.hasObjectPaths(f[d],b[d]),!e)))return!1;return e};l.prototype.countKeys=function(f){var b=0,e;for(e in f)f.hasOwnProperty(e)&&void 0!==f[e]&&("object"!==typeof f[e]?b++:b+=this.countKeys(f[e]));return b};l.prototype.countObjectPaths=function(f,b){var e,d={},a=0,g=0,c;for(c in b)b.hasOwnProperty(c)&&("object"===typeof b[c]?(e=
this.countObjectPaths(f[c],b[c]),d[c]=e.matchedKeys,g+=e.totalKeyCount,a+=e.matchedKeyCount):(g++,f&&f[c]&&"object"!==typeof f[c]?(d[c]=!0,a++):d[c]=!1));return{matchedKeys:d,matchedKeyCount:a,totalKeyCount:g}};l.prototype.parse=function(f,b){var e=[],d="",a,g,c;for(g in f)if(f.hasOwnProperty(g))if(d=g,"object"===typeof f[g])if(b)for(a=this.parse(f[g],b),c=0;c<a.length;c++)e.push({path:d+"."+a[c].path,value:a[c].value});else for(a=this.parse(f[g]),c=0;c<a.length;c++)e.push({path:d+"."+a[c].path});
else b?e.push({path:d,value:f[g]}):e.push({path:d});return e};l.prototype.parseArr=function(f,b){b=b||{};return this._parseArr(f,"",[],b)};l.prototype._parseArr=function(f,b,e,d){var a,g="";b=b||"";e=e||[];for(a in f)f.hasOwnProperty(a)&&(!d.ignore||d.ignore&&!d.ignore.test(a))&&(g=b?b+"."+a:a,"object"===typeof f[a]?this._parseArr(f[a],g,e,d):e.push(g));return e};l.prototype.value=function(f,b){if(void 0!==f&&"object"===typeof f){var e,d,a,g,c=[],k;void 0!==b&&(b=this.clean(b),e=b.split("."));e=e||
this._pathParts;d=e.length;a=f;for(k=0;k<d;k++){a=a[e[k]];if(g instanceof Array){for(d=0;d<g.length;d++)c=c.concat(this.value(g,d+"."+e[k]));return c}if(!a||"object"!==typeof a)break;g=a}return[a]}return[]};l.prototype.set=function(f,b,e){if(void 0!==f&&void 0!==b){var d;b=this.clean(b);b=b.split(".");d=b.shift();b.length?(f[d]=f[d]||{},this.set(f[d],b.join("."),e)):f[d]=e}return f};l.prototype.get=function(f,b){return this.value(f,b)[0]};l.prototype.push=function(f,b,e){if(void 0!==f&&void 0!==b){var d;
b=this.clean(b);b=b.split(".");d=b.shift();if(b.length)f[d]=f[d]||{},this.set(f[d],b.join("."),e);else if(f[d]=f[d]||[],f[d]instanceof Array)f[d].push(e);else throw"Cannot push to a path whose endpoint is not an array!";}return f};l.prototype.keyValue=function(f,b){var e,d,a,g,c;void 0!==b&&(b=this.clean(b),e=b.split("."));e=e||this._pathParts;d=e.length;a=f;for(c=0;c<d;c++)if(a=a[e[c]],!a||"object"!==typeof a){g=e[c]+":"+a;break}return g};l.prototype.clean=function(f){"."===f.substr(0,1)&&(f=f.substr(1,
f.length-1));return f};n.exports=l},{"./Shared":16}],15:[function(h,n,l){l=h("./Shared");var f,b,e,d;d=function(){this.init.apply(this,arguments)};d.prototype.init=function(a){a.isClient()&&void 0!==Storage&&this.mode("localStorage")};l.modules.Persist=d;l=l.modules.Core;f=h("./Collection");b=f.prototype.drop;h("./CollectionGroup");h("./Overload");e=l.prototype.init;d.prototype.mode=function(a){return void 0!==a?(this._mode=a,this):this._mode};d.prototype.save=function(a,b,c){switch(this.mode()){case "localStorage":b=
"object"===typeof b?"json::fdb::"+JSON.stringify(b):"raw::fdb::"+b;try{localStorage.setItem(a,b)}catch(d){c&&c(d)}c&&c(!1)}c&&c("No data handler.")};d.prototype.load=function(a,b){var c,d;switch(this.mode()){case "localStorage":try{c=localStorage.getItem(a)}catch(e){b(e,null)}if(c){c=c.split("::fdb::");switch(c[0]){case "json":d=JSON.parse(c[1]);break;case "raw":d=c[1]}b&&b(!1,d)}}b&&b("No data handler or unrecognised data type.")};d.prototype.drop=function(a,b){switch(this.mode()){case "localStorage":try{localStorage.removeItem(a)}catch(c){b&&
b(c)}b&&b(!1)}b&&b("No data handler or unrecognised data type.")};f.prototype.drop=function(a){if(a)if(this._name)if(this._db)this._db.persist.drop(this._name);else return callback&&callback("Cannot drop a collection's persistent storage when the collection is not attached to a database!"),"Cannot drop a collection's persistent storage when the collection is not attached to a database!";else return callback&&callback("Cannot drop a collection's persistent storage when no name assigned to collection!"),
"Cannot drop a collection's persistent storage when no name assigned to collection!";b.apply(this)};f.prototype.save=function(a){if(this._name)if(this._db)this._db.persist.save(this._name,this._data);else return a&&a("Cannot save a collection that is not attached to a database!"),"Cannot save a collection that is not attached to a database!";else return a&&a("Cannot save a collection with no assigned name!"),"Cannot save a collection with no assigned name!"};f.prototype.load=function(a){var b=this;
if(this._name)if(this._db)this._db.persist.load(this._name,function(c,d){if(c)return a&&a(c),c;d&&b.setData(d);a&&a(!1)});else return a&&a("Cannot load a collection that is not attached to a database!"),"Cannot load a collection that is not attached to a database!";else return a&&a("Cannot load a collection with no assigned name!"),"Cannot load a collection with no assigned name!"};l.prototype.init=function(){this.persist=new d(this);e.apply(this,arguments)};n.exports=d},{"./Collection":2,"./CollectionGroup":3,
"./Overload":13,"./Shared":16}],16:[function(h,n,l){n.exports={idCounter:0,modules:{},prototypes:{}}},{}],17:[function(h,n,l){var f,b,e;l=h("./Shared");var d=function(a,b,c){this.init.apply(this,arguments)};d.prototype.init=function(a,b,c){this._name=a;this._collections=[];this._groups=[];this._listeners={};this._querySettings={query:b,options:c};this._debug={};this._privateData=new f("__FDB__view_privateData_"+this._name)};l.modules.View=d;f=h("./Collection");h=h("./Overload");b=f.prototype.init;
l=l.modules.Core;e=l.prototype.init;d.prototype.debug=new h([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this.privateData().debug(a),this.publicData().debug(a),this):this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug[a]=b,this.privateData().debug(a,b),this.publicData().debug(a,b),this):this._debug[a]:this._debug.all}]);d.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};d.prototype.find=
function(a,b){return this.publicData().find(a,b)};d.prototype.insert=function(a,b,c){a=this._privateData.decouple(a);"function"===typeof b?(c=b,b=this._privateData.length):void 0===b&&(b=this._privateData.length);this._transformInsert(a,b);this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData._insertHandle(a,b,c)};d.prototype.update=function(a,b){this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+
this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');var c=this._privateData.update(a,b),d,e,f;if(this._transformEnabled&&this._transformIn){d=this._publicData.primaryKey();for(var h=0;h<c.length;h++)e={},f=c[h],e[d]=f[d],this._transformUpdate(e,f)}return c};d.prototype.remove=function(a){this._transformRemove(a);this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+
'"');return this._privateData.remove(a)};d.prototype.link=function(a,b){var c=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+a);return c.link(a,b)};d.prototype.unlink=function(a,b){var c=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+
a);return c.unlink(a,b)};d.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};d.prototype._addCollection=function(a){if(-1===this._collections.indexOf(a)){this._collections.push(a);a._addView(this);var b=a.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(a.primaryKey());this._transformInsert(b);this._privateData.primaryKey(a.primaryKey());this._privateData.insert(b)}return this};d.prototype._removeCollection=
function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options)));return this};d.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};d.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};d.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};d.prototype.drop=function(){if(this._collections&&
this._collections.length){(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);this._privateData.drop();return!0}return!1};d.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};d.prototype.primaryKey=function(){return this._privateData.primaryKey()};d.prototype.queryData=function(a,
b,c){void 0!==a&&(this._querySettings.query=a);void 0!==b&&(this._querySettings.options=b);return void 0!==a||void 0!==b?(void 0!==c&&!0!==c||this.refresh(),this):this._querySettings};d.prototype.queryAdd=function(a,b,c){var d=this._querySettings.query,e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&(void 0===d[e]||void 0!==d[e]&&b)&&(d[e]=a[e]);void 0!==c&&!0!==c||this.refresh()};d.prototype.queryRemove=function(a,b){var c=this._querySettings.query,d;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&
delete c[d];void 0!==b&&!0!==b||this.refresh()};d.prototype.query=function(a,b){return void 0!==a?(this._querySettings.query=a,void 0!==b&&!0!==b||this.refresh(),this):this._querySettings.query};d.prototype.queryOptions=function(a,b){return void 0!==a?(this._querySettings.options=a,void 0===a.decouple&&(a.decouple=!0),void 0!==b&&!0!==b||this.refresh(),this):this._querySettings.options};d.prototype.refresh=function(a){var b;a=this.publicData();var c;this._privateData.remove();a.remove();for(c=0;c<
this._collections.length;c++)b=this._collections[c],this._privateData.insert(b.find(this._querySettings.query,this._querySettings.options));b=this._privateData.find({},this._querySettings.options);a._linked?$.observable(a._data).refresh(b):(this._privateData._data.length=0,this._privateData._data=this._privateData._data.concat(b));return this};d.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};d.prototype.transform=function(a){return void 0!==
a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.privateData=function(){return this._privateData};d.prototype.publicData=function(){return this._transformEnabled?
this._publicData:this._privateData};d.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new f("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};d.prototype._transformInsert=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.insert(a,b)};d.prototype._transformUpdate=function(a,b){this._transformEnabled&&
this._publicData&&this._publicData.update(a,b)};d.prototype._transformRemove=function(a){this._transformEnabled&&this._publicData&&this._publicData.remove(a)};d.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};f.prototype.init=function(){this._views=[];b.apply(this,arguments)};f.prototype.view=function(a,b,c){a=(new d(a,b,c)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a};f.prototype._addView=
function(a){void 0!==a&&this._views.push(a);return this};f.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};l.prototype.init=function(){this._views={};e.apply(this,arguments)};l.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new d(a)).db(this);return this._views[a]};l.prototype.viewExists=function(a){return Boolean(this._views[a])};
l.prototype.views=function(){var a=[],b;for(b in this._views)this._views.hasOwnProperty(b)&&a.push({name:b,count:this._views[b].count()});return a};n.exports=d},{"./Collection":2,"./Overload":13,"./Shared":16}]},{},[1])(1)});
