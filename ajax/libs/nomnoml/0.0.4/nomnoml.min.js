!function(t){"function"==typeof define&&define.amd?define(["lodash","dagre"],t):"object"==typeof module&&module.exports?module.exports=t(require("lodash"),require("dagre")):this.nomnoml=t(_,dagre)}(function(t,e){var n=n||{};n.Canvas=function(t,e){function n(e){var n=t;return{x:e.clientX-n.getBoundingClientRect().left-n.clientLeft+n.scrollLeft,y:e.clientY-n.getBoundingClientRect().top-n.clientTop+n.scrollTop}}function i(t,e,n,i){var r=void 0===i?1:i,o=[Math.floor(t),Math.floor(e),Math.floor(n),r];return"rgba("+o.join()+")"}function r(t,e,n){n=void 0===n?1:n,e=e||{x:0,y:0},o.beginPath(),o.moveTo(e.x+n*t[0].x,e.y+n*t[0].y);for(var i=1,r=t.length;r>i;i++)o.lineTo(e.x+n*t[i].x,e.y+n*t[i].y);return a}var o=t.getContext("2d"),s={x:0,y:0},l=6.2832;e&&(t.addEventListener("mousedown",function(t){e.mousedown&&e.mousedown(n(t))}),t.addEventListener("mouseup",function(t){e.mouseup&&e.mouseup(n(t))}),t.addEventListener("mousemove",function(t){s=n(t),e.mousemove&&e.mousemove(n(t))}));var a={stroke:function(){return o.stroke(),a},fill:function(){return o.fill(),a},fillAndStroke:function(){return o.fill(),o.stroke(),a}};return{mousePos:function(){return s},width:function(){return t.width},height:function(){return t.height},ctx:o,background:function(e,n,r){o.fillStyle=i(e,n,r),o.fillRect(0,0,t.width,t.height)},clear:function(){o.clearRect(0,0,t.width,t.height)},circle:function(t,e,n){return o.beginPath(),2===arguments.length?o.arc(t.x,t.y,e,0,l):o.arc(t,e,n,0,l),a},ellipse:function(t,e,n,i,r){return void 0===i&&(i=0),void 0===r&&(r=l),o.beginPath(),o.save(),o.translate(t.x,t.y),o.scale(1,n/e),o.arc(0,0,e/2,i,r),o.restore(),a},arc:function(t,e,n,i,r){return o.beginPath(),o.moveTo(t,e),o.arc(t,e,n,i,r),a},roundRect:function(t,e,n,i,r){return o.beginPath(),o.moveTo(t+r,e),o.arcTo(t+n,e,t+n,e+r,r),o.lineTo(t+n,e+i-r),o.arcTo(t+n,e+i,t+n-r,e+i,r),o.lineTo(t+r,e+i),o.arcTo(t,e+i,t,e+i-r,r),o.lineTo(t,e+r),o.arcTo(t,e,t+r,e,r),o.closePath(),a},rect:function(t,e,n,i){return o.beginPath(),o.moveTo(t,e),o.lineTo(t+n,e),o.lineTo(t+n,e+i),o.lineTo(t,e+i),o.closePath(),a},path:r,circuit:function(t,e,n){return r(t,e,n),o.closePath(),a},colorNorm:function(t,e,n,r){return i(255*t,255*e,255*n,r)},color255:i,colorObjHSL:function(t,e,n){function i(t){var i=Math.cos(6.283*t)/2+.5;return n*(1-e+e*i*i)}return{r:i(t),g:i(t-1/3),b:i(t+1/3)}},radialGradient:function(t,e,n,i,r){var s=o.createRadialGradient(t,e,n,t,e,i);for(var l in r)r.hasOwnProperty(l)&&s.addColorStop(l,r[l]);return s},font:function(t){o.font=t},fillStyle:function(t){o.fillStyle=t},strokeStyle:function(t){o.strokeStyle=t},textAlign:function(t){o.textAlign=t},lineCap:function(t){o.lineCap=t},lineJoin:function(t){o.lineJoin=t},lineWidth:function(t){o.lineWidth=t},arcTo:function(){return o.arcTo.apply(o,arguments)},beginPath:function(){return o.beginPath.apply(o,arguments)},fillText:function(){return o.fillText.apply(o,arguments)},lineTo:function(){return o.lineTo.apply(o,arguments)},measureText:function(){return o.measureText.apply(o,arguments)},moveTo:function(){return o.moveTo.apply(o,arguments)},restore:function(){return o.restore.apply(o,arguments)},save:function(){return o.save.apply(o,arguments)},scale:function(){return o.scale.apply(o,arguments)},setLineDash:function(){return o.setLineDash.apply(o,arguments)},stroke:function(){return o.stroke.apply(o,arguments)},translate:function(){return o.translate.apply(o,arguments)}}};var n=n||{};n.sum=function(e,n){for(var i={undefined:t.identity,string:function(t){return t[n]},number:function(t){return t[n]},"function":n}[typeof n],r=0,o=0,s=e.length;s>r;r++)o+=i(e[r]);return o},n.hasSubstring=function(t,e){return""===e?!0:t?-1!==t.indexOf(e):!1},n.format=function(e){var n=Array.prototype.slice.call(arguments,1);return t.flatten(t.zip(e.split("#"),n)).join("")};var n=n||{};n.vector={dist:function(t,e){return n.vector.mag(n.vector.diff(t,e))},add:function(t,e){return{x:t.x+e.x,y:t.y+e.y}},diff:function(t,e){return{x:t.x-e.x,y:t.y-e.y}},mult:function(t,e){return{x:e*t.x,y:e*t.y}},mag:function(t){return Math.sqrt(t.x*t.x+t.y*t.y)},normalize:function(t){return n.vector.mult(t,1/n.vector.mag(t))},rot:function(t){return{x:t.y,y:-t.x}}};var n=n||{};n.Svg=function(t){function e(t,e,n){return e.style=e.style||"",{name:t,attr:e,content:n||void 0,stroke:function(){return this.attr.style+="stroke:"+s("stroke")+";fill:none;",this},fill:function(){return this.attr.style+="stroke:none; fill:"+s("fill")+";",this},fillAndStroke:function(){return this.attr.style+="stroke:"+s("stroke")+";fill:"+s("fill")+";",this}}}function n(t,e){return{x:t,y:e,stroke:null,fill:null,textAlign:null}}function i(t,e){return u.forEach(function(n){t+=n[e]}),t}function r(t){return Math.round(10*i(t,"x"))/10}function o(t){return Math.round(10*i(t,"y"))/10}function s(t){for(var e=u.length-1;e>=0;e--)if(u[e][t])return u[e][t]}function l(t){return t[t.length-1]}function a(t,e,n){n=void 0===n?1:n,e=e||{x:0,y:0};var i=t.map(function(t,i){return(i?"L":"M")+r(e.x+n*t.x)+" "+o(e.y+n*t.y)}).join(" ");return h("path",{d:i})}function h(t,n,i){var r=e(t,n,i);return f.push(r),r}var c={x:0,y:0,stroke:"none",fill:"none",textAlign:"left"},u=[c],f=[];return{width:function(){return f.width},height:function(){return f.height},background:function(){},clear:function(){},circle:function(t,n,i){var s=2===arguments.length?{r:n,cx:r(t.x),cy:o(t.y)}:{r:i,cx:r(t),cy:o(n)},l=e("circle",s);return f.push(l),l},ellipse:function(t,e,n){return h("ellipse",{cx:r(t.x),cy:o(t.y),rx:e/2,ry:n/2})},arc:function(t,e,n){return h("ellipse",{cx:r(t),cy:o(e),rx:n,ry:n})},roundRect:function(t,e,n,i,s){return h("rect",{x:r(t),y:o(e),rx:s,ry:s,height:i,width:n})},rect:function(t,e,n,i){return h("rect",{x:r(t),y:o(e),height:i,width:n})},path:a,circuit:function(t,e,n){var i=a(t,e,n);return i.attr.d+=" Z",i},font:function(t){l(u).font=t},strokeStyle:function(t){l(u).stroke=t},fillStyle:function(t){l(u).fill=t},arcTo:function(t,e,n,i){l(f).attr.d+="L"+r(t)+" "+o(e)+" L"+r(n)+" "+o(i)+" "},beginPath:function(){return h("path",{d:""})},fillText:function(t,e,n){return"center"===s("textAlign")&&(e-=this.measureText(t).width/2),h("text",{x:r(e),y:o(n)},t)},lineCap:function(e){t+=";stroke-linecap:"+e},lineJoin:function(e){t+=";stroke-linejoin:"+e},lineTo:function(t,e){l(f).attr.d+="L"+r(t)+" "+o(e)+" "},lineWidth:function(e){t+=";stroke-width:"+e},measureText:function(t){return{width:8.5*t.length}},moveTo:function(t,e){l(f).attr.d+="M"+r(t)+" "+o(e)+" "},restore:function(){u.pop()},save:function(){u.push(n(0,0))},scale:function(){},setLineDash:function(){},stroke:function(){l(f).stroke()},textAlign:function(t){l(u).textAlign=t},translate:function(t,e){l(u).x+=t,l(u).y+=e},serialize:function(){function n(t){function e(e){return e+'="'+t[e]+'"'}return Object.keys(t).map(e).join(" ")}function i(t){return"<"+t.name+" "+n(t.attr)+">"+(t.content||"")+"</"+t.name+">"}var r={version:"1.1",baseProfile:"full",width:"100%",height:"100%",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:ev":"http://www.w3.org/2001/xml-events",style:s("font")+";"+t},o=f.map(i).join("\n");return i(e("svg",r,o))}}};var i=function(){function t(){this.yy={}}var e={trace:function(){},yy:{},symbols_:{error:2,root:3,compartment:4,EOF:5,slot:6,IDENT:7,"class":8,association:9,SEP:10,parts:11,"|":12,"[":13,"]":14,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",7:"IDENT",10:"SEP",12:"|",13:"[",14:"]"},productions_:[0,[3,2],[6,1],[6,1],[6,1],[4,1],[4,3],[11,1],[11,3],[11,2],[9,3],[8,3]],performAction:function(t,e,n,i,r,o,s){var l=o.length-1;switch(r){case 1:return o[l-1];case 2:this.$=o[l].trim().replace(/\\(\[|\]|\|)/g,"$1");break;case 3:this.$=o[l];break;case 4:this.$=o[l];break;case 5:this.$=[o[l]];break;case 6:this.$=o[l-2].concat(o[l]);break;case 7:this.$=[o[l]];break;case 8:this.$=o[l-2].concat([o[l]]);break;case 9:this.$=o[l-1].concat([[]]);break;case 10:var a=o[l-1].trim().replace(/\\(\[|\]|\|)/g,"$1").match("^(.*?)([<:o+]*-/?-*[:o+>]*)(.*)$");this.$={assoc:a[2],start:o[l-2],end:o[l],startLabel:a[1].trim(),endLabel:a[3].trim()};break;case 11:var h="CLASS",c=o[l-1][0][0],u=o[l-1][0][0].match("<([a-z]*)>(.*)");u&&(h=u[1].toUpperCase(),c=u[2].trim()),o[l-1][0][0]=c,this.$={type:h,id:c,parts:o[l-1]}}},table:[{3:1,4:2,6:3,7:[1,4],8:5,9:6,13:[1,7]},{1:[3]},{5:[1,8],10:[1,9]},{5:[2,5],10:[2,5],12:[2,5],14:[2,5]},{5:[2,2],10:[2,2],12:[2,2],14:[2,2]},{5:[2,3],7:[1,10],10:[2,3],12:[2,3],14:[2,3]},{5:[2,4],10:[2,4],12:[2,4],14:[2,4]},{4:12,6:3,7:[1,4],8:5,9:6,11:11,13:[1,7]},{1:[2,1]},{6:13,7:[1,4],8:5,9:6,13:[1,7]},{8:14,13:[1,7]},{12:[1,16],14:[1,15]},{10:[1,9],12:[2,7],14:[2,7]},{5:[2,6],10:[2,6],12:[2,6],14:[2,6]},{5:[2,10],10:[2,10],12:[2,10],14:[2,10]},{5:[2,11],7:[2,11],10:[2,11],12:[2,11],14:[2,11]},{4:17,6:3,7:[1,4],8:5,9:6,12:[2,9],13:[1,7],14:[2,9]},{10:[1,9],12:[2,8],14:[2,8]}],defaultActions:{8:[2,1]},parseError:function(t,e){if(!e.recoverable)throw new Error(t);this.trace(t)},parse:function(t){function e(){var t;return t=n.lexer.lex()||f,"number"!=typeof t&&(t=n.symbols_[t]||t),t}var n=this,i=[0],r=[null],o=[],s=this.table,l="",a=0,h=0,c=0,u=2,f=1,y=o.slice.call(arguments,1);this.lexer.setInput(t),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});var d=this.lexer.yylloc;o.push(d);var p=this.lexer.options&&this.lexer.options.ranges;"function"==typeof this.yy.parseError?this.parseError=this.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var g,x,m,v,k,w,S,b,_,T={};;){if(m=i[i.length-1],this.defaultActions[m]?v=this.defaultActions[m]:(null!==g&&"undefined"!=typeof g||(g=e()),v=s[m]&&s[m][g]),"undefined"==typeof v||!v.length||!v[0]){var A="";_=[];for(w in s[m])this.terminals_[w]&&w>u&&_.push("'"+this.terminals_[w]+"'");A=this.lexer.showPosition?"Parse error on line "+(a+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+_.join(", ")+", got '"+(this.terminals_[g]||g)+"'":"Parse error on line "+(a+1)+": Unexpected "+(g==f?"end of input":"'"+(this.terminals_[g]||g)+"'"),this.parseError(A,{text:this.lexer.match,token:this.terminals_[g]||g,line:this.lexer.yylineno,loc:d,expected:_})}if(v[0]instanceof Array&&v.length>1)throw new Error("Parse Error: multiple actions possible at state: "+m+", token: "+g);switch(v[0]){case 1:i.push(g),r.push(this.lexer.yytext),o.push(this.lexer.yylloc),i.push(v[1]),g=null,x?(g=x,x=null):(h=this.lexer.yyleng,l=this.lexer.yytext,a=this.lexer.yylineno,d=this.lexer.yylloc,c>0&&c--);break;case 2:if(S=this.productions_[v[1]][1],T.$=r[r.length-S],T._$={first_line:o[o.length-(S||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(S||1)].first_column,last_column:o[o.length-1].last_column},p&&(T._$.range=[o[o.length-(S||1)].range[0],o[o.length-1].range[1]]),k=this.performAction.apply(T,[l,h,a,this.yy,v[1],r,o].concat(y)),"undefined"!=typeof k)return k;S&&(i=i.slice(0,-1*S*2),r=r.slice(0,-1*S),o=o.slice(0,-1*S)),i.push(this.productions_[v[1]][0]),r.push(T.$),o.push(T._$),b=s[i[i.length-2]][i[i.length-1]],i.push(b);break;case 3:return!0}}return!0}},n=function(){var t={EOF:1,parseError:function(t,e){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,e)},setInput:function(t){return this._input=t,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var t=this._input[0];this.yytext+=t,this.yyleng++,this.offset++,this.match+=t,this.matched+=t;var e=t.match(/(?:\r\n?|\n).*/g);return e?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),t},unput:function(t){var e=t.length,n=t.split(/(?:\r\n?|\n)/g);this._input=t+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-e-1),this.offset-=e;var i=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===i.length?this.yylloc.first_column:0)+i[i.length-n.length].length-n[0].length:this.yylloc.first_column-e},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-e]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(t){this.unput(this.match.slice(t))},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),e=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+e+"^"},test_match:function(t,e){var n,i,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),i=t[0].match(/(?:\r\n?|\n).*/g),i&&(this.yylineno+=i.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:i?i[i.length-1].length-i[i.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],n=this.performAction.call(this,this.yy,this,e,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),n)return n;if(this._backtrack){for(var o in r)this[o]=r[o];return!1}return!1},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var t,e,n,i;this._more||(this.yytext="",this.match="");for(var r=this._currentRules(),o=0;o<r.length;o++)if(n=this._input.match(this.rules[r[o]]),n&&(!e||n[0].length>e[0].length)){if(e=n,i=o,this.options.backtrack_lexer){if(t=this.test_match(n,r[o]),t!==!1)return t;if(this._backtrack){e=!1;continue}return!1}if(!this.options.flex)break}return e?(t=this.test_match(e,r[i]),t!==!1?t:!1):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return t?t:this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){var t=this.conditionStack.length-1;return t>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(t){return t=this.conditionStack.length-1-Math.abs(t||0),t>=0?this.conditionStack[t]:"INITIAL"},pushState:function(t){this.begin(t)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(t,e,n,i){switch(n){case 0:return 12;case 1:return 7;case 2:return 13;case 3:return 14;case 4:return 10;case 5:return 5;case 6:return"INVALID"}},rules:[/^(?:\s*\|\s*)/,/^(?:(\\(\[|\]|\|)|[^\]\[|;\n])+)/,/^(?:\[)/,/^(?:\s*\])/,/^(?:[ ]*(;|\n)+[ ]*)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6],inclusive:!0}}};return t}();return e.lexer=n,t.prototype=e,e.Parser=t,new t}();"undefined"!=typeof require&&"undefined"!=typeof exports&&(exports.parser=i,exports.Parser=i.Parser,exports.parse=function(){return i.parse.apply(i,arguments)},exports.main=function(t){t[1]||(console.log("Usage: "+t[0]+" FILE"),process.exit(1));var e=require("fs").readFileSync(require("path").normalize(t[1]),"utf8");return exports.parser.parse(e)},"undefined"!=typeof module&&require.main===module&&exports.main(process.argv.slice(1)));var r=r||{};r.parse=function(e){function n(t){var e="#"!==t[0]&&"//"!==t.substring(0,2);return e?t:""}var i=function(t){return"#"===t.text[0]},o=e.split("\n").map(function(t,e){return{text:t.trim(),index:e}}),s=t.filter(o,i),l=t.object(s.map(function(t){try{var e=t.text.substring(1).split(":");return[e[0].trim(),e[1].trim()]}catch(n){throw new Error("line "+(t.index+1))}})),a=t.map(t.pluck(o,"text"),n).join("\n").trim(),h=r.transformParseIntoSyntaxTree(r.intermediateParse(a));return h.directives=l,h},r.intermediateParse=function(t){return i.parse(t)},r.transformParseIntoSyntaxTree=function(e){function n(e){var n=[],s=[],l=[];t.each(e,function(t){"string"==typeof t&&n.push(t),t.assoc&&(s.push(t.start),s.push(t.end),l.push({id:o++,assoc:t.assoc,start:t.start.parts[0][0],end:t.end.parts[0][0],startLabel:t.startLabel,endLabel:t.endLabel})),t.parts&&s.push(t)});var a=t.map(s,i),h=t.map(t.groupBy(a,"name"),function(e){return t.max(e,function(t){return t.compartments.length})});return r.Compartment(n,h,l)}function i(e){if("string"==typeof e)return e;if(t.isArray(e))return n(e);if(e.parts){var i=t.map(e.parts,n);return r.Classifier(e.type,e.id,i)}}var o=0;return i(e)};var r=r||{};r.Classifier=function(t,e,n){return{type:t,name:e,compartments:n}},r.Compartment=function(t,e,n){return{lines:t,nodes:e,relations:n}},r.layout=function(i,r,o){function s(t){return e.layout().rankSep(r.spacing).nodeSep(r.spacing).edgeSep(r.spacing).rankDir(r.direction).run(t)}function l(e,n){return e.length?(i.setFont(r,n),{width:Math.round(t.max(t.map(e,i.textWidth))+2*r.padding),height:Math.round(i.textHeight()*e.length+2*r.padding)}):{width:0,height:r.padding}}function a(n,i){function o(t){return{x:t.x,y:t.y}}var a=l(n.lines,i?"normal":"bold");if(n.width=a.width,n.height=a.height,n.nodes.length||n.relations.length){t.each(n.nodes,h);var c=new e.Digraph;t.each(n.nodes,function(t){c.addNode(t.name,{width:t.width,height:t.height})}),t.each(n.relations,function(t){c.addEdge(t.id,t.start,t.end)});var u=s(c),f=t.indexBy(n.relations,"id"),y=t.indexBy(n.nodes,"name");u.eachNode(function(t,e){y[t].x=e.x,y[t].y=e.y}),u.eachEdge(function(e,n,i,r){var s=y[n],l=y[i];f[e].path=t.map(t.flatten([s,r.points,l]),o)});var d=u.graph(),p=d.height?d.height+2*r.gutter:0,g=d.width?d.width+2*r.gutter:0;n.width=Math.max(a.width,g)+2*r.padding,n.height=a.height+p+r.padding}}function h(e){t.each(e.compartments,a),e.width=t.max(t.pluck(e.compartments,"width")),e.height=n.sum(e.compartments,"height"),"HIDDEN"===e.type&&(e.width=0,e.height=0),e.x=e.width/2,e.y=e.height/2,t.each(e.compartments,function(t){t.width=e.width})}return a(o),o};var r=r||{};r.render=function(e,i,r,o){function s(e,n,r){p.save(),p.translate(d,d),p.fillStyle(i.stroke),t.each(e.lines,function(t,r){p.textAlign(n.center?"center":"left");var o=n.center?e.width/2-d:0,s=(.5+(r+.5)*i.leading)*i.fontSize;if(t&&p.fillText(t,o,s),n.underline){var l=p.measureText(t).width;s+=Math.round(.1*i.fontSize)+.5,p.path([{x:o-l/2,y:s},{x:o+l/2,y:s}]).stroke(),p.lineWidth=i.lineWidth}}),p.translate(i.gutter,i.gutter),t.each(e.relations,function(t){c(t,e)}),t.each(e.nodes,function(t){a(t,r)}),p.restore()}function l(t,e){return e>0?{}:{CLASS:{bold:!0,center:!0},LABEL:{},INSTANCE:{center:!0,underline:!0},FRAME:{center:!1,frameHeader:!0},ABSTRACT:{italic:!0,center:!0},STATE:{center:!0},DATABASE:{bold:!0,center:!0},NOTE:{},ACTOR:{},USECASE:{center:!0},START:{empty:!0},END:{empty:!0},INPUT:{center:!0},CHOICE:{center:!0},SENDER:{},RECEIVER:{},HIDDEN:{empty:!0}}[t.type]||{}}function a(e,n){var r=Math.round(e.x-e.width/2),a=Math.round(e.y-e.height/2),h=r+e.width/2,c=i.fill[n]||t.last(i.fill);if(p.fillStyle(c),"NOTE"===e.type)p.circuit([{x:r,y:a},{x:r+e.width-d,y:a},{x:r+e.width,y:a+d},{x:r+e.width,y:a+e.height},{x:r,y:a+e.height},{x:r,y:a}]).fillAndStroke(),p.path([{x:r+e.width-d,y:a},{x:r+e.width-d,y:a+d},{x:r+e.width,y:a+d}]).stroke();else if("ACTOR"===e.type){var u=d/2,f=a+u/2,y={x:h,y:f-u};p.circle(y,u).fillAndStroke(),p.path([{x:h,y:f},{x:h,y:f+2*u}]).stroke(),p.path([{x:h-u,y:f+u},{x:h+u,y:f+u}]).stroke(),p.path([{x:h-u,y:f+u+d},{x:h,y:f+d},{x:h+u,y:f+u+d}]).stroke()}else if("USECASE"===e.type){var g={x:h,y:a+e.height/2};p.ellipse(g,e.width,e.height).fillAndStroke()}else if("START"===e.type)p.fillStyle(i.stroke),p.circle(h,a+e.height/2,e.height/2.5).fill();else if("END"===e.type)p.circle(h,a+e.height/2,e.height/3).fillAndStroke(),p.fillStyle(i.stroke),p.circle(h,a+e.height/2,e.height/3-d/2).fill();else if("STATE"===e.type){var x=Math.min(2*d*i.leading,e.height/2);p.roundRect(r,a,e.width,e.height,x).fillAndStroke()}else if("INPUT"===e.type)p.circuit([{x:r+d,y:a},{x:r+e.width,y:a},{x:r+e.width-d,y:a+e.height},{x:r,y:a+e.height}]).fillAndStroke();else if("CHOICE"===e.type)p.circuit([{x:e.x,y:a-d},{x:r+e.width+d,y:e.y},{x:e.x,y:a+e.height+d},{x:r-d,y:e.y}]).fillAndStroke();else if("PACKAGE"===e.type){var m=e.compartments[0].height;p.rect(r,a+m,e.width,e.height-m).fillAndStroke();var v=p.measureText(e.name).width+2*d;p.circuit([{x:r,y:a+m},{x:r,y:a},{x:r+v,y:a},{x:r+v,y:a+m}]).fillAndStroke()}else if("SENDER"===e.type)p.circuit([{x:r,y:a},{x:r+e.width-d,y:a},{x:r+e.width+d,y:a+e.height/2},{x:r+e.width-d,y:a+e.height},{x:r,y:a+e.height}]).fillAndStroke();else if("RECEIVER"===e.type)p.circuit([{x:r,y:a},{x:r+e.width+d,y:a},{x:r+e.width-d,y:a+e.height/2},{x:r+e.width+d,y:a+e.height},{x:r,y:a+e.height}]).fillAndStroke();else if("HIDDEN"===e.type);else if("DATABASE"===e.type){var k=h,w=a-d/2,S=3.1416;p.rect(r,a,e.width,e.height).fill(),p.path([{x:r,y:w},{x:r,y:w+e.height}]).stroke(),p.path([{x:r+e.width,y:w},{x:r+e.width,y:w+e.height}]).stroke(),p.ellipse({x:k,y:w},e.width,1.5*d).fillAndStroke(),p.ellipse({x:k,y:w+e.height},e.width,1.5*d,0,S).fillAndStroke()}else"LABEL"===e.type||p.rect(r,a,e.width,e.height).fillAndStroke();var b="ACTOR"===e.type?a+3*d/4:a;t.each(e.compartments,function(t,a){var h=l(e,a);if(!h.empty&&(p.save(),p.translate(r,b),o(i,h.bold?"bold":"normal",h.italic),s(t,h,n+1),p.restore(),a+1!==e.compartments.length))if(b+=t.height,"FRAME"===e.type&&0===a){var c=p.measureText(e.name).width+t.height/2+d;p.path([{x:r,y:b},{x:r+c-t.height/2,y:b},{x:r+c,y:b-t.height/2},{x:r+c,y:b-t.height}]).stroke()}else p.path([{x:r,y:b},{x:r+e.width,y:b}]).stroke()})}function h(e){if("rounded"===i.edges){var n=i.spacing*i.bendSize;p.beginPath(),p.moveTo(e[0].x,e[0].y);for(var r=1;r<e.length-1;r++)p.arcTo(e[r].x,e[r].y,e[r+1].x,e[r+1].y,n);p.lineTo(t.last(e).x,t.last(e).y),p.stroke()}else p.path(e).stroke()}function c(e,r){function s(t,e,n){">"===t||"<"===t?f(e,m,n):":>"===t||"<:"===t?f(e,x,n):"+"===t?f(e,m,n,v):"o"===t&&f(e,x,n,v)}var l=t.findWhere(r.nodes,{name:e.start}),a=t.findWhere(r.nodes,{name:e.end}),c=u(e.path[1],t.first(e.path),l),y=u(e.path[e.path.length-2],t.last(e.path),a),g=t.flatten([c,t.tail(t.initial(e.path)),y]),k=i.fontSize;p.fillStyle(i.stroke),o(i,"normal");var w=p.measureText(e.endLabel).width,S="LR"===i.direction?-d-w:d;if(e.startLabel&&p.fillText(e.startLabel,c.x+d,c.y+d+k),e.endLabel&&p.fillText(e.endLabel,y.x+S,y.y-d),"-/-"!==e.assoc)if(p.setLineDash&&n.hasSubstring(e.assoc,"--")){var b=Math.max(4,2*i.lineWidth);p.setLineDash([b,b]),h(g),p.setLineDash([])}else h(g);var _=e.assoc.split("-");s(t.last(_),g,y),s(t.first(_),g.reverse(),c)}function u(t,e,n){if(n.width||n.height){var r,o=n.width/2+i.edgeMargin,s=n.height/2+i.edgeMargin,l=g.diff(t,e);return r=l.x&&l.y?Math.min(Math.abs(o/l.x),Math.abs(s/l.y)):Math.abs(l.x?o/l.x:s/l.y),g.add(e,g.mult(l,r))}return e}function f(e,n,r,o){function s(t){return g.add(r,g.mult(h,t*l))}var l=(i.spacing-2*i.edgeMargin)*i.arrowSize/30,a=g.diff(e[e.length-2],t.last(e)),h=g.normalize(a),c=s(o?7:10),u=g.rot(h),f=o?s(14):n&&!i.fillArrows?s(5):c,y=[g.add(c,g.mult(u,4*l)),f,g.add(c,g.mult(u,-4*l)),r];p.fillStyle(n?i.stroke:i.fill[0]),p.circuit(y).fillAndStroke()}function y(){i.lineWidth%2===1&&p.translate(.5,.5)}var d=i.padding,p=e,g=n.vector,x=!1,m=!0,v=!0;p.clear(),o(i,"bold"),p.save(),p.lineWidth(i.lineWidth),p.lineJoin("round"),p.lineCap("round"),p.strokeStyle(i.stroke),p.scale(i.zoom,i.zoom),y(),s(r,{},0),p.restore()};var r=r||{};return function(){"use strict";function t(t){return{arrowSize:+t.arrowSize||1,bendSize:+t.bendSize||.3,direction:{down:"TB",right:"LR"}[t.direction]||"TB",gutter:+t.gutter||5,edgeMargin:+t.edgeMargin||0,edges:{hard:"hard",rounded:"rounded"}[t.edges]||"rounded",fill:(t.fill||"#eee8d5;#fdf6e3;#eee8d5;#fdf6e3").split(";"),fillArrows:"true"===t.fillArrows,font:t.font||"Calibri",fontSize:+t.fontSize||12,leading:+t.leading||1.25,lineWidth:+t.lineWidth||3,padding:+t.padding||8,spacing:+t.spacing||40,stroke:t.stroke||"#33322E",title:t.title||"nomnoml",zoom:+t.zoom||1}}function e(t,e,n){t.width=e.width*n,t.height=e.height*n}function i(t,e,i,r){var o="bold"===e?"bold":"";i&&(o="italic"+o);var s="Helvetica, sans-serif",l=n.format("# #pt #, #",o,t.fontSize,t.font,s);r.font(l)}function o(n,o,s,l){var a=r.parse(n),h=t(a.directives),c={setFont:function(t,e,n){i(t,e,n,o)},textWidth:function(t){return o.measureText(t).width},textHeight:function(){return h.leading*h.fontSize}},u=r.layout(c,h,a);return e(s,u,h.zoom*l),h.zoom*=l,r.render(o,h,u,c.setFont),{config:h}}r.draw=function(t,e,i){return o(e,n.Canvas(t),t,i||1)},r.renderSvg=function(e){function i(t,e,i){var r="bold"===e?"bold":"";i&&(r="italic"+r);var o="Helvetica, sans-serif",s="font-weight:#; font-size:#pt; font-family:'#', #",a=n.format(s,r,t.fontSize,t.font,o);l.font(a)}var o=r.parse(e),s=t(o.directives),l=n.Svg(""),a={setFont:function(t,e,n){i(t,e,n,l)},textWidth:function(t){return l.measureText(t).width},textHeight:function(){return s.leading*s.fontSize}},h=r.layout(a,s,o);return r.render(l,s,h,a.setFont),l.serialize()}}(),r});
//# sourceMappingURL=./nomnoml.min.js.map