L.Editable=L.Class.extend({includes:[L.Mixin.Events],statics:{FORWARD:1,BACKWARD:-1},options:{zIndex:1e3,polygonClass:L.Polygon,polylineClass:L.Polyline,markerClass:L.Marker,drawingCSSClass:"leaflet-editable-drawing"},initialize:function(a,b){L.setOptions(this,b),this._lastZIndex=this.options.zIndex,this.map=a,this.editLayer=this.createEditLayer(),this.featuresLayer=this.createFeaturesLayer(),this.newClickHandler=this.createNewClickHandler(),this.forwardLineGuide=this.createLineGuide(),this.backwardLineGuide=this.createLineGuide()},fireAndForward:function(a,b){b=b||{},b.editTools=this,this.fire(a,b),this.map.fire(a,b)},createLineGuide:function(){var a=L.extend({dashArray:"5,10",weight:1},this.options.lineGuideOptions);return L.polyline([],a)},createVertexIcon:function(a){return L.Browser.touch?new L.Editable.TouchVertexIcon(a):new L.Editable.VertexIcon(a)},createNewClickHandler:function(){return L.marker(this.map.getCenter(),{icon:this.createVertexIcon({className:"leaflet-div-icon leaflet-drawing-icon"}),opacity:0,zIndexOffset:this._lastZIndex})},createEditLayer:function(){return this.options.editLayer||(new L.LayerGroup).addTo(this.map)},createFeaturesLayer:function(){return this.options.featuresLayer||(new L.LayerGroup).addTo(this.map)},moveForwardLineGuide:function(a){this.forwardLineGuide._latlngs.length&&(this.forwardLineGuide._latlngs[1]=a,this.forwardLineGuide.redraw())},moveBackwardLineGuide:function(a){this.backwardLineGuide._latlngs.length&&(this.backwardLineGuide._latlngs[1]=a,this.backwardLineGuide.redraw())},anchorForwardLineGuide:function(a){this.forwardLineGuide._latlngs[0]=a,this.forwardLineGuide.redraw()},anchorBackwardLineGuide:function(a){this.backwardLineGuide._latlngs[0]=a,this.backwardLineGuide.redraw()},attachForwardLineGuide:function(){this.editLayer.addLayer(this.forwardLineGuide)},attachBackwardLineGuide:function(){this.editLayer.addLayer(this.backwardLineGuide)},detachForwardLineGuide:function(){this.forwardLineGuide._latlngs=[],this.editLayer.removeLayer(this.forwardLineGuide)},detachBackwardLineGuide:function(){this.backwardLineGuide._latlngs=[],this.editLayer.removeLayer(this.backwardLineGuide)},updateNewClickHandlerZIndex:function(){this._lastZIndex+=2,this.newClickHandler.setZIndexOffset(this._lastZIndex)},registerForDrawing:function(a){this.map.on("mousemove touchmove",a.onMouseMove,a),this._drawingEditor&&this.unregisterForDrawing(this._drawingEditor),this._drawingEditor=a,this.editLayer.addLayer(this.newClickHandler),this.newClickHandler.on("click",a.onNewClickHandlerClicked,a),L.Browser.touch&&this.map.on("click",a.onTouch,a),L.DomUtil.addClass(this.map._container,this.options.drawingCSSClass),this.updateNewClickHandlerZIndex()},unregisterForDrawing:function(a){a=a||this._drawingEditor,this.editLayer.removeLayer(this.newClickHandler),a&&(this.map.off("mousemove touchmove",a.onMouseMove,a),this.newClickHandler.off("click",a.onNewClickHandlerClicked,a),L.Browser.touch&&this.map.off("click",a.onTouch,a),a===this._drawingEditor&&(delete this._drawingEditor,a.drawing&&a.cancelDrawing(),L.DomUtil.removeClass(this.map._container,this.options.drawingCSSClass)))},stopDrawing:function(){this.unregisterForDrawing()},connectCreatedToMap:function(a){return this.featuresLayer.addLayer(a)},startPolyline:function(a){var b=this.createPolyline([]);this.connectCreatedToMap(b);var c=b.enableEdit();return c.startDrawingForward(),a&&c.newPointForward(a),b},startPolygon:function(a){var b=this.createPolygon([]);this.connectCreatedToMap(b);var c=b.enableEdit();return c.startDrawingForward(),a&&c.newPointForward(a),b},startMarker:function(a){a=a||this.map.getCenter();var b=this.createMarker(a);this.connectCreatedToMap(b);var c=b.enableEdit();return c.startDrawing(),b},startHole:function(a,b){a.newHole(b)},extendMultiPolygon:function(a){var b=this.createPolygon([]);a.addLayer(b),b.multi=a;var c=b.enableEdit();return c.startDrawingForward(),b},createPolyline:function(a){var b=new this.options.polylineClass(a,{editOptions:{editTools:this}});return this.fireAndForward("editable:created",{layer:b}),b},createPolygon:function(a){var b=new this.options.polygonClass(a,{editOptions:{editTools:this}});return this.fireAndForward("editable:created",{layer:b}),b},createMarker:function(a){var b=new this.options.markerClass(a,{editOptions:{editTools:this}});return this.fireAndForward("editable:created",{layer:b}),b}}),L.Map.addInitHook(function(){this.whenReady(function(){this.options.editable&&(this.editTools=new L.Editable(this,this.options.editOptions))})}),L.Editable.VertexIcon=L.DivIcon.extend({options:{iconSize:new L.Point(8,8)}}),L.Editable.TouchVertexIcon=L.Editable.VertexIcon.extend({options:{iconSize:new L.Point(20,20)}}),L.Editable.VertexMarker=L.Marker.extend({options:{draggable:!0,className:"leaflet-div-icon leaflet-vertex-icon"},initialize:function(a,b,c,d){this.latlng=a,this.latlngs=b,this.editor=c,L.Marker.prototype.initialize.call(this,a,d),this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),this.latlng.__vertex=this,this.editor.editLayer.addLayer(this),this.setZIndexOffset(c.tools._lastZIndex+1)},onAdd:function(a){L.Marker.prototype.onAdd.call(this,a),this.on("drag",this.onDrag),this.on("dragstart",this.onDragStart),this.on("dragend",this.onDragEnd),this.on("click",this.onClick),this.on("contextmenu",this.onContextMenu),this.on("mousedown touchstart",this.onMouseDown),this.addMiddleMarkers()},onRemove:function(a){this.middleMarker&&this.middleMarker["delete"](),delete this.latlng.__vertex,this.off("drag",this.onDrag),this.off("dragstart",this.onDragStart),this.off("dragend",this.onDragEnd),this.off("click",this.onClick),this.off("contextmenu",this.onContextMenu),this.off("mousedown touchstart",this.onMouseDown),L.Marker.prototype.onRemove.call(this,a)},onDrag:function(a){a.vertex=this,this.editor.onVertexMarkerDrag(a);var b=L.DomUtil.getPosition(this._icon),c=this._map.layerPointToLatLng(b);this.latlng.lat=c.lat,this.latlng.lng=c.lng,this.editor.refresh(),this.middleMarker&&this.middleMarker.updateLatLng();var d=this.getNext();d&&d.middleMarker&&d.middleMarker.updateLatLng()},onDragStart:function(a){a.vertex=this,this.editor.onVertexMarkerDragStart(a)},onDragEnd:function(a){a.vertex=this,this.editor.onVertexMarkerDragEnd(a)},onClick:function(a){a.vertex=this,this.editor.onVertexMarkerClick(a)},onContextMenu:function(a){a.vertex=this,this.editor.onVertexMarkerContextMenu(a)},onMouseDown:function(a){a.vertex=this,this.editor.onVertexMarkerMouseDown(a)},"delete":function(){var a=this.getNext();this.latlngs.splice(this.latlngs.indexOf(this.latlng),1),this.editor.editLayer.removeLayer(this),this.editor.onVertexDeleted({latlng:this.latlng,vertex:this}),a&&a.resetMiddleMarker()},getIndex:function(){return this.latlngs.indexOf(this.latlng)},getLastIndex:function(){return this.latlngs.length-1},getPrevious:function(){if(!(this.latlngs.length<2)){var a=this.getIndex(),b=a-1;0===a&&this.editor.CLOSED&&(b=this.getLastIndex());var c=this.latlngs[b];return c?c.__vertex:void 0}},getNext:function(){if(!(this.latlngs.length<2)){var a=this.getIndex(),b=a+1;a===this.getLastIndex()&&this.editor.CLOSED&&(b=0);var c=this.latlngs[b];return c?c.__vertex:void 0}},addMiddleMarker:function(a){a=a||this.getPrevious(),a&&!this.middleMarker&&(this.middleMarker=this.editor.addMiddleMarker(a,this,this.latlngs,this.editor))},addMiddleMarkers:function(){if(!this.editor.tools.options.skipMiddleMarkers){var a=this.getPrevious();a&&this.addMiddleMarker(a);var b=this.getNext();b&&b.resetMiddleMarker()}},resetMiddleMarker:function(){this.middleMarker&&this.middleMarker["delete"](),this.addMiddleMarker()},_initInteraction:function(){L.Marker.prototype._initInteraction.call(this),L.DomEvent.on(this._icon,"touchstart",function(a){this._fireMouseEvent(a)},this)}}),L.Editable.mergeOptions({vertexMarkerClass:L.Editable.VertexMarker}),L.Editable.MiddleMarker=L.Marker.extend({options:{opacity:.5,className:"leaflet-div-icon leaflet-middle-icon"},initialize:function(a,b,c,d,e){this.left=a,this.right=b,this.editor=d,this.latlngs=c,L.Marker.prototype.initialize.call(this,this.computeLatLng(),e),this._opacity=this.options.opacity,this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),this.editor.editLayer.addLayer(this),this.setVisibility()},setVisibility:function(){var a=this._map.latLngToContainerPoint(this.left.latlng),b=this._map.latLngToContainerPoint(this.right.latlng),c=L.point(this.options.icon.options.iconSize);a.distanceTo(b)<3*c.x?this.hide():this.show()},show:function(){this.setOpacity(this._opacity)},hide:function(){this.setOpacity(0)},updateLatLng:function(){this.setLatLng(this.computeLatLng()),this.setVisibility()},computeLatLng:function(){var a=this.editor.map.latLngToContainerPoint(this.left.latlng),b=this.editor.map.latLngToContainerPoint(this.right.latlng),c=(a.y+b.y)/2,d=(a.x+b.x)/2;return this.editor.map.containerPointToLatLng([d,c])},onAdd:function(a){L.Marker.prototype.onAdd.call(this,a),this.on("mousedown touchstart",this.onMouseDown),a.on("zoomend",this.setVisibility,this)},onRemove:function(a){delete this.right.middleMarker,this.off("mousedown touchstart",this.onMouseDown),a.off("zoomend",this.setVisibility,this),L.Marker.prototype.onRemove.call(this,a)},onMouseDown:function(a){this.editor.onMiddleMarkerMouseDown(a,this),this.latlngs.splice(this.index(),0,a.latlng),this.editor.refresh();var b=this.editor.addVertexMarker(a.latlng,this.latlngs);b.dragging._draggable._onDown(a.originalEvent),this["delete"]()},"delete":function(){this.editor.editLayer.removeLayer(this)},index:function(){return this.latlngs.indexOf(this.right.latlng)},_initInteraction:function(){L.Marker.prototype._initInteraction.call(this),L.DomEvent.on(this._icon,"touchstart",function(a){this._fireMouseEvent(a)},this)}}),L.Editable.mergeOptions({middleMarkerClass:L.Editable.MiddleMarker}),L.Editable.BaseEditor=L.Class.extend({initialize:function(a,b,c){L.setOptions(this,c),this.map=a,this.feature=b,this.feature.editor=this,this.editLayer=new L.LayerGroup,this.tools=this.options.editTools||a.editTools},enable:function(){return this._enabled?this:(this.tools.editLayer.addLayer(this.editLayer),this.onEnable(),this._enabled=!0,this.feature.on("remove",this.disable,this),this)},disable:function(){return this.feature.off("remove",this.disable,this),this.editLayer.clearLayers(),this.tools.editLayer.removeLayer(this.editLayer),this.onDisable(),delete this._enabled,this.drawing&&this.cancelDrawing(),this},fireAndForward:function(a,b){b=b||{},b.layer=this.feature,this.feature.fire(a,b),this.feature.multi&&this.feature.multi.fire(a,b),this.tools.fireAndForward(a,b)},onEnable:function(){this.fireAndForward("editable:enable")},onDisable:function(){this.fireAndForward("editable:disable")},onEditing:function(){this.fireAndForward("editable:editing")},onStartDrawing:function(){this.fireAndForward("editable:drawing:start")},onEndDrawing:function(){this.fireAndForward("editable:drawing:end")},onCancelDrawing:function(){this.fireAndForward("editable:drawing:cancel")},onCommitDrawing:function(){this.fireAndForward("editable:drawing:commit")},startDrawing:function(){this.drawing||(this.drawing=L.Editable.FORWARD),this.tools.registerForDrawing(this),this.onStartDrawing()},commitDrawing:function(){this.onCommitDrawing(),this.endDrawing()},cancelDrawing:function(){this.onCancelDrawing(),this.endDrawing()},endDrawing:function(){this.drawing=!1,this.tools.unregisterForDrawing(this),this.onEndDrawing()},onMouseMove:function(a){this.drawing&&this.tools.newClickHandler.setLatLng(a.latlng)},onTouch:function(a){this.onMouseMove(a),this.drawing&&this.tools.newClickHandler._fireMouseEvent(a)},onNewClickHandlerClicked:function(a){this.fireAndForward("editable:drawing:click",a)},isNewClickValid:function(a){return!0}}),L.Editable.MarkerEditor=L.Editable.BaseEditor.extend({enable:function(){return this._enabled?this:(L.Editable.BaseEditor.prototype.enable.call(this),this.feature.dragging.enable(),this.feature.on("dragstart",this.onEditing,this),this)},disable:function(){return L.Editable.BaseEditor.prototype.disable.call(this),this.feature.dragging.disable(),this.feature.off("dragstart",this.onEditing,this),this},onMouseMove:function(a){this.drawing&&(L.Editable.BaseEditor.prototype.onMouseMove.call(this,a),this.feature.setLatLng(a.latlng),this.tools.newClickHandler._bringToFront())},onNewClickHandlerClicked:function(a){this.isNewClickValid(a.latlng)&&(L.Editable.BaseEditor.prototype.onNewClickHandlerClicked.call(this,a),this.commitDrawing())}}),L.Editable.PathEditor=L.Editable.BaseEditor.extend({CLOSED:!1,MIN_VERTEX:2,enable:function(){return this._enabled?this:(L.Editable.BaseEditor.prototype.enable.call(this),this.feature&&this.initVertexMarkers(),this)},disable:function(){return L.Editable.BaseEditor.prototype.disable.call(this)},initVertexMarkers:function(){for(var a=this.getLatLngsGroups(),b=0;b<a.length;b++)this.addVertexMarkers(a[b])},getLatLngsGroups:function(){return[this.getLatLngs()]},getLatLngs:function(){return this.feature.getLatLngs()},reset:function(){this.editLayer.clearLayers(),this.initVertexMarkers()},addVertexMarker:function(a,b){return new this.tools.options.vertexMarkerClass(a,b,this)},addVertexMarkers:function(a){for(var b=0;b<a.length;b++)this.addVertexMarker(a[b],a)},addMiddleMarker:function(a,b,c){return new this.tools.options.middleMarkerClass(a,b,c,this)},onVertexMarkerClick:function(a){var b=a.vertex.getIndex();a.originalEvent.ctrlKey?this.onVertexMarkerCtrlClick(a):a.originalEvent.altKey?this.onVertexMarkerAltClick(a):a.originalEvent.shiftKey?this.onVertexMarkerShiftClick(a):b>=this.MIN_VERTEX-1&&b===a.vertex.getLastIndex()&&this.drawing===L.Editable.FORWARD?this.commitDrawing():0===b&&this.drawing===L.Editable.BACKWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX?this.commitDrawing():0===b&&this.drawing===L.Editable.FORWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX&&this.CLOSED?this.commitDrawing():this.onVertexRawMarkerClick(a)},onVertexRawMarkerClick:function(a){this.vertexCanBeDeleted(a.vertex)&&(a.vertex["delete"](),this.refresh())},vertexCanBeDeleted:function(a){return a.latlngs.length>this.MIN_VERTEX},onVertexDeleted:function(a){this.fireAndForward("editable:vertex:deleted",a)},onVertexMarkerCtrlClick:function(a){this.fireAndForward("editable:vertex:ctrlclick",a)},onVertexMarkerShiftClick:function(a){this.fireAndForward("editable:vertex:shiftclick",a)},onVertexMarkerAltClick:function(a){this.fireAndForward("editable:vertex:altclick",a)},onVertexMarkerContextMenu:function(a){this.fireAndForward("editable:vertex:contextmenu",a)},onVertexMarkerMouseDown:function(a){this.fireAndForward("editable:vertex:mousedown",a)},onMiddleMarkerMouseDown:function(a){this.fireAndForward("editable:middlemarker:mousedown",a)},onVertexMarkerDrag:function(a){this.fireAndForward("editable:vertex:drag",a)},onVertexMarkerDragStart:function(a){this.fireAndForward("editable:vertex:dragstart",a)},onVertexMarkerDragEnd:function(a){this.fireAndForward("editable:vertex:dragend",a)},startDrawing:function(){this._drawnLatLngs||(this._drawnLatLngs=this.getLatLngs()),L.Editable.BaseEditor.prototype.startDrawing.call(this)},startDrawingForward:function(){this.startDrawing(),this.tools.attachForwardLineGuide()},endDrawing:function(){L.Editable.BaseEditor.prototype.endDrawing.call(this),this.tools.detachForwardLineGuide(),this.tools.detachBackwardLineGuide(),delete this._drawnLatLngs},addLatLng:function(a){this.drawing===L.Editable.FORWARD?this._drawnLatLngs.push(a):this._drawnLatLngs.unshift(a),this.refresh(),this.addVertexMarker(a,this._drawnLatLngs)},newPointForward:function(a){this.addLatLng(a),this.tools.anchorForwardLineGuide(a),this.tools.backwardLineGuide._latlngs[0]||this.tools.anchorBackwardLineGuide(a)},newPointBackward:function(a){this.addLatLng(a),this.tools.anchorBackwardLineGuide(a)},onNewClickHandlerClicked:function(a){this.isNewClickValid(a.latlng)&&(this.drawing===L.Editable.FORWARD?this.newPointForward(a.latlng):this.newPointBackward(a.latlng),L.Editable.BaseEditor.prototype.onNewClickHandlerClicked.call(this,a))},onMouseMove:function(a){this.drawing&&(L.Editable.BaseEditor.prototype.onMouseMove.call(this,a),this.tools.moveForwardLineGuide(a.latlng),this.tools.moveBackwardLineGuide(a.latlng))},refresh:function(){this.feature.redraw(),this.onEditing()}}),L.Editable.PolylineEditor=L.Editable.PathEditor.extend({startDrawingBackward:function(){this.drawing=L.Editable.BACKWARD,this.startDrawing(),this.tools.attachBackwardLineGuide()},continueBackward:function(){this.tools.anchorBackwardLineGuide(this.getFirstLatLng()),this.startDrawingBackward()},continueForward:function(){this.tools.anchorForwardLineGuide(this.getLastLatLng()),this.startDrawingForward()},getLastLatLng:function(){return this.getLatLngs()[this.getLatLngs().length-1]},getFirstLatLng:function(){return this.getLatLngs()[0]}}),L.Editable.PolygonEditor=L.Editable.PathEditor.extend({CLOSED:!0,MIN_VERTEX:3,getLatLngsGroups:function(){var a=L.Editable.PathEditor.prototype.getLatLngsGroups.call(this);if(this.feature._holes)for(var b=0;b<this.feature._holes.length;b++)a.push(this.feature._holes[b]);return a},startDrawingForward:function(){L.Editable.PathEditor.prototype.startDrawingForward.call(this),this.tools.attachBackwardLineGuide()},addNewEmptyHole:function(){var a=Array();return this.feature._holes||(this.feature._holes=[]),this.feature._holes.push(a),a},newHole:function(a){this._drawnLatLngs=this.addNewEmptyHole(),this.startDrawingForward(),a&&this.newPointForward(a)},checkContains:function(a){return this.feature._containsPoint(this.map.latLngToLayerPoint(a))},vertexCanBeDeleted:function(a){return a.latlngs===this.getLatLngs()?L.Editable.PathEditor.prototype.vertexCanBeDeleted.call(this,a):!0},isNewClickValid:function(a){return this._drawnLatLngs!==this.getLatLngs()?this.checkContains(a):!0},onVertexDeleted:function(a){L.Editable.PathEditor.prototype.onVertexDeleted.call(this,a),a.vertex.latlngs.length||a.vertex.latlngs===this.getLatLngs()||this.feature._holes.splice(this.feature._holes.indexOf(a.vertex.latlngs),1)}}),L.Map.mergeOptions({polylineEditorClass:L.Editable.PolylineEditor}),L.Map.mergeOptions({polygonEditorClass:L.Editable.PolygonEditor}),L.Map.mergeOptions({markerEditorClass:L.Editable.MarkerEditor});var EditableMixin={createEditor:function(a){a=a||this._map;var b=this.options.editorClass||this.getEditorClass(a);return new b(a,this,this.options.editOptions)},enableEdit:function(){return this.editor||this.createEditor(),this.multi&&this.multi.onEditEnabled(),this.editor.enable()},editEnabled:function(){return this.editor&&this.editor._enabled},disableEdit:function(){this.editor&&(this.multi&&this.multi.onEditDisabled(),this.editor.disable(),delete this.editor)},toggleEdit:function(){this.editEnabled()?this.disableEdit():this.enableEdit()}};L.Polyline.include(EditableMixin),L.Polygon.include(EditableMixin),L.Marker.include(EditableMixin),L.Polyline.include({_containsPoint:function(a,b){var c,d,e,f,g,h,i,j=this.options.weight/2;for(L.Browser.touch&&(j+=10),c=0,f=this._parts.length;f>c;c++)for(i=this._parts[c],d=0,g=i.length,e=g-1;g>d;e=d++)if((b||0!==d)&&(h=L.LineUtil.pointToSegmentDistance(a,i[e],i[d]),j>=h))return!0;return!1},getEditorClass:function(a){return a.options.polylineEditorClass}}),L.Polygon.include({_containsPoint:function(a){var c,d,e,f,g,h,i,j,b=!1;if(L.Polyline.prototype._containsPoint.call(this,a,!0))return!0;for(f=0,i=this._parts.length;i>f;f++)for(c=this._parts[f],g=0,j=c.length,h=j-1;j>g;h=g++)d=c[g],e=c[h],d.y>a.y!=e.y>a.y&&a.x<(e.x-d.x)*(a.y-d.y)/(e.y-d.y)+d.x&&(b=!b);return b},getEditorClass:function(a){return a.options.polygonEditorClass}}),L.Marker.include({getEditorClass:function(a){return a.options.markerEditorClass}});var MultiEditableMixin={enableEdit:function(){this.eachLayer(function(a){a.multi=this,a.enableEdit()},this)},disableEdit:function(){this.eachLayer(function(a){a.disableEdit()})},toggleEdit:function(a){a.layer.editor?this.disableEdit():this.enableEdit(a)},onEditEnabled:function(){this._editEnabled||(this._editEnabled=!0,this.fire("editable:multi:edit:enabled"))},onEditDisabled:function(){this._editEnabled&&(this._editEnabled=!1,this.fire("editable:multi:edit:disabled"))},editEnabled:function(){return!!this._editEnabled}};L.MultiPolygon.include(MultiEditableMixin),L.MultiPolyline.include(MultiEditableMixin);