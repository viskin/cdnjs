/* 
	Captionator 0.4 [Stable]
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

var captionator={createDOMException:function(b,g,d){try{document.querySelectorAll("div/[]")}catch(c){var f=function(e,a,b){this.code=e;this.message=a;this.name=b};f.prototype=c;return new f(b,g,d)}},captionify:function(b,g,d){var c=[],f=0,d=d instanceof Object?d:{};if(HTMLVideoElement){if(typeof document.createElement("video").addTrack==="function")return!1}else return!1;captionator.TextTrack=function(b,a,d,i,c,f){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};this.id=
b||"";this.internalMode=captionator.TextTrack.OFF;this.cues=new captionator.TextTrackCueList(this);this.activeCues=new captionator.ActiveTextTrackCueList(this.cues);this.kind=a||"subtitles";this.label=d||"";this.language=i||"";this.src=c||"";this.readyState=captionator.TextTrack.NONE;this.internalDefault=f||!1;this.getMode=function(){return this.internalMode};this.setMode=function(a){var b;if([captionator.TextTrack.OFF,captionator.TextTrack.HIDDEN,captionator.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==
this.internalMode){this.internalMode=a;this.readyState===captionator.TextTrack.NONE&&this.src.length>0&&a>captionator.TextTrack.OFF&&this.loadTrack(this.src,null);this.readyState===captionator.TextTrack.LOADED&&captionator.rebuildCaptions(this.videoNode);if(a===captionator.TextTrack.OFF||a===captionator.TextTrack.HIDDEN)b="captionator-"+this.videoNode.id+"-"+this.kind+"-"+this.language,(b=document.getElementById(b))&&b.parentNode.removeChild(b);if(a===captionator.TextTrack.OFF)this.cues.length=0,
this.readyState=captionator.TextTrack.NONE}}else throw Error("Illegal mode value for track: "+a);};this.getDefault=function(){return this.internalDefault};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode),this.__defineGetter__("default",this.getDefault)):Object.defineProperty&&(Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode}),Object.defineProperty(this,"default",{get:this.getDefault}));this.loadTrack=function(a,
b){var i,d=new XMLHttpRequest;if(this.readyState===captionator.TextTrack.LOADED)b instanceof Function&&b(i);else{this.src=a;this.readyState=captionator.TextTrack.LOADING;var e=this;d.open("GET",a,!0);d.onreadystatechange=function(){if(d.readyState===4)d.status===200?(i=captionator.parseCaptions(d.responseText),e.readyState=captionator.TextTrack.LOADED,captionator.rebuildCaptions(e.videoNode),e.cues.loadCues(i),e.onload(),b instanceof Function&&b.call(e,i)):(e.readyState=captionator.TextTrack.ERROR,
e.onerror())};d.send(null)}};this.addCue=function(){};this.removeCue=function(){}};captionator.TextTrack.NONE=0;captionator.TextTrack.LOADING=1;captionator.TextTrack.LOADED=2;captionator.TextTrack.ERROR=3;captionator.TextTrack.OFF=0;captionator.TextTrack.HIDDEN=1;captionator.TextTrack.SHOWING=2;captionator.TextTrackCueList=function(b){this.track=b instanceof captionator.TextTrack?b:null;this.getCueById=function(a){return this.filter(function(b){return b.id===a})[0]};this.loadCues=function(a){for(var b=
0;b<a.length;b++)a[b].track=this.track,Array.prototype.push.call(this,a[b])};this.toString=function(){return"[TextTrackCueList]"}};captionator.TextTrackCueList.prototype=[];captionator.ActiveTextTrackCueList=function(b){this.refreshCues=function(){var a=this;this.length=0;b.forEach(function(b){b.active&&a.push(b)})};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};captionator.ActiveTextTrackCueList.prototype=new captionator.TextTrackCueList(null);captionator.TextTrackCue=
function(b,a,d,i,c,f,m){this.id=b;this.track=m instanceof captionator.TextTrack?m:null;this.startTime=parseFloat(a);this.endTime=parseFloat(d);this.text=typeof i==="string"?i:"";this.settings=typeof c==="string"?c:"";this.intSettings={};this.pauseOnExit=!!f;this.direction="horizontal";this.snapToLines=!1;this.linePosition="auto";this.size=this.textPosition=0;this.alignment="";if(this.settings.length){var n=this.intSettings,c=c.split(/\s+/).filter(function(a){return a.length>0});c instanceof Array&&
c.forEach(function(a){var b={D:"verticalText",L:"linePosition",T:"textPosition",A:"textAlignment",S:"textSize"},a=a.split(":");b[a[0]]&&(n[b[a[0]]]=a[1])})}this.getCueAsSource=function(){return this.text};this.getCueAsHTML=function(){var a=document.createDocumentFragment(),b=document.createElement("div");b.innerHTML=this.text;Array.prototype.forEach.call(b.childNodes,function(b){a.appendChild(b.cloneNode(!0))});return a};this.isActive=function(){var a=0;if(this.track instanceof captionator.TextTrack&&
this.track.mode===captionator.TextTrack.SHOWING&&this.track.readyState===captionator.TextTrack.LOADED)try{if(a=this.track.videoNode.currentTime,this.startTime<=a&&this.endTime>=a)return!0}catch(b){}return!1};Object.prototype.__defineGetter__?this.__defineGetter__("active",this.isActive):Object.defineProperty&&Object.defineProperty(this,"active",{get:this.isActive});this.onenter=function(){};this.onexit=function(){}};captionator.MediaTrack=function(b,a,d,i,c,f){var m=function(a){return a.filter(function(a){try{var b=
document.createElement(a.getAttribute("type").split("/").shift());return!(!b.canPlayType||!b.canPlayType(a.getAttribute("type")).replace(/no/,""))}catch(d){return!1}}).shift().getAttribute("src")};this.onload=function(){};this.onerror=function(){};this.id=b||"";this.internalMode=this.internalMode=captionator.TextTrack.OFF;this.mediaElement=null;this.kind=a||"audiodescription";this.label=d||"";this.language=i||"";this.readyState=captionator.TextTrack.NONE;this.type=f||"x/unknown";this.mediaType=null;
this.src="";if(typeof c==="string")this.src=c;else if(c instanceof NodeList)this.src=m(c);if(this.type.match(/^video\//))this.mediaType="video";else if(this.type.match(/^audio\//))this.mediaType="audio";this.getMode=function(){return this.internalMode};this.setMode=function(a){if([captionator.TextTrack.OFF,captionator.TextTrack.HIDDEN,captionator.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode)this.internalMode=a,a===captionator.TextTrack.HIDDEN&&!this.mediaElement&&this.buildMediaElement(),
a===captionator.TextTrack.SHOWING&&this.showMediaElement(),(a===captionator.TextTrack.OFF||a===captionator.TextTrack.HIDDEN)&&this.hideMediaElement()}else throw Error("Illegal mode value for track.");};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode)):Object.defineProperty&&Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode});this.hideMediaElement=function(){if(this.mediaElement&&(this.mediaElement.paused||this.mediaElement.pause(),
this.mediaElement instanceof HTMLVideoElement))this.mediaElement.style.display="none"};this.showMediaElement=function(){if(this.mediaElement){if(this.mediaElement.parentNode||document.body.appendChild(this.mediaElement),this.mediaElement instanceof HTMLVideoElement)this.mediaElement.style.display="block"}else this.buildMediaElement(),document.body.appendChild(this.mediaElement)};this.buildMediaElement=function(){try{if(this.type.match(/^video\//))this.mediaElement=document.createElement("video"),
this.mediaElement.className="captionator-mediaElement-"+this.kind,captionator.styleNode(this.mediaElement,this.kind,this.videoNode);else if(this.type.match(/^audio\//))this.mediaElement=new Audio;this.mediaElement.type=this.type;this.mediaElement.src=this.src;this.mediaElement.load();this.mediaElement.trackObject=this;this.readyState=captionator.TextTrack.LOADING;var a=this.mediaElement;this.mediaElement.addEventListener("progress",function(){a.trackObject.readyState=captionator.TextTrack.LOADING},
!1);this.mediaElement.addEventListener("canplaythrough",function(){a.trackObject.readyState=captionator.TextTrack.LOADED;a.trackObject.onload.call(a.trackObject)},!1);this.mediaElement.addEventListener("error",function(b){a.trackObject.readyState=captionator.TextTrack.ERROR;a.trackObject.mode=captionator.TextTrack.OFF;a.trackObject.mediaElement=null;a.trackObject.onerror.call(a.trackObject,b)},!1)}catch(b){this.readyState=captionator.TextTrack.ERROR,this.mode=captionator.TextTrack.OFF,this.mediaElement=
null,this.onerror.call(this,b)}}};if(d.exportObjects)window.TextTrack=captionator.TextTrack,window.TextTrackCueList=captionator.TextTrackCueList,window.ActiveTextTrackCueList=captionator.ActiveTextTrackCueList,window.TextTrackCue=captionator.TextTrackCue,window.MediaTrack=captionator.MediaTrack;[].slice.call(document.getElementsByTagName("video"),0).forEach(function(b){b.addTrack=function(a,d,i,c,f,m,g){var j=["subtitles","captions","descriptions","captions","metadata","karaoke","lyrics","tickertext",
"audiodescription","commentary","alternate","signlanguage"],k=j.slice(0,7),a=typeof a==="string"?a:"",i=typeof i==="string"?i:"",c=typeof c==="string"?c:"",g=typeof g==="boolean"?g:!1;if(!j.filter(function(a){return d===a?!0:!1}).length)throw captionator.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR");if(k.filter(function(a){return d===a?!0:!1}).length)if(a=new captionator.TextTrack(a,d,i,c,f)){if(!(b.tracks instanceof Array))b.tracks=
[];b.tracks.push(a);return a}else return!1;else if(a=new captionator.MediaTrack(a,d,i,c,f,m,g)){if(!(b.mediaTracks instanceof Array))b.mediaTracks=[];b.mediaTracks.push(a);return a}else return!1}});if(!b||b===!1||b===void 0||b===null)c=[].slice.call(document.getElementsByTagName("video"),0);else if(b instanceof Array)for(f=0;f<b.length;f++)typeof b[f]==="string"?c=c.concat([].slice.call(document.querySelectorAll(b[f]),0)):b[f].constructor===HTMLVideoElement&&c.push(b[f]);else typeof b==="string"?
c=[].slice.call(document.querySelectorAll(b),0):b.constructor===HTMLVideoElement&&c.push(b);if(c.length){for(f=0;f<c.length;f++)captionator.processVideoElement(c[f],g,d);return!0}else return!1},processVideoElement:function(b,g,d){var c=[],f=navigator.language||navigator.userLanguage;g||f.split("-");d=d instanceof Object?d:{};if(!b.captioned){b.captionatorOptions=d;b.className+=(b.className.length?" ":"")+"captioned";b.captioned=!0;if(b.id.length===0){for(f="";f.length<10;)f+=String.fromCharCode(65+
Math.floor(Math.random()*26));b.id="captionator"+f}[].slice.call(b.querySelectorAll("track"),0).forEach(function(e){var a=null,a=e.querySelectorAll("source").length>0?e.querySelectorAll("source"):e.getAttribute("src"),a=b.addTrack(e.getAttribute("id"),e.getAttribute("kind"),e.getAttribute("label"),e.getAttribute("srclang").split("-")[0],a,e.getAttribute("type"),e.hasAttribute("default"));e.track=a;a.trackNode=e;a.videoNode=b;c.push(a);var f=!1;if((a.kind==="subtitles"||a.kind==="captions")&&g===a.language&&
d.enableCaptionsByDefault)c.filter(function(a){return(a.kind==="captions"||a.kind==="subtitles")&&g===a.language&&a.mode===captionator.TextTrack.SHOWING?!0:!1}).length||(f=!0);a.kind==="chapters"&&g===a.language&&(c.filter(function(a){return a.kind==="chapters"&&a.mode===captionator.TextTrack.SHOWING?!0:!1}).length||(f=!0));a.kind==="descriptions"&&d.enableDescriptionsByDefault===!0&&g===a.language&&(c.filter(function(a){return a.kind==="descriptions"&&a.mode===captionator.TextTrack.SHOWING?!0:!1}).length||
(f=!0));f===!0&&c.forEach(function(a){if(a.trackNode.hasAttribute("default")&&a.mode===captionator.TextTrack.SHOWING)a.mode=captionator.TextTrack.HIDDEN});if(e.hasAttribute("default")&&!c.filter(function(a){return a.trackNode.hasAttribute("default")&&a.trackNode!==e?!0:!1}).length)f=!0,a.internalDefault=!0;if(f===!0)a.mode=captionator.TextTrack.SHOWING});b.addEventListener("timeupdate",function(b){b=b.target;try{b.tracks.forEach(function(a){a.activeCues.refreshCues()})}catch(a){}d.renderer instanceof
Function?d.renderer.call(captionator,b):captionator.rebuildCaptions(b);captionator.synchroniseMediaElements(b)},!1);b.addEventListener("play",function(){captionator.synchroniseMediaElements(b)},!1);b.addEventListener("pause",function(){captionator.synchroniseMediaElements(b)},!1)}return b},rebuildCaptions:function(b){var g="captionator-unset",d=null,c="",f=!1;(b.tracks||[]).forEach(function(e){if(e.mode===captionator.TextTrack.SHOWING&&e.readyState===captionator.TextTrack.LOADED){g="captionator-"+
b.id+"-"+e.kind+"-"+e.language;(d=e.containerObject?e.containerObject:document.getElementById(g))?d.parentNode||document.body.appendChild(d):(d=document.createElement("div"),d.id=g,document.body.appendChild(d),e.containerObject=d,d.setAttribute("aria-live","polite"),d.setAttribute("aria-atomic","true"),captionator.styleNode(d,e.kind,e.videoNode));if(String(b.getAttribute("aria-describedby")).indexOf(g)===-1){var a=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"";b.setAttribute("aria-describedby",
a+g)}c="";e.activeCues.forEach(function(a){c+='<div class="captionator-cue">'+a.getCueAsSource()+"</div>"});f=!1;if(String(d.innerHTML)!==c)d.innerHTML=c,f=!0;if(c.length){if(f||d.style.display==="none")if(d.style.display="block",captionator.styleNode(d,e.kind,e.videoNode),window.navigator.userAgent.toLowerCase().indexOf("chrome/10")>-1)d.style.backgroundColor="rgba(0,0,0,0.5"+Math.random().toString().replace(".","")+")"}else d.style.display="none"}})},synchroniseMediaElements:function(b){var g=function(b,
c){try{c.seeking&&b.pause();if(b.currentTime<c.currentTime-0.5||b.currentTime>c.currentTime+0.5)b.currentTime=c.currentTime;b.paused&&!c.paused?b.play():!b.paused&&c.paused&&b.pause()}catch(f){}};(b.mediaTracks||[]).forEach(function(d){d.mode===captionator.TextTrack.SHOWING&&d.readyState>=captionator.TextTrack.LOADING&&g(d.mediaElement,b)});b.id&&[].slice.call(document.body.querySelectorAll("*[syncMaster="+b.id+"]"),0).forEach(function(d){(d.tagName.toLowerCase()==="video"||d.tagName.toLowerCase()===
"audio")&&g(d,b)})},styleNode:function(b,g,d){var c=function(a,b){for(var c in b)({}).hasOwnProperty.call(b,c)&&(a.style[c]=b[c])},f=function(a){for(var b=window.getComputedStyle(a,null),c=a,d=a.offsetTop,f=a.offsetLeft,e=a,g=0,h=0,e=parseInt(b.getPropertyValue("width"),10),g=parseInt(b.getPropertyValue("height"),10);c=c.offsetParent;)d+=c.offsetTop,f+=c.offsetLeft;a.hasAttribute("controls")&&(a=navigator.userAgent.toLowerCase(),a.indexOf("chrome")!==-1?h=32:a.indexOf("opera")!==-1?h=25:a.indexOf("firefox")!==
-1?h=28:a.indexOf("ie 9")!==-1||a.indexOf("ipad")!==-1?h=44:a.indexOf("safari")!==-1&&(h=25));return{left:f,top:d,width:e,height:g,controlHeight:h}},e=function(a,b){var e=0,g,h,j,k;try{var o=function(){g=f(d);h=g.height*0.045/96*72;h=h>=11?h:11;j=Math.floor(h*1.3);j=j>14?j:14;e=Math.ceil(g.height*0.13);a.textContent?a.textContent.replace(/\s\s+/ig," "):a.innerText&&a.innerText.replace(/\s\s+/ig," ");e=Math.ceil(g.height*0.13);k=g.top+g.height;k=b==="bottom"?k-(e+g.controlHeight):g.top;c(a,{width:g.width-
40+"px",height:e+"px",left:g.left+"px",top:k+"px",fontSize:h+"pt",lineHeight:j+"pt"});if(a.scrollHeight>e){var o=Math.ceil(0.33*g.height);e=a.scrollHeight<=o?a.scrollHeight:o;k=g.top+g.height;k=b==="bottom"?k-(e+g.controlHeight):g.top;c(a,{height:e+"px",top:k+"px"})}else{var p=0;Array.prototype.slice.call(a.childNodes,0).forEach(function(a){p+=a.offsetHeight});p<e*0.9&&(j+=(e-p)/96*72,c(a,{lineHeight:j+"pt"}))}};if(!a.resizeHelper)a.resizeHelper=window.addEventListener("resize",o,!1);o()}catch(r){}};
if(b instanceof HTMLElement&&d instanceof HTMLVideoElement){var a=f(d),h=0;switch(g){case "caption":case "captions":case "subtitle":case "subtitles":h=Math.ceil(a.height*0.15<30?30:a.height*0.15);c(b,{display:"block",position:"absolute",width:a.width-40+"px",height:h+"px",backgroundColor:"rgba(0,0,0,0.5)",left:a.left+"px",top:a.top+a.height-(h+a.controlHeight)+"px",color:"white",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"bold",textAlign:"center",paddingLeft:"20px",
paddingRight:"20px",overflow:"hidden",zIndex:20});e(b,"bottom");break;case "textaudiodesc":case "descriptions":case "karaoke":case "lyrics":h=a.height*0.1<20?20:a.height*0.1;c(b,{display:"block",position:"absolute",width:a.width-40+"px",minHeight:h+"px",backgroundColor:"rgba(0,0,0,0.5)",left:a.left+"px",top:a.top+"px",color:"gold",fontStyle:"oblique",textShadow:"black 0px 0px 5px",fontFamily:"Helvetica, Arial, sans-serif",fontWeight:"lighter",textAlign:"center",paddingLeft:"20px",paddingRight:"20px",
overflow:"hidden"});e(b,"top");break;case "toolbar":case "alternate":c(b,{display:"block",position:"absolute",width:a.width+"px",height:a.height-a.controlHeight+"px",backgroundColor:"black",left:a.left+"px",top:a.top+"px"});break;case "signlanguage":c(b,{display:"block",position:"absolute",maxWidth:a.width/20*6+"px",maxHeight:(a.height-a.controlHeight)/20*8+"px",backgroundColor:"black",left:a.left+a.width-a.width/20*7+"px",top:a.top+a.height-a.height/20*11+"px",border:"solid white 2px"})}b.className.indexOf("captionator-kind")===
-1&&(b.className+=(b.className.length?" ":"")+"captionator-kind-"+g)}},parseCaptions:function(b){if(b)return b.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(/\n\n+/g).filter(function(b){if(!b.match(/^WEBVTT(\s*FILE)?/ig)&&b.replace(/\s*/ig,"").length)return!0;return!1}).map(function(b,d){var c=b.split(/\n/g),f,e,a,h,i,l;a=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\,(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/;var q=/^(\d+)?:?(\d{2}):(\d{2})\.(\d+)\,(\d+)?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/;l=/^(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s+\-\-\>\s+(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s*(.*)/;
for(var m=/^([\d\.]+)\s+\+([\d\.]+)\s*(.*)/;!c[0].replace(/\s+/ig,"").length&&c.length>0;)c.shift();for(i=c[0].match(/^\s*\d+\s*$/ig)?String(c.shift().replace(/\s*/ig,"")):d;0<c.length;){var n=c[0];if((l=l.exec(n))||(l=a.exec(n))||(l=q.exec(n)))a=l.slice(1),f=parseInt((a[0]||0)*3600,10)+parseInt((a[1]||0)*60,10)+parseInt(a[2]||0,10)+parseFloat("0."+(a[3]||0),10),e=parseInt((a[4]||0)*3600,10)+parseInt((a[5]||0)*60,10)+parseInt(a[6]||0,10)+parseFloat("0."+(a[7]||0),10),a[8]&&(h=a[8]);else if(l=m.exec(n))a=
l.slice(1),f=parseFloat(a[0],10),e=f+parseFloat(a[1],10),a[2]&&(h=a[2]);c=c.slice(0,0).concat(c.slice(1));break}c=c.join("\n");return new captionator.TextTrackCue(i,f,e,c,h,!1,null)});else throw Error("Required parameter captionData not supplied.");}};