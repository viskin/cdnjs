/*
	Captionator 0.5 [CaptionCrunch]
	Christopher Giffard, 2011
	Share and enjoy

	https://github.com/cgiffard/Captionator
*/

(function(){var x=10,y=16,A=4.5,B=1.5,E=[0,0,0,0.5],F=!1,c={createDOMException:function(b,c,a){try{document.querySelectorAll("div/[]")}catch(f){var d=function(a,b,c){this.code=a;this.message=b;this.name=c};d.prototype=f;return new d(b,c,a)}},compareArray:function(b,c){if(!(b instanceof Array)||!(c instanceof Array))return!1;if(b.length!==c.length)return!1;for(var a in b)if(b.hasOwnProperty(a)&&b[a]!==c[a])return!1;return!0},generateID:function(b){for(var c="",b=b?b:10;c.length<b;)c+=String.fromCharCode(65+
Math.floor(Math.random()*26));return"captionator"+c},captionify:function(b,e,a){var f=[],d=0,a=a instanceof Object?a:{};if(a.minimumFontSize&&typeof a.minimumFontSize==="number")x=a.minimumFontSize;if(a.minimumLineHeight&&typeof a.minimumLineHeight==="number")y=a.minimumLineHeight;if(a.fontSizeVerticalPercentage&&typeof a.fontSizeVerticalPercentage==="number")A=a.fontSizeVerticalPercentage;if(a.lineHeightRatio&&typeof a.lineHeightRatio!=="number")B=a.lineHeightRatio;if(a.cueBackgroundColour&&a.cueBackgroundColour instanceof
Array)E=a.cueBackgroundColour;if(HTMLVideoElement){if(typeof document.createElement("video").addTextTrack==="function")return!1}else return!1;if(!F){c.TextTrack=function(a,b,e,d,f,m){this.onload=function(){};this.onerror=function(){};this.oncuechange=function(){};this.id=a||"";this.internalMode=c.TextTrack.OFF;this.cues=new c.TextTrackCueList(this);this.activeCues=new c.ActiveTextTrackCueList(this.cues,this);this.kind=b||"subtitles";this.label=e||"";this.language=d||"";this.src=f||"";this.readyState=
c.TextTrack.NONE;this.internalDefault=m||!1;this.getMode=function(){return this.internalMode};this.setMode=function(a){if([c.TextTrack.OFF,c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode){this.internalMode=a;this.readyState===c.TextTrack.NONE&&this.src.length>0&&a>c.TextTrack.OFF&&this.loadTrack(this.src,null);this.readyState===c.TextTrack.LOADED&&c.rebuildCaptions(this.videoNode);if((a===c.TextTrack.OFF||a===c.TextTrack.HIDDEN)&&this.videoNode.containerObject)try{this.videoNode.containerObject.parentNode.removeChild(this.videoNode.containerObject)}catch(b){}if(a===
c.TextTrack.OFF)this.cues.length=0,this.readyState=c.TextTrack.NONE}}else throw Error("Illegal mode value for track: "+a);};this.getDefault=function(){return this.internalDefault};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode),this.__defineGetter__("default",this.getDefault)):Object.defineProperty&&(Object.defineProperty(this,"mode",{get:this.getMode,set:this.setMode}),Object.defineProperty(this,"default",{get:this.getDefault}));
this.loadTrack=function(a,b){var e,h=new XMLHttpRequest;if(this.readyState===c.TextTrack.LOADED)b instanceof Function&&b(e);else{this.src=a;this.readyState=c.TextTrack.LOADING;var i=this;h.open("GET",a,!0);h.onreadystatechange=function(){if(h.readyState===4)if(h.status===200){var a=i.videoNode._captionatorOptions||{};if(i.kind==="metadata")a.processCueHTML=!1,a.sanitiseCueHTML=!1;e=c.parseCaptions(h.responseText,a);i.readyState=c.TextTrack.LOADED;i.cues.loadCues(e);c.rebuildCaptions(i.videoNode);
i.onload.call(this);b instanceof Function&&b.call(i,e)}else i.readyState=c.TextTrack.ERROR,i.onerror()};try{h.send(null)}catch(d){i.readyState=c.TextTrack.ERROR,i.onerror(d)}}};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)this.cues.addCue(a);else throw Error("The argument is null or not an instance of TextTrackCue.");};this.removeCue=function(){}};c.TextTrack.NONE=0;c.TextTrack.LOADING=1;c.TextTrack.LOADED=2;c.TextTrack.ERROR=3;c.TextTrack.OFF=0;c.TextTrack.HIDDEN=1;c.TextTrack.SHOWING=
2;c.TextTrackCueList=function(a){this.track=a instanceof c.TextTrack?a:null;this.getCueById=function(a){return this.filter(function(b){return b.id===a})[0]};this.loadCues=function(a){for(var b=0;b<a.length;b++)a[b].track=this.track,Array.prototype.push.call(this,a[b])};this.addCue=function(a){if(a&&a instanceof c.TextTrackCue)if(a.track===this.track||!a.track)Array.prototype.push.call(this,a);else throw Error("This cue is associated with a different track!");else throw Error("The argument is null or not an instance of TextTrackCue.");
};this.toString=function(){return"[TextTrackCueList]"}};c.TextTrackCueList.prototype=[];c.ActiveTextTrackCueList=function(a,b){this.refreshCues=function(){if(a.length){var c=this,e=!1,d=[].slice.call(this,0);this.length=0;a.forEach(function(a){a.active&&(c.push(a),c[c.length-1]!==d[c.length-1]&&(e=!0))});if(e)try{b.oncuechange()}catch(f){}}};this.toString=function(){return"[ActiveTextTrackCueList]"};this.refreshCues()};c.ActiveTextTrackCueList.prototype=new c.TextTrackCueList(null);c.TextTrackCue=
function(a,b,e,d,f,m,j){this.id=a;this.track=j instanceof c.TextTrack?j:null;this.startTime=parseFloat(b);this.endTime=parseFloat(e);this.text=typeof d==="string"||d instanceof c.CaptionatorCueStructure?d:"";this.settings=typeof f==="string"?f:"";this.intSettings={};this.pauseOnExit=!!m;this.wasActive=!1;this.direction="horizontal";this.snapToLines=!0;this.linePosition="auto";this.textPosition=50;this.size=0;this.alignment="middle";if(this.settings.length){var n=this.intSettings,p=this,f=f.split(/\s+/).filter(function(a){return a.length>
0});f instanceof Array&&f.forEach(function(a){var b={D:"direction",L:"linePosition",T:"textPosition",A:"alignment",S:"size"},a=a.split(":");b[a[0]]&&(n[b[a[0]]]=a[1]);b[a[0]]in p&&(p[b[a[0]]]=a[1])})}if(this.linePosition.match(/\%/))this.snapToLines=!1;this.getCueAsSource=function(){return String(this.text)};this.getCueAsHTML=function(){var a=document.createDocumentFragment(),b=document.createElement("div");b.innerHTML=String(this.text);Array.prototype.forEach.call(b.childNodes,function(b){a.appendChild(b.cloneNode(!0))});
return a};this.isActive=function(){var a=0;if(this.track instanceof c.TextTrack&&this.track.mode===c.TextTrack.SHOWING&&this.track.readyState===c.TextTrack.LOADED)try{if(a=this.track.videoNode.currentTime,this.startTime<=a&&this.endTime>=a){if(!this.wasActive)this.wasActive=!0,this.onenter();return!0}}catch(b){return!1}if(this.wasActive)this.wasActive=!1,this.onexit();return!1};Object.prototype.__defineGetter__?this.__defineGetter__("active",this.isActive):Object.defineProperty&&Object.defineProperty(this,
"active",{get:this.isActive});this.toString=function(){return"TextTrackCue:"+this.id+"\n"+String(this.text)};this.onenter=function(){};this.onexit=function(){}};c.MediaTrack=function(a,b,e,d,f,m){var j=function(a){return a.filter(function(a){try{var b=document.createElement(a.getAttribute("type").split("/").shift());return!(!b.canPlayType||!b.canPlayType(a.getAttribute("type")).replace(/no/,""))}catch(c){return!1}}).shift().getAttribute("src")};this.onload=function(){};this.onerror=function(){};this.id=
a||"";this.internalMode=this.internalMode=c.TextTrack.OFF;this.mediaElement=null;this.kind=b||"audiodescription";this.label=e||"";this.language=d||"";this.readyState=c.TextTrack.NONE;this.type=m||"x/unknown";this.mediaType=null;this.src="";if(typeof f==="string")this.src=f;else if(f instanceof NodeList)this.src=j(f);if(this.type.match(/^video\//))this.mediaType="video";else if(this.type.match(/^audio\//))this.mediaType="audio";this.getMode=function(){return this.internalMode};this.setMode=function(a){if([c.TextTrack.OFF,
c.TextTrack.HIDDEN,c.TextTrack.SHOWING].indexOf(a)!==-1){if(a!==this.internalMode)this.internalMode=a,a===c.TextTrack.HIDDEN&&!this.mediaElement&&this.buildMediaElement(),a===c.TextTrack.SHOWING&&this.showMediaElement(),(a===c.TextTrack.OFF||a===c.TextTrack.HIDDEN)&&this.hideMediaElement()}else throw Error("Illegal mode value for track.");};Object.prototype.__defineGetter__?(this.__defineGetter__("mode",this.getMode),this.__defineSetter__("mode",this.setMode)):Object.defineProperty&&Object.defineProperty(this,
"mode",{get:this.getMode,set:this.setMode});this.hideMediaElement=function(){if(this.mediaElement&&(this.mediaElement.paused||this.mediaElement.pause(),this.mediaElement instanceof HTMLVideoElement))this.mediaElement.style.display="none"};this.showMediaElement=function(){if(this.mediaElement){if(this.mediaElement.parentNode||document.body.appendChild(this.mediaElement),this.mediaElement instanceof HTMLVideoElement)this.mediaElement.style.display="block"}else this.buildMediaElement(),document.body.appendChild(this.mediaElement)};
this.buildMediaElement=function(){try{if(this.type.match(/^video\//))this.mediaElement=document.createElement("video"),this.mediaElement.className="captionator-mediaElement-"+this.kind,c.styleNode(this.mediaElement,this.kind,this.videoNode);else if(this.type.match(/^audio\//))this.mediaElement=new Audio;this.mediaElement.type=this.type;this.mediaElement.src=this.src;this.mediaElement.load();this.mediaElement.trackObject=this;this.readyState=c.TextTrack.LOADING;var a=this.mediaElement;this.mediaElement.addEventListener("progress",
function(){a.trackObject.readyState=c.TextTrack.LOADING},!1);this.mediaElement.addEventListener("canplaythrough",function(){a.trackObject.readyState=c.TextTrack.LOADED;a.trackObject.onload.call(a.trackObject)},!1);this.mediaElement.addEventListener("error",function(b){a.trackObject.readyState=c.TextTrack.ERROR;a.trackObject.mode=c.TextTrack.OFF;a.trackObject.mediaElement=null;a.trackObject.onerror.call(a.trackObject,b)},!1)}catch(b){this.readyState=c.TextTrack.ERROR,this.mode=c.TextTrack.OFF,this.mediaElement=
null,this.onerror&&this.onerror.apply(this,b)}}};c.CaptionatorCueStructure=function(a,b){var c=this;this.isTimeDependent=!1;this.cueSource=a;this.options=b;this.processedCue=null;this.toString=function(e){if(b.processCueHTML!==!1){var f=function(a,b){if(c.processedCue===null){var d="",h,g;for(h in a)if(h.match(/^\d+$/)&&a.hasOwnProperty(h))if(g=a[h],g instanceof Object&&g.children&&g.children.length)if(g.token==="v")d+='<q data-voice="'+g.voice.replace(/[\"]/g,"")+"\" class='voice speaker-"+g.voice.replace(/[^a-z0-9]+/ig,
"-").toLowerCase()+"' title=\""+g.voice.replace(/[\"]/g,"")+'">'+f(g.children,b+1)+"</q>";else if(g.token==="c")d+="<span class='webvtt-class-span "+g.classes.join(" ")+"'>"+f(g.children,b+1)+"</span>";else if(g.timeIn>0){if(e===null||e===void 0||e>0&&e>=g.timeIn)d+="<span class='webvtt-timestamp-span' data-timestamp='"+g.token+"' data-timestamp-seconds='"+g.timeIn+"'>"+f(g.children,b+1)+"</span>"}else d+=g.rawToken+f(g.children,b+1)+"</"+g.token+">";else if(g instanceof String||typeof g==="string"||
typeof g==="number")d+=g;if(!c.isTimeDependent&&b===0)c.processedCue=d;return d}else return c.processedCue};return f(this,0)}else return a}};c.CaptionatorCueStructure.prototype=[];if(a.exportObjects)window.TextTrack=c.TextTrack,window.TextTrackCueList=c.TextTrackCueList,window.ActiveTextTrackCueList=c.ActiveTextTrackCueList,window.TextTrackCue=c.TextTrackCue,window.MediaTrack=c.MediaTrack;F=!0}[].slice.call(document.getElementsByTagName("video"),0).forEach(function(a){a.addTextTrack=function(b,e,
d,f,m,j,n){var p="subtitles,captions,descriptions,captions,metadata,karaoke,lyrics,tickertext,audiodescription,commentary,alternate,signlanguage".split(","),w=p.slice(0,7),b=typeof b==="string"?b:"",d=typeof d==="string"?d:"",f=typeof f==="string"?f:"",n=typeof n==="boolean"?n:!1;if(!p.filter(function(a){return e===a?!0:!1}).length)throw c.createDOMException(12,"DOMException 12: SYNTAX_ERR: You must use a valid kind when creating a TimedTextTrack.","SYNTAX_ERR");if(w.filter(function(a){return e===
a?!0:!1}).length)if(b=new c.TextTrack(b,e,d,f,m,null)){if(!(a.tracks instanceof Array))a.tracks=[];a.tracks.push(b);return b}else return!1;else if(b=new c.MediaTrack(b,e,d,f,m,j,n)){if(!(a.mediaTracks instanceof Array))a.mediaTracks=[];a.mediaTracks.push(b);return b}else return!1}});if(!b||b===!1||b===void 0||b===null)f=[].slice.call(document.getElementsByTagName("video"),0);else if(b instanceof Array)for(d=0;d<b.length;d++)typeof b[d]==="string"?f=f.concat([].slice.call(document.querySelectorAll(b[d]),
0)):b[d].constructor===HTMLVideoElement&&f.push(b[d]);else typeof b==="string"?f=[].slice.call(document.querySelectorAll(b),0):b.constructor===HTMLVideoElement&&f.push(b);if(f.length){for(d=0;d<f.length;d++)c.processVideoElement(f[d],e,a);return!0}else return!1},processVideoElement:function(b,e,a){var f=[],d=navigator.language||navigator.userLanguage;e||d.split("-");a=a instanceof Object?a:{};if(!b.captioned){b._captionatorOptions=a;b.className+=(b.className.length?" ":"")+"captioned";b.captioned=
!0;if(b.id.length===0)b.id=c.generateID();[].slice.call(b.querySelectorAll("track"),0).forEach(function(d){var h=null,h=d.querySelectorAll("source").length>0?d.querySelectorAll("source"):d.getAttribute("src"),h=b.addTextTrack(d.getAttribute("id")||c.generateID(),d.getAttribute("kind"),d.getAttribute("label"),d.getAttribute("srclang").split("-")[0],h,d.getAttribute("type"),d.hasAttribute("default"));d.track=h;h.trackNode=d;h.videoNode=b;f.push(h);var i=!1;if((h.kind==="subtitles"||h.kind==="captions")&&
e===h.language&&a.enableCaptionsByDefault)f.filter(function(a){return(a.kind==="captions"||a.kind==="subtitles")&&e===a.language&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=!0);h.kind==="chapters"&&e===h.language&&(f.filter(function(a){return a.kind==="chapters"&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=!0));h.kind==="descriptions"&&a.enableDescriptionsByDefault===!0&&e===h.language&&(f.filter(function(a){return a.kind==="descriptions"&&a.mode===c.TextTrack.SHOWING?!0:!1}).length||(i=
!0));i===!0&&f.forEach(function(a){if(a.trackNode.hasAttribute("default")&&a.mode===c.TextTrack.SHOWING)a.mode=c.TextTrack.HIDDEN});if(d.hasAttribute("default")&&!f.filter(function(a){return a.trackNode.hasAttribute("default")&&a.trackNode!==d?!0:!1}).length)i=!0,h.internalDefault=!0;if(i===!0)h.mode=c.TextTrack.SHOWING});b.addEventListener("timeupdate",function(b){b=b.target;try{b.tracks.forEach(function(a){a.activeCues.refreshCues.apply(a.activeCues)})}catch(e){}a.renderer instanceof Function?a.renderer.call(c,
b):c.rebuildCaptions(b);c.synchroniseMediaElements(b)},!1);window.addEventListener("resize",function(){b._captionator_dirtyBit=!0;c.rebuildCaptions(b)},!1);b.addEventListener("play",function(){c.synchroniseMediaElements(b)},!1);b.addEventListener("pause",function(){c.synchroniseMediaElements(b)},!1)}return b},rebuildCaptions:function(b){var e=b.currentTime,a=[],f=!1,d=[],g=[];(b.tracks||[]).forEach(function(b){b.mode===c.TextTrack.SHOWING&&b.readyState===c.TextTrack.LOADED&&(g=[].slice.call(b.activeCues,
0),g=g.sort(function(a,b){return a.startTime>b.startTime?-1:1}),a=a.concat(g))});d=a.map(function(a){return a.track.id+"."+a.id+":"+a.text.toString(e).length});if((f=!c.compareArray(d,b._captionator_previousActiveCues))||b._captionator_dirtyBit)b._captionator_dirtyBit=!1,b._captionator_availableCueArea=null,b._captionator_previousActiveCues=d,c.styleCueCanvas(b),b._containerObject.innerHTML="",a.forEach(function(a){var d=document.createElement("div");d.id=String(a.id).length?a.id:c.generateID();d.className=
"captionator-cue";d.innerHTML=a.text.toString(e);b._containerObject.appendChild(d);c.styleCue(d,a,b)})},synchroniseMediaElements:function(b){var e=function(a,b){try{b.seeking&&a.pause();if(a.currentTime<b.currentTime-0.5||a.currentTime>b.currentTime+0.5)a.currentTime=b.currentTime;a.paused&&!b.paused?a.play():!a.paused&&b.paused&&a.pause()}catch(c){}};(b.mediaTracks||[]).forEach(function(a){a.mode===c.TextTrack.SHOWING&&a.readyState>=c.TextTrack.LOADING&&e(a.mediaElement,b)});b.id&&[].slice.call(document.body.querySelectorAll("*[syncMaster="+
b.id+"]"),0).forEach(function(a){(a.tagName.toLowerCase()==="video"||a.tagName.toLowerCase()==="audio")&&e(a,b)})},getNodeMetrics:function(b){for(var c=window.getComputedStyle(b,null),a=b,f=b.offsetTop,d=b.offsetLeft,g=b,h=0,i=0,g=parseInt(c.getPropertyValue("width"),10),h=parseInt(c.getPropertyValue("height"),10);a=a.offsetParent;)f+=a.offsetTop,d+=a.offsetLeft;if(b.hasAttribute("controls"))b=navigator.userAgent.toLowerCase(),b.indexOf("chrome")!==-1?i=32:b.indexOf("opera")!==-1?i=25:b.indexOf("firefox")!==
-1?i=28:b.indexOf("ie 9")!==-1||b.indexOf("ipad")!==-1?i=44:b.indexOf("safari")!==-1&&(i=25);else if(b._captionatorOptions)b=b._captionatorOptions,b.controlHeight&&(i=parseInt(b.controlHeight,10));return{left:d,top:f,width:g,height:h,controlHeight:i}},applyStyles:function(b,c){for(var a in c)({}).hasOwnProperty.call(c,a)&&(b.style[a]=c[a])},checkDirection:function(b){var c=RegExp("^[^\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]*[A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]");
return RegExp("^[^A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]*[\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]").test(b)?"rtl":c.test(b)?"ltr":""},styleCue:function(b,e,a){var f=0,d=0,g=0,h=0,i,v,s=0,m=0,j,n,p,w,t,z=0,C=i=d=0,k=0,D=0,u=0,l,q,o=0,s=a._captionatorOptions||{},r=50,f=j=0,r=!0,G=function(a){var b=function(a){return!!a.length},d,e,f,g,h=0,i=function(a){h++;c.applyStyles(a,{display:"block",lineHeight:"auto",height:n+"px",width:t+
"px",textAlign:"center"})};for(d in a.childNodes)if(a.childNodes.hasOwnProperty(d))e=a.childNodes[d],e.nodeType===3?(g=document.createDocumentFragment(),f=e.nodeValue,g.appendChild(document.createElement("span")),g.childNodes[0].innerHTML="<span class='captionator-cue-character'>"+f.split(/(.)/).filter(b).join("</span><span class='captionator-cue-character'>")+"</span>",[].slice.call(g.querySelectorAll("span.captionator-cue-character"),0).forEach(i),e.parentNode.replaceChild(g,e)):a.childNodes[d].nodeType===
1&&(h+=G(a.childNodes[d]));return h},k=c.getNodeMetrics(a);if(!a._captionator_availableCueArea)a._captionator_availableCueArea={bottom:k.height-k.controlHeight,right:k.width,top:0,left:0,height:k.height-k.controlHeight,width:k.width};e.direction==="horizontal"&&(c.applyStyles(b,{width:"auto",position:"static",display:"inline-block",padding:"1em"}),j=parseInt(b.offsetWidth,10),f=Math.floor(j/a._captionator_availableCueArea.width*100),f=f<=100?f:100);j=k.height*(A/100)/96*72;j=j>=x?j:x;n=Math.floor(j/
72*96);p=Math.floor(j*B);p=p>y?p:y;t=j=Math.ceil(p/72*96);j*Math.floor(k.height/j)<k.height&&(j=Math.floor(k.height/Math.floor(k.height/j)),p=Math.ceil(j/96*72));j*Math.floor(k.width/j)<k.width&&(t=Math.ceil(k.width/Math.floor(k.width/j)));d=Math.floor(a._captionator_availableCueArea.height/j);w=Math.floor(a._captionator_availableCueArea.width/t);parseFloat(String(e.size).replace(/[^\d\.]/ig,""))===0?s.sizeCuesByTextBoundingBox===!0?i=f:(i=100,r=!1):(r=!1,i=parseFloat(String(e.size).replace(/[^\d\.]/ig,
"")),i=i<=100?i:100);s=e.direction==="horizontal"?Math.floor(k.width*0.01):0;m=e.direction==="horizontal"?0:Math.floor(k.height*0.01);if(e.linePosition==="auto")e.linePosition=e.direction==="horizontal"?d:w;else if(String(e.linePosition).match(/\%/))e.snapToLines=!1,e.linePosition=parseFloat(String(e.linePosition).replace(/\%/ig,""));e.direction==="horizontal"?(h=j,e.textPosition!=="auto"&&r&&(r=parseFloat(String(e.textPosition).replace(/[^\d\.]/ig,"")),i-r>f?i-=r:i=f),g=e.snapToLines===!0?a._captionator_availableCueArea.width*
(i/100):k.width*(i/100),e.textPosition==="auto"?f=(a._captionator_availableCueArea.right-g)/2+a._captionator_availableCueArea.left:(r=parseFloat(String(e.textPosition).replace(/[^\d\.]/ig,"")),f=(a._captionator_availableCueArea.right-g)*(r/100)+a._captionator_availableCueArea.left),e.snapToLines===!0?d=(d-1)*j+a._captionator_availableCueArea.top:(i=k.controlHeight+j+m*2,d=(k.height-i)*(e.linePosition/100))):(d=a._captionator_availableCueArea.top,f=a._captionator_availableCueArea.right-t,g=t,h=a._captionator_availableCueArea.height*
(i/100),d=G(b),i=[].slice.call(b.querySelectorAll("span.captionator-cue-character"),0),z=Math.floor((h-m*2)/n),g=Math.ceil(d/z)*t,C=Math.ceil(d/z),D=(d-z*(C-1))*n,e.snapToLines===!0?f=e.direction==="vertical-lr"?a._captionator_availableCueArea.left:a._captionator_availableCueArea.right-g:(d=g+s*2,f=e.direction==="vertical-lr"?(k.width-d)*(e.linePosition/100):k.width-d-(k.width-d)*(e.linePosition/100)),e.textPosition==="auto"?d=(a._captionator_availableCueArea.bottom-h)/2+a._captionator_availableCueArea.top:
(e.textPosition=parseFloat(String(e.textPosition).replace(/[^\d\.]/ig,"")),d=(a._captionator_availableCueArea.bottom-h)*(e.textPosition/100)+a._captionator_availableCueArea.top),q=l=o=u=0,i.forEach(function(a){l=e.direction==="vertical-lr"?t*u:g-t*(u+1);e.alignment==="start"||e.alignment!=="start"&&u<C-1?q=o*n+m:e.alignment==="end"?q=o*n-n+(h+m*2-D):e.alignment==="middle"&&(q=(h-m*2-D)/2+o*n);c.applyStyles(a,{position:"absolute",top:q+"px",left:l+"px"});o>=z-1?(o=0,u++):o++}));e.direction==="horizontal"&&
(v=c.checkDirection(String(e.text))==="rtl"?{start:"right",middle:"center",end:"left"}[e.alignment]:{start:"left",middle:"center",end:"right"}[e.alignment]);c.applyStyles(b,{position:"absolute",overflow:"hidden",width:g+"px",height:h+"px",top:d+"px",left:f+"px",padding:m+"px "+s+"px",textAlign:v,backgroundColor:"rgba("+E.join(",")+")",direction:c.checkDirection(String(e.text)),lineHeight:p+"pt",boxSizing:"border-box"});if(e.direction==="vertical"||e.direction==="vertical-lr")f-a._captionator_availableCueArea.left-
a._captionator_availableCueArea.left>=a._captionator_availableCueArea.right-(f+g)?a._captionator_availableCueArea.right=f:a._captionator_availableCueArea.left=f+g,a._captionator_availableCueArea.width=a._captionator_availableCueArea.right-a._captionator_availableCueArea.left;else{if(b.scrollHeight>b.offsetHeight*1.2){if(e.snapToLines){for(v=0;b.scrollHeight>b.offsetHeight*1.2;)h+=j,b.style.height=h+"px",v++;d-=v*j}else h=b.scrollHeight+m,i=k.controlHeight+h+m*2,d=(k.height-i)*(e.linePosition/100),
b.style.height=h+"px";b.style.top=d+"px"}if(d-a._captionator_availableCueArea.top-a._captionator_availableCueArea.top>=a._captionator_availableCueArea.bottom-(d+h)&&a._captionator_availableCueArea.bottom>d)a._captionator_availableCueArea.bottom=d;else if(a._captionator_availableCueArea.top<d+h)a._captionator_availableCueArea.top=d+h;a._captionator_availableCueArea.height=a._captionator_availableCueArea.bottom-a._captionator_availableCueArea.top}},styleCueCanvas:function(b){var e,a,f=b._captionatorOptions instanceof
Object?b._captionatorOptions:{};if(!(b instanceof HTMLVideoElement))throw Error("Cannot style a cue canvas for a non-video node!");if(b._containerObject)a=b._containerObject,e=a.id;if(a)a.parentNode||document.body.appendChild(a);else{a=document.createElement("div");a.className="captionator-cue-canvas";e=c.generateID();a.id=e;if(f.appendCueCanvasTo){var d=null;if(f.appendCueCanvasTo instanceof HTMLElement)d=f.appendCueCanvasTo;else if(typeof f.appendCueCanvasTo==="string")try{var g=document.querySelectorAll(f.appendCueCanvasTo);
if(g.length>0)d=g[0];else throw null;}catch(h){d=document.body,f.appendCueCanvasTo=!1}else d=document.body,f.appendCueCanvasTo=!1;d.appendChild(a)}else document.body.appendChild(a);b._containerObject=a;a.setAttribute("aria-live","polite");a.setAttribute("aria-atomic","true")}String(b.getAttribute("aria-describedby")).indexOf(e)===-1&&(d=b.hasAttribute("aria-describedby")?b.getAttribute("aria-describedby")+" ":"",b.setAttribute("aria-describedby",d+e));d=c.getNodeMetrics(b);b=d.height*(A/100)/96*72;
b=b>=x?b:x;e=Math.floor(b*B);e=e>y?e:y;c.applyStyles(a,{position:"absolute",overflow:"hidden",zIndex:100,height:d.height-d.controlHeight+"px",width:d.width+"px",top:(f.appendCueCanvasTo?0:d.top)+"px",left:(f.appendCueCanvasTo?0:d.left)+"px",color:"white",fontFamily:"Verdana, Helvetica, Arial, sans-serif",fontSize:b+"pt",lineHeight:e+"pt",boxSizing:"border-box"});if(window.navigator.userAgent.toLowerCase().indexOf("chrome/10")>-1)a.style.backgroundColor="rgba(0,0,0,0.01"+Math.random().toString().replace(".",
"")+")"},parseCaptions:function(b,e){var e=e instanceof Object?e:{},a="",f=[],d="",g=[],h=/^(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\,(\d{2})?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,i=/^(\d+)?:?(\d{2}):(\d{2})\.(\d+)\,(\d+)?:?(\d{2}):(\d{2})\.(\d+)\s*(.*)/,v=/^(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s+\-\-\>\s+(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)\s*(.*)/,s=/(\d{2})?:?(\d{2}):(\d{2})[\.\,](\d+)/,m=/^([\d\.]+)\s+\+([\d\.]+)\s*(.*)/,j=/^\[(\d{2})?:?(\d{2})\:(\d{2})\.(\d{2})\]\s*(.*?)$/i,n=/^(DEFAULTS|DEFAULT)\s+\-\-\>\s+(.*)/g,
p=/^(STYLE|STYLES)\s+\-\-\>\s*\n([\s\S]*)/g,w=/^(COMMENT|COMMENTS)\s+\-\-\>\s+(.*)/g;if(b){var t=function(a){var b=new c.CaptionatorCueStructure(a,e),d=[],f,g,h,i=[];h=0;var j=function(a){return!!a.replace(/[^a-z0-9]+/ig,"").length},d=a.split(/(<\/?[^>]+>)/ig).filter(function(a){return!!a.replace(/\s*/ig,"")});h=b;for(f in d)if(d.hasOwnProperty(f))if(g=d[f],g.substr(0,1)==="<")if(g.substr(1,1)==="/"){if(a=g.substr(2).split(/[\s>]+/g)[0],i.length>0){g=0;for(h=i.length-1;h>=0;h--){var m=i[h][i[h].length-
1];g=h;if(m.token===a)break}h=i[g];i=i.slice(0,g)}}else{if(g.substr(1).match(s)||g.match(/^<v\s+[^>]+>/i)||g.match(/^<c[a-z0-9\-\_\.]+>/)||g.match(/^<(b|i|u|ruby|rt)>/)||e.sanitiseCueHTML!==!1){a={token:g.replace(/[<\/>]+/ig,"").split(/[\s\.]+/)[0],rawToken:g,children:[]};if(a.token==="v")a.voice=g.match(/^<v\s*([^>]+)>/i)[1];else if(a.token==="c")a.classes=g.replace(/[<\/>\s]+/ig,"").split(/[\.]+/ig).slice(1).filter(j);else if(g=a.rawToken.match(s))b.isTimeDependent=!0,g=g.slice(1),a.timeIn=parseInt((g[0]||
0)*3600,10)+parseInt((g[1]||0)*60,10)+parseInt(g[2]||0,10)+parseFloat("0."+(g[3]||0));h.push(a);i.push(h);h=a.children}}else e.sanitiseCueHTML!==!1&&(g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\&/g,"&amp;"),e.ignoreWhitespace||(g=g.replace(/\n+/g,"<br />"))),h.push(g);return b},f=b.replace(/\r\n/g,"\n").replace(/\r/g,"\n");j.exec(b)?(f=f.split(/\n+/g),a="LRC"):f=f.split(/\n\n+/g);return f=f.filter(function(b){return b.match(/^WEBVTT(\s*FILE)?/ig)?(a="WebVTT",!1):b.replace(/\s*/ig,"").length?
!0:!1}).map(function(b,f){var k,j,u,l,q="",o;if(o=n.exec(b))return g=o.slice(2).join(""),g=g.split(/\s+/g).filter(function(a){return a&&!!a.length}),null;else if(o=p.exec(b))return d+=o[o.length-1],null;else if(o=w.exec(b))return null;for(k=a==="LRC"?[b.substr(0,b.indexOf("]")),b.substr(b.indexOf("]")+1)]:b.split(/\n/g);!k[0].replace(/\s+/ig,"").length&&k.length>0;)k.shift();for(o=k[0].match(/^\s*[a-z0-9]+\s*$/ig)?String(k.shift().replace(/\s*/ig,"")):f;0<k.length;){var r=k[0];if((l=v.exec(r))||(l=
h.exec(r))||(l=i.exec(r)))l=l.slice(1),j=parseInt((l[0]||0)*3600,10)+parseInt((l[1]||0)*60,10)+parseInt(l[2]||0,10)+parseFloat("0."+(l[3]||0)),u=parseInt((l[4]||0)*3600,10)+parseInt((l[5]||0)*60,10)+parseInt(l[6]||0,10)+parseFloat("0."+(l[7]||0)),l[8]&&(q=l[8]);else if(l=m.exec(r))l=l.slice(1),j=parseFloat(l[0]),u=j+parseFloat(l[1]),l[2]&&(q=l[2]);k=k.slice(0,0).concat(k.slice(1));break}if(!j&&!u)return null;var s=g.reduce(function(a,b){a[b.split(":")[0]]=b.split(":")[1];return a},{}),s=q.split(/\s+/g).filter(function(a){return a&&
!!a.length}).reduce(function(a,b){a[b.split(":")[0]]=b.split(":")[1];return a},s),q="";Object.keys(s).forEach(function(a){q+=q.length?" ":"";q+=a+":"+s[a]});k=e.processCueHTML===!1?k.join("\n"):t(k.join("\n"));j=new c.TextTrackCue(o,j,u,k,q,!1,null);j.styleData=d;return j}).filter(function(a){return a!==null?!0:!1})}else throw Error("Required parameter captionData not supplied.");}};window.captionator=c})();