var rules={newline:/^\n/,block:/^[ ]{4,}[^\n]*(?:\n[ ]{4,}[^\n]*)*/,heading:/^ *(#{1,6}) *([^\n#]*) *#*/,lheading:/^([^\n]+)\n *(=|-){3,}/,hr:/^( ?[\-*_]){3,}/,blockquote:/^ *>[^\n]*(?:\n *>[^\n]*)*/,list:/^(?:( *)(\*|\+|-|\d+\.)[^\n]+(?:\n(?:\1 )+[^\n]+)*(?:\n+|$)){2,}/g,html:/^<([^\/\s>]+)[^\n>]*>[^\n]*(?:\n[^\n]+)*\n?<\/\1>/,text:/^[^\n]+/};var keys=Object.keys(rules),len=keys.length;var line,links,token,tokens;var lex=function(e,d){if(!d){d=[];line=0;e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n");e=e.replace(/\t/g,"    ");links={};e=e.replace(/^ {0,3}\[([^\]]+)\]: *([^ ]+)(?: +"([^"]+)")?/gm,function(g,i,f,h){links[i]={href:f,title:h};return""})}var b,a,c;while(e.length){for(b=0;b<len;b++){a=keys[b];c=rules[a];cap=c.exec(e);if(!cap){continue}e=e.substring(cap[0].length);switch(a){case"newline":line++;break;case"hr":d.push({type:"hr",line:line});break;case"lheading":d.push({type:"heading",depth:cap[2]==="="?1:2,text:cap[1],line:line});break;case"heading":d.push({type:"heading",depth:cap[1].length,text:cap[2],line:line});break;case"block":cap=cap[0].replace(/^ +/gm,"");d.push({type:"block",text:cap,line:line});break;case"list":d.push({type:"list_start",ordered:isFinite(cap[2]),line:line});cap=cap[0].match(/^( *)(\*|\+|-|\d+\.)[^\n]+(?:\n(?:\1 )+[^\n]+)*/gm);cap.forEach(function(g){g=g.replace(/^ *(\*|\+|-|\d+\.) */,"");var f=/\n( +)/.exec(g);if(f){f=f[1].length;g=g.replace(new RegExp("^ {"+f+"}","gm"),"")}d.push({type:"list_item_start",line:line});lex(g,d);d.push({type:"list_item_end",line:line})});d.push({type:"list_end",line:line});break;case"html":case"text":d.push({type:a,text:cap[0],line:line});break;case"blockquote":d.push({type:"blockquote_start",line:line});cap=cap[0].replace(/^ *>/gm,"");lex(cap,d);d.push({type:"blockquote_end",line:line});break}break}}return d};var inline=function(a){a=a.replace(/!\[([^\]]+)\]\(([^\s\)]+)\s*([^\)]*)\)/g,function(b,c,e,d){return'<img src="'+e+'" alt="'+c+'"'+(d?' title="'+d+'"':"")+">"});a=a.replace(/\[([^\]]+)\]\(([^\)]+)\)/g,'<a href="$2">$1</a>');a=a.replace(/\[([^\]]+)\]\[([^\]]+)\]/g,function(b,d,e){var c=links[e];return'<a href="'+c.href+'"'+(c.title?' title="'+c.title+'"':"")+">"+d+"</a>"});a=a.replace(/(?:<|&lt;)([^<>:\/ ]+:(?:\/\/)?[^>\n]+?|[^<>\n]+?(@)[^<>\n]+?)(?:&gt;|>)/g,function(e,d,b){if(b){var d=mangle(d),c=mangle("mailto:")+d;return'<a href="'+c+'">'+d+"</a>"}return'<a href="'+d+'">'+d+"</a>"});a=a.replace(/__([^_]+)__/g,"<strong>$1</strong>");a=a.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>");a=a.replace(/_([^_]+)_/g,"<em>$1</em>");a=a.replace(/\*([^*]+)\*/g,"<em>$1</em>");a=a.replace(/`([^`]+)`/g,function(b,c){return"<code>"+escape(c)+"</code>"});a=a.replace(/  $/gm,"<br>");return a};var next=function(){return token=tokens.pop()};var tok=function(){switch(token.type){case"hr":return"<hr>";case"heading":return"<h"+token.depth+">"+inline(token.text)+"</h"+token.depth+">";case"block":return"<pre><code>"+escape(token.text)+"</code></pre>";case"blockquote_start":var a=[];while(next().type!=="blockquote_end"){a.push(tok())}return"<blockquote>"+a.join("")+"</blockquote>";case"list_start":var a=[],b=token.ordered?"ol":"ul";while(next().type!=="list_end"){a.push(tok())}return"<"+b+">"+a.join("")+"</"+b+">";case"list_item_start":var a=[];while(next().type!=="list_item_end"){if(token.type==="text"){a.push(inline(token.text))}else{a.push(tok())}}return"<li>"+a.join(" ")+"</li>";case"html":return inline(token.text);case"text":var a=[],c=token.line;while(token&&token.type==="text"){if(token.line>c){break}c=token.line+1;a.push(token.text);next()}if(token){tokens.push(token)}return"<p>"+inline(a.join(" "))+"</p>"}};var parse=function(b){tokens=b.reverse();var a=[];while(next()){a.push(tok())}tokens=null;token=null;links=null;line=null;return a.join("\n")};var escape=function(a,b){return a.replace(b?/&(?![^;\n]+;)/:/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};var mangle=function(e){var d,c=0,a=e.length,b="";for(;c<a;c++){d=e[c].charCodeAt(0);if(Math.random()>0.5){d="x"+d.toString(16)}b+="&#"+d+";"}return b};exports=function(a){return parse(lex(a))};exports.parser=parse;exports.lexer=lex;module.exports=exports;