/** Operative v0.4.0-rc1 (c) 2013 James padolsey, MIT-licensed, http://github.com/padolsey/operative **/
(function(){function makeBlobURI(e){var r;try{r=new Blob([e],{type:"text/javascript"})}catch(t){r=new BlobBuilder,r.append(e),r=r.getBlob()}return URL.createObjectURL(r)}function OperativeTransfers(e){this.value=e}function Operative(e,r){var t=this;e.get=e.get||function(e){return this[e]},e.set=e.set||function(e,r){return this[e]=r},this._curToken=0,this._queue=[],this.isDestroyed=!1,this.isContextReady=!1,this.module=e,this.dependencies=r||[],this.dataProperties={},this.api={},this.callbacks={},this.deferreds={},this._fixDependencyURLs(),this._setup();for(var n in e)hasOwn.call(e,n)&&this._createExposedMethod(n);this.api.__operative__=this,this.api.destroy=this.api.terminate=function(){return t.destroy()}}function operative(e,r){var t=operative.hasWorkerSupport?Operative.Worker:Operative.Iframe;if("function"==typeof e){var n=new t({main:e},r),o=function(){return n.api.main.apply(n,arguments)};o.transfer=function(){return n.api.main.transfer.apply(n,arguments)};for(var i in n.api)hasOwn.call(n.api,i)&&(o[i]=n.api[i]);return o}return new t(e,r).api}function iframeBoilerScript(){window.__run__=function(e,r,t,n){function o(){return t.apply(this,arguments)}var i=!1,s=!1;window.async=function(){return i=!0,t},window.deferred=function(){return s=!0,n},o.transfer=function(){return t.apply(this,[].slice.call(arguments,0,arguments.length-1))},t&&r.push(o);var a=window[e].apply(window,r);window.async=function(){throw Error("Operative: async() called at odd time")},window.deferred=function(){throw Error("Operative: deferred() called at odd time")},s||i||void 0===a||o(a)}}function workerBoilerScript(){var postMessage=self.postMessage,structuredCloningSupport=null,toString={}.toString;self.console={},self.isWorker=!0,["log","debug","error","info","warn","time","timeEnd"].forEach(function(e){self.console[e]=function(){postMessage({cmd:"console",method:e,args:[].slice.call(arguments)})}}),self.addEventListener("message",function(e){function returnResult(e,r){postMessage({cmd:"result",token:data.token,result:e},hasTransferSupport&&r||[])}function extractTransfers(e){var r=e[e.length-1];if("[object Array]"!==toString.call(r))throw Error("Operative: callback.transfer() must be passed an Array of transfers as its last arguments");return r}var data=e.data;if("string"==typeof data&&0===data.indexOf("EVAL|"))return eval(data.substring(5)),void 0;if(null==structuredCloningSupport)return structuredCloningSupport="PING"===e.data[0],self.postMessage(structuredCloningSupport?"pingback:structuredCloningSupport=YES":"pingback:structuredCloningSupport=NO"),structuredCloningSupport||(postMessage=function(e){return self.postMessage(JSON.stringify(e))}),void 0;structuredCloningSupport||(data=JSON.parse(data));var defs=data.definitions,isDeferred=!1,isAsync=!1,args=data.args;if(defs)for(var i in defs)self[i]=defs[i];else{var callback=function(){returnResult({args:[].slice.call(arguments)})};callback.transfer=function(){var e=[].slice.call(arguments),r=extractTransfers(e);returnResult({args:e},r)},args.push(callback),self.async=function(){return isAsync=!0,function(){returnResult({args:[].slice.call(arguments)})}},self.deferred=function(){function e(e,r){return returnResult({isDeferred:!0,action:"resolve",args:[e]},r),t}function r(e,r){returnResult({isDeferred:!0,action:"reject",args:[e]},r)}isDeferred=!0;var t={};return t.fulfil=t.fulfill=t.resolve=function(r){return e(r)},t.reject=function(e){return r(e)},t.transferResolve=function(r){var t=extractTransfers(arguments);return e(r,t)},t.transferReject=function(e){var t=extractTransfers(arguments);return r(e,t)},t};var result=self[data.method].apply(self,args);isDeferred||isAsync||void 0===result||returnResult({args:[result]}),self.deferred=function(){throw Error("Operative: deferred() called at odd time")},self.async=function(){throw Error("Operative: async() called at odd time")}}})}if("undefined"==typeof window&&self.importScripts)return workerBoilerScript(),void 0;var slice=[].slice,hasOwn={}.hasOwnProperty,toString={}.toString,scripts=document.getElementsByTagName("script"),opScript=scripts[scripts.length-1],opScriptURL=/operative/.test(opScript.src)&&opScript.src,baseURL=(location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+location.pathname).replace(/[^\/]+$/,""),URL=window.URL||window.webkitURL,BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,workerViaBlobSupport=function(){try{new Worker(makeBlobURI(";"))}catch(e){return!1}return!0}(),transferrableObjSupport=function(){try{var e=new ArrayBuffer(1);return new Worker(makeBlobURI(";")).postMessage(e,[e]),!e.byteLength}catch(r){return!1}}(),objCreate=Object.create||function(e){function r(){}return r.prototype=e,new r};operative.hasWorkerSupport=!!window.Worker,operative.hasWorkerViaBlobSupport=workerViaBlobSupport,operative.hasTransferSupport=transferrableObjSupport,operative.Promise=window.Promise,"function"==typeof define&&define.amd?define(function(){return operative}):"undefined"!=typeof module&&module.exports?module.exports=operative:window.operative=operative,operative.setSelfURL=function(e){opScriptURL=e},operative.setBaseURL=function(e){baseURL=e},operative.getBaseURL=function(){return baseURL},Operative.prototype={_marshal:function(e){return e},_demarshal:function(e){return e},_enqueue:function(e){this._queue.push(e)},_fixDependencyURLs:function(){for(var e=this.dependencies,r=0,t=e.length;t>r;++r){var n=e[r];/\/\//.test(n)||(e[r]=n.replace(/^\/?/,baseURL))}},_dequeueAll:function(){for(var e=0,r=this._queue.length;r>e;++e)this._queue[e].call(this);this._queue=[]},_buildContextScript:function(e){var r,t=[],n=this.module,o=this.dataProperties;for(var i in n)r=n[i],"function"==typeof r?t.push('   self["'+i.replace(/"/g,'\\"')+'"] = '+(""+r)+";"):o[i]=r;return t.join("\n")+(e?"\n("+(""+e)+"());":"")},_createExposedMethod:function(e){var r=this,t=this.api[e]=function(){function t(){r.isContextReady?r._runMethod(e,n,o,s):r._enqueue(t)}if(r.isDestroyed)throw Error("Operative: Cannot run method. Operative has already been destroyed");var n=++r._curToken,o=slice.call(arguments),i="function"==typeof o[o.length-1]&&o.pop(),s=o[o.length-1]instanceof OperativeTransfers&&o.pop();if(!i&&!operative.Promise)throw Error("Operative: No callback has been passed. Assumed that you want a promise. But `operative.Promise` is null. Please provide Promise polyfill/lib.");if(i)r.callbacks[n]=i,setTimeout(function(){t()},1);else if(operative.Promise)return new operative.Promise(function(e,o){var i;e.fulfil||e.fulfill?(i=e,i.fulfil=i.fulfill=e.fulfil||e.fulfill):i={fulfil:e,fulfill:e,resolve:e,reject:o,transferResolve:e,transferReject:o},r.deferreds[n]=i,t()})};t.transfer=function(){var e=[].slice.call(arguments),r="function"==typeof e[e.length-1]?e.length-2:e.length-1,n=e[r];if("[object Array]"!==toString.call(n))throw Error("Operative:transfer() must be passed an Array of transfers as its last arguments");return e[r]=new OperativeTransfers(n),t.apply(null,e)}},destroy:function(){this.isDestroyed=!0}},Operative.Worker=function Worker(){this._msgQueue=[],Operative.apply(this,arguments)};var WorkerProto=Operative.Worker.prototype=objCreate(Operative.prototype);WorkerProto._onWorkerMessage=function(e){var r=e.data;if("string"==typeof r&&0===r.indexOf("pingback"))return"pingback:structuredCloningSupport=NO"===r&&(this._marshal=function(e){return JSON.stringify(e)},this._demarshal=function(e){return JSON.parse(e)}),this.isContextReady=!0,this._postMessage({definitions:this.dataProperties}),this._dequeueAll(),void 0;switch(r=this._demarshal(r),r.cmd){case"console":window.console&&window.console[r.method].apply(window.console,r.args);break;case"result":var t=this.callbacks[r.token],n=this.deferreds[r.token],o=r.result&&r.result.isDeferred&&r.result.action;n&&o?n[o](r.result.args[0]):t?t.apply(this,r.result.args):n&&n.fulfil(r.result.args[0])}},WorkerProto._setup=function(){var e,r=this,t=this._buildContextScript(workerViaBlobSupport?workerBoilerScript:"");if(this.dependencies.length&&(t='importScripts("'+this.dependencies.join('", "')+'");\n'+t),workerViaBlobSupport)e=this.worker=new Worker(makeBlobURI(t));else{if(!opScriptURL)throw Error("Operaritve: No operative.js URL available. Please set via operative.setSelfURL(...)");e=this.worker=new Worker(opScriptURL),e.postMessage("EVAL|"+t)}e.postMessage(["PING"]),e.postMessage("EVAL|self.hasTransferSupport="+transferrableObjSupport),e.addEventListener("message",function(e){r._onWorkerMessage(e)})},WorkerProto._postMessage=function(e){var r=transferrableObjSupport&&e.transfers;return r?this.worker.postMessage(e,r.value):this.worker.postMessage(this._marshal(e))},WorkerProto._runMethod=function(e,r,t,n){this._postMessage({method:e,args:t,token:r,transfers:n})},WorkerProto.destroy=function(){this.worker.terminate(),Operative.prototype.destroy.call(this)},Operative.Iframe=function Iframe(){Operative.apply(this,arguments)};var IframeProto=Operative.Iframe.prototype=objCreate(Operative.prototype),_loadedMethodNameI=0;IframeProto._setup=function(){var e=this,r="__operativeIFrameLoaded"+ ++_loadedMethodNameI;this.module.isWorker=!1;var t=this.iframe=document.body.appendChild(document.createElement("iframe"));t.style.display="none";var n=this.iframeWindow=t.contentWindow,o=n.document;window[r]=function(){window[r]=null;var t=o.createElement("script"),i=e._buildContextScript(iframeBoilerScript);void 0!==t.text?t.text=i:t.innerHTML=i,o.documentElement.appendChild(t);for(var s in e.dataProperties)n[s]=e.dataProperties[s];e.isContextReady=!0,e._dequeueAll()},o.open(),this.dependencies.length&&o.write('<script src="'+this.dependencies.join('"></script><script src="')+'"></script>'),o.write("<script>window.parent."+r+"();</script>"),o.close()},IframeProto._runMethod=function(e,r,t){var n=this,o=this.callbacks[r],i=this.deferreds[r];this.iframeWindow.__run__(e,t,function(e){var r=o,t=i;r?r.apply(n,arguments):t&&t.fulfil(e)},i)},IframeProto.destroy=function(){this.iframe.parentNode.removeChild(this.iframe),Operative.prototype.destroy.call(this)},operative.Operative=Operative,operative.pool=function(e,r,t){e=0|Math.abs(e)||1;for(var n=[],o=0,i=0;e>i;++i)n.push(operative(r,t));return{terminate:function(){for(var r=0;e>r;++r)n[r].destroy()},next:function(){return o=o+1===e?0:o+1,n[o]}}}})();