/** Operative v0.0.3 (c) 2013 James padolsey, MIT-licensed, http://github.com/padolsey/operative **/
(function(){function makeBlobURI(e){var t;try{t=new Blob([e],{type:"text/javascript"})}catch(r){t=new BlobBuilder,t.append(e),t=t.getBlob()}return URL.createObjectURL(t)}function Operative(e){var t=this;e.get=e.get||function(e){return this[e]},e.set=e.set||function(e,t){return this[e]=t},this._msgQueue=[],this._curToken=0,this.isDestroyed=!1,this.workerIsReady=!1,this.module=e,this.dataProperties={},this.api={},this.callbacks={},operative.hasWorkerSupport?this._setupWorker():this._setupFallback();for(var r in e)hasOwn.call(e,r)&&this._createExposedMethod(r);return this.api.__operative__=this,this.api.destroy=function(){return t.destroy()},this.api}function operative(e){return new Operative(e)}function workerBoilerScript(){var postMessage=self.postMessage,objectTransferSupport=null;self.console={},self.isWorker=!0,["log","debug","error","info","warn","time","timeEnd"].forEach(function(e){self.console[e]=function(){postMessage({cmd:"console",method:e,args:[].slice.call(arguments)})}}),self.addEventListener("message",function(e){function returnResult(e){postMessage({cmd:"result",token:data.token,result:e})}var data=e.data;if("string"==typeof data&&0===data.indexOf("EVAL|"))return eval(data.substring(5)),void 0;if(null==objectTransferSupport)return objectTransferSupport="PING"===e.data[0],self.postMessage(objectTransferSupport?"pingback:objectTransferSupport=YES":"pingback:objectTransferSupport=NO"),objectTransferSupport||(postMessage=function(e){return self.postMessage(JSON.stringify(e))}),void 0;objectTransferSupport||(data=JSON.parse(data));var defs=data.definitions;if(defs){for(var i in defs)self[i]=defs[i];return self.setup&&self.setup(),void 0}var isAsync=!1;self.async=function(){return isAsync=!0,function(e){returnResult(e)}};var result=self[data.method].apply(self,data.args);self.async=function(){throw Error("Operative: async() called at odd time")},isAsync||returnResult(result)})}if("undefined"==typeof window&&self.importScripts)return workerBoilerScript(),void 0;var slice=[].slice,hasOwn={}.hasOwnProperty,scripts=document.getElementsByTagName("script"),opScript=scripts[scripts.length-1],opScriptURL=/operative/.test(opScript.src)&&opScript.src,URL=window.URL||window.webkitURL,BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,workerViaBlobSupport=function(){try{new Worker(makeBlobURI(";"))}catch(e){return!1}return!0}();operative.hasWorkerSupport=!!window.Worker,window.operative=operative,operative.setSelfURL=function(e){opScriptURL=e},Operative.prototype={_buildWorkerScript:function(e){var t,r=[],s=this.module,o=this.dataProperties;for(var i in s){var t=s[i];"function"==typeof t?r.push('	self["'+i.replace(/"/g,'\\"')+'"] = '+(""+t)+";"):o[i]=t}return r.join("\n")+(e?"\n("+(""+workerBoilerScript)+"());":"")},_onWorkerMessage:function(e){var t=e.data;if("string"==typeof t&&0===t.indexOf("pingback"))return"pingback:objectTransferSupport=NO"===t&&(this._marshal=function(e){return JSON.stringify(e)},this._demarshal=function(e){return JSON.parse(e)}),this.workerIsReady=!0,this._postQueudMessages(),void 0;switch(t=this._demarshal(t),t.cmd){case"console":window.console&&window.console[t.method].apply(window.console,t.args);break;case"result":if(!(t.token in this.callbacks))throw Error("Operative: Unmatched token: "+t.token);var r=this.callbacks[t.token];delete this.callbacks[t.token],r(t.result)}},_marshal:function(e){return e},_demarshal:function(e){return e},_postWorkerMessage:function(e){return this.workerIsReady?this.worker.postMessage(this._marshal(e)):(this._msgQueue.push(e),void 0)},_postQueudMessages:function(){for(var e=this._msgQueue,t=0,r=e.length;r>t;++t)this._postWorkerMessage(e[t]);this._msgQueue=null},_setupWorker:function(){var e,t=this;if(workerViaBlobSupport)e=this.worker=new Worker(makeBlobURI(this._buildWorkerScript(!0)));else{if(!opScriptURL)throw Error("Operaritve: No operative.js URL available. Please set via operative.setSelfURL(...)");e=this.worker=new Worker(opScriptURL),e.postMessage("EVAL|"+this._buildWorkerScript(!1))}e.postMessage(["PING"]),e.addEventListener("message",function(e){t._onWorkerMessage(e)}),this._postWorkerMessage({definitions:this.dataProperties})},_createExposedMethod:function(e){var t=this;this.api[e]=function(){if(t.isDestroyed)throw Error("Operative: Cannot run method. Operative has already been destroyed");var r=++t._curToken,s=slice.call(arguments),o=s.pop();if("function"!=typeof o)throw new TypeError("Operative: Expected last argument to be Function (callback)");operative.hasWorkerSupport?(t._postWorkerMessage({method:e,args:s,token:r}),t.callbacks[r]=o):setTimeout(function(){var r=!1;t.module.async=function(){return r=!0,o};var i=t.module[e].apply(t.module,s);t.module.async=function(){throw Error("Operative: async() called at odd time")},r||o(i)},1)}},_setupFallback:function(){this.module.isWorker=!1,this.module.setup&&this.module.setup()},destroy:function(){this.isDestroyed=!0,this.worker&&this.worker.terminate()}},operative.Operative=Operative})();