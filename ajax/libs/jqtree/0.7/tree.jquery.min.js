(function(){var j,a,l,h,n,i,e,q,m,g,c,d,p,b,k=[].slice,o={}.hasOwnProperty,f=function(u,s){for(var r in s){if(o.call(s,r)){u[r]=s[r]}}function t(){this.constructor=u}t.prototype=s.prototype;u.prototype=new t;u.__super__=s.prototype;return u};j=this.jQuery;d=(function(){r.name="SimpleWidget";r.prototype.defaults={};function r(t,s){this.$el=j(t);this.options=j.extend({},this.defaults,s);this._init()}r.prototype.destroy=function(){return this._deinit()};r.prototype._init=function(){return null};r.prototype._deinit=function(){return null};return r})();d.register=function(w,u){var v,t,r,s;s=function(){return"simple_widget_"+u};t=function(y,x){var z;z=s();y.each(function(){var A;A=new w(this,x);if(!j.data(this,z)){return j.data(this,z,A)}});return y};r=function(x){var y;y=s();return x.each(function(){var z;z=j.data(this,y);if(z&&(z instanceof d)){z.destroy()}return j.removeData(this,y)})};v=function(z,A,y){var x;x=null;z.each(function(){var C,B;C=j.data(this,s());if(C&&(C instanceof d)){B=C[A];if(B&&(typeof B==="function")){return x=B.apply(C,y)}}});return x};return j.fn[u]=function(){var z,y,A,B,x;A=arguments[0],y=2<=arguments.length?k.call(arguments,1):[];z=this;if(A===void 0||typeof A==="object"){x=A;return t(z,x)}else{if(typeof A==="string"&&A[0]!=="_"){B=A;if(B==="destroy"){return r(z)}else{return v(z,B,y)}}}}};this.SimpleWidget=d;q=(function(r){f(s,r);s.name="MouseWidget";function s(){return s.__super__.constructor.apply(this,arguments)}s.is_mouse_handled=false;s.prototype._init=function(){this.$el.bind("mousedown",j.proxy(this._mouseDown,this));return this.is_mouse_started=false};s.prototype._deinit=function(){var t;this.$el.unbind("mousedown");t=j(document);t.unbind("mousemove");return t.unbind("mouseup")};s.prototype._mouseDown=function(t){var u;if(s.is_mouse_handled){return}if(!this.is_mouse_started){this._mouseUp(t)}if(t.which!==1){return}if(!this._mouseCapture(t)){return}this.mouse_down_event=t;u=j(document);u.bind("mousemove",j.proxy(this._mouseMove,this));u.bind("mouseup",j.proxy(this._mouseUp,this));t.preventDefault();this.is_mouse_handled=true;return true};s.prototype._mouseMove=function(t){if(this.is_mouse_started){this._mouseDrag(t);return t.preventDefault()}this.is_mouse_started=this._mouseStart(this.mouse_down_event)!==false;if(this.is_mouse_started){this._mouseDrag(t)}else{this._mouseUp(t)}return !this.is_mouse_started};s.prototype._mouseUp=function(t){var u;u=j(document);u.unbind("mousemove");u.unbind("mouseup");if(this.is_mouse_started){this.is_mouse_started=false;this._mouseStop(t)}return false};s.prototype._mouseCapture=function(t){return true};s.prototype._mouseStart=function(t){return null};s.prototype._mouseDrag=function(t){return null};s.prototype._mouseStop=function(t){return null};return s})(d);this.Tree={};j=this.jQuery;p=function(w,t){var s,v,u,r;if(w.indexOf){return w.indexOf(t)}else{for(s=u=0,r=w.length;u<r;s=++u){v=w[s];if(v===t){return s}}return -1}};this.Tree.indexOf=p;e={};e.escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;e.meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};e.quote=function(r){e.escapable.lastIndex=0;if(e.escapable.test(r)){return'"'+r.replace(e.escapable,function(s){var t;t=e.meta[s];return(typeof t==="string"?t:"\\u"+("0000"+s.charCodeAt(0).toString(16)).slice(-4))})+'"'}else{return'"'+r+'"'}};e.str=function(z,w){var t,r,u,A,y,s,x;y=w[z];if(y&&typeof y==="object"&&typeof y.toJSON==="function"){y=y.toJSON(z)}switch(typeof y){case"string":return e.quote(y);case"number":if(isFinite(y)){return String(y)}else{return"null"}case"boolean":case"null":return String(y);case"object":if(!y){return"null"}u=[];if(Object.prototype.toString.apply(y)==="[object Array]"){for(t=s=0,x=y.length;s<x;t=++s){A=y[t];u[t]=e.str(t,y)||"null"}return(u.length===0?"[]":"["+u.join(",")+"]")}for(r in y){if(Object.prototype.hasOwnProperty.call(y,r)){A=e.str(r,y);if(A){u.push(e.quote(r)+":"+A)}}}return(u.length===0?"{}":"{"+u.join(",")+"}")}};b=function(r){return e.str("",{"":r})};this.Tree.toJson=b;c={getName:function(r){if(r===c.BEFORE){return"before"}else{if(r===c.AFTER){return"after"}else{if(r===c.INSIDE){return"inside"}else{return"none"}}}}};c.BEFORE=1;c.AFTER=2;c.INSIDE=3;c.NONE=4;this.Tree.Position=c;m=(function(){r.name="Node";function r(s){this.init(s)}r.prototype.init=function(s){this.name=s;this.children=[];return this.parent=null};r.prototype.initFromData=function(t){var s,u,v=this;u=function(w){return j.each(w,function(x,y){if(x==="children"){s(y)}else{if(x==="label"){v.name=y}else{v[x]=y}}return true})};s=function(A){var B,y,z,x,w;w=[];for(z=0,x=A.length;z<x;z++){B=A[z];y=new r();y.initFromData(B);w.push(v.addChild(y))}return w};return u(t)};r.prototype.loadFromData=function(w){var u,x,v,t,s,y=this;this.children=[];s=[];for(v=0,t=w.length;v<t;v++){x=w[v];u=new r(x.label);j.each(x,function(z,A){if(z!=="label"){u[z]=A}return true});this.addChild(u);if(x.children){s.push(u.loadFromData(x.children))}else{s.push(void 0)}}return s};r.prototype.addChild=function(s){this.children.push(s);return s.parent=this};r.prototype.addChildAtPosition=function(t,s){this.children.splice(s,0,t);return t.parent=this};r.prototype.removeChild=function(s){return this.children.splice(this.getChildIndex(s),1)};r.prototype.getChildIndex=function(s){return j.inArray(s,this.children)};r.prototype.hasChildren=function(){return this.children.length!==0};r.prototype.iterate=function(u){var s,t=this;s=function(B){var A,v,z,x,y,w;y=t.children;w=[];for(z=0,x=y.length;z<x;z++){A=y[z];v=u(A,B);if(t.hasChildren()&&v){w.push(A.iterate(u,B+1))}else{w.push(void 0)}}return w};return s(0)};r.prototype.moveNode=function(t,u,s){t.parent.removeChild(t);if(s===c.AFTER){return u.parent.addChildAtPosition(t,u.parent.getChildIndex(u)+1)}else{if(s===c.BEFORE){return u.parent.addChildAtPosition(t,u.parent.getChildIndex(u))}else{if(s===c.INSIDE){return u.addChildAtPosition(t,0)}}}};r.prototype.getData=function(){var s,t=this;s=function(y){var C,x,A,z,w,B,u;C=[];for(B=0,u=y.length;B<u;B++){A=y[B];z={};for(x in A){w=A[x];if((x!=="parent"&&x!=="children"&&x!=="element")&&Object.prototype.hasOwnProperty.call(A,x)){z[x]=w}}if(A.hasChildren()){z.children=s(A.children)}C.push(z)}return C};return s(this.children)};return r})();this.Tree.Tree=m;i=(function(r){f(s,r);s.name="JqueryWidget";function s(){return s.__super__.constructor.apply(this,arguments)}s.prototype.defaults={autoOpen:false,saveState:false,dragAndDrop:false,selectable:false,onCanSelectNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onIsMoveHandle:null,onCanMove:null,onCanMoveTo:null};s.prototype.toggle=function(t,u){if(t.hasChildren()){new h(t).toggle(u)}if(this.options.saveState){return this._saveState()}};s.prototype.getTree=function(){return this.tree};s.prototype.selectNode=function(u,v){var t;if(this.options.selectable){if(this.selected_node){this._getNodeElementForNode(this.selected_node).deselect()}this._getNodeElementForNode(u).select();this.selected_node=u;if(v){t=this.selected_node.parent;while(t){if(!t.is_open){this.openNode(t,null,true)}t=t.parent}}if(this.options.saveState){return this._saveState()}}};s.prototype.getSelectedNode=function(){return this.selected_node||false};s.prototype.toJson=function(){return b(this.tree.getData())};s.prototype.loadData=function(w,B){var x,A,t,z,u,y,v;if(!B){return this._initTree(w)}else{z=new m();z.loadFromData(w);v=z.children;for(u=0,y=v.length;u<y;u++){t=v[u];B.addChild(t)}A=j(B.element);A.children("ul").detach();this._createDomElements(B,A);x=A.children("div");if(!x.find(".toggler").length){return x.prepend('<a class="toggler">&raquo;</a>')}}};s.prototype.getNodeById=function(u){var t;t=null;this.tree.iterate(function(v){if(v.id===u){t=v;return false}else{return true}});return t};s.prototype.openNode=function(t,v,u){if(t.hasChildren()){return new h(t).open(v,u)}};s.prototype._init=function(){s.__super__._init.apply(this,arguments);this.element=this.$el;this._initTree(this.options.data);this.element.click(j.proxy(this._click,this));this.element.bind("contextmenu",j.proxy(this._contextmenu,this));this.hovered_area=null;this.$ghost=null;return this.hit_areas=[]};s.prototype._deinit=function(){this.element.empty();this.element.unbind();this.tree=null;return s.__super__._deinit.apply(this,arguments)};s.prototype._initTree=function(t){var u;this.tree=new m();this.tree.loadFromData(t);this.selected_node=null;this._openNodes();this._createDomElements(this.tree);if(this.selected_node){u=this._getNodeElementForNode(this.selected_node);if(u){return u.select()}}};s.prototype._openNodes=function(){var t;if(this.options.saveState){if(this._restoreState()){return}}if(this.options.autoOpen===false){return}else{if(this.options.autoOpen===true){t=-1}else{t=parseInt(this.options.autoOpen)}}return this.tree.iterate(function(u,v){u.is_open=true;return v!==t})};s.prototype._createDomElements=function(B,z){var y,t,u,A,v,x,w=this;A=function(E,D){var C;if(E){C=""}else{C=' class="tree"'}return j("<ul"+C+"></ul>")};t=function(C){var D;if(C.hasChildren()){D=y(C)}else{D=u(C)}if(w.options.onCreateLi){w.options.onCreateLi(C,D)}return D};u=function(C){return j('<li><div><span class="title">'+C.name+"</span></div></li>")};y=function(G){var E,F,D,C;D=function(){var H;H=["toggler"];if(!G.is_open){H.push("closed")}return H.join(" ")};C=function(){var H;H=["folder"];if(!G.is_open){H.push("closed")}return H.join(" ")};E=D();F=C();return j('<li class="'+F+'"><div><a class="'+E+'">&raquo;</a><span class="title">'+G.name+"</span></div></li>")};x=function(L,D,H,F){var J,I,C,G,K,E;I=A(H,F);L.append(I);E=[];for(G=0,K=D.length;G<K;G++){C=D[G];J=t(C);I.append(J);C.element=J[0];J.data("node",C);if(C.hasChildren()){E.push(x(J,C.children,H+1,C.is_open))}else{E.push(void 0)}}return E};if(z){v=1}else{z=this.element;z.empty();v=0}return x(z,B.children,v,true)};s.prototype._click=function(w){var t,v,u,y,x=this;if(w.ctrlKey){return}t=j(w.target);if(t.is(".toggler")){y=this._getNodeElement(t);if(y&&y.node.hasChildren()){y.toggle(function(){var A,B,z;z=y.node;if(z.is_open){B="tree.open"}else{B="tree.close"}A=j.Event(B);A.node=z;return x.element.trigger(A)});if(this.options.saveState){this._saveState()}w.preventDefault();return w.stopPropagation()}}else{if(t.is("div")||t.is("span")){u=this._getNode(t);if(u){if((!this.options.onCanSelectNode)||this.options.onCanSelectNode(u)){this.selectNode(u);v=j.Event("tree.click");v.node=u;return this.element.trigger(v)}}}}};s.prototype._getNode=function(t){var u;u=t.closest("li");if(u.length===0){return null}else{return u.data("node")}};s.prototype._restoreState=function(){var t;if(this.options.onGetStateFromStorage){t=this.options.onGetStateFromStorage()}else{if(j.cookie){t=j.cookie(this._getCookieName(),{path:"/"})}else{t=null}}if(!t){return false}else{this._setState(t);return true}};s.prototype._saveState=function(){if(this.options.onSetStateFromStorage){return this.options.onSetStateFromStorage(this._getState())}else{if(j.cookie){return j.cookie(this._getCookieName(),this._getState(),{path:"/"})}}};s.prototype._getState=function(){var u,t,v=this;u=[];this.tree.iterate(function(w){if(w.is_open&&w.id&&w.hasChildren()){u.push(w.id)}return true});t="";if(this.selected_node){t=this.selected_node.id}return b({open_nodes:u,selected_node:t})};s.prototype._setState=function(v){var u,w,t,x=this;u=j.parseJSON(v);w=u.open_nodes;t=u.selected_node;return this.tree.iterate(function(y){if(y.id&&y.hasChildren()&&(p(w,y.id)>=0)){y.is_open=true}if(t&&(y.id===t)){x.selected_node=y}return true})};s.prototype._getCookieName=function(){if(typeof this.options.saveState==="string"){return this.options.saveState}else{return"tree"}};s.prototype._getNodeElementForNode=function(t){if(t.hasChildren()){return new h(t)}else{return new g(t)}};s.prototype._getNodeElement=function(t){var u;u=this._getNode(t);if(u){return this._getNodeElementForNode(u)}else{return null}};s.prototype._contextmenu=function(w){var t,v,u;t=j(w.target).closest("ul.tree div");if(t.length){u=this._getNode(t);if(u){w.preventDefault();w.stopPropagation();v=j.Event("tree.contextmenu");v.node=u;v.click_event=w;this.element.trigger(v);return false}}};s.prototype._mouseCapture=function(u){var t,v;if(!this.options.dragAndDrop){return}t=j(u.target);if(this.options.onIsMoveHandle&&!this.options.onIsMoveHandle(t)){return null}v=this._getNodeElement(j(u.target));if(v&&this.options.onCanMove){if(!this.options.onCanMove(v.node)){v=null}}this.current_item=v;return this.current_item!==null};s.prototype._mouseStart=function(u){var t,w,v;if(!this.options.dragAndDrop){return}this._refreshHitAreas();v=this._getOffsetFromEvent(u),t=v[0],w=v[1];this.drag_element=new l(this.current_item.node,t,w,this.element);this.current_item.$element.addClass("moving");return true};s.prototype._mouseDrag=function(u){var t,v;if(!this.options.dragAndDrop){return}this.drag_element.move(u.pageX,u.pageY);t=this._findHoveredArea(u.pageX,u.pageY);if(t&&this.options.onCanMoveTo){v=c.getName(t.position);if(!this.options.onCanMoveTo(this.current_item.node,t.node,v)){t=null}}if(!t){this._removeDropHint();this._removeHover();this._stopOpenFolderTimer()}else{if(this.hovered_area!==t){this.hovered_area=t;this._updateDropHint()}}return true};s.prototype._mouseStop=function(){if(!this.options.dragAndDrop){return}this._moveItem();this._clear();this._removeHover();this._removeDropHint();this._removeHitAreas();this.current_item.$element.removeClass("moving");return false};s.prototype._refreshHitAreas=function(){this._removeHitAreas();return this._generateHitAreas()};s.prototype._generateHitAreas=function(){var t,A,v,z,x,E,u,y,w,C,B,D=this;B=[];C=0;A=function(F){return F.offset().top};t=function(G,F,H){B.push({top:H,node:G,position:F});return C=H};v=function(K){var J,F,I,H,G;I=-1;J=[];for(H=0,G=B.length;H<G;H++){F=B[H];if(F.top!==I){if(J.length){K(J,I,F.top)}I=F.top;J=[]}J.push(F)}return K(J,I,D.element.offset().top+D.element.height())};u=function(H,G,F){var I;I=A(F);if(H===D.current_item.node){t(H,c.NONE,I)}else{t(H,c.INSIDE,I)}if(G===D.current_item.node||H===D.current_item.node){return t(H,c.NONE,I)}else{return t(H,c.AFTER,I)}};y=function(G,F){if(G===D.current_item.node){return false}if(G.children[0]!==D.current_item.node){t(G,c.INSIDE,A(F))}return true};z=function(H,G,F){if(H===D.current_item.node||G===D.current_item.node){return t(H,c.NONE,C)}else{return t(H,c.AFTER,C)}};x=function(H,G,F){var I;I=A(F);if(H===D.current_item.node){return t(H,c.NONE,I)}else{t(H,c.INSIDE,I);if(G!==D.current_item.node){return t(H,c.AFTER,I)}}};E=function(G,F){if(G!==D.current_item.node){return t(G,c.BEFORE,A(j(G.element)))}};this._iterateVisibleNodes(u,y,x,z,E);w=[];v(function(H,L,F){var G,N,K,J,M,I;G=(F-L)/H.length;N=L;I=[];for(J=0,M=H.length;J<M;J++){K=H[J];w.push({top:N,bottom:N+G,node:K.node,position:K.position});I.push(N+=G)}return I});return this.hit_areas=w};s.prototype._removeHitAreas=function(){return this.hit_areas=[]};s.prototype._iterateVisibleNodes=function(v,A,u,y,w){var x,t,z=this;x=true;t=function(D,B){var K,C,J,G,H,E,I,F;H=(D.is_open||!D.element)&&D.hasChildren();if(D.element){K=j(D.element);if(!K.is(":visible")){return}if(x){w(D,K);x=false}if(!D.hasChildren()){v(D,B,K)}else{if(D.is_open){if(!A(D,K)){H=false}}else{u(D,B,K)}}}if(H){J=D.children.length;F=D.children;for(G=E=0,I=F.length;E<I;G=++E){C=F[G];if(G===(J-1)){t(D.children[G],null)}else{t(D.children[G],D.children[G+1])}}if(D.is_open){return y(D,B,K)}}};return t(this.tree)};s.prototype._getOffsetFromEvent=function(u){var t;t=j(u.target).offset();return[u.pageX-t.left,u.pageY-t.top]};s.prototype._findHoveredArea=function(u,B){var z,A,t,w,v;v=this.element.offset();if(u<v.left||B<v.top||u>(v.left+this.element.width())||B>(v.top+this.element.height())){return null}t=0;A=this.hit_areas.length;while(t<A){w=(t+A)>>1;z=this.hit_areas[w];if(B<z.top){A=w}else{if(B>z.bottom){t=w+1}else{return z}}}return null};s.prototype._updateDropHint=function(){var t,u;this._stopOpenFolderTimer();if(!this.hovered_area){return}t=this.hovered_area.node;if(t.hasChildren()&&!t.is_open&&this.hovered_area.position===c.INSIDE){this._startOpenFolderTimer(t)}this._removeDropHint();u=this._getNodeElementForNode(this.hovered_area.node);return this.previous_ghost=u.addDropHint(this.hovered_area.position)};s.prototype._startOpenFolderTimer=function(u){var t,v=this;t=function(){return v._getNodeElementForNode(u).open(function(){v._refreshHitAreas();return v._updateDropHint()})};return this.open_folder_timer=setTimeout(t,500)};s.prototype._stopOpenFolderTimer=function(){if(this.open_folder_timer){clearTimeout(this.open_folder_timer);return this.open_folder_timer=null}};s.prototype._removeDropHint=function(){if(this.previous_ghost){return this.previous_ghost.remove()}};s.prototype._removeHover=function(){return this.hovered_area=null};s.prototype._moveItem=function(){var w,v,t,u,x;if(this.hovered_area&&this.hovered_area.position!==c.NONE){v=this.current_item.node;x=this.hovered_area.node;t=this.hovered_area.position;u=v.parent;this.tree.moveNode(v,x,t);if(t===c.INSIDE){this.hovered_area.node.is_open=true}w=j.Event("tree.move");w.move_info={moved_node:v,target_node:x,position:c.getName(t),previous_parent:u};this.element.trigger(w);this.element.empty();return this._createDomElements(this.tree)}};s.prototype._clear=function(){this.drag_element.remove();return this.drag_element=null};return s})(q);d.register(i,"tree");n=(function(){r.name="GhostDropHint";function r(u,t,s){this.$element=t;this.node=u;this.$ghost=j('<li class="ghost"><span class="circle"></span><span class="line"></span></li>');if(s===c.AFTER){this.moveAfter()}else{if(s===c.BEFORE){this.moveBefore()}else{if(s===c.INSIDE){if(u.hasChildren()&&u.is_open){this.moveInsideOpenFolder()}else{this.moveInside()}}}}}r.prototype.remove=function(){return this.$ghost.remove()};r.prototype.moveAfter=function(){return this.$element.after(this.$ghost)};r.prototype.moveBefore=function(){return this.$element.before(this.$ghost)};r.prototype.moveInsideOpenFolder=function(){return j(this.node.children[0].element).before(this.$ghost)};r.prototype.moveInside=function(){this.$element.after(this.$ghost);return this.$ghost.addClass("inside")};return r})();a=(function(){r.name="BorderDropHint";function r(t){var s,u;s=t.children("div");u=t.width()-4;this.$hint=j('<span class="border"></span>');s.append(this.$hint);this.$hint.css({width:u,height:s.height()-4})}r.prototype.remove=function(){return this.$hint.remove()};return r})();g=(function(){r.name="NodeElement";function r(s){this.init(s)}r.prototype.init=function(s){this.node=s;return this.$element=j(s.element)};r.prototype.getUl=function(){return this.$element.children("ul:first")};r.prototype.getSpan=function(){return this.$element.children("div").find("span.title")};r.prototype.getLi=function(){return this.$element};r.prototype.addDropHint=function(s){if(s===c.INSIDE){return new a(this.$element)}else{return new n(this.node,this.$element,s)}};r.prototype.select=function(){return this.getLi().addClass("selected")};r.prototype.deselect=function(){return this.getLi().removeClass("selected")};return r})();h=(function(s){f(r,s);r.name="FolderElement";function r(){return r.__super__.constructor.apply(this,arguments)}r.prototype.toggle=function(t){if(this.node.is_open){return this.close(t)}else{return this.open(t)}};r.prototype.open=function(v,u){var t,w=this;this.node.is_open=true;this.getButton().removeClass("closed");t=function(){w.getLi().removeClass("closed");if(v){return v()}};if(u){this.getUl().show();return t()}else{return this.getUl().slideDown("fast",t)}};r.prototype.close=function(t){var u=this;this.node.is_open=false;this.getButton().addClass("closed");return this.getUl().slideUp("fast",function(){u.getLi().addClass("closed");if(t){return t()}})};r.prototype.getButton=function(){return this.$element.children("div").find("a.toggler")};r.prototype.addDropHint=function(t){if(!this.node.is_open&&t===c.INSIDE){return new a(this.$element)}else{return new n(this.node,this.$element,t)}};return r})(g);l=(function(){r.name="DragElement";function r(u,t,s,v){this.offset_x=t;this.offset_y=s;this.$element=j('<span class="title tree-dragging">'+u.name+"</span>");this.$element.css("position","absolute");v.append(this.$element)}r.prototype.move=function(t,s){return this.$element.offset({left:t-this.offset_x,top:s-this.offset_y})};r.prototype.remove=function(){return this.$element.remove()};return r})();this.Tree.Node=m}).call(this);