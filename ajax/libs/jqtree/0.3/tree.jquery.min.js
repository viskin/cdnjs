window.Tree={};(function(f){function i(p,o){if(p.indexOf){return p.indexOf(o)}else{var n,m;for(n=0,m=p.length;n<m;n++){if(p[n]===o){return n}}return -1}}var j=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,k={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function b(l,v,u){function s(m){j.lastIndex=0;return j.test(m)?'"'+m.replace(j,function(n){var o=k[n];return typeof o==="string"?o:"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+m+'"'}function t(y,p){var B,o,z,n,m=x,A,C=p[y];typeof w==="function"&&(C=w.call(p,y,C));switch(typeof C){case"string":return s(C);case"number":return isFinite(C)?String(C):"null";case"boolean":case"null":return String(C);case"object":if(!C){return"null"}x+=r;A=[];if(Object.prototype.toString.apply(C)==="[object Array]"){n=C.length;for(B=0;B<n;B+=1){A[B]=t(B,C)||"null"}z=A.length===0?"[]":x?"[\n"+x+A.join(",\n"+x)+"\n"+m+"]":"["+A.join(",")+"]";x=m;return z}if(w&&typeof w==="object"){n=w.length;for(B=0;B<n;B+=1){typeof w[B]==="string"&&(o=w[B],(z=t(o,C))&&A.push(s(o)+(x?": ":":")+z))}}else{for(o in C){Object.prototype.hasOwnProperty.call(C,o)&&(z=t(o,C))&&A.push(s(o)+(x?": ":":")+z)}}z=A.length===0?"{}":x?"{\n"+x+A.join(",\n"+x)+"\n"+m+"}":"{"+A.join(",")+"}";x=m;return z}}var q,w,x="",r="";if(typeof u==="number"){for(q=0;q<u;q+=1){r+=" "}}else{typeof u==="string"&&(r=u)}if((w=v)&&typeof v!=="function"&&(typeof v!=="object"||typeof v.length!=="number")){throw Error("JSON.stringify")}return t("",{"":l})}var c={BEFORE:1,AFTER:2,INSIDE:3,NONE:4,getName:function(l){return this._getNames()[l]},_getNames:function(){var l={};l[c.BEFORE]="before";l[c.AFTER]="after";l[c.INSIDE]="inside";l[c.NONE]="none";return l}};window.Tree.Position=c;var g=function(l){this.init(l)};window.Tree.Node=g;g.prototype={init:function(l){this.name=l;this.children=[];this.parent=null},initFromData:function(m){var l=this;function n(p){f.each(p,function(q,r){if(q=="children"){o(r)}else{if(q=="label"){l.name=r}else{l[q]=r}}});function o(q){f.each(q,function(){var r=new g();r.initFromData(this);l.addChild(r)})}}n(m)},loadFromData:function(m){this.children=[];var l=this;f.each(m,function(){var n=new g(this.label);f.each(this,function(o,p){if(o!="label"){n[o]=p}});l.addChild(n);if(this.children){n.loadFromData(this.children)}})},addChild:function(l){this.children.push(l);l.parent=this},addChildAtPosition:function(m,l){this.children.splice(l,0,m);m.parent=this},removeChild:function(l){this.children.splice(this.getChildIndex(l),1)},getChildIndex:function(l){return f.inArray(l,this.children)},hasChildren:function(){return(this.children.length!=0)},iterate:function(m,l){if(!l){l=0}f.each(this.children,function(){var n=m(this,l);if(this.hasChildren()&&n){this.iterate(m,l+1)}})},moveNode:function(m,n,l){m.parent.removeChild(m);if(l==c.AFTER){n.parent.addChildAtPosition(m,n.parent.getChildIndex(n)+1)}else{if(l==c.BEFORE){n.parent.addChildAtPosition(m,n.parent.getChildIndex(n))}else{if(l==c.INSIDE){n.addChildAtPosition(m,0)}}}},getData:function(){function l(m){var n=[];f.each(m,function(){var o=f.extend({},this);delete o.parent;delete o.element;if(this.hasChildren()){o.children=l(this.children)}else{delete o.children}n.push(o)});return n}return l(this.children)}};g.createFromData=function(m){var l=new g();l.loadFromData(m);return l};window.Tree.Tree=g;f.widget("ui.tree",f.ui.mouse,{widgetEventPrefix:"tree",options:{autoOpen:false,saveState:false,dragAndDrop:false,selectable:false,onCanSelectNode:null,onMoveNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onMustAddHitArea:null,onIsMoveHandle:null,onCanMove:null},getTree:function(){return this.tree},toJson:function(){return b(this.tree.getData())},addNode:function(l){var m=new g();m.initFromData(l);this.getTree().addChild(m);this.element.empty();this._createDomElements(this.getTree())},toggle:function(l,m){if(l.hasChildren()){new e(l).toggle(m)}if(this.options.saveState){this._saveState()}},selectNode:function(l){if(this.options.selectable){if(this.selected_node){this._getNodeElementForNode(this.selected_node).deselect()}this._getNodeElementForNode(l).select();this.selected_node=l;if(this.options.saveState){this._saveState()}}},getSelectedNode:function(){return this.selected_node||false},_create:function(){this.tree=g.createFromData(this.options.data);this.selected_node=null;this._openNodes();this._createDomElements(this.tree);if(this.selected_node){var l=this._getNodeElementForNode(this.selected_node);if(l){l.select()}}this.element.click(f.proxy(this._click,this));this.element.bind("contextmenu",f.proxy(this._contextmenu,this));this._mouseInit();this.hovered_area=null;this.$ghost=null;this.hit_areas=[]},destroy:function(){this.element.empty();this.element.unbind();this.tree=null;this._mouseDestroy();f.Widget.prototype.destroy.call(this)},_getState:function(){var m=[];this.tree.iterate(function(n){if(n.is_open&&n.id&&n.hasChildren()){m.push(n.id)}return true});var l="";if(this.selected_node){l=this.selected_node.id}return b({open_nodes:m,selected_node:l})},_setState:function(o){var n=f.parseJSON(o);var p=n.open_nodes;var m=n.selected_node;var l=this;this.tree.iterate(function(q){if(q.id&&q.hasChildren()&&(i(p,q.id)>=0)){q.is_open=true}if(m&&(q.id==m)){l.selected_node=q}return true})},_saveState:function(){if(this.options.onSetStateFromStorage){this.options.onSetStateFromStorage(this._getState())}else{f.cookie(this._getCookieName(),this._getState(),{path:"/"})}},_restoreState:function(){var l;if(this.options.onGetStateFromStorage){l=this.options.onGetStateFromStorage()}else{l=f.cookie(this._getCookieName(),{path:"/"})}if(!l){return false}else{this._setState(l);return true}},_getCookieName:function(){if(typeof this.options.saveState=="string"){return this.options.saveState}else{return"tree"}},_createDomElements:function(l){var n=this;function r(v,u){var t=[];if(!v){t.push("tree")}var s=f("<ul />");s.addClass(t.join(" "));return s}function p(s){var t;if(s.hasChildren()){t=m(s)}else{t=q(s)}if(n.options.onCreateLi){n.options.onCreateLi(s,t)}return t}function q(s){return f('<li><div><span class="title">'+s.name+"</span></div></li>")}function m(t){var s=["toggler"];if(!t.is_open){s.push("closed")}var v=f('<li><div><a class="'+s.join(" ")+'">&raquo;</a><span class="title">'+t.name+"</span></div></li>");var u=["folder"];if(!t.is_open){u.push("closed")}v.addClass(u.join(" "));return v}function o(s,u,w,v){var t=r(w,v);s.append(t);f.each(u,function(){var x=p(this);t.append(x);this.element=x[0];x.data("node",this);if(this.hasChildren()){o(x,this.children,w+1,this.is_open)}})}o(this.element,l.children,0,true)},_click:function(o){if(o.ctrlKey){return}var l=f(o.target);if(l.is(".toggler")){var p=this._getNodeElement(l);if(p&&(p.node.hasChildren())){p.toggle();if(this.options.saveState){this._saveState()}o.preventDefault();o.stopPropagation()}}else{if(l.is("div")||l.is("span")){var n=this._getNode(l);if(n){if((!this.options.onCanSelectNode)||(this.options.onCanSelectNode(n))){this.selectNode(n);var m=jQuery.Event("tree.click");m.node=n;this.element.trigger(m)}}}}},_contextmenu:function(o){var l=f(o.target).closest("ul.tree div");if(l.length){var n=this._getNode(l);if(n){o.preventDefault();o.stopPropagation();var m=jQuery.Event("tree.contextmenu");m.node=n;m.click_event=o;this.element.trigger(m);return false}}},_getNode:function(l){var m=l.closest("li");if(m.length==0){return null}else{return m.data("node")}},_getNodeElement:function(l){var m=this._getNode(l);if(m){return this._getNodeElementForNode(m)}else{return null}},_getNodeElementForNode:function(l){if(l.hasChildren()){return new e(l)}else{return new d(l)}},_mouseCapture:function(m){if(!this.options.dragAndDrop){return}var l=f(m.target);if(this.options.onIsMoveHandle&&!this.options.onIsMoveHandle(l)){return null}var n=this._getNodeElement(f(m.target));if(n&&this.options.onCanMove){if(!this.options.onCanMove(n.node)){n=null}}this.current_item=n;return(this.current_item!=null)},_mouseStart:function(l){if(!this.options.dragAndDrop){return}this._refreshHitAreas();this.helper=this._createHelper();this.current_item.$element.addClass("moving");return true},_mouseDrag:function(m){if(!this.options.dragAndDrop){return}this.helper.offset({left:m.pageX+16,top:m.pageY});var l=this.findHoveredArea(m.pageX,m.pageY);if(l&&this.options.onCanMove){var n=c.getName(l.position);if(!this.options.onCanMove(this.current_item.node,l.node,n)){l=null}}if(!l){this._removeDropHint();this._removeHover();this._stopOpenFolderTimer()}else{if(this.hovered_area!=l){this.hovered_area=l;this._updateDropHint()}}return true},_updateDropHint:function(){this._stopOpenFolderTimer();if(!this.hovered_area){return}var l=this.hovered_area.node;if(l.hasChildren()&&!l.is_open&&this.hovered_area.position==c.INSIDE){this._startOpenFolderTimer(l)}this._removeDropHint();var m=this._getNodeElementForNode(this.hovered_area.node);this.previous_ghost=m.addDropHint(this.hovered_area.position)},_mouseStop:function(){if(!this.options.dragAndDrop){return}this._moveItem();this._clear();this._removeHover();this._removeDropHint();this._removeHitAreas();this.current_item.$element.removeClass("moving");return false},_mouseMove:function(l){if(f.browser.msie&&document.documentMode==8&&!l.button){l.button=1}return f.ui.mouse.prototype._mouseMove.call(this,l)},_moveItem:function(){if((this.hovered_area)&&(this.hovered_area.position!=c.NONE)){this.tree.moveNode(this.current_item.node,this.hovered_area.node,this.hovered_area.position);if(this.hovered_area.position==c.INSIDE){this.hovered_area.node.is_open=true}if(this.options.onMoveNode){this.options.onMoveNode(this.current_item.node,this.hovered_area.node,c.getName(this.hovered_area.position))}this.element.empty();this._createDomElements(this.tree)}},_createHelper:function(){var l=this.current_item.createHelper();l.css("position","absolute");this.element.append(l);return l},_clear:function(){this.helper.remove();this.helper=null},_refreshHitAreas:function(){this._removeHitAreas();this._generateHitAreas()},_generateHitAreas:function(){var w=this;var t=[];var u=0;function s(x){return x.offset().top}function l(y,x,z){t.push({top:z,node:y,position:x});u=z}function n(z){var x=-1;var y=[];f.each(t,function(){if(this.top!=x){if(y.length){z(y,x,this.top)}x=this.top;y=[]}y.push(this)});z(y,x,w.element.offset().top+w.element.height())}function m(z,y,x){var A=s(x);if((z==w.current_item.node)||(y==w.current_item.node)){l(z,c.NONE,A)}else{l(z,c.INSIDE,A);l(z,c.AFTER,A)}}function q(y,x){if(y==w.current_item.node){return false}if(y.children[0]!=w.current_item.node){l(y,c.INSIDE,s(x))}return true}function r(z,y,x){if((z==w.current_item.node)||(y==w.current_item.node)){l(z,c.NONE,u)}else{l(z,c.AFTER,u)}}function p(z,y,x){var A=s(x);if(z==w.current_item.node){l(z,c.NONE,A)}else{l(z,c.INSIDE,A);if(y!=w.current_item.node){l(z,c.AFTER,A)}}}function v(y,x){if(y!=w.current_item.node){l(y,c.BEFORE,s(f(y.element)))}}this._iterateVisibleNodes(m,q,p,r,v);var o=[];n(function(y,B,x){var z=(x-B)/y.length;var A=B;f.each(y,function(){o.push({top:A,bottom:A+z,node:this.node,position:this.position});A+=z})});this.hit_areas=o},findHoveredArea:function(m,r){var n=this.element.offset();if(m<n.left||r<n.top||m>(n.left+this.element.width())||r>(n.top+this.element.height())){return null}var l=0;var q=this.hit_areas.length;var p,o;while(l<q){o=(l+q)>>1;p=this.hit_areas[o];if(r<p.top){q=o}else{if(r>p.bottom){l=o+1}else{return p}}}return null},_iterateVisibleNodes:function(o,s,n,r,p){var m=this;var q=true;function l(y,x){var v=((y.is_open||!y.element)&&y.hasChildren());if(y.element){var t=f(y.element);if(!t.is(":visible")){return}if(m.options.onMustAddHitArea){if(!m.options.onMustAddHitArea(y)){return}}if(q){p(y,t);q=false}if(!y.hasChildren()){o(y,x,t)}else{if(y.is_open){if(!s(y,t)){v=false}}else{n(y,x,t)}}}if(v){var w=y.children.length;for(var u=0;u<w;u++){if(u==(w-1)){l(y.children[u],null)}else{l(y.children[u],y.children[u+1])}}if(y.is_open){r(y,x,t)}}}l(this.tree)},_removeHover:function(){this.hovered_area=null},_removeDropHint:function(){if(this.previous_ghost){this.previous_ghost.remove()}},_removeHitAreas:function(){this.hit_areas=[]},_openNodes:function(){var l;if(this.options.saveState){if(this._restoreState()){return}}if(this.options.autoOpen===false){return}else{if(this.options.autoOpen===true){l=-1}else{l=parseInt(this.options.autoOpen)}}this.tree.iterate(function(m,n){m.is_open=true;return(n!=l)})},_startOpenFolderTimer:function(n){var l=this;function m(){l._getNodeElementForNode(n).open(function(){l._refreshHitAreas();l._updateDropHint()})}this.open_folder_timer=setTimeout(m,500)},_stopOpenFolderTimer:function(){if(this.open_folder_timer){clearTimeout(this.open_folder_timer);this.open_folder_timer=null}}});var h=function(n,m,l){this.$element=m;this.node=n;this.$ghost=f('<li class="ghost"><span class="circle"></span><span class="line"></span></li>');if(l==c.AFTER){this.moveAfter()}else{if(l==c.BEFORE){this.moveBefore()}else{if(l==c.INSIDE){if(n.hasChildren()&&n.is_open){this.moveInsideOpenFolder()}else{this.moveInside()}}}}};f.extend(h.prototype,{remove:function(){this.$ghost.remove()},moveAfter:function(){this.$element.after(this.$ghost)},moveBefore:function(){this.$element.before(this.$ghost)},moveInsideOpenFolder:function(){f(this.node.children[0].element).before(this.$ghost)},moveInside:function(){this.$element.after(this.$ghost);this.$ghost.addClass("inside")}});var a=function(m){var l=m.children("div");var n=m.width()-4;this.$hint=f('<span class="border"></span>');l.append(this.$hint);this.$hint.css({width:n,height:l.height()-4})};f.extend(a.prototype,{remove:function(){this.$hint.remove()}});var d=function(l){this.init(l)};f.extend(d.prototype,{init:function(l){this.node=l;this.$element=f(l.element)},getUl:function(){return this.$element.children("ul:first")},getSpan:function(){return this.$element.children("div").find("span.title")},getLi:function(){return this.$element},createHelper:function(){var l=this.getSpan().clone();l.addClass("tree-dragging");return l},addDropHint:function(l){if(l==c.INSIDE){return new a(this.$element)}else{return new h(this.node,this.$element,l)}},select:function(){this.getLi().addClass("selected")},deselect:function(){this.getLi().removeClass("selected")}});var e=function(l){this.init(l)};f.extend(e.prototype,d.prototype,{toggle:function(l){if(this.node.is_open){this.close(l)}else{this.open(l)}},open:function(l){this.node.is_open=true;this.getButton().removeClass("closed");this.getUl().slideDown("fast",f.proxy(function(){this.getLi().removeClass("closed");if(l){l()}},this))},close:function(l){this.node.is_open=false;this.getButton().addClass("closed");this.getUl().slideUp("fast",f.proxy(function(){this.getLi().addClass("closed");if(l){l()}},this))},getButton:function(){return this.$element.children("div").find("a.toggler")},addDropHint:function(l){if(!this.node.is_open&&l==c.INSIDE){return new a(this.$element)}else{return new h(this.node,this.$element,l)}}})})(jQuery);