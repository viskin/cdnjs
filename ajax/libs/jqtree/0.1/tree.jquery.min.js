_TestClasses={};(function(g){var f=function(l,m){for(var j=0,k=m.length;j<k;j++){if(m[j]==l){return j}}return -1};var a={BEFORE:1,AFTER:2,INSIDE:3,getName:function(i){return this._getNames()[i]},_getNames:function(){var i={};i[a.BEFORE]="before";i[a.AFTER]="after";i[a.INSIDE]="inside";return i}};_TestClasses.Position=a;var d=function(i){this.init(i)};_TestClasses.Node=d;g.extend(d.prototype,{init:function(i){this.name=i;this.children=[];this.parent=null},loadFromData:function(j){this.children=[];var i=this;g.each(j,function(){var k=new d(this.label);g.each(this,function(l,m){if(l!="label"){k[l]=m}});i.addChild(k);if(this.children){k.loadFromData(this.children)}})},addChild:function(i){this.children.push(i);i.parent=this},addChildAtPosition:function(j,i){this.children.splice(i,0,j);j.parent=this},removeChild:function(i){this.children.splice(this.getChildIndex(i),1)},getChildIndex:function(i){return g.inArray(i,this.children)},hasChildren:function(){return(this.children.length!=0)},iterate:function(j,i){if(!i){i=0}g.each(this.children,function(){var k=j(this,i);if(this.hasChildren()&&k){this.iterate(j,i+1)}})},moveNode:function(j,k,i){j.parent.removeChild(j);if(i==a.AFTER){k.parent.addChildAtPosition(j,k.parent.getChildIndex(k)+1)}else{if(i==a.BEFORE){k.parent.addChildAtPosition(j,k.parent.getChildIndex(k))}else{if(i==a.INSIDE){k.addChild(j)}}}}});d.createFromData=function(j){var i=new h();i.loadFromData(j);return i};var h=d;_TestClasses.Tree=h;var c=function(l,k,j,i){this.init(l,k,j,i)};_TestClasses.Area=c;g.extend(c.prototype,{init:function(l,k,j,i){this.left=l;this.top=k;this.right=j;this.bottom=i;this.children=[]},addArea:function(i){this.children.push(i)},findIntersectingArea:function(l){if(!this.intersects(l)){return null}else{for(var k=0;k<this.children.length;k++){var j=this.children[k].findIntersectingArea(l);if(j){return j}}return this}},intersects:function(i){return((this.bottom>=i.top)&&(this.top<=i.bottom)&&(this.right>=i.left)&&(this.left<=i.right))},duplicate:function(){return new c(this.left,this.top,this.right,this.bottom)},iterate:function(i){i(this);g.each(this.children,function(j,k){k.iterate(i)})},setMinimumWidth:function(i){var j=this.right-this.left;if(j<i){this.right=this.left+i}}});c.createFromElement=function(i){var j=i.offset();return new c(j.left,j.top,j.left+i.outerWidth(),j.top+i.outerHeight())};g.widget("ui.tree",g.ui.mouse,{widgetEventPrefix:"tree",options:{autoOpen:false,saveState:false,dragAndDrop:false,selectable:false,onClick:null,onContextMenu:null,onMoveNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onMustAddHitArea:null,displayTestNodes:false},getTree:function(){return this.tree},toggle:function(i,j){if(i.hasChildren()){new e(i).toggle(j)}if(this.options.saveState){this._saveState()}},getSelectedNode:function(){return this.selected_node},_create:function(){this.tree=h.createFromData(this.options.data);this._openNodes();this._createDomElements(this.tree);this.element.click(g.proxy(this._click,this));this.element.bind("contextmenu",g.proxy(this._contextmenu,this));this._mouseInit();this.hovered_rectangle=null;this.selected_node=null;this.$ghost=null;this.hint_nodes=[]},_destroy:function(){this.element.empty();this.tree=null;this._mouseDestroy();return this},_getState:function(){var i=[];this.tree.iterate(function(j){if(j.is_open&&j.id&&j.hasChildren()){i.push(j.id)}return true});return i.join(",")},_setState:function(i){var j=i.split(",");this.tree.iterate(function(k){if(k.id&&k.hasChildren()&&(f(k.id,j)!=-1)){k.is_open=true}return true})},_saveState:function(){if(this.options.onSetStateFromStorage){this.options.onSetStateFromStorage(this._getState())}else{g.cookie(this._getCookieName(),this._getState(),{path:"/"})}},_restoreState:function(){var i;if(this.options.onGetStateFromStorage){i=this.options.onGetStateFromStorage()}else{i=g.cookie(this._getCookieName(),{path:"/"})}if(!i){return false}else{this._setState(i);return true}},_getCookieName:function(){if(typeof this.options.saveState=="string"){return this.options.saveState}else{return"tree"}},_createDomElements:function(i){var k=this;function o(s,r){var q=[];if(!s){q.push("tree")}var p=g("<ul />");p.addClass(q.join(" "));return p}function m(p){var q;if(p.hasChildren()){q=j(p)}else{q=n(p)}if(k.options.onCreateLi){k.options.onCreateLi(p,q)}return q}function n(p){return g("<li><span>"+p.name+"</span></li>")}function j(q){var p=["toggler"];if(!q.is_open){p.push("closed")}var s=g('<li><a class="'+p.join(" ")+'">&raquo;</a><span>'+q.name+"</span></li>");var r=["folder"];if(!q.is_open){r.push("closed")}s.addClass(r.join(" "));return s}function l(p,r,t,s){var q=o(t,s);p.append(q);g.each(r,function(){var u=m(this);q.append(u);this.element=u[0];u.data("node",this);if(this.hasChildren()){l(u,this.children,t+1,this.is_open)}})}l(this.element,i.children,0,true)},_click:function(k){if(k.ctrlKey){return}var i=g(k.target);if(i.is("a.toggler")){var l=this._getNodeElement(i);if(l&&(l.node.hasChildren())){l.toggle();if(this.options.saveState){this._saveState()}k.preventDefault();k.stopPropagation()}}else{if(i.is("span")){var j=this._getNode(i);if(j){if(this.options.selectable){if(this.selected_node){this._getNodeElementForNode(this.selected_node).deselect()}this._getNodeElementForNode(j).select();this.selected_node=j}if(this.options.onClick){this.options.onClick(j)}}}}},_contextmenu:function(k){if(!this.options.onContextMenu){return}var i=g(k.target);if((i.is("span"))&&(!i.is("span.folder"))){var j=this._getNode(i);if(j){k.preventDefault();k.stopPropagation();this.options.onContextMenu(k,j);return false}}},_getNode:function(i){var j=i.closest("li");if(j.length==0){return null}else{return j.data("node")}},_getNodeElement:function(i){var j=this._getNode(i);if(j){return this._getNodeElementForNode(j)}else{return null}},_getNodeElementForNode:function(i){if(i.hasChildren()){return new e(i)}else{return new b(i)}},_mouseCapture:function(i){if(!this.options.dragAndDrop){return}this.current_item=this._getNodeElement(g(i.target));return(this.current_item!=null)},_mouseStart:function(j){if(!this.options.dragAndDrop){return}var i=this.current_item.$element;var k=i.offset();this.offset={top:k.top-(parseInt(i.css("marginTop"),10)||0),left:k.left-(parseInt(i.css("marginLeft"),10)||0)};g.extend(this.offset,{click:{left:j.pageX-this.offset.left,top:j.pageY-this.offset.top}});i.hide();this._refreshHitAreas();this.helper=this._createHelper();return true},_mouseDrag:function(k){if(!this.options.dragAndDrop){return}this.position=this._generatePosition(k);this.positionAbs=this.position;this.helper.offset(this.position);var m=this._findHoveredRectangle();var l=this.helper.offset();l.right=l.left+this.current_item.$element.outerWidth();l.bottom=l.top+this.current_item.$element.outerHeight();if(!((m)&&m.node)){this._removeGhost();this._removeHover();this._stopOpenFolderTimer()}else{if(this.hovered_rectangle!=m){this.hovered_rectangle=m;var i=this._getGhost();i.detach();this._stopOpenFolderTimer();var j=this.hovered_rectangle.node;if(j.hasChildren()&&!j.is_open){this._startOpenFolderTimer(j)}else{this._getNodeElementForNode(m.node).appendGhost(i,m.move_to)}}}return true},_mouseStop:function(){if(!this.options.dragAndDrop){return}this._moveItem();this._clear();this._removeHover();this._removeGhost();this._removeHintNodes();this.current_item.$element.show();return false},_getPointerRectangle:function(){var i=this.helper.offset();return{left:i.left,top:i.top,right:i.left+this.current_item.$element.outerWidth(),bottom:i.top+this.current_item.$element.outerHeight()}},_findHoveredRectangle:function(){return this.area.findIntersectingArea(this._getPointerRectangle())},_getGhost:function(){if(!this.$ghost){this.$ghost=this.current_item.createGhost();this.element.append(this.$ghost)}return this.$ghost},_moveItem:function(){if(this.hovered_rectangle){this.tree.moveNode(this.current_item.node,this.hovered_rectangle.node,this.hovered_rectangle.move_to);if(this.hovered_rectangle.move_to==a.INSIDE){this.hovered_rectangle.node.is_open=true}if(this.options.onMoveNode){this.options.onMoveNode(this.current_item.node,this.hovered_rectangle.node,a.getName(this.hovered_rectangle.move_to))}}this.element.empty();this._createDomElements(this.tree)},_createHelper:function(){var i=this.current_item.createHelper();i.css("position","absolute");this.element.append(i);return i},_clear:function(){this.helper.remove();this.helper=null},_generatePosition:function(i){return{left:i.pageX-this.offset.click.left,top:i.pageY-this.offset.click.top}},_refreshHitAreas:function(){this.area=this._generateAreaAndChildren();this._removeHintNodes();if(this.options.displayTestNodes){this.hint_nodes=this._createHintNodes(this.area)}},_generateAreaAndChildren:function(){var l=this;function p(t){var r=g(t.element).find("span:first");var u=r.offset();var s=new c(u.left,u.top,u.left+r.outerWidth(),u.top+r.outerHeight());var q=s.bottom-s.top;s.top+=(q/2)-1;s.bottom=s.top+2;s.name=t.name;return s}function k(s){var w=g(s.element);var q=g(s.element).find("span:first");var v=w.offset();var t=q.outerHeight();var u=w.offset().top+t;var r=new c(v.left+6,u,v.left+8,u+w.height()-t);r.name=s.name;return r}function i(s,t){var q=p(s);var r=q.duplicate();r.node=s;r.name=s.name;r.move_to=a.AFTER;r.left+=12;r.right=r.left+24;r.color="blue";t.addArea(r);r=q.duplicate();r.left+=36;r.setMinimumWidth(24);r.move_to=a.INSIDE;r.name=s.name;r.node=s;t.addArea(r)}function n(r,s){var q=k(r);q.node=r;q.name=r.name;q.move_to=a.AFTER;s.addArea(q);q=p(r);q.node=r.children[0];q.move_to=a.BEFORE;q.name=r.children[0].name;s.addArea(q)}function o(r,s){var q=p(r);q.node=r;q.name=r.name;q.move_to=a.INSIDE;s.addArea(q)}function j(q,r){g.each(q,function(t,v){var u=c.createFromElement(g(v.element));u.name=v.name;r.addArea(u);var s=true;if(l.options.onMustAddHitArea){s=l.options.onMustAddHitArea(v)}if(s){if(!v.hasChildren()){i(v,u)}else{if(v.is_open){n(v,u)}else{o(v,u)}}}if(v.hasChildren()&&v.is_open){j(v.children,u)}})}var m=c.createFromElement(this.element);m.name="tree";j(this.tree.children,m);return m},_createHintNodes:function(j){var k=[];var i=this;j.iterate(function(n){if(n.node){var m=n.color||"#000";var l=g('<span class="hit"></span>');l.css({position:"absolute",left:n.left,top:n.top,display:"block",width:n.right-n.left,height:n.bottom-n.top,opacity:"0.5",border:"solid 1px "+m});i.element.append(l);k.push(l)}});return k},_removeHover:function(){this.hovered_rectangle=null},_removeGhost:function(){if(this.$ghost){this.$ghost.remove();this.$ghost=null}},_removeHintNodes:function(){g.each(this.hint_nodes,function(){this.detach()});this.hint_nodes=[]},_openNodes:function(){var i;if(this.options.saveState){if(this._restoreState()){return}}if(this.options.autoOpen===false){return}else{if(this.options.autoOpen===true){i=-1}else{i=parseInt(this.options.autoOpen)}}this.tree.iterate(function(j,k){j.is_open=true;return(k!=i)})},_startOpenFolderTimer:function(j){var i=this;this.open_folder_timer=setTimeout(function(){i._getNodeElementForNode(j).open(function(){i._refreshHitAreas()})},500)},_stopOpenFolderTimer:function(){if(this.open_folder_timer){clearTimeout(this.open_folder_timer);this.open_folder_timer=null}}});var b=function(i){this.init(i)};g.extend(b.prototype,{init:function(i){this.node=i;this.$element=g(i.element)},getUl:function(){return this.$element.children("ul:first")},getSpan:function(){return this.$element.children("span:first")},getLi:function(){return this.$element},createHelper:function(){var i=this.getSpan().clone();i.addClass("dragging");return i},appendGhost:function(l,j){var k=["ghost"];if(j==a.AFTER){this.$element.after(l);if(this.node.hasChildren()){k.push("folder")}}else{if(j==a.BEFORE){this.$element.before(l)}else{if(j==a.INSIDE){this.$element.after(l);k.push("inside")}}}var i=l.children("span:first");i.attr("class",k.join(" "))},createGhost:function(){return g('<li><span class="ghost">'+this.node.name+"</span></li>")},select:function(){this.getSpan().addClass("selected")},deselect:function(){this.getSpan().removeClass("selected")}});var e=function(i){this.init(i)};g.extend(e.prototype,b.prototype,{toggle:function(i){if(this.node.is_open){this.close(i)}else{this.open(i)}},open:function(i){this.node.is_open=true;this.getButton().removeClass("closed");this.getUl().slideDown("fast",g.proxy(function(){this.getLi().removeClass("closed");if(i){i()}},this))},close:function(i){this.node.is_open=false;this.getButton().addClass("closed");this.getUl().slideUp("fast",g.proxy(function(){this.getLi().addClass("closed");if(i){i()}},this))},getButton:function(){return this.$element.children("a.toggler")}})})(jQuery);