(function(){var h,a,i,g,k,d,j,f,c,m,b,l=Object.prototype.hasOwnProperty,e=function(q,o){for(var n in o){if(l.call(o,n)){q[n]=o[n]}}function p(){this.constructor=q}p.prototype=o.prototype;q.prototype=new p;q.__super__=o.prototype;return q};this.Tree={};h=this.jQuery;m=function(r,p){var o,q,n;if(r.indexOf){return r.indexOf(p)}else{for(o=0,n=r.length;o<n;o++){q=r[o];if(q===p){return o}}return -1}};d={};d.escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;d.meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};d.quote=function(n){d.escapable.lastIndex=0;if(d.escapable.test(n)){return'"'+n.replace(d.escapable,function(o){var p;p=d.meta[o];return(type(p==="string")?p:"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4))})+'"'}else{return'"'+n+'"'}};d.str=function(A,s,u,w,o){var q,p,r,z,y,B,t,n,x;y=s[A];if(y&&typeof y==="object"&&y.toJSON==="function"){y=y.toJSON(A)}if(typeof w==="function"){y=w.call(s,A,y)}switch(typeof y){case"string":return d.quote(y);case"number":if(isFinite(y)){return String(y)}else{return"null"}case"boolean":case"null":return String(y);case"object":if(!y){return"null"}r=[];if(Object.prototype.toString.apply(y)==="[object Array]"){for(q=0,t=y.length;q<t;q++){x=y[q];r[q]=d.str(q,y,u+o,w,o)||"null"}return(r.length===0?"[]":u?"[\n"+u+r.join(",\n"+u)+"\n"+mind+"]":"["+r.join(",")+"]")}if(w&&typeof w==="object"){for(q=0,n=y.length;q<n;q++){p=y[q];if(typeof p==="string"){z=d.str(p,y,u,w,o);if(z){B=u?": ":":";r.push(d.quote(p)+B+z)}}}}else{for(p in y){if(Object.prototype.hasOwnProperty.call(y,p)){z=d.str(p,y,u,w,o);if(z){B=u?": ":":";r.push(d.quote(p)+B+z)}}}}return(r.length===0?"{}":u?"{\n"+u+r.join(",\n"+u)+"\n"+mind+"}":"{"+r.join(",")+"}")}};b=function(s,p,r){var t,o,n,q;t="";n="";if(typeof r==="number"){for(o=1;1<=r?o<=r:o>=r;1<=r?o++:o--){n+=" "}}else{if(typeof r==="string"){n=r}}q=p;if(p&&typeof p!=="function"&&typeof p!=="object"&&typeof p!=="number"){throw new Error("JSON.stringify")}return d.str("",{"":s},t,q,n)};c={getName:function(n){return this._getNames()[n]},_getNames:function(){var n;n={};n[c.BEFORE]="before";n[c.AFTER]="after";n[c.INSIDE]="inside";n[c.NONE]="none";return n}};c.BEFORE=1;c.AFTER=2;c.INSIDE=3;c.NONE=4;this.Tree.Position=c;j=(function(){function n(o){this.init(o)}n.prototype.init=function(o){this.name=o;this.children=[];return this.parent=null};n.prototype.initFromData=function(p){var o,q,r=this;q=function(s){return h.each(s,function(t,u){if(t==="children"){o(u)}else{if(t==="label"){r.name=u}else{r[t]=u}}return true})};o=function(w){var x,u,v,t,s;s=[];for(v=0,t=w.length;v<t;v++){x=w[v];u=new n();u.initFromData(x);s.push(r.addChild(u))}return s};return q(p)};n.prototype.loadFromData=function(t){var r,u,s,q,p,v=this;this.children=[];p=[];for(s=0,q=t.length;s<q;s++){u=t[s];r=new n(u.label);h.each(u,function(o,w){if(o!=="label"){r[o]=w}return true});this.addChild(r);if(u.children){p.push(r.loadFromData(u.children))}else{p.push(void 0)}}return p};n.prototype.addChild=function(o){this.children.push(o);return o.parent=this};n.prototype.addChildAtPosition=function(p,o){this.children.splice(o,0,p);return p.parent=this};n.prototype.removeChild=function(o){return this.children.splice(this.getChildIndex(o),1)};n.prototype.getChildIndex=function(o){return h.inArray(o,this.children)};n.prototype.hasChildren=function(){return this.children.length!==0};n.prototype.iterate=function(v,u){var t,o,s,q,r,p;if(!u){u=0}r=this.children;p=[];for(s=0,q=r.length;s<q;s++){t=r[s];o=v(t,u);if(this.hasChildren()&&o){p.push(t.iterate(v,u+1))}else{p.push(void 0)}}return p};n.prototype.moveNode=function(p,q,o){p.parent.removeChild(p);if(o===c.AFTER){return q.parent.addChildAtPosition(p,q.parent.getChildIndex(q)+1)}else{if(o===c.BEFORE){return q.parent.addChildAtPosition(p,q.parent.getChildIndex(q))}else{if(o===c.INSIDE){return q.addChildAtPosition(p,0)}}}};n.prototype.getData=function(){var o,p=this;o=function(r){var v,t,s,u,q;v=[];for(u=0,q=r.length;u<q;u++){t=r[u];s=h.extend({},t);delete s.parent;delete s.element;if(t.hasChildren()){s.children=o(t.children)}else{delete s.children}v.push(s)}return v};return o(this.children)};return n})();this.Tree.Tree=j;h.widget("ui.tree",h.ui.mouse,{widgetEventPrefix:"tree",options:{autoOpen:false,saveState:false,dragAndDrop:false,selectable:false,onCanSelectNode:null,onMoveNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onIsMoveHandle:null,onCanMove:null,onCanMoveTo:null},_create:function(){var n;this.tree=new j();this.tree.loadFromData(this.options.data);this.selected_node=null;this._openNodes();this._createDomElements(this.tree);if(this.selected_node){n=this._getNodeElementForNode(this.selected_node);if(n){n.select()}}this.element.click(h.proxy(this._click,this));this.element.bind("contextmenu",h.proxy(this._contextmenu,this));this._mouseInit();this.hovered_area=null;this.$ghost=null;return this.hit_areas=[]},destroy:function(){this.element.empty();this.element.unbind();this.tree=null;this._mouseDestroy();return h.Widget.prototype.destroy.call(this)},getTree:function(){return this.tree},toJson:function(){return b(this.tree.getData())},addNode:function(o){var p;p=new j();p.initFromData(o);this.getTree().addChild(p);this.element.empty();return this._createDomElements(this.getTree())},toggle:function(n,o){if(n.hasChildren()){new g(n).toggle(o)}if(this.options.saveState){return this._saveState()}},selectNode:function(n){if(this.options.selectable){if(this.selected_node){this._getNodeElementForNode(this.selected_node).deselect()}this._getNodeElementForNode(n).select();this.selected_node=n;if(this.options.saveState){return this._saveState()}}},getSelectedNode:function(){return this.selected_node||false},_getState:function(){var o,n,p=this;o=[];this.tree.iterate(function(q){if(q.is_open&&q.id&&q.hasChildren()){o.push(q.id)}return true});n="";if(this.selected_node){n=this.selected_node.id}return b({open_nodes:o,selected_node:n})},_setState:function(p){var o,q,n,r=this;o=h.parseJSON(p);q=o.open_nodes;n=o.selected_node;return this.tree.iterate(function(s){if(s.id&&s.hasChildren()&&(m(q,s.id)>=0)){s.is_open=true}if(n&&(s.id===n)){r.selected_node=s}return true})},_saveState:function(){if(this.options.onSetStateFromStorage){return this.options.onSetStateFromStorage(this._getState())}else{if(h.cookie){return h.cookie(this._getCookieName(),this._getState(),{path:"/"})}}},_restoreState:function(){var n;if(this.options.onGetStateFromStorage){n=this.options.onGetStateFromStorage()}else{if(h.cookie){n=h.cookie(this._getCookieName(),{path:"/"})}else{n=null}}if(!n){return false}else{this._setState(n);return true}},_getCookieName:function(){if(typeof this.options.saveState==="string"){return this.options.saveState}else{return"tree"}},_createDomElements:function(n){var o,q,r,t,p,s=this;t=function(x,w){var u,v;v=[];if(!x){v.push("tree")}u=h("<ul />");u.addClass(v.join(" "));return u};q=function(u){var v;if(u.hasChildren()){v=o(u)}else{v=r(u)}if(s.options.onCreateLi){s.options.onCreateLi(u,v)}return v};r=function(u){return h('<li><div><span class="title">'+u.name+"</span></div></li>")};o=function(v){var y,u,x,w;u=["toggler"];if(!v.is_open){u.push("closed")}x=u.join(" ");y=h('<li><div><a class="'+x+'">&raquo;</a><span class="title">'+v.name+"</span></div></li>");w=["folder"];if(!v.is_open){w.push("closed")}y.addClass(w.join(" "));return y};p=function(D,v,z,x){var B,u,A,y,C,w;A=t(z,x);D.append(A);w=[];for(y=0,C=v.length;y<C;y++){u=v[y];B=q(u);A.append(B);u.element=B[0];B.data("node",u);if(u.hasChildren()){w.push(p(B,u.children,z+1,u.is_open))}else{w.push(void 0)}}return w};return p(this.element,n.children,0,true)},_click:function(q){var n,p,o,r;if(q.ctrlKey){return}n=h(q.target);if(n.is(".toggler")){r=this._getNodeElement(n);if(r&&r.node.hasChildren()){r.toggle();if(this.options.saveState){this._saveState()}q.preventDefault();return q.stopPropagation()}}else{if(n.is("div")||n.is("span")){o=this._getNode(n);if(o){if((!this.options.onCanSelectNode)||this.options.onCanSelectNode(o)){this.selectNode(o);p=jQuery.Event("tree.click");p.node=o;return this.element.trigger(p)}}}}},_contextmenu:function(q){var n,p,o;n=h(q.target).closest("ul.tree div");if(n.length){o=this._getNode(n);if(o){q.preventDefault();q.stopPropagation();p=jQuery.Event("tree.contextmenu");p.node=o;p.click_event=q;this.element.trigger(p);return false}}},_getNode:function(n){var o;o=n.closest("li");if(o.length===0){return null}else{return o.data("node")}},_getNodeElement:function(n){var o;o=this._getNode(n);if(o){return this._getNodeElementForNode(o)}else{return null}},_getNodeElementForNode:function(n){if(n.hasChildren()){return new g(n)}else{return new f(n)}},_mouseCapture:function(o){var n,p;if(!this.options.dragAndDrop){return}n=h(o.target);if(this.options.onIsMoveHandle&&!this.options.onIsMoveHandle(n)){return null}p=this._getNodeElement(h(o.target));if(p&&this.options.onCanMove){if(!this.options.onCanMove(p.node)){p=null}}this.current_item=p;return this.current_item!==null},_mouseStart:function(o){var n,q,p;if(!this.options.dragAndDrop){return}this._refreshHitAreas();p=this._getOffsetFromEvent(o),n=p[0],q=p[1];this.drag_element=new i(this.current_item.node,n,q,this.element);this.current_item.$element.addClass("moving");return true},_getOffsetFromEvent:function(o){var n;n=h(o.target).offset();return[o.pageX-n.left,o.pageY-n.top]},_mouseDrag:function(o){var n,p;if(!this.options.dragAndDrop){return}this.drag_element.move(o.pageX,o.pageY);n=this.findHoveredArea(o.pageX,o.pageY);if(n&&this.options.onCanMoveTo){p=c.getName(n.position);if(!this.options.onCanMoveTo(this.current_item.node,n.node,p)){n=null}}if(!n){this._removeDropHint();this._removeHover();this._stopOpenFolderTimer()}else{if(this.hovered_area!==n){this.hovered_area=n;this._updateDropHint()}}return true},_updateDropHint:function(){var n,o;this._stopOpenFolderTimer();if(!this.hovered_area){return}n=this.hovered_area.node;if(n.hasChildren()&&!n.is_open&&this.hovered_area.position===c.INSIDE){this._startOpenFolderTimer(n)}this._removeDropHint();o=this._getNodeElementForNode(this.hovered_area.node);return this.previous_ghost=o.addDropHint(this.hovered_area.position)},_mouseStop:function(){if(!this.options.dragAndDrop){return}this._moveItem();this._clear();this._removeHover();this._removeDropHint();this._removeHitAreas();this.current_item.$element.removeClass("moving");return false},_mouseMove:function(n){if(h.browser.msie&&document.documentMode===8&&!n.button){n.button=1}return h.ui.mouse.prototype._mouseMove.call(this,n)},_moveItem:function(){if(this.hovered_area&&this.hovered_area.position!==c.NONE){this.tree.moveNode(this.current_item.node,this.hovered_area.node,this.hovered_area.position);if(this.hovered_area.position===c.INSIDE){this.hovered_area.node.is_open=true}if(this.options.onMoveNode){this.options.onMoveNode(this.current_item.node,this.hovered_area.node,c.getName(this.hovered_area.position))}this.element.empty();return this._createDomElements(this.tree)}},_clear:function(){this.drag_element.remove();return this.drag_element=null},_refreshHitAreas:function(){this._removeHitAreas();return this._generateHitAreas()},_generateHitAreas:function(){var n,u,p,t,r,y,o,s,q,w,v,x=this;v=[];w=0;u=function(z){return z.offset().top};n=function(A,z,B){v.push({top:B,node:A,position:z});return w=B};p=function(E){var D,z,C,B,A;C=-1;D=[];for(B=0,A=v.length;B<A;B++){z=v[B];if(z.top!==C){if(D.length){E(D,C,z.top)}C=z.top;D=[]}D.push(z)}return E(D,C,x.element.offset().top+x.element.height())};o=function(B,A,z){var C;C=u(z);if(B===x.current_item.node||A===x.current_item.node){return n(B,c.NONE,C)}else{n(B,c.INSIDE,C);return n(B,c.AFTER,C)}};s=function(A,z){if(A===x.current_item.node){return false}if(A.children[0]!==x.current_item.node){n(A,c.INSIDE,u(z))}return true};t=function(B,A,z){if(B===x.current_item.node||A===x.current_item.node){return n(B,c.NONE,w)}else{return n(B,c.AFTER,w)}};r=function(B,A,z){var C;C=u(z);if(B===x.current_item.node){return n(B,c.NONE,C)}else{n(B,c.INSIDE,C);if(A!==x.current_item.node){return n(B,c.AFTER,C)}}};y=function(A,z){if(A!==x.current_item.node){return n(A,c.BEFORE,u(h(A.element)))}};this._iterateVisibleNodes(o,s,r,t,y);q=[];p(function(B,F,z){var A,H,E,D,G,C;A=(z-F)/B.length;H=F;C=[];for(D=0,G=B.length;D<G;D++){E=B[D];q.push({top:H,bottom:H+A,node:E.node,position:E.position});C.push(H+=A)}return C});return this.hit_areas=q},findHoveredArea:function(o,t){var r,s,n,q,p;p=this.element.offset();if(o<p.left||t<p.top||o>(p.left+this.element.width())||t>(p.top+this.element.height())){return null}n=0;s=this.hit_areas.length;while(n<s){q=(n+s)>>1;r=this.hit_areas[q];if(t<r.top){s=q}else{if(t>r.bottom){n=q+1}else{return r}}}return null},_iterateVisibleNodes:function(p,u,o,s,q){var r,n,t=this;r=true;n=function(x,v){var D,w,C,z,A,B,y;A=(x.is_open||!x.element)&&x.hasChildren();if(x.element){D=h(x.element);if(!D.is(":visible")){return}if(r){q(x,D);r=false}if(!x.hasChildren()){p(x,v,D)}else{if(x.is_open){if(!u(x,D)){A=false}}else{o(x,v,D)}}}if(A){C=x.children.length;y=x.children;for(z=0,B=y.length;z<B;z++){w=y[z];if(z===(C-1)){n(x.children[z],null)}else{n(x.children[z],x.children[z+1])}}if(x.is_open){return s(x,v,D)}}};return n(this.tree)},_removeHover:function(){return this.hovered_area=null},_removeDropHint:function(){if(this.previous_ghost){return this.previous_ghost.remove()}},_removeHitAreas:function(){return this.hit_areas=[]},_openNodes:function(){var n;if(this.options.saveState){if(this._restoreState()){return}}if(this.options.autoOpen===false){return}else{if(this.options.autoOpen===true){n=-1}else{n=parseInt(this.options.autoOpen)}}return this.tree.iterate(function(o,p){o.is_open=true;return p!==n})},_startOpenFolderTimer:function(o){var n,p=this;n=function(){return p._getNodeElementForNode(o).open(function(){p._refreshHitAreas();return p._updateDropHint()})};return this.open_folder_timer=setTimeout(n,500)},_stopOpenFolderTimer:function(){if(this.open_folder_timer){clearTimeout(this.open_folder_timer);return this.open_folder_timer=null}}});k=(function(){function n(q,p,o){this.$element=p;this.node=q;this.$ghost=h('<li class="ghost"><span class="circle"></span><span class="line"></span></li>');if(o===c.AFTER){this.moveAfter()}else{if(o===c.BEFORE){this.moveBefore()}else{if(o===c.INSIDE){if(q.hasChildren()&&q.is_open){this.moveInsideOpenFolder()}else{this.moveInside()}}}}}n.prototype.remove=function(){return this.$ghost.remove()};n.prototype.moveAfter=function(){return this.$element.after(this.$ghost)};n.prototype.moveBefore=function(){return this.$element.before(this.$ghost)};n.prototype.moveInsideOpenFolder=function(){return h(this.node.children[0].element).before(this.$ghost)};n.prototype.moveInside=function(){this.$element.after(this.$ghost);return this.$ghost.addClass("inside")};return n})();a=(function(){function n(p){var o,q;o=p.children("div");q=p.width()-4;this.$hint=h('<span class="border"></span>');o.append(this.$hint);this.$hint.css({width:q,height:o.height()-4})}n.prototype.remove=function(){return this.$hint.remove()};return n})();f=(function(){function n(o){this.init(o)}n.prototype.init=function(o){this.node=o;return this.$element=h(o.element)};n.prototype.getUl=function(){return this.$element.children("ul:first")};n.prototype.getSpan=function(){return this.$element.children("div").find("span.title")};n.prototype.getLi=function(){return this.$element};n.prototype.addDropHint=function(o){if(o===c.INSIDE){return new a(this.$element)}else{return new k(this.node,this.$element,o)}};n.prototype.select=function(){return this.getLi().addClass("selected")};n.prototype.deselect=function(){return this.getLi().removeClass("selected")};return n})();g=(function(o){e(n,o);function n(){n.__super__.constructor.apply(this,arguments)}n.prototype.toggle=function(p){if(this.node.is_open){return this.close(p)}else{return this.open(p)}};n.prototype.open=function(p){this.node.is_open=true;this.getButton().removeClass("closed");return this.getUl().slideDown("fast",h.proxy(function(){this.getLi().removeClass("closed");if(p){return p()}},this))};n.prototype.close=function(p){this.node.is_open=false;this.getButton().addClass("closed");return this.getUl().slideUp("fast",h.proxy(function(){this.getLi().addClass("closed");if(p){return p()}},this))};n.prototype.getButton=function(){return this.$element.children("div").find("a.toggler")};n.prototype.addDropHint=function(p){if(!this.node.is_open&&p===c.INSIDE){return new a(this.$element)}else{return new k(this.node,this.$element,p)}};return n})(f);i=(function(){function n(q,p,o,r){this.offset_x=p;this.offset_y=o;this.$element=h('<span class="title tree-dragging">'+q.name+"</span>");this.$element.css("position","absolute");r.append(this.$element)}n.prototype.move=function(p,o){return this.$element.offset({left:p-this.offset_x,top:o-this.offset_y})};n.prototype.remove=function(){return this.$element.remove()};return n})();this.Tree.Node=j}).call(this);