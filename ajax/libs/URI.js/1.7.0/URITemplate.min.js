!function(e){var t=Object.prototype.hasOwnProperty,r="undefined"!=typeof module&&module.exports,n=function(e){return r?require("./"+e):window[e]},a=n("URI"),o=function(e){return o._cache[e]?o._cache[e]:this instanceof o?(this.expression=e,o._cache[e]=this,this):new o(e)},p=function(e){this.data=e,this.cache={}},s=o.prototype,i={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};o._cache={},o.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,o.VARIABLE_PATTERN=/^([^*:]+)((\*)|:(\d+))?$/,o.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_]/,o.expand=function(e,t){var r,n,a,p=i[e.operator],s=p.named?"Named":"Unnamed",l=e.variables,c=[];for(a=0;n=l[a];a++)r=t.get(n.name),r.val.length?c.push(o["expand"+s](r,p,n.explode,n.explode&&p.separator||",",n.maxlength,n.name)):r.type&&c.push("");return c.length?p.prefix+c.join(p.separator):""},o.expandNamed=function(t,r,n,o,p,s){var i,l,c,d="",h=r.encode,u=r.empty_name_separator,m=!t[h].length,f=2===t.type?"":a[h](s);for(l=0,c=t.val.length;c>l;l++)p?(i=a[h](t.val[l][1].substring(0,p)),2===t.type&&(f=a[h](t.val[l][0].substring(0,p)))):m?(i=a[h](t.val[l][1]),2===t.type?(f=a[h](t.val[l][0]),t[h].push([f,i])):t[h].push([e,i])):(i=t[h][l][1],2===t.type&&(f=t[h][l][0])),d&&(d+=o),n?d+=f+(u||i?"=":"")+i:(l||(d+=a[h](s)+(u||i?"=":"")),2===t.type&&(d+=f+","),d+=i);return d},o.expandUnnamed=function(t,r,n,o,p){var s,i,l,c,d="",h=r.encode,u=r.empty_name_separator,m=!t[h].length;for(l=0,c=t.val.length;c>l;l++)p?i=a[h](t.val[l][1].substring(0,p)):m?(i=a[h](t.val[l][1]),t[h].push([2===t.type?a[h](t.val[l][0]):e,i])):i=t[h][l][1],d&&(d+=o),2===t.type&&(s=p?a[h](t.val[l][0].substring(0,p)):t[h][l][0],d+=s,d+=n?u||i?"=":"":","),d+=i;return d},s.expand=function(e){var t="";this.parts&&this.parts.length||this.parse(),e instanceof p||(e=new p(e));for(var r=0,n=this.parts.length;n>r;r++)t+="string"==typeof this.parts[r]?this.parts[r]:o.expand(this.parts[r],e);return t},s.parse=function(){var e,t,r,n=this.expression,a=o.EXPRESSION_PATTERN,p=o.VARIABLE_PATTERN,s=o.VARIABLE_NAME_PATTERN,l=[],c=0;for(a.lastIndex=0;;){if(t=a.exec(n),null===t){l.push(n.substring(c));break}if(l.push(n.substring(c,t.index)),c=t.index+t[0].length,!i[t[1]])throw new Error('Unknown Operator "'+t[1]+'" in "'+t[0]+'"');if(!t[3])throw new Error('Unclosed Expression "'+t[0]+'"');e=t[2].split(",");for(var d=0,h=e.length;h>d;d++){if(r=e[d].match(p),null===r)throw new Error('Invalid Variable "'+e[d]+'" in "'+t[0]+'"');if(r[1].match(s))throw new Error('Invalid Variable Name "'+r[1]+'" in "'+t[0]+'"');e[d]={name:r[1],explode:!!r[3],maxlength:r[4]&&parseInt(r[4],10)}}if(!e.length)throw new Error('Expression Missing Variable(s) "'+t[0]+'"');l.push({expression:t[0],operator:t[1],variables:e})}return l.length||l.push(n),this.parts=l,this},p.prototype.get=function(r){var n,a,o,p=this.data,s={type:0,val:[],encode:[],encodeReserved:[]};if(this.cache[r]!==e)return this.cache[r];if(this.cache[r]=s,o="[object Function]"===String(Object.prototype.toString.call(p))?p(r):"[object Function]"===String(Object.prototype.toString.call(p[r]))?p[r](r):p[r],o===e||null===o)return s;if("[object Array]"===String(Object.prototype.toString.call(o))){for(n=0,a=o.length;a>n;n++)o[n]!==e&&null!==o[n]&&s.val.push([e,String(o[n])]);s.val.length&&(s.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(o))){for(n in o)t.call(o,n)&&o[n]!==e&&null!==o[n]&&s.val.push([n,String(o[n])]);s.val.length&&(s.type=2)}else s.type=1,s.val.push([e,String(o)]);return s},a.expand=function(e,t){var r=new o(e),n=r.expand(t);return new a(n)},"undefined"!=typeof module&&module.exports?module.exports=o:window.URITemplate=o}();