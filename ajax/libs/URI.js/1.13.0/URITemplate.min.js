!function(e,t){"object"==typeof exports?module.exports=t(require("./URI")):"function"==typeof define&&define.amd?define(["./URI"],t):e.URITemplate=t(e.URI,e)}(this,function(e,t){"use strict";function n(e){return n._cache[e]?n._cache[e]:this instanceof n?(this.expression=e,n._cache[e]=this,this):new n(e)}function r(e){this.data=e,this.cache={}}var a=t&&t.URITemplate,o=Object.prototype.hasOwnProperty,p=n.prototype,i={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};return n._cache={},n.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,n.VARIABLE_PATTERN=/^([^*:]+)((\*)|:(\d+))?$/,n.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_]/,n.expand=function(e,t){var r,a,o,p=i[e.operator],s=p.named?"Named":"Unnamed",c=e.variables,l=[];for(o=0;a=c[o];o++)r=t.get(a.name),r.val.length?l.push(n["expand"+s](r,p,a.explode,a.explode&&p.separator||",",a.maxlength,a.name)):r.type&&l.push("");return l.length?p.prefix+l.join(p.separator):""},n.expandNamed=function(t,n,r,a,o,p){var i,s,c,l="",d=n.encode,h=n.empty_name_separator,u=!t[d].length,f=2===t.type?"":e[d](p);for(s=0,c=t.val.length;c>s;s++)o?(i=e[d](t.val[s][1].substring(0,o)),2===t.type&&(f=e[d](t.val[s][0].substring(0,o)))):u?(i=e[d](t.val[s][1]),2===t.type?(f=e[d](t.val[s][0]),t[d].push([f,i])):t[d].push([void 0,i])):(i=t[d][s][1],2===t.type&&(f=t[d][s][0])),l&&(l+=a),r?l+=f+(h||i?"=":"")+i:(s||(l+=e[d](p)+(h||i?"=":"")),2===t.type&&(l+=f+","),l+=i);return l},n.expandUnnamed=function(t,n,r,a,o){var p,i,s,c,l="",d=n.encode,h=n.empty_name_separator,u=!t[d].length;for(s=0,c=t.val.length;c>s;s++)o?i=e[d](t.val[s][1].substring(0,o)):u?(i=e[d](t.val[s][1]),t[d].push([2===t.type?e[d](t.val[s][0]):void 0,i])):i=t[d][s][1],l&&(l+=a),2===t.type&&(p=o?e[d](t.val[s][0].substring(0,o)):t[d][s][0],l+=p,l+=r?h||i?"=":"":","),l+=i;return l},n.noConflict=function(){return t.URITemplate===n&&(t.URITemplate=a),n},p.expand=function(e){var t="";this.parts&&this.parts.length||this.parse(),e instanceof r||(e=new r(e));for(var a=0,o=this.parts.length;o>a;a++)t+="string"==typeof this.parts[a]?this.parts[a]:n.expand(this.parts[a],e);return t},p.parse=function(){var e,t,r,a=this.expression,o=n.EXPRESSION_PATTERN,p=n.VARIABLE_PATTERN,s=n.VARIABLE_NAME_PATTERN,c=[],l=0;for(o.lastIndex=0;;){if(t=o.exec(a),null===t){c.push(a.substring(l));break}if(c.push(a.substring(l,t.index)),l=t.index+t[0].length,!i[t[1]])throw new Error('Unknown Operator "'+t[1]+'" in "'+t[0]+'"');if(!t[3])throw new Error('Unclosed Expression "'+t[0]+'"');e=t[2].split(",");for(var d=0,h=e.length;h>d;d++){if(r=e[d].match(p),null===r)throw new Error('Invalid Variable "'+e[d]+'" in "'+t[0]+'"');if(r[1].match(s))throw new Error('Invalid Variable Name "'+r[1]+'" in "'+t[0]+'"');e[d]={name:r[1],explode:!!r[3],maxlength:r[4]&&parseInt(r[4],10)}}if(!e.length)throw new Error('Expression Missing Variable(s) "'+t[0]+'"');c.push({expression:t[0],operator:t[1],variables:e})}return c.length||c.push(a),this.parts=c,this},r.prototype.get=function(e){var t,n,r,a=this.data,p={type:0,val:[],encode:[],encodeReserved:[]};if(void 0!==this.cache[e])return this.cache[e];if(this.cache[e]=p,r="[object Function]"===String(Object.prototype.toString.call(a))?a(e):"[object Function]"===String(Object.prototype.toString.call(a[e]))?a[e](e):a[e],void 0===r||null===r)return p;if("[object Array]"===String(Object.prototype.toString.call(r))){for(t=0,n=r.length;n>t;t++)void 0!==r[t]&&null!==r[t]&&p.val.push([void 0,String(r[t])]);p.val.length&&(p.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(r))){for(t in r)o.call(r,t)&&void 0!==r[t]&&null!==r[t]&&p.val.push([t,String(r[t])]);p.val.length&&(p.type=2)}else p.type=1,p.val.push([void 0,String(r)]);return p},e.expand=function(t,r){var a=new n(t),o=a.expand(r);return new e(o)},n});