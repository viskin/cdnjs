!function(e,t){"object"==typeof exports?module.exports=t(require("./URI")):"function"==typeof define&&define.amd?define(["./URI"],t):e.URITemplate=t(e.URI)}(this,function(e){"use strict";function t(e){return t._cache[e]?t._cache[e]:this instanceof t?(this.expression=e,t._cache[e]=this,this):new t(e)}function r(e){this.data=e,this.cache={}}var n=Object.prototype.hasOwnProperty,a=t.prototype,o={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};return t._cache={},t.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,t.VARIABLE_PATTERN=/^([^*:]+)((\*)|:(\d+))?$/,t.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_]/,t.expand=function(e,r){var n,a,p,i=o[e.operator],s=i.named?"Named":"Unnamed",c=e.variables,l=[];for(p=0;a=c[p];p++)n=r.get(a.name),n.val.length?l.push(t["expand"+s](n,i,a.explode,a.explode&&i.separator||",",a.maxlength,a.name)):n.type&&l.push("");return l.length?i.prefix+l.join(i.separator):""},t.expandNamed=function(t,r,n,a,o,p){var i,s,c,l="",d=r.encode,h=r.empty_name_separator,u=!t[d].length,f=2===t.type?"":e[d](p);for(s=0,c=t.val.length;c>s;s++)o?(i=e[d](t.val[s][1].substring(0,o)),2===t.type&&(f=e[d](t.val[s][0].substring(0,o)))):u?(i=e[d](t.val[s][1]),2===t.type?(f=e[d](t.val[s][0]),t[d].push([f,i])):t[d].push([void 0,i])):(i=t[d][s][1],2===t.type&&(f=t[d][s][0])),l&&(l+=a),n?l+=f+(h||i?"=":"")+i:(s||(l+=e[d](p)+(h||i?"=":"")),2===t.type&&(l+=f+","),l+=i);return l},t.expandUnnamed=function(t,r,n,a,o){var p,i,s,c,l="",d=r.encode,h=r.empty_name_separator,u=!t[d].length;for(s=0,c=t.val.length;c>s;s++)o?i=e[d](t.val[s][1].substring(0,o)):u?(i=e[d](t.val[s][1]),t[d].push([2===t.type?e[d](t.val[s][0]):void 0,i])):i=t[d][s][1],l&&(l+=a),2===t.type&&(p=o?e[d](t.val[s][0].substring(0,o)):t[d][s][0],l+=p,l+=n?h||i?"=":"":","),l+=i;return l},a.expand=function(e){var n="";this.parts&&this.parts.length||this.parse(),e instanceof r||(e=new r(e));for(var a=0,o=this.parts.length;o>a;a++)n+="string"==typeof this.parts[a]?this.parts[a]:t.expand(this.parts[a],e);return n},a.parse=function(){var e,r,n,a=this.expression,p=t.EXPRESSION_PATTERN,i=t.VARIABLE_PATTERN,s=t.VARIABLE_NAME_PATTERN,c=[],l=0;for(p.lastIndex=0;;){if(r=p.exec(a),null===r){c.push(a.substring(l));break}if(c.push(a.substring(l,r.index)),l=r.index+r[0].length,!o[r[1]])throw new Error('Unknown Operator "'+r[1]+'" in "'+r[0]+'"');if(!r[3])throw new Error('Unclosed Expression "'+r[0]+'"');e=r[2].split(",");for(var d=0,h=e.length;h>d;d++){if(n=e[d].match(i),null===n)throw new Error('Invalid Variable "'+e[d]+'" in "'+r[0]+'"');if(n[1].match(s))throw new Error('Invalid Variable Name "'+n[1]+'" in "'+r[0]+'"');e[d]={name:n[1],explode:!!n[3],maxlength:n[4]&&parseInt(n[4],10)}}if(!e.length)throw new Error('Expression Missing Variable(s) "'+r[0]+'"');c.push({expression:r[0],operator:r[1],variables:e})}return c.length||c.push(a),this.parts=c,this},r.prototype.get=function(e){var t,r,a,o=this.data,p={type:0,val:[],encode:[],encodeReserved:[]};if(void 0!==this.cache[e])return this.cache[e];if(this.cache[e]=p,a="[object Function]"===String(Object.prototype.toString.call(o))?o(e):"[object Function]"===String(Object.prototype.toString.call(o[e]))?o[e](e):o[e],void 0===a||null===a)return p;if("[object Array]"===String(Object.prototype.toString.call(a))){for(t=0,r=a.length;r>t;t++)void 0!==a[t]&&null!==a[t]&&p.val.push([void 0,String(a[t])]);p.val.length&&(p.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(a))){for(t in a)n.call(a,t)&&void 0!==a[t]&&null!==a[t]&&p.val.push([t,String(a[t])]);p.val.length&&(p.type=2)}else p.type=1,p.val.push([void 0,String(a)]);return p},e.expand=function(r,n){var a=new t(r),o=a.expand(n);return new e(o)},t});