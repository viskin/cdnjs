!function(e,t){"object"==typeof exports?module.exports=t(require("./URI")):"function"==typeof define&&define.amd?define(["./URI"],t):e.URITemplate=t(e.URI)}(this,function(e){"use strict";function t(e){return t._cache[e]?t._cache[e]:this instanceof t?(this.expression=e,t._cache[e]=this,this):new t(e)}function n(e){this.data=e,this.cache={}}var r=function(e){return e("return this")()}(Function),a=r.URITemplate,o=Object.prototype.hasOwnProperty,p=t.prototype,i={"":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encode"},"+":{prefix:"",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},"#":{prefix:"#",separator:",",named:!1,empty_name_separator:!1,encode:"encodeReserved"},".":{prefix:".",separator:".",named:!1,empty_name_separator:!1,encode:"encode"},"/":{prefix:"/",separator:"/",named:!1,empty_name_separator:!1,encode:"encode"},";":{prefix:";",separator:";",named:!0,empty_name_separator:!1,encode:"encode"},"?":{prefix:"?",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"},"&":{prefix:"&",separator:"&",named:!0,empty_name_separator:!0,encode:"encode"}};return t._cache={},t.EXPRESSION_PATTERN=/\{([^a-zA-Z0-9%_]?)([^\}]+)(\}|$)/g,t.VARIABLE_PATTERN=/^([^*:]+)((\*)|:(\d+))?$/,t.VARIABLE_NAME_PATTERN=/[^a-zA-Z0-9%_]/,t.expand=function(e,n){var r,a,o,p=i[e.operator],s=p.named?"Named":"Unnamed",c=e.variables,l=[];for(o=0;a=c[o];o++)r=n.get(a.name),r.val.length?l.push(t["expand"+s](r,p,a.explode,a.explode&&p.separator||",",a.maxlength,a.name)):r.type&&l.push("");return l.length?p.prefix+l.join(p.separator):""},t.expandNamed=function(t,n,r,a,o,p){var i,s,c,l="",d=n.encode,h=n.empty_name_separator,u=!t[d].length,f=2===t.type?"":e[d](p);for(s=0,c=t.val.length;c>s;s++)o?(i=e[d](t.val[s][1].substring(0,o)),2===t.type&&(f=e[d](t.val[s][0].substring(0,o)))):u?(i=e[d](t.val[s][1]),2===t.type?(f=e[d](t.val[s][0]),t[d].push([f,i])):t[d].push([void 0,i])):(i=t[d][s][1],2===t.type&&(f=t[d][s][0])),l&&(l+=a),r?l+=f+(h||i?"=":"")+i:(s||(l+=e[d](p)+(h||i?"=":"")),2===t.type&&(l+=f+","),l+=i);return l},t.expandUnnamed=function(t,n,r,a,o){var p,i,s,c,l="",d=n.encode,h=n.empty_name_separator,u=!t[d].length;for(s=0,c=t.val.length;c>s;s++)o?i=e[d](t.val[s][1].substring(0,o)):u?(i=e[d](t.val[s][1]),t[d].push([2===t.type?e[d](t.val[s][0]):void 0,i])):i=t[d][s][1],l&&(l+=a),2===t.type&&(p=o?e[d](t.val[s][0].substring(0,o)):t[d][s][0],l+=p,l+=r?h||i?"=":"":","),l+=i;return l},t.noConflict=function(){return r.URITemplate===t&&(r.URITemplate=a),t},p.expand=function(e){var r="";this.parts&&this.parts.length||this.parse(),e instanceof n||(e=new n(e));for(var a=0,o=this.parts.length;o>a;a++)r+="string"==typeof this.parts[a]?this.parts[a]:t.expand(this.parts[a],e);return r},p.parse=function(){var e,n,r,a=this.expression,o=t.EXPRESSION_PATTERN,p=t.VARIABLE_PATTERN,s=t.VARIABLE_NAME_PATTERN,c=[],l=0;for(o.lastIndex=0;;){if(n=o.exec(a),null===n){c.push(a.substring(l));break}if(c.push(a.substring(l,n.index)),l=n.index+n[0].length,!i[n[1]])throw new Error('Unknown Operator "'+n[1]+'" in "'+n[0]+'"');if(!n[3])throw new Error('Unclosed Expression "'+n[0]+'"');e=n[2].split(",");for(var d=0,h=e.length;h>d;d++){if(r=e[d].match(p),null===r)throw new Error('Invalid Variable "'+e[d]+'" in "'+n[0]+'"');if(r[1].match(s))throw new Error('Invalid Variable Name "'+r[1]+'" in "'+n[0]+'"');e[d]={name:r[1],explode:!!r[3],maxlength:r[4]&&parseInt(r[4],10)}}if(!e.length)throw new Error('Expression Missing Variable(s) "'+n[0]+'"');c.push({expression:n[0],operator:n[1],variables:e})}return c.length||c.push(a),this.parts=c,this},n.prototype.get=function(e){var t,n,r,a=this.data,p={type:0,val:[],encode:[],encodeReserved:[]};if(void 0!==this.cache[e])return this.cache[e];if(this.cache[e]=p,r="[object Function]"===String(Object.prototype.toString.call(a))?a(e):"[object Function]"===String(Object.prototype.toString.call(a[e]))?a[e](e):a[e],void 0===r||null===r)return p;if("[object Array]"===String(Object.prototype.toString.call(r))){for(t=0,n=r.length;n>t;t++)void 0!==r[t]&&null!==r[t]&&p.val.push([void 0,String(r[t])]);p.val.length&&(p.type=3)}else if("[object Object]"===String(Object.prototype.toString.call(r))){for(t in r)o.call(r,t)&&void 0!==r[t]&&null!==r[t]&&p.val.push([t,String(r[t])]);p.val.length&&(p.type=2)}else p.type=1,p.val.push([void 0,String(r)]);return p},e.expand=function(n,r){var a=new t(n),o=a.expand(r);return new e(o)},t});