var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Watcher=require("./watcher.js"),Facet=require("./facet.js"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),defaults=require("../defaults.js"),type=require("./type.js");function complexHash(a){return a+"$"+(new Date()).getTime()+(""+Math.random()).replace("0.","")}function Baobab(a,d){if(arguments.length<1){a={}}if(!(this instanceof Baobab)){return new Baobab(a,d)}if(!type.Object(a)&&!type.Array(a)){throw Error("Baobab: invalid data.")}EventEmitter.call(this);this.options=helpers.shallowMerge(defaults,d);this._transaction={};this._future=undefined;this._cursors={};this._identity="[object Baobab]";this.data=helpers.deepClone(a);this.root=this.select([]);this.facets={};function c(e){this[e]=function(){var f=this.root[e].apply(this.root,arguments);return f instanceof Cursor?this:f}}["get","set","unset","update"].forEach(c.bind(this));if(!type.Object(this.options.facets)){throw Error("Baobab: invalid facets.")}for(var b in this.options.facets){this.addFacet(b,this.options.facets[b])}}helpers.inherits(Baobab,EventEmitter);Baobab.prototype.addFacet=function(a,b){this.facets[a]=this.createFacet(b);return this};Baobab.prototype.createFacet=function(a){return new Facet(this,a)};Baobab.prototype.select=function(d){if(!d){throw Error("Baobab.select: invalid path.")}if(arguments.length>1){d=helpers.arrayOf(arguments)}if(!type.Path(d)){throw Error("Baobab.select: invalid path.")}d=[].concat(d);var b=type.ComplexPath(d);var a;if(b){a=helpers.solvePath(this.data,d,this)}var c=d.map(function(f){if(type.Function(f)){return complexHash("fn")}else{if(type.Object(f)){return complexHash("ob")}else{return f}}}).join("|Î»|");if(!this._cursors[c]){var e=new Cursor(this,d,a,c);this._cursors[c]=e;return e}else{return this._cursors[c]}};Baobab.prototype.stack=function(b){var a=this;if(!type.Object(b)){throw Error("Baobab.update: wrong specification.")}this._transaction=merge(b,this._transaction);if(!this.options.autoCommit){return this}if(!this.options.asynchronous){return this.commit()}if(!this._future){this._future=setTimeout(a.commit.bind(a,null),0)}return this};Baobab.prototype.commit=function(){var b=this;var a=update(this.data,this._transaction,this.options);var f=this.data;this._transaction={};if(this._future){this._future=clearTimeout(this._future)}var e=this.options.validate,d=this.options.validationBehavior;if(typeof e==="function"){var c=e.call(this,f,a.data,a.log);if(c instanceof Error){this.emit("invalid",{error:c});if(d==="rollback"){return this}}}this.data=a.data;this.emit("update",{log:a.log,previousState:f});return this};Baobab.prototype.watch=function(a){if(!type.Array(a)||a.some(function(b){return !type.Path(b)})){throw Error("Baobab.watch: invalid paths.")}return new Watcher(this,[].concat(a))};Baobab.prototype.release=function(){var a;delete this.data;delete this._transaction;for(a in this._cursors){this._cursors[a].release()}delete this._cursors;for(a in this.facets){this.facets[a].release()}delete this.facets;this.kill()};Baobab.prototype.toJSON=function(){return this.get()};Baobab.prototype.toString=function(){return this._identity};module.exports=Baobab;