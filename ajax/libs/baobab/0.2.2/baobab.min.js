var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Typology=require("typology"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),types=require("./typology.js"),mixins=require("./mixins.js"),defaults=require("../defaults.json");function Baobab(a,b){if(!(this instanceof Baobab)){return new Baobab(a,b)}if(!types.check(a,"object|array")){throw Error("Baobab: invalid data.")}EventEmitter.call(this);this.options=merge(b,defaults);this._cloner=this.options.cloningFunction||helpers.clone;this._futureUpdate={};this._willUpdate=false;this._history=[];this._registeredCursors={};this.typology=this.options.typology?(types.check(this.options.typology,"typology")?this.options.typology:new Typology(this.options.typology)):new Typology();this.validate=this.options.validate||null;if(this.validate){try{this.typology.check(a,this.validate,true)}catch(c){c.message="/"+c.path.join("/")+": "+c.message;throw c}}this.data=this._cloner(a);this.mixin=mixins.baobab(this)}helpers.inherits(Baobab,EventEmitter);Baobab.prototype._stack=function(b){var a=this;if(!types.check(b,"object")){throw Error("Baobab.update: wrong specification.")}this._futureUpdate=merge(b,this._futureUpdate);if(!this.options.autoCommit){return this}if(!this.options.asynchronous){return this.commit()}if(!this._willUpdate){this._willUpdate=true;helpers.later(function(){a.commit()})}return this};Baobab.prototype._archive=function(){if(this.options.maxHistory<=0){return}var a={data:this._cloner(this.data)};if(this._history.length===this.options.maxHistory){this._history.pop()}this._history.unshift(a);return a};Baobab.prototype.commit=function(a){var m=this,c;if(a){this.data=a.data;c=a.log}else{var g=this._archive();c=update(this.data,this._futureUpdate);if(g){g.log=c}}if(this.validate){var k=[],b=c.length,j,f;for(f=0;f<b;f++){j=helpers.getIn(this.validate,c[f]);if(!j){continue}try{this.typology.check(this.get(c[f]),j,true)}catch(h){h.path=c[f].concat((h.path||[]));k.push(h)}}if(k.length){this.emit("invalid",{errors:k})}}this.emit("update",{log:c});this._futureUpdate={};this._willUpdate=false;return this};Baobab.prototype.select=function(b){if(arguments.length>1){b=helpers.arrayOf(arguments)}if(!types.check(b,"path")){throw Error("Baobab.select: invalid path.")}b=(typeof b==="string")?[b]:b;if(!this.options.cursorSingletons){return new Cursor(this,b)}else{var a=b.join("Î»");if(!this._registeredCursors[a]){var c=new Cursor(this,b);this._registeredCursors[a]=c;return c}else{return this._registeredCursors[a]}}};Baobab.prototype.reference=function(b){var a;if(arguments.length>1){b=helpers.arrayOf(arguments)}if(!types.check(b,"path")){throw Error("Baobab.get: invalid path.")}return helpers.getIn(this.data,types.check(b,"string|number")?[b]:b)};Baobab.prototype.get=function(){var a=this.reference.apply(this,arguments);return this.options.clone?this._cloner(a):a};Baobab.prototype.clone=function(a){return this._cloner(this.reference.apply(this,arguments))};Baobab.prototype.set=function(b,c){if(arguments.length<2){throw Error("Baobab.set: expects a key and a value.")}var a={};a[b]={$set:c};return this.update(a)};Baobab.prototype.update=function(a){return this._stack(a)};Baobab.prototype.hasHistory=function(){return !!this._history.length};Baobab.prototype.getHistory=function(){return this._history};Baobab.prototype.undo=function(){if(!this.hasHistory()){throw Error("Baobab.undo: no history recorded, cannot undo.")}var a=this._history.shift();this.commit(a)};types.add("baobab",function(a){return a instanceof Baobab});Baobab.prototype.toJSON=function(){return this.get()};module.exports=Baobab;