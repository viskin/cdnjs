var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Typology=require("typology"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),types=require("./typology.js"),mixins=require("./mixins.js"),defaults=require("../defaults.json");function Baobab(a,b){if(!(this instanceof Baobab)){return new Baobab(a,b)}if(!types.check(a,"object")){throw Error("Baobab: invalid data.")}EventEmitter.call(this);this.options=merge(b,defaults);this._cloner=this.options.cloningFunction||helpers.clone;this.data=this._cloner(a);this._futureUpdate={};this._willUpdate=false;this._history=[];this._registeredCursors={};this.typology=this.options.typology?(types.check(this.options.typology,"typology")?this.options.typology:new Typology(this.options.typology)):new Typology();this.validate=this.options.validate||null;if(!this.check()){throw Error("Baobab: instantiating with invalid data")}this.mixin=mixins.baobab(this)}helpers.inherits(Baobab,EventEmitter);Baobab.prototype._stack=function(b){var a=this;if(!types.check(b,"object")){throw Error("Baobab.update: wrong specification.")}this._futureUpdate=merge(b,this._futureUpdate);if(!this.options.autoCommit){return this}if(!this.options.delay){return this.commit()}if(!this._willUpdate){this._willUpdate=true;helpers.later(function(){a.commit()})}return this};Baobab.prototype._archive=function(){if(this.options.maxHistory<=0){return}var a={data:this._cloner(this.data)};if(this._history.length===this.options.maxHistory){this._history.pop()}this._history.unshift(a);return a};Baobab.prototype.check=function(){return this.validate?this.typology.check(this.data,this.validate):true};Baobab.prototype.commit=function(c){var b=this,d;if(c){this.data=c.data;d=c.log}else{var a=this._archive();d=update(this.data,this._futureUpdate);if(a){a.log=d}}if(!this.check()){this.emit("invalid")}this.emit("update",{log:d});this._futureUpdate={};this._willUpdate=false;return this};Baobab.prototype.select=function(b){if(arguments.length>1){b=helpers.arrayOf(arguments)}if(!types.check(b,"path")){throw Error("Baobab.select: invalid path.")}b=(typeof b==="string")?[b]:b;if(!this.options.cursorSingletons){return new Cursor(this,b)}else{var a=b.join("Î»");if(!this._registeredCursors[a]){var c=new Cursor(this,b);this._registeredCursors[a]=c;return c}else{return this._registeredCursors[a]}}};Baobab.prototype.get=function(b){var a;if(arguments.length>1){b=helpers.arrayOf(arguments)}if(b){a=helpers.getIn(this.data,typeof b==="string"?[b]:b)}else{a=this.data}return this.options.clone?this._cloner(a):a};Baobab.prototype.reference=function(b){var a;if(arguments.length>1){b=helpers.arrayOf(arguments)}if(b){a=helpers.getIn(this.data,typeof b==="string"?[b]:b)}else{a=this.data}return a};Baobab.prototype.clone=function(b){var a;if(arguments.length>1){b=helpers.arrayOf(arguments)}if(b){a=helpers.getIn(this.data,typeof b==="string"?[b]:b)}else{a=this.data}return this._cloner(a)};Baobab.prototype.set=function(b,c){if(arguments.length<2){throw Error("Baobab.set: expects a key and a value.")}var a={};a[b]={$set:c};return this.update(a)};Baobab.prototype.update=function(a){return this._stack(a)};Baobab.prototype.hasHistory=function(){return !!this._history.length};Baobab.prototype.getHistory=function(){return this._history};Baobab.prototype.undo=function(){if(!this.hasHistory()){throw Error("Baobab.undo: no history recorded, cannot undo.")}var a=this._history.shift();this.commit(a)};types.add("baobab",function(a){return a instanceof Baobab});Baobab.prototype.toJSON=function(){return this.get()};module.exports=Baobab;