var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Facet=require("./facet.js"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),defaults=require("../defaults.js"),type=require("./type.js");var uniqid=(function(){var a=0;return function(){return a++}})();function Baobab(a,d){if(arguments.length<1){a={}}if(!(this instanceof Baobab)){return new Baobab(a,d)}if(!type.Object(a)&&!type.Array(a)){throw Error("Baobab: invalid data.")}EventEmitter.call(this);this.options=helpers.shallowMerge(defaults,d);this._transaction={};this._future=undefined;this._cursors={};this._identity="[object Baobab]";this.log=[];this.previousData=null;this.data=a;this.root=this.select();this.facets={};if(this.options.immutable){helpers.deepFreeze(this.data)}function c(e){this[e]=function(){var f=this.root[e].apply(this.root,arguments);return f instanceof Cursor?this:f}}["get","set","unset","update"].forEach(c.bind(this));if(!type.Object(this.options.facets)){throw Error("Baobab: invalid facets.")}for(var b in this.options.facets){this.addFacet(b,this.options.facets[b])}}helpers.inherits(Baobab,EventEmitter);Baobab.prototype.addFacet=function(b,c,a){this.facets[b]=this.createFacet(c,a);return this};Baobab.prototype.createFacet=function(b,a){return new Facet(this,b,a)};Baobab.prototype.select=function(b){b=b||[];if(arguments.length>1){b=helpers.arrayOf(arguments)}if(!type.Path(b)){throw Error("Baobab.select: invalid path.")}b=[].concat(b);var a=b.map(function(d){if(type.Function(d)||type.Object(d)){return"$"+uniqid()+"$"}else{return d}}).join("|Î»|");var c;if(!this._cursors[a]){c=new Cursor(this,b,a);this._cursors[a]=c}else{c=this._cursors[a]}this.emit("select",{path:b,cursor:c});return c};Baobab.prototype.stack=function(c,d){var b=this;if(!type.Object(c)){throw Error("Baobab.update: wrong specification.")}if(!this.previousData){this.previousData=this.data}if(this.options.syncwrite){var a=update(this.data,c,this.options);this.data=a.data;this.log=[].concat(this.log).concat(a.log)}else{this._transaction=(d&&!Object.keys(this._transaction).length)?c:merge(this._transaction,c)}if(!this.options.autoCommit){return this}if(!this.options.asynchronous){return this.commit()}if(!this._future){this._future=setTimeout(b.commit.bind(b,null),0)}return this};Baobab.prototype.commit=function(){if(this._future){this._future=clearTimeout(this._future)}if(!this.options.syncwrite){var a=update(this.data,this._transaction,this.options);this.data=a.data;this.log=a.log}this._transaction={};var d=this.options.validate,c=this.options.validationBehavior;if(typeof d==="function"){var b=d.call(this,this.previousData,this.data,this.log);if(b instanceof Error){this.emit("invalid",{error:b});if(c==="rollback"){this.data=this.previousData;return this}}}this.emit("update",{log:this.log,previousData:this.previousData,data:this.data});this.log=[];this.previousData=null;return this};Baobab.prototype.release=function(){var a;delete this.data;delete this._transaction;for(a in this._cursors){this._cursors[a].release()}delete this._cursors;for(a in this.facets){this.facets[a].release()}delete this.facets;this.kill()};Baobab.prototype.toJSON=function(){return this.get()};Baobab.prototype.toString=function(){return this._identity};module.exports=Baobab;