var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Typology=require("typology"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),mixins=require("./mixins.js"),defaults=require("../defaults.js"),type=require("./type.js");function complexHash(a){return a+"$"+(new Date()).getTime()+(""+Math.random()).replace("0.","")}function Baobab(a,b){if(arguments.length<1){a={}}if(!(this instanceof Baobab)){return new Baobab(a,b)}if(!type.Object(a)&&!type.Array(a)){throw Error("Baobab: invalid data.")}EventEmitter.call(this);this.options=helpers.shallowMerge(defaults,b);this._cloner=this.options.cloningFunction||helpers.deepClone;this._transaction={};this._future=undefined;this._history=[];this._cursors={};this.typology=this.options.typology?(this.options.typology instanceof Typology?this.options.typology:new Typology(this.options.typology)):new Typology();this.validate=this.options.validate||null;if(this.validate){try{this.typology.check(a,this.validate,true)}catch(c){c.message="/"+c.path.join("/")+": "+c.message;throw c}}this.data=this._cloner(a);this.mixin=mixins.baobab(this)}helpers.inherits(Baobab,EventEmitter);Baobab.prototype._archive=function(){if(this.options.maxHistory<=0){return}var a={data:this._cloner(this.data)};if(this._history.length===this.options.maxHistory){this._history.pop()}this._history.unshift(a);return a};Baobab.prototype.commit=function(a){var m=this,c;if(a){this.data=a.data;c=a.log}else{if(this.options.shiftReferences){this.data=helpers.shallowClone(this.data)}var g=this._archive();c=update(this.data,this._transaction,this.options);if(g){g.log=c}}if(this.validate){var k=[],b=c.length,j,f;for(f=0;f<b;f++){j=helpers.getIn(this.validate,c[f]);if(!j){continue}try{this.typology.check(this.get(c[f]),j,true)}catch(h){h.path=c[f].concat((h.path||[]));k.push(h)}}if(k.length){this.emit("invalid",{errors:k})}}this._transaction={};if(this._future){this._future=clearTimeout(this._future)}this.emit("update",{log:c});return this};Baobab.prototype.select=function(d){if(!d){throw Error("Baobab.select: invalid path.")}if(arguments.length>1){d=helpers.arrayOf(arguments)}if(!type.Path(d)){throw Error("Baobab.select: invalid path.")}d=!type.Array(d)?[d]:d;var b=type.ComplexPath(d);var a;if(b){a=helpers.solvePath(this.data,d)}if(!this.options.cursorSingletons){return new Cursor(this,d)}else{var c=d.map(function(f){if(type.Function(f)){return complexHash("fn")}else{if(type.Object(f)){return complexHash("ob")}else{return f}}}).join("Î»");if(!this._cursors[c]){var e=new Cursor(this,d,a,c);this._cursors[c]=e;return e}else{return this._cursors[c]}}};Baobab.prototype.root=function(){return this.select([])};Baobab.prototype.reference=function(b){var a;if(arguments.length>1){b=helpers.arrayOf(arguments)}if(!type.Path(b)){throw Error("Baobab.get: invalid path.")}return helpers.getIn(this.data,type.String(b)||type.Number(b)?[b]:b)};Baobab.prototype.get=function(){var a=this.reference.apply(this,arguments);return this.options.clone?this._cloner(a):a};Baobab.prototype.clone=function(a){return this._cloner(this.reference.apply(this,arguments))};Baobab.prototype.set=function(b,d){if(arguments.length<2){throw Error("Baobab.set: expects a key and a value.")}var a={};if(type.Array(b)){var c=helpers.solvePath(this.data,b);if(!c){throw Error("Baobab.set: could not solve dynamic path.")}a=helpers.pathObject(c,{$set:d})}else{a[b]={$set:d}}return this.update(a)};Baobab.prototype.unset=function(b){if(!b&&b!==0){throw Error("Baobab.unset: expects a valid key to unset.")}var a={};a[b]={$unset:true};return this.update(a)};Baobab.prototype.update=function(b){var a=this;if(!type.Object(b)){throw Error("Baobab.update: wrong specification.")}this._transaction=merge(b,this._transaction);if(!this.options.autoCommit){return this}if(!this.options.asynchronous){return this.commit()}if(!this._future){this._future=setTimeout(a.commit.bind(a,null),0)}return this};Baobab.prototype.hasHistory=function(){return !!this._history.length};Baobab.prototype.getHistory=function(){return this._history};Baobab.prototype.undo=function(){if(!this.hasHistory()){throw Error("Baobab.undo: no history recorded, cannot undo.")}var a=this._history.shift();this.commit(a)};Baobab.prototype.release=function(){delete this.data;delete this._transaction;delete this._history;for(var a in this._cursors){this._cursors[a].release()}delete this._cursors;this.kill()};Baobab.prototype.toJSON=function(){return this.reference()};module.exports=Baobab;