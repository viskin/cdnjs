function Baobab(t,i){function e(t){this[t]=function(){var i=this.root[t].apply(this.root,arguments);return i instanceof Cursor?this:i}}if(arguments.length<1&&(t={}),!(this instanceof Baobab))return new Baobab(t,i);if(!type.Object(t)&&!type.Array(t))throw Error("Baobab: invalid data.");if(EventEmitter.call(this),this.options=helpers.shallowMerge(defaults,i),this._transaction={},this._future=void 0,this._cursors={},this._identity="[object Baobab]",this.log=[],this.previousData=null,this.data=t,this.root=this.select(),this.facets={},this.options.immutable&&helpers.deepFreeze(this.data),["apply","chain","get","merge","push","set","splice","unset","unshift","update"].forEach(e.bind(this)),!type.Object(this.options.facets))throw Error("Baobab: invalid facets.");for(var s in this.options.facets)this.addFacet(s,this.options.facets[s])}var Cursor=require("./cursor.js"),EventEmitter=require("emmett"),Facet=require("./facet.js"),helpers=require("./helpers.js"),update=require("./update.js"),merge=require("./merge.js"),defaults=require("../defaults.js"),type=require("./type.js"),uniqid=function(){var t=0;return function(){return t++}}();helpers.inherits(Baobab,EventEmitter),Baobab.prototype.addFacet=function(t,i,e){return this.facets[t]=this.createFacet(i,e),this},Baobab.prototype.createFacet=function(t,i){return new Facet(this,t,i)},Baobab.prototype.select=function(t){if(t=t||[],arguments.length>1&&(t=helpers.arrayOf(arguments)),!type.Path(t))throw Error("Baobab.select: invalid path.");t=[].concat(t);var i,e=t.map(function(t){return type.Function(t)||type.Object(t)?"$"+uniqid()+"$":t}).join("|Î»|");return this._cursors[e]?i=this._cursors[e]:(i=new Cursor(this,t,e),this._cursors[e]=i),this.emit("select",{path:t,cursor:i}),i},Baobab.prototype.stack=function(t,i){var e=this;if(!type.Object(t))throw Error("Baobab.update: wrong specification.");if(this.previousData||(this.previousData=this.data),this.options.syncwrite){var s=update(this.data,t,this.options);this.data=s.data,this.log=[].concat(this.log).concat(s.log)}else this._transaction=i&&!Object.keys(this._transaction).length?t:merge(this._transaction,t);return this.options.autoCommit?this.options.asynchronous?(this._future||(this._future=setTimeout(e.commit.bind(e,null),0)),this):this.commit():this},Baobab.prototype.commit=function(){if(this._future&&(this._future=clearTimeout(this._future)),!this.options.syncwrite){var t=update(this.data,this._transaction,this.options);this.data=t.data,this.log=t.log}this._transaction={};var i=this.options.validate,e=this.options.validationBehavior;if("function"==typeof i){var s=i.call(this,this.previousData,this.data,this.log);if(s instanceof Error&&(this.emit("invalid",{error:s}),"rollback"===e))return this.data=this.previousData,this}return this.emit("update",{log:this.log,previousData:this.previousData,data:this.data}),this.log=[],this.previousData=null,this},Baobab.prototype.release=function(){var t;delete this.data,delete this._transaction;for(t in this._cursors)this._cursors[t].release();delete this._cursors;for(t in this.facets)this.facets[t].release();delete this.facets,this.kill()},Baobab.prototype.toJSON=function(){return this.get()},Baobab.prototype.toString=function(){return this._identity},module.exports=Baobab;