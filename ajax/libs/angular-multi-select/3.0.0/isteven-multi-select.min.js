"use strict";angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function($sce,$timeout,$templateCache){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",buttonLabel:"@",directiveId:"@",helperElements:"@",isDisabled:"=",itemLabel:"@",maxLabels:"@",orientation:"@",selectionMode:"@",minSearchLength:"@",tickProperty:"@",disableProperty:"@",groupProperty:"@",searchProperty:"@",maxHeight:"@",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},template:'<span class="multiSelect inlineBlock" id={{directiveId}}>'+'<button type="button"'+'ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"'+'ng-bind-html="varButtonLabel">'+"</button>"+'<div class="checkboxLayer">'+"<div class=\"helperContainer\" ng-if=\"displayHelper( 'filter' ) || displayHelper( 'all' ) || displayHelper( 'none' ) || displayHelper( 'reset' )\">"+"<div class=\"line\" ng-if=\"displayHelper( 'all' ) || displayHelper( 'none' ) || displayHelper( 'reset' )\">"+'<button type="button" class="helperButton"'+"ng-if=\"!isDisabled && displayHelper( 'all' )\""+"ng-click=\"select( 'all', $event );\""+'ng-bind-html="lang.selectAll">'+"</button>"+'<button type="button" class="helperButton"'+"ng-if=\"!isDisabled && displayHelper( 'none' )\""+"ng-click=\"select( 'none', $event );\""+'ng-bind-html="lang.selectNone">'+"</button>"+'<button type="button" class="helperButton reset"'+"ng-if=\"!isDisabled && displayHelper( 'reset' )\""+"ng-click=\"select( 'reset', $event );\""+'ng-bind-html="lang.reset">'+"</button>"+"</div>"+'<div class="line" style="position:relative" ng-if="displayHelper( \'filter\' )">'+'<input placeholder="{{lang.search}}" type="text"'+"ng-click=\"select( 'filter', $event )\" "+'ng-model="inputLabel.labelFilter" '+'ng-change="searchChanged()" class="inputFilter"'+"/>"+'<button type="button" class="clearButton" ng-click="clearClicked( $event )" >×</button> '+"</div> "+"</div> "+'<div class="checkBoxContainer">'+"<div "+'ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"'+'ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"'+'ng-click="syncItems( item, $event, $index );" '+'ng-mouseleave="removeFocusStyle( tabIndex );"> '+'<div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index">'+"</div>  "+'<div class="acol">'+"<label>"+'<input class="checkbox focusable" type="checkbox" '+'ng-disabled="itemIsDisabled( item )" '+'ng-checked="item[ tickProperty ]" '+'ng-click="syncItems( item, $event, $index )" />'+"<span "+'ng-class="{disabled:itemIsDisabled( item )}" '+"ng-bind-html=\"writeLabel( item, 'itemLabel' )\">"+"</span>"+"</label>"+"</div>"+'<span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true">✔</span>'+"</div>"+"</div>"+"</div>"+"</span>",link:function($scope,element,attrs){$scope.backUp=[];$scope.varButtonLabel="";$scope.spacingProperty="";$scope.indexProperty="";$scope.orientationH=false;$scope.orientationV=true;$scope.filteredModel=[];$scope.inputLabel={labelFilter:""};$scope.tabIndex=0;$scope.lang={};$scope.localModel=[];var prevTabIndex=0,helperItems=[],helperItemsLength=0,checkBoxLayer="",scrolled=false,selectedItems=[],formElements=[],vMinSearchLength=0,clickedItem=null;$scope.clearClicked=function(e){$scope.inputLabel.labelFilter="";$scope.updateFilter();$scope.select("clear",e)};$scope.numberToArray=function(num){return new Array(num)};$scope.searchChanged=function(){if($scope.inputLabel.labelFilter.length<vMinSearchLength&&$scope.inputLabel.labelFilter.length>0){return false}$scope.updateFilter()};$scope.updateFilter=function(){$scope.filteredModel=[];var i=0;if(typeof $scope.localModel==="undefined"){return false}for(i=$scope.localModel.length-1;i>=0;i--){if(typeof $scope.localModel[i][$scope.groupProperty]!=="undefined"&&$scope.localModel[i][$scope.groupProperty]===false){$scope.filteredModel.push($scope.localModel[i])}var gotData=false;if(typeof $scope.localModel[i][$scope.groupProperty]==="undefined"){if(typeof attrs.searchProperty!=="undefined"&&$scope.searchProperty!==""){for(var key in $scope.localModel[i]){if(typeof $scope.localModel[i][key]!=="boolean"&&String($scope.localModel[i][key]).toUpperCase().indexOf($scope.inputLabel.labelFilter.toUpperCase())>=0&&$scope.searchProperty.indexOf(key)>-1){gotData=true;break}}}else{for(var key in $scope.localModel[i]){if(typeof $scope.localModel[i][key]!=="boolean"&&String($scope.localModel[i][key]).toUpperCase().indexOf($scope.inputLabel.labelFilter.toUpperCase())>=0){gotData=true;break}}}if(gotData===true){$scope.filteredModel.push($scope.localModel[i])}}if(typeof $scope.localModel[i][$scope.groupProperty]!=="undefined"&&$scope.localModel[i][$scope.groupProperty]===true){if(typeof $scope.filteredModel[$scope.filteredModel.length-1][$scope.groupProperty]!=="undefined"&&$scope.filteredModel[$scope.filteredModel.length-1][$scope.groupProperty]===false){$scope.filteredModel.pop()}else{$scope.filteredModel.push($scope.localModel[i])}}}$scope.filteredModel.reverse();$timeout(function(){$scope.getFormElements();if($scope.inputLabel.labelFilter.length>vMinSearchLength){var filterObj=[];angular.forEach($scope.filteredModel,function(value,key){if(typeof value!=="undefined"){if(typeof value[$scope.groupProperty]==="undefined"){var tempObj=angular.copy(value);var index=filterObj.push(tempObj);delete filterObj[index-1][$scope.indexProperty];delete filterObj[index-1][$scope.spacingProperty]}}});$scope.onSearchChange({data:{keyword:$scope.inputLabel.labelFilter,result:filterObj}})}},0)};$scope.getFormElements=function(){formElements=[];var selectButtons=element.children().children().next().children().children()[0].getElementsByTagName("button");var inputField=element.children().children().next().children().children().next()[0].getElementsByTagName("input");var clearButton=element.children().children().next().children().children().next()[0].getElementsByTagName("button");var checkboxes=element.children().children().next().children().next()[0].getElementsByTagName("input");for(var i=0;i<selectButtons.length;i++){formElements.push(selectButtons[i])}for(var i=0;i<inputField.length;i++){formElements.push(inputField[i])}for(var i=0;i<clearButton.length;i++){formElements.push(clearButton[i])}for(var i=0;i<checkboxes.length;i++){formElements.push(checkboxes[i])}};$scope.isGroupMarker=function(item,type){if(typeof item[$scope.groupProperty]!=="undefined"&&item[$scope.groupProperty]===type)return true;return false};$scope.removeGroupEndMarker=function(item){if(typeof item[$scope.groupProperty]!=="undefined"&&item[$scope.groupProperty]===false)return false;return true};$scope.displayHelper=function(elementString){if(attrs.selectionMode&&$scope.selectionMode.toUpperCase()==="SINGLE"){switch(elementString.toUpperCase()){case"ALL":return false;break;case"NONE":return false;break;case"RESET":if(typeof attrs.helperElements==="undefined"){return true}else if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("RESET")>=0){return true}break;case"FILTER":if(typeof attrs.helperElements==="undefined"){return true}if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf("FILTER")>=0){return true}break;default:break}return false}else{if(typeof attrs.helperElements==="undefined"){return true}if(attrs.helperElements&&$scope.helperElements.toUpperCase().indexOf(elementString.toUpperCase())>=0){return true}return false}};$scope.syncItems=function(item,e,ng_repeat_index){e.preventDefault();e.stopPropagation();if(typeof attrs.disableProperty!=="undefined"&&item[$scope.disableProperty]===true){return false}if(typeof attrs.isDisabled!=="undefined"&&$scope.isDisabled===true){return false}if(typeof item[$scope.groupProperty]!=="undefined"&&item[$scope.groupProperty]===false){return false}var index=$scope.filteredModel.indexOf(item);if(typeof item[$scope.groupProperty]!=="undefined"&&item[$scope.groupProperty]===true){if(attrs.selectionMode&&$scope.selectionMode.toUpperCase()==="SINGLE"){return false}var i,j,k;var startIndex=0;var endIndex=$scope.filteredModel.length-1;var tempArr=[];var nestLevel=0;for(i=index;i<$scope.filteredModel.length;i++){if(nestLevel===0&&i>index){break}if(typeof $scope.filteredModel[i][$scope.groupProperty]!=="undefined"&&$scope.filteredModel[i][$scope.groupProperty]===true){if(tempArr.length===0){startIndex=i+1}nestLevel=nestLevel+1}else if(typeof $scope.filteredModel[i][$scope.groupProperty]!=="undefined"&&$scope.filteredModel[i][$scope.groupProperty]===false){nestLevel=nestLevel-1;if(tempArr.length>0&&nestLevel===0){var allTicked=true;endIndex=i;for(j=0;j<tempArr.length;j++){if(typeof tempArr[j][$scope.tickProperty]!=="undefined"&&tempArr[j][$scope.tickProperty]===false){allTicked=false;break}}if(allTicked===true){for(j=startIndex;j<=endIndex;j++){if(typeof $scope.filteredModel[j][$scope.groupProperty]==="undefined"){if(typeof attrs.disableProperty==="undefined"){$scope.filteredModel[j][$scope.tickProperty]=false;inputModelIndex=$scope.filteredModel[j][$scope.indexProperty];$scope.localModel[inputModelIndex][$scope.tickProperty]=false}else if($scope.filteredModel[j][$scope.disableProperty]!==true){$scope.filteredModel[j][$scope.tickProperty]=false;inputModelIndex=$scope.filteredModel[j][$scope.indexProperty];$scope.localModel[inputModelIndex][$scope.tickProperty]=false}}}}else{for(j=startIndex;j<=endIndex;j++){if(typeof $scope.filteredModel[j][$scope.groupProperty]==="undefined"){if(typeof attrs.disableProperty==="undefined"){$scope.filteredModel[j][$scope.tickProperty]=true;inputModelIndex=$scope.filteredModel[j][$scope.indexProperty];$scope.localModel[inputModelIndex][$scope.tickProperty]=true}else if($scope.filteredModel[j][$scope.disableProperty]!==true){$scope.filteredModel[j][$scope.tickProperty]=true;inputModelIndex=$scope.filteredModel[j][$scope.indexProperty];$scope.localModel[inputModelIndex][$scope.tickProperty]=true}}}}}}else{tempArr.push($scope.filteredModel[i])}}}else{if(attrs.selectionMode&&$scope.selectionMode.toUpperCase()==="SINGLE"){for(i=0;i<$scope.filteredModel.length;i++){$scope.filteredModel[i][$scope.tickProperty]=false}for(i=0;i<$scope.localModel.length;i++){$scope.localModel[i][$scope.tickProperty]=false}$scope.filteredModel[index][$scope.tickProperty]=true;$scope.toggleCheckboxes(e)}else{$scope.filteredModel[index][$scope.tickProperty]=!$scope.filteredModel[index][$scope.tickProperty]}var inputModelIndex=$scope.filteredModel[index][$scope.indexProperty];$scope.localModel[inputModelIndex][$scope.tickProperty]=$scope.filteredModel[index][$scope.tickProperty]}clickedItem=angular.copy(item);if(clickedItem!==null){$timeout(function(){delete clickedItem[$scope.indexProperty];delete clickedItem[$scope.spacingProperty];$scope.onItemClick({data:clickedItem});clickedItem=null},0)}$scope.refreshOutputModel();$scope.refreshButton();prevTabIndex=$scope.tabIndex;$scope.tabIndex=ng_repeat_index+helperItemsLength;e.target.focus();$scope.removeFocusStyle(prevTabIndex);$scope.setFocusStyle($scope.tabIndex)};$scope.refreshOutputModel=function(){$scope.outputModel=[];angular.forEach($scope.localModel,function(value,key){if(typeof value!=="undefined"){if(typeof value[$scope.groupProperty]==="undefined"){if(value[$scope.tickProperty]===true){var temp=angular.copy(value);var index=$scope.outputModel.push(temp);delete $scope.outputModel[index-1][$scope.indexProperty];delete $scope.outputModel[index-1][$scope.spacingProperty]}}}})};$scope.refreshButton=function(){$scope.varButtonLabel="";var ctr=0;if($scope.outputModel.length===0){$scope.varButtonLabel=$scope.lang.nothingSelected}else{var tempMaxLabels=$scope.outputModel.length;if(typeof $scope.maxLabels!=="undefined"&&$scope.maxLabels!==""){tempMaxLabels=$scope.maxLabels}if($scope.outputModel.length>tempMaxLabels){$scope.more=true}else{$scope.more=false}angular.forEach($scope.outputModel,function(value,key){if(typeof value!=="undefined"){if(ctr<tempMaxLabels){$scope.varButtonLabel+=($scope.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+$scope.writeLabel(value,"buttonLabel")}ctr++}});if($scope.more===true){if(tempMaxLabels>0){$scope.varButtonLabel+=", ... "}$scope.varButtonLabel+="("+$scope.outputModel.length+")"}}$scope.varButtonLabel=$sce.trustAsHtml($scope.varButtonLabel+'<span class="caret"></span>')};$scope.itemIsDisabled=function(item){if(typeof attrs.disableProperty!=="undefined"&&item[$scope.disableProperty]===true){return true}else{if($scope.isDisabled===true){return true}else{return false}}};$scope.writeLabel=function(item,type){var temp=$scope[type].split(" ");var label="";angular.forEach(temp,function(value,key){item[value]&&(label+="&nbsp;"+value.split(".").reduce(function(prev,current){return prev[current]},item))});if(type.toUpperCase()==="BUTTONLABEL"){return label}return $sce.trustAsHtml(label)};$scope.toggleCheckboxes=function(e){var clickedEl=element.children()[0];angular.element(document).off("click",$scope.externalClickListener);angular.element(document).off("keydown",$scope.keyboardListener);$scope.inputLabel.labelFilter="";$scope.updateFilter();if(angular.element(checkBoxLayer).hasClass("show")){angular.element(checkBoxLayer).removeClass("show");angular.element(clickedEl).removeClass("buttonClicked");angular.element(document).off("click",$scope.externalClickListener);angular.element(document).off("keydown",$scope.keyboardListener);$scope.removeFocusStyle($scope.tabIndex);$timeout(function(){$scope.onClose()},0);element.children().children()[0].focus()}else{helperItems=[];helperItemsLength=0;angular.element(checkBoxLayer).addClass("show");angular.element(clickedEl).addClass("buttonClicked");angular.element(document).on("click",$scope.externalClickListener);angular.element(document).on("keydown",$scope.keyboardListener);$scope.getFormElements();$scope.tabIndex=0;var helperContainer=angular.element(element[0].querySelector(".helperContainer"))[0];if(typeof helperContainer!=="undefined"){for(var i=0;i<helperContainer.getElementsByTagName("BUTTON").length;i++){helperItems[i]=helperContainer.getElementsByTagName("BUTTON")[i]}helperItemsLength=helperItems.length+helperContainer.getElementsByTagName("INPUT").length}if(element[0].querySelector(".inputFilter")){element[0].querySelector(".inputFilter").focus();$scope.tabIndex=$scope.tabIndex+helperItemsLength-2}else{formElements[$scope.tabIndex].focus()}$scope.onOpen()}};$scope.externalClickListener=function(e){var targetsArr=element.find(e.target.tagName);for(var i=0;i<targetsArr.length;i++){if(e.target==targetsArr[i]){return}}angular.element(checkBoxLayer.previousSibling).removeClass("buttonClicked");angular.element(checkBoxLayer).removeClass("show");angular.element(document).off("click",$scope.externalClickListener);angular.element(document).off("keydown",$scope.keyboardListener);$timeout(function(){$scope.onClose()},0);element.children().children()[0].focus()};$scope.select=function(type,e){var helperIndex=helperItems.indexOf(e.target);$scope.tabIndex=helperIndex;switch(type.toUpperCase()){case"ALL":angular.forEach($scope.filteredModel,function(value,key){if(typeof value!=="undefined"&&value[$scope.disableProperty]!==true){if(typeof value[$scope.groupProperty]==="undefined"){value[$scope.tickProperty]=true}}});$scope.refreshOutputModel();$scope.refreshButton();$scope.onSelectAll();break;case"NONE":angular.forEach($scope.filteredModel,function(value,key){if(typeof value!=="undefined"&&value[$scope.disableProperty]!==true){if(typeof value[$scope.groupProperty]==="undefined"){value[$scope.tickProperty]=false}}});$scope.refreshOutputModel();$scope.refreshButton();$scope.onSelectNone();break;case"RESET":angular.forEach($scope.filteredModel,function(value,key){if(typeof value[$scope.groupProperty]==="undefined"&&typeof value!=="undefined"&&value[$scope.disableProperty]!==true){var temp=value[$scope.indexProperty];value[$scope.tickProperty]=$scope.backUp[temp][$scope.tickProperty]}});$scope.refreshOutputModel();$scope.refreshButton();$scope.onReset();break;case"CLEAR":$scope.tabIndex=$scope.tabIndex+1;$scope.onClear();break;case"FILTER":$scope.tabIndex=helperItems.length-1;break;default:}};function genRandomString(length){var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";var temp="";for(var i=0;i<length;i++){temp+=possible.charAt(Math.floor(Math.random()*possible.length))}return temp}$scope.prepareGrouping=function(){var spacing=0;angular.forEach($scope.filteredModel,function(value,key){value[$scope.spacingProperty]=spacing;if(value[$scope.groupProperty]===true){spacing+=2}else if(value[$scope.groupProperty]===false){spacing-=2}})};$scope.prepareIndex=function(){var ctr=0;angular.forEach($scope.filteredModel,function(value,key){value[$scope.indexProperty]=ctr;ctr++})};$scope.keyboardListener=function(e){var key=e.keyCode?e.keyCode:e.which;var isNavigationKey=false;if(key===27){e.preventDefault();$scope.toggleCheckboxes(e)}else if(key===40||key===39||!e.shiftKey&&key==9){isNavigationKey=true;prevTabIndex=$scope.tabIndex;$scope.tabIndex++;if($scope.tabIndex>formElements.length-1){$scope.tabIndex=0;prevTabIndex=formElements.length-1}while(formElements[$scope.tabIndex].disabled===true){$scope.tabIndex++;if($scope.tabIndex>formElements.length-1){$scope.tabIndex=0}}}else if(key===38||key===37||e.shiftKey&&key==9){isNavigationKey=true;prevTabIndex=$scope.tabIndex;$scope.tabIndex--;if($scope.tabIndex<0){$scope.tabIndex=formElements.length-1;prevTabIndex=0}while(formElements[$scope.tabIndex].disabled===true){$scope.tabIndex--;if($scope.tabIndex<0){$scope.tabIndex=formElements.length-1}}}if(isNavigationKey===true){e.preventDefault();formElements[$scope.tabIndex].focus();var actEl=document.activeElement;if(actEl.type.toUpperCase()==="CHECKBOX"){$scope.setFocusStyle($scope.tabIndex);$scope.removeFocusStyle(prevTabIndex)}else{$scope.removeFocusStyle(prevTabIndex);$scope.removeFocusStyle(helperItemsLength);$scope.removeFocusStyle(formElements.length-1)}}isNavigationKey=false};$scope.setFocusStyle=function(tabIndex){angular.element(formElements[tabIndex]).parent().parent().parent().addClass("multiSelectFocus")};$scope.removeFocusStyle=function(tabIndex){angular.element(formElements[tabIndex]).parent().parent().parent().removeClass("multiSelectFocus")};var tempStr=genRandomString(5);$scope.indexProperty="idx_"+tempStr;$scope.spacingProperty="spc_"+tempStr;if(typeof attrs.orientation!=="undefined"){if(attrs.orientation.toUpperCase()==="HORIZONTAL"){$scope.orientationH=true;$scope.orientationV=false}else{$scope.orientationH=false;$scope.orientationV=true}}checkBoxLayer=element.children().children().next()[0];if(typeof attrs.maxHeight!=="undefined"){var layer=element.children().children().children()[0];angular.element(layer).attr("style","height:"+$scope.maxHeight+"; overflow-y:scroll;")}var icon={};icon.selectAll="&#10003;";icon.selectNone="&times;";icon.reset="&#8630;";if(typeof attrs.translation!=="undefined"){$scope.lang.selectAll=$sce.trustAsHtml(icon.selectAll+"&nbsp;&nbsp;"+$scope.translation.selectAll);$scope.lang.selectNone=$sce.trustAsHtml(icon.selectNone+"&nbsp;&nbsp;"+$scope.translation.selectNone);$scope.lang.reset=$sce.trustAsHtml(icon.reset+"&nbsp;&nbsp;"+$scope.translation.reset);$scope.lang.search=$scope.translation.search;$scope.lang.nothingSelected=$sce.trustAsHtml($scope.translation.nothingSelected)}else{$scope.lang.selectAll=$sce.trustAsHtml(icon.selectAll+"&nbsp;&nbsp;Select All");$scope.lang.selectNone=$sce.trustAsHtml(icon.selectNone+"&nbsp;&nbsp;Select None");$scope.lang.reset=$sce.trustAsHtml(icon.reset+"&nbsp;&nbsp;Reset");$scope.lang.search="Search...";$scope.lang.nothingSelected="None Selected"}if(typeof attrs.MinSearchLength!=="undefined"&&parseInt(attrs.MinSearchLength)>0){vMinSearchLength=Math.floor(parseInt(attrs.MinSearchLength))}$scope.$watch("inputModel",function(newVal){if(newVal){$scope.localModel=angular.copy($scope.inputModel);$scope.refreshOutputModel();$scope.refreshButton()}},true);$scope.$watch("localModel",function(newVal){if(newVal){$scope.backUp=angular.copy($scope.localModel);$scope.updateFilter();$scope.prepareGrouping();$scope.prepareIndex();$scope.refreshOutputModel();$scope.refreshButton()}});$scope.$watch("isDisabled",function(newVal){$scope.isDisabled=newVal});angular.element(document).on("touchstart",function(e){$scope.$apply(function(){scrolled=false})});angular.element(document).on("touchmove",function(e){$scope.$apply(function(){scrolled=true})})}}}]);
