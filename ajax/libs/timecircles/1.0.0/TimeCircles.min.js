(function(f){function c(j){var i=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;j=j.replace(i,function(l,o,n,k){return o+o+n+n+k+k});var h=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(j);return h?{r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16)}:null}function b(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}function d(){return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()}var g={};var e=function(l,q){this.element=l;this.container;this.timer=null;this.data={text_elements:{Days:null,Hours:null,Minutes:null,Seconds:null},attributes:{canvas:null,context:null,item_size:null,line_width:null,radius:null,outer_radius:null},state:{fading:{Days:false,Hours:false,Minutes:false,Seconds:false}}};this.listeners=[];this.config=null;this.setOptions(q);this.container=f("<div>");this.container.addClass("time_circles");this.container.appendTo(this.element);this.data.attributes.canvas=f("<canvas>");this.data.attributes.context=this.data.attributes.canvas[0].getContext("2d");var p=this.element.offsetHeight;var h=this.element.offsetWidth;if(p===0&&h>0){p=h/4}else{if(h===0&&p>0){h=p*4}}this.data.attributes.canvas[0].height=p;this.data.attributes.canvas[0].width=h;this.data.attributes.canvas.appendTo(this.container);this.data.attributes.item_size=Math.min(this.data.attributes.canvas[0].width/4,this.data.attributes.canvas[0].height);this.data.attributes.line_width=this.data.attributes.item_size*this.config.fg_width;this.data.attributes.radius=((this.data.attributes.item_size*0.8)-this.data.attributes.line_width)/2;this.data.attributes.outer_radius=this.data.attributes.radius+0.5*Math.max(this.data.attributes.line_width,this.data.attributes.line_width*this.config.bg_width);var m=0;for(var o in this.data.text_elements){var j=f("<div>");j.addClass("textDiv_"+o);j.css("top",Math.round(0.35*this.data.attributes.item_size));j.css("left",Math.round(m++*this.data.attributes.item_size));j.css("width",this.data.attributes.item_size);j.appendTo(this.container);var n=f("<h4>");n.text(this.config.time[o].text);n.css("font-size",Math.round(0.07*this.data.attributes.item_size));n.css("line-height",Math.round(0.07*this.data.attributes.item_size)+"px");n.appendTo(j);var k=f("<span>");k.css("font-size",Math.round(0.21*this.data.attributes.item_size));k.css("line-height",Math.round(0.07*this.data.attributes.item_size)+"px");k.appendTo(j);this.data.text_elements[o]=k}if(this.config.start){this.start()}};e.prototype.updateArc=function(){var r,v;var j=(1000*this.config.refresh_interval);var l=new Date();if(this.config.count_past_zero){var h=l-j;r=Math.abs(l-this.data.attributes.ref_date)/1000;v=Math.abs(this.data.attributes.ref_date-h)/1000}else{r=Math.max(this.data.attributes.ref_date-l,0)/1000;v=r+(l>this.data.attributes.ref_date)?0:j}var k={Days:(r/60/60/24),Hours:(r/60/60)%24,Minutes:(r/60)%60,Seconds:r%60};var u={Days:k.Days/365,Hours:k.Hours/24,Minutes:k.Minutes/60,Seconds:k.Seconds/60};var o={Days:(v/60/60/24),Hours:(v/60/60)%24,Minutes:(v/60)%60,Seconds:v%60};var n=0;var t=null;for(var s in k){this.data.text_elements[s].text(Math.floor(k[s]));var q=(n*this.data.attributes.item_size)+(this.data.attributes.item_size/2);var p=this.data.attributes.item_size/2;var m=this.config.time[s].color;if(Math.floor(k[s])!==Math.floor(o[s])){this.notifyListeners(s,Math.floor(k[s]),Math.floor(r))}if(t!==null){if(Math.floor(k[t])>Math.floor(o[t])){this.radialFade(q,p,m,1,s);this.data.state.fading[s]=true}else{if(Math.floor(k[t])<Math.floor(o[t])){this.radialFade(q,p,m,0,s);this.data.state.fading[s]=true}}}if(!this.data.state.fading[s]){this.drawArc(q,p,m,u[s])}t=s;n++}};e.prototype.drawArc=function(h,o,j,m){var n=Math.max(this.data.attributes.outer_radius,this.data.attributes.item_size/2);this.data.attributes.context.clearRect(h-n,o-n,n*2,n*2);if(this.config.use_background){this.data.attributes.context.beginPath();this.data.attributes.context.arc(h,o,this.data.attributes.radius,0,2*Math.PI,false);this.data.attributes.context.lineWidth=this.data.attributes.line_width*this.config.bg_width;this.data.attributes.context.strokeStyle=this.config.circle_bg_color;this.data.attributes.context.stroke()}var l=(-0.5*Math.PI);var i=(-0.5*Math.PI)+(2*m*Math.PI);var k=false;this.data.attributes.context.beginPath();this.data.attributes.context.arc(h,o,this.data.attributes.radius,l,i,k);this.data.attributes.context.lineWidth=this.data.attributes.line_width;this.data.attributes.context.strokeStyle=j;this.data.attributes.context.stroke()};e.prototype.radialFade=function(o,n,j,p,q){var m=c(j);var l=this;var h=0.2*((p===1)?-1:1);var k;for(k=0;p<=1&&p>=0;k++){(function(){var i="rgba("+m.r+", "+m.g+", "+m.b+", "+(Math.round(p*10)/10)+")";setTimeout(function(){l.drawArc(o,n,i,1)},50*k)}());p+=h}setTimeout(function(){l.data.state.fading[q]=false},50*k)};e.prototype.timeLeft=function(){var h=new Date();return((this.data.attributes.ref_date-h)/1000)};e.prototype.start=function(){var i=f(this.element).data("date");if(typeof i==="string"){if(i.match(/^[0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-9]{1,2}:[0-9]{2}:[0-9]{2}$/).length>0){i=i.replace(" ","T")}this.data.attributes.ref_date=Date.parse(i)}else{var h=f(this.element).attr("data-timer");if(typeof h==="string"){this.data.attributes.timer=parseFloat(h);f(this.element).removeAttr("data-timer")}else{if(typeof this.config.timer==="string"){this.data.attributes.timer=parseFloat(this.config.timer);this.config.timer=null}else{if(typeof this.config.timer==="number"){this.data.attributes.timer=j.config.timer;this.config.timer=null}}}if(typeof this.data.attributes.timer==="number"){this.data.attributes.ref_date=(new Date()).getTime()+(this.data.attributes.timer*1000)}else{this.data.attributes.ref_date=this.config.ref_date}}var j=this;this.timer=setInterval(function(){j.updateArc()},this.config.refresh_interval*1000)};e.prototype.stop=function(){if(typeof this.data.attributes.timer==="number"){this.data.attributes.timer=this.timeLeft(this)}clearInterval(this.timer)};e.prototype.destroy=function(){this.stop();this.container.remove();f(this.element).removeData("tc-id")};e.prototype.setOptions=function(h){if(this.config===null){this.default_options.ref_date=new Date();this.config=f.extend(true,{},this.default_options)}f.extend(true,this.config,h)};e.prototype.addListener=function(h){if(typeof h!=="function"){return}this.listeners.push(h)};e.prototype.notifyListeners=function(k,l,j){for(var h=0;h<this.listeners.length;h++){this.listeners[h](k,l,j)}};e.prototype.default_options={ref_date:new Date(),start:true,refresh_interval:0.1,count_past_zero:true,circle_bg_color:"#60686F",use_background:true,fg_width:0.1,bg_width:1.2,time:{Days:{show:true,text:"Days",color:"#FC6"},Hours:{show:true,text:"Hours",color:"#9CF"},Minutes:{show:true,text:"Minutes",color:"#BFB"},Seconds:{show:true,text:"Seconds",color:"#F99"}}};var a=function(i,h){this.elements=i;this.options=h;this.foreach()};a.prototype.foreach=function(i){var h=this;this.elements.each(function(){var j;var l=f(this).data("tc-id");if(typeof l==="undefined"){l=d();f(this).data("tc-id",l)}if(typeof g[l]==="undefined"){var m=f(this).data("options");var k=h.options;if(typeof m==="object"){k=f.extend(true,{},h.options,m)}j=new e(this,k);g[l]=j}else{j=g[l];if(typeof h.options!=="undefined"){j.setOptions(h.options)}}if(typeof i==="function"){i(j)}});return this};a.prototype.start=function(){this.foreach(function(h){h.start()});return this};a.prototype.stop=function(){this.foreach(function(h){h.stop()});return this};a.prototype.addListener=function(h){this.foreach(function(i){i.addListener(h)});return this};a.prototype.destroy=function(){this.foreach(function(h){h.destroy()});return this};a.prototype.end=function(){return this.elements};f.fn.TimeCircles=function(h){return new a(this,h)}}(jQuery));