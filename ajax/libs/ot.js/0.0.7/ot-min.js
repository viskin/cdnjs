if(typeof ot=="undefined")var ot={};ot.Operation=function(){function e(e,n,i){t(typeof e=="number"&&e>=0,"the first parameter to the the parent revision number of the document"),this.revision=e,this.id=n||r(),t(this.id&&typeof this.id=="string","not a valid id: "+this.id),this.meta=i||{},this.ops=[],this.baseLength=0,this.targetLength=0}function t(e,t){if(!e)throw new Error(t||"assertion error")}function n(e){return Math.floor(Math.random()*e)}function r(){var e="",t=16;while(t--)e+=n(16).toString(16);return e}return e.prototype.retain=function(e){t(typeof e=="number"&&e>=0);if(e===0)return this;this.baseLength+=e,this.targetLength+=e;var n=this.ops[this.ops.length-1];return n&&n.retain?n.retain+=e:this.ops.push({retain:e}),this},e.prototype.insert=function(e){t(typeof e=="string");if(e==="")return this;this.targetLength+=e.length;var n=this.ops[this.ops.length-1];return n&&n.insert?n.insert+=e:this.ops.push({insert:e}),this},e.prototype.delete=function(e){typeof e=="string"&&(e=e.length),t(typeof e=="number");if(e===0)return this;this.baseLength+=e;var n=this.ops[this.ops.length-1];return n&&n.delete?n.delete+=e:this.ops.push({"delete":e}),this},e.prototype.toString=function(){var e=Array.prototype.map||function(e){var t=this,n=[];for(var r=0,i=t.length;r<i;r++)n[r]=e(t[r]);return n};return e.call(this.ops,function(e){return e.retain?"retain "+e.retain:e.insert?"insert '"+e.insert+"'":"delete "+e.delete}).join(", ")},e.fromJSON=function(n){t(n.id);var r=new e(n.revision,n.id,n.meta);t(typeof r.meta=="object");var i=n.ops;for(var s=0,o=i.length;s<o;s++){var u=i[s];if(u.retain)r.retain(u.retain);else if(u.insert)r.insert(u.insert);else{if(!u.delete)throw new Error("unknown operation: "+JSON.stringify(u));r.delete(u.delete)}}return t(r.baseLength===n.baseLength,"baseLengths don't match"),t(r.targetLength===n.targetLength,"targetLengths don't match"),r},e.prototype.apply=function(e){var t=this;if(e.length!==t.baseLength)throw new Error("The operation's base length must be equal to the string's length.");var n=[],r=0,i=0,s=this.ops;for(var o=0,u=s.length;o<u;o++){var a=s[o];if(a.retain){if(i+a.retain>e.length)throw new Error("Operation can't retain more characters than are left in the string.");n[r++]=e.slice(i,i+a.retain),i+=a.retain}else a.insert?n[r++]=a.insert:i+=a.delete}if(i!==e.length)throw new Error("The operation didn't operate on the whole string.");return n.join("")},e.prototype.invert=function(t){var n=0,r=new e(this.revision+1),i=this.ops;for(var s=0,o=i.length;s<o;s++){var u=i[s];u.retain?(r.retain(u.retain),n+=u.retain):u.insert?r.delete(u.insert.length):(r.insert(t.slice(n,n+u.delete)),n+=u.delete)}return r},e.prototype.compose=function(t){var n=this;if(n.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");if(n.revision+1!==t.revision)throw new Error("The second operations revision must be one more than the first operations revision");var r=new e(n.revision,undefined,n.meta),i=n.ops,s=t.ops,o=0,u=0,a=i[o++],f=s[u++];for(;;){var l=a&&(a.retain||a.delete||a.insert.length),c=f&&(f.retain||f.delete||f.insert.length),h=Math.min(l,c);if(typeof a=="undefined"&&typeof f=="undefined")break;if(typeof a=="undefined"){if(!f.insert)throw new Error("Successive operations can only insert new characters at the end of the string.");r.insert(f.insert),f=s[u++]}else if(typeof f=="undefined"){if(!a.delete)throw new Error("The first operation can only delete at the end of operation 2.");r.delete(a.delete),a=i[o++]}else if(a.retain&&f.retain)r.retain(h),l>c?(a={retain:l-c},f=s[u++]):l===c?(a=i[o++],f=s[u++]):(a=i[o++],f={retain:c-l});else if(a.insert&&f.delete)l>c?(a={insert:a.insert.slice(c)},f=s[u++]):l===c?(a=i[o++],f=s[u++]):(a=i[o++],f={"delete":f.delete-l});else if(a.insert&&f.retain)l>c?(r.insert(a.insert.slice(0,c)),a={insert:a.insert.slice(c)},f=s[u++]):l===c?(r.insert(a.insert),a=i[o++],f=s[u++]):(r.insert(a.insert),a=i[o++],f={retain:c-l});else if(a.retain&&f.delete)l>c?(r.delete(f.delete),a={retain:l-c},f=s[u++]):l===c?(r.delete(f.delete),a=i[o++],f=s[u++]):(r.delete(l),a=i[o++],f={"delete":f.delete-l});else if(a.delete)r.delete(a.delete),a=i[o++];else{if(!f.insert)throw new Error("This shouldn't happen: op1: "+JSON.stringify(a)+", op2: "+JSON.stringify(f));r.insert(f.insert),f=s[u++]}}return r},e.transform=function(t,n){if(t.baseLength!==n.baseLength)throw new Error("Both operations have to have the same base length");if(t.revision!==n.revision)throw new Error("Both operations have to have the same revision");var r=new e(n.revision+1,t.id,t.meta),i=new e(t.revision+1,n.id,n.meta),s=t.ops,o=n.ops,u=0,a=0,f=s[u++],l=o[a++];for(;;){var c=f&&(f.retain||f.delete||f.insert.length),h=l&&(l.retain||l.delete||l.insert.length),p=Math.min(c,h);if(typeof f=="undefined"&&typeof l=="undefined")break;if(f&&f.insert)r.insert(f.insert),i.retain(f.insert.length),f=s[u++];else if(l&&l.insert)r.retain(l.insert.length),i.insert(l.insert),l=o[a++];else if(f.retain&&l.retain)r.retain(p),i.retain(p),c>h?(f={retain:c-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={retain:h-c});else if(f.delete&&l.delete)c>h?(f={"delete":f.delete-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={"delete":l.delete-c});else if(f.delete&&l.retain)r.delete(p),c>h?(f={"delete":f.delete-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={retain:l.retain-c});else{if(!f.retain||!l.delete)throw new Error("The two operations aren't compatible");i.delete(p),c>h?(f={retain:f.retain-h},l=o[a++]):c===h?(f=s[u++],l=o[a++]):(f=s[u++],l={"delete":l.delete-c})}}return[r,i]},e}(),typeof module=="object"&&(module.exports=ot.Operation);if(typeof ot=="undefined")var ot={};ot.Client=function(e){function r(e){s(typeof e=="number"&&e>=0),this.serverRevision=e,this.state="synchronized"}function i(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function s(e,t){if(!e)throw new Error(t||"assertion error")}var t=e.ot?e.ot.Operation:require("./operation"),n={callMethodForState:function(e){var t=Array.prototype.slice.call(arguments,1);return this.states[this.state][e].apply(this,t)},transitionTo:function(e){var t=Array.prototype.slice.call(arguments,1);this.states[this.state].exit.apply(this,[]),this.states[this.state=e].enter.apply(this,t)}};return i(r.prototype,n),r.prototype.createOperation=function(){return new t(this.callMethodForState("newRevision"))},r.prototype.applyClient=function(e){return this.callMethodForState("applyClient",e)},r.prototype.applyServer=function(e){s(e.revision===this.serverRevision),this.callMethodForState("applyServer",e),this.serverRevision++},r.prototype.sendOperation=function(e){throw new Error("sendOperation must be defined in child class")},r.prototype.applyOperation=function(e){throw new Error("applyOperation must be defined in child class")},r.prototype.states={"synchronized":{enter:function(){},exit:function(){},applyClient:function(e){this.sendOperation(e),this.transitionTo("awaitingConfirm",e)},applyServer:function(e){this.applyOperation(e)},newRevision:function(){return this.serverRevision}},awaitingConfirm:{enter:function(e){this.outstanding=e},exit:function(){delete this.outstanding},applyClient:function(e){s(e.revision===this.serverRevision+1),this.transitionTo("awaitingWithBuffer",this.outstanding,e)},applyServer:function(e){if(e.id===this.outstanding.id)this.transitionTo("synchronized");else{var n=t.transform(this.outstanding,e);this.outstanding=n[0],this.applyOperation(n[1])}},newRevision:function(){return this.serverRevision+1}},awaitingWithBuffer:{enter:function(e,t){this.outstanding=e,this.buffer=t},exit:function(){delete this.outstanding,delete this.buffer},applyClient:function(e){s(e.revision===this.serverRevision+2),this.buffer=this.buffer.compose(e)},applyServer:function(e){if(e.id===this.outstanding.id)this.sendOperation(this.buffer),this.transitionTo("awaitingConfirm",this.buffer);else{var n=t.transform(this.outstanding,e);this.outstanding=n[0];var r=n[1],i=t.transform(this.buffer,r);this.buffer=i[0],this.applyOperation(i[1])}},newRevision:function(){return this.serverRevision+2}}},r}(this),typeof module=="object"&&(module.exports=ot.Client),function(){function e(e,t){if(!e)throw new Error(t||"assertion error")}ot.Operation.prototype.fromCodeMirrorChange=function(e,t){function i(e){var t=e.line,n=e.ch,i=0;for(var s=0;s<e.line;s++)i+=r[s].length+1;return i+=n,i}function s(){var e=0;for(var t=0,n=r.length;t<n;t++)e+=r[t].length;return e+r.length-1}function o(e,t){if(e.line===t.line)return r[e.line].slice(e.ch,t.ch);var n=r[e.line].slice(e.ch)+"\n";for(var i=e.line+1;i<t.line;i++)n+=r[i]+"\n";return n+=r[t.line].slice(0,t.ch),n}function u(e,t,n){var i=e.slice(0),s=r[t.line].slice(0,t.ch),o=r[n.line].slice(n.ch);i[0]=s+i[0],i[i.length-1]+=o,i.unshift(n.line-t.line+1),i.unshift(t.line),r.splice.apply(r,i)}function a(e,t){var n=i(t.from),r=i(t.to),a=s();e.retain(n),e.delete(o(t.from,t.to)),e.insert(t.text.join("\n")),e.retain(a-r),u(t.text,t.from,t.to)}var n=this,r=t.split("\n");a(n,e);for(;;){e=e.next;if(!e)break;var f=new ot.Operation(n.revision+1);a(f,e),n=n.compose(f)}return n},ot.Operation.prototype.applyToCodeMirror=function(t){var n=this;t.operation(function(){var r=n.ops,i=0;for(var s=0,o=r.length;s<o;s++){var u=r[s];if(u.retain)i+=u.retain;else if(u.insert)t.replaceRange(u.insert,t.posFromIndex(i)),i+=u.insert.length;else if(u.delete){var a=t.posFromIndex(i),f=t.posFromIndex(i+u.delete);t.replaceRange("",a,f)}}e(i===t.getValue().length)})}}(),ot.CodeMirrorClient=function(){function n(t,n){this.socket=t,this.cm=n,this.fromServer=!1,this.unredo=!1,this.undoStack=[],this.redoStack=[],this.clients={},this.initializeClientList();var r=this;t.on("doc",function(t){e.call(r,t.revision),r.initializeCodeMirror(t.str),r.initializeSocket(),r.initializeClients(t.clients)})}function r(e,t,n,r,i,s){this.id=e,this.listEl=t,this.cm=n,this.name=r,this.selectionClassName="client-selection-"+u(1e6),this.li=document.createElement("li"),r&&(this.li.textContent=r,this.listEl.appendChild(this.li)),this.cursorEl=document.createElement("div"),this.cursorEl.className="other-client",this.pre=document.createElement("pre"),this.pre.innerHTML="&nbsp;",this.cursorEl.appendChild(this.pre),typeof i=="number"&&typeof s=="number"&&this.updateCursor(i,s),this.setColor(r?l(r):Math.random())}function i(e){function t(e){var t=e.ops;return t.length===0||t.length===1&&!!t[0].retain}while(e.length>0){var n=e[e.length-1];if(!t(n))break;e.pop()}}function o(e){var t=e.ops;if(t[0].retain){var n=t[0].retain;return t[1].insert?n+t[1].insert.length:n}return t[0].insert?t[0].insert.length:0}function u(e){return Math.floor(Math.random()*e)}function a(e,t,n){function r(e){var t=Math.round(255*e).toString(16);return t.length===1?"0"+t:t}return"#"+r(e)+r(t)+r(n)}function f(e,t,n){if(t===0)return a(n,n,n);var r=n<.5?n*(1+t):n+t-t*n,i=2*n-r,s=function(e){return e<0&&(e+=1),e>1&&(e-=1),6*e<1?i+(r-i)*6*e:2*e<1?r:3*e<2?i+(r-i)*6*(2/3-e):i};return a(s(e+1/3),s(e),s(e-1/3))}function l(e){var t=1;for(var n=0;n<e.length;n++)t=17*(t+e.charCodeAt(n))%360;return t/360}function c(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}function h(e){e.parentNode&&e.parentNode.removeChild(e)}function p(e){try{var t=document.styleSheets.item(0),n=(t.rules?t.rules:t.cssRules).length;t.insertRule(e,n)}catch(r){console.error("Couldn't add style rule.",r)}}var e=ot.Client,t=ot.Operation;c(n,e),n.prototype.applyClient=function(t){t.meta.cursor=this.cursor,t.meta.selectionEnd=this.selectionEnd,clearTimeout(this.sendCursorTimeout),e.prototype.applyClient.call(this,t)},n.prototype.applyServer=function(t){e.prototype.applyServer.call(this,t)},n.prototype.initializeSocket=function(){var e=this;this.socket.on("client_left",function(t){e.onClientLeft(t.clientId)}).on("set_name",function(t){var n=e.getClientObject(t.clientId);n.setName(t.name)}).on("operation",function(n){var r=t.fromJSON(n);console.log("Operation from server by client "+r.meta.clientId+":",r),e.applyServer(r)}).on("cursor",function(t){var n=e.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd)})},r.prototype.setColor=function(e){this.hue=e;var t=f(e,.75,.5);this.li&&(this.li.style.color=t),this.pre.style.borderLeftColor=t;var n=f(e,.5,.9),r="."+this.selectionClassName,i="background:"+n+";",s=r+"{"+i+"}";p(s)},r.prototype.setName=function(e){this.name=e,this.li.textContent=e,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(l(e))},r.prototype.updateCursor=function(e,t){this.cursor=e,this.selectionEnd=t;var n=cm.posFromIndex(e);h(this.cursorEl),this.cm.addWidget(n,this.cursorEl,!1),this.mark&&(this.mark.clear(),delete this.mark);if(e!==t){var r,i;t>e?(r=n,i=this.cm.posFromIndex(t)):(r=this.cm.posFromIndex(t),i=n),this.mark=this.cm.markText(r,i,this.selectionClassName)}},r.prototype.remove=function(){this.li&&h(this.li),this.cursorEl&&h(this.cursorEl),this.mark&&this.mark.clear()},n.prototype.getClientObject=function(e){var t=this.clients[e];return t?t:this.clients[e]=new r(e,this.clientListEl,this.cm)},n.prototype.onClientLeft=function(e){console.log("User disconnected: "+e);var t=this.clients[e];if(!t)return;t.remove(),delete this.clients[e]},n.prototype.initializeCodeMirror=function(e){var t=this.cm,n=this;t.setValue(e),this.oldValue=e;var r=t.getOption("onChange");t.setOption("onChange",function(e,i){n.onCodeMirrorChange(i),r&&r.call(this,t,i)});var i=t.getOption("onCursorActivity");t.setOption("onCursorActivity",function(e){n.onCodeMirrorCursorActivity(),i&&i.call(this,t)}),t.undo=function(){n.undo()},t.redo=function(){n.redo()}},n.prototype.initializeClients=function(e){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n.clientId=t,this.clients[t]=new r(n.clientId,this.clientListEl,this.cm,n.name,n.cursor,n.selectionEnd)}},n.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")};var s=20;return n.prototype.unredoHelper=function(e,t){i(e);if(e.length===0)return;var n=e.pop();n.revision=this.createOperation().revision,t.push(n.invert(this.oldValue)),this.unredo=!0,n.applyToCodeMirror(this.cm),this.cursor=this.selectionEnd=o(n),this.cm.setCursor(this.cm.posFromIndex(this.cursor)),this.applyClient(n)},n.prototype.transformUnredoStack=function(e,n){i(e);for(var r=e.length-1;r>=0;r--){e[r].revision=n.revision;var s=t.transform(e[r],n);e[r]=s[0],n=s[1]}},n.prototype.addOperationToUndo=function(e){function t(e,t){var n=e.ops;switch(n.length){case 0:return!0;case 1:return!!t(n[0]);case 2:return!!(n[0].retain&&t(n[1])||t(n[0])&&n[1].retain);case 3:return!!(n[0].retain&&t(n[1])&&n[2].retain);default:return!1}}function n(e){return t(e,function(e){return e.insert})}function r(e){return t(e,function(e){return e.delete})}function i(e,t){if(n(e)&&n(t))return n(e.compose(t));if(r(e)&&r(t)){var i=e.ops[0],s=t.ops;return i.retain?s[0].delete?i.retain===s[0].delete:i.retain===s[0].retain+s[1].delete:!1}return!1}if(this.undoStack.length===0)this.undoStack.push(e);else{var o=this.undoStack[this.undoStack.length-1];o.revision=e.revision+1;if(i(e,o)){var u=e.compose(o);this.undoStack[this.undoStack.length-1]=u}else this.undoStack.push(e),this.undoStack.length>s&&this.undoStack.shift()}this.redoStack.length>0&&(this.redoStack=[])},n.prototype.undo=function(){this.unredoHelper(this.undoStack,this.redoStack)},n.prototype.redo=function(){this.unredoHelper(this.redoStack,this.undoStack)},n.prototype.onCodeMirrorChange=function(e){var t=this.cm;try{if(!this.fromServer&&!this.unredo){var n=this.createOperation().fromCodeMirrorChange(e,this.oldValue);this.addOperationToUndo(n.invert(this.oldValue)),this.applyClient(n)}}finally{this.fromServer=!1,this.unredo=!1,this.oldValue=t.getValue()}},n.prototype.onCodeMirrorCursorActivity=function(){function t(e,t){return e.line===t.line&&e.ch===t.ch}var e=this.cm,n=e.getCursor(),r=e.indexFromPos(n),i;if(e.somethingSelected()){var s=e.getCursor(!0),o=t(n,s)?e.getCursor(!1):s;i=e.indexFromPos(o)}else i=r;this.cursor=r,this.selectionEnd=i;if(this.state==="awaitingWithBuffer")this.buffer.meta.cursor=r,this.buffer.meta.selectionEnd=i;else{var u=this;clearTimeout(this.sendCursorTimeout),this.sendCursorTimeout=setTimeout(function(){u.socket.emit("cursor",{cursor:r,selectionEnd:i})},50)}},n.prototype.sendOperation=function(e){this.socket.emit("operation",e)},n.prototype.applyOperation=function(e){this.fromServer=!0,e.applyToCodeMirror(this.cm);var t=e.meta,n=this.getClientObject(t.clientId);n.updateCursor(t.cursor,t.selectionEnd),this.transformUnredoStack(this.undoStack,e),this.transformUnredoStack(this.redoStack,e)},n}();