var geo={};window.geo=geo,geo.renderers={},geo.features={},geo.fileReaders={},geo.inherit=function(C,P){"use strict";var F=inherit.func();F.prototype=P.prototype,C.prototype=new F,C.prototype.constructor=C},geo.inherit.func=function(){"use strict";return function(){}},window.inherit=geo.inherit,geo.registerFileReader=function(name,func){"use strict";void 0===geo.fileReaders&&(geo.fileReaders={}),geo.fileReaders[name]=func},geo.createFileReader=function(name,opts){"use strict";return geo.fileReaders.hasOwnProperty(name)?geo.fileReaders[name](opts):null},geo.registerRenderer=function(name,func){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[name]=func},geo.createRenderer=function(name,layer,canvas){"use strict";if(geo.renderers.hasOwnProperty(name)){var ren=geo.renderers[name]({layer:layer,canvas:canvas});return ren._init(),ren}return null},geo.registerFeature=function(category,name,func){"use strict";void 0===geo.features&&(geo.features={}),category in geo.features||(geo.features[category]={}),geo.features[category][name]=func},geo.createFeature=function(name,layer,renderer,arg){"use strict";var category=renderer.api(),options={layer:layer,renderer:renderer};return category in geo.features&&name in geo.features[category]?(void 0!==arg&&$.extend(!0,options,arg),geo.features[category][name](options)):null},geo.registerLayer=function(name,func){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[name]=func},geo.createLayer=function(name,map,arg){"use strict";var options={map:map,renderer:"vgl"},layer=null;return name in geo.layers?(void 0!==arg&&$.extend(!0,options,arg),layer=geo.layers[name](options),layer._init(),layer):null},geo.registerWidget=function(category,name,func){"use strict";void 0===geo.widgets&&(geo.widgets={}),category in geo.widgets||(geo.widgets[category]={}),geo.widgets[category][name]=func},geo.createWidget=function(name,layer,renderer,arg){"use strict";var category=renderer.api(),options={layer:layer,renderer:renderer};return category in geo.widgets&&name in geo.widgets[category]?(void 0!==arg&&$.extend(!0,options,arg),geo.widgets[category][name](options)):null},window.requestAnimationFrame||(window.requestAnimationFrame=function(func){"use strict";window.setTimeout(func,15)}),Math.log2||(Math.log2=function(){"use strict";return Math.log.apply(Math,arguments)/Math.LN2}),geo.version="0.4.2",function(){"use strict";function setNumeric(){var i;for(i=0;i<arguments.length;i+=1)if(isFinite(arguments[i]))return arguments[i]}var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";geo.util={pointInPolygon:function(point,outer,inner){var inside=!1,n=outer.length;return 3>n?!1:(outer.forEach(function(vert,i){var j=(n+i-1)%n,intersect=outer[i].y>point.y!=outer[j].y>point.y&&point.x<(outer[j].x-outer[i].x)*(point.y-outer[i].y)/(outer[j].y-outer[i].y)+outer[i].x;intersect&&(inside=!inside)}),(inner||[]).forEach(function(hole){inside=inside&&!geo.util.pointInPolygon(point,hole)}),inside)},isFunction:function(f){return"function"==typeof f},ensureFunction:function(f){return geo.util.isFunction(f)?f:function(){return f}},randomString:function(n){var s,i,r;for(n=n||8,s="",i=0;n>i;i+=1)r=Math.floor(Math.random()*chars.length),s+=chars.substring(r,r+1);return s},convertColor:function(color){return void 0!==color.r&&void 0!==color.g&&void 0!==color.b?color:("string"==typeof color&&(geo.util.cssColors.hasOwnProperty(color)?color=geo.util.cssColors[color]:"#"===color.charAt(0)&&(color=parseInt(color.slice(1),16))),isFinite(color)&&(color={r:((16711680&color)>>16)/255,g:((65280&color)>>8)/255,b:(255&color)/255}),color)},normalizeCoordinates:function(p){return p=p||{},Array.isArray(p)?{x:p[0],y:p[1],z:p[2]||0}:p instanceof geo.latlng?{x:p.lng(),y:p.lat(),z:0}:{x:setNumeric(p.x,p.longitude,p.lng,p.lon,0),y:setNumeric(p.y,p.latitude,p.lat,0),z:setNumeric(p.z,p.elevation,p.elev,p.height,0)}}},geo.util.cssColors={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074}}(),function(){"use strict";function vect(x,y){return new Vector2D(x,y)}var RangeNode=function(elem,start,end,current){this.data=elem[current],this.left=null,this.right=null,start!==current&&(this.left=new RangeNode(elem,start,current-1,parseInt((start+(current-1))/2,10))),end!==current&&(this.right=new RangeNode(elem,current+1,end,parseInt((end+(current+1))/2,10))),this.elem=elem,this.start=start,this.end=end,this.subtree=null,this.search=rangeNodeSearch},rangeNodeSearch=function(result,box){var m_this=this,xrange=function(b){return b.x_in(m_this.elem[m_this.start])&&b.x_in(m_this.elem[m_this.end])},yrange=function(b,start,end){return b.y_in(m_this.subtree[start])&&b.y_in(m_this.subtree[end])},subquery=function(result,box,start,end,current){if(yrange(box,start,end))for(var i=start;end>=i;i++)result.push(m_this.subtree[i]);else box.y_in(m_this.subtree[current])&&result.push(m_this.subtree[current]),box.y_left(m_this.subtree[current])?current!==end&&subquery(result,box,current+1,end,parseInt((end+(current+1))/2,10)):box.x_right(m_this.subtree[current])?current!==start&&subquery(result,box,start,current-1,parseInt((start+(current-1))/2,10)):(current!==end&&subquery(result,box,current+1,end,parseInt((end+(current+1))/2,10)),current!==start&&subquery(result,box,start,current-1,parseInt((start+(current-1))/2,10)))};return xrange(box)?(this.subtree||(this.subtree=this.elem.slice(this.start,this.end+1),this.subtree.sort(function(a,b){return a.y-b.y})),void subquery(result,box,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2,10))):(box.contains(this.data)&&result.push(this.data),void(box.x_left(this.data)?this.right&&this.right.search(result,box):box.x_right(this.data)?this.left&&this.left.search(result,box):(this.left&&this.left.search(result,box),this.right&&this.right.search(result,box))))},RangeTree=function(elem){elem.sort(function(a,b){return a.x-b.x}),elem.length>0?this.root=new RangeNode(elem,0,elem.length-1,parseInt((elem.length-1)/2,10)):this.root=null,this.search=function(_box){if(!this.root)return[];var box=_box.clone(),result=[];return this.root.search(result,box),result}},Box=function(v1,v2){this.min=v1.clone(),this.max=v2.clone(),this.contains=function(p){return v1.x<=p.x&&v2.x>=p.x&&v1.y<=p.y&&v2.y>=p.y},this.x_in=function(p){return v1.x<=p.x&&v2.x>=p.x},this.x_left=function(p){return v1.x>=p.x},this.x_right=function(p){return v2.x<=p.x},this.y_in=function(p){return v1.y<=p.y&&v2.y>=p.y},this.y_left=function(p){return v1.y>=p.y},this.y_right=function(p){return v2.y<=p.y},this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)},this.height=function(){return this.max.y-this.min.y},this.width=function(){return this.max.x-this.min.x},this.vertex=function(index){switch(index){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+index}},this.intersects=function(box){for(var i=0;4>i;i++)for(var j=0;4>j;j++)if(vect.intersects(this.vertex(i),this.vertex((i+1)%4),box.vertex(j),box.vertex((j+1)%4)))return!0;return this.contains(box.min)&&this.contains(box.max)&&this.contains(new vect(box.min.x,box.max.y))&&this.contains(new vect(box.max.x,box.min.y))?!0:box.contains(this.min)&&box.contains(this.max)&&box.contains(new vect(this.min.x,this.max.y))&&box.contains(new vect(this.max.x,this.min.y))?!0:!1},this.union=function(b){this.min.x=Math.min(this.min.x,b.min.x),this.min.y=Math.min(this.min.y,b.min.y),this.max.x=Math.max(this.max.x,b.max.x),this.max.y=Math.max(this.max.y,b.max.y)},this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)},this.clone=function(){return new Box(v1,v2)}},Vector2D=function(x,y){this.x=x,this.y=y,this.add=function(v){return this.x+=v.x,this.y+=v.y,this},this.sub=function(v){return this.x-=v.x,this.y-=v.y,this},this.scale=function(s){return this.x*=s,this.y*=s,this},this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(){var scale=this.length();return 0===scale?this:(this.x/=scale,this.y/=scale,this)},this.div=function(v){return this.x/=v.x,this.y/=v.y,this},this.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},this.zero=function(tol){return tol=tol||0,this.length()<=tol},this.dot=function(v){return this.x*v.x+this.y*v.y},this.cross=function(v){return this.x*v.y-this.y*v.x},this.rotate=function(omega){var cos=Math.cos(omega),sin=Math.sin(omega);return xp=cos*this.x-sin*this.y,yp=sin*this.x+cos*this.y,this.x=xp,this.y=yp,this},this.clone=function(){return new Vector2D(this.x,this.y)},this.array=function(){return[this.x,this.y]}};vect.scale=function(v,s){return v.clone().scale(s)},vect.add=function(v1,v2){return v1.clone().add(v2)},vect.sub=function(v1,v2){return v1.clone().sub(v2)},vect.dist=function(v1,v2){return v1.clone().sub(v2).length()},vect.dir=function(v1,v2){return v1.clone().sub(v2).normalize()},vect.dot=function(v1,v2){return v1.x*v2.x+v1.y*v2.y},vect.cross=function(v1,v2){return v1.x*v2.y-v1.y*v2.x},vect.left=function(a,b,c,tol){tol||(tol=0);var v1=vect.sub(b,a),v2=vect.sub(c,a);return vect.cross(v1,v2)>=-tol},vect.intersects=function(a,b,c,d,tol){return tol||(tol=0),vect.left(a,b,c,tol)!=vect.left(a,b,d,tol)&&vect.left(c,d,b,tol)!=vect.left(c,d,a,tol)},vect.intersect2dt=function(a,b,c,d){var denom=a.x*(d.y-c.y)+b.x*(c.y-d.y)+d.x*(b.y-a.y)+c.x*(a.y-b.y);if(0===denom)return 1/0;var num_t=(a.x*(d.y-c.y)+c.x*(a.y-d.y)+d.x*(c.y-a.y),-(a.x*(c.y-b.y)+b.x*(a.y-c.y)+c.x*(b.y-a.y))),t=num_t/denom;return t},vect.intersect2dpos=function(a,b,c,d){var denom=a.x*(d.y-c.y)+b.x*(c.y-d.y)+d.x*(b.y-a.y)+c.x*(a.y-b.y);if(0===denom)return 1/0;var num_s=a.x*(d.y-c.y)+c.x*(a.y-d.y)+d.x*(c.y-a.y),s=num_s/denom,dir=vect.sub(b,a);return dir.scale(s),vect.add(a,dir)},vect.rotate=function(v,omega){var cos=Math.cos(omega),sin=Math.sin(omega);xp=cos*v.x-sin*v.y,yp=sin*v.x+cos*v.y;var c=new vect(xp,yp);return c},vect.normalize=function(v){return v.clone().normalize()},geo.util.RangeTree=RangeTree,geo.util.Box=Box,geo.util.vect=vect}(),geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var m_this=this,m_eventHandlers={},m_idleHandlers=[],m_deferredCount=0;return this.onIdle=function(handler){return m_deferredCount?m_idleHandlers.push(handler):handler(),m_this},this.addDeferred=function(defer){return m_deferredCount+=1,defer.done(function(){m_deferredCount-=1,m_deferredCount||m_idleHandlers.splice(0,m_idleHandlers.length).forEach(function(handler){handler()})}),m_this},this.geoOn=function(event,handler){return Array.isArray(event)?(event.forEach(function(e){m_this.geoOn(e,handler)}),m_this):(m_eventHandlers.hasOwnProperty(event)||(m_eventHandlers[event]=[]),m_eventHandlers[event].push(handler),m_this)},this.geoTrigger=function(event,args){return Array.isArray(event)?(event.forEach(function(e){m_this.geoTrigger(e,args)}),m_this):(m_eventHandlers.hasOwnProperty(event)&&m_eventHandlers[event].forEach(function(handler){handler.call(m_this,args)}),m_this)},this.geoOff=function(event,arg){if(void 0===event&&(m_eventHandlers={},m_idleHandlers=[],m_deferredCount=0),Array.isArray(event))return event.forEach(function(e){m_this.geoOff(e,arg)}),m_this;if(arg){if(Array.isArray(arg))return arg.forEach(function(handler){m_this.geoOff(event,handler)}),m_this}else m_eventHandlers[event]=[];return m_eventHandlers.hasOwnProperty(event)&&(m_eventHandlers[event]=m_eventHandlers[event].filter(function(f){return f!==arg})),m_this},this._exit=function(){m_this.geoOff()},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(arg){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,arg);var m_this=this,m_parent=null,m_children=[],s_exit=this._exit,s_trigger=this.geoTrigger,s_addDeferred=this.addDeferred,s_onIdle=this.onIdle;return this.addDeferred=function(defer){m_parent?m_parent.addDeferred(defer):s_addDeferred(defer)},this.onIdle=function(handler){m_parent?m_parent.onIdle(handler):s_onIdle(handler)},this.parent=function(arg){return void 0===arg?m_parent:(m_parent=arg,m_this)},this.addChild=function(child){return Array.isArray(child)?(child.forEach(m_this.addChild),m_this):(child.parent(m_this),m_children.push(child),m_this)},this.removeChild=function(child){return Array.isArray(child)?(child.forEach(m_this.removeChild),m_this):(m_children=m_children.filter(function(c){return c!==child}),m_this)},this.children=function(){return m_children.slice()},this.draw=function(arg){return m_this.children().forEach(function(child){child.draw(arg)}),m_this},this.geoTrigger=function(event,args,childrenOnly){var geoArgs;return args=args||{},geoArgs=args.geo||{},args.geo=geoArgs,geoArgs.stopPropagation?m_this:!childrenOnly&&m_parent&&geoArgs._triggeredBy!==m_parent?(geoArgs._triggeredBy=m_this,m_parent.geoTrigger(event,args),m_this):(s_trigger.call(m_this,event,args),geoArgs.stopPropagation?m_this:(m_children.forEach(function(child){geoArgs._triggeredBy=m_this,child.geoTrigger(event,args)}),m_this))},this._exit=function(){m_this.children=[],delete m_this.parent,s_exit()},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(x,y,z){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(x,y,z);if(x=vgl.defaultValue(x,0),y=vgl.defaultValue(y,0),z=vgl.defaultValue(z,0),0>x||0>y||0>z)return console.log("[error] Al radii components must be greater than zero");var m_this=this,m_radii=new vec3.fromValues(x,y,z),m_radiiSquared=new vec3.fromValues(x*x,y*y,z*z),m_minimumRadius=Math.min(x,y,z),m_maximumRadius=Math.max(x,y,z);return this.radii=function(){return m_radii},this.radiiSquared=function(){return m_radiiSquared},this.maximumRadius=function(){return m_maximumRadius},this.minimumRadius=function(){return m_minimumRadius},this.computeGeodeticSurfaceNormal=function(lat,lon){if("undefined"==typeof lat||"undefined"==typeof lon)throw"[error] Valid latitude and longitude is required";var cosLatitude=Math.cos(lat),result=vec3.create();return result[0]=cosLatitude*Math.cos(lon),result[1]=cosLatitude*Math.sin(lon),result[2]=Math.sin(lat),vec3.normalize(result,result),result},this.transformPoint=function(lat,lon,elev){lat*=Math.PI/180,lon*=Math.PI/180;var n=m_this.computeGeodeticSurfaceNormal(lat,lon),k=vec3.create(),gamma=Math.sqrt(vec3.dot(n,k)),result=vec3.create();return vec3.multiply(k,m_radiiSquared,n),vec3.scale(k,k,1/gamma),vec3.scale(n,n,elev),vec3.add(result,n,k),result},this.transformGeometry=function(geom){if(!geom)throw"[error] Failed to transform to cartesian. Invalid geometry.";var sourceData=geom.sourceData(vgl.vertexAttributeKeys.Position),sourceDataArray=sourceData.data(),noOfComponents=sourceData.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),stride=sourceData.attributeStride(vgl.vertexAttributeKeys.Position),offset=sourceData.attributeOffset(vgl.vertexAttributeKeys.Position),sizeOfDataType=sourceData.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),index=null,count=sourceDataArray.length*(1/noOfComponents),gamma=null,n=null,j=0,k=vec3.create(),result=vec3.create();if(stride/=sizeOfDataType,offset/=sizeOfDataType,3!==noOfComponents)throw"[error] Requires positions with three components";for(j=0;count>j;j+=1)index=j*stride+offset,sourceDataArray[index]=sourceDataArray[index]*(Math.PI/180),sourceDataArray[index+1]=sourceDataArray[index+1]*(Math.PI/180),n=m_this.computeGeodeticSurfaceNormal(sourceDataArray[index+1],sourceDataArray[index]),vec3.multiply(k,m_radiiSquared,n),gamma=Math.sqrt(vec3.dot(n,k)),vec3.scale(k,k,1/gamma),vec3.scale(n,n,sourceDataArray[index+2]),vec3.add(result,n,k),sourceDataArray[index]=result[0],sourceDataArray[index+1]=result[1],sourceDataArray[index+2]=result[2]},m_this},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(spherical){"use strict";var r_minor;return spherical=void 0!==spherical?spherical:!1,r_minor=spherical?6378137:6356752.314245179},geo.mercator.f=function(spherical){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(spherical))/geo.mercator.r_major},geo.mercator.long2tilex=function(lon,z){"use strict";var rad=(lon+180)/360,f=Math.floor(rad*Math.pow(2,z));return f},geo.mercator.lat2tiley=function(lat,z){"use strict";var rad=lat*Math.PI/180;return Math.floor((1-rad/Math.PI)/2*Math.pow(2,z))},geo.mercator.long2tilex2=function(lon,z){"use strict";var rad=(lon+180)/360,f=rad*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.lat2tiley2=function(lat,z){"use strict";var rad=lat*Math.PI/180,f=(1-Math.log(Math.tan(rad)+1/Math.cos(rad))/Math.PI)/2*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.tilex2long=function(x,z){"use strict";return x/Math.pow(2,z)*360-180},geo.mercator.tiley2lat=function(y,z){"use strict";var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},geo.mercator.y2lat=function(a){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(a*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(a){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+a*(Math.PI/180)/2))},geo.mercator.deg2rad=function(d){"use strict";var r=d*(Math.PI/180);return r},geo.mercator.rad2deg=function(r){"use strict";var d=r/(Math.PI/180);return d},geo.mercator.ll2m=function(lon,lat,spherical){"use strict";lat>89.5&&(lat=89.5),-89.5>lat&&(lat=-89.5);var x=this.r_major*this.deg2rad(lon),temp=this.r_minor(spherical)/this.r_major,es=1-temp*temp,eccent=Math.sqrt(es),phi=this.deg2rad(lat),sinphi=Math.sin(phi),con=eccent*sinphi,com=.5*eccent,con2=Math.pow((1-con)/(1+con),com),ts=Math.tan(.5*(.5*Math.PI-phi))/con2,y=-this.r_major*Math.log(ts),ret={x:x,y:y};return ret},geo.mercator.m2ll=function(x,y,spherical){"use strict";var lon=this.rad2deg(x/this.r_major),temp=this.r_minor(spherical)/this.r_major,e=Math.sqrt(1-temp*temp),lat=this.rad2deg(this.pjPhi2(Math.exp(-(y/this.r_major)),e)),ret={lon:lon,lat:lat};return ret},geo.mercator.pjPhi2=function(ts,e){"use strict";var con,dphi,N_ITER=15,HALFPI=Math.PI/2,TOL=1e-10,i=N_ITER,eccnth=.5*e,Phi=HALFPI-2*Math.atan(ts);do con=e*Math.sin(Phi),dphi=HALFPI-2*Math.atan(ts*Math.pow((1-con)/(1+con),eccnth))-Phi,Phi+=dphi,i-=1;while(Math.abs(dphi)>TOL&&i);return Phi},geo.latlng=function(arg1,arg2,arg3){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(arg1,arg2,arg3);var m_this=this,m_lat=void 0===arg2&&void 0===arg3?arg1.lat():arg1,m_lng=void 0===arg2&&void 0===arg3?arg1.lng():arg2,m_elv=void 0===arg2&&void 0===arg3?arg1.elv():arg3;return this.lat=function(val){return void 0===val?m_lat:void(m_lat=val)},this.lng=function(val){return void 0===val?m_lng:void(m_lng=val)},this.elv=function(val){return void 0===val?m_elv:void(m_elv=val)},this.x=function(val){return void 0===val?m_this.lng():void(m_lng=val)},this.y=function(val){return void 0===val?m_this.lat():void(m_lat=val)},this.z=function(val){return void 0===val?m_this.elv():void(m_elv=val)},this},geo.layer=function(arg){"use strict";if(!(this instanceof geo.layer))return new geo.layer(arg);arg=arg||{},geo.sceneObject.call(this,arg);var m_this=this,s_exit=this._exit,m_style=void 0===arg.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:arg.style,m_id=void 0===arg.id?geo.layer.newLayerId():arg.id,m_name="",m_gcs="EPSG:4326",m_timeRange=null,m_source=arg.source||null,m_map=void 0===arg.map?null:arg.map,m_isReference=!1,m_x=0,m_y=0,m_width=0,m_height=0,m_node=null,m_canvas=null,m_renderer=null,m_initialized=!1,m_rendererName=void 0===arg.renderer?"vgl":arg.renderer,m_dataTime=geo.timestamp(),m_updateTime=geo.timestamp(),m_drawTime=geo.timestamp(),m_sticky=void 0===arg.sticky?!0:arg.sticky,m_active=void 0===arg.active?!0:arg.active;return this.sticky=function(){return m_sticky},this.active=function(){return m_active},this.node=function(){return m_node},this.id=function(val){return void 0===val?m_id:(m_id=geo.newLayerId(),m_this.modified(),m_this)},this.name=function(val){return void 0===val?m_name:(m_name=val,m_this.modified(),m_this)},this.opacity=function(val){return void 0===val?m_style.opacity:(m_style.opacity=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_style.visible:(m_style.visible=val,m_this.modified(),m_this)},this.bin=function(val){return void 0===val?m_style.bin:(m_style.bin=val,m_this.modified(),m_this)},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.transform=function(val){return geo.transform.transformLayer(val,m_this,m_map.baseLayer()),m_this},this.timeRange=function(val){return void 0===val?m_timeRange:(m_timeRange=val,m_this.modified(),m_this)},this.source=function(val){return void 0===val?m_source:(m_source=val,m_this.modified(),m_this)},this.map=function(val){return void 0===val?m_map:(m_map=val,m_map.node().append(m_node),m_this.modified(),m_this)},this.renderer=function(){return m_renderer},this.canvas=function(){return m_canvas},this.viewport=function(){return[m_x,m_y,m_width,m_height]},this.dataTime=function(){return m_dataTime},this.updateTime=function(){return m_updateTime},this.drawTime=function(){return m_drawTime},this.query=function(){},this.referenceLayer=function(val){return void 0!==val?(m_isReference=val,m_this.modified(),m_this):m_isReference},this.initialized=function(val){return void 0!==val?(m_initialized=val,m_this):m_initialized},this.toLocal=function(input){return input},this.fromLocal=function(input){return input},this._init=function(){return m_initialized?m_this:(m_node=$(document.createElement("div")),m_node.attr("id",m_name),m_node.css("position","absolute"),m_map&&m_map.node().append(m_node),m_canvas?m_renderer=geo.createRenderer(m_rendererName,m_this,m_canvas):(m_renderer=geo.createRenderer(m_rendererName,m_this),m_canvas=m_renderer.canvas()),m_this.active()||m_node.css("pointerEvents","none"),m_initialized=!0,m_this)},this._exit=function(){m_renderer._exit(),m_node.off(),m_node.remove(),m_node=null,arg={},m_canvas=null,m_renderer=null,s_exit()},this._update=function(){},this._resize=function(x,y,w,h){return m_x=x,m_y=y,m_width=w,m_height=h,m_node.width(w),m_node.height(h),m_this.modified(),m_this.geoTrigger(geo.event.resize,{x:x,y:y,width:m_width,height:m_height}),m_this},this.width=function(){return m_width},this.height=function(){return m_height},this},geo.layer.newLayerId=function(){"use strict";var currentId=1;return function(){var id=currentId;return currentId+=1,id}}(),geo.layer.create=function(map,spec){"use strict";if(spec=spec||{},spec.type="feature","feature"!==spec.type)return console.warn("Unsupported layer type"),null;if(spec.renderer=spec.renderer||"vgl","d3"!==spec.renderer&&"vgl"!==spec.renderer)return console.warn("Invalid renderer"),null;var layer=map.createLayer(spec.type,spec);return layer?(spec.features.forEach(function(f){f.data=f.data||spec.data,f.feature=geo.feature.create(layer,f)}),layer):(console.warn("Unable to create a layer"),null)},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(arg){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(arg);geo.layer.call(this,arg);var m_this=this,m_features=[],s_init=this._init,s_exit=this._exit,s_update=this._update,s_draw=this.draw;return this.createFeature=function(featureName,arg){var newFeature=geo.createFeature(featureName,m_this,m_this.renderer(),arg);return m_this.addChild(newFeature),m_features.push(newFeature),m_this.features(m_features),m_this.modified(),newFeature},this.deleteFeature=function(feature){var i;for(i=0;i<m_features.length;i+=1)m_features[i]===feature&&(m_features[i]._exit(),m_this.dataTime().modified(),m_this.modified(),m_features.splice(i,1));return m_this.removeChild(feature),m_this},this.features=function(val){return void 0===val?m_features:(m_features=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.geoOn(geo.event.resize,function(event){m_this.renderer()._resize(event.x,event.y,event.width,event.height),m_this._update({}),m_this.renderer()._render()}),m_this.geoOn(geo.event.pan,function(event){m_this._update({event:event}),m_this.renderer()._render()}),m_this.geoOn(geo.event.zoom,function(event){m_this._update({event:event}),m_this.renderer()._render()}),m_this)},this._update=function(request){var i;if(!m_features.length)return m_this;if(s_update.call(m_this,request),!m_this.source()&&m_features&&0===m_features.length)return void console.log("[info] No valid data source found.");if(m_this.dataTime().getMTime()>m_this.updateTime().getMTime())for(i=0;i<m_features.length;i+=1)m_features[i].renderer(m_this.renderer());for(i=0;i<m_features.length;i+=1)m_features[i]._update();return m_this.updateTime().modified(),m_this},this._exit=function(){m_this.clear(),s_exit()},this.draw=function(){return s_draw(),m_this.renderer()._render(),m_this},this.clear=function(){var i;if(!m_features.length)return m_this;for(i=0;i<m_features.length;i+=1)m_features[i]._exit(),m_this.removeChild(m_features[i]);return m_this.dataTime().modified(),m_this.modified(),m_features=[],m_this},m_this},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event={},geo.event.layerAdd="geo_layerAdd",geo.event.layerRemove="geo_layerRemove",geo.event.zoom="geo_zoom",geo.event.pan="geo_pan",geo.event.resize="geo_resize",geo.event.draw="geo_draw",geo.event.drawEnd="geo_drawEnd",geo.event.mousemove="geo_mousemove",geo.event.mouseclick="geo_mouseclick",geo.event.brush="geo_brush",geo.event.brushend="geo_brushend",geo.event.brushstart="geo_brushstart",geo.event.transitionstart="geo_transitionstart",geo.event.transitionend="geo_transitionend",geo.event.clock={play:"geo_clock_play",stop:"geo_clock_stop",pause:"geo_clock_pause",change:"geo_clock_change"},geo.event.feature={mousemove:"geo_feature_mousemove",mouseover:"geo_feature_mouseover",mouseout:"geo_feature_mouseout",mouseon:"geo_feature_mouseon",mouseoff:"geo_feature_mouseoff",mouseclick:"geo_feature_mouseclick",brushend:"geo_feature_brushend",brush:"geo_feature_brush"},geo.mapInteractor=function(args){"use strict";function eventMatch(button,modifiers){return("wheel"===button||m_mouse.buttons[button])&&!!m_mouse.modifiers.alt==!!modifiers.alt&&!!m_mouse.modifiers.meta==!!modifiers.meta&&!!m_mouse.modifiers.shift==!!modifiers.shift&&!!m_mouse.modifiers.ctrl==!!modifiers.ctrl}function calcSpeed(v){var x=v.x,y=v.y;return Math.sqrt(x*x+y*y)}function doRespond(){return m_disableThrottle?!0:m_wait?!1:(m_wait=!0,window.setTimeout(function(){m_wait=!1,m_wheelQueue={x:0,y:0}},m_throttleTime),!0)}function modifyVelocity(v,deltaT){deltaT=0>=deltaT?30:deltaT;var sf=springForce(),speed=calcSpeed(v),vx=v.x/speed,vy=v.y/speed;return speed*=Math.exp(-m_options.momentum.drag*deltaT),calcSpeed(sf)*deltaT+speed<m_options.momentum.minSpeed?null:(speed>0?(vx*=speed,vy*=speed):(vx=0,vy=0),{x:vx-sf.x*deltaT,y:vy-sf.y*deltaT})}function springForce(){var xplus,xminus,yplus,yminus;if(!m_options.spring.enabled)return{x:0,y:0};var ul=m_this.map().gcsToDisplay({x:-180,y:82}),lr=m_this.map().gcsToDisplay({x:180,y:-82}),c=m_options.spring.springConstant,width=m_this.map().node().width(),height=m_this.map().node().height();return xplus=c*Math.max(0,ul.x),xminus=c*Math.max(0,width-lr.x),yplus=c*Math.max(0,ul.y)/2,yminus=c*Math.max(0,height-lr.y)/2,{x:xplus-xminus,y:yplus-yminus}}if(!(this instanceof geo.mapInteractor))return new geo.mapInteractor(args);geo.object.call(this);var m_mouse,m_keyboard,m_state,$node,m_options=args||{},m_this=this,m_wheelQueue={x:0,y:0},m_throttleTime=10,m_wait=!1,m_disableThrottle=!0,m_selectionLayer=null,m_selectionPlane=null;return m_options=$.extend(!0,{panMoveButton:"left",panMoveModifiers:{},zoomMoveButton:"right",zoomMoveModifiers:{},panWheelEnabled:!1,panWheelModifiers:{},zoomWheelEnabled:!0,zoomWheelModifiers:{},wheelScaleX:1,wheelScaleY:1,zoomScale:1,selectionButton:"left",selectionModifiers:{shift:!0},momentum:{enabled:!0,maxSpeed:2.5,minSpeed:.01,drag:.01},spring:{enabled:!1,springConstant:5e-5}},m_options),m_mouse={page:{x:0,y:0},map:{x:0,y:0},buttons:{left:!1,right:!1,middle:!1},modifiers:{alt:!1,ctrl:!1,shift:!1,meta:!1},time:new Date,deltaTime:1,velocity:{x:0,y:0}},m_keyboard={},m_state={},this._connectEvents=function(){return m_options.map?(m_this._disconnectEvents(),$node=$(m_options.map.node()),$node.on("mousemove.geojs",m_this._handleMouseMove),$node.on("mousedown.geojs",m_this._handleMouseDown),$node.on("mouseup.geojs",m_this._handleMouseUp),$node.on("wheel.geojs",m_this._handleMouseWheel),("right"===m_options.panMoveButton||"right"===m_options.zoomMoveButton)&&$node.on("contextmenu.geojs",function(){return!1}),m_this):m_this},this._disconnectEvents=function(){return $node&&($node.off(".geojs"),$node=null),m_this},this.map=function(val){return void 0!==val?(m_options.map=val,m_this._connectEvents(),m_this):m_options.map},this.options=function(opts){return void 0===opts?$.extend({},m_options):($.extend(m_options,opts),m_this)},this._getMousePosition=function(evt){
var dt,t,offset=$node.offset();t=(new Date).valueOf(),dt=t-m_mouse.time,m_mouse.time=t,m_mouse.deltaTime=dt,m_mouse.velocity={x:(evt.pageX-m_mouse.page.x)/dt,y:(evt.pageY-m_mouse.page.y)/dt},m_mouse.page={x:evt.pageX,y:evt.pageY},m_mouse.map={x:evt.pageX-offset.left,y:evt.pageY-offset.top};try{m_mouse.geo=m_this.map().displayToGcs(m_mouse.map)}catch(e){m_mouse.geo=null}},this._getMouseButton=function(evt){1===evt.which?m_mouse.buttons.left="mouseup"!==evt.type:3===evt.which?m_mouse.buttons.right="mouseup"!==evt.type:2===evt.which&&(m_mouse.buttons.middle="mouseup"!==evt.type)},this._getMouseModifiers=function(evt){m_mouse.modifiers.alt=evt.altKey,m_mouse.modifiers.ctrl=evt.ctrlKey,m_mouse.modifiers.meta=evt.metaKey,m_mouse.modifiers.shift=evt.shiftKey},this._getSelection=function(){var origin=m_state.origin,mouse=m_this.mouse(),map=m_this.map(),display={},gcs={};return display.upperLeft={x:Math.min(origin.map.x,mouse.map.x),y:Math.min(origin.map.y,mouse.map.y)},display.lowerRight={x:Math.max(origin.map.x,mouse.map.x),y:Math.max(origin.map.y,mouse.map.y)},display.upperRight={x:display.lowerRight.x,y:display.upperLeft.y},display.lowerLeft={x:display.upperLeft.x,y:display.lowerRight.y},gcs.upperLeft=map.displayToGcs(display.upperLeft),gcs.lowerRight=map.displayToGcs(display.lowerRight),gcs.upperRight=map.displayToGcs(display.upperRight),gcs.lowerLeft=map.displayToGcs(display.lowerLeft),m_selectionPlane.origin([display.lowerLeft.x,display.lowerLeft.y,0]),m_selectionPlane.upperLeft([display.upperLeft.x,display.upperLeft.y,0]),m_selectionPlane.lowerRight([display.lowerRight.x,display.lowerRight.y,0]),m_selectionPlane.draw(),{display:display,gcs:gcs,mouse:mouse,origin:$.extend({},m_state.origin)}},this.cancel=function(action){var out;return out=action?m_state.action===action:!!m_state.action,out&&(m_state={}),out},this._handleMouseDown=function(evt){var action=null;"momentum"===m_state.action&&(m_state={}),m_this._getMousePosition(evt),m_this._getMouseButton(evt),m_this._getMouseModifiers(evt),eventMatch(m_options.panMoveButton,m_options.panMoveModifiers)?action="pan":eventMatch(m_options.zoomMoveButton,m_options.zoomMoveModifiers)?action="zoom":eventMatch(m_options.selectionButton,m_options.selectionModifiers)&&(action="select"),m_mouse.velocity={x:0,y:0},action&&(m_state={action:action,origin:$.extend(!0,{},m_mouse),delta:{x:0,y:0}},"select"===action&&(m_selectionLayer&&(m_selectionLayer.clear(),m_this.map().deleteLayer(m_selectionLayer),m_selectionLayer=null),m_selectionLayer=m_this.map().createLayer("feature",{renderer:"d3"}),m_selectionPlane=m_selectionLayer.createFeature("plane"),m_selectionPlane.style({screenCoordinates:!0,fillOpacity:function(){return.25}}),m_this.map().geoTrigger(geo.event.brushstart,m_this._getSelection())),$(document).on("mousemove.geojs",m_this._handleMouseMoveDocument),$(document).on("mouseup.geojs",m_this._handleMouseUpDocument))},this._handleMouseMove=function(evt){m_state.action||(m_this._getMousePosition(evt),m_this._getMouseButton(evt),m_this._getMouseModifiers(evt),m_this.map().geoTrigger(geo.event.mousemove,m_this.mouse()))},this._handleMouseMoveDocument=function(evt){var dx,dy,selectionObj;return m_this._getMousePosition(evt),m_this._getMouseButton(evt),m_this._getMouseModifiers(evt),m_state.action?void(doRespond()&&(dx=m_mouse.map.x-m_state.origin.map.x-m_state.delta.x,dy=m_mouse.map.y-m_state.origin.map.y-m_state.delta.y,m_state.delta.x+=dx,m_state.delta.y+=dy,"pan"===m_state.action?m_this.map().pan({x:dx,y:dy}):"zoom"===m_state.action?m_this.map().zoom(m_this.map().zoom()-dy*m_options.zoomScale/120):"select"===m_state.action&&(selectionObj=m_this._getSelection(),m_this.map().geoTrigger(geo.event.brush,selectionObj)),evt.preventDefault())):void console.log("WARNING: Invalid state in mapInteractor.")},this._handleMouseUpDocument=function(evt){var selectionObj,oldAction;m_this._getMouseButton(evt),m_this._getMouseModifiers(evt),$(document).off(".geojs"),m_mouse.buttons.right&&evt.preventDefault(),"select"===m_state.action&&(selectionObj=m_this._getSelection(),m_selectionLayer.clear(),m_this.map().deleteLayer(m_selectionLayer),m_selectionLayer=null,m_selectionPlane=null,m_this.map().geoTrigger(geo.event.brushend,selectionObj)),oldAction=m_state.action,m_state={},m_options.momentum.enabled&&"pan"===oldAction&&m_this.springBack(!0)},this._handleMouseUp=function(evt){m_this._getMouseButton(evt),m_this._getMouseModifiers(evt),m_this.map().geoTrigger(geo.event.mouseclick,m_this.mouse())},this._handleMouseWheel=function(evt){var zoomFactor,direction;return evt.deltaFactor=1,1===evt.originalEvent.deltaMode?evt.deltaFactor=12:2===evt.originalEvent.deltaMode&&(evt.deltaFactor=$(window).height()),evt.deltaX=evt.originalEvent.deltaX||0,evt.deltaY=evt.originalEvent.deltaY||0,m_this._getMouseModifiers(evt),evt.deltaX=evt.deltaX*m_options.wheelScaleX*evt.deltaFactor/120,evt.deltaY=evt.deltaY*m_options.wheelScaleY*evt.deltaFactor/120,evt.preventDefault(),doRespond()?(evt.deltaX+=m_wheelQueue.x,evt.deltaY+=m_wheelQueue.y,m_wheelQueue={x:0,y:0},void(m_options.panWheelEnabled&&eventMatch("wheel",m_options.panWheelModifiers)?m_this.map().pan({x:evt.deltaX,y:-evt.deltaY}):m_options.zoomWheelEnabled&&eventMatch("wheel",m_options.zoomWheelModifiers)&&(zoomFactor=-evt.deltaY,direction=m_mouse.map,m_this.map().zoom(m_this.map().zoom()+zoomFactor,direction)))):(m_wheelQueue.x+=evt.deltaX,void(m_wheelQueue.y+=evt.deltaY))},this.springBack=function(initialVelocity){"momentum"!==m_state.action&&(initialVelocity||(m_mouse.velocity={x:0,y:0}),m_state.action="momentum",m_state.origin=m_this.mouse(),m_state.start=new Date,m_state.handler=function(){var v,s,last,dt;if(dt=Math.min(m_mouse.deltaTime,30),"momentum"===m_state.action&&m_this.map()&&!m_this.map().transition()){if(last=m_state.start.valueOf(),m_state.start=new Date,v=modifyVelocity(m_mouse.velocity,m_state.start-last),!v)return void(m_state={});s=calcSpeed(v),s>m_options.momentum.maxSpeed&&(s=m_options.momentum.maxSpeed/s,v.x=v.x*s,v.y=v.y*s),isFinite(v.x)&&isFinite(v.y)||(v.x=0,v.y=0),m_mouse.velocity.x=v.x,m_mouse.velocity.y=v.y,m_this.map().pan({x:m_mouse.velocity.x*dt,y:m_mouse.velocity.y*dt}),m_state.handler&&window.requestAnimationFrame(m_state.handler)}},m_state.handler&&window.requestAnimationFrame(m_state.handler))},this._handleDoubleClick=function(){},this.destroy=function(){m_this._disconnectEvents(),m_this.map(null)},this.mouse=function(){return $.extend(!0,{},m_mouse)},this.keyboard=function(){return $.extend(!0,{},m_keyboard)},this.state=function(){return $.extend(!0,{},m_state)},this.simulateEvent=function(type,options){var evt,page,offset,which;return m_this.map()?(page=options.page||{},options.map&&(offset=$node.offset(),page.x=options.map.x+offset.left,page.y=options.map.y+offset.top),"left"===options.button?which=1:"right"===options.button?which=3:"middle"===options.button&&(which=2),options.modifiers=options.modifiers||[],options.wheelDelta=options.wheelDelta||{},evt=$.Event(type,{pageX:page.x,pageY:page.y,which:which,altKey:options.modifiers.indexOf("alt")>=0,ctrlKey:options.modifiers.indexOf("ctrl")>=0,metaKey:options.modifiers.indexOf("meta")>=0,shiftKey:options.modifiers.indexOf("shift")>=0,originalEvent:{deltaX:options.wheelDelta.x,deltaY:options.wheelDelta.y,deltaMode:options.wheelMode}}),void $node.trigger(evt)):m_this},this._connectEvents(),this},inherit(geo.mapInteractor,geo.object),geo.clock=function(opts){"use strict";if(!(this instanceof geo.clock))return new geo.clock(opts);opts=opts||{},geo.object.call(this,opts);var m_this=this,m_now=new Date(0),m_start=null,m_end=null,m_step=null,m_rate=null,m_loop=Number.POSITIVE_INFINITY,m_currentLoop=0,m_state="stop",m_currentAnimation=null,m_object=null;this.object=function(arg){return void 0===arg?m_object:(m_object=arg,m_this)},this._attached=function(){return m_object instanceof geo.object},this.now=function(arg){var previous=m_now;return void 0===arg?m_now:(m_now=arg,m_now!==previous&&m_this._attached()&&m_this.object().geoTrigger(geo.event.clock.change,{previous:previous,current:m_now,clock:m_this}),m_this)},this.start=function(arg){return void 0===arg?m_start:(m_start=arg,m_this)},this.end=function(arg){return void 0===arg?m_end:(m_end=arg,m_this)},this.step=function(arg){return void 0===arg?m_step:(m_step=arg,m_this)},this.loop=function(arg){return void 0===arg?m_loop:(m_loop=arg,m_this)},this.state=function(arg,step){return void 0===arg?m_state:["stop","play","pause"].indexOf(arg)<0?(console.log("WARNING: Ignored invalid state: "+arg),m_this):("play"===arg&&"stop"===m_state&&(m_currentLoop=0,m_this.now(m_this.start())),"play"===arg&&"play"!==m_state&&(m_state=arg,m_this._animate(step||1)),m_state=arg,m_this)},this.framerate=function(arg){return void 0===arg?m_rate:(m_rate=arg,m_this)},this.stepForward=function(){return m_this.state("pause"),m_this._setNextFrame(1),m_this},this.stepBackward=function(){return m_this.state("pause"),m_this._setNextFrame(-1),m_this},this._setNextFrame=function(step){var next=new Date(m_this.now().valueOf()+step*m_this.step());return next>=m_this.end()||next<=m_this.start()?m_this.loop()<=m_currentLoop?void m_this.state("stop"):(m_currentLoop+=1,void m_this.now(step>=0?m_this.start():m_this.end())):void m_this.now(next)},this._animate=function(step){function frame(){myAnimation===m_currentAnimation&&(m_this._setNextFrame(step),"play"===m_this.state()?m_this.framerate()?window.setTimeout(frame,1e3/m_this.framerate()):window.requestAnimationFrame(frame):m_this._attached()&&m_this.object().geoTrigger(geo.event.clock[m_this.state()],{current:m_this.now(),clock:m_this}))}var myAnimation={};m_currentAnimation=myAnimation,m_this._attached()&&m_this.object().geoTrigger(geo.event.clock.play,{current:m_this.now(),clock:m_this}),m_this.framerate()?window.setTimeout(frame,1e3/m_this.framerate()):window.requestAnimationFrame(frame)}},inherit(geo.clock,geo.object),geo.fileReader=function(arg){"use strict";function newFileReader(done,progress){var reader=new FileReader;return progress&&(reader.onprogress=progress),reader.onloadend=function(){reader.result||done(reader.error),done(reader.result)},reader}if(!(this instanceof geo.fileReader))return new geo.fileReader(arg);if(geo.object.call(this),arg=arg||{},!(arg.layer instanceof geo.featureLayer))throw"fileReader must be given a feature layer";var m_layer=arg.layer;return this.layer=function(){return m_layer},this.canRead=function(){return!1},this.read=function(file,done){done(!1)},this._getString=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this._getArrayBuffer=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this},inherit(geo.fileReader,geo.object),geo.jsonReader=function(arg){"use strict";if(!(this instanceof geo.jsonReader))return new geo.jsonReader(arg);var m_this=this,m_style=arg.style||{};m_style=$.extend({strokeWidth:2,strokeColor:{r:0,g:0,b:0},strokeOpacity:1,fillColor:{r:1,g:0,b:0},fillOpacity:1},m_style),geo.fileReader.call(this,arg),this.canRead=function(file){if(file instanceof File)return"application/json"===file.type||file.name.match(/\.json$/);if("string"==typeof file){try{JSON.parse(file)}catch(e){return!1}return!0}try{if(Array.isArray(m_this._featureArray(file)))return!0}catch(e){}return!1},this._readObject=function(file,done,progress){function onDone(fileString){"string"!=typeof fileString&&done(!1);try{object=JSON.parse(fileString),done(object)}catch(e){object||$.ajax({type:"GET",url:fileString,dataType:"text"}).done(function(data){object=JSON.parse(data),done(object)}).fail(function(){done(!1)})}}var object;file instanceof File?m_this._getString(file,onDone,progress):"string"==typeof file?onDone(file):done(file)},this._featureArray=function(spec){if("FeatureCollection"===spec.type)return spec.features||[];if("GeometryCollection"===spec.type)throw"GeometryCollection not yet implemented.";if(Array.isArray(spec.coordinates))return spec;throw"Unsupported collection type: "+spec.type},this._featureType=function(spec){var geometry=spec.geometry||{};return"Point"===geometry.type||"MultiPoint"===geometry.type?"point":"LineString"===geometry.type?"line":"Polygon"===geometry.type?"polygon":null},this._getCoordinates=function(spec){var elv,geometry=spec.geometry||{},coordinates=geometry.coordinates||[];return(2===coordinates.length||3===coordinates.length)&&isFinite(coordinates[0])&&isFinite(coordinates[1])?(isFinite(coordinates[2])&&(elv=coordinates[2]),[{x:coordinates[0],y:coordinates[1],z:elv}]):(Array.isArray(coordinates[0][0])&&(coordinates=coordinates[0]),coordinates.map(function(c){return{x:c[0],y:c[1],z:c[2]}}))},this._getStyle=function(spec){return spec.properties},this.read=function(file,done,progress){function _done(object){var features,allFeatures=[];features=m_this._featureArray(object),features.forEach(function(feature){var type=m_this._featureType(feature),coordinates=m_this._getCoordinates(feature),style=m_this._getStyle(feature);type?"line"===type?(style.fill=style.fill||!1,allFeatures.push(m_this._addFeature(type,[coordinates],style,feature.properties))):"point"===type?(style.stroke=style.stroke||!1,allFeatures.push(m_this._addFeature(type,coordinates,style,feature.properties))):"polygon"===type&&(style.fill=void 0===style.fill?!0:style.fill,style.fillOpacity=void 0===style.fillOpacity?.25:style.fillOpacity,allFeatures.push(m_this._addFeature("line",[coordinates],style,feature.properties))):console.log("unsupported feature type: "+feature.geometry.type)}),done&&done(allFeatures)}m_this._readObject(file,_done,progress)},this._buildData=function(coordinates,properties,style){return coordinates.map(function(coord){return{coordinates:coord,properties:properties,style:style}})},this._addFeature=function(type,coordinates,style,properties){var _style=$.extend({},m_style,style),feature=m_this.layer().createFeature(type).data(m_this._buildData(coordinates,properties,style)).style(_style);return"line"===type?feature.line(function(d){return d.coordinates}):feature.position(function(d){return d.coordinates}),feature}},inherit(geo.jsonReader,geo.fileReader),geo.registerFileReader("jsonReader",geo.jsonReader),geo.map=function(arg){"use strict";function resizeSelf(){m_this.resize(0,0,m_node.width(),m_node.height())}if(!(this instanceof geo.map))return new geo.map(arg);arg=arg||{},geo.sceneObject.call(this,arg),arg.layers=void 0===arg.layers?[]:arg.layers;var m_this=this,s_exit=this._exit,m_x=0,m_y=0,m_node=$(arg.node),m_width=arg.width||m_node.width(),m_height=arg.height||m_node.height(),m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_uigcs=void 0===arg.uigcs?"EPSG:4326":arg.uigcs,m_center={x:0,y:0},m_zoom=void 0===arg.zoom?1:arg.zoom,m_baseLayer=null,m_fileReader=null,m_interactor=null,m_validZoomRange={min:0,max:16},m_transition=null,m_queuedTransition=null,m_clock=null,m_bounds={};return arg.center=geo.util.normalizeCoordinates(arg.center),arg.autoResize=void 0===arg.autoResize?!0:arg.autoResize,arg.clampBounds=void 0===arg.clampBounds?!0:arg.clampBounds,this.gcs=function(arg){return void 0===arg?m_gcs:(m_gcs=arg,m_this)},this.uigcs=function(){return m_uigcs},this.node=function(){return m_node},this.zoom=function(val,direction){var base,evt,recenter=!1;return void 0===val?m_zoom:(val=Math.min(m_validZoomRange.max,Math.max(val,m_validZoomRange.min)),val===m_zoom?m_this:(base=m_this.baseLayer(),evt={geo:{},zoomLevel:val,screenPosition:direction,eventType:geo.event.zoom},base&&base.renderer().geoTrigger(geo.event.zoom,evt,!0),recenter=evt.center,evt.geo.preventDefault||(m_zoom=val,m_this._updateBounds(),m_this.children().forEach(function(child){child.geoTrigger(geo.event.zoom,evt,!0)}),m_this.modified()),evt.center?m_this.center(recenter):m_this.pan({x:0,y:0}),m_this))},this.pan=function(delta,force){var evt,pt,corner1,corner2,base=m_this.baseLayer();return arg.clampBounds&&!force&&m_width&&m_height&&(pt=m_this.displayToGcs({x:delta.x,y:delta.y}),corner1=m_this.gcsToDisplay({x:-180,y:82}),corner2=m_this.gcsToDisplay({x:180,y:-82}),corner1.x>0&&corner2.x<m_width?delta.x=(-corner1.x+m_width-corner2.x)/2:delta.x=Math.max(Math.min(delta.x,-corner1.x),m_width-corner2.x),corner1.y>0&&corner2.y<m_height?delta.y=(-corner1.y+m_height-corner2.y)/2:delta.y=Math.max(Math.min(delta.y,-corner1.y),m_height-corner2.y)),evt={geo:{},screenDelta:delta,eventType:geo.event.pan},base&&base.renderer().geoTrigger(geo.event.pan,evt,!0),evt.geo.preventDefault?void 0:(m_center=m_this.displayToGcs({x:m_width/2,y:m_height/2}),m_this._updateBounds(),m_this.children().forEach(function(child){child.geoTrigger(geo.event.pan,evt,!0)}),m_this.modified(),m_this)},this.center=function(coordinates,force){var newCenter,currentCenter;return void 0===coordinates?m_center:(coordinates=geo.util.normalizeCoordinates(coordinates),newCenter=m_this.gcsToDisplay(coordinates),currentCenter=m_this.gcsToDisplay(m_center),m_this.pan({x:currentCenter.x-newCenter.x,y:currentCenter.y-newCenter.y},force),m_this)},this.createLayer=function(layerName,arg){var newLayer=geo.createLayer(layerName,m_this,arg);return null===newLayer&&void 0===newLayer?null:(newLayer._resize(m_x,m_y,m_width,m_height),(newLayer.referenceLayer()||0===m_this.children().length)&&m_this.baseLayer(newLayer),m_this.addChild(newLayer),m_this.modified(),newLayer.referenceLayer()||m_this.center(m_this.center()),m_this.geoTrigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:m_this,layer:newLayer}),newLayer)},this.deleteLayer=function(layer){return null!==layer&&void 0!==layer&&(layer._exit(),m_this.removeChild(layer),m_this.modified(),m_this.geoTrigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:m_this,layer:layer})),layer},this.toggle=function(layer){return null!==layer&&void 0!==layer&&(layer.visible(!layer.visible()),m_this.modified(),m_this.geoTrigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:m_this,layer:layer})),m_this},this.resize=function(x,y,w,h){var i,layers=m_this.children();for(m_x=x,m_y=y,m_width=w,m_height=h,i=0;i<layers.length;i+=1)layers[i]._resize(x,y,w,h);return m_this.geoTrigger(geo.event.resize,{type:geo.event.resize,target:m_this,x:m_x,y:m_y,width:w,height:h}),m_this._updateBounds(),m_this.pan({x:0,y:0}),m_this.modified(),m_this},this.gcsToDisplay=function(input){var world,output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method latLonToDisplay does not handle "+input;return world=m_baseLayer.toLocal(input),output=m_baseLayer.renderer().worldToDisplay(world)},this.displayToGcs=function(input){var output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method displayToGcs does not handle "+input;return output=m_baseLayer.renderer().displayToWorld(input),output=m_baseLayer.fromLocal(output)},this.query=function(){},this.baseLayer=function(baseLayer){var save;return void 0!==baseLayer?(m_gcs!==baseLayer.gcs()&&m_this.gcs(baseLayer.gcs()),m_baseLayer=baseLayer,m_baseLayer.referenceLayer(!0),arg.center&&m_this.center(arg.center,!0),save=m_zoom,m_zoom=null,m_this.zoom(save),m_this._updateBounds(),m_this.pan({x:0,y:0}),m_this):m_baseLayer},this.draw=function(){var i,layers=m_this.children();for(m_this.geoTrigger(geo.event.draw,{type:geo.event.draw,target:m_this}),m_this._update(),i=0;i<layers.length;i+=1)layers[i].draw();return m_this.geoTrigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:m_this}),m_this},this.fileReader=function(readerType,opts){var layer,renderer;return opts=opts||{},readerType?(layer=opts.layer,layer||(renderer=opts.renderer,renderer||(renderer="d3"),layer=m_this.createLayer("feature",{renderer:renderer})),opts.layer=layer,opts.renderer=renderer,m_fileReader=geo.createFileReader(readerType,opts),m_this):m_fileReader},this._init=function(arg){var i;if(void 0===m_node||null===m_node)throw"Map require DIV node";if(void 0!==arg&&void 0!==arg.layers)for(i=0;i<arg.layers.length;i+=1)0===i&&m_this.baseLayer(arg.layers[i]),m_this.addLayer(arg.layers[i]);return m_this},this._update=function(request){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._update(request);return m_this},this.exit=function(){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._exit();m_this.interactor()&&(m_this.interactor().destroy(),m_this.interactor(null)),m_this.node().off(".geo"),$(window).off("resize",resizeSelf),s_exit()},this._init(arg),this.node().on("dragover.geo",function(e){var evt=e.originalEvent;m_this.fileReader()&&(evt.stopPropagation(),evt.preventDefault(),evt.dataTransfer.dropEffect="copy")}).on("drop.geo",function(e){function done(){m_this.draw()}var i,file,evt=e.originalEvent,reader=m_this.fileReader();if(reader)for(evt.stopPropagation(),evt.preventDefault(),i=0;i<evt.dataTransfer.files.length;i+=1)file=evt.dataTransfer.files[i],reader.canRead(file)&&reader.read(file,done)}),this.interactor=function(arg){return void 0===arg?m_interactor:(m_interactor=arg,m_interactor&&m_interactor.map(m_this),m_this)},this.clock=function(arg){return void 0===arg?m_clock:(m_clock=arg,m_clock&&m_clock.object(m_this),m_this)},this.zoomRange=function(arg){return void 0===arg?$.extend({},m_validZoomRange):(m_validZoomRange.min=arg.min,m_validZoomRange.max=arg.max,m_this)},this.transition=function(opts){function interp1(p0,p1,t){return p0+(p1-p0)*t}function defaultInterp(p0,p1){return function(t){return[interp1(p0[0],p1[0],t),interp1(p0[1],p1[1],t),interp1(p0[2],p1[2],t)]}}function zoom2z(z){return 360*Math.pow(2,-1-z)}function z2zoom(z){return-1-Math.log2(z/360)}function anim(time){var next,done=m_transition.done;if(next=m_queuedTransition,m_transition.start.time||(m_transition.start.time=time,m_transition.end.time=time+defaultOpts.duration),m_transition.time=time-m_transition.start.time,time>=m_transition.end.time||next)return next||(m_this.center(m_transition.end.center),m_this.zoom(m_transition.end.zoom)),m_transition=null,m_this.geoTrigger(geo.event.transitionend,defaultOpts),done&&done(),void(next&&(m_queuedTransition=null,m_this.transition(next)));var z=m_transition.ease((time-m_transition.start.time)/defaultOpts.duration),p=m_transition.interp(z);m_transition.zCoord&&(p[2]=z2zoom(p[2])),m_this.center({x:p[0],y:p[1]}),m_this.zoom(p[2]),window.requestAnimationFrame(anim)}if(void 0===opts)return m_transition;if(m_transition)return m_queuedTransition=opts,m_this;var defaultOpts={center:m_this.center(),zoom:m_this.zoom(),duration:1e3,ease:function(t){return t},interp:defaultInterp,done:null,zCoord:!0};return opts.center&&(opts.center=geo.util.normalizeCoordinates(opts.center)),$.extend(defaultOpts,opts),m_transition={start:{center:m_this.center(),zoom:m_this.zoom()},end:{center:defaultOpts.center,zoom:defaultOpts.zoom},ease:defaultOpts.ease,zCoord:defaultOpts.zCoord,done:defaultOpts.done,duration:defaultOpts.duration},defaultOpts.zCoord?m_transition.interp=defaultOpts.interp([m_transition.start.center.x,m_transition.start.center.y,zoom2z(m_transition.start.zoom)],[m_transition.end.center.x,m_transition.end.center.y,zoom2z(m_transition.end.zoom)]):m_transition.interp=defaultOpts.interp([m_transition.start.center.x,m_transition.start.center.y,m_transition.start.zoom],[m_transition.end.center.x,m_transition.end.center.y,m_transition.end.zoom]),m_this.geoTrigger(geo.event.transitionstart,defaultOpts),defaultOpts.cancelNavigation?(m_this.geoTrigger(geo.event.transitionend,defaultOpts),m_this):(defaultOpts.cancelAnimation?(defaultOpts.duration=0,anim(0)):window.requestAnimationFrame(anim),m_this)},this._updateBounds=function(){m_bounds.lowerLeft=m_this.displayToGcs({x:0,y:m_height}),m_bounds.lowerRight=m_this.displayToGcs({x:m_width,y:m_height}),m_bounds.upperLeft=m_this.displayToGcs({x:0,y:0}),m_bounds.upperRight=m_this.displayToGcs({x:m_width,y:0})},this.bounds=function(bds){var nav;return void 0===bds?m_bounds:(nav=m_this.zoomAndCenterFromBounds(bds),m_this.zoom(nav.zoom),m_this.center(nav.center),m_bounds)},this.zoomAndCenterFromBounds=function(bds){var ll,ur,dx,dy,zx,zy,center;if(ll=geo.util.normalizeCoordinates(bds.lowerLeft||{}),ur=geo.util.normalizeCoordinates(bds.upperRight||{}),ll.x>=ur.x||ll.y>=ur.y)throw new Error("Invalid bounds provided");return center={x:(ll.x+ur.x)/2,y:(ll.y+ur.y)/2},dx=m_bounds.upperRight.x-m_bounds.lowerLeft.x,dy=m_bounds.upperRight.y-m_bounds.lowerLeft.y,zx=m_zoom-Math.log2((ur.x-ll.x)/dx),zy=m_zoom-Math.log2((ur.y-ll.y)/dy),{zoom:Math.min(zx,zy),center:center}},this.interactor(arg.interactor||geo.mapInteractor()),this.clock(arg.clock||geo.clock()),arg.autoResize&&$(window).resize(resizeSelf),this},geo.map.create=function(spec){"use strict";var map=geo.map(spec);return map?(spec.data=spec.data||[],spec.layers=spec.layers||[],spec.layers.forEach(function(l){l.data=l.data||spec.data,l.layer=geo.layer.create(map,l)}),map):(console.warn("Could not create map."),null)},inherit(geo.map,geo.sceneObject),geo.feature=function(arg){"use strict";if(!(this instanceof geo.feature))return new geo.feature(arg);geo.sceneObject.call(this),arg=arg||{};var m_this=this,s_exit=this._exit,m_selectionAPI=void 0===arg.selectionAPI?!1:arg.selectionAPI,m_style={},m_layer=void 0===arg.layer?null:arg.layer,m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_visible=void 0===arg.visible?!0:arg.visible,m_bin=void 0===arg.bin?0:arg.bin,m_renderer=void 0===arg.renderer?null:arg.renderer,m_dataTime=geo.timestamp(),m_buildTime=geo.timestamp(),m_updateTime=geo.timestamp(),m_selectedFeatures=[];return this._bindMouseHandlers=function(){m_selectionAPI&&(m_this._unbindMouseHandlers(),m_this.geoOn(geo.event.mousemove,m_this._handleMousemove),m_this.geoOn(geo.event.mouseclick,m_this._handleMouseclick),m_this.geoOn(geo.event.brushend,m_this._handleBrushend),m_this.geoOn(geo.event.brush,m_this._handleBrush))},this._unbindMouseHandlers=function(){m_this.geoOff(geo.event.mousemove,m_this._handleMousemove),m_this.geoOff(geo.event.mouseclick,m_this._handleMouseclick),m_this.geoOff(geo.event.brushend,m_this._handleBrushend),m_this.geoOff(geo.event.brush,m_this._handleBrush)},this.pointSearch=function(){return{index:[],found:[]}},this._handleMousemove=function(){var mouse=m_this.layer().map().interactor().mouse(),data=m_this.data(),over=m_this.pointSearch(mouse.geo),newFeatures=[],oldFeatures=[],lastTop=-1,top=-1;m_selectedFeatures.length&&(lastTop=m_selectedFeatures[m_selectedFeatures.length-1]),newFeatures=over.index.filter(function(i){return m_selectedFeatures.indexOf(i)<0}),oldFeatures=m_selectedFeatures.filter(function(i){return over.index.indexOf(i)<0}),geo.feature.eventID+=1,newFeatures.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.mouseover,{data:data[i],index:i,mouse:mouse,eventID:geo.feature.eventID,top:idx===newFeatures.length-1},!0)}),geo.feature.eventID+=1,oldFeatures.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.mouseout,{data:data[i],index:i,mouse:mouse,eventID:geo.feature.eventID,top:idx===oldFeatures.length-1},!0)}),geo.feature.eventID+=1,over.index.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.mousemove,{data:data[i],index:i,mouse:mouse,eventID:geo.feature.eventID,top:idx===over.index.length-1},!0)}),m_selectedFeatures=over.index,m_selectedFeatures.length&&(top=m_selectedFeatures[m_selectedFeatures.length-1]),lastTop!==top&&(-1!==lastTop&&m_this.geoTrigger(geo.event.feature.mouseoff,{data:data[lastTop],index:lastTop,mouse:mouse},!0),-1!==top&&m_this.geoTrigger(geo.event.feature.mouseon,{data:data[top],index:top,mouse:mouse},!0))},this._handleMouseclick=function(){var mouse=m_this.layer().map().interactor().mouse(),data=m_this.data(),over=m_this.pointSearch(mouse.geo);geo.feature.eventID+=1,over.index.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.mouseclick,{data:data[i],index:i,mouse:mouse,eventID:geo.feature.eventID,top:idx===over.index.length-1},!0)})},this._handleBrush=function(brush){var idx=m_this.boxSearch(brush.gcs.lowerLeft,brush.gcs.upperRight),data=m_this.data();geo.feature.eventID+=1,idx.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.brush,{data:data[i],index:i,mouse:brush.mouse,brush:brush,eventID:geo.feature.eventID,top:idx===idx.length-1},!0)})},this._handleBrushend=function(brush){var idx=m_this.boxSearch(brush.gcs.lowerLeft,brush.gcs.upperRight),data=m_this.data();geo.feature.eventID+=1,idx.forEach(function(i,idx){m_this.geoTrigger(geo.event.feature.brushend,{data:data[i],index:i,mouse:brush.mouse,brush:brush,eventID:geo.feature.eventID,top:idx===idx.length-1},!0)})},this.style=function(arg1,arg2){return void 0===arg1?m_style:"string"==typeof arg1&&void 0===arg2?m_style[arg1]:void 0===arg2?(m_style=$.extend({},m_style,arg1),m_this.modified(),m_this):(m_style[arg1]=arg2,m_this.modified(),m_this)},this.style.get=function(key){var tmp,out;if(void 0===key){var k,all={};for(k in m_style)m_style.hasOwnProperty(k)&&(all[k]=m_this.style.get(k));return all}return key.toLowerCase().match(/color$/)?geo.util.isFunction(m_style[key])?(tmp=geo.util.ensureFunction(m_style[key]),out=function(){return geo.util.convertColor(tmp.apply(this,arguments))}):out=geo.util.ensureFunction(geo.util.convertColor(m_style[key])):out=geo.util.ensureFunction(m_style[key]),out},this.layer=function(){return m_layer},this.renderer=function(){return m_renderer},this.drawables=function(){return m_this._drawables()},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_visible:(m_visible=val,m_this.modified(),m_visible?m_this._bindMouseHandlers():m_this._unbindMouseHandlers(),m_this)},this.bin=function(val){return void 0===val?m_bin:(m_bin=val,m_this.modified(),m_this)},this.dataTime=function(val){return void 0===val?m_dataTime:(m_dataTime=val,m_this.modified(),m_this)},this.buildTime=function(val){return void 0===val?m_buildTime:(m_buildTime=val,m_this.modified(),m_this)},this.updateTime=function(val){return void 0===val?m_updateTime:(m_updateTime=val,m_this.modified(),m_this)},this.data=function(data){return void 0===data?m_this.style("data")||[]:(m_this.style("data",data),m_this.dataTime().modified(),m_this.modified(),m_this)},this.selectionAPI=function(){return m_selectionAPI},this._init=function(arg){if(!m_layer)throw"Feature requires a valid layer";m_style=$.extend({},{opacity:1},void 0===arg.style?{}:arg.style),m_this._bindMouseHandlers()},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){m_this._unbindMouseHandlers(),m_selectedFeatures=[],m_style={},arg={},s_exit()},this._init(arg),this},geo.feature.eventID=0,geo.feature.create=function(layer,spec){"use strict";var type=spec.type;if(!layer instanceof geo.layer)return console.warn("Invalid layer"),null;if("object"!=typeof spec)return console.warn("Invalid spec"),null;var feature=layer.createFeature(type);return feature?(spec=spec||{},spec.data=spec.data||[],feature.style(spec)):(console.warn("Could not create feature type '"+type+"'"),null)},inherit(geo.feature,geo.sceneObject),geo.pointFeature=function(arg){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_init=this._init,m_rangeTree=null,m_rangeTreeTime=geo.timestamp(),s_data=this.data,m_maxRadius=0;return this.position=function(val){return void 0===val?m_this.style("position"):(m_this.style("position",val),m_this.dataTime().modified(),m_this.modified(),m_this)},this._updateRangeTree=function(){if(!(m_rangeTreeTime.getMTime()>=m_this.dataTime().getMTime())){var pts,position,radius=m_this.style.get("radius"),stroke=m_this.style.get("stroke"),strokeWidth=m_this.style.get("strokeWidth");position=m_this.position(),m_maxRadius=0,pts=m_this.data().map(function(d,i){var pt=position(d);return pt.idx=i,m_maxRadius=Math.max(m_maxRadius,radius(d,i)+(stroke(d,i)?strokeWidth(d,i):0)),pt}),m_rangeTree=new geo.util.RangeTree(pts),m_rangeTreeTime.modified()}},this.pointSearch=function(p){var min,max,data,box,map,pt,idx=[],found=[],ifound=[],stroke=m_this.style.get("stroke"),strokeWidth=m_this.style.get("strokeWidth"),radius=m_this.style.get("radius");

return m_this.selectionAPI()?(data=m_this.data(),data&&data.length?(map=m_this.layer().map(),pt=map.gcsToDisplay(p),min=map.displayToGcs({x:pt.x-m_maxRadius,y:pt.y+m_maxRadius}),max=map.displayToGcs({x:pt.x+m_maxRadius,y:pt.y-m_maxRadius}),box=new geo.util.Box(geo.util.vect(min.x,min.y),geo.util.vect(max.x,max.y)),m_this._updateRangeTree(),m_rangeTree.search(box).forEach(function(q){idx.push(q.idx)}),idx.forEach(function(i){var dx,dy,rad,d=data[i],p=m_this.position()(d,i);rad=radius(data[i],i),rad+=stroke(data[i],i)?strokeWidth(data[i],i):0,p=map.gcsToDisplay(p),dx=p.x-pt.x,dy=p.y-pt.y,Math.sqrt(dx*dx+dy*dy)<=rad&&(found.push(d),ifound.push(i))}),{data:found,index:ifound}):{found:[],index:[]}):[]},this.boxSearch=function(lowerLeft,upperRight){var pos=m_this.position(),idx=[];return m_this.data().forEach(function(d,i){var p=pos(d);p.x>=lowerLeft.x&&p.x<=upperRight.x&&p.y>=lowerLeft.y&&p.y<=upperRight.y&&idx.push(i)}),idx},this.data=function(data){return void 0===data?s_data():(s_data(data),m_this)},this._boundingBox=function(d){var pt,radius;return pt=m_this.position()(d),pt=m_this.layer().map().gcsToDisplay(pt),radius=m_this.style().radius(d),{min:{x:pt.x-radius,y:pt.y-radius},max:{x:pt.x+radius,y:pt.y+radius}}},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{radius:10,stroke:!0,strokeColor:{r:0,g:1,b:0},strokeWidth:2,strokeOpacity:1,fillColor:{r:1,g:0,b:0},fill:!0,fillOpacity:1,sprites:!1,sprites_image:null,position:function(d){return d}},void 0===arg.style?{}:arg.style);void 0!==arg.position&&(defaultStyle.position=arg.position),m_this.style(defaultStyle),m_this.dataTime().modified()},m_this},geo.event.pointFeature=$.extend({},geo.event.feature),geo.pointFeature.create=function(layer,renderer,spec){"use strict";return spec.type="point",geo.feature.create(layer,spec)},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(arg){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_init=this._init;return this.line=function(val){return void 0===val?m_this.style("line"):(m_this.style("line",val),m_this.dataTime().modified(),m_this.modified(),m_this)},this.position=function(val){return void 0===val?m_this.style("position"):(m_this.style("position",val),m_this.dataTime().modified(),m_this.modified(),m_this)},this.pointSearch=function(p){function lineDist2(q,u,v){var t,l2=dist2(u,v);return 1>l2?dist2(q,u):(t=((q.x-u.x)*(v.x-u.x)+(q.y-u.y)*(v.y-u.y))/l2,0>t?dist2(q,u):t>1?dist2(q,v):dist2(q,{x:u.x+t*(v.x-u.x),y:u.y+t*(v.y-u.y)}))}function dist2(u,v){var dx=u.x-v.x,dy=u.y-v.y;return dx*dx+dy*dy}var data,pt,map,line,width,pos,indices=[],found=[];return data=m_this.data(),data&&data.length?(map=m_this.layer().map(),line=m_this.line(),width=m_this.style.get("strokeWidth"),pos=m_this.position(),pt=map.gcsToDisplay(p),data.forEach(function(d,index){var last=null;try{line(d,index).forEach(function(current,j){var p=pos(current,j,d,index),s=map.gcsToDisplay(p),r=Math.ceil(width(p,j,d,index)/2)+2;if(r*=r,last&&lineDist2(pt,s,last)<=r)throw"found";last=s})}catch(err){if("found"!==err)throw err;found.push(d),indices.push(index)}}),{data:found,index:indices}):{found:[],index:[]}},this.boxSearch=function(lowerLeft,upperRight,opts){var pos=m_this.position(),idx=[],line=m_this.line();if(opts=opts||{},opts.partial=opts.partial||!1,opts.partial)throw"Unimplemented query method.";return m_this.data().forEach(function(d,i){var inside=!0;line(d,i).forEach(function(e,j){if(inside){var p=pos(e,j,d,i);p.x>=lowerLeft.x&&p.x<=upperRight.x&&p.y>=lowerLeft.y&&p.y<=upperRight.y||(inside=!1)}}),inside&&idx.push(i)}),idx},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{strokeWidth:1,strokeColor:{r:1,g:.8431372549,b:0},strokeStyle:"solid",strokeOpacity:1,line:function(d){return d},position:function(d){return d}},void 0===arg.style?{}:arg.style);void 0!==arg.line&&(defaultStyle.line=arg.line),void 0!==arg.position&&(defaultStyle.position=arg.position),m_this.style(defaultStyle),m_this.dataTime().modified()},this._init(arg),this},geo.lineFeature.create=function(layer,spec){"use strict";return spec.type="line",geo.feature.create(layer,spec)},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(arg){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_position=void 0===arg.position?[]:arg.position,s_init=this._init;return this.position=function(val){return void 0===val?m_position:(m_position=val,m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{strokeWidth:function(){return 1},strokeColor:function(){return{r:1,g:1,b:1}}},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_position&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(arg){"use strict";function getCoordinates(){var posFunc=m_this.position(),polyFunc=m_this.polygon();m_coordinates=m_this.data().map(function(d,i){var outer,inner,poly=polyFunc(d);return outer=(poly.outer||[]).map(function(d0,j){return posFunc.call(m_this,d0,j,d,i)}),inner=(poly.inner||[]).map(function(hole){return(hole||[]).map(function(d0,k){return posFunc.call(m_this,d0,k,d,i)})}),{outer:outer,inner:inner}})}if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_position,m_polygon,m_this=this,s_init=this._init,s_data=this.data,m_coordinates={outer:[],inner:[]};return m_polygon=void 0===arg.line?function(d){return d}:arg.polygon,m_position=void 0===arg.position?function(d){return d}:arg.position,this.data=function(arg){var ret=s_data(arg);return void 0!==arg&&getCoordinates(),ret},this.polygon=function(val){return void 0===val?m_polygon:(m_polygon=val,m_this.dataTime().modified(),m_this.modified(),getCoordinates(),m_this)},this.position=function(val){return void 0===val?m_position:(m_position=val,m_this.dataTime().modified(),m_this.modified(),getCoordinates(),m_this)},this.pointSearch=function(coordinate){var found=[],indices=[],data=m_this.data();return m_coordinates.forEach(function(coord,i){var inside=geo.util.pointInPolygon(coordinate,coord.outer,coord.inner);inside&&(indices.push(i),found.push(data[i]))}),{index:indices,found:found}},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{fillColor:{r:0,g:.5,b:.5},fillOpacity:1},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_position&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(arg){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(arg);arg=arg||{},arg.ul=void 0===arg.ul?[0,1,0]:arg.ul,arg.lr=void 0===arg.lr?[1,0,0]:arg.lr,arg.depth=void 0===arg.depth?0:arg.depth,geo.polygonFeature.call(this,arg);var m_this=this,m_origin=[arg.ul.x,arg.lr.y,arg.depth],m_upperLeft=[arg.ul.x,arg.ul.y,arg.depth],m_lowerRight=[arg.lr.x,arg.lr.y,arg.depth],m_defaultDepth=arg.depth,m_drawOnAsyncResourceLoad=void 0===arg.drawOnAsyncResourceLoad?!0:!1,s_init=this._init;return this.origin=function(val){if(void 0===val)return m_origin;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_origin=val.slice(0),2===m_origin.length&&(m_origin[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_origin=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.upperLeft=function(val){if(void 0===val)return m_upperLeft;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_upperLeft=val.slice(0),2===m_upperLeft.length&&(m_upperLeft[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_upperLeft=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.lowerRight=function(val){if(void 0===val)return m_lowerRight;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_lowerRight=val.slice(0),2===m_lowerRight.length&&(m_lowerRight[2]=m_defaultDepth),m_this.dataTime().modified()}else val instanceof geo.latlng&&(m_lowerRight=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.drawOnAsyncResourceLoad=function(val){return void 0===val?m_drawOnAsyncResourceLoad:(m_drawOnAsyncResourceLoad=val,m_this)},this._init=function(arg){var style=null;s_init.call(m_this,arg),style=m_this.style(),void 0===style.image&&(style.image=null),m_this.style(style)},this._init(arg),this},inherit(geo.planeFeature,geo.polygonFeature),geo.vectorFeature=function(arg){"use strict";if(!(this instanceof geo.vectorFeature))return new geo.vectorFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_init=this._init,s_style=this.style;this.origin=function(val){return void 0===val?s_style("origin"):(s_style("origin",val),m_this.dataTime().modified(),m_this.modified(),m_this)},this.delta=function(val){return void 0===val?s_style("delta"):(s_style("delta",val),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{strokeColor:"black",strokeWidth:2,strokeOpacity:1,origin:{x:0,y:0,z:0},delta:function(d){return d},scale:null},void 0===arg.style?{}:arg.style);void 0!==arg.origin&&(defaultStyle.origin=arg.origin),m_this.style(defaultStyle),m_this.dataTime().modified()}},inherit(geo.vectorFeature,geo.feature),geo.geomFeature=function(arg){"use strict";return this instanceof geo.geomFeature?(arg=arg||{},geo.feature.call(this,arg),arg.style=void 0===arg.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},arg.style):arg.style,this.style(arg.style),this):new geo.geomFeature(arg)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(arg){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_draw=this.draw,s_style=this.style,m_nodes=null,m_points=null,m_children=function(d){return d.children},m_links=[],s_init=this._init,s_exit=this._exit;return this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend(!0,{},{nodes:{radius:5,fill:!0,fillColor:{r:1,g:0,b:0},strokeColor:{r:0,g:0,b:0}},links:{strokeColor:{r:0,g:0,b:0}},linkType:"path"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_this.nodes(function(d){return d})},this._build=function(){m_this.children().forEach(function(child){child._build()})},this._update=function(){m_this.children().forEach(function(child){child._update()})},this._exit=function(){return m_this.data([]),m_links.forEach(function(link){link._exit(),m_this.removeChild(link)}),m_links=[],m_points._exit(),m_this.removeChild(m_points),s_exit(),m_this},this.style=function(arg,arg2){var out=s_style.call(m_this,arg,arg2);return out!==m_this?out:(m_points.style(arg.nodes),m_links.forEach(function(l){l.style(arg.links)}),m_this)},this.links=function(arg){return void 0===arg?m_children:(m_children=geo.util.ensureFunction(arg),m_this)},this.nodes=function(val){return void 0===val?m_nodes:(m_nodes=val,m_this.modified(),m_this)},this.nodeFeature=function(){return m_points},this.linkFeatures=function(){return m_links},this.draw=function(){var style,layer=m_this.layer(),data=m_this.data(),nLinks=0;return style=m_this.style(),m_points.data(data),m_points.style(style.nodes),data.forEach(function(source){(source.children||[]).forEach(function(target){var link;nLinks+=1,m_links.length<nLinks&&(link=geo.createFeature(style.linkType,layer,layer.renderer()).style(style.links),m_this.addChild(link),m_links.push(link)),m_links[nLinks-1].data([source,target])})}),m_links.splice(nLinks,m_links.length-nLinks).forEach(function(l){l._exit(),m_this.removeChild(l)}),s_draw(),m_this},m_points=geo.createFeature("point",this.layer(),this.layer().renderer()),m_this.addChild(m_points),arg.nodes&&this.nodes(arg.nodes),this._init(arg),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)return void console.log("[warning] Invalid (null) feature");if(feature.gcs()!==destGcs){if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";var i,yCoord,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,srcGcs=feature.gcs();if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if("EPSG:4326"!==srcGcs&&geo.transform.transformFeature("EPSG:4326",feature,!0),inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(outPos=inplace?inPos:inPos.slice(0),i=0;count>i;i+=pointOffset)yCoord=inPos[i]instanceof geo.latlng?inPos[i].lat():inPos[i+1],yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),inPos[i]instanceof geo.latlng?outPos[i]=geo.latlng(geo.mercator.lat2y(yCoord),outPos[i].lng()):outPos[i+1]=geo.mercator.lat2y(yCoord);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null}},geo.transform.transformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)throw"Invalid (null) feature";if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";if(feature.gcs()===destGcs)return feature.positions();if("EPSG:3857"===destGcs)return geo.transform.osmTransformFeature(destGcs,feature,inplace);var i,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,projPoint=null,srcGcs=feature.gcs(),projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if(inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(inplace?outPos=inPos:(outPos=[],outPos.length=inPos.length),i=0;count>i;i+=pointOffset)projPoint=2===noOfComponents?new proj4.Point(inPos[i],inPos[i+1],0):new proj4.Point(inPos[i],inPos[i+1],inPos[i+2]),proj4.transform(projSrcGcs,projDestGcs,projPoint),2===noOfComponents?(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y):(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y,outPos[i+2]=projPoint.z);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null},geo.transform.transformLayer=function(destGcs,layer,baseLayer){"use strict";var features,count,i;if(!layer)throw"Requires valid layer for tranformation";if(!baseLayer)throw"Requires baseLayer used by the map";if(layer!==baseLayer){if(!(layer instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(features=layer.features(),count=features.length,i=0,i=0;count>i;i+=1)"EPSG:3857"===destGcs&&baseLayer instanceof geo.osmLayer?geo.transform.osmTransformFeature(destGcs,features[i],!0):geo.transform.transformFeature(destGcs,features[i],!0);layer.gcs(destGcs)}},geo.transform.transformCoordinates=function(srcGcs,destGcs,coordinates,numberOfComponents){"use strict";function handleLatLngCoordinates(){coordinates[0]&&coordinates[0]instanceof geo.latlng?(xAcc=function(index){return coordinates[index].x()},yAcc=function(index){return coordinates[index].y()},writer=function(index,x,y){output[index]=geo.latlng(y,x)}):(xAcc=function(){return coordinates.x()},yAcc=function(){return coordinates.y()},writer=function(index,x,y){output=geo.latlng(y,x)})}function handleArrayCoordinates(){if(coordinates[0]instanceof Array)if(2===coordinates[0].length)xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},writer=function(index,x,y){output[index]=[x,y]};else{if(3!==coordinates[0].length)throw"Invalid coordinates. Requires two or three components per array";xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},zAcc=function(index){return coordinates[index][2]},writer=function(index,x,y,z){output[index]=[x,y,z]}}else if(2===coordinates.length)offset=2,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},writer=function(index,x,y){output[index]=x,output[index+1]=y};else if(3===coordinates.length)offset=3,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},zAcc=function(index){return coordinates[index*offset+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z};else{if(!numberOfComponents)throw"Invalid coordinates";offset=numberOfComponents,xAcc=function(index){return coordinates[index]},yAcc=function(index){return coordinates[index+1]},2===numberOfComponents?writer=function(index,x,y){output[index]=x,output[index+1]=y}:(zAcc=function(index){return coordinates[index+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z})}}function handleObjectCoordinates(){if(coordinates[0]&&"x"in coordinates[0]&&"y"in coordinates[0])xAcc=function(index){return coordinates[index].x},yAcc=function(index){return coordinates[index].y},"z"in coordinates[0]?(zAcc=function(index){return coordinates[index].z},writer=function(index,x,y,z){output[i]={x:x,y:y,z:z}}):writer=function(index,x,y){output[index]={x:x,y:y}};else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Invalid coordinates";xAcc=function(){return coordinates.x},yAcc=function(){return coordinates.y},"z"in coordinates?(zAcc=function(){return coordinates.z},writer=function(index,x,y,z){output={x:x,y:y,z:z}}):writer=function(index,x,y){output={x:x,y:y}}}}var i,count,offset,xCoord,yCoord,zCoord,xAcc,yAcc,zAcc,writer,output,projPoint,projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(zAcc=function(){return 0},destGcs===srcGcs)return coordinates;if(!destGcs||!srcGcs)throw"Invalid source or destination GCS";if(coordinates instanceof Array)output=[],output.length=coordinates.length,count=coordinates.length,coordinates[0]instanceof Array||coordinates[0]instanceof geo.latlng||coordinates[0]instanceof Object?(offset=1,coordinates[0]instanceof Array?handleArrayCoordinates():coordinates[0]instanceof geo.latlng?handleLatLngCoordinates():coordinates[0]instanceof Object&&handleObjectCoordinates()):handleArrayCoordinates();else if(coordinates&&coordinates instanceof Object)if(count=1,offset=1,coordinates instanceof geo.latlng)handleLatLngCoordinates();else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Coordinates are not valid";handleObjectCoordinates()}if("EPSG:3857"===destGcs&&"EPSG:4326"===srcGcs){for(i=0;count>i;i+=offset)xCoord=xAcc(i),yCoord=yAcc(i),zCoord=zAcc(i),yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),writer(i,xCoord,geo.mercator.lat2y(yCoord),zCoord);return output}for(i=0;count>i;i+=offset)return projPoint=new proj4.Point(xAcc(i),yAcc(i),zAcc(i)),proj4.transform(projSrcGcs,projDestGcs,projPoint),writer(i,projPoint.x,projPoint.y,projPoint.z),output},geo.renderer=function(arg){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(arg);geo.object.call(this),arg=arg||{};var m_this=this,m_layer=void 0===arg.layer?null:arg.layer,m_canvas=void 0===arg.canvas?null:arg.canvas,m_initialized=!1;return this.layer=function(){return m_layer},this.canvas=function(val){return void 0===val?m_canvas:(m_canvas=val,void m_this.modified())},this.map=function(){return m_layer?m_layer.map():null},this.baseLayer=function(){return m_this.map()?m_this.map().baseLayer():void 0},this.initialized=function(val){return void 0===val?m_initialized:(m_initialized=val,m_this)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(event){var totalOffsetX=0,totalOffsetY=0,canvasX=0,canvasY=0,currentElement=m_this.canvas();do totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop,currentElement=currentElement.offsetParent;while(currentElement);return canvasX=event.pageX-totalOffsetX,canvasY=event.pageY-totalOffsetY,{x:canvasX,y:canvasY}},this._init=function(){},this._resize=function(){},this._render=function(){},this},inherit(geo.renderer,geo.object),geo.osmLayer=function(arg){"use strict";function isTileVisible(tile){return tile.zoom in m_visibleTilesRange&&tile.index_x>=m_visibleTilesRange[tile.zoom].startX&&tile.index_x<=m_visibleTilesRange[tile.zoom].endX&&tile.index_y>=m_visibleTilesRange[tile.zoom].startY&&tile.index_y<=m_visibleTilesRange[tile.zoom].endY?!0:!1}function drawTiles(){m_this._removeTiles(),m_this.draw(),delete m_pendingNewTilesStat[m_updateTimerId]}function updateOSMTiles(request){void 0===request&&(request={}),m_zoom||(m_zoom=m_this.map().zoom()),m_lastVisibleZoom||(m_lastVisibleZoom=m_zoom),m_this._addTiles(request),m_lastVisibleZoom!==m_zoom&&(m_lastVisibleZoom=m_zoom),m_this.updateTime().modified()}if(!(this instanceof geo.osmLayer))return new geo.osmLayer(arg);geo.featureLayer.call(this,arg);var m_tileUrl,m_tileUrlFromTemplate,m_this=this,s_exit=this._exit,m_tiles={},m_hiddenBinNumber=-1,m_lastVisibleBinNumber=-1,m_visibleBinNumber=1e3,m_pendingNewTiles=[],m_pendingInactiveTiles=[],m_numberOfCachedTiles=0,m_tileCacheSize=100,m_baseUrl="http://tile.openstreetmap.org/",m_mapOpacity=1,m_imageFormat="png",m_updateTimerId=null,m_lastVisibleZoom=null,m_visibleTilesRange={},s_init=this._init,m_pendingNewTilesStat={},s_update=this._update,m_updateDefer=null,m_zoom=null;return arg&&void 0!==arg.baseUrl&&(m_baseUrl=arg.baseUrl),"/"!==m_baseUrl.charAt(m_baseUrl.length-1)&&(m_baseUrl+="/"),arg&&void 0!==arg.mapOpacity&&(m_mapOpacity=arg.mapOpacity),arg&&void 0!==arg.imageFormat&&(m_imageFormat=arg.imageFormat),arg&&void 0!==arg.displayLast&&arg.displayLast&&(m_lastVisibleBinNumber=999),m_tileUrl=function(zoom,x,y){return m_baseUrl+zoom+"/"+x+"/"+y+"."+m_imageFormat},m_tileUrlFromTemplate=function(base){return function(zoom,x,y){return base.replace("<zoom>",zoom).replace("<x>",x).replace("<y>",y)}},this.tileCacheSize=function(val){return void 0===val?m_tileCacheSize:(m_tileCacheSize=val,void m_this.modified())},this.tileUrl=function(val){return void 0===val?m_tileUrl:(m_tileUrl="string"==typeof val?m_tileUrlFromTemplate(val):val,m_this.modified(),m_this)},this.toLocal=function(input){var i,output,delta;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof geo.latlng)for(i=0;i<input.length;i+=1)output[i]=geo.latlng(input[i]),output[i].lat(geo.mercator.lat2y(output[i].lat()));else if(input[0]instanceof Array)if(delta=input%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]);else for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]),output[i+2]=input[i+2];else input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y),z:input[i].z}:input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y)}:input.length>=2&&(output=input.slice(0),output[1]=geo.mercator.lat2y(input[1]));else input instanceof geo.latlng?(output={},output.x=input.x(),output.y=geo.mercator.lat2y(input.y())):(output={},output.x=input.x,output.y=geo.mercator.lat2y(input.y));return output},this.fromLocal=function(input){var i,output;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof Object)for(i=0;i<input.length;i+=1)output[i]={},output[i].x=input[i].x,output[i].y=geo.mercator.y2lat(input[i].y);else if(input[0]instanceof Array)for(i=0;i<input.length;i+=1)output[i]=input[i],output[i][1]=geo.mercator.y2lat(input[i][1]);else for(i=0;i<input.length;i+=1)output[i]=input[i],output[i+1]=geo.mercator.y2lat(input[i+1]);else output={},output.x=input.x,output.y=geo.mercator.y2lat(input.y);return output},this._hasTile=function(zoom,x,y){return m_tiles[zoom]&&m_tiles[zoom][x]&&m_tiles[zoom][x][y]?!0:!1},this._addTile=function(request,zoom,x,y){if(m_tiles[zoom]||(m_tiles[zoom]={}),m_tiles[zoom][x]||(m_tiles[zoom][x]={}),!m_tiles[zoom][x][y]){var noOfTilesX=Math.max(1,Math.pow(2,zoom)),noOfTilesY=Math.max(1,Math.pow(2,zoom)),totalLatDegrees=360,lonPerTile=360/noOfTilesX,latPerTile=totalLatDegrees/noOfTilesY,llx=-180+x*lonPerTile,lly=.5*-totalLatDegrees+y*latPerTile,urx=-180+(x+1)*lonPerTile,ury=.5*-totalLatDegrees+(y+1)*latPerTile,tile=new Image;return tile.LOADING=!0,tile.LOADED=!1,tile.REMOVED=!1,tile.REMOVING=!1,tile.INVALID=!1,tile.crossOrigin="anonymous",tile.zoom=zoom,tile.index_x=x,tile.index_y=y,tile.llx=llx,tile.lly=lly,tile.urx=urx,tile.ury=ury,tile.lastused=new Date,tile.src=m_tileUrl(zoom,x,Math.pow(2,zoom)-1-y),m_tiles[zoom][x][y]=tile,m_pendingNewTiles.push(tile),m_numberOfCachedTiles+=1,tile}},this._removeTiles=function(){var i,x,y,tile,zoom,currZoom=m_zoom,lastZoom=m_lastVisibleZoom;if(!m_tiles)return m_this;for(zoom in m_tiles)for(x in m_tiles[zoom])for(y in m_tiles[zoom][x])tile=m_tiles[zoom][x][y],tile&&(tile.REMOVING=!0,m_pendingInactiveTiles.push(tile));for(m_pendingInactiveTiles.sort(function(a,b){return a.lastused-b.lastused}),i=0;m_numberOfCachedTiles>m_tileCacheSize&&i<m_pendingInactiveTiles.length;)tile=m_pendingInactiveTiles[i],isTileVisible(tile)?i+=1:(m_this.deleteFeature(tile.feature),delete m_tiles[tile.zoom][tile.index_x][tile.index_y],m_pendingInactiveTiles.splice(i,1),m_numberOfCachedTiles-=1);for(i=0;i<m_pendingInactiveTiles.length;i+=1)tile=m_pendingInactiveTiles[i],tile.REMOVING=!1,tile.REMOVED=!1,tile.zoom!==currZoom&&tile.zoom===lastZoom?tile.feature.bin(m_lastVisibleBinNumber):tile.zoom!==currZoom?tile.feature.bin(m_hiddenBinNumber):(tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.feature._update();return m_pendingInactiveTiles=[],m_this},this._addTiles=function(request){function tileOnLoad(tile){var defer=$.Deferred();return m_this.addDeferred(defer),function(){tile.INVALID||(tile.LOADING=!1,tile.LOADED=!0,(tile.REMOVING||tile.REMOVED)&&tile.feature&&tile.zoom!==m_zoom?(tile.feature.bin(m_hiddenBinNumber),tile.REMOVING=!1,tile.REMOVED=!0):(tile.REMOVED=!1,tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.updateTimerId===m_updateTimerId&&m_updateTimerId in m_pendingNewTilesStat?(tile.feature.bin(m_visibleBinNumber),m_pendingNewTilesStat[m_updateTimerId].count+=1):(tile.REMOVED=!0,tile.feature.bin(m_hiddenBinNumber)),tile.feature._update(),m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles(),defer.resolve())}}var feature,lastStartX,lastStartY,lastEndX,lastEndY,currStartX,currStartY,currEndX,currEndY,distWorldDeltaPerTile,ren=m_this.renderer(),llx=0,lly=m_this.height(),urx=m_this.width(),ury=0,temp=null,tile=null,tile1x=null,tile1y=null,tile2x=null,tile2y=null,invJ=null,i=0,j=0,worldPt1=ren.displayToWorld([llx,lly]),worldPt2=ren.displayToWorld([urx,ury]),worldDeltaY=null,displayDeltaY=null,worldDelta=null,displayDelta=null,noOfTilesRequired=null,worldDeltaPerTile=null,minDistWorldDeltaPerTile=null;for(worldPt1[0]=Math.max(worldPt1[0],-180),worldPt1[0]=Math.min(worldPt1[0],180),worldPt1[1]=Math.max(worldPt1[1],-180),worldPt1[1]=Math.min(worldPt1[1],180),worldPt2[0]=Math.max(worldPt2[0],-180),worldPt2[0]=Math.min(worldPt2[0],180),worldPt2[1]=Math.max(worldPt2[1],-180),worldPt2[1]=Math.min(worldPt2[1],180),worldDelta=Math.abs(worldPt2[0]-worldPt1[0]),worldDeltaY=Math.abs(worldPt2[1]-worldPt1[1]),displayDelta=urx-llx,displayDeltaY=lly-ury,displayDeltaY>displayDelta&&(displayDelta=displayDeltaY,worldDelta=worldDeltaY),noOfTilesRequired=Math.round(displayDelta/256),worldDeltaPerTile=worldDelta/noOfTilesRequired,minDistWorldDeltaPerTile=Number.POSITIVE_INFINITY,i=20;i>=2;i-=1)distWorldDeltaPerTile=Math.abs(360/Math.pow(2,i)-worldDeltaPerTile),minDistWorldDeltaPerTile>distWorldDeltaPerTile&&(minDistWorldDeltaPerTile=distWorldDeltaPerTile,m_zoom=i);for(tile1x=geo.mercator.long2tilex(worldPt1[0],m_zoom),tile1y=geo.mercator.lat2tiley(worldPt1[1],m_zoom),tile2x=geo.mercator.long2tilex(worldPt2[0],m_zoom),tile2y=geo.mercator.lat2tiley(worldPt2[1],m_zoom),tile1x=Math.max(tile1x,0),tile1x=Math.min(Math.pow(2,m_zoom)-1,tile1x),tile1y=Math.max(tile1y,0),tile1y=Math.min(Math.pow(2,m_zoom)-1,tile1y),tile2x=Math.max(tile2x,0),tile2x=Math.min(Math.pow(2,m_zoom)-1,tile2x),tile2y=Math.max(tile2y,0),tile2y=Math.min(Math.pow(2,m_zoom)-1,tile2y),tile1x>tile2x&&(temp=tile1x,tile1x=tile2x,tile2x=temp),tile2y>tile1y&&(temp=tile1y,tile1y=tile2y,tile2y=temp),currStartX=tile1x,currEndX=tile2x,currStartY=Math.pow(2,m_zoom)-1-tile1y,currEndY=Math.pow(2,m_zoom)-1-tile2y,currStartY>currEndY&&(temp=currStartY,currStartY=currEndY,currEndY=temp),lastStartX=geo.mercator.long2tilex(worldPt1[0],m_lastVisibleZoom),lastStartY=geo.mercator.lat2tiley(worldPt1[1],m_lastVisibleZoom),lastEndX=geo.mercator.long2tilex(worldPt2[0],m_lastVisibleZoom),lastEndY=geo.mercator.lat2tiley(worldPt2[1],m_lastVisibleZoom),lastStartY=Math.pow(2,m_lastVisibleZoom)-1-lastStartY,lastEndY=Math.pow(2,m_lastVisibleZoom)-1-lastEndY,lastStartY>lastEndY&&(temp=lastStartY,lastStartY=lastEndY,lastEndY=temp),m_visibleTilesRange={},m_visibleTilesRange[m_zoom]={startX:currStartX,endX:currEndX,startY:currStartY,endY:currEndY},m_visibleTilesRange[m_lastVisibleZoom]={startX:lastStartX,endX:lastEndX,startY:lastStartY,endY:lastEndY},m_pendingNewTilesStat[m_updateTimerId]={total:(tile2x-tile1x+1)*(tile1y-tile2y+1),count:0},i=tile1x;tile2x>=i;i+=1)for(j=tile2y;tile1y>=j;j+=1)invJ=Math.pow(2,m_zoom)-1-j,m_this._hasTile(m_zoom,i,invJ)?(tile=m_tiles[m_zoom][i][invJ],tile.feature.bin(m_visibleBinNumber),tile.LOADED&&m_updateTimerId in m_pendingNewTilesStat&&(m_pendingNewTilesStat[m_updateTimerId].count+=1),tile.lastused=new Date,tile.feature._update()):tile=m_this._addTile(request,m_zoom,i,invJ),tile.updateTimerId=m_updateTimerId;for(i=0;i<m_pendingNewTiles.length;i+=1)tile=m_pendingNewTiles[i],feature=m_this.createFeature("plane",{drawOnAsyncResourceLoad:!1,onload:tileOnLoad(tile)}).origin([tile.llx,tile.lly]).upperLeft([tile.llx,tile.ury]).lowerRight([tile.urx,tile.lly]).gcs("EPSG:3857").style({image:tile,opacity:m_mapOpacity}),tile.feature=feature,tile.feature._update();m_pendingNewTiles=[],m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles()},this._updateTiles=function(request){var defer=$.Deferred();return m_this.addDeferred(defer),null!==m_updateTimerId?(clearTimeout(m_updateTimerId),m_updateDefer.resolve(),m_updateDefer=defer,m_updateTimerId in m_pendingNewTilesStat&&delete m_pendingNewTilesStat[m_updateTimerId],m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},100)):(m_updateDefer=defer,
m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},0)),m_this},this._init=function(){return s_init.call(m_this),m_this.gcs("EPSG:3857"),m_this.map().zoomRange({min:0,max:18}),m_this},this._update=function(request){m_this._updateTiles(request),s_update.call(m_this,request)},this.updateBaseUrl=function(baseUrl){if(baseUrl&&"/"!==baseUrl.charAt(m_baseUrl.length-1)&&(baseUrl+="/"),baseUrl!==m_baseUrl){void 0!==baseUrl&&(m_baseUrl=baseUrl);var tile,x,y,zoom;for(zoom in m_tiles)for(x in m_tiles[zoom])for(y in m_tiles[zoom][x])tile=m_tiles[zoom][x][y],tile.INVALID=!0,m_this.deleteFeature(tile.feature);m_tiles={},m_pendingNewTiles=[],m_pendingInactiveTiles=[],m_numberOfCachedTiles=0,m_visibleTilesRange={},m_pendingNewTilesStat={},null!==m_updateTimerId&&(clearTimeout(m_updateTimerId),m_updateTimerId=null),this._update()}},this.mapOpacity=function(val){if(void 0===val)return m_mapOpacity;if(val!==m_mapOpacity){m_mapOpacity=val;var zoom,x,y,tile;for(zoom in m_tiles)for(x in m_tiles[zoom])for(y in m_tiles[zoom][x])tile=m_tiles[zoom][x][y],tile.feature.style().opacity=val,tile.feature._update();m_this.modified()}return m_this},this._exit=function(){m_tiles={},m_pendingNewTiles=[],m_pendingInactiveTiles=[],m_numberOfCachedTiles=0,m_visibleTilesRange={},m_pendingNewTilesStat={},s_exit()},arg&&void 0!==arg.tileUrl&&this.tileUrl(arg.tileUrl),this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),geo.gl={},geo.gl.renderer=function(arg){"use strict";return this instanceof geo.gl.renderer?(geo.renderer.call(this,arg),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new geo.gl.renderer(arg)},inherit(geo.gl.renderer,geo.renderer),geo.gl.lineFeature=function(arg){"use strict";function createVertexShader(){var vertexShaderSource=["#ifdef GL_ES","  precision highp float;","#endif","attribute vec3 pos;","attribute vec3 prev;","attribute vec3 next;","attribute float offset;","attribute vec3 strokeColor;","attribute float strokeOpacity;","attribute float strokeWidth;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float pixelWidth;","uniform float aspect;","varying vec3 strokeColorVar;","varying float strokeWidthVar;","varying float strokeOpacityVar;","void main(void)","{","  if (strokeOpacity < 0.0) {","    gl_Position = vec4(2, 2, 0, 1);","    return;","  }","  const float PI = 3.14159265358979323846264;","  vec4 worldPos = projectionMatrix * modelViewMatrix * vec4(pos.xyz, 1);","  if (worldPos.w != 0.0) {","    worldPos = worldPos/worldPos.w;","  }","  vec4 worldNext = projectionMatrix * modelViewMatrix * vec4(next.xyz, 1);","  if (worldNext.w != 0.0) {","    worldNext = worldNext/worldNext.w;","  }","  vec4 worldPrev = projectionMatrix* modelViewMatrix * vec4(prev.xyz, 1);","  if (worldPrev.w != 0.0) {","    worldPrev = worldPrev/worldPrev.w;","  }","  strokeColorVar = strokeColor;","  strokeWidthVar = strokeWidth;","  strokeOpacityVar = strokeOpacity;","  vec2 deltaNext = worldNext.xy - worldPos.xy;","  vec2 deltaPrev = worldPos.xy - worldPrev.xy;","  float angleNext = 0.0, anglePrev = 0.0;","  if (deltaNext.xy != vec2(0.0, 0.0))","    angleNext = atan(deltaNext.y / aspect, deltaNext.x);","  if (deltaPrev.xy == vec2(0.0, 0.0)) anglePrev = angleNext;","  else  anglePrev = atan(deltaPrev.y / aspect, deltaPrev.x);","  if (deltaNext.xy == vec2(0.0, 0.0)) angleNext = anglePrev;","  float angle = (anglePrev + angleNext) / 2.0;","  float cosAngle = cos(anglePrev - angle);","  if (cosAngle < 0.1) { cosAngle = sign(cosAngle) * 1.0; angle = 0.0; }","  float distance = (offset * strokeWidth * pixelWidth) /","                    cosAngle;","  worldPos.x += distance * sin(angle);","  worldPos.y -= distance * cos(angle) * aspect;","  gl_Position = worldPos;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader}function createFragmentShader(){var fragmentShaderSource=["#ifdef GL_ES","  precision highp float;","#endif","varying vec3 strokeColorVar;","varying float strokeWidthVar;","varying float strokeOpacityVar;","void main () {","  gl_FragColor = vec4 (strokeColorVar, strokeOpacityVar);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader}function createGLLines(){var i,j,k,v,len,lineItem,lineItemData,vertTemp,pos,posIdx3,posBuf,nextBuf,prevBuf,offsetBuf,indicesBuf,strokeWidthBuf,strokeColorBuf,strokeOpacityBuf,dest,dest3,data=m_this.data(),numSegments=0,vert=[{},{}],position=[],posFunc=m_this.position(),strkWidthFunc=m_this.style.get("strokeWidth"),strkColorFunc=m_this.style.get("strokeColor"),strkOpacityFunc=m_this.style.get("strokeOpacity"),order=m_this.featureVertices(),geom=m_mapper.geometryData();for(i=0;i<data.length;i+=1)for(lineItem=m_this.line()(data[i],i),numSegments+=lineItem.length-1,j=0;j<lineItem.length;j+=1)pos=posFunc(lineItem[j],j,lineItem,i),pos instanceof geo.latlng?(position.push(pos.x()),position.push(pos.y()),position.push(0)):(position.push(pos.x),position.push(pos.y),position.push(pos.z||0));for(position=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),position,3),len=numSegments*order.length,posBuf=getBuffer(geom,"pos",3*len),nextBuf=getBuffer(geom,"next",3*len),prevBuf=getBuffer(geom,"prev",3*len),offsetBuf=getBuffer(geom,"offset",1*len),strokeWidthBuf=getBuffer(geom,"strokeWidth",1*len),strokeColorBuf=getBuffer(geom,"strokeColor",3*len),strokeOpacityBuf=getBuffer(geom,"strokeOpacity",1*len),indicesBuf=geom.primitive(0).indices(),indicesBuf instanceof Uint16Array&&indicesBuf.length===len||(indicesBuf=new Uint16Array(len),geom.primitive(0).setIndices(indicesBuf)),i=posIdx3=dest=dest3=0;i<data.length;i+=1)for(lineItem=m_this.line()(data[i],i),j=0;j<lineItem.length;j+=1,posIdx3+=3)if(lineItemData=lineItem[j],j&&(vertTemp=vert[0],vert[0]=vert[1],vert[1]=vertTemp),vert[1].pos=posIdx3,vert[1].prev=posIdx3-(j?3:0),vert[1].next=posIdx3+(j+1<lineItem.length?3:0),vert[1].strokeWidth=strkWidthFunc(lineItemData,j,lineItem,i),vert[1].strokeColor=strkColorFunc(lineItemData,j,lineItem,i),vert[1].strokeOpacity=strkOpacityFunc(lineItemData,j,lineItem,i),j)for(k=0;k<order.length;k+=1,dest+=1,dest3+=3)v=vert[order[k][0]],posBuf[dest3]=position[v.pos],posBuf[dest3+1]=position[v.pos+1],posBuf[dest3+2]=position[v.pos+2],prevBuf[dest3]=position[v.prev],prevBuf[dest3+1]=position[v.prev+1],prevBuf[dest3+2]=position[v.prev+2],nextBuf[dest3]=position[v.next],nextBuf[dest3+1]=position[v.next+1],nextBuf[dest3+2]=position[v.next+2],offsetBuf[dest]=order[k][1],strokeWidthBuf[dest]=v.strokeWidth,strokeColorBuf[dest3]=v.strokeColor.r,strokeColorBuf[dest3+1]=v.strokeColor.g,strokeColorBuf[dest3+2]=v.strokeColor.b,strokeOpacityBuf[dest]=v.strokeOpacity;geom.boundsDirty(!0),m_mapper.modified(),m_mapper.boundsDirtyTimestamp().modified()}function getBuffer(geom,srcName,len){var data,src=geom.sourceByName(srcName);return data=src.data(),data instanceof Float32Array&&data.length===len?data:(data=new Float32Array(len),src.setData(data),data)}if(!(this instanceof geo.gl.lineFeature))return new geo.gl.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg);var m_this=this,s_exit=this._exit,m_actor=null,m_mapper=null,m_material=null,m_pixelWidthUnif=null,m_aspectUniform=null,m_dynamicDraw=void 0===arg.dynamicDraw?!1:arg.dynamicDraw,s_init=this._init,s_update=this._update;return this.featureVertices=function(){return[[0,1],[1,-1],[0,-1],[0,1],[1,1],[1,-1]]},this.verticesPerFeature=function(){return this.featureVertices().length},this._init=function(arg){var prog=vgl.shaderProgram(),vs=createVertexShader(),fs=createFragmentShader(),posAttr=vgl.vertexAttribute("pos"),prvAttr=vgl.vertexAttribute("prev"),nxtAttr=vgl.vertexAttribute("next"),offAttr=vgl.vertexAttribute("offset"),strkWidthAttr=vgl.vertexAttribute("strokeWidth"),strkColorAttr=vgl.vertexAttribute("strokeColor"),strkOpacityAttr=vgl.vertexAttribute("strokeOpacity"),mviUnif=new vgl.modelViewUniform("modelViewMatrix"),prjUnif=new vgl.projectionUniform("projectionMatrix"),geom=vgl.geometryData(),posData=vgl.sourceDataP3fv({name:"pos"}),prvPosData=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Four,{name:"prev"}),nxtPosData=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Five,{name:"next"}),offPosData=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Six,{name:"offset"}),strkWidthData=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.One,{name:"strokeWidth"}),strkColorData=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Two,{name:"strokeColor"}),strkOpacityData=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Three,{name:"strokeOpacity"}),triangles=vgl.triangles();m_pixelWidthUnif=new vgl.floatUniform("pixelWidth",1/m_this.renderer().width()),m_aspectUniform=new vgl.floatUniform("aspect",m_this.renderer().width()/m_this.renderer().height()),s_init.call(m_this,arg),m_material=vgl.material(),m_mapper=vgl.mapper({dynamicDraw:m_dynamicDraw}),prog.addVertexAttribute(posAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(strkWidthAttr,vgl.vertexAttributeKeysIndexed.One),prog.addVertexAttribute(strkColorAttr,vgl.vertexAttributeKeysIndexed.Two),prog.addVertexAttribute(strkOpacityAttr,vgl.vertexAttributeKeysIndexed.Three),prog.addVertexAttribute(prvAttr,vgl.vertexAttributeKeysIndexed.Four),prog.addVertexAttribute(nxtAttr,vgl.vertexAttributeKeysIndexed.Five),prog.addVertexAttribute(offAttr,vgl.vertexAttributeKeysIndexed.Six),prog.addUniform(mviUnif),prog.addUniform(prjUnif),prog.addUniform(m_pixelWidthUnif),prog.addUniform(m_aspectUniform),prog.addShader(fs),prog.addShader(vs),m_material.addAttribute(prog),m_material.addAttribute(vgl.blend()),m_actor=vgl.actor(),m_actor.setMaterial(m_material),m_actor.setMapper(m_mapper),geom.addSource(posData),geom.addSource(prvPosData),geom.addSource(nxtPosData),geom.addSource(strkWidthData),geom.addSource(strkColorData),geom.addSource(strkOpacityData),geom.addSource(offPosData),geom.addPrimitive(triangles),m_mapper.setGeometryData(geom)},this.actors=function(){return m_actor?[m_actor]:[]},this._build=function(){m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),createGLLines(),m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){s_update.call(m_this),(m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()||m_this.updateTime().getMTime()<=m_this.getMTime())&&m_this._build(),m_pixelWidthUnif.set(1/m_this.renderer().width()),m_aspectUniform.set(m_this.renderer().width()/m_this.renderer().height()),m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor),s_exit()},this._init(arg),this},inherit(geo.gl.lineFeature,geo.lineFeature),geo.registerFeature("vgl","line",geo.gl.lineFeature),geo.gl.pointFeature=function(arg){"use strict";function createVertexShader(){var shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader}function createFragmentShader(){var shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader}function pointPolygon(x,y,w,h){var verts;switch(m_primitiveShape){case"triangle":verts=[x,y-2*h,x-w*Math.sqrt(3),y+h,x+w*Math.sqrt(3),y+h];break;case"sprite":verts=[x,y];break;default:verts=[x-w,y+h,x-w,y-h,x+w,y+h,x-w,y-h,x+w,y-h,x+w,y+h]}return verts}function createGLPoints(){var i,j,posBuf,posVal,posFunc,unitBuf,indices,radius,radiusVal,radFunc,stroke,strokeVal,strokeFunc,strokeWidth,strokeWidthVal,strokeWidthFunc,strokeOpacity,strokeOpacityVal,strokeOpactityFunc,strokeColor,strokeColorVal,strokeColorFunc,fill,fillVal,fillFunc,fillOpacity,fillOpacityVal,fillOpacityFunc,fillColor,fillColorVal,fillColorFunc,item,ivpf,ivpf3,iunit,i3,numPts=m_this.data().length,unit=pointPolygon(0,0,1,1),position=new Array(3*numPts),vpf=m_this.verticesPerFeature(),data=m_this.data(),geom=m_mapper.geometryData();for(posFunc=m_this.position(),radFunc=m_this.style.get("radius"),strokeFunc=m_this.style.get("stroke"),strokeWidthFunc=m_this.style.get("strokeWidth"),strokeOpactityFunc=m_this.style.get("strokeOpacity"),strokeColorFunc=m_this.style.get("strokeColor"),fillFunc=m_this.style.get("fill"),fillOpacityFunc=m_this.style.get("fillOpacity"),fillColorFunc=m_this.style.get("fillColor"),i=i3=0;numPts>i;i+=1,i3+=3)posVal=posFunc(data[i]),position[i3]=posVal.x,position[i3+1]=posVal.y,position[i3+2]=posVal.z||0;for(position=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),position,3),posBuf=getBuffer(geom,"pos",vpf*numPts*3),"sprite"!==m_primitiveShape&&(unitBuf=getBuffer(geom,"unit",vpf*numPts*2)),radius=getBuffer(geom,"rad",vpf*numPts*1),stroke=getBuffer(geom,"stroke",vpf*numPts*1),strokeWidth=getBuffer(geom,"strokeWidth",vpf*numPts*1),strokeOpacity=getBuffer(geom,"strokeOpacity",vpf*numPts*1),strokeColor=getBuffer(geom,"strokeColor",vpf*numPts*3),fill=getBuffer(geom,"fill",vpf*numPts*1),fillOpacity=getBuffer(geom,"fillOpacity",vpf*numPts*1),fillColor=getBuffer(geom,"fillColor",vpf*numPts*3),indices=geom.primitive(0).indices(),indices instanceof Uint16Array&&indices.length===vpf*numPts||(indices=new Uint16Array(vpf*numPts),geom.primitive(0).setIndices(indices)),i=ivpf=ivpf3=iunit=i3=0;numPts>i;i+=1,i3+=3){if(item=data[i],"sprite"!==m_primitiveShape)for(j=0;j<unit.length;j+=1,iunit+=1)unitBuf[iunit]=unit[j];for(radiusVal=radFunc(item),strokeVal=strokeFunc(item)?1:0,strokeWidthVal=strokeWidthFunc(item),strokeOpacityVal=strokeOpactityFunc(item),strokeColorVal=strokeColorFunc(item),fillVal=fillFunc(item)?1:0,fillOpacityVal=fillOpacityFunc(item),fillColorVal=fillColorFunc(item),j=0;vpf>j;j+=1,ivpf+=1,ivpf3+=3)posBuf[ivpf3]=position[i3],posBuf[ivpf3+1]=position[i3+1],posBuf[ivpf3+2]=position[i3+2],radius[ivpf]=radiusVal,stroke[ivpf]=strokeVal,strokeWidth[ivpf]=strokeWidthVal,strokeOpacity[ivpf]=strokeOpacityVal,strokeColor[ivpf3]=strokeColorVal.r,strokeColor[ivpf3+1]=strokeColorVal.g,strokeColor[ivpf3+2]=strokeColorVal.b,fill[ivpf]=fillVal,fillOpacity[ivpf]=fillOpacityVal,fillColor[ivpf3]=fillColorVal.r,fillColor[ivpf3+1]=fillColorVal.g,fillColor[ivpf3+2]=fillColorVal.b}geom.boundsDirty(!0),m_mapper.modified(),m_mapper.boundsDirtyTimestamp().modified()}function getBuffer(geom,srcName,len){var data,src=geom.sourceByName(srcName);return data=src.data(),data instanceof Float32Array&&data.length===len?data:(data=new Float32Array(len),src.setData(data),data)}if(!(this instanceof geo.gl.pointFeature))return new geo.gl.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg);var m_this=this,s_exit=this._exit,m_actor=null,m_mapper=null,m_pixelWidthUniform=null,m_aspectUniform=null,m_dynamicDraw=void 0===arg.dynamicDraw?!1:arg.dynamicDraw,m_primitiveShape="sprite",s_init=this._init,s_update=this._update,vertexShaderSource=null,fragmentShaderSource=null;return("triangle"===arg.primitiveShape||"square"===arg.primitiveShape||"sprite"===arg.primitiveShape)&&(m_primitiveShape=arg.primitiveShape),vertexShaderSource=["#ifdef GL_ES","  precision highp float;","#endif","attribute vec3 pos;","attribute float rad;","attribute vec3 fillColor;","attribute vec3 strokeColor;","attribute float fillOpacity;","attribute float strokeWidth;","attribute float strokeOpacity;","attribute float fill;","attribute float stroke;","uniform float pixelWidth;","uniform float aspect;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","varying vec4 fillColorVar;","varying vec4 strokeColorVar;","varying float radiusVar;","varying float strokeWidthVar;","varying float fillVar;","varying float strokeVar;"],"sprite"!==m_primitiveShape&&(vertexShaderSource=vertexShaderSource.concat(["attribute vec2 unit;","varying vec3 unitVar;"])),vertexShaderSource.push.apply(vertexShaderSource,["void main(void)","{","  strokeWidthVar = strokeWidth;","  // No stroke or fill implies nothing to draw","  if (stroke < 1.0 || strokeWidth <= 0.0 || strokeOpacity <= 0.0) {","    strokeVar = 0.0;","    strokeWidthVar = 0.0;","  }","  else","    strokeVar = 1.0;","  if (fill < 1.0 || rad <= 0.0 || fillOpacity <= 0.0)","    fillVar = 0.0;","  else","    fillVar = 1.0;","  if (fillVar == 0.0 && strokeVar == 0.0) {","    gl_Position = vec4(2, 2, 0, 1);","    return;","  }","  fillColorVar = vec4 (fillColor, fillOpacity);","  strokeColorVar = vec4 (strokeColor, strokeOpacity);","  radiusVar = rad;"]),"sprite"===m_primitiveShape?vertexShaderSource.push.apply(vertexShaderSource,["  gl_Position = (projectionMatrix * modelViewMatrix * vec4(pos, 1.0)).xyzw;","  gl_PointSize = 2.0 * (rad + strokeWidthVar); ","}"]):vertexShaderSource.push.apply(vertexShaderSource,["  unitVar = vec3 (unit, 1.0);","  vec4 p = (projectionMatrix * modelViewMatrix * vec4(pos, 1.0)).xyzw;","  if (p.w != 0.0) {","    p = p / p.w;","  }","  p += (rad + strokeWidthVar) * ","       vec4 (unit.x * pixelWidth, unit.y * pixelWidth * aspect, 0.0, 1.0);","  gl_Position = vec4(p.xyz, 1.0);","}"]),vertexShaderSource=vertexShaderSource.join("\n"),fragmentShaderSource=["#ifdef GL_ES","  precision highp float;","#endif","uniform float aspect;","varying vec4 fillColorVar;","varying vec4 strokeColorVar;","varying float radiusVar;","varying float strokeWidthVar;","varying float fillVar;","varying float strokeVar;"],"sprite"!==m_primitiveShape&&fragmentShaderSource.push("varying vec3 unitVar;"),fragmentShaderSource.push.apply(fragmentShaderSource,["void main () {","  vec4 strokeColor, fillColor;","  float endStep;","  // No stroke or fill implies nothing to draw","  if (fillVar == 0.0 && strokeVar == 0.0)","    discard;"]),fragmentShaderSource.push("sprite"===m_primitiveShape?"  float rad = 2.0 * length (gl_PointCoord - vec2(0.5));":"  float rad = length (unitVar.xy);"),fragmentShaderSource.push.apply(fragmentShaderSource,["  if (rad > 1.0)","    discard;","  // If there is no stroke, the fill region should transition to nothing","  if (strokeVar == 0.0) {","    strokeColor = vec4 (fillColorVar.rgb, 0.0);","    endStep = 1.0;","  } else {","    strokeColor = strokeColorVar;","    endStep = radiusVar / (radiusVar + strokeWidthVar);","  }","  // Likewise, if there is no fill, the stroke should transition to nothing","  if (fillVar == 0.0)","    fillColor = vec4 (strokeColor.rgb, 0.0);","  else","    fillColor = fillColorVar;","  // Distance to antialias over","  float antialiasDist = 3.0 / (2.0 * radiusVar);","  if (rad < endStep) {","    float step = smoothstep (endStep - antialiasDist, endStep, rad);","    gl_FragColor = mix (fillColor, strokeColor, step);","  } else {","    float step = smoothstep (1.0 - antialiasDist, 1.0, rad);","    gl_FragColor = mix (strokeColor, vec4 (strokeColor.rgb, 0.0), step);","  }","}"]),fragmentShaderSource=fragmentShaderSource.join("\n"),this.actors=function(){return m_actor?[m_actor]:[]},this.verticesPerFeature=function(){var unit=pointPolygon(0,0,1,1);return unit.length/2},this._init=function(){var prog=vgl.shaderProgram(),vertexShader=createVertexShader(),fragmentShader=createFragmentShader(),posAttr=vgl.vertexAttribute("pos"),unitAttr=vgl.vertexAttribute("unit"),radAttr=vgl.vertexAttribute("rad"),strokeWidthAttr=vgl.vertexAttribute("strokeWidth"),fillColorAttr=vgl.vertexAttribute("fillColor"),fillAttr=vgl.vertexAttribute("fill"),strokeColorAttr=vgl.vertexAttribute("strokeColor"),strokeAttr=vgl.vertexAttribute("stroke"),fillOpacityAttr=vgl.vertexAttribute("fillOpacity"),strokeOpacityAttr=vgl.vertexAttribute("strokeOpacity"),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix"),mat=vgl.material(),blend=vgl.blend(),geom=vgl.geometryData(),sourcePositions=vgl.sourceDataP3fv({name:"pos"}),sourceUnits=vgl.sourceDataAnyfv(2,vgl.vertexAttributeKeysIndexed.One,{name:"unit"}),sourceRadius=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Two,{name:"rad"}),sourceStrokeWidth=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Three,{name:"strokeWidth"}),sourceFillColor=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Four,{name:"fillColor"}),sourceFill=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Five,{name:"fill"}),sourceStrokeColor=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Six,{name:"strokeColor"}),sourceStroke=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Seven,{name:"stroke"}),sourceAlpha=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Eight,{name:"fillOpacity"}),sourceStrokeOpacity=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Nine,{name:"strokeOpacity"}),primitive=new vgl.triangles;"sprite"===m_primitiveShape&&(primitive=new vgl.points),m_pixelWidthUniform=new vgl.floatUniform("pixelWidth",2/m_this.renderer().width()),m_aspectUniform=new vgl.floatUniform("aspect",m_this.renderer().width()/m_this.renderer().height()),s_init.call(m_this,arg),m_mapper=vgl.mapper({dynamicDraw:m_dynamicDraw}),prog.addVertexAttribute(posAttr,vgl.vertexAttributeKeys.Position),"sprite"!==m_primitiveShape&&prog.addVertexAttribute(unitAttr,vgl.vertexAttributeKeysIndexed.One),prog.addVertexAttribute(radAttr,vgl.vertexAttributeKeysIndexed.Two),prog.addVertexAttribute(strokeWidthAttr,vgl.vertexAttributeKeysIndexed.Three),prog.addVertexAttribute(fillColorAttr,vgl.vertexAttributeKeysIndexed.Four),prog.addVertexAttribute(fillAttr,vgl.vertexAttributeKeysIndexed.Five),prog.addVertexAttribute(strokeColorAttr,vgl.vertexAttributeKeysIndexed.Six),prog.addVertexAttribute(strokeAttr,vgl.vertexAttributeKeysIndexed.Seven),prog.addVertexAttribute(fillOpacityAttr,vgl.vertexAttributeKeysIndexed.Eight),prog.addVertexAttribute(strokeOpacityAttr,vgl.vertexAttributeKeysIndexed.Nine),prog.addUniform(m_pixelWidthUniform),prog.addUniform(m_aspectUniform),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),mat.addAttribute(prog),mat.addAttribute(blend),m_actor=vgl.actor(),m_actor.setMaterial(mat),m_actor.setMapper(m_mapper),geom.addSource(sourcePositions),geom.addSource(sourceUnits),geom.addSource(sourceRadius),geom.addSource(sourceStrokeWidth),geom.addSource(sourceFillColor),geom.addSource(sourceFill),geom.addSource(sourceStrokeColor),geom.addSource(sourceStroke),geom.addSource(sourceAlpha),geom.addSource(sourceStrokeOpacity),geom.addPrimitive(primitive),m_mapper.setGeometryData(geom)},this._build=function(){m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),createGLPoints(),m_this.renderer().contextRenderer().addActor(m_actor),m_this.renderer().contextRenderer().render(),m_this.buildTime().modified()},this._update=function(){s_update.call(m_this),(m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()||m_this.updateTime().getMTime()<m_this.getMTime())&&m_this._build(),m_pixelWidthUniform.set(2/m_this.renderer().width()),m_aspectUniform.set(m_this.renderer().width()/m_this.renderer().height()),m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor),s_exit()},m_this._init(),this},inherit(geo.gl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",geo.gl.pointFeature),geo.gl.geomFeature=function(arg){"use strict";if(!(this instanceof geo.gl.geomFeature))return new geo.gl.geomFeature(arg);arg=arg||{},geo.geomFeature.call(this,arg);var m_this=this,m_geom=arg.geom||null,m_actor=vgl.actor(),m_mapper=vgl.mapper(),m_material=null,m_scalar=null,m_color=arg.color||[1,1,1],m_buildTime=null,m_noOfPrimitives=0;return this._build=function(){var style=m_this.style();null!==m_geom&&(m_scalar=m_geom.sourceData(vgl.vertexAttributeKeys.Scalar),m_color=m_geom.sourceData(vgl.vertexAttributeKeys.Color),m_mapper.setGeometryData(m_geom)),this.setMapper(m_mapper),void 0!==style.point_sprites&&style.point_sprites&&void 0!==style.point_sprites_image&&null!==style.point_sprites_image&&1===m_noOfPrimitives&&m_geom.primitive(0).primitiveType()===gl.POINTS?m_material=vgl.utils.createPointSpritesMaterial(style.point_sprites_image):m_scalar?m_color instanceof vgl.lookupTable?(m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):(m_color=vgl.lookupTable(),m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):m_material=m_color?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),m_actor.setMaterial(m_material)},this._update=function(){m_buildTime&&m_buildTime.getMTime()<m_this.getMTime()?m_color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color):(m_buildTime=vgl.timestamp(),m_buildTime.modified())},this.geometry=function(val){return void 0===val?m_geom:(m_geom=val,m_this.modified(),m_this)},this},inherit(geo.gl.geomFeature,geo.geomFeature),geo.gl.planeFeature=function(arg){"use strict";if(!(this instanceof geo.gl.planeFeature))return new geo.gl.planeFeature(arg);geo.planeFeature.call(this,arg);var m_this=this,s_exit=this._exit,m_actor=null,m_onloadCallback=void 0===arg.onload?null:arg.onload;return this.coords=function(){return[m_this.origin(),m_this.upperLeft(),m_this.lowerRight()]},this._build=function(){var or=m_this.origin(),ul=m_this.upperLeft(),lr=m_this.lowerRight(),img=m_this.style().image,image=null,texture=null;or=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),or),ul=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),ul),lr=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),lr),m_this.buildTime().modified(),m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),img&&img instanceof Image?image=img:img&&(image=new Image,image.src=img),image?(m_actor=vgl.utils.createTexturePlane(or[0],or[1],or[2],lr[0],lr[1],lr[2],ul[0],ul[1],ul[2],!0),m_actor.material().shaderProgram().uniform("opacity").set(void 0!==m_this.style().opacity?m_this.style().opacity:1),texture=vgl.texture(),m_this.visible(!1),m_this.renderer().contextRenderer().addActor(m_actor),image.complete?(texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this)):image.onload=function(){texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this),m_this.drawOnAsyncResourceLoad()&&(m_this._update(),m_this.layer().draw())}):(m_actor=vgl.utils.createPlane(or[0],or[1],or[2],ul[0],ul[1],ul[2],lr[0],lr[1],lr[2]),m_actor.material().shaderProgram().uniform("opacity").set(void 0!==m_this.style().opacity?m_this.style().opacity:1),m_this.renderer().contextRenderer().addActor(m_actor))},this._update=function(){m_this.buildTime().getMTime()<=m_this.dataTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime()&&(m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),m_actor.material().shaderProgram().uniform("opacity").set(void 0!==m_this.style().opacity?m_this.style().opacity:1)),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor),s_exit()},this},inherit(geo.gl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",geo.gl.planeFeature),geo.gl.polygonFeature=function(arg){"use strict";function createVertexShader(){var vertexShaderSource=["attribute vec3 pos;","attribute vec3 fillColor;","attribute float fillOpacity;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float pixelWidth;","varying vec3 fillColorVar;","varying float fillOpacityVar;","void main(void)","{","  vec4 clipPos = projectionMatrix * modelViewMatrix * vec4(pos.xyz, 1);","  if (clipPos.w != 0.0) {","    clipPos = clipPos/clipPos.w;","  }","  fillColorVar = fillColor;","  fillOpacityVar = fillOpacity;","  gl_Position = clipPos;","}"].join("\n"),shader=new vgl.shader(gl.VERTEX_SHADER);return shader.setShaderSource(vertexShaderSource),shader}function createFragmentShader(){var fragmentShaderSource=["#ifdef GL_ES","  precision highp float;","#endif","varying vec3 fillColorVar;","varying float fillOpacityVar;","void main () {","  gl_FragColor = vec4 (fillColorVar, fillOpacityVar);","}"].join("\n"),shader=new vgl.shader(gl.FRAGMENT_SHADER);return shader.setShaderSource(fragmentShaderSource),shader}function createGLPolygons(){var i=null,numPts=null,start=null,itemIndex=0,polygonItemCoordIndex=0,position=[],fillColor=[],fillOpacity=[],fillColorNew=[],fillOpacityNew=[],posFunc=null,fillColorFunc=null,polygonItem=null,fillOpacityFunc=null,buffers=vgl.DataBuffers(1024),sourcePositions=vgl.sourceDataP3fv(),sourceFillColor=vgl.sourceDataAnyfv(3,vgl.vertexAttributeKeysIndexed.Two),sourceFillOpacity=vgl.sourceDataAnyfv(1,vgl.vertexAttributeKeysIndexed.Three),trianglePrimitive=vgl.triangles(),geom=vgl.geometryData(),polygon=null,holes=null,extRing=null,extIndex=0,extLength=null,intIndex=0,posInstance=null,triangulator=new PNLTRI.Triangulator,triangList=null,newTriangList=null,fillColorInstance=null,currentIndex=null;for(posFunc=m_this.position(),fillColorFunc=m_this.style.get("fillColor"),fillOpacityFunc=m_this.style.get("fillOpacity"),m_this.data().forEach(function(item){for(polygon=m_this.polygon()(item,itemIndex),polygonItem=polygon.outer||[],holes=polygon.inner||[],polygonItemCoordIndex=0,extRing=[],extIndex=0,extLength=polygonItem.length-1,extRing[0]=[],intIndex=0,polygonItem.forEach(function(extRingCoords){extIndex!==extLength&&(posInstance=posFunc(extRingCoords,polygonItemCoordIndex,item,itemIndex),extRing[0].push(posInstance instanceof geo.latlng?{x:posInstance.x(),y:posInstance.y(),i:fillColor.length}:{x:posInstance.x,y:posInstance.y,i:fillColor.length}),fillColorInstance=fillColorFunc(extRingCoords,polygonItemCoordIndex,item,itemIndex),fillColor.push([fillColorInstance.r,fillColorInstance.g,fillColorInstance.b]),fillOpacity.push(fillOpacityFunc(extRingCoords,polygonItemCoordIndex,item,itemIndex)),polygonItemCoordIndex+=1),extIndex+=1}),polygonItemCoordIndex=0,holes.forEach(function(hole){extRing[intIndex+1]=[],hole.forEach(function(intRingCoords){posInstance=posFunc(intRingCoords,polygonItemCoordIndex,item,itemIndex),extRing[intIndex+1].push(posInstance instanceof geo.latlng?{x:posInstance.x(),y:posInstance.y(),i:fillColor.length}:{x:posInstance.x,y:posInstance.y,i:fillColor.length}),fillColorInstance=fillColorFunc(intRingCoords,polygonItemCoordIndex,item,itemIndex),fillColor.push([fillColorInstance.r,fillColorInstance.g,fillColorInstance.b]),fillOpacity.push(fillOpacityFunc(intRingCoords,polygonItemCoordIndex,item,itemIndex)),polygonItemCoordIndex+=1}),intIndex+=1}),triangList=triangulator.triangulate_polygon(extRing),newTriangList=[],triangList.forEach(function(newIndices){Array.prototype.push.apply(newTriangList,newIndices)}),i=1;i<extRing.length;i+=1)extRing[0]=extRing[0].concat(extRing[i]);newTriangList.forEach(function(polygonIndex){var polygonItemCoords=extRing[0][polygonIndex];position.push([polygonItemCoords.x,polygonItemCoords.y,polygonItemCoords.z||0]),fillColorNew.push(fillColor[polygonItemCoords.i]),fillOpacityNew.push(fillOpacity[polygonItemCoords.i])}),itemIndex+=1}),position=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),position,3),buffers.create("pos",3),buffers.create("indices",1),buffers.create("fillColor",3),buffers.create("fillOpacity",1),numPts=position.length,start=buffers.alloc(numPts),currentIndex=start,i=0;numPts>i;i+=1)buffers.write("pos",position[i],start+i,1),buffers.write("indices",[i],start+i,1),buffers.write("fillColor",fillColorNew[i],start+i,1),buffers.write("fillOpacity",[fillOpacityNew[i]],start+i,1);sourcePositions.pushBack(buffers.get("pos")),geom.addSource(sourcePositions),sourceFillColor.pushBack(buffers.get("fillColor")),geom.addSource(sourceFillColor),sourceFillOpacity.pushBack(buffers.get("fillOpacity")),geom.addSource(sourceFillOpacity),trianglePrimitive.setIndices(buffers.get("indices")),
geom.addPrimitive(trianglePrimitive),m_mapper.setGeometryData(geom)}if(!(this instanceof geo.gl.polygonFeature))return new geo.gl.polygonFeature(arg);arg=arg||{},geo.polygonFeature.call(this,arg);var m_this=this,s_exit=this._exit,m_actor=vgl.actor(),m_mapper=vgl.mapper(),m_material=vgl.material(),s_init=this._init,s_update=this._update;return this._init=function(arg){var blend=vgl.blend(),prog=vgl.shaderProgram(),posAttr=vgl.vertexAttribute("pos"),fillColorAttr=vgl.vertexAttribute("fillColor"),fillOpacityAttr=vgl.vertexAttribute("fillOpacity"),modelViewUniform=new vgl.modelViewUniform("modelViewMatrix"),projectionUniform=new vgl.projectionUniform("projectionMatrix"),vertexShader=createVertexShader(),fragmentShader=createFragmentShader();s_init.call(m_this,arg),prog.addVertexAttribute(posAttr,vgl.vertexAttributeKeys.Position),prog.addVertexAttribute(fillColorAttr,vgl.vertexAttributeKeysIndexed.Two),prog.addVertexAttribute(fillOpacityAttr,vgl.vertexAttributeKeysIndexed.Three),prog.addUniform(modelViewUniform),prog.addUniform(projectionUniform),prog.addShader(fragmentShader),prog.addShader(vertexShader),m_material.addAttribute(prog),m_material.addAttribute(blend),m_actor.setMapper(m_mapper),m_actor.setMaterial(m_material)},this._build=function(){m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),createGLPolygons(),m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){s_update.call(m_this),(m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()||m_this.updateTime().getMTime()<=m_this.getMTime())&&m_this._build(),m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor),s_exit()},this._init(arg),this},inherit(geo.gl.polygonFeature,geo.polygonFeature),geo.registerFeature("vgl","polygon",geo.gl.polygonFeature),geo.gl._vglViewerInstances={viewers:[],maps:[]},geo.gl.vglViewerInstance=function(map){"use strict";function makeViewer(){canvas=$(document.createElement("canvas")),canvas.attr("class","webgl-canvas");var viewer=vgl.viewer(canvas.get(0));return viewer.renderWindow().removeRenderer(viewer.renderWindow().activeRenderer()),viewer.init(),viewer}var mapIdx,canvas,maps=geo.gl._vglViewerInstances.maps,viewers=geo.gl._vglViewerInstances.viewers;for(mapIdx=0;mapIdx<maps.length&&map!==maps[mapIdx];mapIdx+=1);return map!==maps[mapIdx]&&(maps[mapIdx]=map,viewers[mapIdx]=makeViewer()),viewers[mapIdx]._exit=function(){canvas&&(canvas.off(),canvas.remove())},viewers[mapIdx]},geo.gl.vglViewerInstance.deleteCache=function(viewer){"use strict";var mapIdx,maps=geo.gl._vglViewerInstances.maps,viewers=geo.gl._vglViewerInstances.viewers;for(mapIdx=0;mapIdx<viewers.length;mapIdx+=1)(void 0===viewer||viewer===viewers[mapIdx])&&(viewer._exit(),maps.splice(mapIdx,1),viewers.splice(mapIdx,1))},geo.gl.vglRenderer=function(arg){"use strict";if(!(this instanceof geo.gl.vglRenderer))return new geo.gl.vglRenderer(arg);geo.gl.renderer.call(this,arg);var m_this=this,s_exit=this._exit,m_viewer=geo.gl.vglViewerInstance(this.layer().map()),m_contextRenderer=vgl.renderer(),m_width=0,m_height=0,s_init=this._init;return m_contextRenderer.setResetScene(!1),this.width=function(){return m_width},this.height=function(){return m_height},this.displayToWorld=function(input){var i,delta,output,temp,point,ren=m_this.contextRenderer(),cam=ren.camera(),fdp=ren.focusDisplayPoint();if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point.x,point.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push({x:temp[0],y:temp[1],z:temp[2],w:temp[3]});else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point[0],point[1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp);else for(delta=input.length%3===0?3:2,i=0;i<input.length;i+=delta)temp=ren.displayToWorld(vec4.fromValues(input[i],input[i+1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]),output.push(temp[3]);else{if(!(input instanceof Object))throw"Display to world conversion requires array of 2D/3D points";output={},temp=ren.displayToWorld(vec4.fromValues(input.x,input.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2],w:temp[3]}}return output},this.worldToDisplay=function(input){var i,temp,delta,ren=m_this.contextRenderer(),cam=ren.camera(),fp=cam.focalPoint(),output=[];if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i].x,input[i].y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i]={x:temp[0],y:temp[1],z:temp[2]};else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i][0],input[i][1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i].push(temp);else if(delta=input.length%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],input[i+2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else{if(!(input instanceof Object))throw"World to display conversion requires array of 2D/3D points";temp=ren.worldToDisplay(vec4.fromValues(input.x,input.y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2]}}return output},this.contextRenderer=function(){return m_contextRenderer},this.api=function(){return"vgl"},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.canvas($(m_viewer.canvas())),m_viewer.renderWindow().renderers().length>0&&(m_contextRenderer.setLayer(m_viewer.renderWindow().renderers().length),m_contextRenderer.setResetScene(!1)),m_viewer.renderWindow().addRenderer(m_contextRenderer),m_this.layer().node().append(m_this.canvas()),m_this)},this._resize=function(x,y,w,h){return m_width=w,m_height=h,m_this.canvas().attr("width",w),m_this.canvas().attr("height",h),m_viewer.renderWindow().positionAndResize(x,y,w,h),m_this._render(),m_this},this._render=function(){return m_viewer.render(),m_this},this._exit=function(){geo.gl.vglViewerInstance.deleteCache(m_viewer),s_exit()},this._updateRendererCamera=function(){var pos,fp,cr,vglRenderer=m_this.contextRenderer(),renderWindow=m_viewer.renderWindow(),camera=vglRenderer.camera();vglRenderer.resetCameraClippingRange(),pos=camera.position(),fp=camera.focalPoint(),cr=camera.clippingRange(),renderWindow.renderers().forEach(function(renderer){var cam=renderer.camera();cam!==camera&&(cam.setPosition(pos[0],pos[1],pos[2]),cam.setFocalPoint(fp[0],fp[1],fp[2]),cam.setClippingRange(cr[0],cr[1]),renderer.render())})},this.geoOn(geo.event.pan,function(evt){var camera,focusPoint,centerDisplay,centerGeo,newCenterDisplay,newCenterGeo,renderWindow,vglRenderer=m_this.contextRenderer(),layer=m_this.layer();layer.map().baseLayer()===layer&&(vglRenderer&&vglRenderer.camera()||console.log("Pan event triggered on unconnected vgl renderer."),renderWindow=m_viewer.renderWindow(),camera=vglRenderer.camera(),focusPoint=renderWindow.focusDisplayPoint(),centerDisplay=[m_width/2,m_height/2,0],centerGeo=renderWindow.displayToWorld(centerDisplay[0],centerDisplay[1],focusPoint,vglRenderer),newCenterDisplay=[centerDisplay[0]+evt.screenDelta.x,centerDisplay[1]+evt.screenDelta.y],newCenterGeo=renderWindow.displayToWorld(newCenterDisplay[0],newCenterDisplay[1],focusPoint,vglRenderer),camera.pan(centerGeo[0]-newCenterGeo[0],centerGeo[1]-newCenterGeo[1],centerGeo[2]-newCenterGeo[2]),evt.center={x:newCenterGeo[0],y:newCenterGeo[1],z:newCenterGeo[2]},m_this._updateRendererCamera())}),this.geoOn(geo.event.zoom,function(evt){var camera,renderWindow,center,dir,focusPoint,position,newZ,vglRenderer=m_this.contextRenderer(),layer=m_this.layer();layer.map().baseLayer()===layer&&(vglRenderer&&vglRenderer.camera()||console.log("Zoom event triggered on unconnected vgl renderer."),renderWindow=m_viewer.renderWindow(),camera=vglRenderer.camera(),focusPoint=camera.focalPoint(),position=camera.position(),newZ=360*Math.pow(2,-evt.zoomLevel),evt.pan=null,evt.screenPosition&&(center=renderWindow.displayToWorld(evt.screenPosition.x,evt.screenPosition.y,focusPoint,vglRenderer),dir=[center[0]-position[0],center[1]-position[1],center[2]-position[2]],evt.center=layer.fromLocal({x:position[0]+dir[0]*(1-newZ/position[2]),y:position[1]+dir[1]*(1-newZ/position[2])})),camera.setPosition(position[0],position[1],360*Math.pow(2,-evt.zoomLevel)),m_this._updateRendererCamera())}),this},inherit(geo.gl.vglRenderer,geo.gl.renderer),geo.registerRenderer("vgl",geo.gl.vglRenderer),geo.d3={},function(){"use strict";var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",strLength=8;geo.d3.uniqueID=function(){var i,strArray=[];for(strArray.length=strLength,i=0;strLength>i;i+=1)strArray[i]=chars.charAt(Math.floor(Math.random()*chars.length));return strArray.join("")},geo.event.d3Rescale="geo_d3_rescale"}(),geo.d3.object=function(arg){"use strict";if(!(this instanceof geo.object))return new geo.d3.object(arg);geo.sceneObject.call(this);var m_id="d3-"+geo.d3.uniqueID(),s_exit=this._exit,m_this=this,s_draw=this.draw;return this._d3id=function(){return m_id},this.select=function(){return m_this.renderer().select(m_this._d3id())},this.draw=function(){return m_this._update(),s_draw(),m_this},this._exit=function(){m_this.renderer()._removeFeature(m_this._d3id()),s_exit()},this},inherit(geo.d3.object,geo.sceneObject),geo.d3.pointFeature=function(arg){"use strict";if(!(this instanceof geo.d3.pointFeature))return new geo.d3.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg),geo.d3.object.call(this);var m_sticky,m_this=this,s_init=this._init,s_update=this._update,m_buildTime=geo.timestamp(),m_style={};return this._init=function(arg){return s_init.call(m_this,arg),m_sticky=m_this.layer().sticky(),m_this},this._build=function(){var data=m_this.data(),s_style=m_this.style.get(),m_renderer=m_this.renderer(),pos_func=m_this.position();return s_update.call(m_this),data||(data=[]),m_style.id=m_this._d3id(),m_style.data=data,m_style.append="circle",m_style.attributes={r:m_renderer._convertScale(s_style.radius),cx:function(d){return m_renderer.worldToDisplay(pos_func(d)).x},cy:function(d){return m_renderer.worldToDisplay(pos_func(d)).y}},m_style.style=s_style,m_style.classes=["d3PointFeature"],m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},this._init(arg),this},inherit(geo.d3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",geo.d3.pointFeature),geo.d3.lineFeature=function(arg){"use strict";if(!(this instanceof geo.d3.lineFeature))return new geo.d3.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg),geo.d3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update;return this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var data=m_this.data()||[],s_style=m_this.style(),m_renderer=m_this.renderer(),pos_func=m_this.position(),line=d3.svg.line().x(function(d){return m_renderer.worldToDisplay(d).x}).y(function(d){return m_renderer.worldToDisplay(d).y});return s_update.call(m_this),s_style.fill=function(){return!1},data.forEach(function(item,idx){function wrapStyle(func){return geo.util.isFunction(func)?function(){return func(ln[0],0,item,idx)}:func}var m_style,key,ln=m_this.line()(item,idx),style={};for(key in s_style)s_style.hasOwnProperty(key)&&(style[key]=wrapStyle(s_style[key]));m_style={data:[ln.map(function(d,i){return pos_func(d,i,item,idx)})],append:"path",attributes:{d:line},id:m_this._d3id()+idx,classes:["d3LineFeature","d3SubLine-"+idx],style:style},m_renderer._drawFeatures(m_style)}),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},this._init(arg),this},inherit(geo.d3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",geo.d3.lineFeature),geo.d3.pathFeature=function(arg){"use strict";if(!(this instanceof geo.d3.pathFeature))return new geo.d3.pathFeature(arg);arg=arg||{},geo.pathFeature.call(this,arg),geo.d3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update,m_style={};return m_style.style={},this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var tmp,diag,data=m_this.data()||[],s_style=m_this.style(),m_renderer=m_this.renderer();return s_update.call(m_this),diag=function(d){var p={source:d.source,target:d.target};return d3.svg.diagonal()(p)},tmp=[],data.forEach(function(d,i){var src,trg;i<data.length-1&&(src=d,trg=data[i+1],tmp.push({source:m_renderer.worldToDisplay(src),target:m_renderer.worldToDisplay(trg)}))}),m_style.data=tmp,m_style.attributes={d:diag},m_style.id=m_this._d3id(),m_style.append="path",m_style.classes=["d3PathFeature"],m_style.style=$.extend({fill:function(){return!1},fillColor:function(){return{r:0,g:0,b:0}}},s_style),m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},this._init(arg),this},inherit(geo.d3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",geo.d3.pathFeature),geo.d3.graphFeature=function(arg){"use strict";var m_this=this;return this instanceof geo.d3.graphFeature?(geo.graphFeature.call(this,arg),this.select=function(){var renderer=m_this.renderer(),selection={},node=m_this.nodeFeature(),links=m_this.linkFeatures();return selection.nodes=renderer.select(node._d3id()),selection.links=links.map(function(link){return renderer.select(link._d3id())}),selection},this):new geo.d3.graphFeature(arg)},inherit(geo.d3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",geo.d3.graphFeature),geo.d3.planeFeature=function(arg){"use strict";function normalize(pt){return Array.isArray(pt)?{x:pt[0],y:pt[1]}:pt instanceof geo.latlng?{x:pt.x(),y:pt.y()}:pt}if(!(this instanceof geo.d3.planeFeature))return new geo.d3.planeFeature(arg);geo.planeFeature.call(this,arg),geo.d3.object.call(this);var m_this=this,m_style={},s_update=this._update,s_init=this._init,m_buildTime=geo.timestamp();return this._build=function(){var origin=normalize(m_this.origin()),ul=normalize(m_this.upperLeft()),lr=normalize(m_this.lowerRight()),renderer=m_this.renderer(),s=m_this.style();return delete s.fill_color,delete s.color,delete s.opacity,s.screenCoordinates||(origin=renderer.worldToDisplay(origin),ul=renderer.worldToDisplay(ul),lr=renderer.worldToDisplay(lr)),m_style.id=m_this._d3id(),m_style.style=s,m_style.attributes={x:ul.x,y:ul.y,width:lr.x-origin.x,height:origin.y-ul.y},m_style.append="rect",m_style.data=[0],m_style.classes=["d3PlaneFeature"],renderer._drawFeatures(m_style),m_buildTime.modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},this._init=function(arg){return s_init.call(m_this,arg||{}),m_this.style({stroke:function(){return!1},fill:function(){return!0},fillColor:function(){return{r:.3,g:.3,b:.3}},fillOpacity:function(){return.5}}),m_this},this._init(),this},inherit(geo.d3.planeFeature,geo.planeFeature),geo.registerFeature("d3","plane",geo.d3.planeFeature),geo.d3.vectorFeature=function(arg){"use strict";function markerID(d,i){return m_this._d3id()+"_marker_"+i}function updateMarkers(data,stroke,opacity){var renderer=m_this.renderer(),sel=m_this.renderer()._definitions().selectAll("marker.geo-vector").data(data);sel.enter().append("marker").attr("id",markerID).attr("class","geo-vector").attr("viewBox","0 0 10 10").attr("refX","1").attr("refY","5").attr("markerWidth","5").attr("markerHeight","5").attr("orient","auto").append("path").attr("d","M 0 0 L 10 5 L 0 10 z"),sel.exit().remove(),sel.style("stroke",renderer._convertColor(stroke)).style("fill",renderer._convertColor(stroke)).style("opacity",opacity)}if(!(this instanceof geo.d3.vectorFeature))return new geo.d3.vectorFeature(arg);arg=arg||{},geo.vectorFeature.call(this,arg),geo.d3.object.call(this);var m_sticky,m_this=this,s_init=this._init,s_exit=this._exit,s_update=this._update,m_buildTime=geo.timestamp(),m_style={};return this._init=function(arg){return s_init.call(m_this,arg),m_sticky=m_this.layer().sticky(),m_this},this._build=function(){function getScale(){return scale/m_renderer.scaleFactor()}var data=m_this.data(),s_style=m_this.style.get(),m_renderer=m_this.renderer(),orig_func=m_this.origin(),size_func=m_this.delta(),cache=[],scale=m_this.style("scale"),max=Number.NEGATIVE_INFINITY;return s_update.call(m_this),data||(data=[]),cache=data.map(function(d,i){var origin=m_renderer.worldToDisplay(orig_func(d,i)),delta=size_func(d,i);return max=Math.max(max,delta.x*delta.x+delta.y*delta.y),{x1:origin.x,y1:origin.y,dx:delta.x,dy:-delta.y}}),max=Math.sqrt(max),scale||(scale=75/max),m_style.id=m_this._d3id(),m_style.data=data,m_style.append="line",m_style.attributes={x1:function(d,i){return cache[i].x1},y1:function(d,i){return cache[i].y1},x2:function(d,i){return cache[i].x1+getScale()*cache[i].dx},y2:function(d,i){return cache[i].y1+getScale()*cache[i].dy},"marker-end":function(d,i){return"url(#"+markerID(d,i)+")"}},m_style.style={stroke:function(){return!0},strokeColor:s_style.strokeColor,strokeWidth:s_style.strokeWidth,strokeOpacity:s_style.strokeOpacity},m_style.classes=["d3VectorFeature"],updateMarkers(data,s_style.strokeColor,s_style.strokeOpacity),m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.getMTime()>=m_buildTime.getMTime()?m_this._build():updateMarkers(m_style.data,m_style.style.strokeColor,m_style.style.strokeOpacity),m_this},this._exit=function(){s_exit.call(m_this),m_style={},updateMarkers([],null,null)},this._init(arg),this},inherit(geo.d3.vectorFeature,geo.vectorFeature),geo.registerFeature("d3","vector",geo.d3.vectorFeature),geo.d3.d3Renderer=function(arg){"use strict";function setAttrs(select,attrs){var key;for(key in attrs)attrs.hasOwnProperty(key)&&select.attr(key,attrs[key])}function setStyles(select,styles){function fillFunc(){return styles.fill.apply(this,arguments)?null:"none"}function strokeFunc(){return styles.stroke.apply(this,arguments)?null:"none"}var key,k,f;for(key in styles)styles.hasOwnProperty(key)&&(f=null,k=null,"strokeColor"===key?(k="stroke",f=m_this._convertColor(styles[key],styles.stroke)):"stroke"===key&&styles[key]?(k="stroke",f=strokeFunc):"strokeWidth"===key?(k="stroke-width",f=m_this._convertScale(styles[key])):"strokeOpacity"===key?(k="stroke-opacity",f=styles[key]):"fillColor"===key?(k="fill",f=m_this._convertColor(styles[key],styles.fill)):"fill"!==key||styles.hasOwnProperty("fillColor")?"fillOpacity"===key&&(k="fill-opacity",f=styles[key]):(k="fill",f=fillFunc),k&&select.style(k,f))}function getMap(){var layer=m_this.layer();return layer?layer.map():null}function getGroup(){return m_svg.select(".group-"+m_this._d3id())}function initCorners(){var layer=m_this.layer(),map=layer.map(),width=m_this.layer().width(),height=m_this.layer().height();if(m_width=width,m_height=height,!m_width||!m_height)throw"Map layer has size 0";m_corners={upperLeft:map.displayToGcs({x:0,y:0}),lowerRight:map.displayToGcs({x:width,y:height})}}function setTransform(){if(m_corners||initCorners(),m_sticky){var dx,dy,scale,layer=m_this.layer(),map=layer.map(),upperLeft=map.gcsToDisplay(m_corners.upperLeft),lowerRight=map.gcsToDisplay(m_corners.lowerRight),group=getGroup();dx=upperLeft.x,dy=upperLeft.y,scale=(lowerRight.y-upperLeft.y)/m_height,group.attr("transform","matrix("+[scale,0,0,scale,dx,dy].join()+")"),m_scale=scale,m_dx=dx,m_dy=dy}}function baseToLocal(pt){return{x:(pt.x-m_dx)/m_scale,y:(pt.y-m_dy)/m_scale}}function localToBase(pt){return{x:pt.x*m_scale+m_dx,y:pt.y*m_scale+m_dy}}if(!(this instanceof geo.d3.d3Renderer))return new geo.d3.d3Renderer(arg);geo.renderer.call(this,arg);var s_exit=this._exit;geo.d3.object.call(this,arg),arg=arg||{};var m_this=this,m_sticky=null,m_features={},m_corners=null,m_width=null,m_height=null,m_scale=1,m_dx=0,m_dy=0,m_svg=null,m_defs=null;return this._convertColor=function(f,g){return f=geo.util.ensureFunction(f),g=g||function(){return!0},function(){var c="none";return g.apply(this,arguments)&&(c=f.apply(this,arguments),c.hasOwnProperty("r")&&c.hasOwnProperty("g")&&c.hasOwnProperty("b")&&(c=d3.rgb(255*c.r,255*c.g,255*c.b))),c}},this._convertPosition=function(f){return f=geo.util.ensureFunction(f),function(){return m_this.worldToDisplay(f.apply(this,arguments))}},this._convertScale=function(f){return f=geo.util.ensureFunction(f),function(){return f.apply(this,arguments)/m_scale}},this._init=function(){if(!m_this.canvas()){var canvas;m_svg=d3.select(m_this.layer().node().get(0)).append("svg"),m_defs=m_svg.append("defs");var shadow=m_defs.append("filter").attr("id","geo-highlight").attr("x","-100%").attr("y","-100%").attr("width","300%").attr("height","300%");shadow.append("feMorphology").attr("operator","dilate").attr("radius",2).attr("in","SourceAlpha").attr("result","dilateOut"),shadow.append("feGaussianBlur").attr("stdDeviation",5).attr("in","dilateOut").attr("result","blurOut"),shadow.append("feColorMatrix").attr("type","matrix").attr("values","-1 0 0 0 1  0 -1 0 0 1  0 0 -1 0 1  0 0 0 1 0").attr("in","blurOut").attr("result","invertOut"),shadow.append("feBlend").attr("in","SourceGraphic").attr("in2","invertOut").attr("mode","normal"),canvas=m_svg.append("g"),shadow=m_defs.append("filter").attr("id","geo-blur").attr("x","-100%").attr("y","-100%").attr("width","300%").attr("height","300%"),shadow.append("feGaussianBlur").attr("stdDeviation",20).attr("in","SourceGraphic"),m_sticky=m_this.layer().sticky(),m_svg.attr("class",m_this._d3id()),m_svg.attr("width",m_this.layer().node().width()),m_svg.attr("height",m_this.layer().node().height()),canvas.attr("class","group-"+m_this._d3id()),m_this.canvas(canvas)}},this.displayToWorld=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";return pt=Array.isArray(pt)?pt.map(function(x){return map.displayToGcs(localToBase(x))}):map.displayToGcs(localToBase(pt))},this.worldToDisplay=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";var v;return v=Array.isArray(pt)?pt.map(function(x){return baseToLocal(map.gcsToDisplay(x))}):baseToLocal(map.gcsToDisplay(pt))},this.api=function(){return"d3"},this.scaleFactor=function(){return m_scale},this._resize=function(x,y,w,h){m_corners||initCorners(),m_svg.attr("width",w),m_svg.attr("height",h),setTransform(),m_this.layer().geoTrigger(geo.event.d3Rescale,{scale:m_scale},!0)},this._update=function(){},this._exit=function(){m_features={},m_this.canvas().remove(),s_exit()},this._definitions=function(){return m_defs},this._drawFeatures=function(arg){return m_features[arg.id]={data:arg.data,index:arg.dataIndex,style:arg.style,attributes:arg.attributes,classes:arg.classes,append:arg.append},m_this.__render(arg.id)},this.__render=function(id){var key;if(void 0===id){for(key in m_features)m_features.hasOwnProperty(key)&&m_this.__render(key);return m_this}var data=m_features[id].data,index=m_features[id].index,style=m_features[id].style,attributes=m_features[id].attributes,classes=m_features[id].classes,append=m_features[id].append,selection=m_this.select(id).data(data,index);return selection.enter().append(append),selection.exit().remove(),setAttrs(selection,attributes),selection.attr("class",classes.concat([id]).join(" ")),setStyles(selection,style),m_this},this.select=function(id){return getGroup().selectAll("."+id)},this._removeFeature=function(id){return m_this.select(id).remove(),delete m_features[id],m_this},this.draw=function(){},this.layer().geoOn(geo.event.pan,setTransform),this.layer().geoOn(geo.event.zoom,function(){setTransform(),m_this.__render(),m_this.layer().geoTrigger(geo.event.d3Rescale,{scale:m_scale},!0)}),this.layer().geoOn(geo.event.resize,function(event){m_this._resize(event.x,event.y,event.width,event.height)}),this._init(arg),this},inherit(geo.d3.d3Renderer,geo.renderer),geo.registerRenderer("d3",geo.d3.d3Renderer),geo.gui={},geo.gui.uiLayer=function(arg){"use strict";if(arg.renderer="d3",arg.sticky=!1,!(this instanceof geo.gui.uiLayer))return new geo.gui.uiLayer(arg);geo.layer.call(this,arg);var m_this=this,s_exit=this._exit;this.createWidget=function(widgetName,arg){var newWidget=geo.createWidget(widgetName,m_this,m_this.renderer(),arg);return m_this.addChild(newWidget),newWidget._init(),m_this.modified(),newWidget},this.deleteWidget=function(widget){return widget._exit(),m_this.removeChild(widget),m_this.modified(),m_this},this._exit=function(){m_this.children().forEach(function(child){m_this.deleteWidget(child)}),s_exit()}},inherit(geo.gui.uiLayer,geo.layer),geo.registerLayer("ui",geo.gui.uiLayer),geo.gui.widget=function(arg){"use strict";if(!(this instanceof geo.gui.widget))return new geo.gui.widget(arg);geo.sceneObject.call(this,arg);var m_this=this,s_exit=this._exit,m_layer=arg.layer;this._init=function(){m_this.modified()},this._exit=function(){m_this.children().forEach(function(child){m_this._deleteFeature(child)}),s_exit()},this._createFeature=function(featureName,arg){var newFeature=geo.createFeature(featureName,m_this,m_this.renderer(),arg);return m_this.addChild(newFeature),m_this.modified(),newFeature},this._deleteFeature=function(feature){return m_this.removeChild(feature),feature._exit(),m_this},this.layer=function(){return m_layer}},inherit(geo.gui.widget,geo.sceneObject),geo.gui.sliderWidget=function(arg){"use strict";function put_icon(icon,base,cx,cy,size){var g=base.append("g"),s=size/1024;return g.append("g").append("g").attr("transform","translate("+cx+","+cy+") scale("+s+") translate(-512,-512)").append("path").attr("d",icon).attr("class","geo-glyphicon"),g}if(!(this instanceof geo.gui.sliderWidget))return new geo.gui.sliderWidget(arg);geo.gui.widget.call(this,arg);var m_xscale,m_yscale,m_plus,m_minus,m_track,m_nub,m_plusIcon,m_minusIcon,m_group,m_lowContrast,m_this=this,s_exit=this._exit,m_width=20,m_height=100,m_nubSize=10,m_highlightDur=100;m_plusIcon="M512 81.92c-237.568 0-430.080 192.614-430.080 430.080 0 237.568 192.563 430.080 430.080 430.080s430.080-192.563 430.080-430.080c0-237.517-192.563-430.080-430.080-430.080zM564.326 564.326v206.182h-104.653v-206.182h-206.234v-104.653h206.182v-206.234h104.704v206.182h206.182v104.704h-206.182z",m_minusIcon="M512 81.92c-237.568 0-430.080 192.614-430.080 430.080 0 237.568 192.563 430.080 430.080 430.080s430.080-192.563 430.080-430.080c0-237.517-192.563-430.080-430.080-430.080zM770.56 459.674v104.704h-517.12v-104.704h517.12z",m_lowContrast={white:"#f4f4f4",black:"#505050"},this._init=function(){function respond(evt,trans){var z=m_yscale.invert(d3.mouse(m_this.layer().node()[0])[1]),zrange=map.zoomRange();z=(1-z)*(zrange.max-zrange.min)+zrange.min,trans?map.transition({zoom:z,ease:d3.ease("cubic-in-out"),duration:500,done:m_this._update()}):(map.zoom(z),m_this._update()),evt.stopPropagation()}var svg=m_this.layer().renderer().canvas(),x0=40,y0=40+m_width,map=m_this.layer().map();m_xscale=d3.scale.linear().domain([-4,4]).range([x0,x0+m_width]),m_yscale=d3.scale.linear().domain([0,1]).range([y0,y0+m_height]),svg=svg.append("g").classed("geo-ui-slider",!0),m_group=svg,m_plus=svg.append("g"),m_plus.append("circle").datum({fill:"white",stroke:null}).classed("geo-zoom-in",!0).attr("cx",m_xscale(0)).attr("cy",m_yscale(0)-m_width+2).attr("r",m_width/2).style({cursor:"pointer"}).on("click",function(){var z=map.zoom();map.transition({zoom:z+1,ease:d3.ease("cubic-in-out"),duration:500})}).on("mousedown",function(){d3.event.stopPropagation()}),put_icon(m_plusIcon,m_plus,m_xscale(0),m_yscale(0)-m_width+2,m_width+5).style("cursor","pointer").style("pointer-events","none").select("path").datum({fill:"black",stroke:null}),m_minus=svg.append("g"),m_minus.append("circle").datum({fill:"white",stroke:null}).classed("geo-zoom-out",!0).attr("cx",m_xscale(0)).attr("cy",m_yscale(1)+m_width-2).attr("r",m_width/2).style({cursor:"pointer"}).on("click",function(){var z=map.zoom();map.transition({zoom:z-1,ease:d3.ease("cubic-in-out"),duration:500})}).on("mousedown",function(){d3.event.stopPropagation()}),put_icon(m_minusIcon,m_minus,m_xscale(0),m_yscale(1)+m_width-2,m_width+5).style("cursor","pointer").style("pointer-events","none").select("path").datum({fill:"black",stroke:null}),m_track=svg.append("rect").datum({fill:"white",stroke:"black"}).classed("geo-zoom-track",!0).attr("x",m_xscale(0)-m_width/6).attr("y",m_yscale(0)).attr("rx",m_width/10).attr("ry",m_width/10).attr("width",m_width/3).attr("height",m_height).style({cursor:"pointer"}).on("click",function(){respond(d3.event,!0)}),m_nub=svg.append("rect").datum({fill:"black",stroke:null}).classed("geo-zoom-nub",!0).attr("x",m_xscale(-4)).attr("y",m_yscale(.5)-m_nubSize/2).attr("rx",3).attr("ry",3).attr("width",m_width).attr("height",m_nubSize).style({cursor:"pointer"}).on("mousedown",function(){d3.select(document).on("mousemove.geo.slider",function(){respond(d3.event)}),d3.select(document).on("mouseup.geo.slider",function(){respond(d3.event),d3.select(document).on(".geo.slider",null)}),d3.event.stopPropagation()});var mouseOver=function(){d3.select(this).attr("filter","url(#geo-highlight)"),m_group.selectAll("rect,path,circle").transition().duration(m_highlightDur).style("fill",function(d){return d.fill||null}).style("stroke",function(d){return d.stroke||null})},mouseOut=function(){d3.select(this).attr("filter",null),m_group.selectAll("circle,rect,path").transition().duration(m_highlightDur).style("fill",function(d){return m_lowContrast[d.fill]||null}).style("stroke",function(d){return m_lowContrast[d.stroke]||null})};m_group.selectAll("*").on("mouseover",mouseOver).on("mouseout",mouseOut),m_this.layer().geoOn(geo.event.zoom,function(){m_this._update()}),mouseOut(),m_this._update()},this._exit=function(){m_group.remove(),m_this.layer().geoOff(geo.event.zoom),s_exit()},this._update=function(obj){var map=m_this.layer().map(),zoomRange=map.zoomRange(),zoom=map.zoom(),zoomScale=d3.scale.linear();obj=obj||{},zoom=obj.value||zoom,zoomScale.domain([zoomRange.min,zoomRange.max]).range([1,0]).clamp(!0),m_nub.attr("y",m_yscale(zoomScale(zoom))-m_nubSize/2)}},inherit(geo.gui.sliderWidget,geo.gui.widget),geo.registerWidget("d3","slider",geo.gui.sliderWidget),geo.gui.legendWidget=function(arg){"use strict";if(!(this instanceof geo.gui.legendWidget))return new geo.gui.legendWidget(arg);geo.gui.widget.call(this,arg);var m_this=this,m_categories=[],m_top=null,m_group=null,m_border=null,m_spacing=20,m_padding=12;this.categories=function(arg){return void 0===arg?m_categories.slice():(m_categories=arg.slice().map(function(d){return"line"===d.type&&(d.style.fill=!1,d.style.stroke=!0),d}),m_this.draw(),m_this)},this.size=function(){var height,width=1,test=m_this.layer().renderer().canvas().append("text").style("opacity",1e-6);return m_categories.forEach(function(d){test.text(d.name),
width=Math.max(width,test.node().getBBox().width)}),test.remove(),height=m_spacing*(m_categories.length+1),{width:width+50,height:height}},this.draw=function(){function applyColor(selection){selection.style("fill",function(d){return d.style.fill||void 0===d.style.fill?d.style.fillColor:"none"}).style("fill-opacity",function(d){return void 0===d.style.fillOpacity?1:d.style.fillOpacity}).style("stroke",function(d){return d.style.stroke||void 0===d.style.stroke?d.style.strokeColor:"none"}).style("stroke-opacity",function(d){return void 0===d.style.strokeOpacity?1:d.style.strokeOpacity}).style("stroke-width",function(d){return void 0===d.style.strokeWidth?1.5:d.style.strokeWidth})}m_this._init(),m_border.attr("height",m_this.size().height+2*m_padding).style("display",null);var scale=m_this._scale(),labels=m_group.selectAll("g.geo-label").data(m_categories,function(d){return d.name}),g=labels.enter().append("g").attr("class","geo-label").attr("transform",function(d,i){return"translate(0,"+scale.y(i)+")"});return applyColor(g.filter(function(d){return"point"!==d.type&&"line"!==d.type}).append("rect").attr("x",0).attr("y",-6).attr("rx",5).attr("ry",5).attr("width",40).attr("height",12)),applyColor(g.filter(function(d){return"point"===d.type}).append("circle").attr("cx",20).attr("cy",0).attr("r",6)),applyColor(g.filter(function(d){return"line"===d.type}).append("line").attr("x1",0).attr("y1",0).attr("x2",40).attr("y2",0)),g.append("text").attr("x","50px").attr("y",0).attr("dy","0.3em").text(function(d){return d.name}),m_this},this._scale=function(){return{x:d3.scale.linear().domain([0,1]).range([0,m_this.size().width]),y:d3.scale.linear().domain([0,m_categories.length-1]).range([m_padding/2,m_this.size().height-m_padding/2])}},this._init=function(){var w=m_this.size().width+2*m_padding,h=m_this.size().height+2*m_padding,nw=m_this.layer().map().node().width(),margin=20;m_top&&m_top.remove(),m_top=m_this.layer().renderer().canvas().append("g").attr("transform","translate("+(nw-w-margin)+","+margin+")"),m_group=m_top.append("g").attr("transform","translate("+[m_padding-1.5,m_padding]+")"),m_border=m_group.append("rect").attr("x",-m_padding).attr("y",-m_padding).attr("width",w).attr("height",h).attr("rx",3).attr("ry",3).style({stroke:"black","stroke-width":"1.5px",fill:"white","fill-opacity":.75,display:"none"}),m_group.on("mousedown",function(){d3.event.stopPropagation()}),m_group.on("mouseover",function(){m_border.transition().duration(250).style("fill-opacity",1)}),m_group.on("mouseout",function(){m_border.transition().duration(250).style("fill-opacity",.75)})},this.geoOn(geo.event.resize,function(){this.draw()})},inherit(geo.gui.legendWidget,geo.gui.widget),geo.registerWidget("d3","legend",geo.gui.legendWidget),function($,geo,d3){"use strict";var load=function(){function isColorKey(key){return"color"===key.slice(key.length-5,key.length).toLowerCase()}function makeColorScale(data,acc){function wrap(func){return geo.util.isFunction(func)?function(){return func(acc.apply(this,arguments))}:func(acc)}if(!d3)return console.warn("d3 is unavailable, cannot apply color scales."),acc;var domain,cannotHandle=!1,doNotHandle=!0,categorical=!1,min=Number.POSITIVE_INFINITY,max=Number.NEGATIVE_INFINITY;return domain=geo.util.isFunction(acc)?d3.set(data.map(acc)).values():[acc],domain.forEach(function(v){("string"!=typeof v||"object"!=typeof geo.util.convertColor(v))&&(doNotHandle=!1),"string"==typeof v?categorical=!0:isFinite(v)?+v>max?max=+v:min>+v&&(min=+v):cannotHandle=!0}),cannotHandle?acc:doNotHandle?acc:wrap(categorical?domain.length<=10?d3.scale.category10().domain(domain):domain.length<=20?d3.scale.category20().domain(domain):d3.scale.category20().domain(domain):d3.scale.linear().range(["rgb(252,141,89)","rgb(255,255,191)","rgb(145,191,219)"]).domain([min,(min+max)/2,max]))}return $.widget?void $.widget("geojs.geojsMap",{options:{center:{latitude:0,longitude:0},zoom:0,width:null,height:null,layers:[],data:[],tileUrl:"http://tile.openstreetmap.org/<zoom>/<x>/<y>.png",baseLayer:"osm",baseRenderer:"vgl"},_create:function(){!this._map&&this.element.length&&(this._map=geo.map({width:this.options.width,height:this.options.height,zoom:this.options.zoom,center:this.options.center,node:this.element.get(0)}),this._baseLayer=this._map.createLayer(this.options.baseLayer,{renderer:this.options.baseRenderer,tileUrl:this.options.tileUrl}),this._resize({width:800,height:600}),this._layers=[],this.update())},update:function(layers){var m_this=this;return this.options.layers=layers||this.options.layers||[],this._layers.forEach(function(layer){layer.clear(),m_this._map.deleteLayer(layer)}),this._layers=this.options.layers.map(function(layer){return layer.data=layer.data||m_this.options.data,(layer.features||[]).forEach(function(feature){var scl,data=feature.data||layer.data||[];"point"===feature.type&&(feature.size?feature._size=geo.util.ensureFunction(feature.size):null===feature.size&&delete feature._size,data.length&&feature._size&&(scl=d3.scale.linear().domain(d3.extent(data,feature._size)).range([5,20]),feature.radius=function(){return scl(feature._size.apply(this,arguments))}),delete feature.size);var key;for(key in feature)feature.hasOwnProperty(key)&&isColorKey(key)&&(feature[key]=makeColorScale(data,feature[key]))}),geo.layer.create(m_this._map,layer)}),this.redraw(),this},map:function(){return this._map},tileUrl:function(url){return this._baseLayer.tileUrl(url),this._baseLayer.updateBaseUrl(),this},_resize:function(size){var width=this.options.width,height=this.options.height;size&&(width=size.width,height=size.height),width||(width=this.element.width()),height||(height=this.element.height()),this._map.resize(0,0,width,height)},redraw:function(){return this._resize(),this}}):void($.fn.geojsMap=function(){throw new Error("The geojs jquery plugin requires jquery ui to be available.")})};$(load)}($||window.$,geo||window.geo,d3||window.d3);