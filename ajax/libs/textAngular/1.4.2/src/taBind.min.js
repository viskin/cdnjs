angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){var e=/<(a|abbr|acronym|bdi|bdo|big|cite|code|del|dfn|img|ins|kbd|label|map|mark|q|ruby|rp|rt|s|samp|time|tt|var)[^>]*(>|$)/i;return function(t){return function(n){if(!n)return!0;var a,r=/(^[^<]|>)[^<]/i.exec(n);return r?a=r.index:(n=n.toString().replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,""),a=n.indexOf(">")),n=n.trim().substring(a,a+100),/^[^<>]+$/i.test(n)?!1:0===n.length||n===t||/^>(\s|&nbsp;)*<\/[^>]+>$/gi.test(n)?!0:!/>\s*[^\s<]/i.test(n)&&!e.test(n)}}}]).directive("taButton",[function(){return{link:function(e,t,n){t.attr("unselectable","on"),t.on("mousedown",function(e,t){return t&&angular.extend(e,t),e.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$window","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM","textAngularManager",function(e,t,n,a,r,i,l,o,s,d,u,c,f,p){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(i,h,m,v){var g,b,L,w,C=v[0],y=v[1]||{},N=void 0!==h.attr("contenteditable")&&h.attr("contenteditable"),D=N||"textarea"===h[0].tagName.toLowerCase()||"input"===h[0].tagName.toLowerCase(),k=!1,x=!1,$=!1,S=m.taUnsafeSanitizer||d.disableSanitizer,M=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,T=/^(8|13|32|46|59|61|107|109|186|187|188|189|190|191|192|219|220|221|222)$/i;void 0===m.taDefaultWrap&&(m.taDefaultWrap="p"),""===m.taDefaultWrap?(L="",w=void 0===_browserDetect.ie?"<div><br></div>":_browserDetect.ie>=11?"<p><br></p>":_browserDetect.ie<=8?"<P>&nbsp;</P>":"<p>&nbsp;</p>"):(L=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+m.taDefaultWrap+"><br></"+m.taDefaultWrap+">":_browserDetect.ie<=8?"<"+m.taDefaultWrap.toUpperCase()+"></"+m.taDefaultWrap.toUpperCase()+">":"<"+m.taDefaultWrap+"></"+m.taDefaultWrap+">",w=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+m.taDefaultWrap+"><br></"+m.taDefaultWrap+">":_browserDetect.ie<=8?"<"+m.taDefaultWrap.toUpperCase()+">&nbsp;</"+m.taDefaultWrap.toUpperCase()+">":"<"+m.taDefaultWrap+">&nbsp;</"+m.taDefaultWrap+">"),y.$options||(y.$options={});var E=u(w),_=function(e){if(E(e))return e;var t=angular.element("<div>"+e+"</div>");if(0===t.children().length)e="<"+m.taDefaultWrap+">"+e+"</"+m.taDefaultWrap+">";else{var n,a=t[0].childNodes,r=!1;for(n=0;n<a.length&&!(r=a[n].nodeName.toLowerCase().match(BLOCKELEMENTS));n++);if(r)for(e="",n=0;n<a.length;n++)if(a[n].nodeName.toLowerCase().match(BLOCKELEMENTS))e+=a[n].outerHTML;else{var i=a[n].outerHTML||a[n].nodeValue;e+=""!==i.trim()?"<"+m.taDefaultWrap+">"+i+"</"+m.taDefaultWrap+">":i}else e="<"+m.taDefaultWrap+">"+e+"</"+m.taDefaultWrap+">"}return e};m.taPaste&&(b=c(m.taPaste)),h.addClass("ta-bind");var W;i["$undoManager"+(m.id||"")]=C.$undoManager={_stack:[],_index:0,_max:1e3,push:function(e){return"undefined"==typeof e||null===e||"undefined"!=typeof this.current()&&null!==this.current()&&e===this.current()?e:(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(e),W&&t.cancel(W),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1,e)},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(e){return 0>e||e>this._stack.length-1?void 0:(this._index=e,this.current())},current:function(){return this._stack[this._index]}};var I,H=i["$undoTaBind"+(m.id||"")]=function(){if(!k&&N){var e=C.$undoManager.undo();"undefined"!=typeof e&&null!==e&&(Q(e),K(e,!1),I&&t.cancel(I),I=t(function(){h[0].focus(),l.setSelectionToElementEnd(h[0])},1))}},A=i["$redoTaBind"+(m.id||"")]=function(){if(!k&&N){var e=C.$undoManager.redo();"undefined"!=typeof e&&null!==e&&(Q(e),K(e,!1),I&&t.cancel(I),I=t(function(){h[0].focus(),l.setSelectionToElementEnd(h[0])},1))}},V=function(){if(N)return h[0].innerHTML;if(D)return h.val();throw"textAngular Error: attempting to update non-editable taBind"},K=function(e,t,n){$=n||!1,"undefined"!=typeof t&&null!==t||(t=N),"undefined"!=typeof e&&null!==e||(e=V()),E(e)?(""!==C.$viewValue&&C.$setViewValue(""),t&&""!==C.$undoManager.current()&&C.$undoManager.push("")):(J(),C.$viewValue!==e&&(C.$setViewValue(e),t&&C.$undoManager.push(e))),C.$render()};i["updateTaBind"+(m.id||"")]=function(){k||K(void 0,void 0,!0)};var B=function(t){return C.$oldViewValue=e(r(t),C.$oldViewValue,S)};if(h.attr("required")&&(C.$validators.required=function(e,t){return!E(e||t)}),C.$parsers.push(B),C.$parsers.unshift(_),C.$formatters.push(B),C.$formatters.unshift(_),C.$formatters.unshift(function(e){return C.$undoManager.push(e||"")}),D)if(i.events={},N){var O=!1,U=function(n){if(n&&n.trim().length){if(n.match(/class=["']*Mso(Normal|List)/i)){var a=n.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);a=a?a[1]:n,a=a.replace(/<o:p>[\s\S]*?<\/o:p>/gi,"").replace(/class=(["']|)MsoNormal(["']|)/gi,"");var r=angular.element("<div>"+a+"</div>"),o=angular.element("<div></div>"),s={element:null,lastIndent:[],lastLi:null,isUl:!1};s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0};for(var d=function(e){s.isUl=e,s.element=angular.element(e?"<ul>":"<ol>"),s.lastIndent=[],s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0},s.lastLevelMatch=null},u=0;u<=r[0].childNodes.length;u++)if(r[0].childNodes[u]&&"#text"!==r[0].childNodes[u].nodeName&&"p"===r[0].childNodes[u].tagName.toLowerCase()){var c=angular.element(r[0].childNodes[u]),p=(c.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i);if(p){if(c[0].childNodes.length<2||c[0].childNodes[1].childNodes.length<1)continue;var m="bullet"===p[1].toLowerCase()||"number"!==p[1].toLowerCase()&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].childNodes[0].innerHTML)),v=(c.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),g=parseFloat(v?v[1]:0),L=(c.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(L&&L[2]&&(g=parseInt(L[2])),L&&(!s.lastLevelMatch||L[1]!==s.lastLevelMatch[1])||!p[3]||"first"===p[3].toLowerCase()||null===s.lastIndent.peek()||s.isUl!==m&&s.lastIndent.peek()===g)d(m),o.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()<g)s.element=angular.element(m?"<ul>":"<ol>"),s.lastLi.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()>g){for(;null!=s.lastIndent.peek()&&s.lastIndent.peek()>g;)if("li"!==s.element.parent()[0].tagName.toLowerCase()){if(!/[uo]l/i.test(s.element.parent()[0].tagName.toLowerCase()))break;s.element=s.element.parent(),s.lastIndent.pop()}else s.element=s.element.parent();s.isUl="ul"===s.element[0].tagName.toLowerCase(),m!==s.isUl&&(d(m),o.append(s.element))}s.lastLevelMatch=L,g!==s.lastIndent.peek()&&s.lastIndent.push(g),s.lastLi=angular.element("<li>"),s.element.append(s.lastLi),s.lastLi.html(c.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/gi,"")),c.remove()}else d(!1),o.append(c)}var w=function(e){e=angular.element(e);for(var t=e[0].childNodes.length-1;t>=0;t--)e.after(e[0].childNodes[t]);e.remove()};angular.forEach(o.find("span"),function(e){e.removeAttribute("lang"),e.attributes.length<=0&&w(e)}),angular.forEach(o.find("font"),w),n=o.html()}else{if(n=n.replace(/<(|\/)meta[^>]*?>/gi,""),n.match(/<[^>]*?(ta-bind)[^>]*?>/)){if(n.match(/<[^>]*?(text-angular)[^>]*?>/)){var y=angular.element("<div>"+n+"</div>");y.find("textarea").remove();for(var N=f.getByAttribute(y,"ta-bind"),D=0;D<N.length;D++){for(var k=N[D][0].parentNode.parentNode,x=0;x<N[D][0].childNodes.length;x++)k.parentNode.insertBefore(N[D][0].childNodes[x],k);k.parentNode.removeChild(k)}n=y.html().replace('<br class="Apple-interchange-newline">',"")}}else n.match(/^<span/)&&(n=n.replace(/<(|\/)span[^>]*?>/gi,""));n=n.replace(/<br class="Apple-interchange-newline"[^>]*?>/gi,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/gi,"&nbsp;")}/<li(\s.*)?>/i.test(n)&&/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(n)===!1&&(n=n.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&</ul>")),b&&(n=b(i,{$html:n})||n),n=e(n,"",S),l.insertHtml(n,h[0]),t(function(){C.$setViewValue(V()),O=!1,h.removeClass("processing-paste")},0)}else O=!1,h.removeClass("processing-paste")};h.on("paste",i.events.paste=function(e,r){if(r&&angular.extend(e,r),k||O)return e.stopPropagation(),e.preventDefault(),!1;O=!0,h.addClass("processing-paste");var i,l=(e.originalEvent||e).clipboardData;if(l&&l.getData&&l.types.length>0){for(var o="",s=0;s<l.types.length;s++)o+=" "+l.types[s];return/text\/html/i.test(o)?i=l.getData("text/html"):/text\/plain/i.test(o)&&(i=l.getData("text/plain")),U(i),e.stopPropagation(),e.preventDefault(),!1}var d=n.rangy.saveSelection(),u=angular.element('<div class="ta-hidden-input" contenteditable="true"></div>');a.find("body").append(u),u[0].focus(),t(function(){n.rangy.restoreSelection(d),U(u[0].innerHTML),h[0].focus(),u.remove()},0)}),h.on("cut",i.events.cut=function(e){k?e.preventDefault():t(function(){C.$setViewValue(V())},0)}),h.on("keydown",i.events.keydown=function(e,t){if(t&&angular.extend(e,t),e.ctrlKey===!1&&e.metaKey===!1&&9===e.keyCode&&(e.preventDefault(),e.specialKey="TabKey",e.shiftKey&&(e.specialKey="ShiftTabKey"),p.sendKeyCommand(i,e)),!k)if(e.altKey||!e.metaKey&&!e.ctrlKey){if(13===e.keyCode&&!e.shiftKey){var n,a=l.getSelectionElement();if(!a.tagName.match(VALIDELEMENTS))return;var r=angular.element(L);if(/^<br(|\/)>$/i.test(a.innerHTML.trim())&&"blockquote"===a.parentNode.tagName.toLowerCase()&&!a.nextSibling){n=angular.element(a);var o=n.parent();o.after(r),n.remove(),0===o.children().length&&o.remove(),l.setSelectionToElementStart(r[0]),e.preventDefault()}else/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(a.innerHTML.trim())&&"blockquote"===a.tagName.toLowerCase()&&(n=angular.element(a),n.after(r),n.remove(),l.setSelectionToElementStart(r[0]),e.preventDefault())}}else 90!==e.keyCode||e.shiftKey?(90===e.keyCode&&e.shiftKey||89===e.keyCode&&!e.shiftKey)&&(A(),e.preventDefault()):(H(),e.preventDefault())});var z;if(h.on("keyup",i.events.keyup=function(e,a){if(a&&angular.extend(e,a),9===e.keyCode){var r=l.getSelection();return void(r.start.element===h[0]&&h.children().length&&l.setSelectionToElementStart(h.children()[0]))}if(W&&t.cancel(W),!k&&!M.test(e.keyCode)){if(""!==L&&13===e.keyCode&&!e.shiftKey){for(var i=l.getSelectionElement();!i.tagName.match(VALIDELEMENTS)&&i!==h[0];)i=i.parentNode;if(i.tagName.toLowerCase()!==m.taDefaultWrap&&"li"!==i.tagName.toLowerCase()&&(""===i.innerHTML.trim()||"<br>"===i.innerHTML.trim())){var o=angular.element(L);angular.element(i).replaceWith(o),l.setSelectionToElementStart(o[0])}}var s=V();if(""!==L&&""===s.trim())Q(L),l.setSelectionToElementStart(h.children()[0]);else if("<"!==s.substring(0,1)&&""!==m.taDefaultWrap){var d=n.rangy.saveSelection();s=V(),s="<"+m.taDefaultWrap+">"+s+"</"+m.taDefaultWrap+">",Q(s),n.rangy.restoreSelection(d)}var u=g!==e.keyCode&&T.test(e.keyCode);z&&t.cancel(z),z=t(function(){K(s,u,!0)},y.$options.debounce||400),u||(W=t(function(){C.$undoManager.push(s)},250)),g=e.keyCode}}),h.on("blur",i.events.blur=function(){x=!1,k?($=!0,C.$render()):K(void 0,void 0,!0)}),m.placeholder&&(_browserDetect.ie>8||void 0===_browserDetect.ie)){var q;if(!m.id)throw"textAngular Error: An unique ID is required for placeholders to work";q=addCSSRule("#"+m.id+".placeholder-text:before",'content: "'+m.placeholder+'"'),i.$on("$destroy",function(){removeCSSRule(q)})}h.on("focus",i.events.focus=function(){x=!0,h.removeClass("placeholder-text"),J()}),h.on("mouseup",i.events.mouseup=function(){var e=l.getSelection();e.start.element===h[0]&&h.children().length&&l.setSelectionToElementStart(h.children()[0])}),h.on("mousedown",i.events.mousedown=function(e,t){t&&angular.extend(e,t),e.stopPropagation()})}else{h.on("change blur",i.events.change=i.events.blur=function(){k||C.$setViewValue(V())}),h.on("keydown",i.events.keydown=function(e,t){if(t&&angular.extend(e,t),9===e.keyCode){var n=this.selectionStart,a=this.selectionEnd,r=h.val();if(e.shiftKey){var i=r.lastIndexOf("\n",n),l=r.lastIndexOf("	",n);-1!==l&&l>=i&&(h.val(r.substring(0,l)+r.substring(l+1)),this.selectionStart=this.selectionEnd=n-1)}else h.val(r.substring(0,n)+"	"+r.substring(a)),this.selectionStart=this.selectionEnd=n+1;e.preventDefault()}});var F=function(e,t){for(var n="",a=0;t>a;a++)n+=e;return n},P=function(e,t){var n="",a=e.childNodes;t++,n+=F("	",t-1)+e.outerHTML.substring(0,e.outerHTML.indexOf("<li"));for(var r=0;r<a.length;r++)a[r].outerHTML&&(n+="ul"===a[r].nodeName.toLowerCase()||"ol"===a[r].nodeName.toLowerCase()?"\n"+P(a[r],t):"\n"+F("	",t)+a[r].outerHTML);return n+="\n"+F("	",t-1)+e.outerHTML.substring(e.outerHTML.lastIndexOf("<"))};C.$formatters.unshift(function(e){var t=angular.element("<div>"+e+"</div>")[0].childNodes;if(t.length>0){e="";for(var n=0;n<t.length;n++)t[n].outerHTML&&(e.length>0&&(e+="\n"),e+="ul"===t[n].nodeName.toLowerCase()||"ol"===t[n].nodeName.toLowerCase()?""+P(t[n],0):""+t[n].outerHTML)}return e})}var R,j=function(e){return i.$emit("ta-element-select",this),e.preventDefault(),!1},G=function(e,n){if(n&&angular.extend(e,n),!dropFired&&!k){dropFired=!0;var a;a=e.originalEvent?e.originalEvent.dataTransfer:e.dataTransfer,i.$emit("ta-drop-event",this,e,a),t(function(){dropFired=!1,K(void 0,void 0,!0)},100)}},J=i["reApplyOnSelectorHandlers"+(m.id||"")]=function(){k||angular.forEach(o,function(e){h.find(e).off("click",j).on("click",j)})},Q=function(e){h[0].innerHTML=e},X=!1;C.$render=function(){if(!X){X=!0;var e=C.$viewValue||"";$||(N&&x&&(h.removeClass("placeholder-text"),R&&t.cancel(R),R=t(function(){x||(h[0].focus(),l.setSelectionToElementEnd(h.children()[h.children().length-1])),R=void 0},1)),N?(Q(m.placeholder?""===e?L:e:""===e?L:e),k?h.off("drop",G):(J(),h.on("drop",G))):"textarea"!==h[0].tagName.toLowerCase()&&"input"!==h[0].tagName.toLowerCase()?Q(s(e)):h.val(e)),N&&m.placeholder&&(""===e?x?h.removeClass("placeholder-text"):h.addClass("placeholder-text"):h.removeClass("placeholder-text")),X=$=!1}},m.taReadonly&&(k=i.$eval(m.taReadonly),k?(h.addClass("ta-readonly"),"textarea"!==h[0].tagName.toLowerCase()&&"input"!==h[0].tagName.toLowerCase()||h.attr("disabled","disabled"),void 0!==h.attr("contenteditable")&&h.attr("contenteditable")&&h.removeAttr("contenteditable")):(h.removeClass("ta-readonly"),"textarea"===h[0].tagName.toLowerCase()||"input"===h[0].tagName.toLowerCase()?h.removeAttr("disabled"):N&&h.attr("contenteditable","true")),i.$watch(m.taReadonly,function(e,t){t!==e&&(e?(h.addClass("ta-readonly"),"textarea"!==h[0].tagName.toLowerCase()&&"input"!==h[0].tagName.toLowerCase()||h.attr("disabled","disabled"),void 0!==h.attr("contenteditable")&&h.attr("contenteditable")&&h.removeAttr("contenteditable"),angular.forEach(o,function(e){h.find(e).on("click",j)}),h.off("drop",G)):(h.removeClass("ta-readonly"),"textarea"===h[0].tagName.toLowerCase()||"input"===h[0].tagName.toLowerCase()?h.removeAttr("disabled"):N&&h.attr("contenteditable","true"),angular.forEach(o,function(e){h.find(e).off("click",j)}),h.on("drop",G)),k=e)})),N&&!k&&(angular.forEach(o,function(e){h.find(e).on("click",j)}),h.on("drop",G),h.on("blur",function(){_browserDetect.webkit&&(globalContentEditableBlur=!0)}))}}}]);
//# sourceMappingURL=./taBind.min.js.map