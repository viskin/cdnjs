angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){var e=/<(a|abbr|acronym|bdi|bdo|big|cite|code|del|dfn|img|ins|kbd|label|map|mark|q|ruby|rp|rt|s|samp|time|tt|var)[^>]*(>|$)/i;return function(t){return function(n){if(!n)return!0;var a,r=/(^[^<]|>)[^<]/i.exec(n);return r?a=r.index:(n=n.toString().replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,""),a=n.indexOf(">")),n=n.trim().substring(a,a+100),/^[^<>]+$/i.test(n)?!1:0===n.length||n===t||/^>(\s|&nbsp;)*<\/[^>]+>$/gi.test(n)?!0:!/>\s*[^\s<]/i.test(n)&&!e.test(n)}}}]).directive("taButton",[function(){return{link:function(e,t,n){t.attr("unselectable","on"),t.on("mousedown",function(e,t){return t&&angular.extend(e,t),e.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$window","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM","textAngularManager",function(e,t,n,a,r,i,o,l,s,d,u,c,f,p){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(i,m,v,h){function g(e){var t;return I.forEach(function(n){if(n.keyCode===e.keyCode){var a=(e.metaKey?_:0)+(e.ctrlKey?K:0)+(e.shiftKey?W:0)+(e.altKey?H:0);if(n.forbiddenModifiers&a)return;n.mustHaveModifiers.every(function(e){return a&e})&&(t=n.specialKey)}}),t}var b,y,C,L,w=h[0],N=h[1]||{},k=void 0!==m.attr("contenteditable")&&m.attr("contenteditable"),D=k||"textarea"===m[0].tagName.toLowerCase()||"input"===m[0].tagName.toLowerCase(),M=!1,x=!1,$=!1,S=v.taUnsafeSanitizer||d.disableSanitizer,E=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,T=/^(8|13|32|46|59|61|107|109|173|186|187|188|189|190|191|192|219|220|221|222)$/i,K=1,_=2,H=4,W=8,I=[{specialKey:"UndoKey",forbiddenModifiers:H+W,mustHaveModifiers:[_+K],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:H,mustHaveModifiers:[_+K,W],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:H+W,mustHaveModifiers:[_+K],keyCode:89},{specialKey:"TabKey",forbiddenModifiers:_+W+H+K,mustHaveModifiers:[],keyCode:9},{specialKey:"ShiftTabKey",forbiddenModifiers:_+H+K,mustHaveModifiers:[W],keyCode:9}];void 0===v.taDefaultWrap&&(v.taDefaultWrap="p"),""===v.taDefaultWrap?(C="",L=void 0===_browserDetect.ie?"<div><br></div>":_browserDetect.ie>=11?"<p><br></p>":_browserDetect.ie<=8?"<P>&nbsp;</P>":"<p>&nbsp;</p>"):(C=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+v.taDefaultWrap+"><br></"+v.taDefaultWrap+">":_browserDetect.ie<=8?"<"+v.taDefaultWrap.toUpperCase()+"></"+v.taDefaultWrap.toUpperCase()+">":"<"+v.taDefaultWrap+"></"+v.taDefaultWrap+">",L=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+v.taDefaultWrap+"><br></"+v.taDefaultWrap+">":_browserDetect.ie<=8?"<"+v.taDefaultWrap.toUpperCase()+">&nbsp;</"+v.taDefaultWrap.toUpperCase()+">":"<"+v.taDefaultWrap+">&nbsp;</"+v.taDefaultWrap+">"),N.$options||(N.$options={});var A=u(L),V=function(e){if(A(e))return e;var t=angular.element("<div>"+e+"</div>");if(0===t.children().length)e="<"+v.taDefaultWrap+">"+e+"</"+v.taDefaultWrap+">";else{var n,a=t[0].childNodes,r=!1;for(n=0;n<a.length&&!(r=a[n].nodeName.toLowerCase().match(BLOCKELEMENTS));n++);if(r)for(e="",n=0;n<a.length;n++)if(a[n].nodeName.toLowerCase().match(BLOCKELEMENTS))e+=a[n].outerHTML;else{var i=a[n].outerHTML||a[n].nodeValue;e+=""!==i.trim()?"<"+v.taDefaultWrap+">"+i+"</"+v.taDefaultWrap+">":i}else e="<"+v.taDefaultWrap+">"+e+"</"+v.taDefaultWrap+">"}return e};v.taPaste&&(y=c(v.taPaste)),m.addClass("ta-bind");var B;i["$undoManager"+(v.id||"")]=w.$undoManager={_stack:[],_index:0,_max:1e3,push:function(e){return"undefined"==typeof e||null===e||"undefined"!=typeof this.current()&&null!==this.current()&&e===this.current()?e:(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(e),B&&t.cancel(B),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1,e)},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(e){return 0>e||e>this._stack.length-1?void 0:(this._index=e,this.current())},current:function(){return this._stack[this._index]}};var U,O=i["$undoTaBind"+(v.id||"")]=function(){if(!M&&k){var e=w.$undoManager.undo();"undefined"!=typeof e&&null!==e&&(ne(e),F(e,!1),U&&t.cancel(U),U=t(function(){m[0].focus(),o.setSelectionToElementEnd(m[0])},1))}},R=i["$redoTaBind"+(v.id||"")]=function(){if(!M&&k){var e=w.$undoManager.redo();"undefined"!=typeof e&&null!==e&&(ne(e),F(e,!1),U&&t.cancel(U),U=t(function(){m[0].focus(),o.setSelectionToElementEnd(m[0])},1))}},z=function(){if(k)return m[0].innerHTML;if(D)return m.val();throw"textAngular Error: attempting to update non-editable taBind"},F=function(e,t,n){$=n||!1,"undefined"!=typeof t&&null!==t||(t=k),"undefined"!=typeof e&&null!==e||(e=z()),A(e)?(""!==w.$viewValue&&w.$setViewValue(""),t&&""!==w.$undoManager.current()&&w.$undoManager.push("")):(te(),w.$viewValue!==e&&(w.$setViewValue(e),t&&w.$undoManager.push(e))),w.$render()};i["updateTaBind"+(v.id||"")]=function(){M||F(void 0,void 0,!0)};var P=function(t){return w.$oldViewValue=e(r(t),w.$oldViewValue,S)};if(m.attr("required")&&(w.$validators.required=function(e,t){return!A(e||t)}),w.$parsers.push(P),w.$parsers.unshift(V),w.$formatters.push(P),w.$formatters.unshift(V),w.$formatters.unshift(function(e){return w.$undoManager.push(e||"")}),D)if(i.events={},k){var q=!1,j=function(n){if(n&&n.trim().length){if(n.match(/class=["']*Mso(Normal|List)/i)){var a=n.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);a=a?a[1]:n,a=a.replace(/<o:p>[\s\S]*?<\/o:p>/gi,"").replace(/class=(["']|)MsoNormal(["']|)/gi,"");var r=angular.element("<div>"+a+"</div>"),l=angular.element("<div></div>"),s={element:null,lastIndent:[],lastLi:null,isUl:!1};s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0};for(var d=function(e){s.isUl=e,s.element=angular.element(e?"<ul>":"<ol>"),s.lastIndent=[],s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0},s.lastLevelMatch=null},u=0;u<=r[0].childNodes.length;u++)if(r[0].childNodes[u]&&"#text"!==r[0].childNodes[u].nodeName&&"p"===r[0].childNodes[u].tagName.toLowerCase()){var c=angular.element(r[0].childNodes[u]),p=(c.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i);if(p){if(c[0].childNodes.length<2||c[0].childNodes[1].childNodes.length<1)continue;var v="bullet"===p[1].toLowerCase()||"number"!==p[1].toLowerCase()&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].childNodes[0].innerHTML)),h=(c.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),g=parseFloat(h?h[1]:0),b=(c.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(b&&b[2]&&(g=parseInt(b[2])),b&&(!s.lastLevelMatch||b[1]!==s.lastLevelMatch[1])||!p[3]||"first"===p[3].toLowerCase()||null===s.lastIndent.peek()||s.isUl!==v&&s.lastIndent.peek()===g)d(v),l.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()<g)s.element=angular.element(v?"<ul>":"<ol>"),s.lastLi.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()>g){for(;null!=s.lastIndent.peek()&&s.lastIndent.peek()>g;)if("li"!==s.element.parent()[0].tagName.toLowerCase()){if(!/[uo]l/i.test(s.element.parent()[0].tagName.toLowerCase()))break;s.element=s.element.parent(),s.lastIndent.pop()}else s.element=s.element.parent();s.isUl="ul"===s.element[0].tagName.toLowerCase(),v!==s.isUl&&(d(v),l.append(s.element))}s.lastLevelMatch=b,g!==s.lastIndent.peek()&&s.lastIndent.push(g),s.lastLi=angular.element("<li>"),s.element.append(s.lastLi),s.lastLi.html(c.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/gi,"")),c.remove()}else d(!1),l.append(c)}var C=function(e){e=angular.element(e);for(var t=e[0].childNodes.length-1;t>=0;t--)e.after(e[0].childNodes[t]);e.remove()};angular.forEach(l.find("span"),function(e){e.removeAttribute("lang"),e.attributes.length<=0&&C(e)}),angular.forEach(l.find("font"),C),n=l.html()}else{if(n=n.replace(/<(|\/)meta[^>]*?>/gi,""),n.match(/<[^>]*?(ta-bind)[^>]*?>/)){if(n.match(/<[^>]*?(text-angular)[^>]*?>/)){var L=angular.element("<div>"+n+"</div>");L.find("textarea").remove();for(var N=f.getByAttribute(L,"ta-bind"),k=0;k<N.length;k++){for(var D=N[k][0].parentNode.parentNode,M=0;M<N[k][0].childNodes.length;M++)D.parentNode.insertBefore(N[k][0].childNodes[M],D);D.parentNode.removeChild(D)}n=L.html().replace('<br class="Apple-interchange-newline">',"")}}else n.match(/^<span/)&&(n=n.replace(/<(|\/)span[^>]*?>/gi,""));n=n.replace(/<br class="Apple-interchange-newline"[^>]*?>/gi,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/gi,"&nbsp;")}/<li(\s.*)?>/i.test(n)&&/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(n)===!1&&(n=n.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&</ul>")),y&&(n=y(i,{$html:n})||n),n=e(n,"",S),o.insertHtml(n,m[0]),t(function(){w.$setViewValue(z()),q=!1,m.removeClass("processing-paste")},0)}else q=!1,m.removeClass("processing-paste")};m.on("paste",i.events.paste=function(e,r){if(r&&angular.extend(e,r),M||q)return e.stopPropagation(),e.preventDefault(),!1;q=!0,m.addClass("processing-paste");var i,o=(e.originalEvent||e).clipboardData;if(o&&o.getData&&o.types.length>0){for(var l="",s=0;s<o.types.length;s++)l+=" "+o.types[s];return/text\/html/i.test(l)?i=o.getData("text/html"):/text\/plain/i.test(l)&&(i=o.getData("text/plain")),j(i),e.stopPropagation(),e.preventDefault(),!1}var d=n.rangy.saveSelection(),u=angular.element('<div class="ta-hidden-input" contenteditable="true"></div>');a.find("body").append(u),u[0].focus(),t(function(){n.rangy.restoreSelection(d),j(u[0].innerHTML),m[0].focus(),u.remove()},0)}),m.on("cut",i.events.cut=function(e){M?e.preventDefault():t(function(){w.$setViewValue(z())},0)}),m.on("keydown",i.events.keydown=function(e,t){t&&angular.extend(e,t),e.specialKey=g(e);var n;if(d.keyMappings.forEach(function(t){e.specialKey===t.commandKeyCode&&(e.specialKey=void 0),t.testForKey(e)&&(n=t.commandKeyCode),"UndoKey"!==t.commandKeyCode&&"RedoKey"!==t.commandKeyCode||t.enablePropagation||e.preventDefault()}),"undefined"!=typeof n&&(e.specialKey=n),"undefined"==typeof e.specialKey||"UndoKey"===e.specialKey&&"RedoKey"===e.specialKey||(e.preventDefault(),p.sendKeyCommand(i,e)),!M&&("UndoKey"===e.specialKey&&(O(),e.preventDefault()),"RedoKey"===e.specialKey&&(R(),e.preventDefault()),13===e.keyCode&&!e.shiftKey)){var a,r=o.getSelectionElement();if(!r.tagName.match(VALIDELEMENTS))return;var l=angular.element(C);if(/^<br(|\/)>$/i.test(r.innerHTML.trim())&&"blockquote"===r.parentNode.tagName.toLowerCase()&&!r.nextSibling){a=angular.element(r);var s=a.parent();s.after(l),a.remove(),0===s.children().length&&s.remove(),o.setSelectionToElementStart(l[0]),e.preventDefault()}else/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(r.innerHTML.trim())&&"blockquote"===r.tagName.toLowerCase()&&(a=angular.element(r),a.after(l),a.remove(),o.setSelectionToElementStart(l[0]),e.preventDefault())}});var G;if(m.on("keyup",i.events.keyup=function(e,a){if(a&&angular.extend(e,a),9===e.keyCode){var r=o.getSelection();return void(r.start.element===m[0]&&m.children().length&&o.setSelectionToElementStart(m.children()[0]))}if(B&&t.cancel(B),!M&&!E.test(e.keyCode)){if(""!==C&&13===e.keyCode&&!e.shiftKey){for(var i=o.getSelectionElement();!i.tagName.match(VALIDELEMENTS)&&i!==m[0];)i=i.parentNode;if(i.tagName.toLowerCase()!==v.taDefaultWrap&&"li"!==i.tagName.toLowerCase()&&(""===i.innerHTML.trim()||"<br>"===i.innerHTML.trim())){var l=angular.element(C);angular.element(i).replaceWith(l),o.setSelectionToElementStart(l[0])}}var s=z();if(""!==C&&""===s.trim())ne(C),o.setSelectionToElementStart(m.children()[0]);else if("<"!==s.substring(0,1)&&""!==v.taDefaultWrap){var d=n.rangy.saveSelection();s=z(),s="<"+v.taDefaultWrap+">"+s+"</"+v.taDefaultWrap+">",ne(s),n.rangy.restoreSelection(d)}var u=b!==e.keyCode&&T.test(e.keyCode);G&&t.cancel(G),G=t(function(){F(s,u,!0)},N.$options.debounce||400),u||(B=t(function(){w.$undoManager.push(s)},250)),b=e.keyCode}}),m.on("blur",i.events.blur=function(){x=!1,M?($=!0,w.$render()):F(void 0,void 0,!0)}),v.placeholder&&(_browserDetect.ie>8||void 0===_browserDetect.ie)){var J;if(!v.id)throw"textAngular Error: An unique ID is required for placeholders to work";J=addCSSRule("#"+v.id+".placeholder-text:before",'content: "'+v.placeholder+'"'),i.$on("$destroy",function(){removeCSSRule(J)})}m.on("focus",i.events.focus=function(){x=!0,m.removeClass("placeholder-text"),te()}),m.on("mouseup",i.events.mouseup=function(){var e=o.getSelection();e.start.element===m[0]&&m.children().length&&o.setSelectionToElementStart(m.children()[0])}),m.on("mousedown",i.events.mousedown=function(e,t){t&&angular.extend(e,t),e.stopPropagation()})}else{m.on("change blur",i.events.change=i.events.blur=function(){M||w.$setViewValue(z())}),m.on("keydown",i.events.keydown=function(e,t){if(t&&angular.extend(e,t),9===e.keyCode){var n=this.selectionStart,a=this.selectionEnd,r=m.val();if(e.shiftKey){var i=r.lastIndexOf("\n",n),o=r.lastIndexOf("	",n);-1!==o&&o>=i&&(m.val(r.substring(0,o)+r.substring(o+1)),this.selectionStart=this.selectionEnd=n-1)}else m.val(r.substring(0,n)+"	"+r.substring(a)),this.selectionStart=this.selectionEnd=n+1;e.preventDefault()}});var Q=function(e,t){for(var n="",a=0;t>a;a++)n+=e;return n},X=function(e,t){var n="",a=e.childNodes;t++,n+=Q("	",t-1)+e.outerHTML.substring(0,e.outerHTML.indexOf("<li"));for(var r=0;r<a.length;r++)a[r].outerHTML&&(n+="ul"===a[r].nodeName.toLowerCase()||"ol"===a[r].nodeName.toLowerCase()?"\n"+X(a[r],t):"\n"+Q("	",t)+a[r].outerHTML);return n+="\n"+Q("	",t-1)+e.outerHTML.substring(e.outerHTML.lastIndexOf("<"))};w.$formatters.unshift(function(e){var t=angular.element("<div>"+e+"</div>")[0].childNodes;if(t.length>0){e="";for(var n=0;n<t.length;n++)t[n].outerHTML&&(e.length>0&&(e+="\n"),e+="ul"===t[n].nodeName.toLowerCase()||"ol"===t[n].nodeName.toLowerCase()?""+X(t[n],0):""+t[n].outerHTML)}return e})}var Y,Z=function(e){return i.$emit("ta-element-select",this),e.preventDefault(),!1},ee=function(e,n){if(n&&angular.extend(e,n),!dropFired&&!M){dropFired=!0;var a;a=e.originalEvent?e.originalEvent.dataTransfer:e.dataTransfer,i.$emit("ta-drop-event",this,e,a),t(function(){dropFired=!1,F(void 0,void 0,!0)},100)}},te=i["reApplyOnSelectorHandlers"+(v.id||"")]=function(){M||angular.forEach(l,function(e){m.find(e).off("click",Z).on("click",Z)})},ne=function(e){m[0].innerHTML=e},ae=!1;w.$render=function(){if(!ae){ae=!0;var e=w.$viewValue||"";$||(k&&x&&(m.removeClass("placeholder-text"),Y&&t.cancel(Y),Y=t(function(){x||(m[0].focus(),o.setSelectionToElementEnd(m.children()[m.children().length-1])),Y=void 0},1)),k?(ne(v.placeholder?""===e?C:e:""===e?C:e),M?m.off("drop",ee):(te(),m.on("drop",ee))):"textarea"!==m[0].tagName.toLowerCase()&&"input"!==m[0].tagName.toLowerCase()?ne(s(e)):m.val(e)),k&&v.placeholder&&(""===e?x?m.removeClass("placeholder-text"):m.addClass("placeholder-text"):m.removeClass("placeholder-text")),ae=$=!1}},v.taReadonly&&(M=i.$eval(v.taReadonly),M?(m.addClass("ta-readonly"),"textarea"!==m[0].tagName.toLowerCase()&&"input"!==m[0].tagName.toLowerCase()||m.attr("disabled","disabled"),void 0!==m.attr("contenteditable")&&m.attr("contenteditable")&&m.removeAttr("contenteditable")):(m.removeClass("ta-readonly"),"textarea"===m[0].tagName.toLowerCase()||"input"===m[0].tagName.toLowerCase()?m.removeAttr("disabled"):k&&m.attr("contenteditable","true")),i.$watch(v.taReadonly,function(e,t){t!==e&&(e?(m.addClass("ta-readonly"),"textarea"!==m[0].tagName.toLowerCase()&&"input"!==m[0].tagName.toLowerCase()||m.attr("disabled","disabled"),void 0!==m.attr("contenteditable")&&m.attr("contenteditable")&&m.removeAttr("contenteditable"),angular.forEach(l,function(e){m.find(e).on("click",Z)}),m.off("drop",ee)):(m.removeClass("ta-readonly"),"textarea"===m[0].tagName.toLowerCase()||"input"===m[0].tagName.toLowerCase()?m.removeAttr("disabled"):k&&m.attr("contenteditable","true"),angular.forEach(l,function(e){m.find(e).off("click",Z)}),m.on("drop",ee)),M=e)})),k&&!M&&(angular.forEach(l,function(e){m.find(e).on("click",Z)}),m.on("drop",ee),m.on("blur",function(){_browserDetect.webkit&&(globalContentEditableBlur=!0)}))}}}]);
//# sourceMappingURL=./taBind.min.js.map