(function(){if(typeof exports!=="undefined"){var underscore=require("underscore");underscore.extend(exports,declare(underscore))}else if(typeof define!=="undefined"){define(["underscore"],declare)}else{ring=declare(_)}function declare(_){var ring={};function Object(){}ring.Object=Object;_.extend(ring.Object,{__mro__:[ring.Object],__properties__:{init:function(){}},prototype:{},__class_id__:1,parents:[],__class_index__:{1:ring.Object},isSubClass:function(other){return this.__class_index__[other.__class_id__]!==undefined}});_.extend(ring.Object.prototype,{$class:ring.Object,init:ring.Object.__properties__.init});var classCounter=3;var fnTest=/xyz/.test(function(){xyz})?/\$super\b/:/.*/;ring.create=function(){var args=_.toArray(arguments);args.reverse();var props=args[0];var parents=args.length>=2?args[1]:[];if(parents.length==0)parents=[ring.Object];var id=classCounter++;var toMerge=_.pluck(parents,"__mro__");toMerge=toMerge.concat([parents]);var __mro__=[{__properties__:props}].concat(mergeMro(toMerge));var prototype={};var keys={};_.each(__mro__,function(c){_.each(c.__properties__,function(v,k){keys[k]=true})});var getProperty=function(mro,key){if(mro.length===0)return undefined;var c=mro[0];if(c.__properties__[key]===undefined)return getProperty(_.rest(mro),key);var p=c.__properties__[key];if(typeof p!=="function"||!fnTest.test(p))return p;var sup=getProperty(_.rest(mro),key);if(!typeof sup==="function")return p;return function(sup){return function(){var tmp=this.$super;this.$super=sup;var ret=p.apply(this,arguments);this.$super=tmp;return ret}}(sup)};_.each(keys,function(v,k){prototype[k]=getProperty(__mro__,k)});var claz=function Instance(){this.$super=null;this.init.apply(this,arguments)};__mro__[0]=claz;claz.__mro__=__mro__;claz.parents=parents;claz.__properties__=props;claz.prototype=prototype;prototype.$class=claz;claz.__class_id__=id;claz.__class_index__={};_.each(claz.__mro__,function(c){claz.__class_index__[c.__class_id__]=c});claz.isSubClass=ring.Object.isSubClass;if(claz.prototype.$classInit){claz.__class_init__=claz.prototype.$classInit;delete claz.prototype.$classInit}_.each(_.chain(claz.__mro__).clone().reverse().value(),function(c){if(c.__class_init__){var ret=c.__class_init__(claz.prototype);if(ret!==undefined)claz.prototype=ret}});return claz};var mergeMro=function(toMerge){var __mro__=[];var current=_.clone(toMerge);while(true){var found=false;for(var i=0;i<current.length;i++){if(current[i].length==0)continue;var currentClass=current[i][0];var isInTail=_.find(current,function(lst){return _.contains(_.rest(lst),currentClass)});if(!isInTail){found=true;__mro__.push(currentClass);current=_.map(current,function(lst){if(_.head(lst)===currentClass)return _.rest(lst);else return lst});break}}if(found)continue;if(_.all(current,function(i){return i.length==0}))return __mro__;throw new ring.ValueError("Cannot create a consistent method resolution order (MRO)")}};ring.instance=function(obj,type){if(typeof obj==="object"&&obj.$class&&typeof type==="function"&&typeof type.__class_id__==="number"){return obj.$class.isSubClass(type)}if(typeof type==="string")return typeof obj===type;return obj instanceof type};ring.Error=ring.create("RingError",[],{name:"ring.Error",defaultMessage:"",init:function(message){this.message=message||this.defaultMessage},$classInit:function(prototype){var p=new Error;_.extend(p,prototype);return p}});ring.ValueError=ring.create([ring.Error],{name:"ring.ValueError"});return ring}})();