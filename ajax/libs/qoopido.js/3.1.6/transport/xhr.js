(function(t){window.qoopido.registerSingleton("transport/xhr",t,["../transport","../function/merge","../function/unique/string","../url","q"])})(function(t,e,o,r,n,i,s){"use strict";function u(t,e,o){var r,n=this,i=n.xhr,s=n.settings;o="object"==typeof o?n.serialize(o):o,e=s.cache===!1?"".concat(e,e.indexOf("?")>-1?"&":"?","_="+(new Date).getTime()):e,e=o&&"GET"===t?"".concat(e,e.indexOf("?")>-1?"&":"?",o):e;for(r in s.xhrOptions)i[r]=s.xhrOptions[r];if(i.open(t,e,s.async,s.username,s.password),i.setRequestHeader){i.setRequestHeader("Accept",s.accept),o&&"GET"!==t&&i.setRequestHeader("Content-Type",s.contentType);for(r in s.header)i.setRequestHeader(r,s.header[r])}i.timeout=s.timeout,i.onprogress=function(t){a.call(n,t)},i.onreadystatechange=i.onload=function(){c.call(n)},i.onerror=function(){l.call(n)},i.send(o||null),n.timeout=setTimeout(function(){p.call(n)},s.timeout)}function a(t){var e=this;e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(function(){p.call(e)},e.settings.timeout),e.dfd.notify(t)}function c(){var t=this,e=t.xhr,o=t.dfd;(e.readyState===s||4===e.readyState)&&(d.call(t),e.status===s||200===e.status?o.resolve({data:e.responseText,xhr:e}):o.reject({status:e.status,xhr:e}))}function l(){var t=this;d.call(t),t.dfd.reject()}function p(){var t=this;t.xhr.abort(),d.call(t),t.dfd.reject()}function d(){var t=this,e=t.xhr;t.timeout&&clearTimeout(t.timeout),e.onprogress=e.onreadystatechange=e.onerror=null}var f,m=t.q||n.Q,g=n.XMLHttpRequest!==s?function(e){return t.url.isLocal(e)?new n.XMLHttpRequest:n.XDomainRequest?new n.XDomainRequest:new n.XMLHttpRequest}:function(){try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(t){return null}};return f=t.transport.extend({_settings:{accept:"*/*",timeout:5e3,async:!0,cache:!1,header:{},username:null,password:null,contentType:"application/x-www-form-urlencoded; charset=UTF-8 ",xhrOptions:{}},load:function(e,o,r,n){var i={};return o=t.url.resolve(o),i.url=o,i.id="".concat("xhr-",t["function/unique/string"]()),i.dfd=m.defer(),i.xhr=g(o),i.settings=t["function/merge"]({},this._settings,n),i.timeout=null,u.call(i,e.toUpperCase(),o,r),i.dfd.promise},get:function(t,e,o){return this.load("GET",t,e,o)},post:function(t,e,o){return this.load("POST",t,e,o)},put:function(t,e,o){return this.load("PUT",t,e,o)},"delete":function(t,e,o){return this.load("DELETE",t,e,o)},head:function(t,e,o){return this.load("HEAD",t,e,o)}})},window,document);