(function(t){window.qoopido.registerSingleton("transport/xhr",t,["../transport","../function/merge","../function/unique/string","../url","q"])})(function(t,e,o,n,r,i,s){"use strict";function u(t,e,o){var n,r=this,i=r.xhr,s=r.settings;o="object"==typeof o?r.serialize(o):o,e=s.cache===!1?"".concat(e,e.indexOf("?")>-1?"&":"?","_="+(new Date).getTime()):e,e=o&&"GET"===t?"".concat(e,e.indexOf("?")>-1?"&":"?",o):e;for(n in s.xhrOptions)i[n]=s.xhrOptions[n];if(i.open(t,e,s.async,s.username,s.password),i.setRequestHeader){i.setRequestHeader("Accept",s.accept),o&&"GET"!==t&&i.setRequestHeader("Content-Type",s.contentType);for(n in s.header)i.setRequestHeader(n,s.header[n])}i.timeout=s.timeout,i.onprogress=function(t){a.call(r,t)},i.onreadystatechange=i.onload=function(){c.call(r)},i.onerror=function(){l.call(r)},i.send(o||null),r.timeout=setTimeout(function(){p.call(r)},s.timeout)}function a(t){var e=this;e.timeout&&clearTimeout(e.timeout),e.timeout=setTimeout(function(){p.call(e)},e.settings.timeout),e.dfd.notify(t)}function c(){var t=this,e=t.xhr,o=t.dfd;(e.readyState===s||4===e.readyState)&&(d.call(t),e.status===s||200===e.status?o.resolve({data:e.responseText,xhr:e}):o.reject({status:e.status,xhr:e}))}function l(){var t=this;d.call(t),t.dfd.reject()}function p(){var t=this;t.xhr.abort(),d.call(t),t.dfd.reject()}function d(){var t=this,e=t.xhr;t.timeout&&clearTimeout(t.timeout),e.onprogress=e.onreadystatechange=e.onerror=null}var f,m=t.q||r.Q,g=r.XMLHttpRequest!==s?function(e){return t.url.isLocal(e)?new r.XMLHttpRequest:r.XDomainRequest?new r.XDomainRequest:new r.XMLHttpRequest}:function(){try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(t){return null}};return f=t.transport.extend({_settings:{accept:"*/*",timeout:5e3,async:!0,cache:!1,header:{},username:null,password:null,contentType:"application/x-www-form-urlencoded; charset=UTF-8 ",xhrOptions:{}},load:function(e,o,n,r){var i={};return o=t.url.resolve(o),i.url=o,i.id="".concat("xhr-",t["function/unique/string"]()),i.dfd=m.defer(),i.xhr=g(o),i.settings=t["function/merge"]({},this._settings,r),i.timeout=null,u.call(i,e.toUpperCase(),o,n),i.dfd.promise},get:function(t,e,o){return this.load("GET",t,e,o)},post:function(t,e,o){return this.load("POST",t,e,o)},put:function(t,e,o){return this.load("PUT",t,e,o)},"delete":function(t,e,o){return this.load("DELETE",t,e,o)},head:function(t,e,o){return this.load("HEAD",t,e,o)}})},window,document);