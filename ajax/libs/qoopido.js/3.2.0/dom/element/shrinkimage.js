(function(t){var e=["../element","../../proxy","../../function/merge","../../url","../../support","../../support/capability/datauri","../../support/element/canvas/todataurl/png","../../transport/xhr"];window.JSON&&window.JSON.parse||e.push("json"),window.qoopido.register("dom/element/shrinkimage",t,e)})(function(t,e,n,i,r,o){"use strict";function a(e,n){e=t.url.resolve(_.exec(e)[1]),n=n?!0:!1;var i=this,r=t["function/merge"]({},i._settings,t.url.getParameter(e)),o=r.target||(e=e.split("?")[0]).replace(b,"".concat(".q",r.quality,".shrunk"));n||i.removeAttribute(i._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(r.debug).then(function(){switch(typeof v[o]){case"object":v[o].one(E,function(t){l.call(i,t.data,n)}),i.emit(w);break;case"string":l.call(i,v[o],n);break;default:v[o]=p.create(o,n?null:i._element).one(q,function(t){t.type===E?(v[o]=t.data,i.emit(x),l.call(i,t.data,n)):(v[o]=e,l.call(i,e,n))},!1)}}).fail(function(){v[o]=e,l.call(i,e,n)}).done()}function l(t,e){var n=this;e?(n.element.style.backgroundImage="url("+t+")",n.emit(E),n.off()):n.one(A,function(){n.show(),n.emit(E),n.off()}).setAttribute("src",t)}function s(t){var e=this;t.get(e._url).then(function(t){try{var n=d.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),u.call(e,n)}catch(i){e.emit(S)}},function(){e.emit(S)}).done()}function u(t){var n,i,r=this,a=function(a){return n=m?e.pool.dom.obtain("canvas"):o.createElement("canvas"),n.style.display="none",n.width=t.width,n.height=t.height,i=n.getContext("2d"),i.clearRect(0,0,t.width,t.height),i.drawImage(r.element,0,0,t.width,t.height),r.one(A,l).setAttribute("src",t.alpha),c(a)},l=function(e){var o;return i.globalCompositeOperation="xor",i.drawImage(r.element,0,0,t.width,t.height),o=n.toDataURL("image/png"),s(),r.emit(E,o),c(e)},s=function(){n&&n.dispose&&n.dispose(),r.element._quid&&r.element.dispose&&r.element.dispose()};r.one(O,function(t){t.type===A?a.call(this,t):(s(),r.emit(S))},!1).setAttribute("src",t.main)}function c(t){return t.preventDefault(),t.stopPropagation(),!1}var f,p,d=t.json||r.JSON,g=n.pop(),h={attribute:"data-"+g,quality:80,debug:!1},m=e.pool&&e.pool.dom,v={},y=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),_=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),b=RegExp("\\.png$","i"),w="queued",x="cached",E="loaded",S="failed",q="".concat(E," ",S),A="load",j="error",O="".concat(A," ",j);return f=t["dom/element"].extend({_constructor:function(e,n){var i,r,o=this;f._parent._constructor.call(o,e),o._settings=n=t["function/merge"]({},h,n),i=o.getAttribute(n.attribute),r=o.element.style.backgroundImage,"IMG"===o.type&&a.call(o,i),"none"!==r&&y.test(r)&&a.call(o,r,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),p=t["dom/element"].extend({_url:null,_constructor:function(n,i){var r=this;i||(i=m?e.pool.dom.obtain("img"):o.createElement("img")),p._parent._constructor.call(r,i),r._url=n,s.call(r,t["transport/xhr"])}}),f},window);