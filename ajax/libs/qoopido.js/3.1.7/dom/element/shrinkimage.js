(function(t){var e=["../element","../../proxy","../../function/merge","../../url","../../support","../../support/capability/datauri","../../support/element/canvas/todataurl/png","../../transport/xhr"];window.JSON&&window.JSON.parse||e.push("json"),window.qoopido.register("dom/element/shrinkimage",t,e)})(function(t,e,n,i,r){"use strict";function o(e,n){e=t.url.resolve(v.exec(e)[1]),n=n?!0:!1;var i=this,r=t["function/merge"]({},i._settings,t.url.getParameter(e)),o=r.target||(e=e.split("?")[0]).replace(y,"".concat(".q",r.quality,".shrunk"));n||i.removeAttribute(i._settings.attribute).hide(),t.support.testMultiple("/capability/datauri","/element/canvas/todataurl/png").then(r.debug).then(function(){switch(typeof h[o]){case"object":h[o].one(w,function(t){a.call(i,t.data,n)}),i.emit(_);break;case"string":a.call(i,h[o],n);break;default:h[o]=f.create(o,n?null:i._element).one(E,function(t){t.type===w?(h[o]=t.data,i.emit(b),a.call(i,t.data,n)):(h[o]=e,a.call(i,e,n))},!1)}}).fail(function(){h[o]=e,a.call(i,e,n)}).done()}function a(t,e){var n=this;e?(n.element.style.backgroundImage="url("+t+")",n.emit(w),n.off()):n.one(S,function(){n.show(),n.emit(w),n.off()}).setAttribute("src",t)}function l(t){var e=this;t.get(e._url).done(function(t){try{var n=p.parse(t.data);n.width=parseInt(n.width,10),n.height=parseInt(n.height,10),s.call(e,n)}catch(i){e.emit(x)}},function(){e.emit(x)})}function s(t){var n,i,r=this,o=function(o){return n=e.pool.dom.obtain("canvas"),n.style.display="none",n.width=t.width,n.height=t.height,i=n.getContext("2d"),i.clearRect(0,0,t.width,t.height),i.drawImage(r.element,0,0,t.width,t.height),r.one(S,a).setAttribute("src",t.alpha),u(o)},a=function(e){var o;return i.globalCompositeOperation="xor",i.drawImage(r.element,0,0,t.width,t.height),o=n.toDataURL("image/png"),l(),r.emit(w,o),u(e)},l=function(){n&&n.dispose(),r.element._quid&&r.element.dispose&&r.element.dispose()};r.one(A,function(t){t.type===S?o.call(this,t):(l(),r.emit(x))},!1).setAttribute("src",t.main)}function u(t){return t.preventDefault(),t.stopPropagation(),!1}var c,f,p=t.json||r.JSON,d=n.pop(),g={attribute:"data-"+d,quality:80,debug:!1},h={},m=RegExp('^url\\x28"{0,1}data:image/shrink,(.+?)"{0,1}\\x29$',"i"),v=RegExp('^(?:url\\x28"{0,1}|)(?:data:image/shrink,|)(.+?)(?:"{0,1}\\x29|)$',"i"),y=RegExp("\\.png$","i"),_="queued",b="cached",w="loaded",x="failed",E="".concat(w," ",x),S="load",q="error",A="".concat(S," ",q);return c=t["dom/element"].extend({_constructor:function(e,n){var i,r,a=this;c._parent._constructor.call(a,e),a._settings=n=t["function/merge"]({},g,n),i=a.getAttribute(n.attribute),r=a.element.style.backgroundImage,"IMG"===a.type&&o.call(a,i),"none"!==r&&m.test(r)&&o.call(a,r,!0)},hide:function(){this.setStyles({visibility:"hidden",opacity:0})},show:function(){this.setStyles({visibility:"",opacity:""})}}),f=t["dom/element"].extend({_url:null,_constructor:function(n,i){var r=this;i||(i=e.pool.dom.obtain("img")),c._parent._constructor.call(r,i),r._url=n,l.call(r,t["transport/xhr"])}}),c},window);