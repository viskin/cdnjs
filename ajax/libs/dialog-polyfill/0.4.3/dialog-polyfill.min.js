(function(){var supportCustomEvent=window.CustomEvent;if(!supportCustomEvent||typeof supportCustomEvent=="object"){supportCustomEvent=function CustomEvent(event,x){x=x||{};var ev=document.createEvent("CustomEvent");ev.initCustomEvent(event,!!x.bubbles,!!x.cancelable,x.detail||null);return ev};supportCustomEvent.prototype=window.Event.prototype}function findNearestDialog(el){while(el){if(el.nodeName.toUpperCase()=="DIALOG"){return el}el=el.parentElement}return null}function safeBlur(el){if(el&&el.blur&&el!=document.body){el.blur()}}function inNodeList(nodeList,node){for(var i=0;i<nodeList.length;++i){if(nodeList[i]==node){return true}}return false}function dialogPolyfillInfo(dialog){this.dialog_=dialog;this.replacedStyleTop_=false;this.openAsModal_=false;if(!dialog.hasAttribute("role")){dialog.setAttribute("role","dialog")}dialog.show=this.show.bind(this);dialog.showModal=this.showModal.bind(this);dialog.close=this.close.bind(this);if(!("returnValue"in dialog)){dialog.returnValue=""}this.maybeHideModal=this.maybeHideModal.bind(this);if("MutationObserver"in window){var mo=new MutationObserver(this.maybeHideModal);mo.observe(dialog,{attributes:true,attributeFilter:["open"]})}else{dialog.addEventListener("DOMAttrModified",this.maybeHideModal)}Object.defineProperty(dialog,"open",{set:this.setOpen.bind(this),get:dialog.hasAttribute.bind(dialog,"open")});this.backdrop_=document.createElement("div");this.backdrop_.className="backdrop";this.backdropClick_=this.backdropClick_.bind(this)}dialogPolyfillInfo.prototype={get dialog(){return this.dialog_},maybeHideModal:function(){if(!this.openAsModal_){return}if(this.dialog_.hasAttribute("open")&&document.body.contains(this.dialog_)){return}this.openAsModal_=false;this.dialog_.style.zIndex="";if(this.replacedStyleTop_){this.dialog_.style.top="";this.replacedStyleTop_=false}this.backdrop_.removeEventListener("click",this.backdropClick_);if(this.backdrop_.parentElement){this.backdrop_.parentElement.removeChild(this.backdrop_)}dialogPolyfill.dm.removeDialog(this)},setOpen:function(value){if(value){this.dialog_.hasAttribute("open")||this.dialog_.setAttribute("open","")}else{this.dialog_.removeAttribute("open");this.maybeHideModal()}},backdropClick_:function(e){var redirectedEvent=document.createEvent("MouseEvents");redirectedEvent.initMouseEvent(e.type,e.bubbles,e.cancelable,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget);this.dialog_.dispatchEvent(redirectedEvent);e.stopPropagation()},updateZIndex:function(backdropZ,dialogZ){this.backdrop_.style.zIndex=backdropZ;this.dialog_.style.zIndex=dialogZ},show:function(){this.setOpen(true)},showModal:function(){if(this.dialog_.hasAttribute("open")){throw new Error("Failed to execute 'showModal' on dialog: The element is already open, and therefore cannot be opened modally.")}if(!document.body.contains(this.dialog_)){throw new Error("Failed to execute 'showModal' on dialog: The element is not in a Document.")}if(!dialogPolyfill.dm.pushDialog(this)){throw new Error("Failed to execute 'showModal' on dialog: There are too many open modal dialogs.")}this.show();this.openAsModal_=true;if(dialogPolyfill.needsCentering(this.dialog_)){dialogPolyfill.reposition(this.dialog_);this.replacedStyleTop_=true}else{this.replacedStyleTop_=false}this.backdrop_.addEventListener("click",this.backdropClick_);this.dialog_.parentNode.insertBefore(this.backdrop_,this.dialog_.nextSibling);var target=this.dialog_.querySelector("[autofocus]:not([disabled])");if(!target){var opts=["button","input","keygen","select","textarea"];var query=opts.map(function(el){return el+":not([disabled])"}).join(", ");target=this.dialog_.querySelector(query)}safeBlur(document.activeElement);target&&target.focus()},close:function(opt_returnValue){if(!this.dialog_.hasAttribute("open")){throw new Error("Failed to execute 'close' on dialog: The element does not have an 'open' attribute, and therefore cannot be closed.")}this.setOpen(false);if(opt_returnValue!==undefined){this.dialog_.returnValue=opt_returnValue}var closeEvent=new supportCustomEvent("close",{bubbles:false,cancelable:false});this.dialog_.dispatchEvent(closeEvent)}};var dialogPolyfill={};dialogPolyfill.reposition=function(element){var scrollTop=document.body.scrollTop||document.documentElement.scrollTop;var topValue=scrollTop+(window.innerHeight-element.offsetHeight)/2;element.style.top=Math.max(scrollTop,topValue)+"px"};dialogPolyfill.isInlinePositionSetByStylesheet=function(element){for(var i=0;i<document.styleSheets.length;++i){var styleSheet=document.styleSheets[i];var cssRules=null;try{cssRules=styleSheet.cssRules}catch(e){}if(!cssRules)continue;for(var j=0;j<cssRules.length;++j){var rule=cssRules[j];var selectedNodes=null;try{selectedNodes=document.querySelectorAll(rule.selectorText)}catch(e){}if(!selectedNodes||!inNodeList(selectedNodes,element))continue;var cssTop=rule.style.getPropertyValue("top");var cssBottom=rule.style.getPropertyValue("bottom");if(cssTop&&cssTop!="auto"||cssBottom&&cssBottom!="auto")return true}}return false};dialogPolyfill.needsCentering=function(dialog){var computedStyle=window.getComputedStyle(dialog);if(computedStyle.position!="absolute"){return false}if(dialog.style.top!="auto"&&dialog.style.top!=""||dialog.style.bottom!="auto"&&dialog.style.bottom!="")return false;return!dialogPolyfill.isInlinePositionSetByStylesheet(dialog)};dialogPolyfill.forceRegisterDialog=function(element){if(element.showModal){console.warn("This browser already supports <dialog>, the polyfill "+"may not work correctly",element)}if(element.nodeName.toUpperCase()!="DIALOG"){throw new Error("Failed to register dialog: The element is not a dialog.")}new dialogPolyfillInfo(element)};dialogPolyfill.registerDialog=function(element){if(element.showModal){console.warn("Can't upgrade <dialog>: already supported",element)}else{dialogPolyfill.forceRegisterDialog(element)}};dialogPolyfill.DialogManager=function(){this.pendingDialogStack=[];this.overlay=document.createElement("div");this.overlay.className="_dialog_overlay";this.overlay.addEventListener("click",function(e){e.stopPropagation()});this.handleKey_=this.handleKey_.bind(this);this.handleFocus_=this.handleFocus_.bind(this);this.handleRemove_=this.handleRemove_.bind(this);this.zIndexLow_=1e5;this.zIndexHigh_=1e5+150};dialogPolyfill.DialogManager.prototype.topDialogElement=function(){if(this.pendingDialogStack.length){var t=this.pendingDialogStack[this.pendingDialogStack.length-1];return t.dialog}return null};dialogPolyfill.DialogManager.prototype.blockDocument=function(){document.body.appendChild(this.overlay);document.body.addEventListener("focus",this.handleFocus_,true);document.addEventListener("keydown",this.handleKey_);document.addEventListener("DOMNodeRemoved",this.handleRemove_)};dialogPolyfill.DialogManager.prototype.unblockDocument=function(){document.body.removeChild(this.overlay);document.body.removeEventListener("focus",this.handleFocus_,true);document.removeEventListener("keydown",this.handleKey_);document.removeEventListener("DOMNodeRemoved",this.handleRemove_)};dialogPolyfill.DialogManager.prototype.updateStacking=function(){var zIndex=this.zIndexLow_;for(var i=0;i<this.pendingDialogStack.length;i++){if(i==this.pendingDialogStack.length-1){this.overlay.style.zIndex=zIndex++}this.pendingDialogStack[i].updateZIndex(zIndex++,zIndex++)}};dialogPolyfill.DialogManager.prototype.handleFocus_=function(event){var candidate=findNearestDialog(event.target);if(candidate!=this.topDialogElement()){event.preventDefault();event.stopPropagation();safeBlur(event.target);return false}};dialogPolyfill.DialogManager.prototype.handleKey_=function(event){if(event.keyCode==27){event.preventDefault();event.stopPropagation();var cancelEvent=new supportCustomEvent("cancel",{bubbles:false,cancelable:true});var dialog=this.topDialogElement();if(dialog.dispatchEvent(cancelEvent)){dialog.close()}}};dialogPolyfill.DialogManager.prototype.handleRemove_=function(event){if(event.target.nodeName.toUpperCase()!="DIALOG"){return}var dialog=event.target;if(!dialog.open){return}this.pendingDialogStack.some(function(dpi){if(dpi.dialog==dialog){dpi.maybeHideModal();return true}})};dialogPolyfill.DialogManager.prototype.pushDialog=function(dpi){var allowed=(this.zIndexHigh_-this.zIndexLow_)/2-1;if(this.pendingDialogStack.length>=allowed){return false}this.pendingDialogStack.push(dpi);if(this.pendingDialogStack.length==1){this.blockDocument()}this.updateStacking();return true};dialogPolyfill.DialogManager.prototype.removeDialog=function(dpi){var index=this.pendingDialogStack.indexOf(dpi);if(index==-1){return}this.pendingDialogStack.splice(index,1);this.updateStacking();if(this.pendingDialogStack.length==0){this.unblockDocument()}};dialogPolyfill.dm=new dialogPolyfill.DialogManager;document.addEventListener("submit",function(ev){var target=ev.target;if(!target||!target.hasAttribute("method")){return}if(target.getAttribute("method").toLowerCase()!="dialog"){return}ev.preventDefault();var dialog=findNearestDialog(ev.target);if(!dialog){return}var returnValue;var cands=[document.activeElement,ev.explicitOriginalTarget];var els=["BUTTON","INPUT"];cands.some(function(cand){if(cand&&cand.form==ev.target&&els.indexOf(cand.nodeName.toUpperCase())!=-1){returnValue=cand.value;return true}});dialog.close(returnValue)},true);dialogPolyfill["forceRegisterDialog"]=dialogPolyfill.forceRegisterDialog;dialogPolyfill["registerDialog"]=dialogPolyfill.registerDialog;if(typeof module==="object"&&typeof module["exports"]==="object"){module["exports"]=dialogPolyfill}else if(typeof define==="function"&&"amd"in define){define(function(){return dialogPolyfill})}else{window["dialogPolyfill"]=dialogPolyfill}})();
