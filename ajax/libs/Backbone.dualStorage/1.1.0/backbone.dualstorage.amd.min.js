!function(e,t){return"function"==typeof define&&define.amd?define(["backbone"],function(r){return e.Backbone.DualStorage=t(r)}):"function"==typeof require&&null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=t(require("backbone")):e.Backbone.DualStorage=t(e.Backbone)}(this,function(e){var t,r,n,o,i,s,c,a,u;e.Collection.prototype.syncDirty=function(){var e,t,r,n,o,i,s,c;for(o=u(this,"url"),n=localStorage.getItem(""+o+"_dirty"),t=n&&n.split(",")||[],c=[],i=0,s=t.length;s>i;i++)e=t[i],r=36===e.length?this.where({id:e})[0]:this.get(e),c.push(r.save());return c},e.Collection.prototype.syncDestroyed=function(){var e,t,r,n,o,i,s,c;for(o=u(this,"url"),n=localStorage.getItem(""+o+"_destroyed"),t=n&&n.split(",")||[],c=[],i=0,s=t.length;s>i;i++)e=t[i],r=new this.model({id:e}),r.collection=this,c.push(r.destroy());return c},e.Collection.prototype.syncDirtyAndDestroyed=function(){return this.syncDirty(),this.syncDestroyed()},t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function e(e){this.name=e,this.records=this.recordsOn(this.name)}return e.prototype.sep="",e.prototype.generateId=function(){return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},e.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},e.prototype.recordsOn=function(e){var t;return t=localStorage.getItem(e),t&&t.split(",")||[]},e.prototype.dirty=function(e){var t;return t=this.recordsOn(this.name+"_dirty"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_dirty",t.join(","))),e},e.prototype.clean=function(e,t){var r,n;return n=""+this.name+"_"+t,r=this.recordsOn(n),_.include(r,e.id.toString())&&localStorage.setItem(n,_.without(r,e.id.toString()).join(",")),e},e.prototype.destroyed=function(e){var t;return t=this.recordsOn(this.name+"_destroyed"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_destroyed",t.join(","))),e},e.prototype.create=function(e){return _.isObject(e)?(e.id||(e.id=this.generateId(),e.set(e.idAttribute,e.id)),localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),this.records.push(e.id.toString()),this.save(),e):e},e.prototype.update=function(e){return localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),_.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),e},e.prototype.clear=function(){var e,t,r,n;for(n=this.records,t=0,r=n.length;r>t;t++)e=n[t],localStorage.removeItem(this.name+this.sep+e);return this.records=[],this.save()},e.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},e.prototype.find=function(e){return JSON.parse(localStorage.getItem(this.name+this.sep+e.id))},e.prototype.findAll=function(){var e,t,r,n,o;for(n=this.records,o=[],t=0,r=n.length;r>t;t++)e=n[t],o.push(JSON.parse(localStorage.getItem(this.name+this.sep+e)));return o},e.prototype.destroy=function(e){return localStorage.removeItem(this.name+this.sep+e.id),this.records=_.reject(this.records,function(t){return t===e.id.toString()}),this.save(),e},e}(),n={needsTranslation:"0.9.10"===e.VERSION,forBackboneCaller:function(e){return this.needsTranslation?function(t,r,n){return e.call(null,r)}:e},forDualstorageCaller:function(e,t,r){return this.needsTranslation?function(n){return e.call(null,t,n,r)}:e}},i=function(t,r,n){var o,i,s,c;if(o="clear"===t||"hasDirtyOrDestroyed"===t,o||(o=r instanceof e.Model),o||(o=r instanceof e.Collection),!o)throw new Error("model parameter is required to be a backbone model or collection.");return c=new Store(n.storeName),s=function(){switch(t){case"read":return r.id?c.find(r):c.findAll();case"hasDirtyOrDestroyed":return c.hasDirtyOrDestroyed();case"clear":return c.clear();case"create":return n.add&&!n.merge&&(i=c.find(r))?i:(r=c.create(r),n.dirty&&c.dirty(r),r);case"update":return c.update(r),n.dirty?c.dirty(r):c.clean(r,"dirty");case"delete":return c.destroy(r),n.dirty?c.destroyed(r):36===r.id.toString().length?c.clean(r,"dirty"):c.clean(r,"destroyed")}}(),(null!=s?s.attributes:void 0)&&(s=s.attributes),n.ignoreCallbacks||(s?n.success(s):n.error("Record not found")),s},u=function(e,t){var r;return e?(r=e[t],_.isFunction(r)?r.call(e):r):null},a=function(e,t){return e&&e.parseBeforeLocalSave?_.isFunction(e.parseBeforeLocalSave)?e.parseBeforeLocalSave(t):void 0:t},s=function(e,t){var r;return r=e.clone(),r.set(r.parse(t)),r},r=e.sync,c=function(e,t,o){return o.success=n.forBackboneCaller(o.success),o.error=n.forBackboneCaller(o.error),r(e,t,o)},o=function(e,t,r){var o,l,d,f;if(r.storeName=u(t.collection,"url")||u(t,"url"),r.success=n.forDualstorageCaller(r.success,t,r),r.error=n.forDualstorageCaller(r.error,t,r),u(t,"remote")||u(t.collection,"remote"))return c(e,t,r);if(l=u(t,"local")||u(t.collection,"local"),r.dirty=r.remote===!1&&!l,r.remote===!1||l)return i(e,t,r);switch(r.ignoreCallbacks=!0,f=r.success,o=r.error,e){case"read":return i("hasDirtyOrDestroyed",t,r)?f(i(e,t,r)):(r.success=function(e,n,o){var c,u,l,d,h;if(e=a(t,e),r.add||i("clear",t,r),_.isArray(e))for(c=t,d=0,h=e.length;h>d;d++)u=e[d],l=s(new c.model,u),i("create",l,r);else l=s(new t.constructor,e),i("create",l,r);return f(e,n,o)},r.error=function(n){return f(i(e,t,r))},c(e,t,r));case"create":return r.success=function(n,o,c){var a;return a=s(t,n),i(e,a,r),f(n,o,c)},r.error=function(n){return r.dirty=!0,f(i(e,t,r))},c(e,t,r);case"update":return _.isString(t.id)&&36===t.id.length?(d=t.clone(),r.success=function(e,n,o){var c;return c=s(t,e),i("delete",d,r),i("create",c,r),f(e,n,o)},r.error=function(t){return r.dirty=!0,f(i(e,d,r))},t.set({id:null}),c("create",t,r)):(r.success=function(n,o,c){var a;return a=s(t,n),i(e,a,r),f(n,o,c)},r.error=function(n){return r.dirty=!0,f(i(e,t,r))},c(e,t,r));case"delete":return _.isString(t.id)&&36===t.id.length?i(e,t,r):(r.success=function(n,o,s){return i(e,t,r),f(n,o,s)},r.error=function(n){return r.dirty=!0,f(i(e,t,r))},c(e,t,r))}},e.sync=o});
//# sourceMappingURL=./backbone.dualstorage.amd.min.js.map