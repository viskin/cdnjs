(function(){var e,t,r,n,o,i,s,c,a;Backbone.Collection.prototype.syncDirty=function(){var e,t,r,n,o,i,s,c;for(o=a(this,"url"),n=localStorage.getItem(""+o+"_dirty"),t=n&&n.split(",")||[],c=[],i=0,s=t.length;s>i;i++)e=t[i],r=36===e.length?this.where({id:e})[0]:this.get(e),c.push(r.save());return c},Backbone.Collection.prototype.syncDestroyed=function(){var e,t,r,n,o,i,s,c;for(o=a(this,"url"),n=localStorage.getItem(""+o+"_destroyed"),t=n&&n.split(",")||[],c=[],i=0,s=t.length;s>i;i++)e=t[i],r=new this.model({id:e}),r.collection=this,c.push(r.destroy());return c},Backbone.Collection.prototype.syncDirtyAndDestroyed=function(){return this.syncDirty(),this.syncDestroyed()},e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function t(e){this.name=e,this.records=this.recordsOn(this.name)}return t.prototype.sep="",t.prototype.generateId=function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},t.prototype.recordsOn=function(e){var t;return t=localStorage.getItem(e),t&&t.split(",")||[]},t.prototype.dirty=function(e){var t;return t=this.recordsOn(this.name+"_dirty"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_dirty",t.join(","))),e},t.prototype.clean=function(e,t){var r,n;return n=""+this.name+"_"+t,r=this.recordsOn(n),_.include(r,e.id.toString())&&localStorage.setItem(n,_.without(r,e.id.toString()).join(",")),e},t.prototype.destroyed=function(e){var t;return t=this.recordsOn(this.name+"_destroyed"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_destroyed",t.join(","))),e},t.prototype.create=function(e){return _.isObject(e)?(e.id||(e.id=this.generateId(),e.set(e.idAttribute,e.id)),localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),this.records.push(e.id.toString()),this.save(),e):e},t.prototype.update=function(e){return localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),_.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),e},t.prototype.clear=function(){var e,t,r,n;for(n=this.records,t=0,r=n.length;r>t;t++)e=n[t],localStorage.removeItem(this.name+this.sep+e);return this.records=[],this.save()},t.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},t.prototype.find=function(e){return JSON.parse(localStorage.getItem(this.name+this.sep+e.id))},t.prototype.findAll=function(){var e,t,r,n,o;for(n=this.records,o=[],t=0,r=n.length;r>t;t++)e=n[t],o.push(JSON.parse(localStorage.getItem(this.name+this.sep+e)));return o},t.prototype.destroy=function(e){return localStorage.removeItem(this.name+this.sep+e.id),this.records=_.reject(this.records,function(t){return t===e.id.toString()}),this.save(),e},t}(),r={needsTranslation:"0.9.10"===Backbone.VERSION,forBackboneCaller:function(e){return this.needsTranslation?function(t,r,n){return e.call(null,r)}:e},forDualstorageCaller:function(e,t,r){return this.needsTranslation?function(n){return e.call(null,t,n,r)}:e}},o=function(e,t,r){var n,o,i,s;if(n="clear"===e||"hasDirtyOrDestroyed"===e,n||(n=t instanceof Backbone.Model),n||(n=t instanceof Backbone.Collection),!n)throw new Error("model parameter is required to be a backbone model or collection.");return s=new Store(r.storeName),i=function(){switch(e){case"read":return t.id?s.find(t):s.findAll();case"hasDirtyOrDestroyed":return s.hasDirtyOrDestroyed();case"clear":return s.clear();case"create":return r.add&&!r.merge&&(o=s.find(t))?o:(t=s.create(t),r.dirty&&s.dirty(t),t);case"update":return s.update(t),r.dirty?s.dirty(t):s.clean(t,"dirty");case"delete":return s.destroy(t),r.dirty?s.destroyed(t):36===t.id.toString().length?s.clean(t,"dirty"):s.clean(t,"destroyed")}}(),(null!=i?i.attributes:void 0)&&(i=i.attributes),r.ignoreCallbacks||(i?r.success(i):r.error("Record not found")),i},a=function(e,t){var r;return e?(r=e[t],_.isFunction(r)?r.call(e):r):null},c=function(e,t){return e&&e.parseBeforeLocalSave?_.isFunction(e.parseBeforeLocalSave)?e.parseBeforeLocalSave(t):void 0:t},i=function(e,t){var r;return r=e.clone(),r.set(r.parse(t)),r},t=Backbone.sync,s=function(e,n,o){return o.success=r.forBackboneCaller(o.success),o.error=r.forBackboneCaller(o.error),t(e,n,o)},n=function(e,t,n){var u,l,d,h;if(n.storeName=a(t.collection,"url")||a(t,"url"),n.success=r.forDualstorageCaller(n.success,t,n),n.error=r.forDualstorageCaller(n.error,t,n),a(t,"remote")||a(t.collection,"remote"))return s(e,t,n);if(l=a(t,"local")||a(t.collection,"local"),n.dirty=n.remote===!1&&!l,n.remote===!1||l)return o(e,t,n);switch(n.ignoreCallbacks=!0,h=n.success,u=n.error,e){case"read":return o("hasDirtyOrDestroyed",t,n)?h(o(e,t,n)):(n.success=function(e,r,s){var a,u,l,d,y;if(e=c(t,e),n.add||o("clear",t,n),_.isArray(e))for(a=t,d=0,y=e.length;y>d;d++)u=e[d],l=i(new a.model,u),o("create",l,n);else l=i(new t.constructor,e),o("create",l,n);return h(e,r,s)},n.error=function(r){return h(o(e,t,n))},s(e,t,n));case"create":return n.success=function(r,s,c){var a;return a=i(t,r),o(e,a,n),h(r,s,c)},n.error=function(r){return n.dirty=!0,h(o(e,t,n))},s(e,t,n);case"update":return _.isString(t.id)&&36===t.id.length?(d=t.clone(),n.success=function(e,r,s){var c;return c=i(t,e),o("delete",d,n),o("create",c,n),h(e,r,s)},n.error=function(t){return n.dirty=!0,h(o(e,d,n))},t.set({id:null}),s("create",t,n)):(n.success=function(r,s,c){var a;return a=i(t,r),o(e,a,n),h(r,s,c)},n.error=function(r){return n.dirty=!0,h(o(e,t,n))},s(e,t,n));case"delete":return _.isString(t.id)&&36===t.id.length?o(e,t,n):(n.success=function(r,i,s){return o(e,t,n),h(r,i,s)},n.error=function(r){return n.dirty=!0,h(o(e,t,n))},s(e,t,n))}},Backbone.sync=n}).call(this);
//# sourceMappingURL=./backbone.dualstorage.min.js.map