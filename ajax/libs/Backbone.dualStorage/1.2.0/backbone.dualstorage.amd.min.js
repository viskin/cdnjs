!function(t,e){return"function"==typeof define&&define.amd?define(["backbone"],function(r){return t.Backbone.DualStorage=e(r)}):"function"==typeof require&&null!=("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=e(require("backbone")):t.Backbone.DualStorage=e(t.Backbone)}(this,function(t){var e,r,o,n,i,s,a,c,u,l;t.Model.prototype.hasTempId=function(){return _.isString(this.id)&&36===this.id.length},i=function(t,e){return e||(e=t.model.prototype),l(t,"storeName")||l(e,"storeName")||l(t,"url")||l(e,"urlRoot")||l(e,"url")},t.Collection.prototype.syncDirty=function(){var t,e,r,o,n,s,a;for(r=localStorage.getItem(""+i(this)+"_dirty"),e=r&&r.split(",")||[],a=[],o=0,n=e.length;n>o;o++)t=e[o],a.push(null!=(s=this.get(t))?s.save():void 0);return a},t.Collection.prototype.dirtyModels=function(){var t,e,r,o;return o=localStorage.getItem(""+i(this)+"_dirty"),e=o&&o.split(",")||[],r=function(){var r,o,n;for(n=[],r=0,o=e.length;o>r;r++)t=e[r],n.push(this.get(t));return n}.call(this),_(r).compact()},t.Collection.prototype.syncDestroyed=function(){var t,e,r,o,n,s,a;for(o=localStorage.getItem(""+i(this)+"_destroyed"),e=o&&o.split(",")||[],a=[],n=0,s=e.length;s>n;n++)t=e[n],r=new this.model({id:t}),r.collection=this,a.push(r.destroy());return a},t.Collection.prototype.destroyedModelIds=function(){var t,e;return e=localStorage.getItem(""+i(this)+"_destroyed"),t=e&&e.split(",")||[]},t.Collection.prototype.syncDirtyAndDestroyed=function(){return this.syncDirty(),this.syncDestroyed()},e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function t(t){this.name=t,this.records=this.recordsOn(this.name)}return t.prototype.sep="",t.prototype.generateId=function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},t.prototype.recordsOn=function(t){var e;return e=localStorage.getItem(t),e&&e.split(",")||[]},t.prototype.dirty=function(t){var e;return e=this.recordsOn(this.name+"_dirty"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_dirty",e.join(","))),t},t.prototype.clean=function(t,e){var r,o;return o=""+this.name+"_"+e,r=this.recordsOn(o),_.include(r,t.id.toString())&&localStorage.setItem(o,_.without(r,t.id.toString()).join(",")),t},t.prototype.destroyed=function(t){var e;return e=this.recordsOn(this.name+"_destroyed"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_destroyed",e.join(","))),t},t.prototype.create=function(t){return _.isObject(t)?(t.id||(t.id=this.generateId(),t.set(t.idAttribute,t.id)),localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t)),this.records.push(t.id.toString()),this.save(),t):t},t.prototype.update=function(t){return localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t)),_.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),t},t.prototype.clear=function(){var t,e,r,o;for(o=this.records,e=0,r=o.length;r>e;e++)t=o[e],localStorage.removeItem(this.name+this.sep+t);return this.records=[],this.save()},t.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},t.prototype.find=function(t){var e;return e=localStorage.getItem(this.name+this.sep+t.id),null===e?null:JSON.parse(e)},t.prototype.findAll=function(){var t,e,r,o,n;for(o=this.records,n=[],e=0,r=o.length;r>e;e++)t=o[e],n.push(JSON.parse(localStorage.getItem(this.name+this.sep+t)));return n},t.prototype.destroy=function(t){return localStorage.removeItem(this.name+this.sep+t.id),this.records=_.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t},t}(),o={needsTranslation:"0.9.10"===t.VERSION,forBackboneCaller:function(t){return this.needsTranslation?function(e,r,o){return t.call(null,r)}:t},forDualstorageCaller:function(t,e,r){return this.needsTranslation?function(o){return t.call(null,e,o,r)}:t}},s=function(e,r,o){var n,i,s,a;if(n="clear"===e||"hasDirtyOrDestroyed"===e,n||(n=r instanceof t.Model),n||(n=r instanceof t.Collection),!n)throw new Error("model parameter is required to be a backbone model or collection.");return a=new Store(o.storeName),s=function(){switch(e){case"read":return r.id?a.find(r):a.findAll();case"hasDirtyOrDestroyed":return a.hasDirtyOrDestroyed();case"clear":return a.clear();case"create":return o.add&&!o.merge&&(i=a.find(r))?i:(r=a.create(r),o.dirty&&a.dirty(r),r);case"update":return a.update(r),o.dirty?a.dirty(r):a.clean(r,"dirty");case"delete":return a.destroy(r),o.dirty?a.destroyed(r):36===r.id.toString().length?a.clean(r,"dirty"):a.clean(r,"destroyed")}}(),(null!=s?s.attributes:void 0)&&(s=s.attributes),o.ignoreCallbacks||(s?o.success(s):o.error("Record not found")),s},l=function(t,e){var r;return t?(r=t[e],_.isFunction(r)?r.call(t):r):null},u=function(t,e){return t&&t.parseBeforeLocalSave?_.isFunction(t.parseBeforeLocalSave)?t.parseBeforeLocalSave(e):void 0:e},a=function(e,r){var o;return o=new t.Model,o.idAttribute=e.idAttribute,o.set(e.attributes),o.set(o.parse(r)),o},r=t.sync,c=function(t,e,n){return n.success=o.forBackboneCaller(n.success),n.error=o.forBackboneCaller(n.error),r(t,e,n)},n=function(t,e,r){var n,d,f,h;if(r.storeName=i(e.collection,e),r.success=o.forDualstorageCaller(r.success,e,r),r.error=o.forDualstorageCaller(r.error,e,r),l(e,"remote")||l(e.collection,"remote"))return c(t,e,r);if(d=l(e,"local")||l(e.collection,"local"),r.dirty=r.remote===!1&&!d,r.remote===!1||d)return s(t,e,r);switch(r.ignoreCallbacks=!0,f=r.success,n=r.error,t){case"read":return s("hasDirtyOrDestroyed",e,r)?f(s(t,e,r)):(r.success=function(t,o,n){var i,c,l,d,h,p;if(t=u(e,t),r.add||s("clear",e,r),_.isArray(t))for(i=e,c=i.model.prototype.idAttribute,h=0,p=t.length;p>h;h++)l=t[h],e=i.get(l[c]),d=e?a(e,l):new i.model(l),s("create",d,r);else d=a(e,t),s("create",d,r);return f(t,o,n)},r.error=function(o){return f(s(t,e,r))},c(t,e,r));case"create":return r.success=function(o,n,i){var c;return c=a(e,o),s(t,c,r),f(o,n,i)},r.error=function(o){return r.dirty=!0,f(s(t,e,r))},c(t,e,r);case"update":return e.hasTempId()?(h=e.id,r.success=function(t,o,n){var i;return i=a(e,t),e.set(e.idAttribute,h,{silent:!0}),s("delete",e,r),s("create",i,r),f(t,o,n)},r.error=function(o){return r.dirty=!0,e.set(e.idAttribute,h,{silent:!0}),f(s(t,e,r))},e.set(e.idAttribute,null,{silent:!0}),c("create",e,r)):(r.success=function(o,n,i){var c;return c=a(e,o),s(t,c,r),f(o,n,i)},r.error=function(o){return r.dirty=!0,f(s(t,e,r))},c(t,e,r));case"delete":return e.hasTempId()?s(t,e,r):(r.success=function(o,n,i){return s(t,e,r),f(o,n,i)},r.error=function(o){return r.dirty=!0,f(s(t,e,r))},c(t,e,r))}},t.sync=n});
//# sourceMappingURL=./backbone.dualstorage.amd.min.js.map