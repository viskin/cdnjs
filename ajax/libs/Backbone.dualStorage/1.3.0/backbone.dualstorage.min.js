(function(){var t,e,r,o,n,i,s,a,c,u,l=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};Backbone.DualStorage={offlineStatusCodes:[408,502]},Backbone.Model.prototype.hasTempId=function(){return _.isString(this.id)&&36===this.id.length},n=function(t,e){return e||(e=t.model.prototype),u(t,"storeName")||u(e,"storeName")||u(t,"url")||u(e,"urlRoot")||u(e,"url")},Backbone.Collection.prototype.syncDirty=function(){var t,e,r,o,i,s,a;for(r=localStorage.getItem(""+n(this)+"_dirty"),e=r&&r.split(",")||[],a=[],o=0,i=e.length;i>o;o++)t=e[o],a.push(null!=(s=this.get(t))?s.save():void 0);return a},Backbone.Collection.prototype.dirtyModels=function(){var t,e,r,o;return o=localStorage.getItem(""+n(this)+"_dirty"),e=o&&o.split(",")||[],r=function(){var r,o,n;for(n=[],r=0,o=e.length;o>r;r++)t=e[r],n.push(this.get(t));return n}.call(this),_(r).compact()},Backbone.Collection.prototype.syncDestroyed=function(){var t,e,r,o,i,s,a;for(o=localStorage.getItem(""+n(this)+"_destroyed"),e=o&&o.split(",")||[],a=[],i=0,s=e.length;s>i;i++)t=e[i],r=new this.model,r.id=t,r.collection=this,a.push(r.destroy());return a},Backbone.Collection.prototype.destroyedModelIds=function(){var t,e;return e=localStorage.getItem(""+n(this)+"_destroyed"),t=e&&e.split(",")||[]},Backbone.Collection.prototype.syncDirtyAndDestroyed=function(){return this.syncDirty(),this.syncDestroyed()},t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function e(t){this.name=t,this.records=this.recordsOn(this.name)}return e.prototype.sep="",e.prototype.generateId=function(){return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},e.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},e.prototype.recordsOn=function(t){var e;return e=localStorage.getItem(t),e&&e.split(",")||[]},e.prototype.dirty=function(t){var e;return e=this.recordsOn(this.name+"_dirty"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_dirty",e.join(","))),t},e.prototype.clean=function(t,e){var r,o;return o=""+this.name+"_"+e,r=this.recordsOn(o),_.include(r,t.id.toString())&&localStorage.setItem(o,_.without(r,t.id.toString()).join(",")),t},e.prototype.destroyed=function(t){var e;return e=this.recordsOn(this.name+"_destroyed"),_.include(e,t.id.toString())||(e.push(t.id),localStorage.setItem(this.name+"_destroyed",e.join(","))),t},e.prototype.create=function(t){return _.isObject(t)?(t.id||(t.id=this.generateId(),t.set(t.idAttribute,t.id)),localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t)),this.records.push(t.id.toString()),this.save(),t):t},e.prototype.update=function(t){return localStorage.setItem(this.name+this.sep+t.id,JSON.stringify(t)),_.include(this.records,t.id.toString())||this.records.push(t.id.toString()),this.save(),t},e.prototype.clear=function(){var t,e,r,o;for(o=this.records,e=0,r=o.length;r>e;e++)t=o[e],localStorage.removeItem(this.name+this.sep+t);return this.records=[],this.save()},e.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},e.prototype.find=function(t){var e;return e=localStorage.getItem(this.name+this.sep+t.id),null===e?null:JSON.parse(e)},e.prototype.findAll=function(){var t,e,r,o,n;for(o=this.records,n=[],e=0,r=o.length;r>e;e++)t=o[e],n.push(JSON.parse(localStorage.getItem(this.name+this.sep+t)));return n},e.prototype.destroy=function(t){return localStorage.removeItem(this.name+this.sep+t.id),this.records=_.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t},e}(),r={needsTranslation:"0.9.10"===Backbone.VERSION,forBackboneCaller:function(t){return this.needsTranslation?function(e,r,o){return t.call(null,r)}:t},forDualstorageCaller:function(t,e,r){return this.needsTranslation?function(o){return t.call(null,e,o,r)}:t}},i=function(t,e,r){var o,n,i,s;if(o="clear"===t||"hasDirtyOrDestroyed"===t,o||(o=e instanceof Backbone.Model),o||(o=e instanceof Backbone.Collection),!o)throw new Error("model parameter is required to be a backbone model or collection.");return s=new Store(r.storeName),i=function(){switch(t){case"read":return e instanceof Backbone.Model?s.find(e):s.findAll();case"hasDirtyOrDestroyed":return s.hasDirtyOrDestroyed();case"clear":return s.clear();case"create":return r.add&&!r.merge&&(n=s.find(e))?n:(e=s.create(e),r.dirty&&s.dirty(e),e);case"update":return s.update(e),r.dirty?s.dirty(e):s.clean(e,"dirty");case"delete":return s.destroy(e),r.dirty?s.destroyed(e):36===e.id.toString().length?s.clean(e,"dirty"):s.clean(e,"destroyed")}}(),(null!=i?i.attributes:void 0)&&(i=i.attributes),r.ignoreCallbacks||(i?r.success(i):r.error("Record not found")),i},u=function(t,e){var r;return t?(r=t[e],_.isFunction(r)?r.call(t):r):null},c=function(t,e){return t&&t.parseBeforeLocalSave?_.isFunction(t.parseBeforeLocalSave)?t.parseBeforeLocalSave(e):void 0:e},s=function(t,e){var r;return r=new Backbone.Model,r.idAttribute=t.idAttribute,r.set(t.attributes),r.set(t.parse(e)),r},e=Backbone.sync,a=function(t,o,n){return n.success=r.forBackboneCaller(n.success),n.error=r.forBackboneCaller(n.error),e(t,o,n)},o=function(t,e,o){var d,h,f,p,y;if(o.storeName=n(e.collection,e),o.success=r.forDualstorageCaller(o.success,e,o),o.error=r.forDualstorageCaller(o.error,e,o),u(e,"remote")||u(e.collection,"remote"))return a(t,e,o);if(h=u(e,"local")||u(e.collection,"local"),o.dirty=o.remote===!1&&!h,o.remote===!1||h)return i(t,e,o);switch(o.ignoreCallbacks=!0,p=o.success,d=o.error,f=function(r){var n,s,a;return s=Backbone.DualStorage.offlineStatusCodes,_.isFunction(s)&&(s=s(r)),n=0===r.status||(a=r.status,l.call(s,a)>=0),n?(o.dirty=!0,p(i(t,e,o))):d(r)},t){case"read":return i("hasDirtyOrDestroyed",e,o)?(o.dirty=!0,p(i(t,e,o))):(o.success=function(t,r,n){var a,u,l,d,h,f;if(t=c(e,t),e instanceof Backbone.Collection)for(a=e,u=a.model.prototype.idAttribute,o.add||i("clear",a,o),h=0,f=t.length;f>h;h++)l=t[h],e=a.get(l[u]),d=e?s(e,l):new a.model(l),i("update",d,o);else d=s(e,t),i("update",d,o);return p(t,r,n)},o.error=function(t){return f(t)},a(t,e,o));case"create":return o.success=function(r,n,a){var c;return c=s(e,r),i(t,c,o),p(r,n,a)},o.error=function(t){return f(t)},a(t,e,o);case"update":return e.hasTempId()?(y=e.id,o.success=function(t,r,n){var a;return a=s(e,t),e.set(e.idAttribute,y,{silent:!0}),i("delete",e,o),i("create",a,o),p(t,r,n)},o.error=function(t){return e.set(e.idAttribute,y,{silent:!0}),f(t)},e.set(e.idAttribute,null,{silent:!0}),a("create",e,o)):(o.success=function(r,n,a){var c;return c=s(e,r),i(t,c,o),p(r,n,a)},o.error=function(t){return f(t)},a(t,e,o));case"delete":return e.hasTempId()?i(t,e,o):(o.success=function(r,n,s){return i(t,e,o),p(r,n,s)},o.error=function(t){return f(t)},a(t,e,o))}},Backbone.sync=o}).call(this);
//# sourceMappingURL=./backbone.dualstorage.min.js.map