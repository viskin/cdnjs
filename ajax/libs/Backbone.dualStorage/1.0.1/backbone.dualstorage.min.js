(function(){var e,t,r,n,o,i,s,c;Backbone.Collection.prototype.syncDirty=function(){var e,t,r,n,o,i,s;for(n=localStorage.getItem(""+this.url+"_dirty"),t=n&&n.split(",")||[],s=[],o=0,i=t.length;i>o;o++)e=t[o],r=36===e.length?this.where({id:e})[0]:this.get(parseInt(e)),s.push(r.save());return s},Backbone.Collection.prototype.syncDestroyed=function(){var e,t,r,n,o,i,s;for(n=localStorage.getItem(""+this.url+"_destroyed"),t=n&&n.split(",")||[],s=[],o=0,i=t.length;i>o;o++)e=t[o],r=new this.model({id:e}),r.collection=this,s.push(r.destroy());return s},Backbone.Collection.prototype.syncDirtyAndDestroyed=function(){return this.syncDirty(),this.syncDestroyed()},e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},window.Store=function(){function t(e){this.name=e,this.records=this.recordsOn(this.name)}return t.prototype.sep="",t.prototype.generateId=function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.save=function(){return localStorage.setItem(this.name,this.records.join(","))},t.prototype.recordsOn=function(e){var t;return t=localStorage.getItem(e),t&&t.split(",")||[]},t.prototype.dirty=function(e){var t;return t=this.recordsOn(this.name+"_dirty"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_dirty",t.join(","))),e},t.prototype.clean=function(e,t){var r,n;return n=""+this.name+"_"+t,r=this.recordsOn(n),_.include(r,e.id.toString())&&localStorage.setItem(n,_.without(r,e.id.toString()).join(",")),e},t.prototype.destroyed=function(e){var t;return t=this.recordsOn(this.name+"_destroyed"),_.include(t,e.id.toString())||(t.push(e.id),localStorage.setItem(this.name+"_destroyed",t.join(","))),e},t.prototype.create=function(e){return _.isObject(e)?(e.id||(e.id=this.generateId(),e.set(e.idAttribute,e.id)),localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),this.records.push(e.id.toString()),this.save(),e):e},t.prototype.update=function(e){return localStorage.setItem(this.name+this.sep+e.id,JSON.stringify(e)),_.include(this.records,e.id.toString())||this.records.push(e.id.toString()),this.save(),e},t.prototype.clear=function(){var e,t,r,n;for(n=this.records,t=0,r=n.length;r>t;t++)e=n[t],localStorage.removeItem(this.name+this.sep+e);return this.records=[],this.save()},t.prototype.hasDirtyOrDestroyed=function(){return!_.isEmpty(localStorage.getItem(this.name+"_dirty"))||!_.isEmpty(localStorage.getItem(this.name+"_destroyed"))},t.prototype.find=function(e){return JSON.parse(localStorage.getItem(this.name+this.sep+e.id))},t.prototype.findAll=function(){var e,t,r,n,o;for(n=this.records,o=[],t=0,r=n.length;r>t;t++)e=n[t],o.push(JSON.parse(localStorage.getItem(this.name+this.sep+e)));return o},t.prototype.destroy=function(e){return localStorage.removeItem(this.name+this.sep+e.id),this.records=_.reject(this.records,function(t){return t===e.id.toString()}),this.save(),e},t}(),r={needsTranslation:"0.9.10"===Backbone.VERSION,forBackboneCaller:function(e){return this.needsTranslation?function(t,r,n){return e.call(null,r)}:e},forDualstorageCaller:function(e,t,r){return this.needsTranslation?function(n){return e.call(null,t,n,r)}:e}},o=function(e,t,r){var n,o;return o=new Store(r.storeName),n=function(){switch(e){case"read":return t.id?o.find(t):o.findAll();case"hasDirtyOrDestroyed":return o.hasDirtyOrDestroyed();case"clear":return o.clear();case"create":if((!r.add||r.merge||!o.find(t))&&(t=o.create(t),r.dirty))return o.dirty(t);break;case"update":return o.update(t),r.dirty?o.dirty(t):o.clean(t,"dirty");case"delete":return o.destroy(t),r.dirty?o.destroyed(t):36===t.id.toString().length?o.clean(t,"dirty"):o.clean(t,"destroyed")}}(),r.ignoreCallbacks||(n?r.success(n):r.error("Record not found")),n},c=function(e,t){var r;return e?(r=e[t],_.isFunction(r)?r.call(e):r):null},s=function(e,t){return e&&e.parseBeforeLocalSave?_.isFunction(e.parseBeforeLocalSave)?e.parseBeforeLocalSave(t):void 0:t},t=Backbone.sync,i=function(e,n,o){return o.success=r.forBackboneCaller(o.success),o.error=r.forBackboneCaller(o.error),t(e,n,o)},n=function(e,t,n){var a,u,l,d;if(n.storeName=c(t.collection,"url")||c(t,"url"),n.success=r.forDualstorageCaller(n.success,t,n),n.error=r.forDualstorageCaller(n.error,t,n),c(t,"remote")||c(t.collection,"remote"))return i(e,t,n);if(u=c(t,"local")||c(t.collection,"local"),n.dirty=n.remote===!1&&!u,n.remote===!1||u)return o(e,t,n);switch(n.ignoreCallbacks=!0,d=n.success,a=n.error,e){case"read":return o("hasDirtyOrDestroyed",t,n)?d(o(e,t,n)):(n.success=function(e,r,i){var c,a,u;if(e=s(t,e),n.add||o("clear",t,n),_.isArray(e))for(a=0,u=e.length;u>a;a++)c=e[a],o("create",c,n);else o("create",e,n);return d(e,r,i)},n.error=function(r){return d(o(e,t,n))},i(e,t,n));case"create":return n.success=function(t,r,i){return o(e,t,n),d(t,r,i)},n.error=function(r){return n.dirty=!0,d(o(e,t,n))},i(e,t,n);case"update":return _.isString(t.id)&&36===t.id.length?(l=t.clone(),n.success=function(e,t,r){return o("delete",l,n),o("create",e,n),d(e,t,r)},n.error=function(t){return n.dirty=!0,d(o(e,l,n))},t.set({id:null}),i("create",t,n)):(n.success=function(r,i,s){return d(o(e,t,n))},n.error=function(r){return n.dirty=!0,d(o(e,t,n))},i(e,t,n));case"delete":return _.isString(t.id)&&36===t.id.length?o(e,t,n):(n.success=function(r,i,s){return o(e,t,n),d(r,i,s)},n.error=function(r){return n.dirty=!0,d(o(e,t,n))},i(e,t,n))}},Backbone.sync=n}).call(this);
//# sourceMappingURL=./backbone.dualstorage.min.js.map