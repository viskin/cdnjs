(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",queryVisualizationHeadline:"",highlight:true,throttleTime:150,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var c=-1;var h;var t;var q="";var l;var d=[];var e=true;var s=300;var k="";var m=2;var j;var o=[];var n="all";var b=-1;function g(v){if(v!==undefined){var w=h.val();if(v.keyCode==9||v.keyCode==13||w.length<m){t.slideUp(s);c=-1}}else{t.slideUp(s);c=-1}}function f(w,v){var x=null;return function(){var z=this,y=arguments;clearTimeout(x);x=window.setTimeout(function(){w.apply(z,y)},v||500)}}function r(w,v){if(!e){return w}var y=v.split(" ");var x={};$.each(y,function(z,A){if(A.length<2){return}w=w.replace(new RegExp(A,"gi"),"##"+z+"##");x["##"+z+"##"]="<span>"+A+"</span>"});$.each(x,function(z,A){w=w.replace(new RegExp(z,"gi"),A)});return w}function u(w){if(b==13){g();return}var v=h.val();t.html("");$.each(w.suggests,function(y,x){if(y.replace(/_/,"").length>0&&x.length>0){var z=$("<h4>"+y+"</h4>");t.append(z)}$.each(x,function(A,D){var B='<div class="unibox-selectable">';if(D.image!=undefined){B+='<div class="unibox-selectable-img-container"><img src="'+D.image+'"/></div>'}if(D.link!=undefined){B+='<a href="'+D.link+'">';B+=r(D.name,v);B+="</a>"}else{B+=r(D.name,v)}B+='<div class="unibox-ca"></div></div>';var C=$(B);t.append(C)})});$(".unibox-selectable").click(function(){h.val($(this).text());var x=undefined;try{x=$(this).find("a").attr("href")}catch(y){}j($(this).text(),x);g()});if(w.words.length>0&&k.length>0&&(n=="all"||n=="bottom")){t.append("<h4>"+k+"</h4>")}$.each(w.words,function(y,B){if((n=="all"||n=="bottom")){if(B.overlayImage!=undefined){t.append('<img class="unibox-vis" src="'+B.overlayImage+'" style="background-image: url(\''+B.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{t.append('<img class="unibox-vis" src="'+B.image+'">')}}var A=$("#unibox-invisible");A.html(v.replace(new RegExp(B.name,"gi"),"<span>"+B.name+"</span>"));if((n=="all"||n=="top")&&jQuery.inArray(B.image,o)==-1){var z=$("#unibox-invisible span")[0];if(z!=undefined&&B.name.length>0){var x=$(z).position().left;visImage=$('<div class="unibox-ivf"><img src="'+B.image+'" alt="'+B.name+'"></div>');visImage.css("left",h.offset().left+x-10);visImage.css("top",h.offset().top-80);$("body").append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10)}o.push(B.image)}});$("img").error(function(){$(this).hide()});t.css("left",h.offset().left);t.css("top",h.offset().top+h.outerHeight());t.slideDown(s,function(){t.css("left",h.offset().left);t.css("top",h.offset().top+h.outerHeight())});d=$(".unibox-selectable");c=-1}function a(){o=[];$(".unibox-ivf").remove()}function i(x){if(h.val().length<=1){a()}if(x.keyCode!=38&&x.keyCode!=40&&x.keyCode!=13){if(x.keyCode==46||x.keyCode==8){a()}return}if(x.keyCode==38&&c>0){c--}else{if(x.keyCode==40){c++}}if(d.length>0){c=c%d.length;d.removeClass("active");var w=$(d[c]);w.addClass("active")}if(x.keyCode==13){if(j!=undefined){var z=h.val();var v=undefined;if(c!=-1){z=$($(".unibox-selectable.active")[0]).text();try{v=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(y){}}j(z,v)}else{if(c!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function p(v){b=v.keyCode;if(v.keyCode==38||v.keyCode==40||v.keyCode==13){return}var w=h.val();if(w.length>=m){$.ajax(q+encodeURIComponent(w),{dataType:"json",success:function(x){u(x)}})}}return{init:function(x,v){h=x;e=v.highlight;q=v.suggestUrl;l=v.throttleTime;s=v.animationSpeed;m=v.minChars;j=v.enterCallback;n=v.instantVisualFeedback;k=v.queryVisualizationHeadline;h.attr("autocomplete","off");t=$('<div id="unibox-suggest-box"></div>');$("body").append(t);t.css("min-width",h.outerWidth());t.css("max-width",v.maxWidth);h.keydown(i);h.keydown(f(p,l));h.keydown(g);h.keyup(g);$("html").click(function(){t.slideUp(s)});t.click(function(y){y.stopPropagation()});var w=$('<div id="unibox-invisible">text whatever <span>this one</span></div>');h.parent().append(w);console.log("unibox initialized")}}}();