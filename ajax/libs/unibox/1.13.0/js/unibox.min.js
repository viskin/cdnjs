var UniBox=function(){var w=-1;var r;var e;var g;var f="";var m="";var B=-80;var D;var a;var j=[];var J=true;var o;var p=300;var l="";var k=2;var t;var s;var H;var d;var c;var y;var I=[];var q="all";var x=-1;var v="";var b=false;var G=[];var h=[];function u(L){if(L!==undefined){var M=r.val();if(L.keyCode==9||L.keyCode==27||L.keyCode==13||M.length<k){g.slideUp(p);if(L.keyCode==13&&t!=undefined&&w==-1){t.call(this,M)}w=-1}}else{g.slideUp(p);w=-1}}function C(M,L){var N=null;return function(){var P=this,O=arguments;clearTimeout(N);N=window.setTimeout(function(){M.apply(P,O)},L||50)}}function E(M,L){if(!J){return M}var S=L.split(" ");S.sort(function(U,T){return T.length-U.length});var R={};jQuery.each(S,function(T,X){if(X.length<1){return}var W=M.match(new RegExp("(("+X+")(?!#<##|-\\d+#<##))(?!.*\\1)","gi"));if(W!=null){for(var V=0;V<W.length;V++){var U=W[V];M=M.replace(new RegExp("("+U+")(?!#<##|-\\d+#<##)","g"),"##>#"+T+"-"+V+"#<##");R["##>#"+T+"-"+V+"#<##"]='<span class="unibox-highlight">'+U+"</span>"}}});var P=Object.keys(R).reverse();for(var N=0;N<P.length;N++){var Q=P[N];var O=R[Q];M=M.replace(new RegExp(Q,"gi"),O)}return M}function K(P){if(x==13){u();return}var L=r.val();g.html("");var N=false;var O=Object.keys(P.suggests);if(G&&G.length>0){O=G;jQuery.each(Object.keys(P.suggests),function(Q,R){if(jQuery.inArray(R,O)<0){O.push(R)}})}jQuery.each(O,function(Q,T){var S=P.suggests[T];if(!S){return true}var R=0;jQuery.each(O,function(W,Y){var X=P.suggests[Y];if(!X||T===Y||X.length==0){return true}R+=X.length});var V=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+T+" "+("unibox-"+S.length+"-entries")+" "+(R==0?"unibox-single-suggestion-block":"")+'"></div>');if(T.replace(/_/,"").length>0&&S.length>0){var U=jQuery("<h4>"+T+"</h4>");V.append(U)}jQuery.each(S,function(ae,ac){var ab='<div class="unibox-selectable">';if(ac.image!=undefined){var ag=ac.image.length===0&&D?D:ac.image.length===0||ac.image.indexOf("/")===0||ac.image.indexOf("http")===0?ac.image:m+ac.image;ab+='<div class="unibox-selectable-img-container"><img src="'+ag+'"/></div>'}if(ac.link!=undefined){ab+='<a href="'+ac.link+'">';ab+=E(ac.name,L);ab+="</a>"}else{ab+="<span>"+E(ac.name,L)+"</span>"}if(o!=undefined){var ad=o.match(/##(.*?)##/gi);var aa=o;var Z=false;for(var X in ad){var Y=ad[X].replace(/#/g,"");var W=ac[Y];if(W==undefined){Z=true;continue}var ah=new RegExp(ad[X],"g");aa=aa.replace(ah,W)}if(!Z){ab+='<div class="unibox-extra">'+aa+"</div>"}}ab+='<div class="unibox-ca"></div></div>';var af=jQuery(ab);V.append(af);N=true});g.append(V)});if(h&&h.length>0){j=[];jQuery.each(h,function(Q,R){j=j.concat(e.find(".unibox-suggest-"+R+":first .unibox-selectable").get())})}else{j=e.find(".unibox-selectable")}w=-1;jQuery(j).mousedown(function(){var R=jQuery(this).text();r.val(R);var Q=undefined;try{Q=jQuery(this).find("a:first").attr("href")}catch(S){}if(s!=undefined){s.call(this,R,Q)}u()});e.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(P.words.length>0&&l.length>0&&(q=="all"||q=="bottom")){g.append("<h4>"+l+"</h4>");N=true}var M=[];jQuery.each(P.words,function(R,U){if((q=="all"||q=="bottom")){if(U.overlayImage!=undefined){g.append('<img class="unibox-vis" src="'+m+U.overlayImage+'" style="background-image: url(\''+m+U.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(U.image!=undefined){g.append('<img class="unibox-vis" src="'+m+U.image+'">')}}}var T=e.find("#unibox-invisible");T.html(L.replace(new RegExp(U.name,"gi"),"<span>"+U.name+"</span>"));if((q=="all"||q=="top")&&jQuery.inArray(U.image,I)==-1){var S=e.find("#unibox-invisible span")[0];if(S!=undefined&&U.name.length>0&&U.image!=undefined){var Q=jQuery(S).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+m+U.image+'" alt="'+U.name+'"></div>');visImage.css("left",i().left+Q-10);visImage.css("top",i().top-r.outerHeight()+B);e.append(visImage);setTimeout(function(){e.find(".unibox-ivf").find("img").addClass("l")},10);M.push(U.image)}}else{if(jQuery.inArray(U.image,I)>-1){M.push(U.image)}}});I=M;jQuery("img").error(function(){if(D){jQuery(this).attr("src",D)}else{jQuery(this).hide()}});g.css("left",i().left);g.css("top",i().top);if(N){g.slideDown(p,function(){g.css("left",i().left);g.css("top",i().top)})}else{u()}}function i(){return{left:r.offset().left-e.offset().left,top:r.offset().top-e.offset().top+r.outerHeight()}}function A(){var M=e.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var L=0;L<M.length;L++){if(jQuery.inArray(M[L].replace(m,""),I)==-1){e.find('.unibox-ivf:has(img[src*="'+M[L]+'"])').remove()}}}function n(){I=[];e.find(".unibox-ivf").remove()}function F(N){if(r.val().length<=1){n()}if(H!=undefined){H.call(this,r.val())}if(N.keyCode!=38&&N.keyCode!=40&&N.keyCode!=13){A();return}if(N.keyCode==38&&w>0){w--}else{if(N.keyCode==40){w++}else{if(N.keyCode==38&&w<=0){w=((w!=-1)?w-1:w)+j.length}}}if(j.length>0&&w>-1){w=w%j.length;jQuery(j).removeClass("active");var M=jQuery(j[w]);M.addClass("active")}if(N.keyCode==13){if(s!=undefined){var P=r.val();var L=undefined;if(w!=-1){P=jQuery(e.find(".unibox-selectable.active")[0]).text();r.val(P);try{L=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(O){}if(s!=undefined){s.call(this,P,L)}}}else{if(w!=-1){window.location.href=jQuery(e.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function z(L){if(x==18){x=L.keyCode;return}x=L.keyCode;if(L.keyCode==38||L.keyCode==40||L.keyCode==13||L.keyCode==9){return}var M=r.val();if(x==46&&M.length==0){n()}if(M.length>=k){v=M;jQuery.ajax({usedQuery:M,url:f+encodeURIComponent(M),dataType:"json",success:function(N){if(this.usedQuery==v){K(N)}}})}}return{updateSuggestUrl:function(L){f=L},hideSuggestBox:function(){u()},setIvfImagePath:function(L){m=L;if(m.charAt(m.length-1)!="/"){m+="/"}},changeInstantVisualFeedbackState:function(L){q=L},init:function(Y,aa){r=Y;e=aa.searchBoxContainer;J=aa.highlight;o=aa.extraHtml;f=aa.suggestUrl;m=aa.ivfImagePath;B=aa.ivfImageOffset;D=aa.missingErrorImage;a=aa.throttleTime;p=aa.animationSpeed;k=aa.minChars;t=aa.enterCallback;s=aa.enterCallbackResult;H=aa.typeCallback;d=aa.focusCallback;c=aa.blurCallback;y=aa.placeholder;q=aa.instantVisualFeedback;l=aa.queryVisualizationHeadline;b=aa.showDeleteAllButton;G=aa.suggestOrder;h=aa.suggestSelectionOrder;r.attr("autocomplete","off");g=jQuery('<div id="unibox-suggest-box"></div>');e.append(g);var W=e.css("position");if(W!="absolute"){e.css("position","relative")}var R=g.css("border-width").replace("px","");g.css("min-width",r.outerWidth()-2*R);g.css("max-width",aa.maxWidth-2*R);r.keydown(F);r.keydown(C(z,a));r.keyup(u);r.focusout(function(){g.slideUp(p);if(c!=undefined){c.call(this,jQuery(this).val())}});r.focus(function(){if(d!=undefined){d.call(this,jQuery(this).val())}});g.mouseenter(function(){g.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){g.slideUp(p)});g.click(function(ab){ab.stopPropagation()});var M=r.attr("placeholder");y=M&&M.length>0?M:y;if(y&&y.length>0){var T=document.createElement("input");if(!("placeholder" in T)){r.focus(function(){var ab=jQuery(this).attr("placeholder");if((ab)&&(ab.length>0)&&(ab!="")&&jQuery(this).val()==ab){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var ab=jQuery(this).attr("placeholder");if((ab)&&(ab.length>0)&&(ab!="")&&(jQuery(this).val()==""||jQuery(this).val()==ab)){jQuery(this).val(ab).addClass("hasPlaceholder")}});r.val(y)}r.attr("placeholder",y)}var Z=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');e.append(Z);if(b){var X=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');e.append(X);jQuery(X).mousedown(function(ab){(ab||window.event).stopPropagation();r.val("");r.focus();return false});r.focus(function(){if(r.val().length>0){X.show()}else{X.hide()}}).blur(function(){X.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(X).show()}});var V=parseInt(r.css("paddingTop").replace("px","").trim());var U=r.outerHeight();var S=parseInt(r.css("borderTopWidth").replace("px","").trim());var P=r.css("boxShadow").match(/\d{1,3}px/g);var O=(P&&P.length>2)?parseInt(P[2].replace("px","").trim()):0;X.height(U-(2*S)-O-V);var L=parseInt(r.css("paddingRight").replace("px","").trim());L=(L>25)?L:25;r.css("paddingRight",L);var Q=S+O+(r.offset().top-r.parent().offset().top-r.parent().scrollTop());var N=Math.abs(r[0].getBoundingClientRect().left-r.parent()[0].getBoundingClientRect().left)+r.outerWidth()-X.outerWidth()-S-L;X.css("top",Q);X.css("left",N)}if(q=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var c=this.map(function(d,g){g=$(g);var e=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,typeCallback:undefined,focusCallback:undefined,blurCallback:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:g.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);if(e.searchBoxContainerSelector==undefined){e.searchBoxContainer=g.parent()}else{e.searchBoxContainer=$(e.searchBoxContainerSelector)}var f=new UniBox();f.init(g,e);return f});if(c.length==1){return c[0]}return c}}(jQuery));