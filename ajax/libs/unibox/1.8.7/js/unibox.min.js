var UniBox=function(){var e=-1;var k;var s;var B;var w="";var m="";var x;var p;var f=[];var g=true;var c;var A=300;var o="";var q=2;var n;var v;var j;var t=[];var r="all";var d=-1;function i(D){if(D!==undefined){var E=k.val();if(D.keyCode==9||D.keyCode==27||D.keyCode==13||E.length<q){B.slideUp(A);if(D.keyCode==13&&n!=undefined&&e==-1){n.call(this,E)}e=-1}}else{B.slideUp(A);e=-1}}function h(E,D){var F=null;return function(){var H=this,G=arguments;clearTimeout(F);F=window.setTimeout(function(){E.apply(H,G)},D||50)}}function y(E,D){if(!g){return E}var G=D.split(" ");var F={};jQuery.each(G,function(H,I){if(I.length<1){return}E=E.replace(new RegExp(I,"gi"),"##"+H+"##");F["##"+H+"##"]="<span>"+I+"</span>"});jQuery.each(F,function(H,I){E=E.replace(new RegExp(H,"gi"),I)});return E}function C(G){if(d==13){i();return}var D=k.val();B.html("");var F=false;jQuery.each(G.suggests,function(I,H){var K=jQuery('<div class="unibox-suggest-'+I+'"></div>');if(I.replace(/_/,"").length>0&&H.length>0){var J=jQuery("<h4>"+I+"</h4>");K.append(J)}jQuery.each(H,function(T,R){var Q='<div class="unibox-selectable">';if(R.image!=undefined){var V=R.image.length===0&&x?x:R.image.length===0||R.image.indexOf("/")===0||R.image.indexOf("http")===0?R.image:m+R.image;Q+='<div class="unibox-selectable-img-container"><img src="'+V+'"/></div>'}if(R.link!=undefined){Q+='<a href="'+R.link+'">';Q+=y(R.name,D);Q+="</a>"}else{Q+="<span>"+y(R.name,D)+"</span>"}if(c!=undefined){var S=c.match(/##(.*?)##/gi);var P=c;var O=false;for(var M in S){var N=S[M].replace(/#/g,"");var L=R[N];if(L==undefined){O=true;continue}var W=new RegExp(S[M],"g");P=P.replace(W,L)}if(!O){Q+='<div class="unibox-extra">'+P+"</div>"}}Q+='<div class="unibox-ca"></div></div>';var U=jQuery(Q);K.append(U);F=true});B.append(K)});f=s.find(".unibox-selectable");e=-1;f.click(function(){var I=jQuery(this).find("span").first().text();k.val(I);var H=undefined;try{H=jQuery(this).find("a").attr("href")}catch(J){}v.call(this,I,H);i()});s.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(G.words.length>0&&o.length>0&&(r=="all"||r=="bottom")){B.append("<h4>"+o+"</h4>");F=true}var E=[];jQuery.each(G.words,function(I,L){if((r=="all"||r=="bottom")){if(L.overlayImage!=undefined){B.append('<img class="unibox-vis" src="'+m+L.overlayImage+'" style="background-image: url(\''+m+L.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(L.image!=undefined){B.append('<img class="unibox-vis" src="'+m+L.image+'">')}}}var K=s.find("#unibox-invisible");K.html(D.replace(new RegExp(L.name,"gi"),"<span>"+L.name+"</span>"));if((r=="all"||r=="top")&&jQuery.inArray(L.image,t)==-1){var J=s.find("#unibox-invisible span")[0];if(J!=undefined&&L.name.length>0&&L.image!=undefined){var H=jQuery(J).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+m+L.image+'" alt="'+L.name+'"></div>');visImage.css("left",z().left+H-10);visImage.css("top",z().top-k.outerHeight()-80);s.append(visImage);setTimeout(function(){s.find(".unibox-ivf").find("img").addClass("l")},10);E.push(L.image)}}else{if(jQuery.inArray(L.image,t)>-1){E.push(L.image)}}});t=E;jQuery("img").error(function(){if(x){jQuery(this).attr("src",x)}else{jQuery(this).hide()}});B.css("left",z().left);B.css("top",z().top);if(F){B.slideDown(A,function(){B.css("left",z().left);B.css("top",z().top)})}else{i()}}function z(){return{left:k.offset().left-s.offset().left,top:k.offset().top-s.offset().top+k.outerHeight()}}function b(){var E=s.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var D=0;D<E.length;D++){if(jQuery.inArray(E[D].replace(m,""),t)==-1){s.find('.unibox-ivf:has(img[src*="'+E[D]+'"])').remove()}}}function a(){t=[];s.find(".unibox-ivf").remove()}function l(F){if(k.val().length<=1){a()}if(F.keyCode!=38&&F.keyCode!=40&&F.keyCode!=13){b();return}if(F.keyCode==38&&e>0){e--}else{if(F.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var E=jQuery(f[e]);E.addClass("active")}if(F.keyCode==13){if(v!=undefined){var H=k.val();var D=undefined;if(e!=-1){H=jQuery(s.find(".unibox-selectable.active span")[0]).text();k.val(H);try{D=jQuery(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(G){}v.call(this,H,D)}}else{if(e!=-1){window.location.href=jQuery(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function u(D){if(d==18){d=D.keyCode;return}d=D.keyCode;if(D.keyCode==38||D.keyCode==40||D.keyCode==13||D.keyCode==9){return}var E=k.val();if(d==46&&E.length==0){a()}if(E.length>=q){jQuery.ajax({url:w+encodeURIComponent(E),dataType:"json",success:function(F){C(F)}})}}return{updateSuggestUrl:function(D){w=D},hideSuggestBox:function(){i()},setIvfImagePath:function(D){m=D;if(m.charAt(m.length-1)!="/"){m+="/"}},changeInstantVisualFeedbackState:function(D){r=D},init:function(G,D){k=G;s=k.parent();g=D.highlight;c=D.extraHtml;w=D.suggestUrl;m=D.ivfImagePath;x=D.missingErrorImage;p=D.throttleTime;A=D.animationSpeed;q=D.minChars;n=D.enterCallback;v=D.enterCallbackResult;j=D.placeholder;r=D.instantVisualFeedback;o=D.queryVisualizationHeadline;k.attr("autocomplete","off");B=jQuery('<div id="unibox-suggest-box"></div>');s.append(B);var H=s.css("position");if(H!="absolute"){s.css("position","relative")}var E=B.css("border-width").replace("px","");B.css("min-width",k.outerWidth()-2*E);B.css("max-width",D.maxWidth-2*E);k.keydown(l);k.keydown(h(u,p));k.keyup(i);k.blur(function(){B.slideUp(A)});jQuery("html").click(function(){B.slideUp(A)});B.click(function(I){I.stopPropagation()});if(j!=undefined){k.attr("placeholder",j);k.val("")}var F=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');k.parent().append(F);if(r=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth()},b);var d=new UniBox();d.init(e,c);return d}}(jQuery));