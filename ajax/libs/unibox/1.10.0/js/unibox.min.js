var UniBox=function(){var g=-1;var m;var u;var F;var z="";var o="";var D=-80;var A;var r;var h=[];var i=true;var d;var E=300;var q="";var s=2;var p;var y;var l;var w=[];var t="all";var e=-1;var f=false;var c=[];var v=[];function k(H){if(H!==undefined){var I=m.val();if(H.keyCode==9||H.keyCode==27||H.keyCode==13||I.length<s){F.slideUp(E);if(H.keyCode==13&&p!=undefined&&g==-1){p.call(this,I)}g=-1}}else{F.slideUp(E);g=-1}}function j(I,H){var J=null;return function(){var L=this,K=arguments;clearTimeout(J);J=window.setTimeout(function(){I.apply(L,K)},H||50)}}function B(I,H){if(!i){return I}var K=H.split(" ");var J={};jQuery.each(K,function(N,P){if(P.length<1){return}var O=I.match(new RegExp("("+P+")","gi"));if(O!=null){for(var M=0;M<O.length;M++){var L=O[M];I=I.replace(new RegExp(L,"g"),"##"+N+"-"+M+"##");J["##"+N+"-"+M+"##"]="<span>"+L+"</span>"}}});jQuery.each(J,function(L,M){I=I.replace(new RegExp(L,"gi"),M)});return I}function G(L){if(e==13){k();return}var H=m.val();F.html("");var J=false;var K=Object.keys(L.suggests);if(c&&c.length>0){K=c;jQuery.each(Object.keys(L.suggests),function(M,N){if(jQuery.inArray(N,K)<0){K.push(N)}})}jQuery.each(K,function(M,O){var N=L.suggests[O];if(!N){return true}var Q=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+O+'"></div>');if(O.replace(/_/,"").length>0&&N.length>0){var P=jQuery("<h4>"+O+"</h4>");Q.append(P)}jQuery.each(N,function(Z,X){var W='<div class="unibox-selectable">';if(X.image!=undefined){var ab=X.image.length===0&&A?A:X.image.length===0||X.image.indexOf("/")===0||X.image.indexOf("http")===0?X.image:o+X.image;W+='<div class="unibox-selectable-img-container"><img src="'+ab+'"/></div>'}if(X.link!=undefined){W+='<a href="'+X.link+'">';W+=B(X.name,H);W+="</a>"}else{W+="<span>"+B(X.name,H)+"</span>"}if(d!=undefined){var Y=d.match(/##(.*?)##/gi);var V=d;var U=false;for(var S in Y){var T=Y[S].replace(/#/g,"");var R=X[T];if(R==undefined){U=true;continue}var ac=new RegExp(Y[S],"g");V=V.replace(ac,R)}if(!U){W+='<div class="unibox-extra">'+V+"</div>"}}W+='<div class="unibox-ca"></div></div>';var aa=jQuery(W);Q.append(aa);J=true});F.append(Q)});if(v&&v.length>0){h=[];jQuery.each(v,function(M,N){h=h.concat(u.find(".unibox-suggest-"+N+":first .unibox-selectable").get())})}else{h=u.find(".unibox-selectable")}g=-1;jQuery(h).mousedown(function(){var N=jQuery(this).text();m.val(N);var M=undefined;try{M=jQuery(this).find("a:first").attr("href")}catch(O){}if(y!=undefined){y.call(this,N,M)}k()});u.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(L.words.length>0&&q.length>0&&(t=="all"||t=="bottom")){F.append("<h4>"+q+"</h4>");J=true}var I=[];jQuery.each(L.words,function(N,Q){if((t=="all"||t=="bottom")){if(Q.overlayImage!=undefined){F.append('<img class="unibox-vis" src="'+o+Q.overlayImage+'" style="background-image: url(\''+o+Q.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(Q.image!=undefined){F.append('<img class="unibox-vis" src="'+o+Q.image+'">')}}}var P=u.find("#unibox-invisible");P.html(H.replace(new RegExp(Q.name,"gi"),"<span>"+Q.name+"</span>"));if((t=="all"||t=="top")&&jQuery.inArray(Q.image,w)==-1){var O=u.find("#unibox-invisible span")[0];if(O!=undefined&&Q.name.length>0&&Q.image!=undefined){var M=jQuery(O).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+o+Q.image+'" alt="'+Q.name+'"></div>');visImage.css("left",C().left+M-10);visImage.css("top",C().top-m.outerHeight()+D);u.append(visImage);setTimeout(function(){u.find(".unibox-ivf").find("img").addClass("l")},10);I.push(Q.image)}}else{if(jQuery.inArray(Q.image,w)>-1){I.push(Q.image)}}});w=I;jQuery("img").error(function(){if(A){jQuery(this).attr("src",A)}else{jQuery(this).hide()}});F.css("left",C().left);F.css("top",C().top);if(J){F.slideDown(E,function(){F.css("left",C().left);F.css("top",C().top)})}else{k()}}function C(){return{left:m.offset().left-u.offset().left,top:m.offset().top-u.offset().top+m.outerHeight()}}function b(){var I=u.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var H=0;H<I.length;H++){if(jQuery.inArray(I[H].replace(o,""),w)==-1){u.find('.unibox-ivf:has(img[src*="'+I[H]+'"])').remove()}}}function a(){w=[];u.find(".unibox-ivf").remove()}function n(J){if(m.val().length<=1){a()}if(J.keyCode!=38&&J.keyCode!=40&&J.keyCode!=13){b();return}if(J.keyCode==38&&g>0){g--}else{if(J.keyCode==40){g++}else{if(J.keyCode==38&&g<=0){g=((g!=-1)?g-1:g)+h.length}}}if(h.length>0&&g>-1){g=g%h.length;jQuery(h).removeClass("active");var I=jQuery(h[g]);I.addClass("active")}if(J.keyCode==13){if(y!=undefined){var L=m.val();var H=undefined;if(g!=-1){L=jQuery(u.find(".unibox-selectable.active")[0]).text();m.val(L);try{H=jQuery(u.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(K){}if(y!=undefined){y.call(this,L,H)}}}else{if(g!=-1){window.location.href=jQuery(u.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function x(H){if(e==18){e=H.keyCode;return}e=H.keyCode;if(H.keyCode==38||H.keyCode==40||H.keyCode==13||H.keyCode==9){return}var I=m.val();if(e==46&&I.length==0){a()}if(I.length>=s){jQuery.ajax({url:z+encodeURIComponent(I),dataType:"json",success:function(J){G(J)}})}}return{updateSuggestUrl:function(H){z=H},hideSuggestBox:function(){k()},setIvfImagePath:function(H){o=H;if(o.charAt(o.length-1)!="/"){o+="/"}},changeInstantVisualFeedbackState:function(H){t=H},init:function(T,V){m=T;u=m.parent();i=V.highlight;d=V.extraHtml;z=V.suggestUrl;o=V.ivfImagePath;D=V.ivfImageOffset;A=V.missingErrorImage;r=V.throttleTime;E=V.animationSpeed;s=V.minChars;p=V.enterCallback;y=V.enterCallbackResult;l=V.placeholder;t=V.instantVisualFeedback;q=V.queryVisualizationHeadline;f=V.showDeleteAllButton;c=V.suggestOrder;v=V.suggestSelectionOrder;m.attr("autocomplete","off");F=jQuery('<div id="unibox-suggest-box"></div>');u.append(F);var R=u.css("position");if(R!="absolute"){u.css("position","relative")}var M=F.css("border-width").replace("px","");F.css("min-width",m.outerWidth()-2*M);F.css("max-width",V.maxWidth-2*M);m.keydown(n);m.keydown(j(x,r));m.keyup(k);m.blur(function(){F.slideUp(E)});F.mouseenter(function(){F.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){F.slideUp(E)});F.click(function(W){W.stopPropagation()});var I=m.attr("placeholder");l=I&&I.length>0?I:l;if(l&&l.length>0){var O=document.createElement("input");if(!("placeholder" in O)){m.focus(function(){var W=jQuery(this).attr("placeholder");if((W)&&(W.length>0)&&(W!="")&&jQuery(this).val()==W){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var W=jQuery(this).attr("placeholder");if((W)&&(W.length>0)&&(W!="")&&(jQuery(this).val()==""||jQuery(this).val()==W)){jQuery(this).val(W).addClass("hasPlaceholder")}});m.val(l)}m.attr("placeholder",l)}var U=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');m.parent().append(U);if(f){var S=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');u.append(S);jQuery(S).mousedown(function(W){(W||window.event).stopPropagation();m.val("");m.focus();return false});m.focus(function(){if(m.val().length>0){S.show()}else{S.hide()}}).blur(function(){S.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(S).show()}});var Q=parseInt(m.css("paddingTop").replace("px","").trim());var P=m.outerHeight();var N=parseInt(m.css("borderTopWidth").replace("px","").trim());var K=m.css("boxShadow").match(/\d{1,3}px/g);var J=(K&&K.length>2)?parseInt(K[2].replace("px","").trim()):0;S.height(P-(2*N)-J-Q);var H=parseInt(m.css("paddingRight").replace("px","").trim());m.css("paddingRight",(H>25)?H:25);var L=N+J+(m.offset().top-m.parent().offset().top-m.parent().scrollTop());S.css("top",L);S.css("left",m.outerWidth()-S.outerWidth()-N)}if(t=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);var d=new UniBox();d.init(e,c);return d}}(jQuery));