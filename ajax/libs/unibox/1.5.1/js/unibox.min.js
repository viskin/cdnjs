(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,extraHtml:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var e=-1;var j;var x;var t="";var l="";var o;var f=[];var g=true;var c;var w=300;var n="";var p=2;var m;var r=[];var q="all";var d=-1;function i(z){if(z!==undefined){var A=j.val();if(z.keyCode==9||z.keyCode==13||A.length<p){x.slideUp(w);e=-1}}else{x.slideUp(w);e=-1}}function h(A,z){var B=null;return function(){var D=this,C=arguments;clearTimeout(B);B=window.setTimeout(function(){A.apply(D,C)},z||50)}}function u(A,z){if(!g){return A}var C=z.split(" ");var B={};$.each(C,function(D,E){if(E.length<2){return}A=A.replace(new RegExp(E,"gi"),"##"+D+"##");B["##"+D+"##"]="<span>"+E+"</span>"});$.each(B,function(D,E){A=A.replace(new RegExp(D,"gi"),E)});return A}function y(B){if(d==13){i();return}var z=j.val();x.html("");$.each(B.suggests,function(D,C){var F=$('<div class="unibox-suggest-'+D+'"></div>');if(D.replace(/_/,"").length>0&&C.length>0){var E=$("<h4>"+D+"</h4>");F.append(E)}$.each(C,function(O,M){var L='<div class="unibox-selectable">';if(M.image!=undefined){L+='<div class="unibox-selectable-img-container"><img src="'+M.image+'"/></div>'}if(M.link!=undefined){L+='<a href="'+M.link+'">';L+=u(M.name,z);L+="</a>"}else{L+="<span>"+u(M.name,z)+"</span>"}if(c!=undefined){var N=c.match(/##(.*?)##/gi);var K=c;var I=false;for(var H in N){var J=N[H].replace(/#/g,"");var G=M[J];if(G==undefined){I=true;continue}var Q=new RegExp(N[H],"g");K=K.replace(Q,G)}if(!I){L+='<div class="unibox-extra">'+K+"</div>"}}L+='<div class="unibox-ca"></div></div>';var P=$(L);F.append(P)});x.append(F)});f=$(".unibox-selectable");e=-1;f.click(function(){var D=$(this).find("span").first().text();j.val(D);var C=undefined;try{C=$(this).find("a").attr("href")}catch(E){}m.call(this,D,C);i()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(B.words.length>0&&n.length>0&&(q=="all"||q=="bottom")){x.append("<h4>"+n+"</h4>")}var A=[];$.each(B.words,function(D,G){if((q=="all"||q=="bottom")){if(G.overlayImage!=undefined){x.append('<img class="unibox-vis" src="'+l+G.overlayImage+'" style="background-image: url(\''+l+G.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{x.append('<img class="unibox-vis" src="'+l+G.image+'">')}}var F=$("#unibox-invisible");F.html(z.replace(new RegExp(G.name,"gi"),"<span>"+G.name+"</span>"));if((q=="all"||q=="top")&&jQuery.inArray(G.image,r)==-1){var E=$("#unibox-invisible span")[0];if(E!=undefined&&G.name.length>0){var C=$(E).position().left;visImage=$('<div class="unibox-ivf"><img src="'+l+G.image+'" alt="'+G.name+'"></div>');visImage.css("left",v()+C-10);visImage.css("top",j.offset().top-80);$("body").append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10);A.push(G.image)}}else{if(jQuery.inArray(G.image,r)>-1){A.push(G.image)}}});r=A;$("img").error(function(){$(this).hide()});x.css("left",v());x.css("top",j.offset().top+j.outerHeight());x.slideDown(w,function(){x.css("left",v());x.css("top",j.offset().top+j.outerHeight())})}function v(){return j.offset().left-$("body").offset().left}function b(){var A=$(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var z=0;z<A.length;z++){if(jQuery.inArray(A[z].replace(l,""),r)==-1){$('.unibox-ivf:has(img[src*="'+A[z]+'"])').remove()}}}function a(){r=[];$(".unibox-ivf").remove()}function k(B){if(j.val().length<=1){a()}if(B.keyCode!=38&&B.keyCode!=40&&B.keyCode!=13){b();return}if(B.keyCode==38&&e>0){e--}else{if(B.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var A=$(f[e]);A.addClass("active")}if(B.keyCode==13){if(m!=undefined){var D=j.val();var z=undefined;if(e!=-1){D=$($(".unibox-selectable.active span")[0]).text();j.val(D);try{z=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(C){}}m.call(this,D,z)}else{if(e!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function s(z){d=z.keyCode;if(z.keyCode==38||z.keyCode==40||z.keyCode==13){return}var A=j.val();if(d==46&&A.length==0){a()}if(A.length>=p){$.ajax(t+encodeURIComponent(A),{dataType:"json",success:function(B){y(B)}})}}return{updateSuggestUrl:function(z){t=z},setIvfImagePath:function(z){l=z;if(l.charAt(l.length-1)!="/"){l+="/"}},changeInstantVisualFeedbackState:function(z){q=z},init:function(B,z){j=B;g=z.highlight;c=z.extraHtml;t=z.suggestUrl;l=z.ivfImagePath;o=z.throttleTime;w=z.animationSpeed;p=z.minChars;m=z.enterCallback;q=z.instantVisualFeedback;n=z.queryVisualizationHeadline;j.attr("autocomplete","off");x=$('<div id="unibox-suggest-box"></div>');$("body").append(x);x.css("min-width",j.outerWidth());x.css("max-width",z.maxWidth);j.keydown(k);j.keydown(h(s,o));j.keydown(i);j.keyup(i);$("html").click(function(){x.slideUp(w)});x.click(function(C){C.stopPropagation()});var A=$('<div id="unibox-invisible">text whatever <span>this one</span></div>');j.parent().append(A)}}}();