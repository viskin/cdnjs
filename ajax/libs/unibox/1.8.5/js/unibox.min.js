var UniBox=function(){var e=-1;var k;var s;var A;var w="";var m="";var p;var f=[];var g=true;var c;var z=300;var o="";var q=2;var n;var v;var j;var t=[];var r="all";var d=-1;function i(C){if(C!==undefined){var D=k.val();if(C.keyCode==9||C.keyCode==27||C.keyCode==13||D.length<q){A.slideUp(z);if(C.keyCode==13&&n!=undefined&&e==-1){n.call(this,D)}e=-1}}else{A.slideUp(z);e=-1}}function h(D,C){var E=null;return function(){var G=this,F=arguments;clearTimeout(E);E=window.setTimeout(function(){D.apply(G,F)},C||50)}}function x(D,C){if(!g){return D}var F=C.split(" ");var E={};$.each(F,function(G,H){if(H.length<1){return}D=D.replace(new RegExp(H,"gi"),"##"+G+"##");E["##"+G+"##"]="<span>"+H+"</span>"});$.each(E,function(G,H){D=D.replace(new RegExp(G,"gi"),H)});return D}function B(F){if(d==13){i();return}var C=k.val();A.html("");var E=false;$.each(F.suggests,function(H,G){var J=$('<div class="unibox-suggest-'+H+'"></div>');if(H.replace(/_/,"").length>0&&G.length>0){var I=$("<h4>"+H+"</h4>");J.append(I)}$.each(G,function(S,Q){var P='<div class="unibox-selectable">';if(Q.image!=undefined){P+='<div class="unibox-selectable-img-container"><img src="'+Q.image+'"/></div>'}if(Q.link!=undefined){P+='<a href="'+Q.link+'">';P+=x(Q.name,C);P+="</a>"}else{P+="<span>"+x(Q.name,C)+"</span>"}if(c!=undefined){var R=c.match(/##(.*?)##/gi);var O=c;var M=false;for(var L in R){var N=R[L].replace(/#/g,"");var K=Q[N];if(K==undefined){M=true;continue}var U=new RegExp(R[L],"g");O=O.replace(U,K)}if(!M){P+='<div class="unibox-extra">'+O+"</div>"}}P+='<div class="unibox-ca"></div></div>';var T=$(P);J.append(T);E=true});A.append(J)});f=s.find(".unibox-selectable");e=-1;f.click(function(){var H=$(this).find("span").first().text();k.val(H);var G=undefined;try{G=$(this).find("a").attr("href")}catch(I){}v.call(this,H,G);i()});s.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(F.words.length>0&&o.length>0&&(r=="all"||r=="bottom")){A.append("<h4>"+o+"</h4>");E=true}var D=[];$.each(F.words,function(H,K){if((r=="all"||r=="bottom")){if(K.overlayImage!=undefined){A.append('<img class="unibox-vis" src="'+m+K.overlayImage+'" style="background-image: url(\''+m+K.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(K.image!=undefined){A.append('<img class="unibox-vis" src="'+m+K.image+'">')}}}var J=s.find("#unibox-invisible");J.html(C.replace(new RegExp(K.name,"gi"),"<span>"+K.name+"</span>"));if((r=="all"||r=="top")&&jQuery.inArray(K.image,t)==-1){var I=s.find("#unibox-invisible span")[0];if(I!=undefined&&K.name.length>0&&K.image!=undefined){var G=$(I).position().left;visImage=$('<div class="unibox-ivf"><img src="'+m+K.image+'" alt="'+K.name+'"></div>');visImage.css("left",y().left+G-10);visImage.css("top",y().top-k.outerHeight()-80);s.append(visImage);setTimeout(function(){s.find(".unibox-ivf").find("img").addClass("l")},10);D.push(K.image)}}else{if(jQuery.inArray(K.image,t)>-1){D.push(K.image)}}});t=D;$("img").error(function(){$(this).hide()});A.css("left",y().left);A.css("top",y().top);if(E){A.slideDown(z,function(){A.css("left",y().left);A.css("top",y().top)})}else{i()}}function y(){return{left:k.offset().left-s.offset().left,top:k.offset().top-s.offset().top+k.outerHeight()}}function b(){var D=s.find(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var C=0;C<D.length;C++){if(jQuery.inArray(D[C].replace(m,""),t)==-1){s.find('.unibox-ivf:has(img[src*="'+D[C]+'"])').remove()}}}function a(){t=[];s.find(".unibox-ivf").remove()}function l(E){if(k.val().length<=1){a()}if(E.keyCode!=38&&E.keyCode!=40&&E.keyCode!=13){b();return}if(E.keyCode==38&&e>0){e--}else{if(E.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var D=$(f[e]);D.addClass("active")}if(E.keyCode==13){if(v!=undefined){var G=k.val();var C=undefined;if(e!=-1){G=$(s.find(".unibox-selectable.active span")[0]).text();k.val(G);try{C=$(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(F){}}v.call(this,G,C)}else{if(e!=-1){window.location.href=$(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function u(C){if(d==18){d=C.keyCode;return}d=C.keyCode;if(C.keyCode==38||C.keyCode==40||C.keyCode==13||C.keyCode==9){return}var D=k.val();if(d==46&&D.length==0){a()}if(D.length>=q){$.ajax(w+encodeURIComponent(D),{dataType:"json",success:function(E){B(E)}})}}return{updateSuggestUrl:function(C){w=C},hideSuggestBox:function(){i()},setIvfImagePath:function(C){m=C;if(m.charAt(m.length-1)!="/"){m+="/"}},changeInstantVisualFeedbackState:function(C){r=C},init:function(F,C){k=F;s=k.parent();g=C.highlight;c=C.extraHtml;w=C.suggestUrl;m=C.ivfImagePath;p=C.throttleTime;z=C.animationSpeed;q=C.minChars;n=C.enterCallback;v=C.enterCallbackResult;j=C.placeholder;r=C.instantVisualFeedback;o=C.queryVisualizationHeadline;k.attr("autocomplete","off");A=$('<div id="unibox-suggest-box"></div>');s.append(A);var G=s.css("position");if(G!="absolute"){s.css("position","relative")}var D=A.css("border-width").replace("px","");A.css("min-width",k.outerWidth()-2*D);A.css("max-width",C.maxWidth-2*D);k.keydown(l);k.keydown(h(u,p));k.keyup(i);k.blur(function(){A.slideUp(z)});$("html").click(function(){A.slideUp(z)});A.click(function(H){H.stopPropagation()});if(j!=undefined){k.attr("placeholder",j);k.val("")}var E=$('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');k.parent().append(E);if(r=="none"){$("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth()},b);var d=new UniBox();d.init(e,c);return this}}(jQuery));