var UniBox=function(){var g=-1;var m;var u;var E;var y="";var o="";var C=-80;var z;var r;var h=[];var i=true;var d;var D=300;var q="";var s=2;var p;var x;var l;var v=[];var t="all";var e=-1;var f=false;var c=[];function k(G){if(G!==undefined){var H=m.val();if(G.keyCode==9||G.keyCode==27||G.keyCode==13||H.length<s){E.slideUp(D);if(G.keyCode==13&&p!=undefined&&g==-1){p.call(this,H)}g=-1}}else{E.slideUp(D);g=-1}}function j(H,G){var I=null;return function(){var K=this,J=arguments;clearTimeout(I);I=window.setTimeout(function(){H.apply(K,J)},G||50)}}function A(H,G){if(!i){return H}var J=G.split(" ");var I={};jQuery.each(J,function(M,O){if(O.length<1){return}var N=H.match(new RegExp("("+O+")","gi"));if(N!=null){for(var L=0;L<N.length;L++){var K=N[L];H=H.replace(new RegExp(K,"g"),"##"+M+"-"+L+"##");I["##"+M+"-"+L+"##"]="<span>"+K+"</span>"}}});jQuery.each(I,function(K,L){H=H.replace(new RegExp(K,"gi"),L)});return H}function F(K){if(e==13){k();return}var G=m.val();E.html("");var I=false;var J=Object.keys(K.suggests);if(c&&c.length>0){J=c;jQuery.each(Object.keys(K.suggests),function(L,M){if(jQuery.inArray(M,J)<0){J.push(M)}})}jQuery.each(J,function(L,N){var M=K.suggests[N];if(!M){return true}var P=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+N+'"></div>');if(N.replace(/_/,"").length>0&&M.length>0){var O=jQuery("<h4>"+N+"</h4>");P.append(O)}jQuery.each(M,function(Y,W){var V='<div class="unibox-selectable">';if(W.image!=undefined){var aa=W.image.length===0&&z?z:W.image.length===0||W.image.indexOf("/")===0||W.image.indexOf("http")===0?W.image:o+W.image;V+='<div class="unibox-selectable-img-container"><img src="'+aa+'"/></div>'}if(W.link!=undefined){V+='<a href="'+W.link+'">';V+=A(W.name,G);V+="</a>"}else{V+="<span>"+A(W.name,G)+"</span>"}if(d!=undefined){var X=d.match(/##(.*?)##/gi);var U=d;var T=false;for(var R in X){var S=X[R].replace(/#/g,"");var Q=W[S];if(Q==undefined){T=true;continue}var ab=new RegExp(X[R],"g");U=U.replace(ab,Q)}if(!T){V+='<div class="unibox-extra">'+U+"</div>"}}V+='<div class="unibox-ca"></div></div>';var Z=jQuery(V);P.append(Z);I=true});E.append(P)});h=u.find(".unibox-selectable");g=-1;h.mousedown(function(){var M=jQuery(this).text();m.val(M);var L=undefined;try{L=jQuery(this).find("a").attr("href")}catch(N){}if(x!=undefined){x.call(this,M,L)}k()});u.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(K.words.length>0&&q.length>0&&(t=="all"||t=="bottom")){E.append("<h4>"+q+"</h4>");I=true}var H=[];jQuery.each(K.words,function(M,P){if((t=="all"||t=="bottom")){if(P.overlayImage!=undefined){E.append('<img class="unibox-vis" src="'+o+P.overlayImage+'" style="background-image: url(\''+o+P.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(P.image!=undefined){E.append('<img class="unibox-vis" src="'+o+P.image+'">')}}}var O=u.find("#unibox-invisible");O.html(G.replace(new RegExp(P.name,"gi"),"<span>"+P.name+"</span>"));if((t=="all"||t=="top")&&jQuery.inArray(P.image,v)==-1){var N=u.find("#unibox-invisible span")[0];if(N!=undefined&&P.name.length>0&&P.image!=undefined){var L=jQuery(N).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+o+P.image+'" alt="'+P.name+'"></div>');visImage.css("left",B().left+L-10);visImage.css("top",B().top-m.outerHeight()+C);u.append(visImage);setTimeout(function(){u.find(".unibox-ivf").find("img").addClass("l")},10);H.push(P.image)}}else{if(jQuery.inArray(P.image,v)>-1){H.push(P.image)}}});v=H;jQuery("img").error(function(){if(z){jQuery(this).attr("src",z)}else{jQuery(this).hide()}});E.css("left",B().left);E.css("top",B().top);if(I){E.slideDown(D,function(){E.css("left",B().left);E.css("top",B().top)})}else{k()}}function B(){return{left:m.offset().left-u.offset().left,top:m.offset().top-u.offset().top+m.outerHeight()}}function b(){var H=u.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var G=0;G<H.length;G++){if(jQuery.inArray(H[G].replace(o,""),v)==-1){u.find('.unibox-ivf:has(img[src*="'+H[G]+'"])').remove()}}}function a(){v=[];u.find(".unibox-ivf").remove()}function n(I){if(m.val().length<=1){a()}if(I.keyCode!=38&&I.keyCode!=40&&I.keyCode!=13){b();return}if(I.keyCode==38&&g>0){g--}else{if(I.keyCode==40){g++}}if(h.length>0&&g>-1){g=g%h.length;h.removeClass("active");var H=jQuery(h[g]);H.addClass("active")}if(I.keyCode==13){if(x!=undefined){var K=m.val();var G=undefined;if(g!=-1){K=jQuery(u.find(".unibox-selectable.active span")[0]).text();m.val(K);try{G=jQuery(u.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(J){}x.call(this,K,G)}}else{if(g!=-1){window.location.href=jQuery(u.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function w(G){if(e==18){e=G.keyCode;return}e=G.keyCode;if(G.keyCode==38||G.keyCode==40||G.keyCode==13||G.keyCode==9){return}var H=m.val();if(e==46&&H.length==0){a()}if(H.length>=s){jQuery.ajax({url:y+encodeURIComponent(H),dataType:"json",success:function(I){F(I)}})}}return{updateSuggestUrl:function(G){y=G},hideSuggestBox:function(){k()},setIvfImagePath:function(G){o=G;if(o.charAt(o.length-1)!="/"){o+="/"}},changeInstantVisualFeedbackState:function(G){t=G},init:function(S,U){m=S;u=m.parent();i=U.highlight;d=U.extraHtml;y=U.suggestUrl;o=U.ivfImagePath;C=U.ivfImageOffset;z=U.missingErrorImage;r=U.throttleTime;D=U.animationSpeed;s=U.minChars;p=U.enterCallback;x=U.enterCallbackResult;l=U.placeholder;t=U.instantVisualFeedback;q=U.queryVisualizationHeadline;f=U.showDeleteAllButton;c=U.suggestOrder;m.attr("autocomplete","off");E=jQuery('<div id="unibox-suggest-box"></div>');u.append(E);var Q=u.css("position");if(Q!="absolute"){u.css("position","relative")}var L=E.css("border-width").replace("px","");E.css("min-width",m.outerWidth()-2*L);E.css("max-width",U.maxWidth-2*L);m.keydown(n);m.keydown(j(w,r));m.keyup(k);m.blur(function(){E.slideUp(D)});E.mouseenter(function(){E.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){E.slideUp(D)});E.click(function(V){V.stopPropagation()});var H=m.attr("placeholder");l=H&&H.length>0?H:l;if(l&&l.length>0){var N=document.createElement("input");if(!("placeholder" in N)){m.focus(function(){var V=jQuery(this).attr("placeholder");if((V)&&(V.length>0)&&(V!="")&&jQuery(this).val()==V){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var V=jQuery(this).attr("placeholder");if((V)&&(V.length>0)&&(V!="")&&(jQuery(this).val()==""||jQuery(this).val()==V)){jQuery(this).val(V).addClass("hasPlaceholder")}});m.val(l)}m.attr("placeholder",l)}var T=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');m.parent().append(T);if(f){var R=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');u.append(R);jQuery(R).mousedown(function(V){(V||window.event).stopPropagation();m.val("");m.focus();return false});m.focus(function(){if(m.val().length>0){R.show()}else{R.hide()}}).blur(function(){R.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(R).show()}});var P=parseInt(m.css("paddingTop").replace("px","").trim());var O=m.outerHeight();var M=parseInt(m.css("borderTopWidth").replace("px","").trim());var J=m.css("boxShadow").match(/\d{1,3}px/g);var I=(J&&J.length>2)?parseInt(J[2].replace("px","").trim()):0;R.height(O-(2*M)-I-P);var G=parseInt(m.css("paddingRight").replace("px","").trim());m.css("paddingRight",(G>25)?G:25);var K=M+I+(m.offset().top-m.parent().offset().top-m.parent().scrollTop());R.css("top",K);R.css("left",m.outerWidth()-R.outerWidth()-M)}if(t=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth(),showDeleteAllButton:false,suggestOrder:[]},b);var d=new UniBox();d.init(e,c);return d}}(jQuery));