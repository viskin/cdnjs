(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,extraHtml:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var e=-1;var j;var r;var y;var u="";var l="";var o;var f=[];var g=true;var c;var x=300;var n="";var p=2;var m;var s=[];var q="all";var d=-1;function i(A){if(A!==undefined){var B=j.val();if(A.keyCode==9||A.keyCode==13||B.length<p){y.slideUp(x);e=-1}}else{y.slideUp(x);e=-1}}function h(B,A){var C=null;return function(){var E=this,D=arguments;clearTimeout(C);C=window.setTimeout(function(){B.apply(E,D)},A||50)}}function v(B,A){if(!g){return B}var D=A.split(" ");var C={};$.each(D,function(E,F){if(F.length<2){return}B=B.replace(new RegExp(F,"gi"),"##"+E+"##");C["##"+E+"##"]="<span>"+F+"</span>"});$.each(C,function(E,F){B=B.replace(new RegExp(E,"gi"),F)});return B}function z(D){if(d==13){i();return}var A=j.val();y.html("");var C=false;$.each(D.suggests,function(F,E){var H=$('<div class="unibox-suggest-'+F+'"></div>');if(F.replace(/_/,"").length>0&&E.length>0){var G=$("<h4>"+F+"</h4>");H.append(G)}$.each(E,function(Q,O){var N='<div class="unibox-selectable">';if(O.image!=undefined){N+='<div class="unibox-selectable-img-container"><img src="'+O.image+'"/></div>'}if(O.link!=undefined){N+='<a href="'+O.link+'">';N+=v(O.name,A);N+="</a>"}else{N+="<span>"+v(O.name,A)+"</span>"}if(c!=undefined){var P=c.match(/##(.*?)##/gi);var M=c;var K=false;for(var J in P){var L=P[J].replace(/#/g,"");var I=O[L];if(I==undefined){K=true;continue}var S=new RegExp(P[J],"g");M=M.replace(S,I)}if(!K){N+='<div class="unibox-extra">'+M+"</div>"}}N+='<div class="unibox-ca"></div></div>';var R=$(N);H.append(R);C=true});y.append(H)});f=$(".unibox-selectable");e=-1;f.click(function(){var F=$(this).find("span").first().text();j.val(F);var E=undefined;try{E=$(this).find("a").attr("href")}catch(G){}m.call(this,F,E);i()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(D.words.length>0&&n.length>0&&(q=="all"||q=="bottom")){y.append("<h4>"+n+"</h4>");C=true}var B=[];$.each(D.words,function(F,I){if((q=="all"||q=="bottom")){if(I.overlayImage!=undefined){y.append('<img class="unibox-vis" src="'+l+I.overlayImage+'" style="background-image: url(\''+l+I.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(I.image!=undefined){y.append('<img class="unibox-vis" src="'+l+I.image+'">')}}}var H=$("#unibox-invisible");H.html(A.replace(new RegExp(I.name,"gi"),"<span>"+I.name+"</span>"));if((q=="all"||q=="top")&&jQuery.inArray(I.image,s)==-1){var G=$("#unibox-invisible span")[0];if(G!=undefined&&I.name.length>0&&I.image!=undefined){var E=$(G).position().left;visImage=$('<div class="unibox-ivf"><img src="'+l+I.image+'" alt="'+I.name+'"></div>');visImage.css("left",w().left+E-10);visImage.css("top",w().top-j.outerHeight()-80);r.append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10);B.push(I.image)}}else{if(jQuery.inArray(I.image,s)>-1){B.push(I.image)}}});s=B;$("img").error(function(){$(this).hide()});y.css("left",w().left);y.css("top",w().top);if(C){y.slideDown(x,function(){y.css("left",w().left);y.css("top",w().top)})}else{i()}}function w(){return{left:j.offset().left-r.offset().left,top:j.offset().top-r.offset().top+j.outerHeight()}}function b(){var B=$(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var A=0;A<B.length;A++){if(jQuery.inArray(B[A].replace(l,""),s)==-1){$('.unibox-ivf:has(img[src*="'+B[A]+'"])').remove()}}}function a(){s=[];$(".unibox-ivf").remove()}function k(C){if(j.val().length<=1){a()}if(C.keyCode!=38&&C.keyCode!=40&&C.keyCode!=13){b();return}if(C.keyCode==38&&e>0){e--}else{if(C.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var B=$(f[e]);B.addClass("active")}if(C.keyCode==13){if(m!=undefined){var E=j.val();var A=undefined;if(e!=-1){E=$($(".unibox-selectable.active span")[0]).text();j.val(E);try{A=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(D){}}m.call(this,E,A)}else{if(e!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function t(A){d=A.keyCode;if(A.keyCode==38||A.keyCode==40||A.keyCode==13){return}var B=j.val();if(d==46&&B.length==0){a()}if(B.length>=p){$.ajax(u+encodeURIComponent(B),{dataType:"json",success:function(C){z(C)}})}}return{updateSuggestUrl:function(A){u=A},setIvfImagePath:function(A){l=A;if(l.charAt(l.length-1)!="/"){l+="/"}},changeInstantVisualFeedbackState:function(A){q=A},init:function(D,A){j=D;r=j.parent();g=A.highlight;c=A.extraHtml;u=A.suggestUrl;l=A.ivfImagePath;o=A.throttleTime;x=A.animationSpeed;p=A.minChars;m=A.enterCallback;q=A.instantVisualFeedback;n=A.queryVisualizationHeadline;j.attr("autocomplete","off");y=$('<div id="unibox-suggest-box"></div>');r.append(y);var E=r.css("position");if(E!="absolute"){j.parent().css("position","relative")}var B=y.css("border-width").replace("px","");console.log(B);y.css("min-width",j.outerWidth()-2*B);y.css("max-width",A.maxWidth-2*B);j.keydown(k);j.keydown(h(t,o));j.keydown(i);j.keyup(i);$("html").click(function(){y.slideUp(x)});y.click(function(F){F.stopPropagation()});var C=$('<div id="unibox-invisible">text <span>more</span></div>');j.parent().append(C)}}}();