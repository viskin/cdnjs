var UniBox=function(){var g=-1;var n;var v;var G;var A="";var p="";var E=-80;var B;var s;var h=[];var j=true;var d;var F=300;var r="";var t=2;var q;var z;var m;var x=[];var u="all";var e=-1;var i="";var f=false;var c=[];var w=[];function l(I){if(I!==undefined){var J=n.val();if(I.keyCode==9||I.keyCode==27||I.keyCode==13||J.length<t){G.slideUp(F);if(I.keyCode==13&&q!=undefined&&g==-1){q.call(this,J)}g=-1}}else{G.slideUp(F);g=-1}}function k(J,I){var K=null;return function(){var M=this,L=arguments;clearTimeout(K);K=window.setTimeout(function(){J.apply(M,L)},I||50)}}function C(J,I){if(!j){return J}var P=I.split(" ");P.sort(function(R,Q){return Q.length-R.length});var O={};jQuery.each(P,function(Q,U){if(U.length<1){return}var T=J.match(new RegExp("(("+U+")(?!#<##|-\\d+#<##))(?!.*\\1)","gi"));if(T!=null){for(var S=0;S<T.length;S++){var R=T[S];J=J.replace(new RegExp("("+R+")(?!#<##|-\\d+#<##)","g"),"##>#"+Q+"-"+S+"#<##");O["##>#"+Q+"-"+S+"#<##"]='<span class="unibox-highlight">'+R+"</span>"}}});var M=Object.keys(O).reverse();for(var K=0;K<M.length;K++){var N=M[K];var L=O[N];J=J.replace(new RegExp(N,"gi"),L)}return J}function H(M){if(e==13){l();return}var I=n.val();G.html("");var K=false;var L=Object.keys(M.suggests);if(c&&c.length>0){L=c;jQuery.each(Object.keys(M.suggests),function(N,O){if(jQuery.inArray(O,L)<0){L.push(O)}})}jQuery.each(L,function(N,Q){var P=M.suggests[Q];if(!P){return true}var O=0;jQuery.each(L,function(T,V){var U=M.suggests[V];if(!U||Q===V||U.length==0){return true}O+=U.length});var S=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+Q+" "+("unibox-"+P.length+"-entries")+" "+(O==0?"unibox-single-suggestion-block":"")+'"></div>');if(Q.replace(/_/,"").length>0&&P.length>0){var R=jQuery("<h4>"+Q+"</h4>");S.append(R)}jQuery.each(P,function(ab,Z){var Y='<div class="unibox-selectable">';if(Z.image!=undefined){var ad=Z.image.length===0&&B?B:Z.image.length===0||Z.image.indexOf("/")===0||Z.image.indexOf("http")===0?Z.image:p+Z.image;Y+='<div class="unibox-selectable-img-container"><img src="'+ad+'"/></div>'}if(Z.link!=undefined){Y+='<a href="'+Z.link+'">';Y+=C(Z.name,I);Y+="</a>"}else{Y+="<span>"+C(Z.name,I)+"</span>"}if(d!=undefined){var aa=d.match(/##(.*?)##/gi);var X=d;var W=false;for(var U in aa){var V=aa[U].replace(/#/g,"");var T=Z[V];if(T==undefined){W=true;continue}var ae=new RegExp(aa[U],"g");X=X.replace(ae,T)}if(!W){Y+='<div class="unibox-extra">'+X+"</div>"}}Y+='<div class="unibox-ca"></div></div>';var ac=jQuery(Y);S.append(ac);K=true});G.append(S)});if(w&&w.length>0){h=[];jQuery.each(w,function(N,O){h=h.concat(v.find(".unibox-suggest-"+O+":first .unibox-selectable").get())})}else{h=v.find(".unibox-selectable")}g=-1;jQuery(h).mousedown(function(){var O=jQuery(this).text();n.val(O);var N=undefined;try{N=jQuery(this).find("a:first").attr("href")}catch(P){}if(z!=undefined){z.call(this,O,N)}l()});v.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(M.words.length>0&&r.length>0&&(u=="all"||u=="bottom")){G.append("<h4>"+r+"</h4>");K=true}var J=[];jQuery.each(M.words,function(O,R){if((u=="all"||u=="bottom")){if(R.overlayImage!=undefined){G.append('<img class="unibox-vis" src="'+p+R.overlayImage+'" style="background-image: url(\''+p+R.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(R.image!=undefined){G.append('<img class="unibox-vis" src="'+p+R.image+'">')}}}var Q=v.find("#unibox-invisible");Q.html(I.replace(new RegExp(R.name,"gi"),"<span>"+R.name+"</span>"));if((u=="all"||u=="top")&&jQuery.inArray(R.image,x)==-1){var P=v.find("#unibox-invisible span")[0];if(P!=undefined&&R.name.length>0&&R.image!=undefined){var N=jQuery(P).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+p+R.image+'" alt="'+R.name+'"></div>');visImage.css("left",D().left+N-10);visImage.css("top",D().top-n.outerHeight()+E);v.append(visImage);setTimeout(function(){v.find(".unibox-ivf").find("img").addClass("l")},10);J.push(R.image)}}else{if(jQuery.inArray(R.image,x)>-1){J.push(R.image)}}});x=J;jQuery("img").error(function(){if(B){jQuery(this).attr("src",B)}else{jQuery(this).hide()}});G.css("left",D().left);G.css("top",D().top);if(K){G.slideDown(F,function(){G.css("left",D().left);G.css("top",D().top)})}else{l()}}function D(){return{left:n.offset().left-v.offset().left,top:n.offset().top-v.offset().top+n.outerHeight()}}function b(){var J=v.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var I=0;I<J.length;I++){if(jQuery.inArray(J[I].replace(p,""),x)==-1){v.find('.unibox-ivf:has(img[src*="'+J[I]+'"])').remove()}}}function a(){x=[];v.find(".unibox-ivf").remove()}function o(K){if(n.val().length<=1){a()}if(K.keyCode!=38&&K.keyCode!=40&&K.keyCode!=13){b();return}if(K.keyCode==38&&g>0){g--}else{if(K.keyCode==40){g++}else{if(K.keyCode==38&&g<=0){g=((g!=-1)?g-1:g)+h.length}}}if(h.length>0&&g>-1){g=g%h.length;jQuery(h).removeClass("active");var J=jQuery(h[g]);J.addClass("active")}if(K.keyCode==13){if(z!=undefined){var M=n.val();var I=undefined;if(g!=-1){M=jQuery(v.find(".unibox-selectable.active")[0]).text();n.val(M);try{I=jQuery(v.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(L){}if(z!=undefined){z.call(this,M,I)}}}else{if(g!=-1){window.location.href=jQuery(v.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function y(I){if(e==18){e=I.keyCode;return}e=I.keyCode;if(I.keyCode==38||I.keyCode==40||I.keyCode==13||I.keyCode==9){return}var J=n.val();if(e==46&&J.length==0){a()}if(J.length>=t){i=J;jQuery.ajax({usedQuery:J,url:A+encodeURIComponent(J),dataType:"json",success:function(K){if(this.usedQuery==i){H(K)}}})}}return{updateSuggestUrl:function(I){A=I},hideSuggestBox:function(){l()},setIvfImagePath:function(I){p=I;if(p.charAt(p.length-1)!="/"){p+="/"}},changeInstantVisualFeedbackState:function(I){u=I},init:function(V,X){n=V;v=n.parent();j=X.highlight;d=X.extraHtml;A=X.suggestUrl;p=X.ivfImagePath;E=X.ivfImageOffset;B=X.missingErrorImage;s=X.throttleTime;F=X.animationSpeed;t=X.minChars;q=X.enterCallback;z=X.enterCallbackResult;m=X.placeholder;u=X.instantVisualFeedback;r=X.queryVisualizationHeadline;f=X.showDeleteAllButton;c=X.suggestOrder;w=X.suggestSelectionOrder;n.attr("autocomplete","off");G=jQuery('<div id="unibox-suggest-box"></div>');v.append(G);var T=v.css("position");if(T!="absolute"){v.css("position","relative")}var O=G.css("border-width").replace("px","");G.css("min-width",n.outerWidth()-2*O);G.css("max-width",X.maxWidth-2*O);n.keydown(o);n.keydown(k(y,s));n.keyup(l);n.blur(function(){G.slideUp(F)});G.mouseenter(function(){G.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){G.slideUp(F)});G.click(function(Y){Y.stopPropagation()});var J=n.attr("placeholder");m=J&&J.length>0?J:m;if(m&&m.length>0){var Q=document.createElement("input");if(!("placeholder" in Q)){n.focus(function(){var Y=jQuery(this).attr("placeholder");if((Y)&&(Y.length>0)&&(Y!="")&&jQuery(this).val()==Y){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var Y=jQuery(this).attr("placeholder");if((Y)&&(Y.length>0)&&(Y!="")&&(jQuery(this).val()==""||jQuery(this).val()==Y)){jQuery(this).val(Y).addClass("hasPlaceholder")}});n.val(m)}n.attr("placeholder",m)}var W=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');n.parent().append(W);if(f){var U=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');v.append(U);jQuery(U).mousedown(function(Y){(Y||window.event).stopPropagation();n.val("");n.focus();return false});n.focus(function(){if(n.val().length>0){U.show()}else{U.hide()}}).blur(function(){U.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(U).show()}});var S=parseInt(n.css("paddingTop").replace("px","").trim());var R=n.outerHeight();var P=parseInt(n.css("borderTopWidth").replace("px","").trim());var M=n.css("boxShadow").match(/\d{1,3}px/g);var L=(M&&M.length>2)?parseInt(M[2].replace("px","").trim()):0;U.height(R-(2*P)-L-S);var I=parseInt(n.css("paddingRight").replace("px","").trim());I=(I>25)?I:25;n.css("paddingRight",I);var N=P+L+(n.offset().top-n.parent().offset().top-n.parent().scrollTop());var K=Math.abs(n[0].getBoundingClientRect().left-n.parent()[0].getBoundingClientRect().left)+n.outerWidth()-U.outerWidth()-P-I;U.css("top",N);U.css("left",K)}if(u=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var c=this.map(function(d,g){g=$(g);var e=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:g.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);var f=new UniBox();f.init(g,e);return f});if(c.length==1){return c[0]}return c}}(jQuery));