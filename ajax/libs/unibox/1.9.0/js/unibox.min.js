var UniBox=function(){var f=-1;var l;var t;var D;var x="";var n="";var B=-80;var y;var q;var g=[];var h=true;var c;var C=300;var p="";var r=2;var o;var w;var k;var u=[];var s="all";var d=-1;var e=false;function j(F){if(F!==undefined){var G=l.val();if(F.keyCode==9||F.keyCode==27||F.keyCode==13||G.length<r){D.slideUp(C);if(F.keyCode==13&&o!=undefined&&f==-1){o.call(this,G)}f=-1}}else{D.slideUp(C);f=-1}}function i(G,F){var H=null;return function(){var J=this,I=arguments;clearTimeout(H);H=window.setTimeout(function(){G.apply(J,I)},F||50)}}function z(G,F){if(!h){return G}var I=F.split(" ");var H={};$.each(I,function(L,N){if(N.length<1){return}var M=G.match(new RegExp("("+N+")","gi"));if(M!=null){for(var K=0;K<M.length;K++){var J=M[K];G=G.replace(new RegExp(J,"g"),"##"+L+"-"+K+"##");H["##"+L+"-"+K+"##"]="<span>"+J+"</span>"}}});$.each(H,function(J,K){G=G.replace(new RegExp(J,"gi"),K)});return G}function E(I){if(d==13){j();return}var F=l.val();D.html("");var H=false;jQuery.each(I.suggests,function(K,J){var M=jQuery('<div class="unibox-suggest-'+K+'"></div>');if(K.replace(/_/,"").length>0&&J.length>0){var L=jQuery("<h4>"+K+"</h4>");M.append(L)}jQuery.each(J,function(V,T){var S='<div class="unibox-selectable">';if(T.image!=undefined){var X=T.image.length===0&&y?y:T.image.length===0||T.image.indexOf("/")===0||T.image.indexOf("http")===0?T.image:n+T.image;S+='<div class="unibox-selectable-img-container"><img src="'+X+'"/></div>'}if(T.link!=undefined){S+='<a href="'+T.link+'">';S+=z(T.name,F);S+="</a>"}else{S+="<span>"+z(T.name,F)+"</span>"}if(c!=undefined){var U=c.match(/##(.*?)##/gi);var R=c;var Q=false;for(var O in U){var P=U[O].replace(/#/g,"");var N=T[P];if(N==undefined){Q=true;continue}var Y=new RegExp(U[O],"g");R=R.replace(Y,N)}if(!Q){S+='<div class="unibox-extra">'+R+"</div>"}}S+='<div class="unibox-ca"></div></div>';var W=jQuery(S);M.append(W);H=true});D.append(M)});g=t.find(".unibox-selectable");f=-1;g.mousedown(function(){var K=jQuery(this).find("span").first().text();l.val(K);var J=undefined;try{J=jQuery(this).find("a").attr("href")}catch(L){}w.call(this,K,J);j()});t.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(I.words.length>0&&p.length>0&&(s=="all"||s=="bottom")){D.append("<h4>"+p+"</h4>");H=true}var G=[];jQuery.each(I.words,function(K,N){if((s=="all"||s=="bottom")){if(N.overlayImage!=undefined){D.append('<img class="unibox-vis" src="'+n+N.overlayImage+'" style="background-image: url(\''+n+N.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(N.image!=undefined){D.append('<img class="unibox-vis" src="'+n+N.image+'">')}}}var M=t.find("#unibox-invisible");M.html(F.replace(new RegExp(N.name,"gi"),"<span>"+N.name+"</span>"));if((s=="all"||s=="top")&&jQuery.inArray(N.image,u)==-1){var L=t.find("#unibox-invisible span")[0];if(L!=undefined&&N.name.length>0&&N.image!=undefined){var J=jQuery(L).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+n+N.image+'" alt="'+N.name+'"></div>');visImage.css("left",A().left+J-10);visImage.css("top",A().top-l.outerHeight()+B);t.append(visImage);setTimeout(function(){t.find(".unibox-ivf").find("img").addClass("l")},10);G.push(N.image)}}else{if(jQuery.inArray(N.image,u)>-1){G.push(N.image)}}});u=G;jQuery("img").error(function(){if(y){jQuery(this).attr("src",y)}else{jQuery(this).hide()}});D.css("left",A().left);D.css("top",A().top);if(H){D.slideDown(C,function(){D.css("left",A().left);D.css("top",A().top)})}else{j()}}function A(){return{left:l.offset().left-t.offset().left,top:l.offset().top-t.offset().top+l.outerHeight()}}function b(){var G=t.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var F=0;F<G.length;F++){if(jQuery.inArray(G[F].replace(n,""),u)==-1){t.find('.unibox-ivf:has(img[src*="'+G[F]+'"])').remove()}}}function a(){u=[];t.find(".unibox-ivf").remove()}function m(H){if(l.val().length<=1){a()}if(H.keyCode!=38&&H.keyCode!=40&&H.keyCode!=13){b();return}if(H.keyCode==38&&f>0){f--}else{if(H.keyCode==40){f++}}if(g.length>0&&f>-1){f=f%g.length;g.removeClass("active");var G=jQuery(g[f]);G.addClass("active")}if(H.keyCode==13){if(w!=undefined){var J=l.val();var F=undefined;if(f!=-1){J=jQuery(t.find(".unibox-selectable.active span")[0]).text();l.val(J);try{F=jQuery(t.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(I){}w.call(this,J,F)}}else{if(f!=-1){window.location.href=jQuery(t.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function v(F){if(d==18){d=F.keyCode;return}d=F.keyCode;if(F.keyCode==38||F.keyCode==40||F.keyCode==13||F.keyCode==9){return}var G=l.val();if(d==46&&G.length==0){a()}if(G.length>=r){jQuery.ajax({url:x+encodeURIComponent(G),dataType:"json",success:function(H){E(H)}})}}return{updateSuggestUrl:function(F){x=F},hideSuggestBox:function(){j()},setIvfImagePath:function(F){n=F;if(n.charAt(n.length-1)!="/"){n+="/"}},changeInstantVisualFeedbackState:function(F){s=F},init:function(K,G){l=K;t=l.parent();h=G.highlight;c=G.extraHtml;x=G.suggestUrl;n=G.ivfImagePath;B=G.ivfImageOffset;y=G.missingErrorImage;q=G.throttleTime;C=G.animationSpeed;r=G.minChars;o=G.enterCallback;w=G.enterCallbackResult;k=G.placeholder;s=G.instantVisualFeedback;p=G.queryVisualizationHeadline;e=G.showDeleteAllButton;l.attr("autocomplete","off");D=jQuery('<div id="unibox-suggest-box"></div>');t.append(D);var L=t.css("position");if(L!="absolute"){t.css("position","relative")}var H=D.css("border-width").replace("px","");D.css("min-width",l.outerWidth()-2*H);D.css("max-width",G.maxWidth-2*H);l.keydown(m);l.keydown(i(v,q));l.keyup(j);l.blur(function(){D.slideUp(C)});jQuery("html").click(function(){D.slideUp(C)});D.click(function(M){M.stopPropagation()});var J=l.attr("placeholder");k=J&&J.length>0?J:k;if(k&&k.length>0){var F=document.createElement("input");if(!("placeholder" in F)){l.focus(function(){var M=jQuery(this).attr("placeholder");if((M)&&(M.length>0)&&(M!="")&&jQuery(this).val()==M){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var M=jQuery(this).attr("placeholder");if((M)&&(M.length>0)&&(M!="")&&(jQuery(this).val()==""||jQuery(this).val()==M)){jQuery(this).val(M).addClass("hasPlaceholder")}});l.val(k)}l.attr("placeholder",k);l.val("")}var I=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');l.parent().append(I);if(s=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth(),showDeleteAllButton:false},b);var d=new UniBox();d.init(e,c);return d}}(jQuery));