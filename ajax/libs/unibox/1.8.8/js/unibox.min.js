var UniBox=function(){var e=-1;var k;var s;var C;var w="";var m="";var A=-80;var x;var p;var f=[];var g=true;var c;var B=300;var o="";var q=2;var n;var v;var j;var t=[];var r="all";var d=-1;function i(E){if(E!==undefined){var F=k.val();if(E.keyCode==9||E.keyCode==27||E.keyCode==13||F.length<q){C.slideUp(B);if(E.keyCode==13&&n!=undefined&&e==-1){n.call(this,F)}e=-1}}else{C.slideUp(B);e=-1}}function h(F,E){var G=null;return function(){var I=this,H=arguments;clearTimeout(G);G=window.setTimeout(function(){F.apply(I,H)},E||50)}}function y(F,E){if(!g){return F}var H=E.split(" ");var G={};jQuery.each(H,function(I,J){if(J.length<1){return}F=F.replace(new RegExp(J,"gi"),"##"+I+"##");G["##"+I+"##"]="<span>"+J+"</span>"});jQuery.each(G,function(I,J){F=F.replace(new RegExp(I,"gi"),J)});return F}function D(H){if(d==13){i();return}var E=k.val();C.html("");var G=false;jQuery.each(H.suggests,function(J,I){var L=jQuery('<div class="unibox-suggest-'+J+'"></div>');if(J.replace(/_/,"").length>0&&I.length>0){var K=jQuery("<h4>"+J+"</h4>");L.append(K)}jQuery.each(I,function(U,S){var R='<div class="unibox-selectable">';if(S.image!=undefined){var W=S.image.length===0&&x?x:S.image.length===0||S.image.indexOf("/")===0||S.image.indexOf("http")===0?S.image:m+S.image;R+='<div class="unibox-selectable-img-container"><img src="'+W+'"/></div>'}if(S.link!=undefined){R+='<a href="'+S.link+'">';R+=y(S.name,E);R+="</a>"}else{R+="<span>"+y(S.name,E)+"</span>"}if(c!=undefined){var T=c.match(/##(.*?)##/gi);var Q=c;var P=false;for(var N in T){var O=T[N].replace(/#/g,"");var M=S[O];if(M==undefined){P=true;continue}var X=new RegExp(T[N],"g");Q=Q.replace(X,M)}if(!P){R+='<div class="unibox-extra">'+Q+"</div>"}}R+='<div class="unibox-ca"></div></div>';var V=jQuery(R);L.append(V);G=true});C.append(L)});f=s.find(".unibox-selectable");e=-1;f.click(function(){var J=jQuery(this).find("span").first().text();k.val(J);var I=undefined;try{I=jQuery(this).find("a").attr("href")}catch(K){}v.call(this,J,I);i()});s.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(H.words.length>0&&o.length>0&&(r=="all"||r=="bottom")){C.append("<h4>"+o+"</h4>");G=true}var F=[];jQuery.each(H.words,function(J,M){if((r=="all"||r=="bottom")){if(M.overlayImage!=undefined){C.append('<img class="unibox-vis" src="'+m+M.overlayImage+'" style="background-image: url(\''+m+M.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(M.image!=undefined){C.append('<img class="unibox-vis" src="'+m+M.image+'">')}}}var L=s.find("#unibox-invisible");L.html(E.replace(new RegExp(M.name,"gi"),"<span>"+M.name+"</span>"));if((r=="all"||r=="top")&&jQuery.inArray(M.image,t)==-1){var K=s.find("#unibox-invisible span")[0];if(K!=undefined&&M.name.length>0&&M.image!=undefined){var I=jQuery(K).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+m+M.image+'" alt="'+M.name+'"></div>');visImage.css("left",z().left+I-10);visImage.css("top",z().top-k.outerHeight()+A);s.append(visImage);setTimeout(function(){s.find(".unibox-ivf").find("img").addClass("l")},10);F.push(M.image)}}else{if(jQuery.inArray(M.image,t)>-1){F.push(M.image)}}});t=F;jQuery("img").error(function(){if(x){jQuery(this).attr("src",x)}else{jQuery(this).hide()}});C.css("left",z().left);C.css("top",z().top);if(G){C.slideDown(B,function(){C.css("left",z().left);C.css("top",z().top)})}else{i()}}function z(){return{left:k.offset().left-s.offset().left,top:k.offset().top-s.offset().top+k.outerHeight()}}function b(){var F=s.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var E=0;E<F.length;E++){if(jQuery.inArray(F[E].replace(m,""),t)==-1){s.find('.unibox-ivf:has(img[src*="'+F[E]+'"])').remove()}}}function a(){t=[];s.find(".unibox-ivf").remove()}function l(G){if(k.val().length<=1){a()}if(G.keyCode!=38&&G.keyCode!=40&&G.keyCode!=13){b();return}if(G.keyCode==38&&e>0){e--}else{if(G.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var F=jQuery(f[e]);F.addClass("active")}if(G.keyCode==13){if(v!=undefined){var I=k.val();var E=undefined;if(e!=-1){I=jQuery(s.find(".unibox-selectable.active span")[0]).text();k.val(I);try{E=jQuery(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(H){}v.call(this,I,E)}}else{if(e!=-1){window.location.href=jQuery(s.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function u(E){if(d==18){d=E.keyCode;return}d=E.keyCode;if(E.keyCode==38||E.keyCode==40||E.keyCode==13||E.keyCode==9){return}var F=k.val();if(d==46&&F.length==0){a()}if(F.length>=q){jQuery.ajax({url:w+encodeURIComponent(F),dataType:"json",success:function(G){D(G)}})}}return{updateSuggestUrl:function(E){w=E},hideSuggestBox:function(){i()},setIvfImagePath:function(E){m=E;if(m.charAt(m.length-1)!="/"){m+="/"}},changeInstantVisualFeedbackState:function(E){r=E},init:function(H,E){k=H;s=k.parent();g=E.highlight;c=E.extraHtml;w=E.suggestUrl;m=E.ivfImagePath;A=E.ivfImageOffset;x=E.missingErrorImage;p=E.throttleTime;B=E.animationSpeed;q=E.minChars;n=E.enterCallback;v=E.enterCallbackResult;j=E.placeholder;r=E.instantVisualFeedback;o=E.queryVisualizationHeadline;k.attr("autocomplete","off");C=jQuery('<div id="unibox-suggest-box"></div>');s.append(C);var I=s.css("position");if(I!="absolute"){s.css("position","relative")}var F=C.css("border-width").replace("px","");C.css("min-width",k.outerWidth()-2*F);C.css("max-width",E.maxWidth-2*F);k.keydown(l);k.keydown(h(u,p));k.keyup(i);k.blur(function(){C.slideUp(B)});jQuery("html").click(function(){C.slideUp(B)});C.click(function(J){J.stopPropagation()});if(j!=undefined){k.attr("placeholder",j);k.val("")}var G=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');k.parent().append(G);if(r=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var e=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:e.outerWidth()},b);var d=new UniBox();d.init(e,c);return d}}(jQuery));