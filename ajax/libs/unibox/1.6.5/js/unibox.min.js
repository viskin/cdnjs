(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",ivfImagePath:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,extraHtml:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var e=-1;var j;var x;var t="";var l="";var o;var f=[];var g=true;var c;var w=300;var n="";var p=2;var m;var r=[];var q="all";var d=-1;function i(z){if(z!==undefined){var A=j.val();if(z.keyCode==9||z.keyCode==13||A.length<p){x.slideUp(w);e=-1}}else{x.slideUp(w);e=-1}}function h(A,z){var B=null;return function(){var D=this,C=arguments;clearTimeout(B);B=window.setTimeout(function(){A.apply(D,C)},z||50)}}function u(A,z){if(!g){return A}var C=z.split(" ");var B={};$.each(C,function(D,E){if(E.length<2){return}A=A.replace(new RegExp(E,"gi"),"##"+D+"##");B["##"+D+"##"]="<span>"+E+"</span>"});$.each(B,function(D,E){A=A.replace(new RegExp(D,"gi"),E)});return A}function y(C){if(d==13){i();return}var z=j.val();x.html("");var B=false;$.each(C.suggests,function(E,D){var G=$('<div class="unibox-suggest-'+E+'"></div>');if(E.replace(/_/,"").length>0&&D.length>0){var F=$("<h4>"+E+"</h4>");G.append(F)}$.each(D,function(P,N){var M='<div class="unibox-selectable">';if(N.image!=undefined){M+='<div class="unibox-selectable-img-container"><img src="'+N.image+'"/></div>'}if(N.link!=undefined){M+='<a href="'+N.link+'">';M+=u(N.name,z);M+="</a>"}else{M+="<span>"+u(N.name,z)+"</span>"}if(c!=undefined){var O=c.match(/##(.*?)##/gi);var L=c;var J=false;for(var I in O){var K=O[I].replace(/#/g,"");var H=N[K];if(H==undefined){J=true;continue}var R=new RegExp(O[I],"g");L=L.replace(R,H)}if(!J){M+='<div class="unibox-extra">'+L+"</div>"}}M+='<div class="unibox-ca"></div></div>';var Q=$(M);G.append(Q);B=true});x.append(G)});f=$(".unibox-selectable");e=-1;f.click(function(){var E=$(this).find("span").first().text();j.val(E);var D=undefined;try{D=$(this).find("a").attr("href")}catch(F){}m.call(this,E,D);i()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(C.words.length>0&&n.length>0&&(q=="all"||q=="bottom")){x.append("<h4>"+n+"</h4>");B=true}var A=[];$.each(C.words,function(E,H){if((q=="all"||q=="bottom")){if(H.overlayImage!=undefined){x.append('<img class="unibox-vis" src="'+l+H.overlayImage+'" style="background-image: url(\''+l+H.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(H.image!=undefined){x.append('<img class="unibox-vis" src="'+l+H.image+'">')}}}var G=$("#unibox-invisible");G.html(z.replace(new RegExp(H.name,"gi"),"<span>"+H.name+"</span>"));if((q=="all"||q=="top")&&jQuery.inArray(H.image,r)==-1){var F=$("#unibox-invisible span")[0];if(F!=undefined&&H.name.length>0&&H.image!=undefined){var D=$(F).position().left;visImage=$('<div class="unibox-ivf"><img src="'+l+H.image+'" alt="'+H.name+'"></div>');visImage.css("left",v().left+D-10);visImage.css("top",v().top-j.outerHeight()-80);$("#unibox").append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10);A.push(H.image)}}else{if(jQuery.inArray(H.image,r)>-1){A.push(H.image)}}});r=A;$("img").error(function(){$(this).hide()});x.css("left",v().left);x.css("top",v().top);if(B){x.slideDown(w,function(){x.css("left",v().left);x.css("top",v().top)})}else{i()}}function v(){return{left:j.offset().left-$("#unibox").offset().left,top:j.offset().top-$("#unibox").offset().top+j.outerHeight()}}function b(){var A=$(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var z=0;z<A.length;z++){if(jQuery.inArray(A[z].replace(l,""),r)==-1){$('.unibox-ivf:has(img[src*="'+A[z]+'"])').remove()}}}function a(){r=[];$(".unibox-ivf").remove()}function k(B){if(j.val().length<=1){a()}if(B.keyCode!=38&&B.keyCode!=40&&B.keyCode!=13){b();return}if(B.keyCode==38&&e>0){e--}else{if(B.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var A=$(f[e]);A.addClass("active")}if(B.keyCode==13){if(m!=undefined){var D=j.val();var z=undefined;if(e!=-1){D=$($(".unibox-selectable.active span")[0]).text();j.val(D);try{z=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(C){}}m.call(this,D,z)}else{if(e!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function s(z){d=z.keyCode;if(z.keyCode==38||z.keyCode==40||z.keyCode==13){return}var A=j.val();if(d==46&&A.length==0){a()}if(A.length>=p){$.ajax(t+encodeURIComponent(A),{dataType:"json",success:function(B){y(B)}})}}return{updateSuggestUrl:function(z){t=z},setIvfImagePath:function(z){l=z;if(l.charAt(l.length-1)!="/"){l+="/"}},changeInstantVisualFeedbackState:function(z){q=z},init:function(B,z){j=B;g=z.highlight;c=z.extraHtml;t=z.suggestUrl;l=z.ivfImagePath;o=z.throttleTime;w=z.animationSpeed;p=z.minChars;m=z.enterCallback;q=z.instantVisualFeedback;n=z.queryVisualizationHeadline;j.attr("autocomplete","off");x=$('<div id="unibox-suggest-box"></div>');$("#unibox").append(x);x.css("min-width",j.outerWidth());x.css("max-width",z.maxWidth);j.keydown(k);j.keydown(h(s,o));j.keydown(i);j.keyup(i);$("html").click(function(){x.slideUp(w)});x.click(function(C){C.stopPropagation()});var A=$('<div id="unibox-invisible">text <span>more</span></div>');j.parent().append(A)}}}();