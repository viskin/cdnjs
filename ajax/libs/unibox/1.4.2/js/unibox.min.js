(function(a){a.fn.unibox=function(b){var d=this;var c=a.extend({suggestUrl:"",queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,extraHtml:undefined,minChars:3,maxWidth:d.outerWidth()},b);UniBox.init(d,c);return this}}(jQuery));var UniBox=function(){var e=-1;var j;var w;var s="";var n;var f=[];var g=true;var c;var v=300;var m="";var o=2;var l;var q=[];var p="all";var d=-1;function i(y){if(y!==undefined){var z=j.val();if(y.keyCode==9||y.keyCode==13||z.length<o){w.slideUp(v);e=-1}}else{w.slideUp(v);e=-1}}function h(z,y){var A=null;return function(){var C=this,B=arguments;clearTimeout(A);A=window.setTimeout(function(){z.apply(C,B)},y||50)}}function t(z,y){if(!g){return z}var B=y.split(" ");var A={};$.each(B,function(C,D){if(D.length<2){return}z=z.replace(new RegExp(D,"gi"),"##"+C+"##");A["##"+C+"##"]="<span>"+D+"</span>"});$.each(A,function(C,D){z=z.replace(new RegExp(C,"gi"),D)});return z}function x(A){if(d==13){i();return}var y=j.val();w.html("");$.each(A.suggests,function(C,B){var E=$('<div class="unibox-suggest-'+C+'"></div>');if(C.replace(/_/,"").length>0&&B.length>0){var D=$("<h4>"+C+"</h4>");E.append(D)}$.each(B,function(N,L){var K='<div class="unibox-selectable">';if(L.image!=undefined){K+='<div class="unibox-selectable-img-container"><img src="'+L.image+'"/></div>'}if(L.link!=undefined){K+='<a href="'+L.link+'">';K+=t(L.name,y);K+="</a>"}else{K+="<span>"+t(L.name,y)+"</span>"}if(c!=undefined){var M=c.match(/##(.*?)##/gi);var J=c;var H=false;for(var G in M){var I=M[G].replace(/#/g,"");var F=L[I];if(F==undefined){H=true;continue}var P=new RegExp(M[G],"g");J=J.replace(P,F)}if(!H){K+='<div class="unibox-extra">'+J+"</div>"}}K+='<div class="unibox-ca"></div></div>';var O=$(K);E.append(O)});w.append(E)});f=$(".unibox-selectable");e=-1;f.click(function(){var C=$(this).find("span").text();j.val(C);var B=undefined;try{B=$(this).find("a").attr("href")}catch(D){}l.call(this,C,B);i()});$(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(A.words.length>0&&m.length>0&&(p=="all"||p=="bottom")){w.append("<h4>"+m+"</h4>")}var z=[];$.each(A.words,function(C,F){if((p=="all"||p=="bottom")){if(F.overlayImage!=undefined){w.append('<img class="unibox-vis" src="'+F.overlayImage+'" style="background-image: url(\''+F.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{w.append('<img class="unibox-vis" src="'+F.image+'">')}}var E=$("#unibox-invisible");E.html(y.replace(new RegExp(F.name,"gi"),"<span>"+F.name+"</span>"));if((p=="all"||p=="top")&&jQuery.inArray(F.image,q)==-1){var D=$("#unibox-invisible span")[0];if(D!=undefined&&F.name.length>0){var B=$(D).position().left;visImage=$('<div class="unibox-ivf"><img src="'+F.image+'" alt="'+F.name+'"></div>');visImage.css("left",u()+B-10);visImage.css("top",j.offset().top-80);$("body").append(visImage);setTimeout(function(){$(".unibox-ivf").find("img").addClass("l")},10);z.push(F.image)}}else{if(jQuery.inArray(F.image,q)>-1){z.push(F.image)}}});q=z;$("img").error(function(){$(this).hide()});w.css("left",u());w.css("top",j.offset().top+j.outerHeight());w.slideDown(v,function(){w.css("left",u());w.css("top",j.offset().top+j.outerHeight())})}function u(){return j.offset().left-$("body").offset().left}function b(){var z=$(".unibox-ivf img").map(function(){return $(this).attr("src")}).get();for(var y=0;y<z.length;y++){if(jQuery.inArray(z[y],q)==-1){$('.unibox-ivf:has(img[src*="'+z[y]+'"])').remove()}}}function a(){q=[];$(".unibox-ivf").remove()}function k(A){if(j.val().length<=1){a()}if(A.keyCode!=38&&A.keyCode!=40&&A.keyCode!=13){b();return}if(A.keyCode==38&&e>0){e--}else{if(A.keyCode==40){e++}}if(f.length>0&&e>-1){e=e%f.length;f.removeClass("active");var z=$(f[e]);z.addClass("active")}if(A.keyCode==13){if(l!=undefined){var C=j.val();var y=undefined;if(e!=-1){C=$($(".unibox-selectable.active span")[0]).text();j.val(C);try{y=$($(".unibox-selectable.active")[0]).find("a").attr("href")}catch(B){}}l.call(this,C,y)}else{if(e!=-1){window.location.href=$($(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function r(y){d=y.keyCode;if(y.keyCode==38||y.keyCode==40||y.keyCode==13){return}var z=j.val();if(d==46&&z.length==0){a()}if(z.length>=o){$.ajax(s+encodeURIComponent(z),{dataType:"json",success:function(A){x(A)}})}}return{updateSuggestUrl:function(y){s=y},init:function(A,y){j=A;g=y.highlight;c=y.extraHtml;s=y.suggestUrl;n=y.throttleTime;v=y.animationSpeed;o=y.minChars;l=y.enterCallback;p=y.instantVisualFeedback;m=y.queryVisualizationHeadline;j.attr("autocomplete","off");w=$('<div id="unibox-suggest-box"></div>');$("body").append(w);w.css("min-width",j.outerWidth());w.css("max-width",y.maxWidth);j.keydown(k);j.keydown(h(r,n));j.keydown(i);j.keyup(i);$("html").click(function(){w.slideUp(v)});w.click(function(B){B.stopPropagation()});var z=$('<div id="unibox-invisible">text whatever <span>this one</span></div>');j.parent().append(z)}}}();