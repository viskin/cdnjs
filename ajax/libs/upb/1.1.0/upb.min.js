function pad(c,a,b){b=b||"0";c=c+"";return c.length>=a?c:new Array(a-c.length+1).join(b)+c}var validCommands=["20","activate","21","deactivate","22","goto","23","fadeStart","24","fadeStop","25","blink","26","indicate","27","toggle","30","reportState","31","storeState","80","ackResponse","85","setupTimeReport","86","deviceStateReport","87","deviceStatusReport","8F","deviceSignatureReport","90","registerValuesReport","91","RAMvaluesReport","92","rawDataReport","93","heartbeatReport"];exports.validCommands=validCommands;var defaultCommand={source:255,sendx:1,sendTime:1,ackPulse:false,idPulse:false,ackMsg:false,powerlineRepeater:0,sendTime:1};exports.defaultCommand=defaultCommand;function generateChecksum(b){var a=parseInt(b.hex.ctrlWord.fullByte1.slice(0,2),16);a+=parseInt(b.hex.ctrlWord.fullByte2.slice(0,2),16);a+=parseInt(b.hex.network.slice(0,2),16);a+=parseInt(b.hex.id.slice(0,2),16);a+=parseInt(b.hex.source.slice(0,2),16);a+=parseInt(b.hex.msg.slice(0,2),16);if(b.hex.level){a+=parseInt(b.hex.level.slice(0,2),16)}if(b.hex.rate){a+=parseInt(b.hex.rate.slice(0,2),16)}if(b.hex.blinkRate){a+=parseInt(b.hex.blinkRate.slice(0,2),16)}if(b.hex.toggleCount){a+=parseInt(b.hex.toggleCount.slice(0,2),16)}if(b.hex.toggleRate){a+=parseInt(b.hex.toggleRate.slice(0,2),16)}if(b.hex.channel){a+=parseInt(b.hex.channel.slice(0,2),16)}a=parseInt((~a+1>>>0)).toString(16);a=a.substr(a.length-2);return a}exports.generateChecksum=generateChecksum;function generate(b,a){if(!b.network){a(null,new Error("No network id specified!"))}if(!b.id){a(null,new Error("No link or device id specified!"))}if(!b.type){a(null,new Error("No id type specified!"))}if(!b.cmd){a(null,new Error("No command specified!"))}if(!validCommands.contains(String(b.cmd))||b.cmd=="1"){a(null,new Error("Invalid command specified! Please us the correct command name or number."))}if(b.powerlineRepeater&&!(b.powerlineRepeater==1||b.powerlineRepeater==2||b.powerlineRepeater==4||b.powerlineRepeater=="false")){a(null,new Error("Power line repeater argument only accepts 1, 2, 4, or false!"))}if(b.level>100||b.level<0){a(null,new Error("Level can only be values 0 through 100! Inequality: -1 < L < 101 where variable 'L' is level."))}if(b.sendTime&&b.sendTime>b.sendx){a(null,new Error("Number of time sent (sendTime) cannot be greater than total number of times sent (sendx)!"))}b.ctrlWord={};b.ctrlWord.byte1=0;b.ctrlWord.byte2=0;b.words=7;b.ctrlWord.byte3=0;b.ctrlWord.byte4=0;b.hex={};b.hex.network=parseInt(b.network).toString(16);b.hex.id=parseInt(b.id).toString(16);b.hex.source=parseInt(b.source).toString(16);if(b.cmd==20||b.cmd=="activate"){b.cmd="activate";b.msg=20}else{if(b.cmd==21||b.cmd=="deactivate"){b.msg=21;b.cmd="deactivate"}else{if(b.cmd==22||b.cmd=="goto"){b.msg=22;b.cmd="goto"}else{if(b.cmd==23||b.cmd=="fadeStart"){b.msg=23;b.cmd="fadeStart"}else{if(b.cmd==24||b.cmd=="fadeStop"){b.msg=24;b.cmd="fadeStop"}else{if(b.cmd==25||b.cmd=="blink"){b.msg=25;b.cmd="blink"}else{if(b.cmd==26||b.cmd=="indicate"){b.msg=26;b.cmd="indicate"}else{if(b.cmd==27||b.cmd=="toggle"){b.msg=27;b.cmd="toggle"}else{if(b.cmd==30||b.cmd=="reportState"){b.msg=30;b.cmd="reportState"}else{if(b.cmd==31||b.cmd=="storeState"){b.msg=31;b.cmd="storeState"}else{if(b.cmd==80||b.cmd=="ackResponse"){b.msg=80;b.cmd="ackResponse"}else{if(b.cmd==85||b.cmd=="setupTimeReport"){b.msg=85;b.cmd="setupTimeReport"}else{if(b.cmd==86||b.cmd=="deviceStateReport"){b.msg=86;b.cmd="deviceStateReport"}else{if(b.cmd==87||b.cmd=="deviceStatusReport"){b.msg=87;b.cmd="deviceStatusReport"}else{if(b.cmd=="8F"||b.cmd=="deviceSignatureReport"){b.msg=="8F";b.cmd="deviceSignatureReport"}else{if(b.cmd==90||b.cmd=="registerValuesReport"){b.msg=90;b.cmd="registerValuesReport"}else{if(b.cmd==91||b.cmd=="RAMvaluesReport"){b.msg=91;b.cmd="RAMvaluesReport"}else{if(b.cmd==92||b.cmd=="rawDataReport"){b.msg=92;b.cmd="rawDataReport"}else{if(b.cmd==93||b.cmd=="heartbeatReport"){b.msg=93;b.cmd="heartbeatReport"}}}}}}}}}}}}}}}}}}}b.hex.msg=parseInt(b.msg,16).toString(16);if((b.cmd=="goto"||b.cmd=="fadeStart"||b.cmd=="deviceStateReport")&&!b.level){a(null,new Error("No level specified! A level must be specified with goto, fadeStart, and deviceStateReport."))}if(b.cmd=="blink"&&!b.blinkRate){a(null,new Error("No blink rate specified!"))}if(b.cmd=="toggle"&&!b.toggleCount){a(null,new Error("No toggle count specified!"))}if(b.level&&(b.cmd=="goto"||b.cmd=="fadeStart"||b.cmd=="fadeStop"||b.cmd=="toggle"||b.cmd=="indicate")){b.words++;b.hex.level=parseInt(b.level).toString(16)}if(b.rate&&b.level&&(b.cmd=="goto"||b.cmd=="fadeStart"||b.cmd=="indicate")){b.words++;b.hex.rate=parseInt(b.rate).toString(16)}if(b.cmd=="blink"){b.words++;b.hex.blinkRate=parseInt(b.blinkRate).toString(16)}if(b.cmd=="toggle"){b.words++;b.hex.toggleCount=parseInt(b.toggleCount).toString(16)}if(b.toggleRate&&b.cmd=="toggle"){b.words++;b.hex.toggleRate=parseInt(b.toggleRate).toString(16)}if(b.channel&&b.type=="device"&&b.rate&&(b.cmd=="goto"||b.cmd=="fadeStart"||b.cmd=="blink"||b.cmd=="toggle"||b.cmd=="indicate")){b.words++;b.hex.channel=parseInt(b.channel).toString(16)}if(b.type=="link"){b.ctrlWord.byte1+=8}if(b.powerlineRepeater==1){b.ctrlWord.byte1+=2}else{if(b.powerlineRepeater==2){b.ctrlWord.byte1+=4}else{if(b.powerlineRepeater==4){b.ctrlWord.byte1+=6}}}b.ctrlWord.byte2=b.words;if(b.ackPulse==true){b.ctrlWord.byte3+=1}if(b.idPulse==true){b.ctrlWord.byte3+=2}if(b.ackMsg==true){b.ctrlWord.byte3+=4}if(b.sendx==2){b.ctrlWord.byte4+=4}else{if(b.sendx==3){b.ctrlWord.byte4+=8}else{if(b.sendx==4){b.ctrlWord.byte4+=12}}}if(b.sendTime==2){b.ctrlWord.byte4+=1}else{if(b.sendTime==3){b.ctrlWord.byte4+=2}else{if(b.sendTime==4){b.ctrlWord.byte4+=3}}}b.hex.ctrlWord={};b.hex.ctrlWord.byte1=parseInt(b.ctrlWord.byte1).toString(16);b.hex.ctrlWord.byte2=parseInt(b.words).toString(16);b.hex.ctrlWord.byte3=parseInt(b.ctrlWord.byte3).toString(16);b.hex.ctrlWord.byte4=parseInt(b.ctrlWord.byte4).toString(16);b.hex.ctrlWord.fullByte1=b.hex.ctrlWord.byte1+b.hex.ctrlWord.byte2;b.hex.ctrlWord.fullByte2=b.hex.ctrlWord.byte3+b.hex.ctrlWord.byte4;b.generated=b.hex.ctrlWord.fullByte1;b.generated+=b.hex.ctrlWord.fullByte2;b.generated+=pad(b.hex.network,2,0);b.generated+=pad(b.hex.id,2,0);b.generated+=pad(b.hex.source,2,0);b.generated+=pad(b.msg,2,0);if(b.hex.level){b.generated+=pad(b.hex.level,2,0)}if(b.hex.rate){b.generated+=pad(b.hex.rate,2,0)}if(b.hex.blinkRate){b.generated+=pad(b.hex.blinkRate,2,0)}if(b.hex.toggleCount){b.generated+=pad(b.hex.toggleCount,2,0)}if(b.hex.toggleRate){b.generated+=pad(b.hex.toggleRate,2,0)}if(b.hex.channel){b.generated+=pad(b.hex.channel,2,0)}b.checksum=generateChecksum(b);b.generated+=pad(b.checksum,2,0);b.generated=b.generated.toUpperCase();a(b,null)}exports.generate=generate;function decode(b,a){command=defaultCommand;command.hex={};command.generated=b.toUpperCase();command.hex.ctrlWord={};command.hex.ctrlWord.fullByte1=command.generated.substring(0,2).toString(16);command.hex.ctrlWord.fullByte2=command.generated.substring(2,4).toString(16);command.hex.ctrlWord.byte1=command.generated.substring(0,1).toString(16);command.hex.ctrlWord.byte2=command.generated.substring(1,2).toString(16);command.hex.ctrlWord.byte3=command.generated.substring(2,3).toString(16);command.hex.ctrlWord.byte4=command.generated.substring(3,4).toString(16);command.ctrlWord={};command.ctrlWord.byte1=parseInt(command.hex.ctrlWord.byte1,16);command.ctrlWord.byte2=parseInt(command.hex.ctrlWord.byte2,16);command.ctrlWord.byte3=parseInt(command.hex.ctrlWord.byte3,16);command.ctrlWord.byte4=parseInt(command.hex.ctrlWord.byte4,16);if(command.ctrlWord.byte1>=8){command.type="link";command.powerlineRepeater=command.ctrlWord.byte1-8}else{command.type="device";command.powerlineRepeater=command.ctrlWord.byte1}if(command.powerlineRepeater==0){command.powerlineRepeater=0}else{if(command.powerlineRepeater==2){command.powerlineRepeater=1}else{if(command.powerlineRepeater==4){command.powerlineRepeater=2}else{if(command.powerlineRepeater==6){command.powerlineRepeater=4}else{a(null,new Error("Invalid command! Powerline repeater argument can only be 1, 2, or 4 which translates into 2, 4, or 6."))}}}}command.words=command.ctrlWord.byte2;if(command.generated.length/2!=command.words){a(null,new Error("Invalid command! Word count doesn't add up.'"))}if(command.ctrlWord.byte3==1){command.ackPulse=true}if(command.ctrlWord.byte3==2){command.idPulse=true}if(command.ctrlWord.byte3==3){command.ackPulse=true;command.idPulse=true}if(command.ctrlWord.byte3==4){command.ackMsg=true}if(command.ctrlWord.byte3==5){command.ackPulse=true;command.ackMsg=true}if(command.ctrlWord.byte3==6){command.idPulse=true;command.ackMsg=true}if(command.ctrlWord.byte3==7){command.ackPulse=true;command.idPulse=true;command.ackMsg=true}if(command.ctrlWord.byte3>7){a(null,new Error("Invalid command! Any number greater than seven cannot be an Acknowledge Pulse, ID Pulse, or Acknowledge Message."))}if(command.ctrlWord.byte4==0){command.sendx=1;command.sendTime=1}else{if(command.ctrlWord.byte4==4){command.sendx=2;command.sendTime=1}else{if(command.ctrlWord.byte4==5){command.sendx=2;command.sendTime=2}else{if(command.ctrlWord.byte4==8){command.sendx=3;command.sendTime=1}else{if(command.ctrlWord.byte4==9){command.sendx=3;command.sendTime=2}else{if(command.ctrlWord.byte4==10){command.sendx=3;command.sendTime=3}else{if(command.ctrlWord.byte4==12){command.sendx=4;command.sendTime=1}else{if(command.ctrlWord.byte4==12){command.sendx=4;command.sendTime=2}else{if(command.ctrlWord.byte4==13){command.sendx=4;command.sendTime=3}else{if(command.ctrlWord.byte4==14){command.sendx=4;command.sendTime=4}else{a(null,new Error("Invalid command! Send time is greater than total sent times."))}}}}}}}}}}command.hex.network=command.generated.substring(4,6).toString(16);command.network=parseInt(command.hex.network,16);command.hex.id=command.generated.substring(6,8).toString(16);command.id=parseInt(command.hex.id,16);command.hex.source=command.generated.substring(8,10).toString(16);command.source=parseInt(command.hex.source,16);command.msg=command.generated.substring(10,12).toString(16);if(command.msg==20){command.cmd="activate"}else{if(command.msg==21){command.cmd="deactivate"}else{if(command.msg==22){command.cmd="goto"}else{if(command.msg==23){command.cmd="fadeStart"}else{if(command.msg==24){command.cmd="fadeStop"}else{if(command.msg==25){command.cmd="blink"}else{if(command.msg==26){command.cmd="indicate"}else{if(command.msg==27){command.cmd="toggle"}else{if(command.msg==30){command.cmd="reportState"}else{if(command.msg==31){command.cmd="storeState"}else{if(command.msg==80){command.cmd="ackResponse"}else{if(command.msg==85){command.cmd="setupTimeReport"}else{if(command.msg==86){command.cmd="deviceStateReport"}else{if(command.msg==87){command.cmd="deviceStatusReport"}else{if(command.msg=="8F"){command.cmd="deviceSignatureReport"}else{if(command.msg==90){command.cmd="registerValuesReport"}else{if(command.msg==91){command.cmd="RAMvaluesReport"}else{if(command.msg==92){command.cmd="rawDataReport"}else{if(command.msg==93){command.cmd="heartbeatReport"}else{calbackFinal(null,"An unknown command was specified!")}}}}}}}}}}}}}}}}}}}command.hex.msg=parseInt(command.msg,16).toString(16);command.checksum=command.generated.slice(-2).toString(16);if(command.words>7&&command.checksum!=String(command.generated.substring(12,14))&&(command.cmd=="goto"||command.cmd=="fadeStart"||command.cmd=="fadeStop"||command.cmd=="toggle"||command.cmd=="deviceStateReport"||command.cmd=="indicate")){command.hex.level=command.generated.substring(12,14).toString(16);command.level=parseInt(command.hex.level,16)}if(command.words>8&&command.checksum!=String(command.generated.substring(12,14))&&command.level&&(command.cmd=="goto"||command.cmd=="fadeStart"||command.cmd=="indicate")){command.hex.rate=command.generated.substring(14,16).toString(16);command.rate=parseInt(command.hex.rate,16)}if(command.words>7&&command.cmd=="blink"){command.hex.blinkRate=command.generated.substring(12,14).toString(16);command.blinkRate=parseInt(command.hex.blinkRate,16)}if(command.words>7&&command.cmd=="toggle"){command.hex.toggleCount=command.generated.substring(12,14).toString(16);command.toggleCount=parseInt(command.hex.toggleCount,16)}if(command.toggleRate&&command.cmd=="toggle"){command.hex.toggleRate=command.generated.substring(14,16).toString(16);command.toggleRate=parseInt(command.hex.toggleRate,16)}if(command.words>9&&command.checksum!=String(command.generated.substring(12,14))&&command.rate&&command.type=="device"&&(command.cmd=="goto"||command.cmd=="fadeStart"||command.cmd=="toggle"||command.cmd=="indicate")){command.words++;command.hex.channel=command.generated.substring(16,18).toString(16);command.channel=parseInt(command.hex.channel,16)}if(command.words>8&&command.checksum!=String(command.generated.substring(14,16))&&command.blinkRate&&command.type=="device"&&command.cmd=="blink"){command.hex.channel=command.generated.substring(16,18).toString(16);command.channel=parseInt(command.hex.channel,16)}if((command.cmd=="goto"||command.cmd=="fadeStart")&&!command.level){a(null,new Error("Invalid command! No level specified. A level must be specified with goto and fadeStart."))}if(command.cmd=="blink"&&!command.blinkRate){a(null,new Error("No blink rate specified. Blink rate must be specified with the blink command."))}if(command.cmd=="toggle"&&!command.toggleCount){a(null,new Error("Invalid command! No toggle count specified. Toggle count must be specified with the toggle command."))}a(command,null)}exports.decode=decode;