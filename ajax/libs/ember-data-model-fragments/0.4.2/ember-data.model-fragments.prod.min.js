/*!
 * @overview  Ember Data Model Fragments
 * @copyright Copyright 2015 Lytics Inc. and contributors
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/lytics/ember-data.model-fragments/master/LICENSE
 * @version   0.4.2
 */
(function(){var C=Ember;var aK=DS;var aL=DS.JSONAPISerializer;var f=DS.JSONSerializer;var aw=DS.InternalModel;var aA=DS.RootState;var aa=DS.Model;var J=DS.Snapshot;var ag=DS.Store;var al=DS.Transform;var av=C.get;var t=Object.create||C.create;var ao=aA.loaded.saved.didSetProperty;var Z=aA.loaded.updated.uncommitted.propertyWasReset;var ak=function(aR){var e=aR._owner;var aS=aR._name;if(e){aC(e,aS,aR)}};var i={isEmpty:false,isLoading:false,isLoaded:false,isDirty:false,isSaving:false,isDeleted:false,isNew:false,isValid:true,didSetProperty:ao,propertyWasReset:C.K,becomeDirty:C.K,rolledBack:C.K,empty:{isEmpty:true,loadedData:function(e){e.transitionTo("loaded.created")},pushedData:function(e){e.transitionTo("loaded.saved")}},loaded:{pushedData:function(e){e.transitionTo("saved")},saved:{setup:function(aR){var e=aR._owner;var aS=aR._name;if(!e._internalModel._fragments[aS]){return}if(!av(e,aS+".hasDirtyAttributes")){ac(e,aS,aR)}},pushedData:C.K,didCommit:C.K,becomeDirty:function(e){e.transitionTo("updated")}},created:{isDirty:true,setup:ak,didCommit:function(e){e.transitionTo("saved")}},updated:{isDirty:true,setup:ak,propertyWasReset:Z,didCommit:function(e){e.transitionTo("saved")},rolledBack:function(e){e.transitionTo("saved")}}}};function H(e,aR){for(var aS in aR){e[aS]=aR[aS]}return e}function F(aR,aS,e){aR=H(aS?t(aS):{},aR);aR.parentState=aS;aR.stateName=e;for(var aT in aR){if(!aR.hasOwnProperty(aT)||aT==="parentState"||aT==="stateName"){continue}if(typeof aR[aT]==="object"){aR[aT]=F(aR[aT],aR,e+"."+aT)}}return aR}i=F(i,null,"root");var aj=i;function aC(e,aS,aR){if(!av(e,"isDeleted")){e._internalModel._attributes[aS]=aR;e.send("becomeDirty")}}function ac(e,aR){delete e._internalModel._attributes[aR];if(!av(e,"isNew")){e.send("propertyWasReset",aR)}}var v=C.get;var aB=C.set;var aP=C.computed;var s=C.copy;var z=C.makeArray;var aG=C.ArrayProxy.extend(C.Copyable,{owner:null,name:null,init:function(){this._super();this._pendingData=undefined;aB(this,"_originalState",[])},content:aP(function(){return C.A()}),copy:function(){return this.map(s)},setupData:function(aS){if(this._pendingData===aS){return}this._pendingData=aS;var e=this._normalizeData(z(aS));var aR=v(this,"content");aB(this,"_originalState",e);aR.replace(0,v(aR,"length"),e);this._pendingData=undefined},_normalizeData:function(e){return e},_createSnapshot:function(){return this.toArray()},_flushChangedAttributes:function(){},_adapterDidCommit:function(e){if(e){this.setupData(e)}else{aB(this,"_originalState",this.toArray())}},isDirty:aP("hasDirtyAttributes",function(){return this.get("hasDirtyAttributes")}),hasDirtyAttributes:aP("[]","_originalState",function(){return C.compare(this.toArray(),v(this,"_originalState"))!==0}),rollback:function(){this.rollbackAttributes()},rollbackAttributes:function(){this.setObjects(v(this,"_originalState"))},serialize:function(){return this.toArray()},arrayContentDidChange:function(){this._super.apply(this,arguments);var e=v(this,"owner");var aR=v(this,"name");if(v(this,"hasDirtyAttributes")){aC(e,aR,this)}else{ac(e,aR)}},toStringExtension:function(){return"owner("+v(this,"owner.id")+")"}});var aF=aG;var aQ=Object.keys||Ember.keys;ag.reopen({createFragment:function(e,aU){var aT=this.modelFor(e);Ember.assert("The '"+aT+"' model must be a subclass of DS.ModelFragment",B.detect(aT));var aR=new aw(aT,null,this,this.container);aR.currentState=aj.empty;aR._name=null;aR._owner=null;aR.loadedData();var aS=aR.getRecord();if(aU){aS.setProperties(aU)}aS._isFragment=true;return aS}});aa.reopen({changedAttributes:function(){var aR=this._super();var e=aD(this);aQ(e._fragments).forEach(function(aS){if(aS in e._attributes){aR[aS]=true}},this);return aR}});function aE(aT,e,aR){var aS=aT[e];aT[e]=function(){var aU=aS.apply(this,arguments);return aR.call(this,aU,arguments)}}var O=aw.prototype;aE(O,"createSnapshot",function an(e){var aR=e._attributes;aQ(aR).forEach(function(aT){var aS=aR[aT];if(aS&&typeof aS._createSnapshot==="function"){aR[aT]=aS._createSnapshot()}});return e});aE(O,"rollbackAttributes",function r(){for(var e in this._fragments){if(this._fragments[e]){this._fragments[e].rollbackAttributes()}}});aE(O,"flushChangedAttributes",function aq(){var e;for(var aR in this._fragments){if(e=this._fragments[aR]){e._flushChangedAttributes()}}});aE(O,"adapterDidCommit",function au(aU,aS){var e=(aS[0]&&aS[0].attributes)||{};var aR;for(var aT in this._fragments){if(aR=this._fragments[aT]){aR._adapterDidCommit(e[aT])}}});f.reopen({transformFor:function(e){if(e.indexOf("-mf-")===0){return m(this.container,this.store,e)}return this._super.apply(this,arguments)}});function m(aT,aZ,aU){var aR=aT._registry||aT.registry||aT;var aX="transform:"+aU;var aW=aU.match(/^-mf-(fragment|fragment-array|array)(?:\$([^$]+))?(?:\$(.+))?$/);var aV=aW[1];var aY=aW[2];var e=aW[3];if(!aR.has(aX)){var aS=aT.lookupFactory("transform:"+aV);aR.register(aX,aS.extend({store:aZ,modelName:aY,polymorphicTypeProp:e}))}return aT.lookup(aX)}var am=C.get;var aO=Object.create||C.create;var y=C.copy;var ap=aa.extend(C.Comparable,C.Copyable,{compare:function(e,aR){return e===aR?0:1},copy:function(){var aR=this.constructor;var e={};aR.eachAttribute(function(aS){e[aS]=y(am(this,aS))},this);return this.store.createFragment(aR.modelName,e)},_flushChangedAttributes:function(){aD(this).flushChangedAttributes()},_adapterDidCommit:function(e){aD(this).adapterDidCommit({attributes:e||{}})},toStringExtension:function(){return"owner("+am(aD(this)._owner,"id")+")"}}).reopenClass({fragmentOwnerProperties:C.computed(function(){var e=[];this.eachComputedProperty(function(aR,aS){if(aS.isFragmentOwner){e.push(aR)}});return e}).readOnly()});function ar(aR,e,aU){if(!e.polymorphic||!aU){return aR}var aT=e.typeKey||"type";var aS=aU[aT];return aS||aR}function aD(e){var aR=e._internalModel;if(!aR._fragments){aR._fragments=aO(null)}return aR}function aM(aS,e,aT){var aR=aD(aS);aR._owner=e;aR._name=aT;am(aS.constructor,"fragmentOwnerProperties").forEach(function(aU){aS.notifyPropertyChange(aU)});return aS}var B=ap;function az(e,aR){if(aR instanceof e){return true}else{if(Ember.MODEL_FACTORY_INJECTIONS){return aR instanceof e.superclass}}return false}var b=az;function R(aR,aS,e){return aR.map?aR.map(aS,e):d.call(aR,aS,e)}var ae=R;function d(aR){if(this===void 0||this===null||typeof aR!=="function"){throw new TypeError()}var aV=Object(this);var e=aV.length>>>0;var aU=new Array(e);var aT=arguments[1];for(var aS=0;aS<e;aS++){if(aS in aV){aU[aS]=aR.call(aT,aV[aS],aS,aV)}}return aU}var D=C.get;var A=C.computed;var N=C.typeOf;function o(aU,aV,aR){var aS=D(aU,"owner");var aW=D(aS,"store");var e=D(aU,"type");var aY=D(aU,"options");var aX=D(aU,"name");var aT;return ae(aR,function(a2,a0){if(a2._isFragment){aT=a2;var aZ=aD(aT)._owner;if(!aZ){aM(aT,aS,aX)}}else{aT=aV[a0];if(!aT){var a1=ar(e,aY,a2);aT=aW.createFragment(a1);aM(aT,aS,aX)}aD(aT).setupData({attributes:a2})}return aT})}var ad=aF.extend({type:null,options:null,_normalizeData:function(aR){var e=D(this,"content");return o(this,e,aR)},_createSnapshot:function(){return this.map(function(e){return e._createSnapshot()})},_flushChangedAttributes:function(){this.map(function(e){e._flushChangedAttributes()})},_adapterDidCommit:function(e){this._super(e);this.forEach(function(aS,aR){aS._adapterDidCommit(e&&e[aR])})},hasDirtyAttributes:A("@each.hasDirtyAttributes","_originalState",function(){return this._super()||this.isAny("hasDirtyAttributes")}),rollbackAttributes:function(){this._super();this.invoke("rollbackAttributes")},serialize:function(){return this.invoke("serialize")},replaceContent:function(aR,aS,aV){var aT=D(this,"content");var aU=aT.slice(aR,aR+aS);var e=o(this,aU,aV);if(e.length<aU.length){aU.slice(e.length).forEach(function(aW){aM(aW,null,null)})}return aT.replace(aR,aS,e)},addFragment:function(e){return this.addObject(e)},removeFragment:function(e){return this.removeObject(e)},createFragment:function(aU){var e=D(this,"owner");var aR=D(e,"store");var aT=D(this,"type");var aS=aR.createFragment(aT,aU);return this.pushObject(aS)}});var aN=ad;var af=window.Ember;var l=af.computed;var k;try{af.computed({set:function(){},get:function(){}});k=true}catch(Y){k=false}var n=function(){var aU=[];var aR=arguments[arguments.length-1];if(typeof aR==="function"||k){return l.apply(this,arguments)}for(var aS=0,e=arguments.length-1;aS<e;aS++){aU.push(arguments[aS])}var aT;if(aR.set){aT=function(aV,aW){if(arguments.length>1){return aR.set.call(this,aV,aW)}else{return aR.get.call(this,aV)}}}else{aT=function(aV){return aR.get.call(this,aV)}}aU.push(aT);return l.apply(this,aU)};var p=C.get;var g=C.typeOf;function c(aS,e,aR){var aT="-mf-"+aS;if(e){aT+="$"+e}if(aR&&aR.polymorphic){aT+="$"+(aR.typeKey||"type")}return aT}function V(aT,aS){aS=aS||{};var aU=c("fragment",aT,aS);function aR(aY,aW,a0){var aX=aD(aW);var a1=P(aX,a0,aS,"object");var aZ=aX._fragments[a0];var aV=ar(aT,aS,a1);if(!aZ&&b(aY.modelFor(aV),a1)){aZ=a1}else{if(a1&&a1!==aZ){aZ||(aZ=w(aY,aV,aW,a0));aX._data[a0]=aZ;aD(aZ).setupData({attributes:a1})}else{aZ=a1}}return aZ}function e(aW,a0,aZ,a1){var aY=aW.store;var aX=aD(aW);if(aZ&&aZ!==a1){aM(aZ,null,null)}if(a1){if(g(a1)==="object"){if(!aZ){var aV=ar(aT,aS,a1);aZ=w(aY,aV,aW,a0)}aZ.setProperties(a1)}else{aZ=aM(a1,aW,a0)}}else{aZ=null}if(aX._data[a0]!==aZ){aC(aW,a0,aZ)}else{ac(aW,a0)}return aZ}return j(aU,aS,aR,e)}function L(e,aR){aR||(aR={});if(g(e)!=="string"){return u(aR)}var aT=c("fragment-array",e,aR);return M(aT,aR,function aS(aU,aV){return aN.create({type:e,options:aR,name:aV,owner:aU})})}function u(aR){aR||(aR={});var aS=c("array");return M(aS,aR,function e(aT,aU){return aF.create({options:aR,name:aU,owner:aT})})}function j(aT,aS,aR,e){aS=aS||{};var aU={type:aT,isAttribute:true,isFragment:true,options:aS};return n({get:function(aX){var aV=aD(this);var aW=aR(this.store,this,aX);return aV._fragments[aX]=aW},set:function(aX,aY){var aV=aD(this);var aW=aR(this.store,this,aX);aW=e(this,aX,aW,aY);return aV._fragments[aX]=aW}}).meta(aU)}function M(aU,aT,aR){function aS(aY,aW,aZ){var aX=aD(aW);var a0=P(aX,aZ,aT,"array");var aV=aX._fragments[aZ]||null;if(a0 instanceof aF&&!aV){aV=a0}else{if(a0&&a0!==aV){aV||(aV=aR(aW,aZ));aX._data[aZ]=aV;aV.setupData(a0)}else{aV=a0}}return aV}function e(aW,aY,aV,aZ){var aX=aD(aW);if(C.isArray(aZ)){aV||(aV=aR(aW,aY));aV.setObjects(aZ)}else{if(aZ===null){aV=null}else{}}if(aX._data[aY]!==aV||p(aV,"hasDirtyAttributes")){aC(aW,aY,aV)}else{ac(aW,aY)}return aV}return j(aU,aT,aS,e)}function ai(){return C.computed(function(){return aD(this)._owner}).meta({isFragmentOwner:true}).readOnly()}function Q(e,aR,aS){var aT;C.warn("The default value of fragment array properties will change from `null` to an empty array in v1.0. This warning can be silenced by explicitly setting a default value with the option `{ defaultValue: null }`",aS!=="array"||"defaultValue" in aR);if(typeof aR.defaultValue==="function"){aT=aR.defaultValue()}else{if("defaultValue" in aR){aT=aR.defaultValue}else{return null}}return C.copy(aT,true)}function w(aR,aT,e,aS){return aM(aR.createFragment(aT),e,aS)}function P(e,aS,aR,aT){if(aS in e._data){return e._data[aS]}else{return Q(e,aR,aT)}}var ab=C.makeArray;var X=al.extend({deserialize:function at(e){return e==null?null:ab(e)},serialize:function ax(e){return e&&e.toArray?e.toArray():e}});var U=X;var G=C.get;var T=al.extend({store:null,modelName:null,polymorphicTypeProp:null,deserialize:function aJ(e){if(e==null){return null}return this.deserializeSingle(e)},serialize:function E(aR){if(!aR){return null}var e=this.store;var aS=e.serializerFor(aR.modelName);return aS.serialize(aR)},modelNameFor:function h(aS){var aR=G(this,"modelName");var e=G(this,"polymorphicTypeProp");if(aS&&e&&aS[e]){aR=aS[e]}return aR},deserializeSingle:function aI(aU){var aR=this.store;var e=this.modelNameFor(aU);var aS=aR.serializerFor(e);var aW=G(aS,"isNewSerializerAPI");var aT=aR.modelFor(e);var aV=aS.normalize(aT,aU);if(aW){return G(aV,"data.attributes")}else{return aV}}});var aH=T;var ah=aH.extend({deserialize:function W(e){if(e==null){return null}return ae(e,function(aR){return this.deserializeSingle(aR)},this)},serialize:function q(aR){if(!aR){return null}var e=this.store;return ae(aR,function(aS){var aT=e.serializerFor(aS.modelName);return aT.serialize(aS)})}});var S=ah;var a=[{name:"fragmentTransform",before:"store",initialize:function(e,aR){aR.register("transform:fragment",aH);aR.register("transform:fragment-array",S);aR.register("transform:array",U)}}];var x=a;function I(e){e.ModelFragment=B;e.FragmentArray=aN;e.FragmentTransform=aH;e.FragmentArrayTransform=S;e.ArrayTransform=U;e.hasOneFragment=V;e.hasManyFragments=L;e.fragmentOwner=ai}var ay=C.Namespace.create({VERSION:"0.4.2"});I(ay);I(aK);C.onLoad("Ember.Application",function(e){x.forEach(e.initializer,e)});if(C.libraries){C.libraries.register("Model Fragments",ay.VERSION)}var K=ay}).call(this);