/*!
* js-data-localstorage
* @version 3.0.0-alpha.1 - Homepage <https://github.com/js-data/js-data-localstorage>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-localstorage/blob/master/LICENSE>
*
* @overview localStorage adapter for js-data.
*/
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-data")):"function"==typeof define&&define.amd?define(["js-data"],e):"object"==typeof exports?exports.LocalStorageAdapter=e(require("js-data")):t.LocalStorageAdapter=e(t.JSData)}(this,function(t){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){return null!=t&&""!==t}function a(t,e){return e||(e=""),t.filter(o).join(e)}function i(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];var r=a(e,"/");return r.replace(/([^:\/]|^)\/{2,}/g,"$1/")}function u(t){var e={},n=[];return t.forEach(function(t){t in e||(n.push(t),e[t]=0)}),n}function f(t){K.push(t)}function c(){K.length&&!D&&(D=!0,K[0]())}function l(t){K.length?f(t):(f(t),c())}function s(t){return new Promise(t).then(function(t){return D=!1,K.shift(),setTimeout(c,0),t},function(t){return D=!1,K.shift(),setTimeout(c,0),M(t)})}function d(t){w(this,t||{}),w(this,L)}var h=n(1),p=n(2),g=h.Query,v=h.utils,y=v.addHiddenPropsToTarget,b=v.copy,A=v.deepMixIn,m=v.extend,w=v.fillIn,I=v.forOwn,x=v.fromJson,P=v.get,E=v.isArray,F=v.isUndefined,O=v.resolve,M=v.reject,j=v.set,U=v.toJson,K=[],D=!1,T=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-1];return t.dbg.apply(t,[o.op].concat(n)),O()},C=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-2];return t.dbg.apply(t,[o.op].concat(n)),O()},L={basePath:"",debug:!1,storage:localStorage};d.extend=m,y(d.prototype,{afterCreate:C,afterCreateMany:C,afterDEL:C,afterDestroy:C,afterDestroyAll:C,afterFind:C,afterFindAll:C,afterGET:C,afterPUT:C,afterUpdate:C,afterUpdateAll:C,afterUpdateMany:C,beforeCreate:T,beforeCreateMany:T,beforeDEL:T,beforeDestroy:T,beforeDestroyAll:T,beforeFind:T,beforeFindAll:T,beforeGET:T,beforePUT:T,beforeUpdate:T,beforeUpdateAll:T,beforeUpdateMany:T,create:function(t,e,n){var r=this;return e||(e={}),n||(n={}),s(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreate",O(r[i](t,e,n)).then(function(o){var a=F(o)?e:o,u=P(a,t.idAttribute)||p();j(a,t.idAttribute,u);var f=r.getIdPath(t,n,u);return r.storage.setItem(f,U(a)),r.ensureId(u,t,n),i=n.op="afterCreate",r[i](t,e,n,a).then(function(t){return a=F(t)?a:t,n.raw?{data:a,created:1}:a})}).then(o,a)})})},createMany:function(t,e,n){var r=this;return e||(e={}),n||(n={}),s(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreateMany",O(r[i](t,e,n)).then(function(o){var a=F(o)?e:o,u=t.idAttribute;return a.forEach(function(e){var o=P(e,u)||p();j(e,u,o);var a=r.getIdPath(t,n,o);r.storage.setItem(a,U(e)),r.ensureId(o,t,n)}),i=n.op="afterCreateMany",r[i](t,e,n,a).then(function(t){return a=F(t)?a:t,n.raw?{data:a,created:a.length}:a})}).then(o,a)})})},dbg:function(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];this.log.apply(this,["debug"].concat(e))},destroy:function(t,e,n){var r=this;return n||(n={}),s(function(o,a){l(function(){var i=void 0;return i=n.op="beforeDestroy",O(r[i](t,e,n)).then(function(){return i=n.op="destroy",r.dbg(i,e,n),r.storage.removeItem(r.getIdPath(t,n,e)),r.removeId(e,t,n),i=n.op="afterDestroy",r[i](t,e,n).then(function(t){return e=F(t)?e:t,n.raw?{data:e,deleted:1}:e})}).then(o,a)})})},destroyAll:function(t,e,n){var r=this;return e||(e={}),n||(n={}),s(function(o,a){l(function(){var i=void 0;return i=n.op="beforeDestroyAll",O(r[i](t,e,n)).then(function(){return i=n.op="destroyAll",r.dbg(i,e,n),r.findAll(t,e,n)}).then(function(o){var a=t.idAttribute,u=o.map(function(t){return P(t,a)});return u.forEach(function(e){r.storage.removeItem(r.getIdPath(t,n,e))}),r.removeId(u,t,n),i=n.op="afterDestroyAll",r[i](t,e,n,u).then(function(t){return u=F(t)?u:t,n.raw?{data:u,deleted:o.length}:u})}).then(o,a)})})},ensureId:function(t,e,n){var r=this.getIds(e,n);if(E(t)){if(!t.length)return;t.forEach(function(t){r[t]=1})}else r[t]=1;this.saveKeys(r,e,n)},find:function(t,e,n){var o=this,a=void 0,i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFind",O(o[i](t,e,n)).then(function(){i=n.op="find",o.dbg(i,e,n);var f=o.getIdPath(t,n,e);if(a=o.storage.getItem(f),F(a))return void(a=void 0);a=x(a);var c=[],l=t.relationList||[];return l.forEach(function(e){var i=e.relation,f=e.getRelation(),l=null;if(-1!==n.with.indexOf(i)?l=i:-1!==n.with.indexOf(e.localField)&&(l=e.localField),l){var s=b(n);s.with=n.with.slice(),w(s,f);var d=s.with.indexOf(l);d>=0&&s.with.splice(d,1),s.with.forEach(function(t,e){t&&0===t.indexOf(l)&&t.length>=l.length&&"."===t[l.length]?s.with[e]=t.substr(l.length+1):s.with[e]=""});var h=void 0;if("hasOne"!==e.type&&"hasMany"!==e.type||!e.foreignKey)if("hasMany"===e.type&&e.localKeys){var p=[],g=P(a,e.localKeys)||[];g=Array.isArray(g)?g:Object.keys(g),p=p.concat(g||[]),h=o.findAll(f,{where:r({},f.idAttribute,{in:u(p).filter(function(t){return t})})},s).then(function(t){return j(a,e.localField,t),t})}else"belongsTo"===e.type&&(h=o.find(f,P(a,e.foreignKey),s).then(function(t){return j(a,e.localField,t),t}));else h=o.findAll(f,r({},e.foreignKey,P(a,t.idAttribute)),s).then(function(t){return"hasOne"===e.type&&t.length?j(a,e.localField,t[0]):j(a,e.localField,t),t});h&&c.push(h)}}),Promise.all(c)}).then(function(){return i=n.op="afterFind",O(o[i](t,e,n,a)).then(function(t){return a=F(t)?a:t,n.raw?{data:a,found:a?1:0}:a})})},findAll:function(t,e,n){var o=this,a=[],i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFindAll",O(o[i](t,e,n)).then(function(){i=n.op="findAll",o.dbg(i,e,n);var f=o.getIds(t,n);I(f,function(e,r){var i=o.storage.getItem(o.getIdPath(t,n,r));i&&a.push(x(i))});var c=t.idAttribute,l=new g({index:{getAll:function(){return a}}});a=l.filter(e).run();var s=[],d=t.relationList||[];return d.forEach(function(t){var e=t.relation,i=t.getRelation(),f=null;if(-1!==n.with.indexOf(e)?f=e:-1!==n.with.indexOf(t.localField)&&(f=t.localField),f){var l=b(n);l.with=n.with.slice(),w(l,i);var d=l.with.indexOf(f);d>=0&&l.with.splice(d,1),l.with.forEach(function(t,e){t&&0===t.indexOf(f)&&t.length>=f.length&&"."===t[f.length]?l.with[e]=t.substr(f.length+1):l.with[e]=""});var h=void 0;"hasOne"!==t.type&&"hasMany"!==t.type||!t.foreignKey?"hasMany"===t.type&&t.localKeys?!function(){var e=[];a.forEach(function(n){var r=P(n,t.localKeys)||[];r=Array.isArray(r)?r:Object.keys(r),e=e.concat(r||[])}),h=o.findAll(i,{where:r({},i.idAttribute,{in:u(e).filter(function(t){return t})})},l).then(function(e){return a.forEach(function(n){var r=[],o=P(n,t.localKeys)||[];o=Array.isArray(o)?o:Object.keys(o),e.forEach(function(t){o&&-1!==o.indexOf(t[i.idAttribute])&&r.push(t)}),j(n,t.localField,r)}),e})}():"belongsTo"===t.type&&(h=o.findAll(i,{where:r({},i.idAttribute,{in:a.map(function(e){return P(e,t.foreignKey)}).filter(function(t){return t})})},l).then(function(e){return a.forEach(function(n){e.forEach(function(e){e[i.idAttribute]===P(n,t.foreignKey)&&j(n,t.localField,e)})}),e})):h=o.findAll(i,{where:r({},t.foreignKey,{in:a.map(function(t){return P(t,c)}).filter(function(t){return t})})},l).then(function(e){return a.forEach(function(n){var r=[];e.forEach(function(e){P(e,t.foreignKey)===P(n,c)&&r.push(e)}),"hasOne"===t.type&&r.length?j(n,t.localField,r[0]):j(n,t.localField,r)}),e}),h&&s.push(h)}}),Promise.all(s)}).then(function(){return i=n.op="afterFindAll",O(o[i](t,e,n,a)).then(function(t){return a=F(t)?a:t,n.raw?{data:a,found:a.length}:a})})},getPath:function(t,e){return e=e||{},i(void 0===e.basePath?void 0===t.basePath?this.basePath:t.basePath:e.basePath,t.name)},getIdPath:function(t,e,n){return e=e||{},i(e.basePath||this.basePath||t.basePath,t.endpoint,n)},getIds:function(t,e){var n=void 0,r=this.getPath(t,e),o=this.storage.getItem(r);return n=o?x(o):{}},log:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];if(t&&!n.length&&(n.push(t),t="debug"),"debug"!==t||this.debug){var o=t.toUpperCase()+": (LocalStorageAdapter)";if(console[t]){var a;(a=console)[t].apply(a,[o].concat(n))}else{var i;(i=console).log.apply(i,[o].concat(n))}}},removeId:function(t,e,n){var r=this.getIds(e,n);if(E(t)){if(!t.length)return;t.forEach(function(t){delete r[t]})}else delete r[t];this.saveKeys(r,e,n)},saveKeys:function(t,e,n){t=t||{};var r=this.getPath(e,n);Object.keys(t).length?this.storage.setItem(r,U(t)):this.storage.removeItem(r)},update:function(t,e,n,r){var o=this;return n||(n={}),r||(r={}),s(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdate",O(o[u](t,e,n,r)).then(function(a){n=F(a)?n:a;var i=o.getIdPath(t,r,e),f=o.storage.getItem(i);f=f?x(f):void 0;var c=0;return f&&(A(f,n),o.storage.setItem(i,U(f)),c++),u=r.op="afterUpdate",o[u](t,e,n,r,f).then(function(t){return f=F(t)?f:t,r.raw?{data:f,updated:c}:f})}).then(a,i)})})},updateAll:function(t,e,n,r){var o=this;return e||(e={}),n||(n={}),r||(r={}),s(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdateAll",O(o[u](t,e,n,r)).then(function(a){return e=F(a)?e:a,u=r.op="updateAll",o.dbg(u,n,r),o.findAll(t,n,r)}).then(function(a){var i=t.idAttribute,f=0;return a.forEach(function(n){n||(n={});var a=P(n,i),u=o.getIdPath(t,r,a);A(n,e),o.storage.setItem(u,U(n)),f++}),u=r.op="afterUpdateAll",o[u](t,e,n,r,a).then(function(t){return a=F(t)?a:t,r.raw?{data:a,updated:f}:a})}).then(a,i)})})},updateMany:function(t,e,n){var r=this;return e||(e=[]),n||(n={}),s(function(o,a){l(function(){var i=void 0,u=[];return i=n.op="beforeUpdateMany",O(r[i](t,e,n)).then(function(o){e=F(o)?e:o,i=n.op="updateMany",r.dbg(i,e,n);var a=t.idAttribute;return e.forEach(function(e){if(e){var o=P(e,a);if(!F(o)){var i=r.getIdPath(t,n,o),f=r.storage.getItem(i),c=f?x(f):void 0;c&&(A(c,e),r.storage.setItem(i,U(c)),u.push(c))}}}),i=n.op="afterUpdateMany",r[i](t,e,n,u).then(function(t){return e=F(t)?u:t,n.raw?{data:e,updated:u.length}:e})}).then(o,a)})})}}),d.version={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"},t.exports=d},function(e,n){e.exports=t},function(t,e,n){function r(){return o(8)+"-"+o(4)+"-4"+o(3)+"-"+a(8,9,"a","b")+o(3)+"-"+o(12)}var o=n(3),a=n(4);t.exports=r},function(t,e,n){function r(t){t=t&&t>0?t:6;for(var e="";t--;)e+=o(a);return e}var o=n(4),a="0123456789abcdef".split("");t.exports=r},function(t,e,n){function r(t){var e=1===arguments.length&&a(t)?t:arguments;return e[o(0,e.length-1)]}var o=n(5),a=n(10);t.exports=r},function(t,e,n){function r(t,e){return t=null==t?o:~~t,e=null==e?a:~~e,Math.round(i(t-.5,e+.499999999999))}var o=n(6),a=n(7),i=n(8);t.exports=r},function(t,e){t.exports=-2147483648},function(t,e){t.exports=2147483647},function(t,e,n){function r(t,e){return t=null==t?a:t,e=null==e?i:e,t+(e-t)*o()}var o=n(9),a=n(6),i=n(7);t.exports=r},function(t,e){function n(){return n.get()}n.get=Math.random,t.exports=n},function(t,e,n){var r=n(11),o=Array.isArray||function(t){return r(t,"Array")};t.exports=o},function(t,e,n){function r(t,e){return o(t)===e}var o=n(12);t.exports=r},function(t,e){function n(t){return null===t?"Null":t===r?"Undefined":o.exec(a.call(t))[1]}var r,o=/^\[object (.*)\]$/,a=Object.prototype.toString;t.exports=n}])});
//# sourceMappingURL=dist/js-data-localstorage.min.map