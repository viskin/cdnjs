(function(a,b){if(typeof define==="function"&&define.amd){define(function(){return(a.returnExportsGlobal=b())})}else{if(typeof exports==="object"){module.exports=b()}else{a.Springy=b()}}}(this,function(){var i={};var g=i.Graph=function(){this.nodeSet={};this.nodes=[];this.edges=[];this.adjacency={};this.nextNodeId=0;this.nextEdgeId=0;this.eventListeners=[]};var f=i.Node=function(k,j){this.id=k;this.data=(j!==undefined)?j:{}};var d=i.Edge=function(m,k,l,j){this.id=m;this.source=k;this.target=l;this.data=(j!==undefined)?j:{}};g.prototype.addNode=function(j){if(!(j.id in this.nodeSet)){this.nodes.push(j)}this.nodeSet[j.id]=j;this.notify();return j};g.prototype.addNodes=function(){for(var k=0;k<arguments.length;k++){var j=arguments[k];var l=new f(j,{label:j});this.addNode(l)}};g.prototype.addEdge=function(k){var j=false;this.edges.forEach(function(l){if(k.id===l.id){j=true}});if(!j){this.edges.push(k)}if(!(k.source.id in this.adjacency)){this.adjacency[k.source.id]={}}if(!(k.target.id in this.adjacency[k.source.id])){this.adjacency[k.source.id][k.target.id]=[]}j=false;this.adjacency[k.source.id][k.target.id].forEach(function(l){if(k.id===l.id){j=true}});if(!j){this.adjacency[k.source.id][k.target.id].push(k)}this.notify();return k};g.prototype.addEdges=function(){for(var m=0;m<arguments.length;m++){var n=arguments[m];var l=this.nodeSet[n[0]];if(l==undefined){throw new TypeError("invalid node name: "+n[0])}var k=this.nodeSet[n[1]];if(k==undefined){throw new TypeError("invalid node name: "+n[1])}var j=n[2];this.newEdge(l,k,j)}};g.prototype.newNode=function(k){var j=new f(this.nextNodeId++,k);this.addNode(j);return j};g.prototype.newEdge=function(l,m,k){var j=new d(this.nextEdgeId++,l,m,k);this.addEdge(j);return j};g.prototype.loadJSON=function(j){if(typeof j=="string"||j instanceof String){j=JSON.parse(j)}if("nodes" in j||"edges" in j){this.addNodes.apply(this,j.nodes);this.addEdges.apply(this,j.edges)}};g.prototype.getEdges=function(k,j){if(k.id in this.adjacency&&j.id in this.adjacency[k.id]){return this.adjacency[k.id][j.id]}return[]};g.prototype.removeNode=function(k){if(k.id in this.nodeSet){delete this.nodeSet[k.id]}for(var j=this.nodes.length-1;j>=0;j--){if(this.nodes[j].id===k.id){this.nodes.splice(j,1)}}this.detachNode(k)};g.prototype.detachNode=function(j){var k=this.edges.slice();k.forEach(function(l){if(l.source.id===j.id||l.target.id===j.id){this.removeEdge(l)}},this);this.notify()};g.prototype.removeEdge=function(o){for(var n=this.edges.length-1;n>=0;n--){if(this.edges[n].id===o.id){this.edges.splice(n,1)}}for(var k in this.adjacency){for(var p in this.adjacency[k]){var l=this.adjacency[k][p];for(var m=l.length-1;m>=0;m--){if(this.adjacency[k][p][m].id===o.id){this.adjacency[k][p].splice(m,1)}}if(this.adjacency[k][p].length==0){delete this.adjacency[k][p]}}if(b(this.adjacency[k])){delete this.adjacency[k]}}this.notify()};g.prototype.merge=function(k){var j=[];k.nodes.forEach(function(l){j.push(this.addNode(new f(l.id,l.data)))},this);k.edges.forEach(function(m){var p=j[m.from];var o=j[m.to];var n=(m.directed)?(n=m.type+"-"+p.id+"-"+o.id):(p.id<o.id)?m.type+"-"+p.id+"-"+o.id:m.type+"-"+o.id+"-"+p.id;var l=this.addEdge(new d(n,p,o,m.data));l.data.type=m.type},this)};g.prototype.filterNodes=function(j){var k=this.nodes.slice();k.forEach(function(l){if(!j(l)){this.removeNode(l)}},this)};g.prototype.filterEdges=function(j){var k=this.edges.slice();k.forEach(function(l){if(!j(l)){this.removeEdge(l)}},this)};g.prototype.addGraphListener=function(j){this.eventListeners.push(j)};g.prototype.notify=function(){this.eventListeners.forEach(function(j){j.graphChanged()})};var h=i.Layout={};h.ForceDirected=function(n,j,k,l,m){this.graph=n;this.stiffness=j;this.repulsion=k;this.damping=l;this.minEnergyThreshold=m||0.01;this.nodePoints={};this.edgeSprings={}};h.ForceDirected.prototype.point=function(k){if(!(k.id in this.nodePoints)){var j=(k.data.mass!==undefined)?k.data.mass:1;this.nodePoints[k.id]=new h.ForceDirected.Point(c.random(),j)}return this.nodePoints[k.id]};h.ForceDirected.prototype.spring=function(k){if(!(k.id in this.edgeSprings)){var j=(k.data.length!==undefined)?k.data.length:1;var l=false;var n=this.graph.getEdges(k.source,k.target);n.forEach(function(o){if(l===false&&o.id in this.edgeSprings){l=this.edgeSprings[o.id]}},this);if(l!==false){return new h.ForceDirected.Spring(l.point1,l.point2,0,0)}var m=this.graph.getEdges(k.target,k.source);n.forEach(function(o){if(l===false&&o.id in this.edgeSprings){l=this.edgeSprings[o.id]}},this);if(l!==false){return new h.ForceDirected.Spring(l.point2,l.point1,0,0)}this.edgeSprings[k.id]=new h.ForceDirected.Spring(this.point(k.source),this.point(k.target),j,this.stiffness)}return this.edgeSprings[k.id]};h.ForceDirected.prototype.eachNode=function(k){var j=this;this.graph.nodes.forEach(function(l){k.call(j,l,j.point(l))})};h.ForceDirected.prototype.eachEdge=function(k){var j=this;this.graph.edges.forEach(function(l){k.call(j,l,j.spring(l))})};h.ForceDirected.prototype.eachSpring=function(k){var j=this;this.graph.edges.forEach(function(l){k.call(j,j.spring(l))})};h.ForceDirected.prototype.applyCoulombsLaw=function(){this.eachNode(function(k,j){this.eachNode(function(m,l){if(j!==l){var o=j.p.subtract(l.p);var p=o.magnitude()+0.1;var n=o.normalise();j.applyForce(n.multiply(this.repulsion).divide(p*p*0.5));l.applyForce(n.multiply(this.repulsion).divide(p*p*-0.5))}})})};h.ForceDirected.prototype.applyHookesLaw=function(){this.eachSpring(function(j){var m=j.point2.p.subtract(j.point1.p);var k=j.length-m.magnitude();var l=m.normalise();j.point1.applyForce(l.multiply(j.k*k*-0.5));j.point2.applyForce(l.multiply(j.k*k*0.5))})};h.ForceDirected.prototype.attractToCentre=function(){this.eachNode(function(k,j){var l=j.p.multiply(-1);j.applyForce(l.multiply(this.repulsion/50))})};h.ForceDirected.prototype.updateVelocity=function(j){this.eachNode(function(l,k){k.v=k.v.add(k.a.multiply(j)).multiply(this.damping);k.a=new c(0,0)})};h.ForceDirected.prototype.updatePosition=function(j){this.eachNode(function(l,k){k.p=k.p.add(k.v.multiply(j))})};h.ForceDirected.prototype.totalEnergy=function(j){var k=0;this.eachNode(function(m,l){var n=l.v.magnitude();k+=0.5*l.m*n*n});return k};var e=function(j,k){return function(){return j.apply(k,arguments)}};i.requestAnimationFrame=e(this.requestAnimationFrame||this.webkitRequestAnimationFrame||this.mozRequestAnimationFrame||this.oRequestAnimationFrame||this.msRequestAnimationFrame||(function(k,j){this.setTimeout(k,10)}),this);h.ForceDirected.prototype.start=function(l,n,k){var j=this;if(this._started){return}this._started=true;this._stop=false;if(k!==undefined){k()}i.requestAnimationFrame(function m(){j.tick(0.03);if(l!==undefined){l()}if(j._stop||j.totalEnergy()<j.minEnergyThreshold){j._started=false;if(n!==undefined){n()}}else{i.requestAnimationFrame(m)}})};h.ForceDirected.prototype.stop=function(){this._stop=true};h.ForceDirected.prototype.tick=function(j){this.applyCoulombsLaw();this.applyHookesLaw();this.attractToCentre();this.updateVelocity(j);this.updatePosition(j)};h.ForceDirected.prototype.nearest=function(l){var k={node:null,point:null,distance:null};var j=this;this.graph.nodes.forEach(function(p){var m=j.point(p);var o=m.p.subtract(l).magnitude();if(k.distance===null||o<k.distance){k={node:p,point:m,distance:o}}});return k};h.ForceDirected.prototype.getBoundingBox=function(){var j=new c(-2,-2);var l=new c(2,2);this.eachNode(function(o,m){if(m.p.x<j.x){j.x=m.p.x}if(m.p.y<j.y){j.y=m.p.y}if(m.p.x>l.x){l.x=m.p.x}if(m.p.y>l.y){l.y=m.p.y}});var k=l.subtract(j).multiply(0.07);return{bottomleft:j.subtract(k),topright:l.add(k)}};var c=i.Vector=function(j,k){this.x=j;this.y=k};c.random=function(){return new c(10*(Math.random()-0.5),10*(Math.random()-0.5))};c.prototype.add=function(j){return new c(this.x+j.x,this.y+j.y)};c.prototype.subtract=function(j){return new c(this.x-j.x,this.y-j.y)};c.prototype.multiply=function(j){return new c(this.x*j,this.y*j)};c.prototype.divide=function(j){return new c((this.x/j)||0,(this.y/j)||0)};c.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};c.prototype.normal=function(){return new c(-this.y,this.x)};c.prototype.normalise=function(){return this.divide(this.magnitude())};h.ForceDirected.Point=function(j,k){this.p=j;this.m=k;this.v=new c(0,0);this.a=new c(0,0)};h.ForceDirected.Point.prototype.applyForce=function(j){this.a=this.a.add(j.divide(this.m))};h.ForceDirected.Spring=function(m,l,n,j){this.point1=m;this.point2=l;this.length=n;this.k=j};var a=i.Renderer=function(n,j,m,l,o,k){this.layout=n;this.clear=j;this.drawEdge=m;this.drawNode=l;this.onRenderStop=o;this.onRenderStart=k;this.layout.graph.addGraphListener(this)};a.prototype.graphChanged=function(j){this.start()};a.prototype.start=function(j){var k=this;this.layout.start(function l(){k.clear();k.layout.eachEdge(function(n,m){k.drawEdge(n,m.point1.p,m.point2.p)});k.layout.eachNode(function(n,m){k.drawNode(n,m.p)})},this.onRenderStop,this.onRenderStart)};a.prototype.stop=function(){this.layout.stop()};if(!Array.prototype.forEach){Array.prototype.forEach=function(q,l){var n,m;if(this==null){throw new TypeError(" this is null or not defined")}var p=Object(this);var j=p.length>>>0;if({}.toString.call(q)!="[object Function]"){throw new TypeError(q+" is not a function")}if(l){n=l}m=0;while(m<j){var o;if(m in p){o=p[m];q.call(n,o,m,p)}m++}}}var b=function(l){for(var j in l){if(l.hasOwnProperty(j)){return false}}return true};return i}));