(function(){jQuery.fn.springy=function(E){var c=this.graph=E.graph||new Springy.Graph();var p="16px Verdana, sans-serif";var x="8px Verdana, sans-serif";var B=E.stiffness||400;var i=E.repulsion||400;var f=E.damping||0.5;var v=E.minEnergyThreshold||0.00001;var A=E.nodeSelected||null;var h={};var m=true;var g=this[0];var u=g.getContext("2d");var C=this.layout=new Springy.Layout.ForceDirected(c,B,i,f,v);var d=C.getBoundingBox();var o={bottomleft:new Springy.Vector(-2,-2),topright:new Springy.Vector(2,2)};Springy.requestAnimationFrame(function w(){o=C.getBoundingBox();d={bottomleft:d.bottomleft.add(o.bottomleft.subtract(d.bottomleft).divide(10)),topright:d.topright.add(o.topright.subtract(d.topright).divide(10))};Springy.requestAnimationFrame(w)});var z=function(H){var G=d.topright.subtract(d.bottomleft);var J=H.subtract(d.bottomleft).divide(G.x).x*g.width;var I=H.subtract(d.bottomleft).divide(G.y).y*g.height;return new Springy.Vector(J,I)};var a=function(J){var I=d.topright.subtract(d.bottomleft);var H=(J.x/g.width)*I.x+d.bottomleft.x;var G=(J.y/g.height)*I.y+d.bottomleft.y;return new Springy.Vector(H,G)};var r=null;var e=null;var n=null;jQuery(g).mousedown(function(H){var I=jQuery(this).offset();var G=a({x:H.pageX-I.left,y:H.pageY-I.top});r=e=n=C.nearest(G);if(r.node!==null){n.point.m=10000;if(A){A(r.node)}}s.start()});jQuery(g).dblclick(function(H){var I=jQuery(this).offset();var G=a({x:H.pageX-I.left,y:H.pageY-I.top});r=C.nearest(G);node=r.node;if(node&&node.data&&node.data.ondoubleclick){node.data.ondoubleclick()}});jQuery(g).mousemove(function(H){var I=jQuery(this).offset();var G=a({x:H.pageX-I.left,y:H.pageY-I.top});e=C.nearest(G);if(n!==null&&n.node!==null){n.point.p.x=G.x;n.point.p.y=G.y}s.start()});jQuery(window).bind("mouseup",function(G){n=null});var l=function(H){var I=(H.data.label!==undefined)?H.data.label:H.id;if(H._width&&H._width[I]){return H._width[I]}u.save();u.font=(H.data.font!==undefined)?H.data.font:p;var G=u.measureText(I).width;u.restore();H._width||(H._width={});H._width[I]=G;return G};var j=function(G){return 16};var t=function(H){var G=(H.data.image.width!==undefined)?H.data.image.width:h[H.data.image.src].object.width;return G};var b=function(H){var G=(H.data.image.height!==undefined)?H.data.image.height:h[H.data.image.src].object.height;return G};Springy.Node.prototype.getHeight=function(){var G;if(this.data.image==undefined){G=j(this)}else{if(this.data.image.src in h&&h[this.data.image.src].loaded){G=b(this)}else{G=10}}return G};Springy.Node.prototype.getWidth=function(){var G;if(this.data.image==undefined){G=l(this)}else{if(this.data.image.src in h&&h[this.data.image.src].loaded){G=t(this)}else{G=10}}return G};var s=this.renderer=new Springy.Renderer(C,function q(){u.clearRect(0,0,g.width,g.height)},function k(P,I,G){var ag=z(I).x;var M=z(I).y;var ae=z(G).x;var L=z(G).y;var ai=new Springy.Vector(ae-ag,L-M);var ak=ai.normal().normalise();var X=c.getEdges(P.source,P.target);var K=c.getEdges(P.target,P.source);var al=X.length+K.length;var W=0;for(var ac=0;ac<X.length;ac++){if(X[ac].id===P.id){W=ac}}var N=12;var O=ak.multiply(-((al-1)*N)/2+(W*N));var ad=6;var Z=6;var J=z(I).add(O);var H=z(G).add(O);var T=P.target.getWidth()+ad;var Q=P.target.getHeight()+Z;var S=D(J,H,{x:ae-T/2,y:L-Q/2},T,Q);if(!S){S=H}var R=(P.data.color!==undefined)?P.data.color:"#000000";var af;var V;var U=(P.data.weight!==undefined)?P.data.weight:1;u.lineWidth=Math.max(U*2,0.1);af=1+u.lineWidth;V=8;var Y=(P.data.directional!==undefined)?P.data.directional:true;var ab;if(Y){ab=S.subtract(ai.normalise().multiply(V*0.5))}else{ab=H}u.strokeStyle=R;u.beginPath();u.moveTo(J.x,J.y);u.lineTo(ab.x,ab.y);u.stroke();if(Y){u.save();u.fillStyle=R;u.translate(S.x,S.y);u.rotate(Math.atan2(L-M,ae-ag));u.beginPath();u.moveTo(-V,af);u.lineTo(0,0);u.lineTo(-V,-af);u.lineTo(-V*0.8,-0);u.closePath();u.fill();u.restore()}if(P.data.label!==undefined){text=P.data.label;u.save();u.textAlign="center";u.textBaseline="top";u.font=(P.data.font!==undefined)?P.data.font:x;u.fillStyle=R;var ah=Math.atan2(H.y-J.y,H.x-J.x);var aj=-8;if(m&&(ah>Math.PI/2||ah<-Math.PI/2)){aj=8;ah+=Math.PI}var aa=J.add(H).divide(2).add(ak.multiply(aj));u.translate(aa.x,aa.y);u.rotate(ah);u.fillText(text,0,-2);u.restore()}},function y(J,I){var R=z(I);u.save();var L=6;var K=6;var H=J.getWidth();var P=J.getHeight();var N=H+L;var O=P+K;u.clearRect(R.x-N/2,R.y-O/2,N,O);if(r!==null&&r.node!==null&&r.node.id===J.id){u.fillStyle="#FFFFE0"}else{if(e!==null&&e.node!==null&&e.node.id===J.id){u.fillStyle="#EEEEEE"}else{u.fillStyle="#FFFFFF"}}u.fillRect(R.x-N/2,R.y-O/2,N,O);if(J.data.image==undefined){u.textAlign="left";u.textBaseline="top";u.font=(J.data.font!==undefined)?J.data.font:p;u.fillStyle="#000000";var Q=(J.data.label!==undefined)?J.data.label:J.id;u.fillText(Q,R.x-H/2,R.y-P/2)}else{var G=J.data.image.src;if(G in h){if(h[G].loaded){u.drawImage(h[G].object,R.x-H/2,R.y-P/2,H,P)}}else{h[G]={};var M=new Image();h[G].object=M;M.addEventListener("load",function(){h[G].loaded=true});M.src=G}}u.restore()});s.start();function F(M,L,K,J){var G=((J.y-K.y)*(L.x-M.x)-(J.x-K.x)*(L.y-M.y));if(G===0){return false}var I=((J.x-K.x)*(M.y-K.y)-(J.y-K.y)*(M.x-K.x))/G;var H=((L.x-M.x)*(M.y-K.y)-(L.y-M.y)*(M.x-K.x))/G;if(I<0||I>1||H<0||H>1){return false}return new Springy.Vector(M.x+I*(L.x-M.x),M.y+I*(L.y-M.y))}function D(M,L,J,K,H){var O={x:J.x,y:J.y};var I={x:J.x+K,y:J.y};var G={x:J.x,y:J.y+H};var N={x:J.x+K,y:J.y+H};var P;if(P=F(M,L,O,I)){return P}if(P=F(M,L,I,N)){return P}if(P=F(M,L,N,G)){return P}if(P=F(M,L,G,O)){return P}return false}return this}})();