!function(t){"use strict";!function(t,e){function r(e,r,n){function a(e,r){var n=t.isObject(e)?e.name:e;return r?s[n]:internalStates[n]}function o(t,e){if(e.name){var r=e.name.split(/\./);for("."===e.name.charAt(0)&&(r[0]=t.current.name);r.length;){var n=r.join(".");if(t.get(n,{relative:t.current}))return null;if(s[n])return s[n];r.pop()}}if(e.url){var a=[];for(var o in s){var u=s[o].urlMatcher;u&&u.exec(e.url)&&a.push(s[o])}for(var i=a.slice(0),c=a.length-1;c>=0;c--)for(var f=0;f<i.length;f++)a[c]===i[f].parentFutureState&&a.splice(c,1);return a[0]}}function u(t,e){l=!0;var r=t.get("$q");if(!e){var n=r.defer();return n.reject("No lazyState passed in "+e),n.promise}var a=r.when([]),o=e.parentFutureState;o&&s[o.name]&&(a=u(t,s[o.name]));var i=e.type,c=f[i];if(!c)throw Error("No state factory for futureState.type: "+(e&&e.type));return a.then(function(r){var n=t.invoke(c,c,{futureState:e});return n.then(function(t){return t&&r.push(t),r})})["finally"](function(){delete s[e.name]})}function i(t,r){var n=!1,a=["$rootScope","$urlRouter","$state",function(a,i,f){function s(){n=!0,i.sync(),n=!1}if(!h)return c().then(s),void(h=!0);var v=o(f,{url:r.path()});return v?void u(t,v).then(function(t){t.forEach(function(t){t&&(!f.get(t)||t.name&&!f.get(t.name))&&e.state(t)}),l=!1,s()},function(){l=!1,s()}):t.invoke(m)}];if(!l){var i=n?m:a;return t.invoke(i)}}var c,f={},s={},l=!1,v=[],h=!1,p=this;this.addResolve=function(t){v.push(t)},this.stateFactory=function(t,e){f[t]=e},this.futureState=function(e){e.stateName&&(e.name=e.stateName),e.urlPrefix&&(e.url="^"+e.urlPrefix),s[e.name]=e;var r,o=e.name.split(/\./).slice(0,-1).join("."),u=a(e.parent||o);if(u)r=u.url||u.navigable.url;else if(""===o)r=n.compile("");else{var i=a(e.parent||o,!0);if(!i)throw new Error("Couldn't determine parent state of future state. FutureState:"+t.toJson(e));var c=i.urlMatcher.source.replace(/\*rest$/,"");r=n.compile(c),e.parentFutureState=i}e.url&&(e.urlMatcher="^"===e.url.charAt(0)?n.compile(e.url.substring(1)+"*rest"):r.concat(e.url+"*rest"))},this.get=function(){return t.extend({},s)};var m=["$log","$location",function(t,e){t.debug("Unable to map "+e.path())}];r.otherwise(i),r.otherwise=function(e){if(t.isString(e)){var n=e;e=function(){return n}}else if(!t.isFunction(e))throw new Error("'rule' must be a function");return m=["$injector","$location",e],r};var $={getResolvePromise:function(){return c()}};this.$get=["$injector","$state","$q","$rootScope","$urlRouter","$timeout","$log",function(r,n,a,i,f,s,h){function m(){if(i.$on("$stateNotFound",function(t,a,i,c){if(!l){h.debug("event, unfoundState, fromState, fromParams",t,a,i,c);var f=o(n,{name:a.to});if(f){t.preventDefault();var s=u(r,f);s.then(function(t){t.forEach(function(t){t&&(!n.get(t)||t.name&&!n.get(t.name))&&e.state(t)}),n.go(a.to,a.toParams),l=!1},function(t){console.log("failed to lazy load state ",t),n.go(i,c),l=!1})}}}),!c){var p=[];t.forEach(v,function(t){p.push(r.invoke(t))}),c=function(){return a.all(p)}}c().then(function(){s(function(){n.transition?n.transition.then(f.sync,f.sync):f.sync()})})}return m(),$.state=e.state,$.futureState=p.futureState,$.get=p.get,$}]}var n=t.module("ct.ui.router.extras.future",["ct.ui.router.extras.core"]);n.provider("$futureState",["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider",r]);var a={state:function(t){a.$rootScope&&a.$rootScope.$broadcast("$stateAdded",t)},itsNowRuntimeOhWhatAHappyDay:function(t){a.$rootScope=t},$rootScope:e};n.config(["$stateProvider",function(e){var r=e.state;e.state=function(){var n=r.apply(e,arguments),o=t.isObject(arguments[0])?arguments[0]:arguments[1];return a.state(o),n}}]),n.run(["$futureState",function(t,e){a.itsNowRuntimeOhWhatAHappyDay(e)}])}(t)}(angular);