(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets"))}else{if(typeof define=="function"&&define.amd){define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],a)}else{a(CodeMirror)}}})(function(l){var q=l.keyMap.sublime={fallthrough:"default"};var j=l.commands;var i=l.Pos;var d=l.keyMap["default"]==l.keyMap.macDefault;var f=d?"Cmd-":"Ctrl-";function e(C,u,v){if(v<0&&u.ch==0){return C.clipPos(i(u.line-1))}var D=C.getLine(u.line);if(v>0&&u.ch>=D.length){return C.clipPos(i(u.line+1,0))}var t="start",z;for(var B=u.ch,y=v<0?0:D.length,w=0;B!=y;B+=v,w++){var x=D.charAt(v<0?B-1:B);var A=x!="_"&&l.isWordChar(x)?"w":"o";if(A=="w"&&x.toUpperCase()==x){A="W"}if(t=="start"){if(A!="o"){t="in";z=A}}else{if(t=="in"){if(z!=A){if(z=="w"&&A=="W"&&v<0){B--}if(z=="W"&&A=="w"&&v>0){z="w";continue}break}}}}return i(u.line,B)}function o(t,u){t.extendSelectionsBy(function(v){if(t.display.shift||t.doc.extend||v.empty()){return e(t.doc,v.head,u)}else{return u<0?v.from():v.to()}})}j[q["Alt-Left"]="goSubwordLeft"]=function(t){o(t,-1)};j[q["Alt-Right"]="goSubwordRight"]=function(t){o(t,1)};var s=d?"Ctrl-Alt-":"Ctrl-";j[q[s+"Up"]="scrollLineUp"]=function(t){var v=t.getScrollInfo();if(!t.somethingSelected()){var u=t.lineAtHeight(v.top+v.clientHeight,"local");if(t.getCursor().line>=u){t.execCommand("goLineUp")}}t.scrollTo(null,v.top-t.defaultTextHeight())};j[q[s+"Down"]="scrollLineDown"]=function(t){var v=t.getScrollInfo();if(!t.somethingSelected()){var u=t.lineAtHeight(v.top,"local")+1;if(t.getCursor().line<=u){t.execCommand("goLineDown")}}t.scrollTo(null,v.top+t.defaultTextHeight())};j[q["Shift-"+f+"L"]="splitSelectionByLine"]=function(t){var v=t.listSelections(),x=[];for(var w=0;w<v.length;w++){var z=v[w].from(),y=v[w].to();for(var u=z.line;u<=y.line;++u){if(!(y.line>z.line&&u==y.line&&y.ch==0)){x.push({anchor:u==z.line?z:i(u,0),head:u==y.line?y:i(u)})}}}t.setSelections(x,0)};q["Shift-Tab"]="indentLess";j[q.Esc="singleSelectionTop"]=function(t){var u=t.listSelections()[0];t.setSelection(u.anchor,u.head,{scroll:false})};j[q[f+"L"]="selectLine"]=function(u){var v=u.listSelections(),t=[];for(var x=0;x<v.length;x++){var w=v[x];t.push({anchor:i(w.from().line,0),head:i(w.to().line+1,0)})}u.setSelections(t)};q["Shift-"+f+"K"]="deleteLine";function a(u,t){if(u.isReadOnly()){return l.Pass}u.operation(function(){var x=u.listSelections().length,w=[],A=-1;for(var z=0;z<x;z++){var y=u.listSelections()[z].head;if(y.line<=A){continue}var v=i(y.line+(t?0:1),0);u.replaceRange("\n",v,null,"+insertLine");u.indentLine(v.line,null,true);w.push({head:v,anchor:v});A=y.line+1}u.setSelections(w)})}j[q[f+"Enter"]="insertLineAfter"]=function(t){return a(t,false)};j[q["Shift-"+f+"Enter"]="insertLineBefore"]=function(t){return a(t,true)};function b(t,x){var w=x.ch,v=w,u=t.getLine(x.line);while(w&&l.isWordChar(u.charAt(w-1))){--w}while(v<u.length&&l.isWordChar(u.charAt(v))){++v}return{from:i(x.line,w),to:i(x.line,v),word:u.slice(w,v)}}j[q[f+"D"]="selectNextOccurrence"]=function(t){var A=t.getCursor("from"),z=t.getCursor("to");var u=t.state.sublimeFindFullWord==t.doc.sel;if(l.cmpPos(A,z)==0){var w=b(t,A);if(!w.word){return}t.setSelection(w.from,w.to);u=true}else{var y=t.getRange(A,z);var v=u?new RegExp("\\b"+y+"\\b"):y;var x=t.getSearchCursor(v,z);if(x.findNext()){t.addSelection(x.from(),x.to())}else{x=t.getSearchCursor(v,i(t.firstLine(),0));if(x.findNext()){t.addSelection(x.from(),x.to())}}}if(u){t.state.sublimeFindFullWord=t.doc.sel}};var h="(){}[]";function n(u){var w=u.getCursor(),t=u.scanForBracket(w,-1);if(!t){return}for(;;){var v=u.scanForBracket(w,1);if(!v){return}if(v.ch==h.charAt(h.indexOf(t.ch)+1)){u.setSelection(i(t.pos.line,t.pos.ch+1),v.pos,false);return true}w=i(v.pos.line,v.pos.ch+1)}}j[q["Shift-"+f+"Space"]="selectScope"]=function(t){n(t)||t.execCommand("selectAll")};j[q["Shift-"+f+"M"]="selectBetweenBrackets"]=function(t){if(!n(t)){return l.Pass}};j[q[f+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(u){var v=t.scanForBracket(u.head,1);if(v&&l.cmpPos(v.pos,u.head)!=0){return v.pos}var w=t.scanForBracket(u.head,-1);return w&&i(w.pos.line,w.pos.ch+1)||u.head})};var m=d?"Cmd-Ctrl-":"Shift-Ctrl-";j[q[m+"Up"]="swapLineUp"]=function(A){if(A.isReadOnly()){return l.Pass}var t=A.listSelections(),x=[],u=A.firstLine()-1,B=[];for(var v=0;v<t.length;v++){var w=t[v],z=w.from().line-1,y=w.to().line;B.push({anchor:i(w.anchor.line-1,w.anchor.ch),head:i(w.head.line-1,w.head.ch)});if(w.to().ch==0&&!w.empty()){--y}if(z>u){x.push(z,y)}else{if(x.length){x[x.length-1]=y}}u=y}A.operation(function(){for(var D=0;D<x.length;D+=2){var F=x[D],E=x[D+1];var C=A.getLine(F);A.replaceRange("",i(F,0),i(F+1,0),"+swapLine");if(E>A.lastLine()){A.replaceRange("\n"+C,i(A.lastLine()),null,"+swapLine")}else{A.replaceRange(C+"\n",i(E,0),null,"+swapLine")}}A.setSelections(B);A.scrollIntoView()})};j[q[m+"Down"]="swapLineDown"]=function(u){if(u.isReadOnly()){return l.Pass}var v=u.listSelections(),y=[],t=u.lastLine()+1;for(var x=v.length-1;x>=0;x--){var w=v[x],A=w.to().line+1,z=w.from().line;if(w.to().ch==0&&!w.empty()){A--}if(A<t){y.push(A,z)}else{if(y.length){y[y.length-1]=z}}t=z}u.operation(function(){for(var C=y.length-2;C>=0;C-=2){var E=y[C],D=y[C+1];var B=u.getLine(E);if(E==u.lastLine()){u.replaceRange("",i(E-1),i(E),"+swapLine")}else{u.replaceRange("",i(E,0),i(E+1,0),"+swapLine")}u.replaceRange(B+"\n",i(D,0),null,"+swapLine")}u.scrollIntoView()})};j[q[f+"/"]="toggleCommentIndented"]=function(t){t.toggleComment({indent:true})};j[q[f+"J"]="joinLines"]=function(t){var v=t.listSelections(),y=[];for(var x=0;x<v.length;x++){var w=v[x],A=w.from();var z=A.line,u=w.to().line;while(x<v.length-1&&v[x+1].from().line==u){u=v[++x].to().line}y.push({start:z,end:u,anchor:!w.empty()&&A})}t.operation(function(){var H=0,C=[];for(var F=0;F<y.length;F++){var G=y[F];var D=G.anchor&&i(G.anchor.line-H,G.anchor.ch),E;for(var B=G.start;B<=G.end;B++){var I=B-H;if(B==G.end){E=i(I,t.getLine(I).length+1)}if(I<t.lastLine()){t.replaceRange(" ",i(I),i(I+1,/^\s*/.exec(t.getLine(I+1))[0].length));++H}}C.push({anchor:D||E,head:E})}t.setSelections(C,0)})};j[q["Shift-"+f+"D"]="duplicateLine"]=function(t){t.operation(function(){var v=t.listSelections().length;for(var w=0;w<v;w++){var u=t.listSelections()[w];if(u.empty()){t.replaceRange(t.getLine(u.head.line)+"\n",i(u.head.line,0))}else{t.replaceRange(t.getRange(u.from(),u.to()),u.from())}}t.scrollIntoView()})};q[f+"T"]="transposeChars";function r(B,y){if(B.isReadOnly()){return l.Pass}var t=B.listSelections(),x=[],u;for(var v=0;v<t.length;v++){var w=t[v];if(w.empty()){continue}var A=w.from().line,z=w.to().line;while(v<t.length-1&&t[v+1].from().line==z){z=w[++v].to().line}x.push(A,z)}if(x.length){u=true}else{x.push(B.firstLine(),B.lastLine())}B.operation(function(){var E=[];for(var F=0;F<x.length;F+=2){var I=x[F],H=x[F+1];var G=i(I,0),D=i(H);var C=B.getRange(G,D,false);if(y){C.sort()}else{C.sort(function(L,J){var M=L.toUpperCase(),K=J.toUpperCase();if(M!=K){L=M;J=K}return L<J?-1:L==J?0:1})}B.replaceRange(C,G,D);if(u){E.push({anchor:G,head:D})}}if(u){B.setSelections(E,0)}})}j[q.F9="sortLines"]=function(t){r(t,true)};j[q[f+"F9"]="sortLinesInsensitive"]=function(t){r(t,false)};j[q.F2="nextBookmark"]=function(t){var u=t.state.sublimeBookmarks;if(u){while(u.length){var w=u.shift();var v=w.find();if(v){u.push(w);return t.setSelection(v.from,v.to)}}}};j[q["Shift-F2"]="prevBookmark"]=function(t){var u=t.state.sublimeBookmarks;if(u){while(u.length){u.unshift(u.pop());var v=u[u.length-1].find();if(!v){u.pop()}else{return t.setSelection(v.from,v.to)}}}};j[q[f+"F2"]="toggleBookmark"]=function(A){var t=A.listSelections();var x=A.state.sublimeBookmarks||(A.state.sublimeBookmarks=[]);for(var w=0;w<t.length;w++){var y=t[w].from(),z=t[w].to();var B=A.findMarks(y,z);for(var v=0;v<B.length;v++){if(B[v].sublimeBookmark){B[v].clear();for(var u=0;u<x.length;u++){if(x[u]==B[v]){x.splice(u--,1)}}break}}if(v==B.length){x.push(A.markText(y,z,{sublimeBookmark:true,clearWhenEmpty:false}))}}};j[q["Shift-"+f+"F2"]="clearBookmarks"]=function(t){var v=t.state.sublimeBookmarks;if(v){for(var u=0;u<v.length;u++){v[u].clear()}}v.length=0};j[q["Alt-F2"]="selectBookmarks"]=function(t){var w=t.state.sublimeBookmarks,u=[];if(w){for(var v=0;v<w.length;v++){var x=w[v].find();if(!x){w.splice(v--,0)}else{u.push({anchor:x.from,head:x.to})}}}if(u.length){t.setSelections(u,0)}};q["Alt-Q"]="wrapLines";var c=f+"K ";function g(t,u){t.operation(function(){var w=t.listSelections(),B=[],z=[];for(var y=0;y<w.length;y++){var x=w[y];if(x.empty()){B.push(y);z.push("")}else{z.push(u(t.getRange(x.from(),x.to())))}}t.replaceSelections(z,"around","case");for(var y=B.length-1,v;y>=0;y--){var x=w[B[y]];if(v&&l.cmpPos(x.head,v)>0){continue}var A=b(t,x.head);v=A.from;t.replaceRange(u(A.word),A.from,A.to)}})}q[c+f+"Backspace"]="delLineLeft";j[q.Backspace="smartBackspace"]=function(t){if(t.somethingSelected()){return l.Pass}var x=t.getCursor();var w=t.getRange({line:x.line,ch:0},x);var v=l.countColumn(w,null,t.getOption("tabSize"));var u=t.getOption("indentUnit");if(w&&!/\S/.test(w)&&v%u==0){var y=new i(x.line,l.findColumn(w,v-u,u));if(y.ch==x.ch){return l.Pass}return t.replaceRange("",y,x,"+delete")}else{return l.Pass}};j[q[c+f+"K"]="delLineRight"]=function(t){t.operation(function(){var u=t.listSelections();for(var v=u.length-1;v>=0;v--){t.replaceRange("",u[v].anchor,i(u[v].to().line),"+delete")}t.scrollIntoView()})};j[q[c+f+"U"]="upcaseAtCursor"]=function(t){g(t,function(u){return u.toUpperCase()})};j[q[c+f+"L"]="downcaseAtCursor"]=function(t){g(t,function(u){return u.toLowerCase()})};j[q[c+f+"Space"]="setSublimeMark"]=function(t){if(t.state.sublimeMark){t.state.sublimeMark.clear()}t.state.sublimeMark=t.setBookmark(t.getCursor())};j[q[c+f+"A"]="selectToSublimeMark"]=function(t){var u=t.state.sublimeMark&&t.state.sublimeMark.find();if(u){t.setSelection(t.getCursor(),u)}};j[q[c+f+"W"]="deleteToSublimeMark"]=function(t){var v=t.state.sublimeMark&&t.state.sublimeMark.find();if(v){var x=t.getCursor(),w=v;if(l.cmpPos(x,w)>0){var u=w;w=x;x=u}t.state.sublimeKilled=t.getRange(x,w);t.replaceRange("",x,w)}};j[q[c+f+"X"]="swapWithSublimeMark"]=function(t){var u=t.state.sublimeMark&&t.state.sublimeMark.find();if(u){t.state.sublimeMark.clear();t.state.sublimeMark=t.setBookmark(t.getCursor());t.setCursor(u)}};j[q[c+f+"Y"]="sublimeYank"]=function(t){if(t.state.sublimeKilled!=null){t.replaceSelection(t.state.sublimeKilled,null,"paste")}};q[c+f+"G"]="clearBookmarks";j[q[c+f+"C"]="showInCenter"]=function(t){var u=t.cursorCoords(null,"local");t.scrollTo(null,(u.top+u.bottom)/2-t.getScrollInfo().clientHeight/2)};j[q["Shift-Alt-Up"]="selectLinesUpward"]=function(t){t.operation(function(){var u=t.listSelections();for(var w=0;w<u.length;w++){var v=u[w];if(v.head.line>t.firstLine()){t.addSelection(i(v.head.line-1,v.head.ch))}}})};j[q["Shift-Alt-Down"]="selectLinesDownward"]=function(t){t.operation(function(){var u=t.listSelections();for(var w=0;w<u.length;w++){var v=u[w];if(v.head.line<t.lastLine()){t.addSelection(i(v.head.line+1,v.head.ch))}}})};function p(t){var w=t.getCursor("from"),v=t.getCursor("to");if(l.cmpPos(w,v)==0){var u=b(t,w);if(!u.word){return}w=u.from;v=u.to}return{from:w,to:v,query:t.getRange(w,v),word:u}}function k(t,u){var w=p(t);if(!w){return}var v=w.query;var x=t.getSearchCursor(v,u?w.to:w.from);if(u?x.findNext():x.findPrevious()){t.setSelection(x.from(),x.to())}else{x=t.getSearchCursor(v,u?i(t.firstLine(),0):t.clipPos(i(t.lastLine())));if(u?x.findNext():x.findPrevious()){t.setSelection(x.from(),x.to())}else{if(w.word){t.setSelection(w.from,w.to)}}}}j[q[f+"F3"]="findUnder"]=function(t){k(t,true)};j[q["Shift-"+f+"F3"]="findUnderPrevious"]=function(t){k(t,false)};j[q["Alt-F3"]="findAllUnder"]=function(t){var w=p(t);if(!w){return}var x=t.getSearchCursor(w.query);var v=[];var u=-1;while(x.findNext()){v.push({anchor:x.from(),head:x.to()});if(x.from().line<=w.from.line&&x.from().ch<=w.from.ch){u++}}t.setSelections(v,u)};q["Shift-"+f+"["]="fold";q["Shift-"+f+"]"]="unfold";q[c+f+"0"]=q[c+f+"j"]="unfoldAll";q[f+"I"]="findIncremental";q["Shift-"+f+"I"]="findIncrementalReverse";q[f+"H"]="replace";q.F3="findNext";q["Shift-F3"]="findPrev";l.normalizeKeyMap(q)});