(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","diff_match_patch"],a)}else{a(CodeMirror)}}})(function(u){var l=u.Pos;var F="http://www.w3.org/2000/svg";function i(U,V){this.mv=U;this.type=V;this.classes=V=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}i.prototype={constructor:i,init:function(W,V,U){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=u(W,m({value:V,readOnly:!this.mv.options.allowEditingOriginals},m(U)));this.orig.state.diffViews=[this];this.diff=b(A(V),A(U.value));this.chunks=o(this.diff);this.diffOutOfDate=this.dealigned=false;this.showDifferences=U.showDifferences!==false;this.forceUpdate=O(this);r(this,true,false);e(this)},setShowDifferences:function(U){U=U!==false;if(U!=this.showDifferences){this.showDifferences=U;this.forceUpdate("full")}}};function G(U){if(U.diffOutOfDate){U.diff=b(U.orig.getValue(),U.edit.getValue());U.chunks=o(U.diff);U.diffOutOfDate=false;u.signal(U.edit,"updateDiff",U.diff)}}var T=false;function O(V){var ab={from:0,to:0,marked:[]};var Z={from:0,to:0,marked:[]};var U,ac=false;function W(ad){T=true;ac=false;if(ad=="full"){if(V.svg){E(V.svg)}if(V.copyButtons){E(V.copyButtons)}R(V.edit,ab.marked,V.classes);R(V.orig,Z.marked,V.classes);ab.from=ab.to=Z.from=Z.to=0}G(V);if(V.showDifferences){q(V.edit,V.diff,ab,DIFF_INSERT,V.classes);q(V.orig,V.diff,Z,DIFF_DELETE,V.classes)}n(V);if(V.mv.options.connect=="align"){f(V)}T=false}function X(ad){if(T){return}V.dealigned=true;aa(ad)}function aa(ad){if(T||ac){return}clearTimeout(U);if(ad===true){ac=true}U=setTimeout(W,ad===true?20:250)}function Y(ad,ae){if(!V.diffOutOfDate){V.diffOutOfDate=true;ab.from=ab.to=Z.from=Z.to=0}X(ae.text.length-1!=ae.to.line-ae.from.line)}V.edit.on("change",Y);V.orig.on("change",Y);V.edit.on("markerAdded",X);V.edit.on("markerCleared",X);V.orig.on("markerAdded",X);V.orig.on("markerCleared",X);V.edit.on("viewportChange",function(){aa(false)});V.orig.on("viewportChange",function(){aa(false)});W();return W}function e(U){U.edit.on("scroll",function(){x(U,DIFF_INSERT)&&n(U)});U.orig.on("scroll",function(){x(U,DIFF_DELETE)&&n(U)})}function x(ag,Y){if(ag.diffOutOfDate){return false}if(!ag.lockScroll){return true}var Z,ab,W=+new Date;if(Y==DIFF_INSERT){Z=ag.edit;ab=ag.orig}else{Z=ag.orig;ab=ag.edit}if(Z.state.scrollSetBy==ag&&(Z.state.scrollSetAt||0)+50>W){return false}var U=Z.getScrollInfo();if(ag.mv.options.connect=="align"){X=U.top}else{var V=0.5*U.clientHeight,ae=U.top+V;var ak=Z.lineAtHeight(ae,"local");var ai=S(ag.chunks,ak,Y==DIFF_INSERT);var al=M(Z,Y==DIFF_INSERT?ai.edit:ai.orig);var ad=M(ab,Y==DIFF_INSERT?ai.orig:ai.edit);var ac=(ae-al.top)/(al.bot-al.top);var X=(ad.top-V)+ac*(ad.bot-ad.top);var aa,af;if(X>U.top&&(af=U.top/V)<1){X=X*af+U.top*(1-af)}else{if((aa=U.height-U.clientHeight-U.top)<V){var aj=ab.getScrollInfo();var ah=aj.height-aj.clientHeight-X;if(ah>aa&&(af=aa/V)<1){X=X*af+(aj.height-aj.clientHeight-aa)*(1-af)}}}}ab.scrollTo(U.left,X);ab.state.scrollSetAt=W;ab.state.scrollSetBy=ag;return true}function M(U,V){var W=V.after;if(W==null){W=U.lastLine()+1}return{top:U.heightAtLine(V.before||0,"local"),bot:U.heightAtLine(W,"local")}}function r(U,W,V){U.lockScroll=W;if(W&&V!=false){x(U,DIFF_INSERT)&&n(U)}U.lockButton.innerHTML=W?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function R(X,U,W){for(var V=0;V<U.length;++V){var Y=U[V];if(Y instanceof u.TextMarker){Y.clear()}else{if(Y.parent){X.removeLineClass(Y,"background",W.chunk);X.removeLineClass(Y,"background",W.start);X.removeLineClass(Y,"background",W.end)}}}U.length=0}function q(X,Z,Y,W,V){var U=X.getViewport();X.operation(function(){if(Y.from==Y.to||U.from-Y.to>20||Y.from-U.to>20){R(X,Y.marked,V);d(X,Z,W,Y.marked,U.from,U.to,V);Y.from=U.from;Y.to=U.to}else{if(U.from<Y.from){d(X,Z,W,Y.marked,U.from,Y.from,V);Y.from=U.from}if(U.to>Y.to){d(X,Z,W,Y.marked,Y.to,U.to,V);Y.to=U.to}}})}function d(ab,ae,aa,ak,aj,W,am){var ac=l(0,0);var ag=l(aj,0),af=ab.clipPos(l(W-1));var U=aa==DIFF_DELETE?am.del:am.insert;function ad(aw,ar){var av=Math.max(aj,aw),at=Math.min(W,ar);for(var au=av;au<at;++au){var aq=ab.addLineClass(au,"background",am.chunk);if(au==aw){ab.addLineClass(aq,"background",am.start)}if(au==ar-1){ab.addLineClass(aq,"background",am.end)}ak.push(aq)}if(aw==ar&&av==ar&&at==ar){if(av){ak.push(ab.addLineClass(av-1,"background",am.end))}else{ak.push(ab.addLineClass(av,"background",am.start))}}}var ap=0;for(var al=0;al<ae.length;++al){var ai=ae[al],V=ai[0],ah=ai[1];if(V==DIFF_EQUAL){var Z=ac.line+(H(ae,al)?0:1);C(ac,ah);var Y=ac.line+(K(ae,al)?1:0);if(Y>Z){if(al){ad(ap,Z)}ap=Y}}else{if(V==aa){var X=C(ac,ah,true);var ao=I(ag,ac),an=j(af,X);if(!N(ao,an)){ak.push(ab.markText(ao,an,{className:U}))}ac=X}}}if(ap<=ac.line){ad(ap,ac.line+1)}}function n(Y){if(!Y.showDifferences){return}if(Y.svg){E(Y.svg);var V=Y.gap.offsetWidth;h(Y.svg,"width",V,"height",Y.gap.offsetHeight)}if(Y.copyButtons){E(Y.copyButtons)}var ab=Y.edit.getViewport(),W=Y.orig.getViewport();var U=Y.edit.getScrollInfo().top,aa=Y.orig.getScrollInfo().top;for(var X=0;X<Y.chunks.length;X++){var Z=Y.chunks[X];if(Z.editFrom<=ab.to&&Z.editTo>=ab.from&&Z.origFrom<=W.to&&Z.origTo>=W.from){a(Y,Z,aa,U,V)}}}function y(Z,Y){var X=0,W=0;for(var V=0;V<Y.length;V++){var U=Y[V];if(U.editTo>Z&&U.editFrom<=Z){return null}if(U.editFrom>Z){break}X=U.editTo;W=U.origTo}return W+(Z-X)}function k(Z,U){var Y=[];for(var X=0;X<Z.chunks.length;X++){var W=Z.chunks[X];Y.push([W.origTo,W.editTo,U?y(W.editTo,U.chunks):null])}if(U){for(var X=0;X<U.chunks.length;X++){var W=U.chunks[X];for(var V=0;V<Y.length;V++){var aa=Y[V];if(aa[1]==W.editTo){V=-1;break}else{if(aa[1]>W.editTo){break}}}if(V>-1){Y.splice(V-1,0,[y(W.editTo,Z.chunks),W.editTo,W.origTo])}}}return Y}function f(U,V){if(!U.dealigned&&!V){return}if(!U.orig.curOp){return U.orig.operation(function(){f(U,V)})}U.dealigned=false;var Y=U.mv.left==U?U.mv.right:U.mv.left;if(Y){G(Y);Y.dealigned=false}var X=k(U,Y);var ac=U.mv.aligners;for(var W=0;W<ac.length;W++){ac[W].clear()}ac.length=0;var ab=[U.orig,U.edit],aa=[];if(Y){ab.push(Y.orig)}for(var W=0;W<ab.length;W++){aa.push(ab[W].getScrollInfo().top)}for(var Z=0;Z<X.length;Z++){J(ab,X[Z],ac)}for(var W=0;W<ab.length;W++){ab[W].scrollTo(null,aa[W])}}function J(U,V,Y){var X=0,ab=[];for(var W=0;W<U.length;W++){if(V[W]!=null){var aa=U[W].heightAtLine(V[W],"local");ab[W]=aa;X=Math.max(X,aa)}}for(var W=0;W<U.length;W++){if(V[W]!=null){var Z=X-ab[W];if(Z>1){Y.push(B(U[W],V[W],Z))}}}}function B(V,W,Y){var U=true;if(W>V.lastLine()){W--;U=false}var X=document.createElement("div");X.className="CodeMirror-merge-spacer";X.style.height=Y+"px";X.style.minWidth="1px";return V.addLineWidget(W,X,{height:Y,above:U})}function a(ac,ab,ag,V,aa){var X=ac.type=="left";var ae=ac.orig.heightAtLine(ab.origFrom,"local")-ag;if(ac.svg){var U=ae;var Z=ac.edit.heightAtLine(ab.editFrom,"local")-V;if(X){var al=U;U=Z;Z=al}var Y=ac.orig.heightAtLine(ab.origTo,"local")-ag;var ah=ac.edit.heightAtLine(ab.editTo,"local")-V;if(X){var al=Y;Y=ah;ah=al}var af=" C "+aa/2+" "+Z+" "+aa/2+" "+U+" "+(aa+2)+" "+U;var ad=" C "+aa/2+" "+Y+" "+aa/2+" "+ah+" -1 "+ah;h(ac.svg.appendChild(document.createElementNS(F,"path")),"d","M -1 "+Z+af+" L "+(aa+2)+" "+Y+ad+" z","class",ac.classes.connect)}if(ac.copyButtons){var aj=ac.copyButtons.appendChild(L("div",ac.type=="left"?"\u21dd":"\u21dc","CodeMirror-merge-copy"));var ai=ac.mv.options.allowEditingOriginals;aj.title=ai?"Push to left":"Revert chunk";aj.chunk=ab;aj.style.top=ae+"px";if(ai){var ak=ac.orig.heightAtLine(ab.editFrom,"local")-V;var W=ac.copyButtons.appendChild(L("div",ac.type=="right"?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));W.title="Push to right";W.chunk={editFrom:ab.origFrom,editTo:ab.origTo,origFrom:ab.editFrom,origTo:ab.editTo};W.style.top=ak+"px";ac.type=="right"?W.style.left="2px":W.style.right="2px"}}}function p(V,X,W,U){if(V.diffOutOfDate){return}X.replaceRange(W.getRange(l(U.origFrom,0),l(U.origTo,0)),l(U.editFrom,0),l(U.editTo,0))}var t=u.MergeView=function(Z,aj){if(!(this instanceof t)){return new t(Z,aj)}this.options=aj;var ac=aj.origLeft,aa=aj.origRight==null?aj.orig:aj.origRight;var af=ac!=null,ak=aa!=null;var ad=1+(af?1:0)+(ak?1:0);var W=[],Y=this.left=null,ag=this.right=null;var ai=this;if(af){Y=this.left=new i(this,"left");var V=L("div",null,"CodeMirror-merge-pane");W.push(V);W.push(z(Y))}var ab=L("div",null,"CodeMirror-merge-pane");W.push(ab);if(ak){ag=this.right=new i(this,"right");W.push(z(ag));var ae=L("div",null,"CodeMirror-merge-pane");W.push(ae)}(ak?ae:ab).className+=" CodeMirror-merge-pane-rightmost";W.push(L("div",null,null,"height: 0; clear: both;"));var X=this.wrap=Z.appendChild(L("div",W,"CodeMirror-merge CodeMirror-merge-"+ad+"pane"));this.edit=u(ab,m(aj));if(Y){Y.init(V,ac,aj)}if(ag){ag.init(ae,aa,aj)}if(aj.collapseIdentical){this.editor().operation(function(){P(ai,aj.collapseIdentical)})}if(aj.connect=="align"){this.aligners=[];f(this.left||this.right,true)}var U=function(){if(Y){n(Y)}if(ag){n(ag)}};u.on(window,"resize",U);var ah=setInterval(function(){for(var al=X.parentNode;al&&al!=document.body;al=al.parentNode){}if(!al){clearInterval(ah);u.off(window,"resize",U)}},5000)};function z(X){var W=X.lockButton=L("div",null,"CodeMirror-merge-scrolllock");W.title="Toggle locked scrolling";var Y=L("div",[W],"CodeMirror-merge-scrolllock-wrap");u.on(W,"click",function(){r(X,!X.lockScroll)});var V=[Y];if(X.mv.options.revertButtons!==false){X.copyButtons=L("div",null,"CodeMirror-merge-copybuttons-"+X.type);u.on(X.copyButtons,"click",function(aa){var Z=aa.target||aa.srcElement;if(!Z.chunk){return}if(Z.className=="CodeMirror-merge-copy-reverse"){p(X,X.orig,X.edit,Z.chunk);return}p(X,X.edit,X.orig,Z.chunk)});V.unshift(X.copyButtons)}if(X.mv.options.connect!="align"){var U=document.createElementNS&&document.createElementNS(F,"svg");if(U&&!U.createSVGRect){U=null}X.svg=U;if(U){V.push(U)}}return X.gap=L("div",V,"CodeMirror-merge-gap")}t.prototype={constuctor:t,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(U){if(this.right){this.right.setShowDifferences(U)}if(this.left){this.left.setShowDifferences(U)}},rightChunks:function(){if(this.right){G(this.right);return this.right.chunks}},leftChunks:function(){if(this.left){G(this.left);return this.left.chunks}}};function A(U){if(typeof U=="string"){return U}else{return U.getValue()}}var D=new diff_match_patch();function b(V,U){var Y=D.diff_main(V,U);D.diff_cleanupSemantic(Y);for(var X=0;X<Y.length;++X){var W=Y[X];if(!W[1]){Y.splice(X--,1)}else{if(X&&Y[X-1][0]==W[0]){Y.splice(X--,1);Y[X][1]+=W[1]}}}return Y}function o(ah){var Z=[];var ae=0,ad=0;var ai=l(0,0),ag=l(0,0);for(var W=0;W<ah.length;++W){var V=ah[W],af=V[0];if(af==DIFF_EQUAL){var U=H(ah,W)?0:1;var Y=ai.line+U,X=ag.line+U;C(ai,V[1],null,ag);var aa=K(ah,W)?1:0;var ac=ai.line+aa,ab=ag.line+aa;if(ac>Y){if(W){Z.push({origFrom:ad,origTo:X,editFrom:ae,editTo:Y})}ae=ac;ad=ab}}else{C(af==DIFF_INSERT?ai:ag,V[1])}}if(ae<=ai.line||ad<=ag.line){Z.push({origFrom:ad,origTo:ag.line+1,editFrom:ae,editTo:ai.line+1})}return Z}function K(W,U){if(U==W.length-1){return true}var V=W[U+1][1];if(V.length==1||V.charCodeAt(0)!=10){return false}if(U==W.length-2){return true}V=W[U+2][1];return V.length>1&&V.charCodeAt(0)==10}function H(W,U){if(U==0){return true}var V=W[U-1][1];if(V.charCodeAt(V.length-1)!=10){return false}if(U==1){return true}V=W[U-2][1];return V.charCodeAt(V.length-1)==10}function S(Y,U,aa){var ac,ae,W,Z;for(var V=0;V<Y.length;V++){var ab=Y[V];var ad=aa?ab.editFrom:ab.origFrom;var X=aa?ab.editTo:ab.origTo;if(ae==null){if(ad>U){ae=ab.editFrom;Z=ab.origFrom}else{if(X>U){ae=ab.editTo;Z=ab.origTo}}}if(X<=U){ac=ab.editTo;W=ab.origTo}else{if(ad<=U){ac=ab.editFrom;W=ab.origFrom}}}return{edit:{before:ac,after:ae},orig:{before:W,after:Z}}}function w(V,Z,Y){V.addLineClass(Z,"wrap","CodeMirror-merge-collapsed-line");var W=document.createElement("span");W.className="CodeMirror-merge-collapsed-widget";W.title="Identical text collapsed. Click to expand.";var X=V.markText(l(Z,0),l(Y-1),{inclusiveLeft:true,inclusiveRight:true,replacedWith:W,clearOnEnter:true});function U(){X.clear();V.removeLineClass(Z,"wrap","CodeMirror-merge-collapsed-line")}u.on(W,"click",U);return{mark:X,clear:U}}function s(W,Z){var Y=[];function U(){for(var ab=0;ab<Y.length;ab++){Y[ab].clear()}}for(var V=0;V<Z.length;V++){var X=Z[V];var aa=w(X.cm,X.line,X.line+W);Y.push(aa);aa.mark.on("clear",U)}return Y[0].mark}function v(Y,Z,aa,U){for(var X=0;X<Y.chunks.length;X++){var W=Y.chunks[X];for(var V=W.editFrom-Z;V<W.editTo+Z;V++){var ab=V+aa;if(ab>=0&&ab<U.length){U[ab]=false}}}}function P(ad,X){if(typeof X!="number"){X=2}var Z=[],ac=ad.editor(),U=ac.firstLine();for(var V=U,aa=ac.lastLine();V<=aa;V++){Z.push(true)}if(ad.left){v(ad.left,X,U,Z)}if(ad.right){v(ad.right,X,U,Z)}for(var Y=0;Y<Z.length;Y++){if(Z[Y]){var af=Y+U;for(var ae=1;Y<Z.length-1&&Z[Y+1];Y++,ae++){}if(ae>X){var ab=[{line:af,cm:ac}];if(ad.left){ab.push({line:y(af,ad.left.chunks),cm:ad.left.orig})}if(ad.right){ab.push({line:y(af,ad.right.chunks),cm:ad.right.orig})}var W=s(ae,ab);if(ad.options.onCollapse){ad.options.onCollapse(ad,af,ae,W)}}}}}function L(U,Y,X,W){var Z=document.createElement(U);if(X){Z.className=X}if(W){Z.style.cssText=W}if(typeof Y=="string"){Z.appendChild(document.createTextNode(Y))}else{if(Y){for(var V=0;V<Y.length;++V){Z.appendChild(Y[V])}}}return Z}function E(V){for(var U=V.childNodes.length;U>0;--U){V.removeChild(V.firstChild)}}function h(U){for(var V=1;V<arguments.length;V+=2){U.setAttribute(arguments[V],arguments[V+1])}}function m(V,U){if(!U){U={}}for(var W in V){if(V.hasOwnProperty(W)){U[W]=V[W]}}return U}function C(aa,Y,Z,V){var X=Z?l(aa.line,aa.ch):aa,U=0;for(;;){var W=Y.indexOf("\n",U);if(W==-1){break}++X.line;if(V){++V.line}U=W+1}X.ch=(U?0:X.ch)+(Y.length-U);if(V){V.ch=(U?0:V.ch)+(Y.length-U)}return X}function j(V,U){return(V.line-U.line||V.ch-U.ch)<0?V:U}function I(V,U){return(V.line-U.line||V.ch-U.ch)>0?V:U}function N(V,U){return V.line==U.line&&V.ch==U.ch}function c(Z,Y,U){for(var W=Z.length-1;W>=0;W--){var V=Z[W];var X=(U?V.origTo:V.editTo)-1;if(X<Y){return X}}}function g(Z,Y,U){for(var W=0;W<Z.length;W++){var V=Z[W];var X=(U?V.origFrom:V.editFrom);if(X>Y){return X}}}function Q(Z,V){var ab=null,aa=Z.state.diffViews,ac=Z.getCursor().line;if(aa){for(var X=0;X<aa.length;X++){var U=aa[X],W=Z==U.orig;G(U);var Y=V<0?c(U.chunks,ac,W):g(U.chunks,ac,W);if(Y!=null&&(ab==null||(V<0?Y>ab:Y<ab))){ab=Y}}}if(ab!=null){Z.setCursor(ab,0)}else{return u.Pass}}u.commands.goNextDiff=function(U){return Q(U,1)};u.commands.goPrevDiff=function(U){return Q(U,-1)}});