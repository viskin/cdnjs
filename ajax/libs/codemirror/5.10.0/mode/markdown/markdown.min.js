(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../xml/xml","../meta"],a)}else{a(CodeMirror)}}})(function(a){a.defineMode("markdown",function(t,u){var n=a.modes.hasOwnProperty("xml");var h=a.getMode(t,n?{name:"xml",htmlMode:true}:"text/plain");function z(L){if(a.findModeByName){var M=a.findModeByName(L);if(M){L=M.mime||M.mimes[0]}}var N=a.getMode(t,L);return N.name=="null"?null:N}if(u.highlightFormatting===undefined){u.highlightFormatting=false}if(u.maxBlockquoteDepth===undefined){u.maxBlockquoteDepth=0}if(u.underscoresBreakWords===undefined){u.underscoresBreakWords=true}if(u.taskLists===undefined){u.taskLists=false}if(u.strikethrough===undefined){u.strikethrough=false}if(u.tokenTypeOverrides===undefined){u.tokenTypeOverrides={}}var i=0;var o={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"tag",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough"};for(var k in o){if(o.hasOwnProperty(k)&&u.tokenTypeOverrides[k]){o[k]=u.tokenTypeOverrides[k]}}var b=/^([*\-_])(?:\s*\1){2,}\s*$/,d=/^[*\-+]\s+/,x=/^[0-9]+([.)])\s+/,q=/^\[(x| )\](?=\s)/,H=u.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,K=/^ *(?:\={1,}|-{1,})\s*$/,w=/^[^#!\[\]*_\\<>` "'(~]+/,m=new RegExp("^("+(u.fencedCodeBlocks===true?"~~~+|```+":u.fencedCodeBlocks)+")[ \\t]*([\\w+#]*)");function I(N,M,L){M.f=M.inline=L;return L(N,M)}function y(N,M,L){M.f=M.block=L;return L(N,M)}function f(L){return !L||!/\S/.test(L.string)}function c(L){L.linkTitle=false;L.em=false;L.strong=false;L.strikethrough=false;L.quote=0;L.indentedCode=false;if(!n&&L.f==p){L.f=G;L.block=C}L.trailingSpace=0;L.trailingSpaceNewLine=false;L.prevLine=L.thisLine;L.thisLine=null;return null}function C(R,Q){var P=R.sol();var N=Q.list!==false,L=Q.indentedCode;Q.indentedCode=false;if(N){if(Q.indentationDiff>=0){if(Q.indentationDiff<4){Q.indentation-=Q.indentationDiff}Q.list=null}else{if(Q.indentation>0){Q.list=null;Q.listDepth=Math.floor(Q.indentation/4)}else{Q.list=false;Q.listDepth=0}}}var M=null;if(Q.indentationDiff>=4){R.skipToEnd();if(L||f(Q.prevLine)){Q.indentation-=4;Q.indentedCode=true;return o.code}else{return null}}else{if(R.eatSpace()){return null}else{if((M=R.match(H))&&M[1].length<=6){Q.header=M[1].length;if(u.highlightFormatting){Q.formatting="header"}Q.f=Q.inline;return r(Q)}else{if(!f(Q.prevLine)&&!Q.quote&&!N&&!L&&(M=R.match(K))){Q.header=M[0].charAt(0)=="="?1:2;if(u.highlightFormatting){Q.formatting="header"}Q.f=Q.inline;return r(Q)}else{if(R.eat(">")){Q.quote=P?1:Q.quote+1;if(u.highlightFormatting){Q.formatting="quote"}R.eatSpace();return r(Q)}else{if(R.peek()==="["){return I(R,Q,e)}else{if(R.match(b,true)){Q.hr=true;return o.hr}else{if((f(Q.prevLine)||N)&&(R.match(d,false)||R.match(x,false))){var O=null;if(R.match(d,true)){O="ul"}else{R.match(x,true);O="ol"}Q.indentation=R.column()+R.current().length;Q.list=true;Q.listDepth++;if(u.taskLists&&R.match(q,false)){Q.taskList=true}Q.f=Q.inline;if(u.highlightFormatting){Q.formatting=["list","list-"+O]}return r(Q)}else{if(u.fencedCodeBlocks&&(M=R.match(m,true))){Q.fencedChars=M[1];Q.localMode=z(M[2]);if(Q.localMode){Q.localState=Q.localMode.startState()}Q.f=Q.block=B;if(u.highlightFormatting){Q.formatting="code-block"}Q.code=true;return r(Q)}}}}}}}}}return I(R,Q,Q.inline)}function p(N,M){var L=h.token(N,M.htmlState);if((n&&M.htmlState.tagStart===null&&(!M.htmlState.context&&M.htmlState.tokenize.isInText))||(M.md_inside&&N.current().indexOf(">")>-1)){M.f=G;M.block=C;M.htmlState=null}return L}function B(M,L){if(M.sol()&&L.fencedChars&&M.match(L.fencedChars,false)){L.localMode=L.localState=null;L.f=L.block=F;return null}else{if(L.localMode){return L.localMode.token(M,L.localState)}else{M.skipToEnd();return o.code}}}function F(N,M){N.match(M.fencedChars);M.block=C;M.f=G;M.fencedChars=null;if(u.highlightFormatting){M.formatting="code-block"}M.code=true;var L=r(M);M.code=false;return L}function r(O){var N=[];if(O.formatting){N.push(o.formatting);if(typeof O.formatting==="string"){O.formatting=[O.formatting]}for(var L=0;L<O.formatting.length;L++){N.push(o.formatting+"-"+O.formatting[L]);if(O.formatting[L]==="header"){N.push(o.formatting+"-"+O.formatting[L]+"-"+O.header)}if(O.formatting[L]==="quote"){if(!u.maxBlockquoteDepth||u.maxBlockquoteDepth>=O.quote){N.push(o.formatting+"-"+O.formatting[L]+"-"+O.quote)}else{N.push("error")}}}}if(O.taskOpen){N.push("meta");return N.length?N.join(" "):null}if(O.taskClosed){N.push("property");return N.length?N.join(" "):null}if(O.linkHref){N.push(o.linkHref,"url")}else{if(O.strong){N.push(o.strong)}if(O.em){N.push(o.em)}if(O.strikethrough){N.push(o.strikethrough)}if(O.linkText){N.push(o.linkText)}if(O.code){N.push(o.code)}}if(O.header){N.push(o.header,o.header+"-"+O.header)}if(O.quote){N.push(o.quote);if(!u.maxBlockquoteDepth||u.maxBlockquoteDepth>=O.quote){N.push(o.quote+"-"+O.quote)}else{N.push(o.quote+"-"+u.maxBlockquoteDepth)}}if(O.list!==false){var M=(O.listDepth-1)%3;if(!M){N.push(o.list1)}else{if(M===1){N.push(o.list2)}else{N.push(o.list3)}}}if(O.trailingSpaceNewLine){N.push("trailing-space-new-line")}else{if(O.trailingSpace){N.push("trailing-space-"+(O.trailingSpace%2?"a":"b"))}}return N.length?N.join(" "):null}function l(M,L){if(M.match(w,true)){return r(L)}return undefined}function G(Q,P){var ab=P.text(Q,P);if(typeof ab!=="undefined"){return ab}if(P.list){P.list=null;return r(P)}if(P.taskList){var X=Q.match(q,true)[1]!=="x";if(X){P.taskOpen=true}else{P.taskClosed=true}if(u.highlightFormatting){P.formatting="task"}P.taskList=false;return r(P)}P.taskOpen=false;P.taskClosed=false;if(P.header&&Q.match(/^#+$/,true)){if(u.highlightFormatting){P.formatting="header"}return r(P)}var L=Q.sol();var U=Q.next();if(U==="\\"){Q.next();if(u.highlightFormatting){var N=r(P);var T=o.formatting+"-escape";return N?N+" "+T:T}}if(P.linkTitle){P.linkTitle=false;var aa=U;if(U==="("){aa=")"}aa=(aa+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var M="^\\s*(?:[^"+aa+"\\\\]+|\\\\\\\\|\\\\.)"+aa;if(Q.match(new RegExp(M),true)){return o.linkHref}}if(U==="`"){var Z=P.formatting;if(u.highlightFormatting){P.formatting="code"}var V=r(P);var W=Q.pos;Q.eatWhile("`");var ac=1+Q.pos-W;if(!P.code){i=ac;P.code=true;return r(P)}else{if(ac===i){P.code=false;return V}P.formatting=Z;return r(P)}}else{if(P.code){return r(P)}}if(U==="!"&&Q.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){Q.match(/\[[^\]]*\]/);P.inline=P.f=v;return o.image}if(U==="["&&Q.match(/.*\](\(.*\)| ?\[.*\])/,false)){P.linkText=true;if(u.highlightFormatting){P.formatting="link"}return r(P)}if(U==="]"&&P.linkText&&Q.match(/\(.*\)| ?\[.*\]/,false)){if(u.highlightFormatting){P.formatting="link"}var N=r(P);P.linkText=false;P.inline=P.f=v;return N}if(U==="<"&&Q.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){P.f=P.inline=E;if(u.highlightFormatting){P.formatting="link"}var N=r(P);if(N){N+=" "}else{N=""}return N+o.linkInline}if(U==="<"&&Q.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){P.f=P.inline=E;if(u.highlightFormatting){P.formatting="link"}var N=r(P);if(N){N+=" "}else{N=""}return N+o.linkEmail}if(U==="<"&&Q.match(/^(!--|\w)/,false)){var O=Q.string.indexOf(">",Q.pos);if(O!=-1){var Y=Q.string.substring(Q.start,O);if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(Y)){P.md_inside=true}}Q.backUp(1);P.htmlState=a.startState(h);return y(Q,P,p)}if(U==="<"&&Q.match(/^\/\w*?>/)){P.md_inside=false;return"tag"}var S=false;if(!u.underscoresBreakWords){if(U==="_"&&Q.peek()!=="_"&&Q.match(/(\w)/,false)){var R=Q.pos-2;if(R>=0){var ad=Q.string.charAt(R);if(ad!=="_"&&ad.match(/(\w)/,false)){S=true}}}}if(U==="*"||(U==="_"&&!S)){if(L&&Q.peek()===" "){}else{if(P.strong===U&&Q.eat(U)){if(u.highlightFormatting){P.formatting="strong"}var V=r(P);P.strong=false;return V}else{if(!P.strong&&Q.eat(U)){P.strong=U;if(u.highlightFormatting){P.formatting="strong"}return r(P)}else{if(P.em===U){if(u.highlightFormatting){P.formatting="em"}var V=r(P);P.em=false;return V}else{if(!P.em){P.em=U;if(u.highlightFormatting){P.formatting="em"}return r(P)}}}}}}else{if(U===" "){if(Q.eat("*")||Q.eat("_")){if(Q.peek()===" "){return r(P)}else{Q.backUp(1)}}}}if(u.strikethrough){if(U==="~"&&Q.eatWhile(U)){if(P.strikethrough){if(u.highlightFormatting){P.formatting="strikethrough"}var V=r(P);P.strikethrough=false;return V}else{if(Q.match(/^[^\s]/,false)){P.strikethrough=true;if(u.highlightFormatting){P.formatting="strikethrough"}return r(P)}}}else{if(U===" "){if(Q.match(/^~~/,true)){if(Q.peek()===" "){return r(P)}else{Q.backUp(2)}}}}}if(U===" "){if(Q.match(/ +$/,false)){P.trailingSpace++}else{if(P.trailingSpace){P.trailingSpaceNewLine=true}}}return r(P)}function E(O,N){var M=O.next();if(M===">"){N.f=N.inline=G;if(u.highlightFormatting){N.formatting="link"}var L=r(N);if(L){L+=" "}else{L=""}return L+o.linkInline}O.match(/^[^>]+/,true);return o.linkInline}function v(N,M){if(N.eatSpace()){return null}var L=N.next();if(L==="("||L==="["){M.f=M.inline=D(L==="("?")":"]");if(u.highlightFormatting){M.formatting="link-string"}M.linkHref=true;return r(M)}return"error"}function D(L){return function(P,O){var N=P.next();if(N===L){O.f=O.inline=G;if(u.highlightFormatting){O.formatting="link-string"}var M=r(O);O.linkHref=false;return M}if(P.match(s(L),true)){P.backUp(1)}O.linkHref=true;return r(O)}}function e(M,L){if(M.match(/^([^\]\\]|\\.)*\]:/,false)){L.f=A;M.next();if(u.highlightFormatting){L.formatting="link"}L.linkText=true;return r(L)}return I(M,L,G)}function A(N,M){if(N.match(/^\]:/,true)){M.f=M.inline=g;if(u.highlightFormatting){M.formatting="link"}var L=r(M);M.linkText=false;return L}N.match(/^([^\]\\]|\\.)+/,true);return o.linkText}function g(M,L){if(M.eatSpace()){return null}M.match(/^[^\s]+/,true);if(M.peek()===undefined){L.linkTitle=true}else{M.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}L.f=L.inline=G;return o.linkHref+" url"}var J=[];function s(L){if(!J[L]){L=(L+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");J[L]=new RegExp("^(?:[^\\\\]|\\\\.)*?("+L+")")}return J[L]}var j={startState:function(){return{f:C,prevLine:null,thisLine:null,block:C,htmlState:null,indentation:0,inline:G,text:l,formatting:false,linkText:false,linkHref:false,linkTitle:false,em:false,strong:false,header:0,hr:false,taskList:false,list:false,listDepth:0,quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false,fencedChars:null}},copyState:function(L){return{f:L.f,prevLine:L.prevLine,thisLine:L.thisLine,block:L.block,htmlState:L.htmlState&&a.copyState(h,L.htmlState),indentation:L.indentation,localMode:L.localMode,localState:L.localMode?a.copyState(L.localMode,L.localState):null,inline:L.inline,text:L.text,formatting:false,linkTitle:L.linkTitle,code:L.code,em:L.em,strong:L.strong,strikethrough:L.strikethrough,header:L.header,hr:L.hr,taskList:L.taskList,list:L.list,listDepth:L.listDepth,quote:L.quote,indentedCode:L.indentedCode,trailingSpace:L.trailingSpace,trailingSpaceNewLine:L.trailingSpaceNewLine,md_inside:L.md_inside,fencedChars:L.fencedChars}},token:function(P,O){O.formatting=false;if(P!=O.thisLine){var L=O.header||O.hr;O.header=0;O.hr=false;if(P.match(/^\s*$/,true)||L){c(O);if(!L){return null}O.prevLine=null}O.prevLine=O.thisLine;O.thisLine=P;O.taskList=false;O.trailingSpace=0;O.trailingSpaceNewLine=false;O.f=O.block;var M=P.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;var Q=Math.floor((M-O.indentation)/4)*4;if(Q>4){Q=4}var N=O.indentation+Q;O.indentationDiff=N-O.indentation;O.indentation=N;if(M>0){return null}}return O.f(P,O)},innerMode:function(L){if(L.block==p){return{state:L.htmlState,mode:h}}if(L.localState){return{state:L.localState,mode:L.localMode}}return{state:L,mode:j}},blankLine:c,getType:r,fold:"markdown"};return j},"xml");a.defineMIME("text/x-markdown","markdown")});