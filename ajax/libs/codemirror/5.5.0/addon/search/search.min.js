(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a)}else{a(CodeMirror)}}})(function(l){function i(u,t){if(typeof u=="string"){u=new RegExp(u.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g")}else{if(!u.global){u=new RegExp(u.source,u.ignoreCase?"gi":"g")}}return{token:function(w){u.lastIndex=w.pos;var v=u.exec(w.string);if(v&&v.index==w.pos){w.pos+=v[0].length;return"searching"}else{if(v){w.pos=v.index}else{w.skipToEnd()}}}}}function h(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function q(t){return t.state.search||(t.state.search=new h())}function d(t){return typeof t=="string"&&t==t.toLowerCase()}function b(t,u,v){return t.getSearchCursor(u,v,d(u))}function c(t,v,w,u){t.openDialog(v,u,{value:w,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){o(t)}})}function n(t,w,u,x,v){if(t.openDialog){t.openDialog(w,v,{value:x,selectValueOnOpen:true})}else{v(prompt(u,x))}}function j(u,w,v,t){if(u.openConfirm){u.openConfirm(w,t)}else{if(confirm(v)){t[0]()}}}function g(u){var t=u.match(/^\/(.*)\/([a-z]*)$/);if(t){try{u=new RegExp(t[1],t[2].indexOf("i")==-1?"":"i")}catch(v){}}if(typeof u=="string"?u=="":u.test("")){u=/x^/}return u}var s='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function r(t,v,u){v.queryText=u;v.query=g(u);t.removeOverlay(v.overlay,d(v.query));v.overlay=i(v.query,d(v.query));t.addOverlay(v.overlay);if(t.showMatchesOnScrollbar){if(v.annotate){v.annotate.clear();v.annotate=null}v.annotate=t.showMatchesOnScrollbar(v.query,d(v.query))}}function k(t,v,u){var x=q(t);if(x.query){return e(t,v)}var w=t.getSelection()||x.lastQuery;if(u&&t.openDialog){c(t,s,w,function(z,y){l.e_stop(y);if(!z){return}if(z!=x.queryText){r(t,x,z)}e(t,y.shiftKey)})}else{n(t,s,"Search for:",w,function(y){if(y&&!x.query){t.operation(function(){r(t,x,y);x.posFrom=x.posTo=t.getCursor();e(t,v)})}})}}function e(t,u){t.operation(function(){var v=q(t);var w=b(t,v.query,u?v.posFrom:v.posTo);if(!w.find(u)){w=b(t,v.query,u?l.Pos(t.lastLine()):l.Pos(t.firstLine(),0));if(!w.find(u)){return}}t.setSelection(w.from(),w.to());t.scrollIntoView({from:w.from(),to:w.to()},20);v.posFrom=w.from();v.posTo=w.to()})}function o(t){t.operation(function(){var u=q(t);u.lastQuery=u.query;if(!u.query){return}u.query=u.queryText=null;t.removeOverlay(u.overlay);if(u.annotate){u.annotate.clear();u.annotate=null}})}var a='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var f='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var m="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function p(t,u){if(t.getOption("readOnly")){return}var v=t.getSelection()||q(t).lastQuery;n(t,a,"Replace:",v,function(w){if(!w){return}w=g(w);n(t,f,"Replace with:","",function(A){if(u){t.operation(function(){for(var C=b(t,w);C.findNext();){if(typeof w!="string"){var B=t.getRange(C.from(),C.to()).match(w);C.replace(A.replace(/\$(\d)/g,function(D,E){return B[E]}))}else{C.replace(A)}}})}else{o(t);var z=b(t,w,t.getCursor());var y=function(){var C=z.from(),B;if(!(B=z.findNext())){z=b(t,w);if(!(B=z.findNext())||(C&&z.from().line==C.line&&z.from().ch==C.ch)){return}}t.setSelection(z.from(),z.to());t.scrollIntoView({from:z.from(),to:z.to()});j(t,m,"Replace?",[function(){x(B)},y])};var x=function(B){z.replace(typeof w=="string"?A:A.replace(/\$(\d)/g,function(C,D){return B[D]}));y()};y()}})})}l.commands.find=function(t){o(t);k(t)};l.commands.findPersistent=function(t){o(t);k(t,false,true)};l.commands.findNext=k;l.commands.findPrev=function(t){k(t,true)};l.commands.clearSearch=o;l.commands.replace=p;l.commands.replaceAll=function(t){p(t,true)}});