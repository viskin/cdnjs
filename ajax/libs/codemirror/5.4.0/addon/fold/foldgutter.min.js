(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./foldcode"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./foldcode"],a)}else{a(CodeMirror)}}})(function(d){d.defineOption("foldGutter",false,function(m,o,n){if(n&&n!=d.Init){m.clearGutter(m.state.foldGutter.options.gutter);m.state.foldGutter=null;m.off("gutterClick",k);m.off("change",g);m.off("viewportChange",l);m.off("fold",e);m.off("unfold",e);m.off("swapDoc",b)}if(o){m.state.foldGutter=new j(i(o));b(m);m.on("gutterClick",k);m.on("change",g);m.on("viewportChange",l);m.on("fold",e);m.on("unfold",e);m.on("swapDoc",b)}});var h=d.Pos;function j(m){this.options=m;this.from=this.to=0}function i(m){if(m===true){m={}}if(m.gutter==null){m.gutter="CodeMirror-foldgutter"}if(m.indicatorOpen==null){m.indicatorOpen="CodeMirror-foldgutter-open"}if(m.indicatorFolded==null){m.indicatorFolded="CodeMirror-foldgutter-folded"}return m}function c(m,n){var p=m.findMarksAt(h(n));for(var o=0;o<p.length;++o){if(p[o].__isFold&&p[o].find().from.line==n){return p[o]}}}function f(m){if(typeof m=="string"){var n=document.createElement("div");n.className=m+" CodeMirror-guttermarker-subtle";return n}else{return m.cloneNode(true)}}function a(m,s,r){var o=m.state.foldGutter.options,q=s;var p=m.foldOption(o,"minFoldSize");var n=m.foldOption(o,"rangeFinder");m.eachLine(s,r,function(t){var w=null;if(c(m,q)){w=f(o.indicatorFolded)}else{var v=h(q,0);var u=n&&n(m,v);if(u&&u.to.line-u.from.line>=p){w=f(o.indicatorOpen)}}m.setGutterMarker(t,o.gutter,w);++q})}function b(m){var n=m.getViewport(),o=m.state.foldGutter;if(!o){return}m.operation(function(){a(m,n.from,n.to)});o.from=n.from;o.to=n.to}function k(m,n,q){var p=m.state.foldGutter;if(!p){return}var o=p.options;if(q!=o.gutter){return}var r=c(m,n);if(r){r.clear()}else{m.foldCode(h(n,0),o.rangeFinder)}}function g(m){var o=m.state.foldGutter;if(!o){return}var n=o.options;o.from=o.to=0;clearTimeout(o.changeUpdate);o.changeUpdate=setTimeout(function(){b(m)},n.foldOnChangeTimeSpan||600)}function l(m){var o=m.state.foldGutter;if(!o){return}var n=o.options;clearTimeout(o.changeUpdate);o.changeUpdate=setTimeout(function(){var p=m.getViewport();if(o.from==o.to||p.from-o.to>20||o.from-p.to>20){b(m)}else{m.operation(function(){if(p.from<o.from){a(m,p.from,o.from);o.from=p.from}if(p.to>o.to){a(m,o.to,p.to);o.to=p.to}})}},n.updateViewportTimeSpan||400)}function e(m,p){var o=m.state.foldGutter;if(!o){return}var n=p.line;if(n>=o.from&&n<o.to){a(m,n,n+1)}}});