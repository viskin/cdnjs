(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],a)}else{a(CodeMirror)}}})(function(m){function j(v,u){if(typeof v=="string"){v=new RegExp(v.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),u?"gi":"g")}else{if(!v.global){v=new RegExp(v.source,v.ignoreCase?"gi":"g")}}return{token:function(x){v.lastIndex=x.pos;var w=v.exec(x.string);if(w&&w.index==x.pos){x.pos+=w[0].length;return"searching"}else{if(w){x.pos=w.index}else{x.skipToEnd()}}}}}function i(){this.posFrom=this.posTo=this.lastQuery=this.query=null;this.overlay=null}function r(u){return u.state.search||(u.state.search=new i())}function d(u){return typeof u=="string"&&u==u.toLowerCase()}function b(u,v,w){return u.getSearchCursor(v,w,d(v))}function c(u,w,x,v){u.openDialog(w,v,{value:x,selectValueOnOpen:true,closeOnEnter:false,onClose:function(){p(u)}})}function o(u,x,v,y,w){if(u.openDialog){u.openDialog(x,w,{value:y,selectValueOnOpen:true})}else{w(prompt(v,y))}}function k(v,x,w,u){if(v.openConfirm){v.openConfirm(x,u)}else{if(confirm(w)){u[0]()}}}function h(u){return u.replace(/\\(.)/g,function(v,w){if(w=="n"){return"\n"}if(w=="r"){return"\r"}return w})}function g(v){var u=v.match(/^\/(.*)\/([a-z]*)$/);if(u){try{v=new RegExp(u[1],u[2].indexOf("i")==-1?"":"i")}catch(w){}}else{v=h(v)}if(typeof v=="string"?v=="":v.test("")){v=/x^/}return v}var t='Search: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function s(u,w,v){w.queryText=v;w.query=g(v);u.removeOverlay(w.overlay,d(w.query));w.overlay=j(w.query,d(w.query));u.addOverlay(w.overlay);if(u.showMatchesOnScrollbar){if(w.annotate){w.annotate.clear();w.annotate=null}w.annotate=u.showMatchesOnScrollbar(w.query,d(w.query))}}function l(u,w,v){var y=r(u);if(y.query){return e(u,w)}var x=u.getSelection()||y.lastQuery;if(v&&u.openDialog){c(u,t,x,function(A,z){m.e_stop(z);if(!A){return}if(A!=y.queryText){s(u,y,A)}e(u,z.shiftKey)})}else{o(u,t,"Search for:",x,function(z){if(z&&!y.query){u.operation(function(){s(u,y,z);y.posFrom=y.posTo=u.getCursor();e(u,w)})}})}}function e(u,v){u.operation(function(){var w=r(u);var x=b(u,w.query,v?w.posFrom:w.posTo);if(!x.find(v)){x=b(u,w.query,v?m.Pos(u.lastLine()):m.Pos(u.firstLine(),0));if(!x.find(v)){return}}u.setSelection(x.from(),x.to());u.scrollIntoView({from:x.from(),to:x.to()},20);w.posFrom=x.from();w.posTo=x.to()})}function p(u){u.operation(function(){var v=r(u);v.lastQuery=v.query;if(!v.query){return}v.query=v.queryText=null;u.removeOverlay(v.overlay);if(v.annotate){v.annotate.clear();v.annotate=null}})}var a='Replace: <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';var f='With: <input type="text" style="width: 10em" class="CodeMirror-search-field"/>';var n="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";function q(u,v){if(u.getOption("readOnly")){return}var w=u.getSelection()||r(u).lastQuery;o(u,a,"Replace:",w,function(x){if(!x){return}x=g(x);o(u,f,"Replace with:","",function(B){B=h(B);if(v){u.operation(function(){for(var D=b(u,x);D.findNext();){if(typeof x!="string"){var C=u.getRange(D.from(),D.to()).match(x);D.replace(B.replace(/\$(\d)/g,function(E,F){return C[F]}))}else{D.replace(B)}}})}else{p(u);var A=b(u,x,u.getCursor());var z=function(){var D=A.from(),C;if(!(C=A.findNext())){A=b(u,x);if(!(C=A.findNext())||(D&&A.from().line==D.line&&A.from().ch==D.ch)){return}}u.setSelection(A.from(),A.to());u.scrollIntoView({from:A.from(),to:A.to()});k(u,n,"Replace?",[function(){y(C)},z])};var y=function(C){A.replace(typeof x=="string"?B:B.replace(/\$(\d)/g,function(D,E){return C[E]}));z()};z()}})})}m.commands.find=function(u){p(u);l(u)};m.commands.findPersistent=function(u){p(u);l(u,false,true)};m.commands.findNext=l;m.commands.findPrev=function(u){l(u,true)};m.commands.clearSearch=p;m.commands.replace=q;m.commands.replaceAll=function(u){q(u,true)}});