// Backbone.Epoxy 0.12.0
// (c) 2013 Greg MacWilliam
// Freely distributed under the MIT license
// http://epoxyjs.org
(function(t,e){var n="backbone",i="underscore";"undefined"!=typeof exports?module.exports=e(require(i),require(n)):"function"==typeof define&&define.amd?define([i,n],e):e(t._,t.Backbone)})(this,function(t,e){function n(t){return function(e,n,i){return t.prototype[n].apply(e,i)}}function i(e,n,r,o){for(var s in n)if(n.hasOwnProperty(s)){var u=n[s];if(e.hasComputed(s)){if(o.length&&!(0>t.indexOf(o,s)))throw"Recursive setter: "+o.join(" > ");u=e.c()[s].set(u),u&&C(u)&&(r=i(e,u,r,o.slice().concat([s])))}else r[s]=u}return r}function r(e){return O(e)?e.slice():C(e)?t.clone(e):e}function o(t,e){for(var n=0,i=e.length;i>n;n++)e[n]=t.get(e[n]);return e}function s(e,n,i,r){i=i||{},i.get&&x(i.get)&&(i._get=i.get),i.set&&x(i.set)&&(i._set=i.set),delete i.get,delete i.set,t.extend(this,i),this.model=e,this.name=n,this.deps=this.deps||[],r||this.init()}function u(e){return x(e)?e():(C(e)&&(e=O(e)?e.slice():t.clone(e),t.each(e,function(t,n){e[n]=u(t)})),e)}function c(t){return x(t)?{set:t}:t}function a(t){return function(){var e=arguments,n=x(t)?t:t.read,i=t.write;return function(t){return _(t)?n.apply(this,l(e)):e[0]((i?i:n).call(this,t))}}}function l(t){for(var e=[],n=0,i=t.length;i>n;n++)e.push(u(t[n]));return e}function h(e,n,i,r){return(e=t.result(e,i))?(k(e)?(r=r?r+"_":"",n["$"+i]=function(){return N&&N.push([e,"change"]),e},t.each(e.toJSON({computed:!0}),function(t,i){n[r+i]=function(t){return f(e,i,t)}})):B(e)&&(n["$"+i]=function(){return N&&N.push([e,"reset add remove sort update"]),e}),e):void 0}function f(t,e,n){return N&&N.push([t,"change:"+e]),_(n)?t.get(e):C(n)&&!O(n)?t.set(n):t.set(e,n)}function d(t,e){var n=t.$(e);return t.$el.is(e)&&(n=n.add(t.$el)),n}function p(e,n,i,r,o,s){try{var u=Function("$f","$c","with($f){with($c){return{"+i+"}}}")(s,r)}catch(c){throw"Error parsing bindings: "+i}var a=t.map(t.union(u.events||[],["change"]),function(t){return t+".epoxy"}).join(" ");t.each(u,function(t,i){o.hasOwnProperty(i)&&e.b().push(new m(n,o[i],t,a,r,u))})}function g(t,e,n,i){if(e.callee.caller.id===n)throw"recursive access error: "+n;return t&&t.hasOwnProperty(n)?_(i)?u(t[n]):t[n](i):void 0}function v(t,e){var n=[];if(e&&t)for(var i=0,r=e.length;r>i;i++)n.push(e[i]in t?t[e[i]]():null);return n}function m(e,n,i,r,o,s){var c=this,a=e[0].tagName.toLowerCase(),l="input"==a||"select"==a||"textarea"==a,h=[],f=function(t){c.set(c.$el,u(i),t)};if(c.$el=e,c.evt=r,t.extend(c,n),i=c.init(c.$el,u(i),o,s)||i,N=h,f(),N=null,l&&n.get&&x(i)&&c.$el.on(r,function(){i(c.get(c.$el,u(i)))}),h.length)for(var d=0,p=h.length;p>d;d++)c.listenTo(h[d][0],h[d][1],f)}var y,b=e.Epoxy={},w=Array.prototype,_=t.isUndefined,x=t.isFunction,C=t.isObject,O=t.isArray,k=function(t){return t instanceof e.Model},B=function(t){return t instanceof e.Collection},P=function(){},E={mixin:function(t){var e=this.prototype;t=t||{};for(var n in e)e.hasOwnProperty(n)&&"constructor"!==n&&(t[n]=e[n]);return t}},S=n(e.Model),M=["computeds"];b.Model=e.Model.extend({constructor:function(e,n){t.extend(this,t.pick(n||{},M)),S(this,"constructor",arguments),this.initComputeds()},getCopy:function(t){return r(this.get(t))},get:function(t){return y&&y.push(["change:"+t,this]),this.hasComputed(t)?this.c()[t].get():S(this,"get",arguments)},set:function(t,e,n){var r=t;return r&&!C(r)?(r={},r[t]=e):n=e,n=n||{},n.unset||(r=i(this,r,{},[])),S(this,"set",[r,n])},toJSON:function(e){var n=S(this,"toJSON",arguments);return e&&e.computed&&t.each(this.c(),function(t,e){n[e]=t.value}),n},destroy:function(){return this.clearComputeds(),S(this,"destroy",arguments)},c:function(){return this._c||(this._c={})},initComputeds:function(){this.clearComputeds(),t.each(t.result(this,"computeds")||{},function(t,e){t._init=1,this.addComputed(e,t)},this),t.invoke(this.c(),"init")},addComputed:function(t,e,n){this.removeComputed(t);var i=e,r=i._init;if(x(e)){var o=2;i={},i._get=e,x(n)&&(i._set=n,o++),i.deps=w.slice.call(arguments,o)}return this.c()[t]=new s(this,t,i,r),this},hasComputed:function(t){return this.c().hasOwnProperty(t)},removeComputed:function(t){return this.hasComputed(t)&&(this.c()[t].dispose(),delete this.c()[t]),this},clearComputeds:function(){for(var t in this.c())this.removeComputed(t);return this},modifyArray:function(t,e){var n=this.get(t);if(O(n)&&x(w[e])){var i=w.slice.call(arguments,2),r=w[e].apply(n,i);return this.trigger("change change:"+t),r}return null},modifyObject:function(t,e,n){var i=this.get(t),r=!1;return C(i)?(_(n)&&i.hasOwnProperty(e)?(delete i[e],r=!0):i[e]!==n&&(i[e]=n,r=!0),r&&this.trigger("change change:"+t),i):null}},E),t.extend(s.prototype,e.Events,{init:function(){var e={},n=y=[];this.get(!0),y=null,n.length&&(t.each(n,function(n){var i=n[0],r=n[1];e[i]?t.contains(e[i],r)||e[i].push(r):e[i]=[r]}),t.each(e,function(e,n){for(var i=0,r=e.length;r>i;i++)this.listenTo(e[i],n,t.bind(this.get,this,!0))},this))},get:function(t){if(t===!0&&this._get){var e=this._get.apply(this.model,o(this.model,this.deps.slice()));this.change(e)}return this.value},set:function(t){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed attribute."}return this.change(t),null},fire:function(){this.model.trigger("change change:"+this.name)},change:function(e){t.isEqual(e,this.value)||(this.value=e,this.fire())},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var q={optionText:"label",optionValue:"value"},F={attr:{set:function(t,e){t.attr(e)}},checked:{get:function(e,n){var i=!!e.prop("checked"),r=e.val();if(e.is(":radio"))return r;if(O(n)){n=n.slice();var o=t.indexOf(n,r);return i&&0>o?n.push(r):!i&&o>-1&&n.splice(o,1),n}return i},set:function(e,n){var i=!!n;e.is(":radio")?i=n==e.val():O(n)&&(i=t.contains(n,e.val())),e.prop("checked",i)}},classes:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},collection:{init:function(t,e){if(!B(e)||!x(e.view))throw"Binding 'collection' requires a Collection with a 'view' constructor.";this.v={}},set:function(e,n,i){var r,o=n.models,s=this.v;if(i=i||n,k(i))if(s.hasOwnProperty(i.cid))r=s[i.cid],r.remove(),delete s[i.cid];else{s[i.cid]=r=new n.view({model:i});var u=t.indexOf(o,i);u>e.children().length?e.eq(u).before(r.$el):e.append(r.$el)}else if(B(i)){var c=o.length&&t.every(o,function(t){return s.hasOwnProperty(t.cid)});e.hide(),c?n.each(function(t){e.append(s[t.cid].$el)}):(this.clean(),n.each(function(t){s[t.cid]=r=new n.view({model:t}),e.append(r.$el)})),e.show()}},clean:function(){for(var t in this.v)this.v.hasOwnProperty(t)&&(this.v[t].remove(),delete this.v[t])}},css:{set:function(t,e){t.css(e)}},disabled:{set:function(t,e){t.prop("disabled",!!e)}},enabled:{set:function(t,e){t.prop("disabled",!e)}},html:{set:function(t,e){t.html(e)}},options:{init:function(t,e,n,i){this.e=i.optionsEmpty,this.d=i.optionsDefault,this.v=i.value},set:function(e,n){var i=this,r=u(i.e),o=u(i.d),s=u(i.v),c=O(s)?s:[s],a=B(n)?n.models:n,l=a.length,h=!0,f="";l||o||!r?(o&&(a=[o].concat(a)),t.each(a,function(t){f+=i.opt(t,l,c)})):(f+=i.opt(r,l,c),h=!1),e.html(f).prop("disabled",!h);var d=e.val();i.v&&!t.isEqual(s,d)&&i.v(d)},opt:function(e,n,i){var r=e,o=e,s=q.optionText,u=q.optionValue;C(e)&&(r=k(e)?e.get(s):e[s],o=k(e)?e.get(u):e[u]);var c=!n||t.contains(i,o)?"' selected='selected'>":"'>";return"<option value='"+o+c+r+"</option>"},clean:function(){this.d=this.e=this.v=null}},template:{init:function(e,n,i){var r=e.find("script,template");return this.tmpl=t.template(r.length?r.html():e.html()),O(n)?t.pick(i,n):void 0},set:function(t,e){e=k(e)?e.toJSON({computed:!0}):e,t.html(this.tmpl(e))},clean:function(){this.tmpl=null}},text:{set:function(t,e){t.text(e)}},toggle:{set:function(t,e){t.toggle(!!e)}},value:{get:function(t){return t.val()},set:function(t,e){try{t.val()!=e&&t.val(e)}catch(n){}}}},j={all:a(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(!t[e])return!1;return!0}),any:a(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(t[e])return!0;return!1}),length:a(function(t){return t.length||0}),none:a(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(t[e])return!1;return!0}),not:a(function(t){return!t}),format:a(function(t){for(var e=arguments,n=1,i=e.length;i>n;n++)t=t.replace(RegExp("\\$"+n,"g"),e[n]);return t}),select:a(function(t,e,n){return t?e:n}),csv:a({read:function(t){return t+="",t?t.split(","):[]},write:function(t){return O(t)?t.join(","):t}}),integer:a(function(t){return t?parseInt(t,10):0}),decimal:a(function(t){return t?parseFloat(t):0})};b.binding={addHandler:function(t,e){F[t]=c(e)},addFilter:function(t,e){j[t]=a(e)},config:function(e){t.extend(q,e)}};var N,V=n(e.View),J=["viewModel","bindings","bindingFilters","bindingHandlers","bindingSources","computeds"];return b.View=e.View.extend({constructor:function(e){t.extend(this,t.pick(e||{},J)),V(this,"constructor",arguments),this.applyBindings()},b:function(){return this._b||(this._b=[])},bindings:"data-bind",applyBindings:function(){if(this.removeBindings(),this.model||this.collection||this.bindingSources){var e=this,n=t.clone(t.result(e,"bindingSources")),i=e.bindings,r=t.clone(F),o=t.clone(j),s=e._c={};t.each(t.result(e,"bindingHandlers")||{},function(t,e){r[e]=c(t)}),t.each(t.result(e,"bindingFilters")||{},function(t,e){o[e]=a(t)}),e.model=h(e,s,"model"),e.viewModel=h(e,s,"viewModel"),e.collection=h(e,s,"collection"),n&&(t.each(n,function(t,e){n[e]=h(n,s,e,e)}),e.bindingSources=n),t.each(t.result(e,"computeds")||{},function(t,n){var i=x(t)?t:t.get,r=t.set,o=t.deps;i.id=n,s[n]=function(t){return t&&r?r.call(e,t):i.apply(e,v(e._c,o))}}),C(i)?t.each(i,function(t,n){var i=d(e,n);i.length&&p(e,i,t,s,r,o)}):d(e,"["+i+"]").each(function(){var t=$(this);p(e,t,t.attr(i),s,r,o)})}},getBinding:function(t){return g(this._c,arguments,t)},setBinding:function(t,e){return g(this._c,arguments,t,e)},removeBindings:function(){if(this._c=null,this._b)for(;this._b.length;)this._b.pop().dispose()},remove:function(){this.removeBindings(),V(this,"remove")}},E),t.extend(m.prototype,e.Events,{init:P,get:P,set:P,clean:P,dispose:function(){this.clean(),this.stopListening(),this.$el.off(this.evt),this.$el=null}}),b});