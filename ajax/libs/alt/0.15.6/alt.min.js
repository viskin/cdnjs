"use strict";var _interopRequire=function(a){return a&&a.__esModule?a["default"]:a};var _get=function get(b,e,d){var f=Object.getOwnPropertyDescriptor(b,e);if(f===undefined){var c=Object.getPrototypeOf(b);if(c===null){return undefined}else{return get(c,e,d)}}else{if("value" in f&&f.writable){return f.value}else{var a=f.get;if(a===undefined){return undefined}return a.call(d)}}};var _inherits=function(b,a){if(typeof a!=="function"&&a!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof a)}b.prototype=Object.create(a&&a.prototype,{constructor:{value:b,enumerable:false,writable:true,configurable:true}});if(a){b.__proto__=a}};var _createClass=(function(){function a(d,c){for(var b in c){var e=c[b];e.configurable=true;if(e.value){e.writable=true}}Object.defineProperties(d,c)}return function(d,b,c){if(b){a(d.prototype,b)}if(c){a(d,c)}return d}})();var _classCallCheck=function(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}};var Dispatcher=require("flux").Dispatcher;var EventEmitter=_interopRequire(require("eventemitter3"));var Symbol=_interopRequire(require("es-symbol"));var assign=_interopRequire(require("object-assign"));var ACTION_HANDLER=Symbol("action creator handler");var ACTION_KEY=Symbol("holds the actions uid symbol for listening");var ACTION_UID=Symbol("the actions uid name");var ALL_LISTENERS=Symbol("name of listeners");var EE=Symbol("event emitter instance");var INIT_SNAPSHOT=Symbol("init snapshot storage");var LAST_SNAPSHOT=Symbol("last snapshot storage");var LIFECYCLE=Symbol("store lifecycle listeners");var LISTENERS=Symbol("stores action listeners storage");var PUBLIC_METHODS=Symbol("store public method storage");var STATE_CHANGED=Symbol();var STATE_CONTAINER=Symbol("the state container");var GlobalActionsNameRegistry={};function formatAsConstant(a){return a.replace(/[a-z]([A-Z])/g,function(b){return""+b[0]+"_"+b[1].toLowerCase()}).toUpperCase()}function uid(a,b){var d=0;var c=b;while(Object.hasOwnProperty.call(a,c)){c=b+String(++d)}return c}function doSetState(a,c,b){if(!b){return}if(!a.alt.dispatcher.isDispatching()){throw new Error("You can only use setState while dispatching")}if(typeof b==="function"){assign(c[STATE_CONTAINER],b(c[STATE_CONTAINER]))}else{assign(c[STATE_CONTAINER],b)}c[STATE_CHANGED]=true}function NoopClass(){}var builtIns=Object.getOwnPropertyNames(NoopClass);var builtInProto=Object.getOwnPropertyNames(NoopClass.prototype);var getInternalMethods=function(b,a){return Object.getOwnPropertyNames(b).reduce(function(d,c){if(a.indexOf(c)!==-1){return d}d[c]=b[c];return d},{})};var AltStore=(function(){function f(j,i,k,h){var g=this;_classCallCheck(this,f);this[EE]=new EventEmitter();this[LIFECYCLE]={};this[STATE_CHANGED]=false;this[STATE_CONTAINER]=k||i;this.boundListeners=i[ALL_LISTENERS];this.StoreModel=h;if(typeof this.StoreModel==="object"){this.StoreModel.state=assign({},h.state)}assign(this[LIFECYCLE],i[LIFECYCLE]);assign(this,i[PUBLIC_METHODS]);this.dispatchToken=j.register(function(n){if(typeof i.beforeEach==="function"){i.beforeEach(n.action.toString(),n.data,g[STATE_CONTAINER])}if(i[LISTENERS][n.action]){var l=false;try{l=i[LISTENERS][n.action](n.data)}catch(m){if(g[LIFECYCLE].error){g[LIFECYCLE].error(m,n.action.toString(),n.data,g[STATE_CONTAINER])}else{throw m}}if(l!==false||g[STATE_CHANGED]){g.emitChange()}g[STATE_CHANGED]=false}if(typeof i.afterEach==="function"){i.afterEach(n.action.toString(),n.data,g[STATE_CONTAINER])}});if(this[LIFECYCLE].init){this[LIFECYCLE].init()}}_createClass(f,{getEventEmitter:{value:function d(){return this[EE]}},emitChange:{value:function e(){this[EE].emit("change",this[STATE_CONTAINER])}},listen:{value:function b(h){var g=this;this[EE].on("change",h);return function(){return g.unlisten(h)}}},unlisten:{value:function c(g){if(this[LIFECYCLE].unlisten){this[LIFECYCLE].unlisten()}this[EE].removeListener("change",g)}},getState:{value:function a(){var g=this[STATE_CONTAINER];return Object.keys(g).reduce(function(i,h){i[h]=g[h];return i},{})}}});return f})();var ActionCreator=(function(){function b(e,c,d,f){_classCallCheck(this,b);this[ACTION_UID]=c;this[ACTION_HANDLER]=d.bind(this);this.actions=f;this.alt=e}_createClass(b,{dispatch:{value:function a(c){this.alt.dispatch(this[ACTION_UID],c)}}});return b})();var StoreMixinListeners={on:function on(b,a){this[LIFECYCLE][b]=a.bind(this)},bindAction:function bindAction(c,b){if(!c){throw new ReferenceError("Invalid action reference passed in")}if(typeof b!=="function"){throw new TypeError("bindAction expects a function")}if(b.length>1){throw new TypeError("Action handler in store "+this._storeName+" for "+(""+(c[ACTION_KEY]||c).toString()+" was defined with 2 ")+"parameters. Only a single parameter is passed through the dispatcher, did you mean to pass in an Object instead?")}var a=c[ACTION_KEY]?c[ACTION_KEY]:c;this[LISTENERS][a]=b.bind(this);this[ALL_LISTENERS].push(Symbol.keyFor(a))},bindActions:function bindActions(b){var a=this;Object.keys(b).forEach(function(e){var d=b[e];var g=/./;var f=e.replace(g,function(h){return"on"+h[0].toUpperCase()});var c=null;if(a[e]&&a[f]){throw new ReferenceError("You have multiple action handlers bound to an action: "+(""+e+" and "+f))}else{if(a[e]){c=a[e]}else{if(a[f]){c=a[f]}}}if(c){a.bindAction(d,c)}})},bindListeners:function bindListeners(b){var a=this;Object.keys(b).forEach(function(c){var e=b[c];var d=a[c];if(!d){throw new ReferenceError(""+c+" defined but does not exist in "+a._storeName)}if(Array.isArray(e)){e.forEach(function(f){a.bindAction(f,d)})}else{a.bindAction(e,d)}})}};var StoreMixinEssentials={waitFor:function waitFor(a){if(!a){throw new ReferenceError("Dispatch tokens not provided")}if(arguments.length===1){a=Array.isArray(a)?a:[a]}else{a=Array.prototype.slice.call(arguments)}var b=a.map(function(c){return c.dispatchToken||c});this.dispatcher.waitFor(b)},exportPublicMethods:function exportPublicMethods(b){var a=this;Object.keys(b).forEach(function(c){if(typeof b[c]!=="function"){throw new TypeError("exportPublicMethods expects a function")}a[PUBLIC_METHODS][c]=b[c]})},emitChange:function emitChange(){this.getInstance().emitChange()}};var setAppState=function(a,c,b){var d=a.deserialize(c);Object.keys(d).forEach(function(f){var e=a.stores[f];if(e){if(e[LIFECYCLE].deserialize){d[f]=e[LIFECYCLE].deserialize(d[f])||d[f]}assign(e[STATE_CONTAINER],d[f]);b(e)}})};var snapshot=function(a){for(var d=arguments.length,c=Array(d>1?d-1:0),e=1;e<d;e++){c[e-1]=arguments[e]}var b=c.length?c:Object.keys(a.stores);return b.reduce(function(i,h){var g=a.stores[h];if(g[LIFECYCLE].snapshot){g[LIFECYCLE].snapshot()}var f=g[LIFECYCLE].serialize&&g[LIFECYCLE].serialize();i[h]=f?f:g.getState();return i},{})};var saveInitialSnapshot=function(a,c){var d=a.stores[c][STATE_CONTAINER];var b=a.deserialize(a[INIT_SNAPSHOT]);b[c]=d;a[INIT_SNAPSHOT]=a.serialize(b);a[LAST_SNAPSHOT]=a[INIT_SNAPSHOT]};var filterSnapshotOfStores=function(a,d,c){var b=a.deserialize(d);var e=c.reduce(function(g,f){if(!b[f]){throw new ReferenceError(""+f+" is not a valid store")}g[f]=b[f];return g},{});return a.serialize(e)};var createStoreFromObject=function(g,a,b,f){var e=undefined;var d={};d[ALL_LISTENERS]=[];d[LIFECYCLE]={};d[LISTENERS]={};assign(d,{_storeName:b,alt:g,dispatcher:g.dispatcher,getInstance:function c(){return e},setState:function h(i){doSetState(this,e,i)}},StoreMixinListeners,StoreMixinEssentials,a);if(d.bindListeners){StoreMixinListeners.bindListeners.call(d,d.bindListeners)}if(d.lifecycle){Object.keys(d.lifecycle).forEach(function(i){StoreMixinListeners.on.call(d,i,d.lifecycle[i])})}e=assign(new AltStore(g.dispatcher,d,d.state,a),d.publicMethods);if(f){g.stores[b]=e;saveInitialSnapshot(g,b)}return e};var Alt=(function(){function h(){var p=arguments[0]===undefined?{}:arguments[0];_classCallCheck(this,h);this.serialize=p.serialize||JSON.stringify;this.deserialize=p.deserialize||JSON.parse;this.dispatcher=p.dispatcher||new Dispatcher();this.actions={};this.stores={};this[LAST_SNAPSHOT]=this[INIT_SNAPSHOT]="{}"}_createClass(h,{dispatch:{value:function i(q,p){this.dispatcher.dispatch({action:q,data:p})}},createStore:{value:function j(s,r){var p=arguments[2]===undefined?true:arguments[2];var v=undefined;var x=r||s.name||s.displayName||"";if(p&&(this.stores[x]||!x)){if(typeof console!=="undefined"){if(this.stores[x]){console.warn(new ReferenceError("A store named "+x+" already exists, double check your store names or pass in your own custom identifier for each store"))}else{console.warn(new ReferenceError("Store name was not specified"))}}x=uid(this.stores,x)}if(typeof s==="object"){return createStoreFromObject(this,s,x,p)}var u=(function(z){function y(A){_classCallCheck(this,y);_get(Object.getPrototypeOf(y.prototype),"constructor",this).call(this,A)}_inherits(y,z);return y})(s);assign(u.prototype,StoreMixinListeners,StoreMixinEssentials,{_storeName:x,alt:this,dispatcher:this.dispatcher,getInstance:function q(){return v},setState:function t(y){doSetState(this,v,y)}});u.prototype[ALL_LISTENERS]=[];u.prototype[LIFECYCLE]={};u.prototype[LISTENERS]={};u.prototype[PUBLIC_METHODS]={};var w=new u(this);v=assign(new AltStore(this.dispatcher,w,null,s),getInternalMethods(s,builtIns));if(p){this.stores[x]=v;saveInitialSnapshot(this,x)}return v}},generateActions:{value:function k(){for(var p=arguments.length,r=Array(p),q=0;q<p;q++){r[q]=arguments[q]}return this.createActions(function(){this.generateActions.apply(this,r)})}},createAction:{value:function l(r,q,u){var v=uid(GlobalActionsNameRegistry,r);GlobalActionsNameRegistry[v]=1;var p=Symbol["for"](v);var t=new ActionCreator(this,p,q,u);var s=t[ACTION_HANDLER];s.defer=function(){for(var w=arguments.length,x=Array(w),y=0;y<w;y++){x[y]=arguments[y]}setTimeout(function(){t[ACTION_HANDLER].apply(null,x)})};s[ACTION_KEY]=p;return s}},createActions:{value:function e(t){var p=this;var r=arguments[1]===undefined?{}:arguments[1];var s={};var q=t.name||t.displayName||"";if(typeof t==="function"){(function(){assign(s,getInternalMethods(t.prototype,builtInProto));var u=(function(x){function v(y){_classCallCheck(this,v);_get(Object.getPrototypeOf(v.prototype),"constructor",this).call(this,y)}_inherits(v,x);_createClass(v,{generateActions:{value:function w(){for(var y=arguments.length,A=Array(y),z=0;z<y;z++){A[z]=arguments[z]}A.forEach(function(B){s[B]=function(D){for(var C=arguments.length,E=Array(C>1?C-1:0),F=1;F<C;F++){E[F-1]=arguments[F]}this.dispatch(E.length?[D].concat(E):D)}})}}});return v})(t);new u(p)})()}else{assign(s,t)}return Object.keys(s).reduce(function(w,v){w[v]=p.createAction(""+q+"#"+v,s[v],w);var u=formatAsConstant(v);w[u]=w[v][ACTION_KEY];return w},r)}},takeSnapshot:{value:function m(){for(var q=arguments.length,p=Array(q),r=0;r<q;r++){p[r]=arguments[r]}var s=snapshot.apply(undefined,[this].concat(p));this[LAST_SNAPSHOT]=this.serialize(assign(this.deserialize(this[LAST_SNAPSHOT]),s));return this.serialize(s)}},rollback:{value:function n(){setAppState(this,this[LAST_SNAPSHOT],function(p){if(p[LIFECYCLE].rollback){p[LIFECYCLE].rollback()}p.emitChange()})}},recycle:{value:function d(){for(var r=arguments.length,q=Array(r),s=0;s<r;s++){q[s]=arguments[s]}var p=q.length?filterSnapshotOfStores(this,this[INIT_SNAPSHOT],q):this[INIT_SNAPSHOT];setAppState(this,p,function(t){if(t[LIFECYCLE].init){t[LIFECYCLE].init()}t.emitChange()})}},flush:{value:function o(){var p=this.serialize(snapshot(this));this.recycle();return p}},bootstrap:{value:function f(p){setAppState(this,p,function(q){if(q[LIFECYCLE].bootstrap){q[LIFECYCLE].bootstrap()}q.emitChange()})}},addActions:{value:function c(p,q){this.actions[p]=Array.isArray(q)?this.generateActions.apply(this,q):this.createActions(q)}},addStore:{value:function b(q,p,r){this.createStore(p,q,r)}},getActions:{value:function a(p){return this.actions[p]}},getStore:{value:function g(p){return this.stores[p]}}});return h})();module.exports=Alt;