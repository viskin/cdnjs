"use strict";var _prototypeProperties=function(c,b,a){if(b){Object.defineProperties(c,b)}if(a){Object.defineProperties(c.prototype,a)}};var _classCallCheck=function(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}};var Dispatcher=require("flux").Dispatcher;var EventEmitter=require("eventemitter3");var Symbol=require("es-symbol");var assign=require("object-assign");var now=Date.now();var VariableSymbol=function(a){return Symbol(""+now+""+a)};var ACTION_DISPATCHER=Symbol("action dispatcher storage");var ACTION_HANDLER=Symbol("action creator handler");var ACTION_KEY=Symbol("holds the actions uid symbol for listening");var ACTION_UID=Symbol("the actions uid name");var BOOTSTRAP_FLAG=VariableSymbol("has bootstrap");var EE=Symbol("event emitter instance");var INIT_SNAPSHOT=Symbol("init snapshot storage");var LAST_SNAPSHOT=Symbol("last snapshot storage");var LISTENERS=Symbol("stores action listeners storage");var STATE_CONTAINER=VariableSymbol("the state container");var STORE_BOOTSTRAP=Symbol("event handler onBootstrap");var STORE_SNAPSHOT=Symbol("event handler onTakeSnapshot");var formatAsConstant=function(a){return a.replace(/[a-z]([A-Z])/g,function(b){return""+b[0]+"_"+b[1].toLowerCase()}).toUpperCase()};function NoopClass(){}var builtIns=Object.getOwnPropertyNames(NoopClass);var builtInProto=Object.getOwnPropertyNames(NoopClass.prototype);var getInternalMethods=function(b,a){return Object.getOwnPropertyNames(b).reduce(function(d,c){if(a.indexOf(c)!==-1){return d}d[c]=b[c];return d},{})};var AltStore=(function(){function e(f,g){var h=this;_classCallCheck(this,e);this[STATE_CONTAINER]=g;this[EE]=new EventEmitter();if(g.onBootstrap){this[STORE_BOOTSTRAP]=g.onBootstrap.bind(g)}if(g.onTakeSnapshot){this[STORE_SNAPSHOT]=g.onTakeSnapshot.bind(g)}this.dispatchToken=f.register(function(j){if(g[LISTENERS][j.action]){var i=g[LISTENERS][j.action](j.data);i!==false&&h.emitChange()}})}_prototypeProperties(e,null,{emitChange:{value:function d(){this[EE].emit("change",this[STATE_CONTAINER])},writable:true,configurable:true},listen:{value:function b(f){this[EE].on("change",f)},writable:true,configurable:true},unlisten:{value:function c(f){this[EE].removeListener("change",f)},writable:true,configurable:true},getState:{value:function a(){return assign({},this[STATE_CONTAINER])},writable:true,configurable:true}});return e})();var ActionCreator=(function(){function b(d,c,e,f){_classCallCheck(this,b);this[ACTION_DISPATCHER]=d;this[ACTION_UID]=c;this[ACTION_HANDLER]=e.bind(this);this[BOOTSTRAP_FLAG]=false;this.actions=f}_prototypeProperties(b,null,{dispatch:{value:function a(c){this[ACTION_DISPATCHER].dispatch({action:this[ACTION_UID],data:c})},writable:true,configurable:true}});return b})();var StoreMixin={bindAction:function bindAction(b,a){if(!b){throw new ReferenceError("Invalid action reference passed in")}if(typeof a!=="function"){throw new TypeError("bindAction expects a function")}if(a.length>1){throw new TypeError("Action handler in store "+this._storeName+" for "+(""+(b[ACTION_KEY]||b)+" was defined with 2 parameters. ")+"Only a single parameter is passed through the dispatcher, did you mean to pass in an Object instead?")}if(b[ACTION_KEY]){this[LISTENERS][b[ACTION_KEY]]=a.bind(this)}else{this[LISTENERS][b]=a.bind(this)}},bindActions:function bindActions(a){var b=this;Object.keys(a).forEach(function(e){var d=a[e];var g=/./;var f=e.replace(g,function(h){return"on"+h[0].toUpperCase()});var c=null;if(b[e]&&b[f]){throw new ReferenceError("You have multiple action handlers bound to an action: "+(""+e+" and "+f))}else{if(b[e]){c=b[e]}else{if(b[f]){c=b[f]}}}if(c){b.bindAction(d,c)}})},waitFor:function waitFor(a){if(!a){throw new ReferenceError("Dispatch tokens not provided")}a=Array.isArray(a)?a:[a];this.dispatcher.waitFor(a)}};var setAppState=function(a,b){var c=JSON.parse(b);Object.keys(c).forEach(function(d){assign(a.stores[d][STATE_CONTAINER],c[d]);if(a.stores[d][STORE_BOOTSTRAP]){a.stores[d][STORE_BOOTSTRAP]()}})};var snapshot=function(a){return JSON.stringify(Object.keys(a.stores).reduce(function(c,b){if(a.stores[b][STORE_SNAPSHOT]){a.stores[b][STORE_SNAPSHOT]()}c[b]=a.stores[b].getState();return c},{}))};var saveInitialSnapshot=function(a,c){var d=a.stores[c][STATE_CONTAINER];var b=JSON.parse(a[INIT_SNAPSHOT]);b[c]=d;a[INIT_SNAPSHOT]=JSON.stringify(b)};var filterSnapshotOfStores=function(c,b){var a=JSON.parse(c);var d=b.reduce(function(f,e){if(!a[e]){throw new ReferenceError(""+e+" is not a valid store")}f[e]=a[e];return f},{});return JSON.stringify(d)};var Alt=(function(){function e(){_classCallCheck(this,e);this.dispatcher=new Dispatcher();this.stores={};this[LAST_SNAPSHOT]=null;this[INIT_SNAPSHOT]="{}"}_prototypeProperties(e,null,{createStore:{value:function c(k,j){var n=this;var l=j||k.displayName||k.name;function m(){k.call(this)}m.prototype=k.prototype;m.prototype[LISTENERS]={};assign(m.prototype,StoreMixin,{_storeName:l,dispatcher:this.dispatcher,getInstance:function(){return n.stores[l]}});var i=new m();if(this.stores[l]){throw new ReferenceError("A store named "+l+" already exists, double check your store names or pass in\nyour own custom identifier for each store")}this.stores[l]=assign(new AltStore(this.dispatcher,i),getInternalMethods(k,builtIns));saveInitialSnapshot(this,l);return this.stores[l]},writable:true,configurable:true},createActions:{value:function h(m){var n=this;var k=arguments[1]===undefined?{}:arguments[1];var j=m.displayName||m.name;var l=assign({},getInternalMethods(m.prototype,builtInProto));function i(){m.call(this)}i.prototype=m.prototype;i.prototype.generateActions=function(){for(var o=arguments.length,q=Array(o),p=0;p<o;p++){q[p]=arguments[p]}q.forEach(function(r){l[r]=function(t){for(var s=arguments.length,u=Array(s>1?s-1:0),v=1;v<s;v++){u[v-1]=arguments[v]}this.dispatch(u.length?[t].concat(u):t)}})};new i();return Object.keys(l).reduce(function(s,q){var p=formatAsConstant(q);var o=Symbol("action "+j+".prototype."+q);var r=new ActionCreator(n.dispatcher,o,l[q],s);s[q]=r[ACTION_HANDLER];s[q].defer=function(t){return setTimeout(function(){return r[ACTION_HANDLER](t)})};s[q][ACTION_KEY]=o;s[p]=o;return s},k)},writable:true,configurable:true},takeSnapshot:{value:function g(){var i=snapshot(this);this[LAST_SNAPSHOT]=i;return i},writable:true,configurable:true},rollback:{value:function b(){setAppState(this,this[LAST_SNAPSHOT])},writable:true,configurable:true},recycle:{value:function f(){for(var j=arguments.length,i=Array(j),l=0;l<j;l++){i[l]=arguments[l]}var k=i.length?filterSnapshotOfStores(this[INIT_SNAPSHOT],i):this[INIT_SNAPSHOT];setAppState(this,k)},writable:true,configurable:true},flush:{value:function a(){var i=snapshot(this);this.recycle();return i},writable:true,configurable:true},bootstrap:{value:function d(i){setAppState(this,i);if(typeof window!=="undefined"){if(this[BOOTSTRAP_FLAG]){throw new ReferenceError("Stores have already been bootstrapped")}this[BOOTSTRAP_FLAG]=true}},writable:true,configurable:true}});return e})();module.exports=Alt;