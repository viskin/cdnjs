function propname(key,obj){if(/^[A-Z_$][0-9A-Z_$]*$/i.test(key)){return obj?obj+"."+key:key}else{var jkey=JSON.stringify(key);return obj?obj+"["+jkey+"]":jkey}}function MessageFormat(locale,pluralFunc,formatters){if(!locale){this.lc=["en"]}else if(typeof locale=="string"){this.lc=[];for(var l=locale;l;l=l.replace(/[-_]?[^-_]*$/,""))this.lc.push(l)}else{this.lc=locale}if(!pluralFunc){if(this.lc.every(function(l){pluralFunc=MessageFormat.plurals[l];return!pluralFunc})){throw new Error("Plural function for locale `"+this.lc.join(",")+"` not found")}}this.runtime.pluralFuncs={};this.runtime.pluralFuncs[this.lc[0]]=pluralFunc;this.runtime.fmt={};if(formatters)for(var f in formatters){this.runtime.fmt[f]=formatters[f]}}module.exports=MessageFormat;MessageFormat._parse=require("./messageformat-parser").parse;MessageFormat.plurals=require("make-plural/plurals");MessageFormat.formatters={number:function(self){return new Function("v,lc,p","return Intl.NumberFormat(lc,\n"+"    p=='integer' ? {maximumFractionDigits:0}\n"+"  : p=='percent' ? {style:'percent'}\n"+"  : p=='currency' ? {style:'currency', currency:'"+(self.currency||"USD")+"', minimumFractionDigits:2, maximumFractionDigits:2}\n"+"  : {}).format(v)")},date:function(v,lc,p){var o={day:"numeric",month:"short",year:"numeric"};switch(p){case"full":o.weekday="long";case"long":o.month="long";break;case"short":o.month="numeric"}return new Date(v).toLocaleDateString(lc,o)},time:function(v,lc,p){var o={second:"numeric",minute:"numeric",hour:"numeric"};switch(p){case"full":case"long":o.timeZoneName="short";break;case"short":delete o.minute}return new Date(v).toLocaleTimeString(lc,o)}};MessageFormat.prototype.setIntlSupport=function(enable){this.withIntlSupport=!!enable||typeof enable=="undefined";return this};MessageFormat.prototype.runtime={number:function(value,offset){if(isNaN(value))throw new Error("'"+value+"' isn't a number.");return value-(offset||0)},plural:function(value,offset,lcfunc,data,isOrdinal){if({}.hasOwnProperty.call(data,value))return data[value]();if(offset)value-=offset;var key=lcfunc(value,isOrdinal);if(key in data)return data[key]();return data.other()},select:function(value,data){if({}.hasOwnProperty.call(data,value))return data[value]();return data.other()},pluralFuncs:{},fmt:{},toString:function(){var _stringify=function(o,level){if(typeof o!="object"){var funcStr=o.toString().replace(/^(function )\w*/,"$1");var indent=/([ \t]*)\S.*$/.exec(funcStr);return indent?funcStr.replace(new RegExp("^"+indent[1],"mg"),""):funcStr}var s=[];for(var i in o)if(i!="toString"){if(level==0)s.push("var "+i+" = "+_stringify(o[i],level+1)+";\n");else s.push(propname(i)+": "+_stringify(o[i],level+1))}if(level==0)return s.join("");if(s.length==0)return"{}";var indent="  ";while(--level)indent+="  ";return"{\n"+s.join(",\n").replace(/^/gm,indent)+"\n}"};return _stringify(this,0)}};MessageFormat.prototype._precompile=function(ast,data){data=data||{keys:{},offset:{}};var r=[],i,tmp,args=[];switch(ast.type){case"messageFormatPattern":for(i=0;i<ast.statements.length;++i){r.push(this._precompile(ast.statements[i],data))}tmp=r.join(" + ")||'""';return data.pf_count?tmp:"function(d) { return "+tmp+"; }";case"messageFormatElement":data.pf_count=data.pf_count||0;if(ast.output){return propname(ast.argumentIndex,"d")}else{data.keys[data.pf_count]=ast.argumentIndex;return this._precompile(ast.elementFormat,data)}return"";case"elementFormat":args=[propname(data.keys[data.pf_count],"d")];switch(ast.key){case"select":args.push(this._precompile(ast.val,data));return"select("+args.join(", ")+")";case"selectordinal":args=args.concat([0,propname(this.lc[0],"pluralFuncs"),this._precompile(ast.val,data),1]);return"plural("+args.join(", ")+")";case"plural":data.offset[data.pf_count||0]=ast.val.offset||0;args=args.concat([data.offset[data.pf_count]||0,propname(this.lc[0],"pluralFuncs"),this._precompile(ast.val,data)]);return"plural("+args.join(", ")+")";default:if(this.withIntlSupport&&!(ast.key in this.runtime.fmt)&&ast.key in MessageFormat.formatters){tmp=MessageFormat.formatters[ast.key];this.runtime.fmt[ast.key]=typeof tmp(this)=="function"?tmp(this):tmp}args.push(JSON.stringify(this.lc));if(ast.val&&ast.val.length)args.push(JSON.stringify(ast.val.length==1?ast.val[0]:ast.val));return"fmt."+ast.key+"("+args.join(", ")+")"}case"pluralFormatPattern":case"selectFormatPattern":data.pf_count=data.pf_count||0;if(ast.type=="selectFormatPattern")data.offset[data.pf_count]=0;var needOther=true;for(i=0;i<ast.pluralForms.length;++i){var key=ast.pluralForms[i].key;if(key==="other")needOther=false;var data_copy=JSON.parse(JSON.stringify(data));data_copy.pf_count++;r.push(propname(key)+": function() { return "+this._precompile(ast.pluralForms[i].val,data_copy)+";}")}if(needOther)throw new Error("No 'other' form found in "+ast.type+" "+data.pf_count);return"{ "+r.join(", ")+" }";case"string":return JSON.stringify(ast.val||"");case"octothorpe":if(!data.pf_count)return'"#"';args=[propname(data.keys[data.pf_count-1],"d")];if(data.offset[data.pf_count-1])args.push(data.offset[data.pf_count-1]);return"number("+args.join(", ")+")";default:throw new Error("Bad AST type: "+ast.type)}};MessageFormat.prototype.compile=function(messages,opt){var r={},lc0=this.lc,compileMsg=function(self,msg){try{var ast=MessageFormat._parse(msg);return self._precompile(ast)}catch(e){throw new Error((ast?"Precompiler":"Parser")+" error: "+e.toString())}},stringify=function(r,level){if(!level)level=0;if(typeof r!="object")return r;var o=[],indent="";for(var i=0;i<level;++i)indent+="  ";for(var k in r)o.push("\n"+indent+"  "+propname(k)+": "+stringify(r[k],level+1));return"{"+o.join(",")+"\n"+indent+"}"};if(typeof messages=="string"){var f=new Function("number, plural, select, pluralFuncs, fmt","return "+compileMsg(this,messages));return f(this.runtime.number,this.runtime.plural,this.runtime.select,this.runtime.pluralFuncs,this.runtime.fmt)}opt=opt||{};for(var ns in messages){if(opt.locale)this.lc=opt.locale[ns]&&[].concat(opt.locale[ns])||lc0;if(typeof messages[ns]=="string"){try{r[ns]=compileMsg(this,messages[ns])}catch(e){e.message=e.message.replace(":"," with `"+ns+"`:");throw e}}else{r[ns]={};for(var key in messages[ns]){try{r[ns][key]=compileMsg(this,messages[ns][key])}catch(e){e.message=e.message.replace(":"," with `"+key+"` in `"+ns+"`:");throw e}}}}this.lc=lc0;var s=this.runtime.toString()+"\n";switch(opt.global||""){case"exports":var o=[];for(var k in r)o.push(propname(k,"exports")+" = "+stringify(r[k]));return new Function(s+o.join(";\n"));case"module.exports":return new Function(s+"module.exports = "+stringify(r));case"":return new Function(s+"return "+stringify(r));default:return new Function("G",s+propname(opt.global,"G")+" = "+stringify(r))}};