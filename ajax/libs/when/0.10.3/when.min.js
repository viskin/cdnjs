(typeof define=="function"?define:function(a){typeof module!="undefined"?(module.exports=a()):(this.when=a())})(function(){var b,g,a;function e(){}function q(s){return new Array(s)}b=Object.freeze||e;g=[].reduce||function(x){var t,v,u,s,w;w=0;t=Object(this);s=t.length>>>0;v=arguments;if(v.length<=1){for(;;){if(w in t){u=t[w++];break}if(++w>=s){throw new TypeError()}}}else{u=v[1]}for(;w<s;++w){if(w in t){u=x(u,t[w],w,t)}}return u};function d(){var D,F,w,G,A,y,v,u,t;A=[];y=[];v=function z(K,H,J){var I=d();A.push({deferred:I,resolve:K,reject:H});J&&y.push(J);return I.promise};function x(J,H,I){return v(J,H,I)}function C(H){t("resolve",H)}function E(H){t("reject",H)}u=function(J){var H,I=0;while(H=y[I++]){H(J)}};function s(H){u(H)}t=function(L,K){var J=v;v=function I(O,M){var N=J(O,M);B(L);return N};t=u=function H(){throw new Error("already completed")};y=a;G=K;B(L)};function B(O){var M,L,I,K,H,J=0;H=A;A=[];while(M=H[J++]){L=M.deferred;K=M[O];try{I=K?K(G):G;if(m(I)){f(I,L)}else{L[O](I===a?G:I)}}catch(N){L.reject(N)}}}D={};F=D.promise={then:(D.then=x)};w=D.resolver={resolve:(D.resolve=C),reject:(D.reject=E),progress:(D.progress=s)};b(F);b(w);return D}function m(s){return s&&typeof s.then==="function"}function h(t,w,u,s){var v=n(t);return v.then(w,u,s)}function n(s){return m(s)?s:p(s)}function p(t){var s=d();s.resolve(t);return s.promise}function j(H,G,v,y,u){var s,C,I,J,x,A,B,F,E;F=H.length>>>0;s=Math.max(0,Math.min(G,F));C=[];J=d();I=h(J,v,y,u);function D(K){x(K)}function t(K){A(K)}function w(K){B(K)}function z(){x=A=B=e}if(!s){J.resolve(C)}else{x=function(K){C.push(K);if(!--s){z();J.resolve(C)}};A=function(K){z();J.reject(K)};B=J.progress;for(E=0;E<F;++E){if(E in H){h(H[E],D,t,w)}}}return I}function c(v,x,t,s){var u,w;u=q(v.length);w=k(v,i,u);return h(w,x,t,s)}function i(t,u,s){t[s]=u;return t}function l(u,w,t,s){function v(x){return w(x[0])}return j(u,1,v,t,s)}function r(u,v){var t,s;s=u.length;t=q(s);for(;s>=0;--s){if(s in u){t[s]=h(u[s],v)}}return k(t,i,t)}function k(w,u,s){var v,t;v=w.length;t=[function(y,z,x){return h(y,function(A){return h(z,function(B){return u(A,B,x,v)})})}];if(arguments.length>=3){t.push(s)}return n(g.apply(w,t))}function o(s,w,v){var u,t;u=n(s);t=arguments.length>2?function(x){return f(u,x,v)}:function(x){return f(u,x)};t(w);return t(h.defer()).promise}function f(u,s,t){u.then(arguments.length>2?function(){s.resolve(t)}:s.resolve,s.reject,s.progress);return s}h.defer=d;h.isPromise=m;h.some=j;h.all=c;h.any=l;h.reduce=k;h.map=r;h.chain=o;return h});