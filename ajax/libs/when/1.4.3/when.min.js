(function(a){a(function(){var d,j,t,c;k.defer=f;k.resolve=u;k.reject=i;k.all=e;k.some=o;k.any=p;k.map=x;k.reduce=n;k.chain=r;k.isPromise=q;function k(z,B,A,y){return u(z).then(B,A,y)}function u(y){var A,z;if(y instanceof g){A=y}else{if(y!=null&&typeof y.valueOf==="function"){y=y.valueOf()}if(q(y)){z=f();y.then(z.resolve,z.reject,z.progress);A=z.promise}else{A=s(y)}}return A}function i(y){return k(y,function(z){return w(z)})}d=Object.freeze||function(y){return y};function g(){}g.prototype=d({always:function(y,z){return this.then(y,y,z)},otherwise:function(y){return this.then(c,y)}});function s(y){var z=new g();z.then=function(B){try{return u(B?B(y):y)}catch(A){return w(A)}};return d(z)}function w(z){var y=new g();y.then=function(C,A){try{return A?u(A(z)):w(z)}catch(B){return w(B)}};return d(y)}function f(){var I,J,B,F,E,A,z,G;F=[];E=[];I={};B={};J=new g();J.then=I.then=function D(M,K,L){return A(M,K,L)};I.promise=d(J);B.resolve=I.resolve=function C(K){return G(K)};B.reject=I.reject=function H(K){return G(w(K))};B.progress=I.progress=function y(K){z(K)};I.resolver=d(B);A=function(N,L,M){var K=f();F.push(function(O){O.then(N,L).then(K.resolve,K.reject,K.progress)});M&&E.push(M);return K.promise};z=function(M){var K,L=0;while(K=E[L++]){K(M)}};G=function(L){var N,K=0;L=u(L);A=L.then;G=z=function M(){throw new Error("already completed")};while(N=F[K++]){N(L)}E=F=c;return L};return I}function q(y){return y&&typeof y.then==="function"}function o(B,A,C,z,y){m(2,arguments);return k(B,function(H){var L,J,O,F,G,N,K,I;K=H.length>>>0;L=Math.max(0,Math.min(A,K));J=[];O=f();function M(Q){F(Q)}function P(Q){G(Q)}function D(Q){N(Q)}if(!L){O.resolve(J)}else{O.promise.always(function E(){F=G=N=h});G=O.reject;N=O.progress;F=function(Q){J.push(Q);if(!--L){O.resolve(J)}};for(I=0;I<K;++I){if(I in H){k(H[I],M,P,D)}}}return k(O,C,z,y)})}function e(A,B,z,y){m(1,arguments);return k(A,function(C){return v(C,l,[])}).then(B,z,y)}function l(z,A,y){z[y]=A;return z}function p(A,C,z,y){function B(D){return C?C(D[0]):D[0]}return o(A,1,B,z,y)}function x(z,y){return k(z,function(A){return b(A,y)})}function b(B,C){var A,y,z;y=B.length>>>0;A=new Array(y);for(z=0;z<y;z++){if(z in B){A[z]=k(B[z],C)}}return v(A,l,A)}function n(B,A,y){var z=t.call(arguments,1);return k(B,function(C){return v.apply(c,[C].concat(z))})}function v(C,A,y){var B,z;B=C.length;z=[function(E,F,D){return k(E,function(G){return k(F,function(H){return A(G,H,D,B)})})}];if(arguments.length>2){z.push(y)}return j.apply(C,z)}function r(y,B,A){var z=arguments.length>2;return k(y,function(C){return B.resolve(z?A:C)},B.reject,B.progress)}function m(B,A){var y,z=A.length;while(z>B){y=A[--z];if(y!=null&&typeof y!="function"){throw new Error("arg "+z+" must be a function")}}}function h(){}t=[].slice;j=[].reduce||function(D){var z,B,A,y,C;C=0;z=Object(this);y=z.length>>>0;B=arguments;if(B.length<=1){for(;;){if(C in z){A=z[C++];break}if(++C>=y){throw new TypeError()}}}else{A=B[1]}for(;C<y;++C){if(C in z){A=D(A,z[C],C,z)}}return A};return d(k)})})(typeof define=="function"?define:function(a){typeof module!="undefined"?(module.exports=a()):(this.when=a())});