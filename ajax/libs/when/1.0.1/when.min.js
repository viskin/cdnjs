(function(a){a(function(){var c,h,b;function g(){}function t(v){return new Array(v)}c=Object.freeze||function(v){return v};h=[].reduce||function(A){var w,y,x,v,z;z=0;w=Object(this);v=w.length>>>0;y=arguments;if(y.length<=1){for(;;){if(z in w){x=w[z++];break}if(++z>=v){throw new TypeError()}}}else{x=y[1]}for(;z<v;++z){if(z in w){x=A(x,w[z],z,w)}}return x};function f(){}function r(v){var w=new f();w.then=function(z){k(arguments);var x;try{x=z&&z(v);return p(x===b?v:x)}catch(y){return s(y)}};return w}function s(w){var v=new f();v.then=function(A,x){k(arguments);var y;try{if(x){y=x(w);return p(y===b?w:y)}return s(w)}catch(z){return s(z)}};return v}function k(x){var v,w=x.length;while(w){v=x[--w];if(v!=null&&typeof v!="function"){throw new Error("callback is not a function")}}}function e(){var E,G,C,A,y,w,x;C=[];A=[];y=function B(K,I,J){k(arguments);var H=e();C.push(function(L){L.then(K,I).then(H.resolve,H.reject,H.progress)});J&&A.push(J);return H.promise};function z(J,H,I){return y(J,H,I)}function D(H){x(r(H))}function F(H){x(s(H))}w=function(J){var H,I=0;while(H=A[I++]){H(J)}};function v(H){w(H)}x=function(I){var K,H=0;y=I.then;x=w=function J(){throw new Error("already completed")};A=b;while(K=C[H++]){K(I)}C=[]};E={};G=new f();G.then=E.then=z;E.promise=c(G);E.resolver=c({resolve:(E.resolve=D),reject:(E.reject=F),progress:(E.progress=v)});return E}function o(v){return v&&typeof v.then==="function"}function i(x,z,y,w){var v=p(x);return v.then(z,y,w)}function p(v){var x,w;if(v instanceof f){x=v}else{w=e();if(o(v)){v.then(w.resolve,w.reject,w.progress);x=w.promise}else{w.resolve(v);x=w.promise}}return x}function m(K,J,y,B,x){var v,F,L,M,A,D,E,I,H;I=K.length>>>0;v=Math.max(0,Math.min(J,I));F=[];M=e();L=i(M,y,B,x);function G(N){A(N)}function w(N){D(N)}function z(N){E(N)}function C(){A=D=E=g}if(!v){M.resolve(F)}else{A=function(N){F.push(N);if(!--v){C();M.resolve(F)}};D=function(N){C();M.reject(N)};E=M.progress;for(H=0;H<I;++H){if(H in K){i(K[H],G,w,z)}}}return L}function d(y,A,w,v){var x,z;x=t(y.length);z=l(y,j,x);return i(z,A,w,v)}function j(w,x,v){w[v]=x;return w}function n(x,z,w,v){function y(A){return z(A[0])}return m(x,1,y,w,v)}function u(x,y){var w,v;v=x.length;w=t(v);for(;v>=0;--v){if(v in x){w[v]=i(x[v],y)}}return l(w,j,w)}function l(z,x,v){var y,w;y=z.length;w=[function(B,C,A){return i(B,function(D){return i(C,function(E){return x(D,E,A,y)})})}];if(arguments.length>=3){w.push(v)}return p(h.apply(z,w))}function q(v,y,x){var w=arguments.length>2;return i(v,function(z){y.resolve(w?x:z)},y.reject,y.progress)}i.defer=e;i.isPromise=o;i.some=m;i.all=d;i.any=n;i.reduce=l;i.map=u;i.chain=q;return i})})(typeof define=="function"?define:function(a){typeof module!="undefined"?(module.exports=a()):(this.when=a())});