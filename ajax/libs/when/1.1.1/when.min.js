(function(a){a(function(){var d,j,u,c;k.defer=f;k.reject=i;k.isPromise=q;k.all=e;k.some=o;k.any=p;k.map=x;k.reduce=n;k.chain=s;d=Object.freeze||function(y){return y};function g(){}g.prototype=d({always:function(y,z){return this.then(y,y,z)}});function t(y){var z=new g();z.then=function(C){var A;try{if(C){A=C(y)}return r(A===c?y:A)}catch(B){return w(B)}};return d(z)}function w(z){var y=new g();y.then=function(D,A){var B;try{if(A){B=A(z);return r(B===c?z:B)}return w(z)}catch(C){return w(C)}};return d(y)}function i(y){return k(y,function(z){return w(z)})}function f(){var H,J,F,D,B,z,A;F=[];D=[];B=function E(N,L,M){var K=f();F.push(function(O){O.then(N,L).then(K.resolve,K.reject,K.progress)});M&&D.push(M);return K.promise};function C(M,K,L){return B(M,K,L)}function G(K){A(t(K))}function I(K){A(w(K))}z=function(M){var K,L=0;while(K=D[L++]){K(M)}};function y(K){z(K)}A=function(L){var N,K=0;B=L.then;A=z=function M(){throw new Error("already completed")};D=c;while(N=F[K++]){N(L)}F=[]};H={};J=new g();J.then=H.then=C;H.promise=d(J);H.resolver=d({resolve:(H.resolve=G),reject:(H.reject=I),progress:(H.progress=y)});return H}function q(y){return y&&typeof y.then==="function"}function k(A,C,B,z){var y=r(A);return y.then(C,B,z)}function r(y){var A,z;if(y instanceof g){A=y}else{z=f();if(q(y)){y.then(z.resolve,z.reject,z.progress);A=z.promise}else{z.resolve(y);A=z.promise}}return A}function o(B,A,C,z,y){m(2,arguments);return k(B,function(H){var M,J,L,P,F,G,O,K,I;K=H.length>>>0;M=Math.max(0,Math.min(A,K));J=[];P=f();L=k(P,C,z,y);function N(R){F(R)}function Q(R){G(R)}function D(R){O(R)}function E(){F=G=O=h}if(!M){P.resolve(J)}else{F=function(R){J.push(R);if(!--M){E();P.resolve(J)}};G=function(R){E();P.reject(R)};O=P.progress;for(I=0;I<K;++I){if(I in H){k(H[I],N,Q,D)}}}return L})}function e(A,B,z,y){m(1,arguments);return k(A,function(C){return v(C,l,[])}).then(B,z,y)}function l(z,A,y){z[y]=A;return z}function p(A,C,z,y){function B(D){return C?C(D[0]):D[0]}return o(A,1,B,z,y)}function x(z,y){return k(z,function(A){return b(A,y)})}function b(B,C){var A,y,z;y=B.length>>>0;A=new Array(y);for(z=0;z<y;z++){if(z in B){A[z]=k(B[z],C)}}return v(A,l,A)}function n(B,A,y){var z=u.call(arguments,1);return k(B,function(C){return v.apply(c,[C].concat(z))})}function v(C,A,y){var B,z;B=C.length;z=[function(E,F,D){return k(E,function(G){return k(F,function(H){return A(G,H,D,B)})})}];if(arguments.length>2){z.push(y)}return j.apply(C,z)}function s(y,B,A){var z=arguments.length>2;return k(y,function(C){if(z){C=A}B.resolve(C);return C},function(C){B.reject(C);return w(C)},B.progress)}function m(B,A){var y,z=A.length;while(z>B){y=A[--z];if(y!=null&&typeof y!="function"){throw new Error("callback is not a function")}}}function h(){}u=[].slice;j=[].reduce||function(D){var z,B,A,y,C;C=0;z=Object(this);y=z.length>>>0;B=arguments;if(B.length<=1){for(;;){if(C in z){A=z[C++];break}if(++C>=y){throw new TypeError()}}}else{A=B[1]}for(;C<y;++C){if(C in z){A=D(A,z[C],C,z)}}return A};return k})})(typeof define=="function"?define:function(a){typeof module!="undefined"?(module.exports=a()):(this.when=a())});