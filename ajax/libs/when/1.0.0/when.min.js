(function(a){a(function(){var f,r,g;function p(){}function j(s){return new Array(s)}f=Object.freeze||function(s){return s};r=[].reduce||function(x){var t,v,u,s,w;w=0;t=Object(this);s=t.length>>>0;v=arguments;if(v.length<=1){for(;;){if(w in t){u=t[w++];break}if(++w>=s){throw new TypeError()}}}else{u=v[1]}for(;w<s;++w){if(w in t){u=x(u,t[w],w,t)}}return u};function m(){}function c(){var C,E,F,z,x,v,t,u;z=[];x=[];v=function y(L,I,K){var G,H,J=arguments.length;while(J){G=arguments[--J];if(G!=null&&typeof G!="function"){throw new Error("callback is not a function")}}H=c();z.push({deferred:H,resolve:L,reject:I});K&&x.push(K);return H.promise};function w(I,G,H){return v(I,G,H)}function B(G){u("resolve",G)}function D(G){u("reject",G)}t=function(I){var G,H=0;while(G=x[H++]){G(I)}};function s(G){t(G)}u=function(K,J){var I=v;v=function H(N,L){var M=I(N,L);A(K);return M};u=t=function G(){throw new Error("already completed")};x=g;F=J;A(K)};function A(N){var L,K,H,J,G,I=0;G=z;z=[];while(L=G[I++]){K=L.deferred;J=L[N];try{H=J?J(F):F;if(h(H)){k(H,K.resolve,K.reject,K.progress)}else{K[N](H===g?F:H)}}catch(M){K.reject(M)}}}C={};E=new m();E.then=C.then=w;C.promise=f(E);C.resolver=f({resolve:(C.resolve=B),reject:(C.reject=D),progress:(C.progress=s)});return C}function h(s){return s&&typeof s.then==="function"}function k(u,w,v,t){var s=q(u);return s.then(w,v,t)}function q(s){var u,t;if(s instanceof m){u=s}else{t=c();if(h(s)){s.then(t.resolve,t.reject,t.progress)}else{t.resolve(s)}u=t.promise}return u}function o(H,G,v,y,u){var s,C,I,J,x,A,B,F,E;F=H.length>>>0;s=Math.max(0,Math.min(G,F));C=[];J=c();I=k(J,v,y,u);function D(K){x(K)}function t(K){A(K)}function w(K){B(K)}function z(){x=A=B=p}if(!s){J.resolve(C)}else{x=function(K){C.push(K);if(!--s){z();J.resolve(C)}};A=function(K){z();J.reject(K)};B=J.progress;for(E=0;E<F;++E){if(E in H){k(H[E],D,t,w)}}}return I}function n(v,x,t,s){var u,w;u=j(v.length);w=l(v,e,u);return k(w,x,t,s)}function e(t,u,s){t[s]=u;return t}function i(u,w,t,s){function v(x){return w(x[0])}return o(u,1,v,t,s)}function d(u,v){var t,s;s=u.length;t=j(s);for(;s>=0;--s){if(s in u){t[s]=k(u[s],v)}}return l(t,e,t)}function l(w,u,s){var v,t;v=w.length;t=[function(y,z,x){return k(y,function(A){return k(z,function(B){return u(A,B,x,v)})})}];if(arguments.length>=3){t.push(s)}return q(r.apply(w,t))}function b(s,v,u){var t=arguments.length>2;return k(s,function(w){v.resolve(t?u:w)},v.reject,v.progress)}k.defer=c;k.isPromise=h;k.some=o;k.all=n;k.any=i;k.reduce=l;k.map=d;k.chain=b;return k})})(typeof define=="function"?define:function(a){typeof module!="undefined"?(module.exports=a()):(this.when=a())});