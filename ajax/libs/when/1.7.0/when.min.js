!function(n){"use strict";n(function(){function n(n,r,e,u){return t(n).then(r,e,u)}function t(n){var t,r;return n instanceof e?t=n:c(n)?(r=i(),n.then(function(n){r.resolve(n)},function(n){r.reject(n)},function(n){r.progress(n)}),t=r.promise):t=u(n),t}function r(t){return n(t,o)}function e(n){this.then=n}function u(n){var r=new e(function(r){try{return t(r?r(n):n)}catch(e){return o(e)}});return r}function o(n){var r=new e(function(r,e){try{return e?t(e(n)):o(n)}catch(u){return o(u)}});return r}function i(){function n(n,t,r){return l(n,t,r)}function r(n){return v(n)}function u(n){return v(o(n))}function c(n){return p(n)}var f,s,h,a,l,p,v;return s=new e(n),f={then:n,resolve:r,reject:u,progress:c,promise:s,resolver:{resolve:r,reject:u,progress:c}},h=[],a=[],l=function(n,t,r){var e,u;return e=i(),u="function"==typeof r?function(n){try{e.progress(r(n))}catch(t){e.progress(t)}}:function(n){e.progress(n)},h.push(function(r){r.then(n,t).then(e.resolve,e.reject,u)}),a.push(u),e.promise},p=function(n){return g(a,n),n},v=function(n){return n=t(n),l=n.then,v=t,p=y,g(h,n),a=h=b,n},f}function c(n){return n&&"function"==typeof n.then}function f(t,r,e,u,o){return m(2,arguments),n(t,function(t){function c(n){g(n)}function f(n){v(n)}var s,h,a,l,p,v,g,m,j,d;if(j=t.length>>>0,s=Math.max(0,Math.min(r,j)),a=[],h=j-s+1,l=[],p=i(),s)for(m=p.progress,g=function(n){l.push(n),--h||(v=g=y,p.reject(l))},v=function(n){a.push(n),--s||(v=g=y,p.resolve(a))},d=0;j>d;++d)d in t&&n(t[d],f,c,m);else p.resolve(a);return p.then(e,u,o)})}function s(n,t,r,e){function u(n){return t?t(n[0]):n[0]}return f(n,1,u,r,e)}function h(n,t,r,e){return m(1,arguments),l(n,j).then(t,r,e)}function a(){return l(arguments,j)}function l(t,r){return n(t,function(t){var e,u,o,c,f,s;if(o=u=t.length>>>0,e=[],s=i(),o)for(c=function(t,u){n(t,r).then(function(n){e[u]=n,--o||s.resolve(e)},s.reject)},f=0;u>f;f++)f in t?c(t[f],f):--o;else s.resolve(e);return s.promise})}function p(t,r){var e=w.call(arguments,1);return n(t,function(t){var u;return u=t.length,e[0]=function(t,e,o){return n(t,function(t){return n(e,function(n){return r(t,n,o,u)})})},d.apply(t,e)})}function v(t,r,e){var u=arguments.length>2;return n(t,function(n){return n=u?e:n,r.resolve(n),n},function(n){return r.reject(n),o(n)},r.progress)}function g(n,t){for(var r,e=0;r=n[e++];)r(t)}function m(n,t){for(var r,e=t.length;e>n;)if(r=t[--e],null!=r&&"function"!=typeof r)throw new Error("arg "+e+" must be a function")}function y(){}function j(n){return n}var d,w,b;return n.defer=i,n.resolve=t,n.reject=r,n.join=a,n.all=h,n.some=f,n.any=s,n.map=l,n.reduce=p,n.chain=v,n.isPromise=c,e.prototype={always:function(n,t){return this.then(n,n,t)},otherwise:function(n){return this.then(b,n)},"yield":function(n){return this.then(function(){return n})},spread:function(n){return this.then(function(t){return h(t,function(t){return n.apply(b,t)})})}},w=[].slice,d=[].reduce||function(n){var t,r,e,u,o;if(o=0,t=Object(this),u=t.length>>>0,r=arguments,r.length<=1)for(;;){if(o in t){e=t[o++];break}if(++o>=u)throw new TypeError}else e=r[1];for(;u>o;++o)o in t&&(e=n(e,t[o],o,t));return e},n})}("function"==typeof define&&define.amd?define:function(n){"object"==typeof exports?module.exports=n():this.when=n()});