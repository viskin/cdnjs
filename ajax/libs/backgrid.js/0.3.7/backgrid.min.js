(function(root,factory){if(typeof define==="function"&&define.amd){define(["underscore","backbone"],function(_,Backbone){return root.Backgrid=factory(_,Backbone)})}else if(typeof exports==="object"){var Backbone=require("backbone");Backbone.$=Backbone.$||require("jquery");module.exports=factory(require("underscore"),Backbone)}else{root.Backgrid=factory(root._,root.Backbone)}})(this,function(_,Backbone){"use strict";var ws="	\n\f\r   ᠎    "+"         　\u2028"+"\u2029\ufeff";if(!String.prototype.trim||ws.trim()){ws="["+ws+"]";var trimBeginRegexp=new RegExp("^"+ws+ws+"*"),trimEndRegexp=new RegExp(ws+ws+"*$");String.prototype.trim=function trim(){if(this===undefined||this===null){throw new TypeError("can't convert "+this+" to object")}return String(this).replace(trimBeginRegexp,"").replace(trimEndRegexp,"")}}function lpad(str,length,padstr){var paddingLen=length-(str+"").length;paddingLen=paddingLen<0?0:paddingLen;var padding="";for(var i=0;i<paddingLen;i++){padding=padding+padstr}return padding+str}var $=Backbone.$;var Backgrid={Extension:{},resolveNameToClass:function(name,suffix){if(_.isString(name)){var key=_.map(name.split("-"),function(e){return e.slice(0,1).toUpperCase()+e.slice(1)}).join("")+suffix;var klass=Backgrid[key]||Backgrid.Extension[key];if(_.isUndefined(klass)){throw new ReferenceError("Class '"+key+"' not found")}return klass}return name},callByNeed:function(){var value=arguments[0];if(!_.isFunction(value))return value;var context=arguments[1];var args=[].slice.call(arguments,2);return value.apply(context,!!(args+"")?args:[])}};_.extend(Backgrid,Backbone.Events);var Command=Backgrid.Command=function(evt){_.extend(this,{altKey:!!evt.altKey,"char":evt["char"],charCode:evt.charCode,ctrlKey:!!evt.ctrlKey,key:evt.key,keyCode:evt.keyCode,locale:evt.locale,location:evt.location,metaKey:!!evt.metaKey,repeat:!!evt.repeat,shiftKey:!!evt.shiftKey,which:evt.which})};_.extend(Command.prototype,{moveUp:function(){return this.keyCode==38},moveDown:function(){return this.keyCode===40},moveLeft:function(){return this.shiftKey&&this.keyCode===9},moveRight:function(){return!this.shiftKey&&this.keyCode===9},save:function(){return this.keyCode===13},cancel:function(){return this.keyCode===27},passThru:function(){return!(this.moveUp()||this.moveDown()||this.moveLeft()||this.moveRight()||this.save()||this.cancel())}});var CellFormatter=Backgrid.CellFormatter=function(){};_.extend(CellFormatter.prototype,{fromRaw:function(rawData,model){return rawData},toRaw:function(formattedData,model){return formattedData}});var NumberFormatter=Backgrid.NumberFormatter=function(options){_.extend(this,this.defaults,options||{});if(this.decimals<0||this.decimals>20){throw new RangeError("decimals must be between 0 and 20")}};NumberFormatter.prototype=new CellFormatter;_.extend(NumberFormatter.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(number,model){if(_.isNull(number)||_.isUndefined(number))return"";number=parseFloat(number).toFixed(~~this.decimals);var parts=number.split(".");var integerPart=parts[0];var decimalPart=parts[1]?(this.decimalSeparator||".")+parts[1]:"";return integerPart.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+decimalPart},toRaw:function(formattedData,model){formattedData=formattedData.trim();if(formattedData==="")return null;var rawData="";var thousands=formattedData.split(this.orderSeparator);for(var i=0;i<thousands.length;i++){rawData+=thousands[i]}var decimalParts=rawData.split(this.decimalSeparator);rawData="";for(var i=0;i<decimalParts.length;i++){rawData=rawData+decimalParts[i]+"."}if(rawData[rawData.length-1]==="."){rawData=rawData.slice(0,rawData.length-1)}var result=(rawData*1).toFixed(~~this.decimals)*1;if(_.isNumber(result)&&!_.isNaN(result))return result}});var PercentFormatter=Backgrid.PercentFormatter=function(){Backgrid.NumberFormatter.apply(this,arguments)};PercentFormatter.prototype=new Backgrid.NumberFormatter,_.extend(PercentFormatter.prototype,{defaults:_.extend({},NumberFormatter.prototype.defaults,{multiplier:1,symbol:"%"}),fromRaw:function(number,model){var args=[].slice.call(arguments,1);args.unshift(number*this.multiplier);return(NumberFormatter.prototype.fromRaw.apply(this,args)||"0")+this.symbol},toRaw:function(formattedValue,model){var tokens=formattedValue.split(this.symbol);if(tokens&&tokens[0]&&tokens[1]===""||tokens[1]==null){var rawValue=NumberFormatter.prototype.toRaw.call(this,tokens[0]);if(_.isUndefined(rawValue))return rawValue;return rawValue/this.multiplier}}});var DatetimeFormatter=Backgrid.DatetimeFormatter=function(options){_.extend(this,this.defaults,options||{});if(!this.includeDate&&!this.includeTime){throw new Error("Either includeDate or includeTime must be true")}};DatetimeFormatter.prototype=new CellFormatter;_.extend(DatetimeFormatter.prototype,{defaults:{includeDate:true,includeTime:true,includeMilli:false},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(data,validate){if((data+"").trim()==="")return null;var date,time=null;if(_.isNumber(data)){var jsDate=new Date(data);date=lpad(jsDate.getUTCFullYear(),4,0)+"-"+lpad(jsDate.getUTCMonth()+1,2,0)+"-"+lpad(jsDate.getUTCDate(),2,0);time=lpad(jsDate.getUTCHours(),2,0)+":"+lpad(jsDate.getUTCMinutes(),2,0)+":"+lpad(jsDate.getUTCSeconds(),2,0)}else{data=data.trim();var parts=data.split(this.ISO_SPLITTER_RE)||[];date=this.DATE_RE.test(parts[0])?parts[0]:"";time=date&&parts[1]?parts[1]:this.TIME_RE.test(parts[0])?parts[0]:""}var YYYYMMDD=this.DATE_RE.exec(date)||[];var HHmmssSSS=this.TIME_RE.exec(time)||[];if(validate){if(this.includeDate&&_.isUndefined(YYYYMMDD[0]))return;if(this.includeTime&&_.isUndefined(HHmmssSSS[0]))return;if(!this.includeDate&&date)return;if(!this.includeTime&&time)return}var jsDate=new Date(Date.UTC(YYYYMMDD[1]*1||0,YYYYMMDD[2]*1-1||0,YYYYMMDD[3]*1||0,HHmmssSSS[1]*1||null,HHmmssSSS[2]*1||null,HHmmssSSS[3]*1||null,HHmmssSSS[5]*1||null));var result="";if(this.includeDate){result=lpad(jsDate.getUTCFullYear(),4,0)+"-"+lpad(jsDate.getUTCMonth()+1,2,0)+"-"+lpad(jsDate.getUTCDate(),2,0)}if(this.includeTime){result=result+(this.includeDate?"T":"")+lpad(jsDate.getUTCHours(),2,0)+":"+lpad(jsDate.getUTCMinutes(),2,0)+":"+lpad(jsDate.getUTCSeconds(),2,0);if(this.includeMilli){result=result+"."+lpad(jsDate.getUTCMilliseconds(),3,0)}}if(this.includeDate&&this.includeTime){result+="Z"}return result},fromRaw:function(rawData,model){if(_.isNull(rawData)||_.isUndefined(rawData))return"";return this._convert(rawData)},toRaw:function(formattedData,model){return this._convert(formattedData,true)}});var StringFormatter=Backgrid.StringFormatter=function(){};StringFormatter.prototype=new CellFormatter;_.extend(StringFormatter.prototype,{fromRaw:function(rawValue,model){if(_.isUndefined(rawValue)||_.isNull(rawValue))return"";return rawValue+""}});var EmailFormatter=Backgrid.EmailFormatter=function(){};EmailFormatter.prototype=new CellFormatter;_.extend(EmailFormatter.prototype,{toRaw:function(formattedData,model){var parts=formattedData.trim().split("@");if(parts.length===2&&_.all(parts)){return formattedData}}});var SelectFormatter=Backgrid.SelectFormatter=function(){};SelectFormatter.prototype=new CellFormatter;_.extend(SelectFormatter.prototype,{fromRaw:function(rawValue,model){return _.isArray(rawValue)?rawValue:rawValue!=null?[rawValue]:[]}});var CellEditor=Backgrid.CellEditor=Backbone.View.extend({initialize:function(options){this.formatter=options.formatter;this.column=options.column;if(!(this.column instanceof Column)){this.column=new Column(this.column)}this.listenTo(this.model,"backgrid:editing",this.postRender)},postRender:function(model,column){if(column==null||column.get("name")==this.column.get("name")){this.$el.focus()}return this}});var InputCellEditor=Backgrid.InputCellEditor=CellEditor.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(options){InputCellEditor.__super__.initialize.apply(this,arguments);if(options.placeholder){this.$el.attr("placeholder",options.placeholder)}},render:function(){var model=this.model;this.$el.val(this.formatter.fromRaw(model.get(this.column.get("name")),model));return this},saveOrCancel:function(e){var formatter=this.formatter;var model=this.model;var column=this.column;var command=new Command(e);var blurred=e.type==="blur";if(command.moveUp()||command.moveDown()||command.moveLeft()||command.moveRight()||command.save()||blurred){e.preventDefault();e.stopPropagation();var val=this.$el.val();var newValue=formatter.toRaw(val,model);if(_.isUndefined(newValue)){model.trigger("backgrid:error",model,column,val)}else{model.set(column.get("name"),newValue);model.trigger("backgrid:edited",model,column,command)}}else if(command.cancel()){e.stopPropagation();model.trigger("backgrid:edited",model,column,command)}},postRender:function(model,column){if(column==null||column.get("name")==this.column.get("name")){if(this.$el.css("text-align")==="right"){var val=this.$el.val();this.$el.focus().val(null).val(val)}else this.$el.focus()}return this}});var Cell=Backgrid.Cell=Backbone.View.extend({tagName:"td",formatter:CellFormatter,editor:InputCellEditor,events:{click:"enterEditMode"},initialize:function(options){this.column=options.column;if(!(this.column instanceof Column)){this.column=new Column(this.column)}var column=this.column,model=this.model,$el=this.$el;var formatter=Backgrid.resolveNameToClass(column.get("formatter")||this.formatter,"Formatter");if(!_.isFunction(formatter.fromRaw)&&!_.isFunction(formatter.toRaw)){formatter=new formatter}this.formatter=formatter;this.editor=Backgrid.resolveNameToClass(this.editor,"CellEditor");this.listenTo(model,"change:"+column.get("name"),function(){if(!$el.hasClass("editor"))this.render()});this.listenTo(model,"backgrid:error",this.renderError);this.listenTo(column,"change:editable change:sortable change:renderable",function(column){var changed=column.changedAttributes();for(var key in changed){if(changed.hasOwnProperty(key)){$el.toggleClass(key,changed[key])}}});this.updateStateClassesMaybe()},updateStateClassesMaybe:function(){var model=this.model;var column=this.column;var $el=this.$el;$el.toggleClass("editable",Backgrid.callByNeed(column.editable(),column,model));$el.toggleClass("sortable",Backgrid.callByNeed(column.sortable(),column,model));$el.toggleClass("renderable",Backgrid.callByNeed(column.renderable(),column,model))},render:function(){var $el=this.$el;$el.empty();var model=this.model;var columnName=this.column.get("name");$el.text(this.formatter.fromRaw(model.get(columnName),model));$el.addClass(columnName);this.updateStateClassesMaybe();this.delegateEvents();return this},enterEditMode:function(){var model=this.model;var column=this.column;var editable=Backgrid.callByNeed(column.editable(),column,model);if(editable){this.currentEditor=new this.editor({column:this.column,model:this.model,formatter:this.formatter});model.trigger("backgrid:edit",model,column,this,this.currentEditor);this.undelegateEvents();this.$el.empty();this.$el.append(this.currentEditor.$el);this.currentEditor.render();this.$el.addClass("editor");model.trigger("backgrid:editing",model,column,this,this.currentEditor)}},renderError:function(model,column){if(column==null||column.get("name")==this.column.get("name")){this.$el.addClass("error")}},exitEditMode:function(){this.$el.removeClass("error");this.currentEditor.remove();this.stopListening(this.currentEditor);delete this.currentEditor;this.$el.removeClass("editor");this.render()},remove:function(){if(this.currentEditor){this.currentEditor.remove.apply(this.currentEditor,arguments);delete this.currentEditor}return Cell.__super__.remove.apply(this,arguments)}});var StringCell=Backgrid.StringCell=Cell.extend({className:"string-cell",formatter:StringFormatter});var UriCell=Backgrid.UriCell=Cell.extend({className:"uri-cell",title:null,target:"_blank",initialize:function(options){UriCell.__super__.initialize.apply(this,arguments);this.title=options.title||this.title;this.target=options.target||this.target},render:function(){this.$el.empty();var rawValue=this.model.get(this.column.get("name"));var formattedValue=this.formatter.fromRaw(rawValue,this.model);this.$el.append($("<a>",{tabIndex:-1,href:rawValue,title:this.title||formattedValue,target:this.target}).text(formattedValue));this.delegateEvents();return this}});var EmailCell=Backgrid.EmailCell=StringCell.extend({className:"email-cell",formatter:EmailFormatter,render:function(){this.$el.empty();var model=this.model;var formattedValue=this.formatter.fromRaw(model.get(this.column.get("name")),model);this.$el.append($("<a>",{tabIndex:-1,href:"mailto:"+formattedValue,title:formattedValue}).text(formattedValue));this.delegateEvents();return this}});var NumberCell=Backgrid.NumberCell=Cell.extend({className:"number-cell",decimals:NumberFormatter.prototype.defaults.decimals,decimalSeparator:NumberFormatter.prototype.defaults.decimalSeparator,orderSeparator:NumberFormatter.prototype.defaults.orderSeparator,formatter:NumberFormatter,initialize:function(options){NumberCell.__super__.initialize.apply(this,arguments);var formatter=this.formatter;formatter.decimals=this.decimals;formatter.decimalSeparator=this.decimalSeparator;formatter.orderSeparator=this.orderSeparator}});var IntegerCell=Backgrid.IntegerCell=NumberCell.extend({className:"integer-cell",decimals:0});var PercentCell=Backgrid.PercentCell=NumberCell.extend({className:"percent-cell",multiplier:PercentFormatter.prototype.defaults.multiplier,symbol:PercentFormatter.prototype.defaults.symbol,formatter:PercentFormatter,initialize:function(){PercentCell.__super__.initialize.apply(this,arguments);var formatter=this.formatter;formatter.multiplier=this.multiplier;formatter.symbol=this.symbol}});var DatetimeCell=Backgrid.DatetimeCell=Cell.extend({className:"datetime-cell",includeDate:DatetimeFormatter.prototype.defaults.includeDate,includeTime:DatetimeFormatter.prototype.defaults.includeTime,includeMilli:DatetimeFormatter.prototype.defaults.includeMilli,formatter:DatetimeFormatter,initialize:function(options){DatetimeCell.__super__.initialize.apply(this,arguments);var formatter=this.formatter;formatter.includeDate=this.includeDate;formatter.includeTime=this.includeTime;formatter.includeMilli=this.includeMilli;var placeholder=this.includeDate?"YYYY-MM-DD":"";placeholder+=this.includeDate&&this.includeTime?"T":"";placeholder+=this.includeTime?"HH:mm:ss":"";placeholder+=this.includeTime&&this.includeMilli?".SSS":"";this.editor=this.editor.extend({attributes:_.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:placeholder})})}});var DateCell=Backgrid.DateCell=DatetimeCell.extend({className:"date-cell",includeTime:false});var TimeCell=Backgrid.TimeCell=DatetimeCell.extend({className:"time-cell",includeDate:false});var BooleanCellEditor=Backgrid.BooleanCellEditor=CellEditor.extend({tagName:"input",attributes:{tabIndex:-1,type:"checkbox"},events:{mousedown:function(){this.mouseDown=true},blur:"enterOrExitEditMode",mouseup:function(){this.mouseDown=false},change:"saveOrCancel",keydown:"saveOrCancel"},render:function(){var model=this.model;var val=this.formatter.fromRaw(model.get(this.column.get("name")),model);this.$el.prop("checked",val);return this},enterOrExitEditMode:function(e){if(!this.mouseDown){var model=this.model;model.trigger("backgrid:edited",model,this.column,new Command(e))}},saveOrCancel:function(e){var model=this.model;var column=this.column;var formatter=this.formatter;var command=new Command(e);if(command.passThru()&&e.type!="change")return true;if(command.cancel()){e.stopPropagation();model.trigger("backgrid:edited",model,column,command)}var $el=this.$el;if(command.save()||command.moveLeft()||command.moveRight()||command.moveUp()||command.moveDown()){e.preventDefault();e.stopPropagation();var val=formatter.toRaw($el.prop("checked"),model);model.set(column.get("name"),val);model.trigger("backgrid:edited",model,column,command)}else if(e.type=="change"){var val=formatter.toRaw($el.prop("checked"),model);model.set(column.get("name"),val);$el.focus()}}});var BooleanCell=Backgrid.BooleanCell=Cell.extend({className:"boolean-cell",editor:BooleanCellEditor,events:{click:"enterEditMode"},render:function(){this.$el.empty();var model=this.model,column=this.column;var editable=Backgrid.callByNeed(column.editable(),column,model);this.$el.append($("<input>",{tabIndex:-1,type:"checkbox",checked:this.formatter.fromRaw(model.get(column.get("name")),model),disabled:!editable}));this.delegateEvents();return this}});var SelectCellEditor=Backgrid.SelectCellEditor=CellEditor.extend({tagName:"select",events:{change:"save",blur:"close",keydown:"close"},template:_.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>',null,{variable:null,evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g}),setOptionValues:function(optionValues){this.optionValues=optionValues;this.optionValues=_.result(this,"optionValues")},setMultiple:function(multiple){this.multiple=multiple;this.$el.prop("multiple",multiple)},_renderOptions:function(nvps,selectedValues){var options="";for(var i=0;i<nvps.length;i++){options=options+this.template({text:nvps[i][0],value:nvps[i][1],selected:_.indexOf(selectedValues,nvps[i][1])>-1})}return options},render:function(){this.$el.empty();var optionValues=_.result(this,"optionValues");var model=this.model;var selectedValues=this.formatter.fromRaw(model.get(this.column.get("name")),model);if(!_.isArray(optionValues))throw new TypeError("optionValues must be an array");var optionValue=null;var optionText=null;var optionValue=null;var optgroupName=null;var optgroup=null;for(var i=0;i<optionValues.length;i++){var optionValue=optionValues[i];if(_.isArray(optionValue)){optionText=optionValue[0];optionValue=optionValue[1];this.$el.append(this.template({text:optionText,value:optionValue,selected:_.indexOf(selectedValues,optionValue)>-1}))}else if(_.isObject(optionValue)){optgroupName=optionValue.name;optgroup=$("<optgroup></optgroup>",{label:optgroupName});optgroup.append(this._renderOptions.call(this,optionValue.values,selectedValues));this.$el.append(optgroup)}else{throw new TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }")}}this.delegateEvents();return this},save:function(e){var model=this.model;var column=this.column;model.set(column.get("name"),this.formatter.toRaw(this.$el.val(),model))},close:function(e){var model=this.model;var column=this.column;var command=new Command(e);if(command.cancel()){e.stopPropagation();model.trigger("backgrid:edited",model,column,new Command(e))}else if(command.save()||command.moveLeft()||command.moveRight()||command.moveUp()||command.moveDown()||e.type=="blur"){e.preventDefault();e.stopPropagation();this.save(e);model.trigger("backgrid:edited",model,column,new Command(e))}}});var SelectCell=Backgrid.SelectCell=Cell.extend({className:"select-cell",editor:SelectCellEditor,multiple:false,formatter:SelectFormatter,optionValues:undefined,delimiter:", ",initialize:function(options){SelectCell.__super__.initialize.apply(this,arguments);this.listenTo(this.model,"backgrid:edit",function(model,column,cell,editor){if(column.get("name")==this.column.get("name")){editor.setOptionValues(this.optionValues);editor.setMultiple(this.multiple)}})},render:function(){this.$el.empty();var optionValues=_.result(this,"optionValues");var model=this.model;var rawData=this.formatter.fromRaw(model.get(this.column.get("name")),model);var selectedText=[];try{if(!_.isArray(optionValues)||_.isEmpty(optionValues))throw new TypeError;for(var k=0;k<rawData.length;k++){var rawDatum=rawData[k];for(var i=0;i<optionValues.length;i++){var optionValue=optionValues[i];if(_.isArray(optionValue)){var optionText=optionValue[0];var optionValue=optionValue[1];if(optionValue==rawDatum)selectedText.push(optionText)}else if(_.isObject(optionValue)){var optionGroupValues=optionValue.values;for(var j=0;j<optionGroupValues.length;j++){var optionGroupValue=optionGroupValues[j];if(optionGroupValue[1]==rawDatum){selectedText.push(optionGroupValue[0])}}}else{throw new TypeError}}}this.$el.append(selectedText.join(this.delimiter))}catch(ex){if(ex instanceof TypeError){throw new TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}")}throw ex}this.delegateEvents();return this}});var Column=Backgrid.Column=Backbone.Model.extend({defaults:{name:undefined,label:undefined,sortable:true,editable:true,renderable:true,formatter:undefined,sortType:"cycle",sortValue:undefined,direction:null,cell:undefined,headerCell:undefined},initialize:function(){if(!this.has("label")){this.set({label:this.get("name")},{silent:true})}var headerCell=Backgrid.resolveNameToClass(this.get("headerCell"),"HeaderCell");var cell=Backgrid.resolveNameToClass(this.get("cell"),"Cell");this.set({cell:cell,headerCell:headerCell},{silent:true})},sortValue:function(){var sortValue=this.get("sortValue");if(_.isString(sortValue))return this[sortValue];else if(_.isFunction(sortValue))return sortValue;return function(model,colName){return model.get(colName)}}});_.each(["sortable","renderable","editable"],function(key){Column.prototype[key]=function(){var value=this.get(key);if(_.isString(value))return this[value];else if(_.isFunction(value))return value;return!!value}});var Columns=Backgrid.Columns=Backbone.Collection.extend({model:Column});var Row=Backgrid.Row=Backbone.View.extend({tagName:"tr",initialize:function(options){var columns=this.columns=options.columns;if(!(columns instanceof Backbone.Collection)){columns=this.columns=new Columns(columns)}var cells=this.cells=[];for(var i=0;i<columns.length;i++){cells.push(this.makeCell(columns.at(i),options))}this.listenTo(columns,"add",function(column,columns){var i=columns.indexOf(column);var cell=this.makeCell(column,options);cells.splice(i,0,cell);var $el=this.$el;if(i===0){$el.prepend(cell.render().$el)}else if(i===columns.length-1){$el.append(cell.render().$el)}else{$el.children().eq(i).before(cell.render().$el)}});this.listenTo(columns,"remove",function(column,columns,opts){cells[opts.index].remove();cells.splice(opts.index,1)})},makeCell:function(column){return new(column.get("cell"))({column:column,model:this.model})},render:function(){this.$el.empty();var fragment=document.createDocumentFragment();for(var i=0;i<this.cells.length;i++){fragment.appendChild(this.cells[i].render().el)}this.el.appendChild(fragment);this.delegateEvents();return this},remove:function(){for(var i=0;i<this.cells.length;i++){var cell=this.cells[i];cell.remove.apply(cell,arguments)}return Backbone.View.prototype.remove.apply(this,arguments)}});var EmptyRow=Backgrid.EmptyRow=Backbone.View.extend({tagName:"tr",emptyText:null,initialize:function(options){this.emptyText=options.emptyText;this.columns=options.columns},render:function(){this.$el.empty();var td=document.createElement("td");td.setAttribute("colspan",this.columns.length);var span=document.createElement("span");span.innerHTML=_.result(this,"emptyText");td.appendChild(span);this.el.className="empty";this.el.appendChild(td);return this}});var HeaderCell=Backgrid.HeaderCell=Backbone.View.extend({tagName:"th",events:{"click a":"onClick"},initialize:function(options){this.column=options.column;if(!(this.column instanceof Column)){this.column=new Column(this.column)}var column=this.column,collection=this.collection,$el=this.$el;this.listenTo(column,"change:editable change:sortable change:renderable",function(column){var changed=column.changedAttributes();for(var key in changed){if(changed.hasOwnProperty(key)){$el.toggleClass(key,changed[key])}}});this.listenTo(column,"change:direction",this.setCellDirection);this.listenTo(column,"change:name change:label",this.render);if(Backgrid.callByNeed(column.editable(),column,collection))$el.addClass("editable");if(Backgrid.callByNeed(column.sortable(),column,collection))$el.addClass("sortable");if(Backgrid.callByNeed(column.renderable(),column,collection))$el.addClass("renderable");this.listenTo(collection.fullCollection||collection,"sort",this.removeCellDirection)},removeCellDirection:function(){this.$el.removeClass("ascending").removeClass("descending");this.column.set("direction",null)},setCellDirection:function(column,direction){this.$el.removeClass("ascending").removeClass("descending");if(column.cid==this.column.cid)this.$el.addClass(direction)},onClick:function(e){e.preventDefault();var column=this.column;var collection=this.collection;var event="backgrid:sort";function cycleSort(header,col){if(column.get("direction")==="ascending")collection.trigger(event,col,"descending");else if(column.get("direction")==="descending")collection.trigger(event,col,null);else collection.trigger(event,col,"ascending")}function toggleSort(header,col){if(column.get("direction")==="ascending")collection.trigger(event,col,"descending");else collection.trigger(event,col,"ascending")}var sortable=Backgrid.callByNeed(column.sortable(),column,this.collection);if(sortable){var sortType=column.get("sortType");if(sortType==="toggle")toggleSort(this,column);else cycleSort(this,column)}},render:function(){this.$el.empty();var column=this.column;var sortable=Backgrid.callByNeed(column.sortable(),column,this.collection);var label;if(sortable){label=$("<a>").text(column.get("label")).append("<b class='sort-caret'></b>")}else{label=document.createTextNode(column.get("label"))}this.$el.append(label);this.$el.addClass(column.get("name"));this.$el.addClass(column.get("direction"));this.delegateEvents();return this}});var HeaderRow=Backgrid.HeaderRow=Backgrid.Row.extend({initialize:function(){Backgrid.Row.prototype.initialize.apply(this,arguments)},makeCell:function(column,options){var headerCell=column.get("headerCell")||options.headerCell||HeaderCell;headerCell=new headerCell({column:column,collection:this.collection});return headerCell}});var Header=Backgrid.Header=Backbone.View.extend({tagName:"thead",initialize:function(options){this.columns=options.columns;if(!(this.columns instanceof Backbone.Collection)){this.columns=new Columns(this.columns)}this.row=new Backgrid.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){this.$el.append(this.row.render().$el);this.delegateEvents();return this},remove:function(){this.row.remove.apply(this.row,arguments);return Backbone.View.prototype.remove.apply(this,arguments)}});var Body=Backgrid.Body=Backbone.View.extend({tagName:"tbody",initialize:function(options){this.columns=options.columns;if(!(this.columns instanceof Backbone.Collection)){this.columns=new Columns(this.columns)}this.row=options.row||this.row||Row;this.rows=this.collection.map(function(model){var row=new this.row({columns:this.columns,model:model});return row},this);this.emptyText=options.emptyText;this._unshiftEmptyRowMayBe();var collection=this.collection;this.listenTo(collection,"add",this.insertRow);this.listenTo(collection,"remove",this.removeRow);this.listenTo(collection,"sort",this.refresh);this.listenTo(collection,"reset",this.refresh);this.listenTo(collection,"backgrid:sort",this.sort);this.listenTo(collection,"backgrid:edited",this.moveToNextCell);this.listenTo(this.columns,"add remove",this.updateEmptyRow)},_unshiftEmptyRowMayBe:function(){if(this.rows.length===0&&this.emptyText!=null){this.emptyRow=new EmptyRow({emptyText:this.emptyText,columns:this.columns});this.rows.unshift(this.emptyRow);return true}},insertRow:function(model,collection,options){if(this.rows[0]instanceof EmptyRow)this.rows.pop().remove();if(!(collection instanceof Backbone.Collection)&&!options){this.collection.add(model,options=collection);return}var row=new this.row({columns:this.columns,model:model});var index=collection.indexOf(model);this.rows.splice(index,0,row);var $el=this.$el;var $children=$el.children();var $rowEl=row.render().$el;if(index>=$children.length){$el.append($rowEl)}else{$children.eq(index).before($rowEl)}return this},removeRow:function(model,collection,options){if(!options){this.collection.remove(model,options=collection);if(this._unshiftEmptyRowMayBe()){this.render()}return}if(_.isUndefined(options.render)||options.render){this.rows[options.index].remove()}this.rows.splice(options.index,1);if(this._unshiftEmptyRowMayBe()){this.render()}return this},updateEmptyRow:function(){if(this.emptyRow!=null){this.emptyRow.render()}},refresh:function(){for(var i=0;i<this.rows.length;i++){this.rows[i].remove()}this.rows=this.collection.map(function(model){var row=new this.row({columns:this.columns,model:model});return row},this);this._unshiftEmptyRowMayBe();this.render();this.collection.trigger("backgrid:refresh",this);return this},render:function(){this.$el.empty();var fragment=document.createDocumentFragment();for(var i=0;i<this.rows.length;i++){var row=this.rows[i];fragment.appendChild(row.render().el)}this.el.appendChild(fragment);this.delegateEvents();return this},remove:function(){for(var i=0;i<this.rows.length;i++){var row=this.rows[i];row.remove.apply(row,arguments)}return Backbone.View.prototype.remove.apply(this,arguments)},sort:function(column,direction){if(!_.contains(["ascending","descending",null],direction)){throw new RangeError('direction must be one of "ascending", "descending" or `null`')}if(_.isString(column))column=this.columns.findWhere({name:column});var collection=this.collection;var order;if(direction==="ascending")order=-1;else if(direction==="descending")order=1;else order=null;var comparator=this.makeComparator(column.get("name"),order,order?column.sortValue():function(model){return model.cid.replace("c","")*1});if(Backbone.PageableCollection&&collection instanceof Backbone.PageableCollection){collection.setSorting(order&&column.get("name"),order,{sortValue:column.sortValue()});if(collection.fullCollection){if(collection.fullCollection.comparator==null){collection.fullCollection.comparator=comparator}collection.fullCollection.sort();collection.trigger("backgrid:sorted",column,direction,collection)}else collection.fetch({reset:true,success:function(){collection.trigger("backgrid:sorted",column,direction,collection)}})}else{collection.comparator=comparator;collection.sort();collection.trigger("backgrid:sorted",column,direction,collection)}column.set("direction",direction);return this},makeComparator:function(attr,order,func){return function(left,right){var l=func(left,attr),r=func(right,attr),t;if(order===1)t=l,l=r,r=t;if(l===r)return 0;else if(l<r)return-1;return 1}},moveToNextCell:function(model,column,command){var i=this.collection.indexOf(model);var j=this.columns.indexOf(column);var cell,renderable,editable,m,n;if(j===-1)return this;this.rows[i].cells[j].exitEditMode();if(command.moveUp()||command.moveDown()||command.moveLeft()||command.moveRight()||command.save()){var l=this.columns.length;var maxOffset=l*this.collection.length;if(command.moveUp()||command.moveDown()){m=i+(command.moveUp()?-1:1);var row=this.rows[m];if(row){cell=row.cells[j];if(Backgrid.callByNeed(cell.column.editable(),cell.column,model)){cell.enterEditMode();model.trigger("backgrid:next",m,j,false)}}else model.trigger("backgrid:next",m,j,true)}else if(command.moveLeft()||command.moveRight()){var right=command.moveRight();for(var offset=i*l+j+(right?1:-1);offset>=0&&offset<maxOffset;right?offset++:offset--){m=~~(offset/l);n=offset-m*l;cell=this.rows[m].cells[n];renderable=Backgrid.callByNeed(cell.column.renderable(),cell.column,cell.model);editable=Backgrid.callByNeed(cell.column.editable(),cell.column,model);if(renderable&&editable){cell.enterEditMode();model.trigger("backgrid:next",m,n,false);break}}if(offset==maxOffset){model.trigger("backgrid:next",~~(offset/l),offset-m*l,true)}}}return this}});var Footer=Backgrid.Footer=Backbone.View.extend({tagName:"tfoot",initialize:function(options){
this.columns=options.columns;if(!(this.columns instanceof Backbone.Collection)){this.columns=new Backgrid.Columns(this.columns)}}});var Grid=Backgrid.Grid=Backbone.View.extend({tagName:"table",className:"backgrid",header:Header,body:Body,footer:null,initialize:function(options){if(!(options.columns instanceof Backbone.Collection)){options.columns=new Columns(options.columns||this.columns)}this.columns=options.columns;var filteredOptions=_.omit(options,["el","id","attributes","className","tagName","events"]);this.body=options.body||this.body;this.body=new this.body(filteredOptions);this.header=options.header||this.header;if(this.header){this.header=new this.header(filteredOptions)}this.footer=options.footer||this.footer;if(this.footer){this.footer=new this.footer(filteredOptions)}this.listenTo(this.columns,"reset",function(){if(this.header){this.header=new(this.header.remove().constructor)(filteredOptions)}this.body=new(this.body.remove().constructor)(filteredOptions);if(this.footer){this.footer=new(this.footer.remove().constructor)(filteredOptions)}this.render()})},insertRow:function(){this.body.insertRow.apply(this.body,arguments);return this},removeRow:function(){this.body.removeRow.apply(this.body,arguments);return this},insertColumn:function(){this.columns.add.apply(this.columns,arguments);return this},removeColumn:function(){this.columns.remove.apply(this.columns,arguments);return this},sort:function(){this.body.sort.apply(this.body,arguments);return this},render:function(){this.$el.empty();if(this.header){this.$el.append(this.header.render().$el)}if(this.footer){this.$el.append(this.footer.render().$el)}this.$el.append(this.body.render().$el);this.delegateEvents();this.trigger("backgrid:rendered",this);return this},remove:function(){this.header&&this.header.remove.apply(this.header,arguments);this.body.remove.apply(this.body,arguments);this.footer&&this.footer.remove.apply(this.footer,arguments);return Backbone.View.prototype.remove.apply(this,arguments)}});return Backgrid});