L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(key,options){L.Util.setOptions(this,options),this._key=key,this._url=null,this._providers=[],this.metaRequested=!1},tile2quad:function(x,y,z){for(var quad="",i=z;i>0;i--){var digit=0,mask=1<<i-1;0!==(x&mask)&&(digit+=1),0!==(y&mask)&&(digit+=2),quad+=digit}return quad},getTileUrl:function(p,z){var zoom=this._getZoomForUrl(),subdomains=this.options.subdomains,s=this.options.subdomains[Math.abs((p.x+p.y)%subdomains.length)];return this._url.replace("{subdomain}",s).replace("{quadkey}",this.tile2quad(p.x,p.y,zoom)).replace("{culture}",this.options.culture)},loadMetadata:function(){if(!this.metaRequested){this.metaRequested=!0;var _this=this,cbid="_bing_metadata_"+L.Util.stamp(this);window[cbid]=function(meta){window[cbid]=void 0;var e=document.getElementById(cbid);e.parentNode.removeChild(e),meta.errorDetails||_this.initMetadata(meta)};var urlScheme="file:"===document.location.protocol?"http":document.location.protocol.slice(0,-1),url=urlScheme+"://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+cbid+"&key="+this._key+"&UriScheme="+urlScheme,script=document.createElement("script");script.type="text/javascript",script.src=url,script.id=cbid,document.getElementsByTagName("head")[0].appendChild(script)}},initMetadata:function(meta){var r=meta.resourceSets[0].resources[0];if(this.options.subdomains=r.imageUrlSubdomains,this._url=r.imageUrl,r.imageryProviders)for(var i=0;i<r.imageryProviders.length;i++)for(var p=r.imageryProviders[i],j=0;j<p.coverageAreas.length;j++){var c=p.coverageAreas[j],coverage={zoomMin:c.zoomMin,zoomMax:c.zoomMax,active:!1},bounds=new L.LatLngBounds(new L.LatLng(c.bbox[0]+.01,c.bbox[1]+.01),new L.LatLng(c.bbox[2]-.01,c.bbox[3]-.01));coverage.bounds=bounds,coverage.attrib=p.attribution,this._providers.push(coverage)}this._update()},_update:function(){null!==this._url&&this._map&&(this._update_attribution(),L.TileLayer.prototype._update.apply(this,[]))},_update_attribution:function(){for(var bounds=this._map.getBounds(),zoom=this._map.getZoom(),i=0;i<this._providers.length;i++){var p=this._providers[i];zoom<=p.zoomMax&&zoom>=p.zoomMin&&bounds.intersects(p.bounds)?(!p.active&&this._map.attributionControl&&this._map.attributionControl.addAttribution(p.attrib),p.active=!0):(p.active&&this._map.attributionControl&&this._map.attributionControl.removeAttribution(p.attrib),p.active=!1)}},onAdd:function(map){this.loadMetadata(),L.TileLayer.prototype.onAdd.apply(this,[map])},onRemove:function(map){for(var i=0;i<this._providers.length;i++){var p=this._providers[i];p.active&&this._map.attributionControl&&(this._map.attributionControl.removeAttribution(p.attrib),p.active=!1)}L.TileLayer.prototype.onRemove.apply(this,[map])}}),L.bingLayer=function(key,options){return new L.BingLayer(key,options)};