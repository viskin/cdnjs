L.Yandex=L.Class.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,attribution:"",opacity:1,traffic:!1},possibleShortMapTypes:{schemaMap:"map",satelliteMap:"satellite",hybridMap:"hybrid",publicMap:"publicMap",publicMapInHybridView:"publicMapHybrid"},_getPossibleMapType:function(mapType){var result="yandex#map";if("string"!=typeof mapType)return result;for(var key in this.possibleShortMapTypes){if(mapType===this.possibleShortMapTypes[key]){result="yandex#"+mapType;break}mapType==="yandex#"+this.possibleShortMapTypes[key]&&(result=mapType)}return result},initialize:function(type,options){L.Util.setOptions(this,options),this._type=this._getPossibleMapType(type)},onAdd:function(map,insertAtTheBottom){this._map=map,this._insertAtTheBottom=insertAtTheBottom,this._initContainer(),this._initMapObject(),map.on("viewreset",this._resetCallback,this),this._limitedUpdate=L.Util.limitExecByInterval(this._update,150,this),map.on("move",this._update,this),map._controlCorners.bottomright.style.marginBottom="3em",this._reset(),this._update(!0)},onRemove:function(map){this._map._container.removeChild(this._container),this._map.off("viewreset",this._resetCallback,this),this._map.off("move",this._update,this),map._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(opacity){this.options.opacity=opacity,1>opacity&&L.DomUtil.setOpacity(this._container,opacity)},setElementSize:function(e,size){e.style.width=size.x+"px",e.style.height=size.y+"px"},_initContainer:function(){var tilePane=this._map._container,first=tilePane.firstChild;this._container||(this._container=L.DomUtil.create("div","leaflet-yandex-layer leaflet-top leaflet-left"),this._container.id="_YMapContainer_"+L.Util.stamp(this),this._container.style.zIndex="auto"),this.options.overlay&&(first=this._map._container.getElementsByClassName("leaflet-map-pane")[0],first=first.nextSibling,L.Browser.opera&&(this._container.className+=" leaflet-objects-pane")),tilePane.insertBefore(this._container,first),this.setOpacity(this.options.opacity),this.setElementSize(this._container,this._map.getSize())},_initMapObject:function(){if(!this._yandex){if(void 0===ymaps.Map)return ymaps.load(["package.map"],this._initMapObject,this);if(this.options.traffic&&(void 0===ymaps.control||void 0===ymaps.control.TrafficControl))return ymaps.load(["package.traffic","package.controls"],this._initMapObject,this);var map=new ymaps.Map(this._container,{center:[0,0],zoom:0,behaviors:[],controls:[]});this.options.traffic&&map.controls.add(new ymaps.control.TrafficControl({shown:!0})),"yandex#null"===this._type&&(this._type=new ymaps.MapType("null",[]),map.container.getElement().style.background="transparent"),map.setType(this._type),this._yandex=map,this._update(!0),this.fire("MapObjectInitialized",{mapObject:map})}},_resetCallback:function(e){this._reset(e.hard)},_reset:function(clearOldContainer){this._initContainer()},_update:function(force){if(this._yandex){this._resize(force);var center=this._map.getCenter(),_center=[center.lat,center.lng],zoom=this._map.getZoom();(force||this._yandex.getZoom()!==zoom)&&this._yandex.setZoom(zoom),this._yandex.panTo(_center,{duration:0,delay:0})}},_resize:function(force){var size=this._map.getSize(),style=this._container.style;if(style.width!==size.x+"px"||style.height!==size.y+"px"||force===!0){this.setElementSize(this._container,size);var b=this._map.getBounds();b.getSouthWest(),b.getNorthEast();this._yandex.container.fitToViewport()}}});