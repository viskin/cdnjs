L.GPX=L.FeatureGroup.extend({initialize:function(gpx,options){L.Util.setOptions(this,options),this._gpx=gpx,this._layers={},gpx&&this.addGPX(gpx,options,this.options.async)},loadXML:function(url,cb,options,async){void 0===async&&(async=this.options.async),void 0===options&&(options=this.options);var req=new window.XMLHttpRequest;req.open("GET",url,async);try{req.overrideMimeType("text/xml")}catch(e){}req.onreadystatechange=function(){4===req.readyState&&200===req.status&&cb(req.responseXML,options)},req.send(null)},_humanLen:function(l){return 2e3>l?l.toFixed(0)+" m":(l/1e3).toFixed(1)+" km"},_polylineLen:function(line){for(var ll=line._latlngs,d=0,p=null,i=0;i<ll.length;i++)i&&p&&(d+=p.distanceTo(ll[i])),p=ll[i];return d},addGPX:function(url,options,async){var _this=this,cb=function(gpx,options){_this._addGPX(gpx,options)};this.loadXML(url,cb,options,async)},_addGPX:function(gpx,options){var layers=this.parseGPX(gpx,options);layers&&(this.addLayer(layers),this.fire("loaded"))},parseGPX:function(xml,options){var j,i,el,layers=[],named=!1,tags=[["rte","rtept"],["trkseg","trkpt"]];for(j=0;j<tags.length;j++)for(el=xml.getElementsByTagName(tags[j][0]),i=0;i<el.length;i++)for(var l=this.parse_trkseg(el[i],xml,options,tags[j][1]),k=0;k<l.length;k++)this.parse_name(el[i],l[k])&&(named=!0),layers.push(l[k]);if(el=xml.getElementsByTagName("wpt"),options.display_wpt!==!1)for(i=0;i<el.length;i++){var marker=this.parse_wpt(el[i],xml,options);marker&&(this.parse_name(el[i],marker)&&(named=!0),layers.push(marker))}if(layers.length){var layer=layers[0];return layers.length>1&&(layer=new L.FeatureGroup(layers)),named||this.parse_name(xml,layer),layer}},parse_name:function(xml,layer){var i,el,name,txt="",descr="",len=0;for(el=xml.getElementsByTagName("name"),el.length&&(name=el[0].childNodes[0].nodeValue),el=xml.getElementsByTagName("desc"),i=0;i<el.length;i++)for(var j=0;j<el[i].childNodes.length;j++)descr+=el[i].childNodes[j].nodeValue;return layer instanceof L.Path&&(len=this._polylineLen(layer)),name&&(txt+="<h2>"+name+"</h2>"+descr),len&&(txt+="<p>"+this._humanLen(len)+"</p>"),layer&&void 0===layer._popup&&layer.bindPopup(txt),txt},parse_trkseg:function(line,xml,options,tag){var el=line.getElementsByTagName(tag);if(!el.length)return[];for(var coords=[],i=0;i<el.length;i++){var ll=new L.LatLng(el[i].getAttribute("lat"),el[i].getAttribute("lon"));ll.meta={};for(var j in el[i].childNodes){var e=el[i].childNodes[j];e.tagName&&(ll.meta[e.tagName]=e.textContent)}coords.push(ll)}var l=[new L.Polyline(coords,options)];return this.fire("addline",{line:l}),l},parse_wpt:function(e,xml,options){for(var m=new L.Marker(new L.LatLng(e.getAttribute("lat"),e.getAttribute("lon")),options),attributes={},i=0;i<e.childNodes.length;i++){var ch=e.childNodes[i];"#text"!==ch.nodeName&&(attributes[ch.nodeName]=ch.textContent)}return this.fire("addpoint",{point:m,attributes:attributes}),m}});