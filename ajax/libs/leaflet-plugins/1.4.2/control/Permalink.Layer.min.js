L.Control.Permalink.include({initialize_layer:function(){this.on("update",this._set_layer,this),this.on("add",this._onadd_layer,this)},_onadd_layer:function(e){this._map.on("layeradd",this._update_layer,this),this._map.on("layerremove",this._update_layer,this),this._update_layer()},_update_layer:function(){if(this.options.layers){var layer=this.options.layers.currentBaseLayer();layer&&this._update({layer:layer.name})}},_set_layer:function(e){var p=e.params;this.options.layers&&p.layer&&this.options.layers.chooseBaseLayer(p.layer)}}),L.Control.Layers.include({chooseBaseLayer:function(name){var layer,obj;for(var i in this._layers)this._layers.hasOwnProperty(i)&&(obj=this._layers[i],obj.overlay||obj.name!==name||(layer=obj.layer));if(layer&&!this._map.hasLayer(layer)){for(var j in this._layers)this._layers.hasOwnProperty(j)&&(obj=this._layers[j],!obj.overlay&&this._map.hasLayer(obj.layer)&&this._map.removeLayer(obj.layer));this._map.addLayer(layer),this._update()}},currentBaseLayer:function(){for(var i in this._layers)if(this._layers.hasOwnProperty(i)){var obj=this._layers[i];if(!obj.overlay&&!obj.overlay&&this._map.hasLayer(obj.layer))return obj}}});