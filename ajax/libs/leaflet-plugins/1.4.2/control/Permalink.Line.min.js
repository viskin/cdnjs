L.Control.Permalink.include({initialize_line:function(){this.on("update",this._set_line,this),this.on("add",this._onadd_line,this)},_onadd_line:function(e){this.options.line&&(this.options.line.on("edit",this._update_line,this),this._update_line())},_update_line:function(){if(this.options.line){var line=this.options.line;if(line){var text=[],coords=line.getLatLngs();if(!coords.length)return this._update({line:null});for(var i in coords)text.push(coords[i].lat.toFixed(4)+","+coords[i].lng.toFixed(4));this._update({line:text.join(";")})}}},_set_line:function(e){var p=e.params,l=this.options.line;if(l&&p.line){var coords=[],text=p.line.split(";");for(var i in text){var ll=text[i].split(",");2===ll.length&&coords.push(new L.LatLng(ll[0],ll[1]))}coords.length&&(l.setLatLngs(coords),this._map.hasLayer(l)||this._map.addLayer(l))}}});