/**
 * API Bound Models for AngularJS
 * @version v0.8.1 - 2013-12-09
 * @link https://github.com/angular-platanus/restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";a.module("plRestmod",["ng","platanus.inflector"]);var c={chain:function(a,b){return a?function(c){return b.call(this,a.call(this,c))}:b},override:function(a,b){return a&&"function"==typeof b?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b},extendOverriden:function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=c.override(a[d],b[d]))}};a.module("plRestmod").constant("Utils",c);var d={NONE:0,ALL:65535,SYSTEM_ALL:131071,SYSTEM:65536,DECODE_CREATE:1,DECODE_UPDATE:2,DECODE_USER:4,DECODE_SAVE:3,ENCODE_CREATE:256,ENCODE_UPDATE:512,ENCODE_USER:1024,ENCODE_SAVE:768,DECODE:255,ENCODE:65280,CREATE:257,UPDATE:514,USER:1028,SAVE:771},e=a.bind,f=a.forEach,g=a.extend,h=a.isObject,i=a.isArray,j=a.isFunction,k=Array.prototype.slice;a.module("plRestmod").provider("$restmod",function(){var a=[];return{pushModelBase:function(){return Array.prototype.push.apply(a,arguments),this},$get:["$http","$q","$injector","$parse","$filter","$inflector",function(l,m,n,o,p,q){return{model:function(r){function s(a,b){var c=D[a];if(c)for(var d,e=0,f=k.call(arguments,2);d=c[e++];)d.apply(b,f)}function t(a,b,c,d){s("before-request",a,b),a.$pending=!0,a.$response=null,a.$error=!1,a.$promise=l(b).then(function(b){return a.$pending=!1,a.$response=b,s("after-request",a,b),c&&c.call(a,b),a},function(b){return a.$pending=!1,a.$response=b,a.$error=!0,s("after-request-error",a,b),d&&d.call(a,b),m.reject(a)})}function u(a,c,d,e,f,g){var h,i,j,k,l,m,n=g||{};for(h in a)if(a.hasOwnProperty(h)&&(i=f&&E?E(h):h,k=d+i,!((z[k]||0)&e))){if(m=a[h],l=f?B[k]:C[k]){if(m=l.call(c,m),m===b)continue}else"object"==typeof m&&m&&(f||"function"!=typeof m.toJSON)&&(m=v(m,c,k,e,f));j=!f&&F?F(i):i,n[j]=m}return n}function v(a,b,c,d,e){if(i(a)){var f,g,h,j=c+"[]",k=e?B[j]:C[j],l=[];for(f=0,g=a.length;g>f;f++)h=a[f],k?h=k.call(b,h):"object"==typeof h&&h&&(e||"function"!=typeof h.toJSON)&&(h=v(h,b,c,d,e)),l.push(h);return l}return u(a,b,c+".",d,e)}function w(a){for(var b=0,c=a.length;c>b;b++)x(a[b])}function x(a){a.$chain?w(a.$chain):"string"==typeof a?x(n.get(a)):i(a)||j(a)?n.invoke(a,K,{$builder:K}):K.describe(a)}var y,z={$partial:d.SYSTEM_ALL,$context:d.SYSTEM_ALL,$promise:d.SYSTEM_ALL,$pending:d.SYSTEM_ALL,$response:d.SYSTEM_ALL,$error:d.SYSTEM_ALL},A=[],B={},C={},D={},E=q.camelize,F=function(a){return q.parameterize(a,"_")},G=function(a,b,c){this.$pending=!1,this.$partial=b,this.$context=c;for(var d,e=0;d=A[e];e++)this[d[0]]="function"==typeof d[1]?d[1].apply(this):d[1];if(a)for(d in a)a.hasOwnProperty(d)&&(this[d]=a[d])};G.prototype={$url:function(a){return y.resourceUrl(this,a)},$each:function(a,c,e){c===b&&(c=d.SYSTEM);for(var f in this)this.hasOwnProperty(f)&&((z[f]||0)&c||a.call(e||this[f],this[f],f));return this},$callback:function(a){return s(this,a,k.call(arguments,1)),this},$send:function(a,b,c){return t(this,a,b,c),this},$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$finally:function(a){return this.$promise=this.$promise["finally"](a),this},$decode:function(a,b){return u(a,this,"",b||d.DECODE_USER,!0,this),s("after-feed",this,a),this},$encode:function(a){var b=u(this,this,"",a||d.ENCODE_USER,!1);return s("before-render",this,b),b},$fetch:function(){if(!this.$url())throw new Error("Cannot fetch an unbound resource");var a={method:"GET",url:this.$url()};return s("before-fetch",this,a),this.$send(a,function(a){var b=a.data;if(!b||i(b))throw new Error("Expected object while feeding resource");this.$decode(b),s("after-fetch",this,a)},function(a){s("after-fetch-error",this,a)})},$save:function(){var a,b;if(this.$url()){if(a=y.updateUrl(this),!a)throw new Error("Update is not supported by this resource");return b={method:"PUT",url:a,data:this.$encode(d.ENCODE_UPDATE)},s("before-update",this,b),s("before-save",this,b),this.$send(b,function(a){var b=a.data;b&&!i(b)&&this.$decode(b,d.DECODE_UPDATE),s("after-update",this,a),s("after-save",this,a)},function(a){s("after-update-error",this,a),s("after-save-error",this,a)})}if(a=y.createUrl(this),!a)throw new Error("Create is not supported by this resource");return b={method:"POST",url:a,data:this.$encode(d.ENCODE_CREATE)},s("before-save",this,b),s("before-create",this,b),this.$send(b,function(a){var b=a.data;b&&!i(b)&&this.$decode(b,d.DECODE_CREATE),s("after-create",this,a),s("after-save",this,a)},function(a){s("after-create-error",this,a),s("after-save-error",this,a)})},$destroy:function(){var a=y.destroyUrl(this);if(!a)throw new Error("Destroy is not supported by this resource");var b={method:"DELETE",url:a};return s("before-destroy",this,b),this.$send(b,function(a){s("after-destroy",this,a)},function(a){s("after-destroy-error",this,a)})}};var H,I={$url:function(a){return y.collectionUrl(this,a)},$build:function(a){var b,c;if(h(a))b=a;else{if(b={},c=y.inferKey(this),!c)throw new Error("Cannot infer key, use explicit mode");b[c]=a}var d=new G(b,null,this);return this.$isCollection&&this.push(d),d},$buildRaw:function(a){return this.$build(null).$decode(a)},$create:function(a){return this.$build(a).$save()},$find:function(a){var b,c;if(h(a))b=a;else{if(b={},c=y.inferKey(this),!c)throw new Error("Cannot infer key, use explicit mode");b[c]=a}return new G(b,null,this).$fetch()},$collection:function(a,b,c){a=this.$params?g({},this.$params,a):a;var d=[];for(var e in I)this.hasOwnProperty(e)&&(d[e]=this[e]);return d.$partial=b||this.$partial,d.$context=c||this.$context,d.$isCollection=!0,d.$params=a,d.$pending=!1,d.$resolved=!1,d},$search:function(a){return this.$collection(a).$fetch()},$then:function(a,b){if(!this.$isCollection)throw new Error("$then is only supported by collections");return this.$promise=this.$promise.then(a,b),this},$finally:function(a){return this.$promise=this.$promise["finally"](a),this},$feed:function(a){if(!this.$isCollection)throw new Error("$feed is only supported by collections");return this.$resolved||(this.length=0),f(a,this.$buildRaw,this),this.$resolved=!0,this},$reset:function(){if(!this.$isCollection)throw new Error("$reset is only supported by collections");return this.$resolved=!1,this},$fetch:function(a){if(!this.$isCollection)throw new Error("$fetch is only supported by collections");var b=a?g({},this.$params||{},a):this.$params,c={method:"GET",url:this.$url(),params:b};return s("before-fetch-many",this,c),t(this,c,function(a){var b=a.data;if(!b||!i(b))throw new Error("Error in resource {0} configuration. Expected response to be array");this.$feed(b),s("after-fetch-many",this,a)},function(a){s("after-fetch-many-error",this,a)}),this},$refresh:function(a){return this.$reset().$fetch(a)}},J={init:["attrDefault"],mask:["attrMask"],ignore:["attrMask"],decode:["attrDecoder","param","chain"],encode:["attrEncoder","param","chain"],serialize:["attrSerializer"],hasMany:["hasMany","alias"],hasOne:["hasOne","alias"]},K={setHttpOptions:function(){},setUrlBuilderFactory:function(a){return H=a,this},setNameDecoder:function(a){return E=a,this},setNameEncoder:function(a){return F=a,this},disableRenaming:function(){return this.setNameDecoder(!1).setNameEncoder(!1)},extend:function(a,b,d){return"string"==typeof a?(this[a]=c.override(this[name],b),d&&(J[d[0]]=d,d[0]=a)):c.extendOverriden(this,a),this},describe:function(a){return f(a,function(a,b){h(a)?this.attribute(b,a):j(a)?this.define(b,a):this.attrDefault(b,a)},this),this},attribute:function(a,b){var c,d,e,f;for(c in b)if(b.hasOwnProperty(c)&&(d=J[c])){for(e=[a,b[c]],f=1;f<d.length;f++)e.push(b[d[f]]);e.push(b),this[d[0]].apply(this,e)}return this},attrDefault:function(a,b){return A.push([a,b]),this},attrMask:function(a,b,c){return b===!0?z[a]=d.ALL:b===!1?delete z[a]:c?z[a]=b:z[a]|=b,this},attrSerializer:function(a,b,c){return"string"==typeof b&&(b=n.get(q.camelize(b,!0)+"Serializer")),j(b)&&(b=b(c)),b.decode&&this.attrDecoder(a,e(b,b.decode)),b.encode&&this.attrEncoder(a,e(b,b.encode)),this},attrDecoder:function(a,b,d,e){if("string"==typeof b){var f=p(b);b=function(a){return f(a,d)}}return B[a]=e?c.chain(B[a],b):b,this},attrEncoder:function(a,b,d,e){if("string"==typeof b){var f=p(b);b=function(a){return f(a,d)}}return C[a]=e?c.chain(C[a],b):b,this},hasMany:function(a,b,c){return this.attrDefault(a,function(){return"string"==typeof b&&(b=n.get(b)),b.$collection(null,c||q.parameterize(a),this)}).attrDecoder(a,function(b){this[a].$feed(b)}).attrMask(a,d.ENCODE)},hasOne:function(a,b,c){return this.attrDefault(a,function(){return"string"==typeof b&&(b=n.get(b)),new b(null,c||q.parameterize(a),this)}).attrDecoder(a,function(b){this[a].$decode(b)}).attrMask(a,d.ENCODE)},define:function(a,b){return"string"==typeof a?G.prototype[a]=c.override(G.prototype[a],b):c.extendOverriden(G.prototype,a),this},classDefine:function(a,b){return"string"==typeof a?I[a]=c.override(I[a],b):c.extendOverriden(I,a),this},on:function(a,b){var c=D[a];return c||(c=D[a]=[]),c.push(b),this},beforeRequest:function(a){return this.on("before-request",a)},afterRequest:function(a){return this.on("after-request",a)},afterRequestError:function(a){return this.on("after-request-error",a)},beforeSave:function(a){return this.on("before-save",a)},beforeCreate:function(a){return this.on("before-create",a)},afterCreate:function(a){return this.on("after-create",a)},beforeUpdate:function(a){return this.on("before-update",a)},afterUpdate:function(a){return this.on("after-update",a)},afterSave:function(a){return this.on("after-save",a)},beforeDestroy:function(a){return this.on("before-destroy",a)},afterDestroy:function(a){return this.on("after-destroy",a)},afterFeed:function(a){return this.on("after-feed",a)},beforeRender:function(a){return this.on("before-render",a)},attrExpression:function(a,b){var c=o(b);this.on("after-feed",function(){this[a]=c(this)})}};return w(a),w(G.$chain=k.call(arguments,1)),y=(H||n.get("restUrlBuilderFactory")())(r),g(G,I),G},mixin:function(){return{$isAbstract:!0,$chain:k.call(arguments,0)}}}}]}}).factory("model",["$restmod",function(a){return a.model}]).factory("mixin",["$restmod",function(a){return a.mixin}]).constant("SyncMask",d),a.module("plRestmod").constant("restUrlBuilderFactory",function(){function a(a){for(var c,d=1,e=(a+"").replace(/\/$/,"");(c=arguments[d++])!==b;)e+="/"+(c+"").replace(/(\/$|^\/)/g,"");return e}return function(c){c=c||{};var d=c.primary||"id";return function(e){function f(a,d){if(a){a=a.replace(/\/$/,"");var e=d&&d.extension!==b?d.extension:c.extension;e&&(a+="."!==e[0]?"."+e:e)}return a}return c.baseUrl&&(e=a(c.baseUrl,e)),{inferKey:function(){return d},resourceUrl:function(b,c){var g=b.$partial,h=b[d];if(null!=h&&e)return f(a(e,h),c);if(b.$context){var i=b.$context.$url({extension:!1});if(null!=g&&b.$context)return f(a(i,g),c);if(null!=h&&b.$context)return f(a(i,h),c)}return null!=g?f(g):null},collectionUrl:function(b,c){if(b.$context){var d=b.$context.$url({extension:!1});return d?f(b.$partial?a(d,b.$partial):d,c):null}return b.$partial?f(b.$partial,c):f(e,c)},createUrl:function(a){return a.$context?a.$context.$url():f(e)},updateUrl:function(a){return this.resourceUrl(a)},destroyUrl:function(a){return this.resourceUrl(a)}}}}}()).config(["$restmodProvider",function(a){a.pushModelBase(["$injector",function(a){this.extend("setRestUrlOptions",function(b){return this.setUrlBuilderFactory(a.get("restUrlBuilderFactory")(b))})}])}])}(angular);