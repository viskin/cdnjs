/**
 * API Bound Models for AngularJS
 * @version v0.3.0 - 2013-10-17
 * @link https://github.com/angular-platanus/angular-restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("plRestmod",["ng"]),angular.module("plRestmod").factory("ModelBuilder",["$injector","$parse","$filter","Utils","SyncMask",function(a,b,c,d,e){function f(a,b){return a?function(c){return b.call(this,a.call(this,c))}:b}function g(a,b){return a?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b}function h(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=g(a[c],b[c]))}function i(b){return a.get(d.camelcase(b)+"Serializer")}var j=angular.bind,k=angular.forEach,l=angular.isFunction,m=angular.isObject;return function(n){var o={primary:["attrPrimary"],init:["attrDefault"],ignore:["attrIgnored"],decode:["attrDecoder","param","chain"],encode:["attrEncoder","param","chain"],type:["attrSerializer"],hasMany:["hasMany","alias"],hasOne:["hasOne","alias"]};return{extend:function(a,b,c){return"string"==typeof a?(this[a]=g(this[name],b),c&&(o[c[0]]=c,c[0]=a)):h(this,a),this},describe:function(a){return k(a,function(a,b){m(a)?this.attribute(b,a):l(a)?this.define(b,a):this.attrDefault(b,a)},this),this},attribute:function(a,b){var c,d,e,f;for(c in b)if(b.hasOwnProperty(c)&&(d=o[c])){for(e=[a,b[c]],f=1;f<d.length;f++)e.push(b[d[f]]);e.push(b),this[d[0]].apply(this,e)}return this},attrPrimary:function(a,b){return b&&n.urlBuilder.addPrimaryKey(a),this},attrDefault:function(a,b){return n.defaults.push([a,b]),this},attrIgnored:function(a,b,c){return b===!0?n.masks[a]=e.ALL:b===!1?delete n.masks[a]:c?n.masks[a]=b:n.masks[a]|=b,this},attrSerializer:function(a,b,c){return"string"==typeof b&&(b=i(b)),l(b)&&(b=b(c)),b.decode&&this.attrDecoder(a,j(b,b.decode)),b.encode&&this.attrEncoder(a,j(b,b.encode)),this},attrDecoder:function(a,b,d,e){if("string"==typeof b){var g=c(b);b=function(a){return g(a,d)}}return n.decoders[a]=e?f(n.decoders[a],b):b,this},attrEncoder:function(a,b,d,e){if("string"==typeof b){var g=c(b);b=function(a){return g(a,d)}}return n.encoders[a]=e?f(n.encoders[a],b):b,this},hasMany:function(b,c,e){return this.attrDefault(b,function(){return"string"==typeof c&&(c=a.get(c)),c.$collection(null,e||d.snakecase(b,"-"),this)}).attrDecoder(b,function(a){this[b].$feed(a)})},hasOne:function(b,c,e){return this.attrDefault(b,function(){return"string"==typeof c&&(c=a.get(c)),new c(null,e||d.snakecase(b,"-"),this)}).attrDecoder(b,function(a){this[b].$decode(a)})},define:function(a,b){return"string"==typeof a?n.objectProto[a]=g(n.objectProto[a],b):h(n.objectProto,a),this},classDefine:function(a,b){return"string"==typeof a?n.classProto[a]=g(n.classProto[a],b):h(n.classProto,a),this},on:function(a,b){var c=n.callbacks[a];return c||(c=n.callbacks[a]=[]),c.push(b),this},beforeSave:function(a){return this.on("before_save",a)},beforeCreate:function(a){return this.on("before_create",a)},afterCreate:function(a){return this.on("after_create",a)},beforeUpdate:function(a){return this.on("before_update",a)},afterUpdate:function(a){return this.on("after_update",a)},afterSave:function(a){return this.on("after_save",a)},beforeDestroy:function(a){return this.on("before_destroy",a)},afterDestroy:function(a){return this.on("after_destroy",a)},afterFeed:function(a){return this.on("after_feed",a)},beforeRender:function(a){return this.on("before_render",a)},attrVolatile:function(a,b){return this.attrDefault(a,b).attrEncoder(a,function(c){return this[a]=l(b)?b.call(this):b,c},null,!0)},attrExpression:function(a,c){var d=b(c);this.on("after_feed",function(){this[a]=d(this)})}}}}]),angular.module("plRestmod").constant("RestUrlBuilderFactory",function(){return function(a,b){return function(c){return b&&(c=b+"/"+c),{setPrimaryKey:function(b){a=b},inferKey:function(){return a},resourceUrl:function(b){var d,e=b.$partial;if(!e){if(d=b[a],null===d||void 0===d)return null;if(c)return c+"/"+d}if(b.$context){var f=b.$context.$url();return f?f+"/"+(e||d):null}return e||null},collectionUrl:function(a){if(a.$context){var b=a.$context.$url();return b?a.$partial?b+"/"+a.$partial:b:null}return a.$partial?a.$partial:c},createUrl:function(a){return a.$context?a.$context.$url():c},updateUrl:function(a){return this.resourceUrl(a)},destroyUrl:function(a){return this.resourceUrl(a)}}}}}());var $restmodMinErr=angular.noop;angular.module("plRestmod").constant("Utils",{camelcase:function(a){return"string"!=typeof a?a:a.replace(/_[\w\d]/g,function(a,b,c){return 0===b?a:c.charAt(b+1).toUpperCase()})},snakecase:function(a,b){return"string"!=typeof a?a:a.replace(/[A-Z]/g,function(a,c){return 0===c?a:(b||"_")+a.toLowerCase()})}}).constant("SyncMask",{NONE:0,ALL:65535,DECODE_CREATE:1,DECODE_UPDATE:2,DECODE_USER:4,DECODE_SAVE:3,ENCODE_CREATE:256,ENCODE_UPDATE:512,ENCODE_USER:1024,ENCODE_SAVE:768,DECODE:255,ENCODE:65280,CREATE:257,UPDATE:514,USER:1028,SAVE:771}).provider("$restmod",["Utils","SyncMask",function(a,b){var c,d,e=angular.forEach,f=angular.extend,g=angular.isObject,h=angular.isArray,i=Array.prototype.slice,j=a.camelcase,k=a.snakecase,l=[];return{pushModelBase:function(){return Array.prototype.push.apply(l,arguments),this},setUrlBuilder:function(a){return c=a,this},setAttributeRenaming:function(b){return b?b===!0?(j=a.camelcase,k=a.snakecase):(j=b.decode,k=b.encode):j=k=null,this},$get:["$http","$q","$injector",function(a,m,n){function o(a,b){if(a.$meta)o(a.$meta,b);else if("string"==typeof a)o(n.get(a),b);else if(h(a))for(var c,d=0;c=a[d++];)o(c,b);else"function"==typeof a?a.call(b,b):b.describe(a)}c||(c=n.get("RestUrlBuilderFactory")("id")),d||(d=n.get("ModelBuilder"));var p=function(n){function p(a,b){var c=x[a];if(c)for(var d,e=0,f=i.call(arguments,2);d=c[e++];)d.apply(b,f)}function q(b,c,d,e){b.$pending=!0,b.$error=!1,b.$promise=a(c).then(function(a){return b.$pending=!1,d&&d.call(b,a),b},function(a){return b.$pending=!1,b.$error=!0,e&&e.call(b,a),m.reject(b)})}var r={},s=r.urlBuilder=g(n)?n:c(n),t=r.masks={$partial:b.ALL,$context:b.ALL,$promise:b.ALL,$pending:b.ALL,$error:b.ALL},u=r.defaults=[],v=r.decoders={},w=r.encoders={},x=r.callbacks={},y=function(a,b,c){this.$pending=!1,this.$partial=b,this.$context=c;for(var d,e=0;d=u[e];e++)this[d[0]]="function"==typeof d[1]?d[1].apply(this):d[1];if(a)for(d in a)a.hasOwnProperty(d)&&(this[d]=a[d])};r.classProto=f(y,{$url:function(){return s.collectionUrl(this)},$build:function(a){var b,c;if(g(a))b=a;else{if(b={},c=s.inferKey(this),!c)throw $restmodMinErr("notsup","Cannot infer build key, use explicit mode");b[c]=a}var d=new y(b,null,this);return this.$isCollection&&this.push(d),d},$buildRaw:function(a){return this.$build(null).$decode(a)},$create:function(a,b,c){return this.$build(a).$save(b,c)},$find:function(a,b,c){var d,e;if(g(a))d=a;else{if(d={},e=s.inferKey(this),!e)throw $restmodMinErr("notsup","Cannot infer find key, use explicit mode");d[e]=a}return new y(d,null,this).$fetch(b,c)},$collection:function(a,b,c){a=this.$params?f({},this.$params,a):a;var d=[];for(var e in this)this.hasOwnProperty(e)&&(d[e]=this[e]);return d.$partial=b||this.$partial,d.$context=c||this.$context,d.$isCollection=!0,d.$params=a,d.$pending=!1,d.$resolved=!1,d},$search:function(a,b,c){return this.$collection(a).$fetch(b,c)},$then:function(a,b){return this.$isCollection&&(this.$promise=this.$promise.then(a,b)),this},$reset:function(){return this.$isCollection&&(this.$resolved=!1,this.length=0),this},$feed:function(a){return this.$isCollection&&(e(a,this.$buildRaw,this),this.$resolved=!0),this},$fetch:function(a){if(this.$isCollection){var b=a?f({},this.$params||{},a):this.$params;q(this,{method:"GET",url:this.$url(),params:b},function(a){var b=a.data;if(!b||!h(b))throw $restmodMinErr("badcfg","Error in resource {0} configuration. Expected response to be array");this.$reset().$feed(b),p("after_collection_fetch",this,a)})}return this}}),r.objectProto=y.prototype={$url:function(){return s.resourceUrl(this)},$callback:function(a){return p(this,a,i.call(arguments,1)),this},$send:function(a,b,c){return q(this,a,b,c),this},$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$decode:function(a,c){c||(c=b.DECODE_USER);var d,e,f,g,h={};for(d in a)!a.hasOwnProperty(d)||(t[d]||0)&c||(e=j?j(d):d,f=v[e],g=f?f.call(this,a[d]):a[d],void 0!==g&&(h[e]=this[e]=g));return p("after_feed",this,h,a),this},$encode:function(a){a||(a=b.ENCODE_USER);var c,d,e,f={};for(c in this)!this.hasOwnProperty(c)||(t[c]||0)&a||(d=k?k(c):c,e=w[c],f[d]=e?e.call(this,this[c]):this[c]);return p("before_render",this,f),f},$fetch:function(){if(!this.$url())throw $restmodMinErr("notsup","Cannot fetch an unbound resource");return this.$send({method:"GET",url:this.$url(),feed:!0},function(a){var b=a.data;if(!b||h(b))throw $restmodMinErr("badresp","Expected object while feeding resource");this.$decode(b)})},$save:function(){var a;if(this.$url()){if(a=s.updateUrl(this),!a)throw $restmodMinErr("notsup","Update is not supported by this resource");return p("before_update",this),p("before_save",this),this.$send({method:"PUT",url:a,data:this.$encode(b.ENCODE_CREATE)},function(a){var c=a.data;c&&!h(c)&&this.$decode(c,b.DECODE_UPDATE),p("after_update",this),p("after_save",this)})}if(a=s.createUrl(this),!a)throw $restmodMinErr("notsup","Create is not supported by this resource");return p("before_save",this),p("before_create",this),this.$send({method:"POST",url:a,data:this.$encode(b.ENCODE_UPDATE)},function(a){var c=a.data;c&&!h(c)&&this.$decode(c,b.DECODE_CREATE),p("after_create",this),p("after_save",this)})},$destroy:function(){var a=s.destroyUrl(this);if(!a)throw $restmodMinErr("notsup","Destroy is not supported by this resource");return p("before_destroy",this),this.$send({method:"DELETE",url:a},function(){p("after_destroy",this)})}},y.$isAbstract=!1,y.$meta=i.call(arguments,1);var z=d(r);return o(l,z),o(y.$meta,z),y};return p.abstract=function(){return{$isAbstract:!0,$meta:i.call(arguments,0)}},p}]}}]);