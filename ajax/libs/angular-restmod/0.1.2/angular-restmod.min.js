/**
 * API Bound Models for AngularJS
 * @version v0.1.2 - 2013-09-26
 * @link https://github.com/angular-platanus/angular-restmod
 * @author Ignacio Baixas <iobaixas@gmai.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var $restmodMinErr=angular.noop;angular.module("plRestmod",["ng"]).provider("$restmod",[function(){function a(a){return i(a)?a.replace(/_[\w\d]/g,function(a,b,c){return 0===b?a:c.charAt(b+1).toUpperCase()}):a}function b(a){return i(a)?a.replace(/[A-Z]/g,function(a,b){return 0===b?a:"_"+a.toLowerCase()}):a}var c=angular.forEach,d=angular.extend,e=angular.noop,f=angular.isFunction,g=angular.isObject,h=angular.isArray,i=angular.isString,j=Array.prototype.slice,k=function(a){this.primary=a};k.prototype={get:function(a){var b={primary:this.primary};return{setPrimaryKey:function(a){b.primary=a},inferKey:function(){return b.primary},queryUrl:function(){return a},resourceUrl:function(c){var d=c[b.primary];return null===d||void 0===d?null:a?a+"/"+d:c.$context&&c.$context.$url?c.$context.$url+"/"+d:null},createUrl:function(b){return b.$context&&b.$context.$url?b.$context.$url:a},updateUrl:function(a){return a.$url},destroyUrl:function(a){return a.$url},nestedUrl:function(a,b){return a.$url+"/"+b}}}};var l=new k("id"),m={"rails-date":function(a){if(!a)return a;var b=a.match(/(\d{2,4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);return b?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10),parseInt(b[4],10),parseInt(b[5],10),parseInt(b[6],10)):(b=a.match(/(\d{2,4})-(\d{2})-(\d{2})/))?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10)):(b=a.match(/(\d{2,4})\/(\d{2})\/(\d{2})/),b?new Date(parseInt(b[1],10),parseInt(b[2],10)-1,parseInt(b[3],10)):null)}};return{setUrlBuilder:function(a){return l=a,this},addTransformation:function(a,b){return g(a)?d(m,a):m[a]=b,this},addDatatype:function(){},$get:["$http","$q","$injector",function(k,n,o){return function(p){function q(a,b){var c=x[a];if(c)for(var d,e=0,f=j.call(arguments,2);d=c[e++];)d.apply(b,f)}function r(a,b,c,d){a.$pending=!0,a.$error=!1,a.$promise=k(b).then(function(b){return a.$pending=!1,(c||e).call(a,b),a},function(b){return a.$pending=!1,a.$error=!0,(d||e).call(a,b),n.reject(a)})}var s=g(p)?p:l.get(p),t={$url:!0,$promise:!0,$pending:!0,$error:!0,$context:!0,$relcache:!0},u={},v={},w={},x={},y=function(a,b,c){this.$pending=!1,this.$context=c,this.$url=b;var d,e;for(d in u)u.hasOwnProperty(d)&&(e=u[d],this[d]="function"==typeof e?e.apply(this):e);if(a){for(d in a)a.hasOwnProperty(d)&&(this[d]=a[d]);this.$url||(this.$url=s.resourceUrl(this))}};y.prototype=d({$isBound:function(){return!!this.$url},$callback:function(a){return q(this,a,j.call(arguments,1)),this},$send:function(a,b,c){return r(this,a,b,c),this},$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$feed:function(b){var c,d,e,f;for(c in b)b.hasOwnProperty(c)&&(d=a(c),e=v[d],f=e?e.call(this,b[c]):b[c],void 0!==f&&(this[d]=f));return q("after_feed",this,b),this.$url||(this.$url=s.resourceUrl(this)),this},$render:function(){var a,c,d,e={};for(a in this)this.hasOwnProperty(a)&&!t[a]&&(c=b(a),d=w[c],e[c]=d?d.call(this,this[a]):this[a]);return q("before_render",this,e),e},$fetch:function(){if(!this.$url)throw $restmodMinErr("notsup","Cannot fetch an unbound resource");return this.$send({method:"GET",url:this.$url,feed:!0},function(a){var b=a.data;if(!b||h(b))throw $restmodMinErr("badresp","Expected object while feeding resource");this.$feed(b)})},$save:function(){var a;if(this.$isBound()){if(a=s.updateUrl(this),!a)throw $restmodMinErr("notsup","Update is not supported by this resource");return q("before_update",this),q("before_save",this),this.$send({method:"PUT",url:a,data:this.$render()},function(a){var b=a.data;b&&!h(b)&&this.$feed(b),q("after_update",this),q("after_save",this)})}if(a=s.createUrl(this),!a)throw $restmodMinErr("notsup","Create is not supported by this resource");return q("before_save",this),q("before_create",this),this.$send({method:"POST",url:a,data:this.$render()},function(a){var b=a.data;b&&!h(b)&&this.$feed(b),q("after_create",this),q("after_save",this)})},$destroy:function(){var a=s.destroyUrl(this);if(!a)throw $restmodMinErr("notsup","Destroy is not supported by this resource");return q("before_destroy",this),this.$send({method:"DELETE",url:a},function(){q("after_destroy",this)})}}),y.$collection=function(a,b,e){var f=d([],y.collectionProto);return f.$url=a,f.$isCollection=!0,f.$params=b,f.$pending=!1,h(e)?(c(e,f.$buildRaw,f),f.$resolved=!0):f.$resolved=!1,f},y.collectionProto={$then:function(a,b){return this.$promise=this.$promise.then(a,b),this},$fetch:function(a){var b=a?d({},this.$params,a):this.$params;return r(this,{method:"GET",url:this.$url,params:b},function(a){var b=a.data;if(!b||!h(b))throw $restmodMinErr("badcfg","Error in resource {0} configuration. Expected response to be array");this.length=0,c(b,this.$buildRaw,this),this.$resolved=!0,q("after_collection_fetch",this,a)}),this}};var z={$build:function(a){var b=new y(a,null,this);return this.$isCollection&&this.push(b),b},$buildRaw:function(a){return this.$build(null).$feed(a)},$create:function(a,b,c){return this.$build(a).$save(b,c)},$find:function(a,b,c){var d,e;if(g(a))d=a;else{if(d={},e=s.inferKey(this),!e)throw $restmodMinErr("notsup","Cannot infer find key, use explicit mode");d[e]=a}return new y(d,null,this).$fetch(b,c)},$buildQuery:function(a){var b,c;if(this.$isCollection)b=this.$url,c=d({},this.$params,a);else{if(b=s.queryUrl(),!b)throw $restmodMinErr("notsup","Collection not supported by resource root");c=a}return y.$collection(b,c)},$search:function(a,b,c){return this.$buildQuery(a).$fetch(b,c)}},A={loadMeta:function(a){if(a.$meta)this.loadMeta(a.$meta);else if(h(a))for(var b,d=0;b=a[d++];)this.loadMeta(b);else f(a)?a.call(this,this):c(a,function(a,b){f(a)?this.define(b,a):a.hasMany?this.hasMany(b,a.hasMany,a):a.hasOne?this.hasOne(b,a.hasOne,a):(a.primary&&s.primary&&this.attrPrimary(b),a.ignore&&this.attrIgnore(b,!0),a.init&&this.attrDefault(b,a.init),a.parse&&this.attrParser(b,a.parse,a),a.render&&this.attrRenderer(b,a.render,a))},this)},attrPrimary:function(a){return s.addPrimaryKey(a),this},attrIgnore:function(a,b){return t[a]=b,this},attrDefault:function(a,b){return u[a]=b,this},attrParser:function(a,b,c){return v[a]=f(b)?b:function(a){return m[b](a,c)},this},attrRenderer:function(a,b,c){return w[a]=f(b)?b:function(a){return m[b](a,c)},this},hasMany:function(a,b,c){return y.prototype[a]=function(d){this.$relcache||(this.$relcache={});var e=this.$relcache[a];if(!e||d){var f=i(b)?o.get(b):b,g=c.url||s.nestedUrl(this,c.alias||a,f,c),j=h(d)?d:null;this.$relcache[a]=e=f.$collection(g,{},j)}return e},v[a]=function(b){this[a](b)},this},hasOne:function(a,b,c){return y.prototype[a]=function(d){this.$relcache||(this.$relcache={});var e=this.$relcache[a];if(!e||d){var f=i(b)?o.get(b):b,h=c.url||s.nestedUrl(this,c.alias||a,f,c),j=g(d)?d:null;this.$relcache[a]=e=f.$buildRaw(j,h,this)}return e},v[a]=function(b){this[a](b)},this},define:function(a,b){return g(a)?c(a,function(a,b){y.prototype[b]=a},this):y.prototype[a]=b,this},classDefine:function(a,b){return g(a)?c(a,function(a,b){this.classDefine(b,a)},this):z[a]=b,this},on:function(a,b){var c=x[a];return c||(c=x[a]=[]),c.push(b),this},beforeSave:function(a){return this.on("before_save",a)},beforeCreate:function(a){return this.on("before_create",a)},afterCreate:function(a){return this.on("after_create",a)},beforeUpdate:function(a){return this.on("before_update",a)},afterUpdate:function(a){return this.on("after_update",a)},afterSave:function(a){return this.on("after_save",a)},beforeDestroy:function(a){return this.on("before_destroy",a)},afterDestroy:function(a){return this.on("after_destroy",a)},afterFeed:function(a){return this.on("after_feed",a)},beforeRender:function(a){return this.on("before_render",a)}};return y.$meta=j.call(arguments,1),A.loadMeta(y.$meta),d(y,z),d(y.collectionProto,z),y}}]}}]);