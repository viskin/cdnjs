/**
 * API Bound Models for AngularJS
 * @version v1.0.0 - 2014-09-10
 * @link https://github.com/angular-platanus/restmod
 * @author Ignacio Baixas <ignacio@platan.us>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";var c=a.module("restmod",["ng","platanus.inflector"]);c.provider("restmod",[function(){function b(a){return function(b){b.invoke(a,this,{$builder:this})}}var c=["RMBuilderExt","RMBuilderRelations"];return{rebase:function(){var d,e,f=arguments.length;for(e=0;f>e;e++)d=arguments[e],(a.isArray(d)||a.isFunction(d))&&(d=b(d)),c.push(d);return this},$get:["RMModelFactory","$log",function(a,b){var d=Array.prototype.slice,e={model:function(e){var f=a(e,c);return arguments.length>1&&(f.$mix(d.call(arguments,1)),b.warn("Passing mixins and difinitions in the model method will be deprecated in restmod 1.1, use restmod.model().$mix() instead.")),f},mixin:function(){return{$isAbstract:!0,$$chain:d.call(arguments,0)}},singleton:function(a){return e.model.apply(this,arguments).$single(a)}};return e}]}}]).factory("model",["restmod",function(a){return a.model}]).factory("mixin",["restmod",function(a){return a.mixin}]),c.factory("RMBuilder",["$injector","inflector","RMUtils",function(b,c,d){function e(a){var b={init:["attrDefault"],mask:["attrMask"],ignore:["attrMask"],map:["attrMap","force"],decode:["attrDecoder","param","chain"],encode:["attrEncoder","param","chain"]};this.dsl=j(a,{describe:function(a){return f(a,function(a,b){switch(b.charAt(0)){case"@":b=b.substring(1),i(a)?this.classDefine(b,a):this.define(b,a);break;case"~":b=c.parameterize(b.substring(1)),this.on(b,a);break;default:k.test(b)?(b=c.camelize(b.toLowerCase()),"packer"===b?this.setPacker(a):"renamer"===b?this.setRenamer(a):this.setProperty(b,a)):g(a)?this.attribute(b,a):i(a)?this.define(b,a):this.attrDefault(b,a)}},this),this},extend:function(a,c,e){return"string"==typeof a?(this[a]=d.override(this[name],c),e&&(b[e[0]]=e,e[0]=a)):d.extendOverriden(this,a),this},attribute:function(a,c){var d,e,f,g;for(d in c)if(c.hasOwnProperty(d)&&(e=b[d])){for(f=[a,c[d]],g=1;g<e.length;g++)f.push(c[e[g]]);f.push(c),this[e[0]].apply(this,f)}return this}})}var f=a.forEach,g=a.isObject,h=a.isArray,i=a.isFunction,j=a.extend,k=/^[A-Z]+[A-Z_0-9]*$/;return e.prototype={chain:function(a){for(var b=0,c=a.length;c>b;b++)this.mixin(a[b])},mixin:function(a){a.$$chain?this.chain(a.$$chain):"string"==typeof a?this.mixin(b.get(a)):h(a)?this.chain(a):i(a)?a.call(this.dsl,b):this.dsl.describe(a)}},e}]),c.factory("RMModelFactory",["$injector","inflector","RMUtils","RMScopeApi","RMCommonApi","RMRecordApi","RMCollectionApi","RMExtendedApi","RMSerializer","RMBuilder",function(c,d,e,f,g,h,i,j,k,l){var m=/(.*?)([^\/]+)\/?$/,n=e.extendOverriden;return function(o,p){function q(a,b){this.$type=q,this.$scope=a||q,this.$pk=b,this.$initialize()}function r(a,b){var c=new C;return c.$type=q,c.$scope=a,c.$params=b,c.$initialize(),c}function s(a){return function(b){if(y){var c="function"==typeof y?new y(q):y;return c[a](b,this)}return b}}function t(){return q.$inferKey.apply(q,arguments)}function u(){return q.$getProperty.apply(q,arguments)}o=e.cleanUrl(o);var v,w={primaryKey:"id",urlPrefix:null},x=new k,y=null,z=[],A={},B={};!w.name&&o&&(w.name=d.singularize(o.replace(m,"$2"))),!w.plural&&w.name&&(w.plural=d.pluralize(w.name));var C=e.buildArrayType();return n(q,{$$chain:[],$$inferKey:t,$new:function(a,b){return new q(b||q,a)},$collection:function(a,b){return r(b||q,a)},$$getDescription:function(a){return A[a]},$inferKey:function(a){return a&&"undefined"!=typeof a[w.primaryKey]?a[w.primaryKey]:null},$getProperty:function(a,c){var d=w[a];return d!==b?d:c},$isNested:function(){return!o},$single:function(a){return new q({$urlFor:function(){return w.urlPrefix?e.joinUrl(w.urlPrefix,a):a}},"")},$url:function(){return w.urlPrefix?e.joinUrl(w.urlPrefix,o):o},$name:function(a){return a?w.plural:w.name},$urlFor:function(a){return e.joinUrl(this.$url(),a)},$mix:function(){return v.chain(arguments),this.$$chain.push.apply(this.$$chain,arguments),this},$dispatch:function(a,b,c){var d,e,f=B[a];if(f)for(d=0;e=f[d];d++)e.apply(c||this,b||[]);return this}},f),n(q.prototype,{$$inferKey:t,$initialize:function(){for(var a,b=0;a=z[b];b++)this[a[0]]="function"==typeof a[1]?a[1].apply(this):a[1]},$$pack:s("pack"),$$unpack:s("unpack"),$decode:function(a,b){x.decode(this,a,b)},$encode:function(a){return x.encode(this,a)},$getProperty:u},g,h,j),n(C.prototype,{$$inferKey:t,$new:function(a,b){return new q(b||this,a)},$collection:function(b,c){return b=this.$params?a.extend({},this.$params,b):b,r(c||this.$scope,b)},$$pack:s("packMany"),$$unpack:s("unpackMany"),$getProperty:u},f,g,i,j),v=new l(a.extend(x.dsl(),{setProperty:function(a,b){return w[a]=b,this},attrDefault:function(a,b){return z.push([a,b]),this},attrMeta:function(a,b){return A[a]=n(A[a]||{},b),this},setPacker:function(a){return"string"==typeof a&&(a=c.get(d.camelize(a,!0)+"Packer")),y=a,this},define:function(a,b){return"function"==typeof b?q.prototype[a]=e.override(q.prototype[a],b):(b.type&&(q[a]=e.override(q[a],b.type)),b.collection&&(C.prototype[a]=e.override(C.prototype[a],b.collection)),b.record&&(q.prototype[a]=e.override(q.prototype[a],b.record))),this},classDefine:function(a,b){this.define(a,{type:b,collection:b})},on:function(a,b){return(B[a]||(B[a]=[])).push(b),this}})),v.chain(p),q}}]),c.factory("RMPackerCache",[function(){var a;return{feed:function(b,c){a[b]=c},resolve:function(b){if(a){var c=b.$type,d=a[c.$name(!0)];if(d&&b.$pk)for(var e=0,f=d.length;f>e;e++)if(b.$pk===c.$$inferKey(d[e])){b.$decode(d[e]);break}}return b},prepare:function(){a={}},clear:function(){a=null}}}]),c.factory("RMSerializer",["$injector","inflector","$filter","RMUtils",function(c,d,e,f){function g(a,b){for(var c,d=0;a&&(c=b[d]);d++)a=a[c];return a}function h(a,b,c){for(var d=0,e=b.length-1;e>d;d++){var f=b[d];a=a[f]||(a[f]={})}a[b[b.length-1]]=c}return function(){function i(a,b){var c=o[a];return c&&(c===!0||-1!==c.indexOf(b))}function j(a,c,d,e,f){var h,j,l,m,n,o,p,q,u=d?d+".":"";if(n=s[d])for(p=0,q=n.length;q>p;p++)l=u+n[p].path,i(l,e)||(m=n[p].map?g(a,n[p].map):a[t?t.encode(n[p].path):n[p].path],(n[p].forced||m!==b)&&(m=k(m,l,e,f),m!==b&&(c[n[p].path]=m)));for(h in a)if(a.hasOwnProperty(h)){if(j=t?t.decode(h):h,"$"===j[0])continue;if(n){for(o=!1,p=0,q=n.length;q>p&&!(o=n[p].mapPath===h);p++);if(o)continue}if(l=u+j,r[l]||i(l,e))continue;m=k(a[h],l,e,f),m!==b&&(c[j]=m)}}function k(a,b,c,d){var e=p[b],f=a;if(e)f=e.call(d,a);else if("object"==typeof a)if(n(a)){f=[];for(var g=0,h=a.length;h>g;g++)f.push(k(a[g],b+"[]",c,d))}else a&&(f={},j(a,f,b,c,d));return f}function l(a,c,d,e,f){var g,j,k,l,n,o=d?d+".":"";for(g in a)if(a.hasOwnProperty(g)&&"$"!==g[0]){if(j=o+g,r[j]||i(j,e))continue;l=m(a[g],j,e,f),l!==b&&(k=t?t.encode(g):g,c[k]=l)}if(n=s[d])for(var p=0,q=n.length;q>p;p++)j=o+n[p].path,i(j,e)||(l=a[n[p].path],(n[p].forced||l!==b)&&(l=m(l,j,e,f),l!==b&&(n[p].map?h(c,n[p].map,l):c[t?t.encode(n[p].path):n[p].path]=l)))}function m(a,b,c,d){var e=q[b],f=a;if(e)f=e.call(d,a);else if(null!==a&&"object"==typeof a&&"function"!=typeof a.toJSON)if(n(a)){f=[];for(var g=0,h=a.length;h>g;g++)f.push(m(a[g],b+"[]",c,d))}else a&&(f={},l(a,f,b,c,d));return f}var n=a.isArray,o={},p={},q={},r={},s={},t=null;return{decode:function(a,b,c){j(b,a,"",c,a)},encode:function(a,b){var c={};return l(a,c,"",b,a),c},dsl:function(){return{setRenamer:function(a){return"string"==typeof _packer&&(a=c.get(d.camelize(a,!0)+"Renamer")),t=a,this},attrMap:function(a,b,c){var d=a.lastIndexOf("."),e=-1!==d?a.substr(0,d):"",f=-1!==d?a.substr(d+1):a;r[a]=!0;var g=s[e]||(s[e]=[]);return g.push({path:f,map:"*"===b?null:b.split("."),mapPath:b,forced:c}),this},attrMask:function(a,b){return b?o[a]=b:delete o[a],this},attrDecoder:function(a,b,c,d){if("string"==typeof b){var g=e(b);b=function(a){return g(a,c)}}return p[a]=d?f.chain(p[a],b):b,this},attrEncoder:function(a,b,c,d){if("string"==typeof b){var g=e(b);b=function(a){return g(a,c)}}return q[a]=d?f.chain(q[a],b):b,this}}}}}}]),c.factory("RMUtils",["$log",function(a){var b=[],c=function(){var a=function(){};return Object.setPrototypeOf?function(a,b){Object.setPrototypeOf(a,b)}:(new a).__proto__===a.prototype?function(a,b){a.__proto__=b}:void 0}(),d={CREATE_MASK:"C",UPDATE_MASK:"U",READ_MASK:"R",WRITE_MASK:"CU",FULL_MASK:"CRU",format:function(a,b){for(var c=0;b&&c<b.length;c++)a=a.replace("$"+(c+1),b[c]);return a},assert:function(b,c){if(!b){var e=Array.prototype.slice.call(arguments,2);throw c=d.format(c,e),a.error(c),new Error(c)}},joinUrl:function(a,b){return a&&b?(a+"").replace(/\/$/,"")+"/"+(b+"").replace(/^\//,""):null},cleanUrl:function(a){return a?a.replace(/\/$/,""):a},chain:function(a,b){return a?function(c){return b.call(this,a.call(this,c))}:b},override:function(a,b){return a&&"function"==typeof b?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b},extendOverriden:function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var e in c)c.hasOwnProperty(e)&&(a[e]=a[e]&&"function"==typeof a[e]?d.override(a[e],c[e]):c[e])}return a},buildArrayType:function(a){var d;if(c&&!a){var e=function(){var a=[];return a.push.apply(a,arguments),c(a,e.prototype),a};e.prototype=[],e.prototype.last=function(){return this[this.length-1]},d=e}else{var f=document.createElement("iframe");f.style.display="none",f.height=0,f.width=0,f.border=0,document.body.appendChild(f),window.frames[window.frames.length-1].document.write("<script>parent.RestmodArray = Array;</script>"),d=window.RestmodArray,delete window.RestmodArray;for(var g in Array.prototype)"function"!=typeof Array.prototype[g]||d.prototype[g]||(d.prototype[g]=Array.prototype[g]);document.body.removeChild(f),b.push(f)}return d}};return d}])}(angular);