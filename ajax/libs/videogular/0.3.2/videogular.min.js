"use strict";angular.module("com.2fdevs.videogular",["ngSanitize"]).constant("VG_STATES",{PLAY:"play",PAUSE:"pause",STOP:"stop"}).constant("VG_EVENTS",{ON_PLAY:"onVgPlay",ON_PAUSE:"onVgPause",ON_PLAY_PAUSE:"onVgPlayPause",ON_START_PLAYING:"onVgStartPlaying",ON_COMPLETE:"onVgComplete",ON_SET_STATE:"onVgSetState",ON_SET_VOLUME:"onVgSetVolume",ON_TOGGLE_FULLSCREEN:"onVgToggleFullscreen",ON_ENTER_FULLSCREEN:"onVgEnterFullscreen",ON_EXIT_FULLSCREEN:"onVgExitFullscreen",ON_BUFFERING:"onVgBuffering",ON_UPDATE_TIME:"onVgUpdateTime",ON_SEEK_TIME:"onVgSeekTime",ON_UPDATE_SIZE:"onVgUpdateSize",ON_UPDATE_THEME:"onVgUpdateTheme",ON_PLAYER_READY:"onVgPlayerReady",ON_LOAD_POSTER:"onVgLoadPoster",ON_ERROR:"onVgError"}).service("VG_UTILS",function(){this.fixEventOffset=function(a){if(navigator.userAgent.match(/Firefox/i)){var b=a.currentTarget.currentStyle||window.getComputedStyle(a.target,null),c=parseInt(b.borderLeftWidth,10),d=parseInt(b.borderTopWidth,10),e=a.currentTarget.getBoundingClientRect(),f=a.clientX-c-e.left,g=a.clientY-d-e.top;a.offsetX=f,a.offsetY=g}return a},this.getZIndex=function(){var a=1;return angular.element("*").filter(function(){return"auto"!==angular.element(this).css("zIndex")}).each(function(){var b=parseInt(angular.element(this).css("zIndex"));b>a&&(a=b+1)}),a},this.isMobileDevice=function(){return"undefined"!=typeof window.orientation||-1!==navigator.userAgent.indexOf("IEMobile")},this.isiOSDevice=function(){return navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)}}).run(["$window","VG_UTILS",function(a,b){var c,d={w3:{enabled:"fullscreenEnabled",element:"fullscreenElement",request:"requestFullscreen",exit:"exitFullscreen",onchange:"fullscreenchange",onerror:"fullscreenerror"},newWebkit:{enabled:"webkitFullscreenEnabled",element:"webkitFullscreenElement",request:"webkitRequestFullscreen",exit:"webkitExitFullscreen",onchange:"webkitfullscreenchange",onerror:"webkitfullscreenerror"},oldWebkit:{enabled:"webkitIsFullScreen",element:"webkitCurrentFullScreenElement",request:"webkitRequestFullScreen",exit:"webkitCancelFullScreen",onchange:"webkitfullscreenchange",onerror:"webkitfullscreenerror"},moz:{enabled:"mozFullScreen",element:"mozFullScreenElement",request:"mozRequestFullScreen",exit:"mozCancelFullScreen",onchange:"mozfullscreenchange",onerror:"mozfullscreenerror"},ios:{enabled:"webkitFullscreenEnabled",element:"webkitFullscreenElement",request:"webkitEnterFullscreen",exit:void 0,onexit:"webkitendfullscreen",onchange:"webkitfullscreenchange",onerror:"webkitfullscreenerror"}};for(var e in d)if(d[e].enabled in document){c=d[e],c.isFullScreen=function(){return null!=document[this.element]};break}b.isiOSDevice()&&(c=d.ios,c.isFullScreen=function(){return null!=document[this.element]}),angular.element(a)[0].fullScreenAPI=c}]).directive("videogular",["$window","VG_STATES","VG_EVENTS","VG_UTILS",function(a,b,c,d){return{restrict:"E",scope:{playerWidth:"=vgWidth",playerHeight:"=vgHeight",theme:"=vgTheme",autoPlay:"=vgAutoplay",responsive:"=vgResponsive",stretch:"=vgStretch",vgComplete:"&",vgUpdateVolume:"&",vgUpdateTime:"&",vgUpdateSize:"&",vgUpdateState:"&",vgPlayerReady:"&"},controller:["$scope",function(e){var f=null,g=null,h=null,i=b.STOP,j=e.stretch,k=0,l=0,m=!1,n=!1,o=!1,p=!1,q=!1,r=!1,s=!1,t=this,u=e.vgComplete(),v=e.vgUpdateVolume(),w=e.vgUpdateTime(),x=e.vgUpdateSize(),y=e.vgUpdateState(),z=e.vgPlayerReady();this.$on=function(){e.$on.apply(e,arguments)},this.isPlayerReady=function(){return r},this.seekTime=function(a){this.videoElement[0].currentTime=a},this.playPause=function(){this.videoElement[0].paused?(this.videoElement[0].play(),this.setState(b.PLAY),e.$emit(c.ON_PLAY)):(this.videoElement[0].pause(),this.setState(b.PAUSE),e.$emit(c.ON_PAUSE))},this.setState=function(a){return a&&a!=i&&(y&&y(a),i=a,e.$emit(c.ON_SET_STATE,[i])),i},this.play=function(){this.videoElement[0].play(),this.setState(b.PLAY),e.$emit(c.ON_PLAY)},this.pause=function(){this.videoElement[0].pause(),this.setState(b.PAUSE),e.$emit(c.ON_PAUSE)},this.toggleFullScreen=function(){angular.element(a)[0].fullScreenAPI?angular.element(a)[0].fullScreenAPI.isFullScreen()?d.isMobileDevice()||document[angular.element(a)[0].fullScreenAPI.exit]():d.isMobileDevice()?d.isiOSDevice()?o?this.enterElementInFullScreen(this.videoElement[0]):(m=!0,this.play()):this.enterElementInFullScreen(this.videoElement[0]):this.enterElementInFullScreen(this.elementScope[0]):(n?(this.videogularElement.removeClass("fullscreen"),this.videogularElement.css("z-index",0)):(this.videogularElement.addClass("fullscreen"),this.videogularElement.css("z-index",d.getZIndex())),n=!n,e.updateSize())},this.enterElementInFullScreen=function(b){b[angular.element(a)[0].fullScreenAPI.request]()},this.setVolume=function(a){v&&v(a),this.videoElement[0].volume=a,e.$emit(c.ON_SET_VOLUME,[a])},this.updateTheme=function(a){if(f)for(var b=document.getElementsByTagName("link"),c=0,d=b.length;d>c;c++)b[c].outerHTML.indexOf(f)>=0&&b[c].parentNode.removeChild(b[c]);if(a){var e=angular.element(document).find("head");e.append("<link rel='stylesheet' href='"+a+"'>"),f=a}},this.updateStretch=function(a){j=a,e.updateSize()},this.setSize=function(a,b){g=a,h=b,e.updateSize()},this.getSize=function(){return{width:g,height:h}},e.API=this,e.init=function(){t.updateTheme(e.theme),e.addBindings(),void 0==e.playerWidth||void 0==e.playerHeight||1==e.responsive?(s=!0,angular.element(a).bind("resize",e.onResizeBrowser)):(k=e.playerWidth,l=e.playerHeight,t.setSize(k,l)),angular.element(a)[0].fullScreenAPI&&document.addEventListener(angular.element(a)[0].fullScreenAPI.onchange,e.onFullScreenChange)},e.addBindings=function(){e.$watch("playerWidth",function(a,b){a!=b&&t.setSize(a,h)}),e.$watch("playerHeight",function(a,b){a!=b&&t.setSize(g,a)}),e.$watch("theme",function(a,b){a!=b&&t.updateTheme(a)}),e.$watch("stretch",function(a,b){a!=b&&t.updateStretch(a)}),e.$watch("autoPlay",function(a,b){a!=b&&t.play()}),e.$watch("responsive",function(b,c){b!=c&&(s=b,s?(angular.element(a).bind("resize",e.onResizeBrowser),e.onResizeBrowser()):(angular.element(a).unbind("resize",e.onResizeBrowser),g=e.playerWidth,h=e.playerHeight,e.updateSize()))})},e.onElementReady=function(){p=!0,q&&e.onPlayerReady()},e.onVideoReady=function(){q=!0,p&&e.onPlayerReady()},e.onPlayerReady=function(){t.videoElement[0].addEventListener("loadedmetadata",e.onLoadedMetaData),e.doPlayerReady()},e.onLoadedMetaData=function(){o=!0,e.doPlayerReady()},e.doPlayerReady=function(){if(s){var a=100*t.elementScope[0].parentNode.clientWidth/t.videoElement[0].videoWidth,f=t.videoElement[0].videoHeight*a/100;g=t.elementScope[0].parentNode.clientWidth,h=f}r=!0,e.updateSize(),z&&z(t),e.$emit(c.ON_PLAYER_READY),(e.autoPlay&&!d.isMobileDevice()||i===b.PLAY)&&t.play()},e.updateSize=function(){if(r){var b,d,f;angular.element(a)[0].fullScreenAPI&&angular.element(a)[0].fullScreenAPI.isFullScreen()||n?(t.elementScope.css("width",parseInt(window.screen.width,10)+"px"),t.elementScope.css("height",parseInt(window.screen.height,10)+"px"),b=e.getVideoSize(window.screen.width,window.screen.height),n?(k=a.innerWidth,l=a.innerHeight):(k=a.screen.width,l=a.screen.height)):(t.elementScope.css("width",parseInt(g,10)+"px"),t.elementScope.css("height",parseInt(h,10)+"px"),b=e.getVideoSize(g,h),k=g,l=h),(0==h||isNaN(h))&&(k=b.width,l=b.height),0==b.width&&(b.width=g),0==b.height&&(b.height=h),f=(k-b.width)/2,d=(l-b.height)/2,t.videoElement.attr("width",parseInt(b.width,10)),t.videoElement.attr("height",parseInt(b.height,10)),t.videoElement.css("width",parseInt(b.width,10)+"px"),t.videoElement.css("height",parseInt(b.height,10)),t.videoElement.css("top",d+"px"),t.videoElement.css("left",f+"px"),t.elementScope.css("width",parseInt(k,10)+"px"),t.elementScope.css("height",parseInt(l,10)+"px"),x&&x(k,l),e.$emit(c.ON_UPDATE_SIZE,[k,l])}},e.onResizeBrowser=function(){var a=100*t.elementScope[0].parentNode.clientWidth/t.videoElement[0].videoWidth,b=t.videoElement[0].videoHeight*a/100;g=t.elementScope[0].parentNode.clientWidth,h=b,e.updateSize()},e.onFullScreenChange=function(){angular.element(a)[0].fullScreenAPI.isFullScreen()?e.$emit(c.ON_ENTER_FULLSCREEN):e.$emit(c.ON_EXIT_FULLSCREEN),e.updateSize(),e.$apply()},e.onComplete=function(){u&&u(),t.setState(b.STOP),e.$emit(c.ON_COMPLETE),e.$apply()},e.onStartBuffering=function(){e.$emit(c.ON_BUFFERING),e.$apply()},e.onStartPlaying=function(a){a.target.width++,a.target.width--,e.$emit(c.ON_START_PLAYING,[a.target.duration]),e.$apply()},e.onUpdateTime=function(a){w&&w(a.target.currentTime,a.target.duration),e.$emit(c.ON_UPDATE_TIME,[a.target.currentTime,a.target.duration]),e.$apply()},e.getVideoSize=function(a,b){var c,d,e={},f=t.videoElement[0].videoWidth/t.videoElement[0].videoHeight>a/b;return e.width=a,e.height=b,"fit"==j&&f||"fill"==j&&!f?(c=100*a/t.videoElement[0].videoWidth,e.height=t.videoElement[0].videoHeight*c/100):"fill"==j&&f||"fit"==j&&!f?(d=100*b/t.videoElement[0].videoHeight,e.width=t.videoElement[0].videoWidth*d/100):(e.width=t.videoElement[0].videoWidth,e.height=t.videoElement[0].videoHeight),(0==e.height||isNaN(e.height))&&(e.width=t.elementScope[0].parentElement.clientWidth,e.height=9*e.width/16),e},e.init()}],link:{pre:function(a,b,c,d){d.videogularElement=b,d.elementScope=angular.element(b),d.videoElement=d.elementScope.find("video"),d.videoElement[0].addEventListener("waiting",a.onStartBuffering,!1),d.videoElement[0].addEventListener("ended",a.onComplete,!1),d.videoElement[0].addEventListener("playing",a.onStartPlaying,!1),d.videoElement[0].addEventListener("timeupdate",a.onUpdateTime,!1),d.elementScope.ready(a.onElementReady),d.videoElement.ready(a.onVideoReady)}}}}]).directive("vgSrc",["VG_EVENTS","VG_UTILS",function(a){return{restrict:"A",link:{pre:function(b,c,d){function e(){for(var c=0,d=f.length;d>c;c++)if(g=h[0].canPlayType(f[c].type),"maybe"==g||"probably"==g){h.attr("src",f[c].src),h.attr("type",f[c].type);break}""==g&&b.$emit(a.ON_ERROR,{type:"Can't play file"})}var f,g,h=c;b.$watch(d.vgSrc,function(a,b){f&&a==b||(f=a,e())})}}}}]);