(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){exports.nes=b()}else{a.nes=b()}}}})(this,function(){var f=function(){};var a=(typeof WebSocket==="undefined"?require("ws"):WebSocket);var d=function(h,g){this._url=h;this._settings=g;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this.onError=console.error;this.onConnect=f;this.onBroadcast=f};d.prototype.connect=function(g,h){if(typeof g==="function"){h=arguments[0];g={}}if(g.reconnect!==false){this._reconnection={wait:0,delay:g.delay||1000,maxDelay:g.maxDelay||5000,auth:g.auth}}else{this._reconnection=null}this._connect(g.auth,h)};d.prototype._connect=function(i,k){var h=this;var g=new a(this._url,this._settings);this._ws=g;var j=false;g.onopen=function(){if(!j){j=true;return h._hello(i,function(l){if(l){h.disconnect();return k(l)}h.onConnect();return k()})}};g.onerror=function(l){if(!j){j=true;return k(l)}return h.onError(l)};g.onclose=function(){return h._onClose()};g.onmessage=function(l){return h._onMessage(l)}};d.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===a.OPEN||this._ws.readyState===a.CONNECTING){this._ws.close()}};d.prototype._onClose=function(){this._ws=null;var h=new Error("Request failed - server disconnected");var k=Object.keys(this._requests);for(var j=0,g=k.length;j<g;++j){var m=k[j];var l=this._requests[m];delete this._requests[m];l(h)}this._reconnect()};d.prototype._reconnect=function(){var g=this;if(this._reconnection){this._reconnection.wait+=this._reconnection.delay;var h=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!g._reconnection){return}g._connect(g._reconnection.auth,function(i){if(i){g.onError(i);return g._reconnect()}})},h)}};d.prototype.request=function(g,i){if(typeof g==="string"){g={method:"GET",path:g}}var h={type:"request",method:g.method||"GET",path:g.path,headers:g.headers,payload:g.payload};return this._send(h,i)};d.prototype.message=function(h,i){var g={type:"message",data:h};return this._send(g,i)};d.prototype._send=function(h,i){var g=this;i=i||f;if(!this._ws||this._ws.readyState!==a.OPEN){return i(new Error("Failed to send message - server disconnected"))}h.id=++g._ids;e(h,function(j,k){if(j){return i(j)}g._requests[h.id]=i;try{g._ws.send(k)}catch(j){delete g._requests[h.id];return i(j)}})};d.prototype.authenticate=function(h,g){if(!h){return g(new Error("Authentication missing credentials"))}return this._hello(h,g)};d.prototype._hello=function(i,j){var h={type:"hello"};if(i){h.auth=i}var g=this.subscriptions();if(g.length){h.subs=g}return this._send(h,j)};d.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};d.prototype.subscribe=function(k,i){var g=this;if(!k||k[0]!=="/"){return i(new Error("Invalid path"))}var h=this._subscriptions[k];if(h){if(h.indexOf(i)===-1){h.push(i)}return}this._subscriptions[k]=[i];if(!this._ws||this._ws.readyState!==a.OPEN){return}var j={type:"sub",path:k};return this._send(j,function(l){return i(l)})};d.prototype.unsubscribe=function(l,i){var g=this;if(!l||l[0]!=="/"){return i(new Error("Invalid path"))}var h=this._subscriptions[l];if(!h){return}var k=false;if(!i){delete this._subscriptions[l];k=true}else{var m=h.indexOf(i);if(m===-1){return}h.splice(m,1);if(!h.length){delete this._subscriptions[l];k=true}}if(!k||!this._ws||this._ws.readyState!==a.OPEN){return}var j={type:"unsub",path:l};return this._send(j)};d.prototype._onMessage=function(h){var g=this;c(h.data,function(n,p){if(n){return g.onError(n)}if(p.type==="broadcast"){return g.onBroadcast(p.message)}if(p.type==="pub"){var k=g._subscriptions[p.path];if(k){for(var m=0,j=k.length;m<j;++m){k[m](null,p.message)}}return}var o=g._requests[p.id];delete g._requests[p.id];if(!o){return g.onError(new Error("Received response for missing request"))}if(p.type==="sub"){if(p.error){g._processSubscribeErrors(p)}return}if(p.type==="response"){var l=(p.statusCode>=400&&p.statusCode<=599?new Error(p.payload.message):null);return o(l,p.payload,p.statusCode,p.headers)}if(p.type==="message"){return o(p.error?new Error(p.error):null,p.data)}if(p.type==="hello"){if(p.subs){g._processSubscribeErrors(p.subs)}return o(p.error?new Error(p.error):null)}return g.onError(new Error("Received unknown response type: "+p.type))})};d.prototype._processSubscribeErrors=function(m){m=[].concat(m);for(var j=0,l=m.length;j<l;++j){var n=m[j];var h=this._subscriptions[n.path];if(h){delete this._subscriptions[n.path];for(var k=0,g=h.length;k<g;++k){h[k](new Error(n.error))}}}};var c=function(j,h){var k=null;var g=null;try{k=JSON.parse(j)}catch(i){g=i}return h(g,k)};var e=function(k,i){var h=null;var g=null;try{h=JSON.stringify(k)}catch(j){g=j}return i(g,h)};var b={Client:d};return b});