"use strict";function _typeof(a){return a&&typeof Symbol!=="undefined"&&a.constructor===Symbol?"symbol":typeof a}(function(a,b){if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"&&(typeof module==="undefined"?"undefined":_typeof(module))==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"){exports.nes=b()}else{a.nes=b()}}}})(undefined,function(){var a="2";var f=function f(){};var b=typeof WebSocket==="undefined"?require("ws"):WebSocket;var d=function d(j,h){var k=null;var g=null;try{k=JSON.parse(j)}catch(i){g=i}return h(g,k)};var e=function e(k,i){var h=null;var g=null;try{h=JSON.stringify(k)}catch(j){g=j}return i(g,h)};var c=function c(h,g){g=g||{};this._url=h;this._settings=g;this._heartbeatTimeout=false;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this._heartbeat=null;this.onError=function(i){return console.error(i)};this.onConnect=f;this.onDisconnect=f;this.onUpdate=f;this.id=null};c.prototype.connect=function(g,h){if(typeof g==="function"){h=arguments[0];g={}}if(g.reconnect!==false){this._reconnection={wait:0,delay:g.delay||1000,maxDelay:g.maxDelay||5000,retries:g.retries||Infinity,settings:{auth:g.auth,timeout:g.timeout}}}else{this._reconnection=null}this._connect(g,true,h)};c.prototype._connect=function(i,h,n){var m=this;var k=false;var l=function l(){k=true;m._ws.close();n(new Error("Connection timed out"));m._cleanup();if(h){return m._reconnect()}};var j=i.timeout?setTimeout(l,i.timeout):null;var g=new b(this._url,this._settings.ws);this._ws=g;g.onopen=function(){clearTimeout(j);if(!k){k=true;return m._hello(i.auth,function(o){if(o){if(o.path){delete m._subscriptions[o.path]}m.disconnect();return n(o)}m.onConnect();return n()})}};g.onerror=function(o){clearTimeout(j);if(!k){k=true;return n(o)}return m.onError(o)};g.onclose=function(){m._cleanup();m.onDisconnect(!!m._reconnection);m._reconnect()};g.onmessage=function(o){return m._onMessage(o)}};c.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===b.OPEN||this._ws.readyState===b.CONNECTING){this._ws.close()}};c.prototype._cleanup=function(){var g=this._ws;if(!g){return}this._ws=null;this.id=null;g.onopen=null;g.onclose=null;g.onerror=f;g.onmessage=null;clearTimeout(this._heartbeat);var h=new Error("Request failed - server disconnected");var k=Object.keys(this._requests);for(var j=0;j<k.length;++j){var n=k[j];var l=this._requests[n];var m=l.callback;clearTimeout(l.timeout);delete this._requests[n];m(h)}};c.prototype._reconnect=function(){var g=this;if(this._reconnection){if(this._reconnection.retries<1){return}--this._reconnection.retries;this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var h=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!g._reconnection){return}g._connect(g._reconnection.settings,false,function(i){if(i){g.onError(i);g._cleanup();return g._reconnect()}})},h)}};c.prototype.request=function(g,i){if(typeof g==="string"){g={method:"GET",path:g}}var h={type:"request",method:g.method||"GET",path:g.path,headers:g.headers,payload:g.payload};return this._send(h,true,i)};c.prototype.message=function(h,i){var g={type:"message",message:h};return this._send(g,true,i)};c.prototype._send=function(i,g,j){var h=this;j=j||f;if(!this._ws||this._ws.readyState!==b.OPEN){return j(new Error("Failed to send message - server disconnected"))}i.id=++this._ids;e(i,function(l,m){if(l){return j(l)}if(!g){try{return h._ws.send(m)}catch(l){return j(l)}}var k={callback:j,timeout:null};if(h._settings.timeout){k.timeout=setTimeout(function(){k.callback=null;k.timeout=null;return j(new Error("Request timed out"))},h._settings.timeout)}h._requests[i.id]=k;try{h._ws.send(m)}catch(l){clearTimeout(h._requests[i.id].timeout);delete h._requests[i.id];return j(l)}})};c.prototype._hello=function(i,j){var h={type:"hello",version:a};if(i){h.auth=i}var g=this.subscriptions();if(g.length){h.subs=g}return this._send(h,true,j)};c.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};c.prototype.subscribe=function(k,i,l){var h=this;if(!k||k[0]!=="/"){return l(new Error("Invalid path"))}var g=this._subscriptions[k];if(g){if(g.indexOf(i)===-1){g.push(i)}return l()}this._subscriptions[k]=[i];if(!this._ws||this._ws.readyState!==b.OPEN){return l()}var j={type:"sub",path:k};return this._send(j,true,function(m){if(m){delete h._subscriptions[k]}return l(m)})};c.prototype.unsubscribe=function(k,h){if(!k||k[0]!=="/"){return h(new Error("Invalid path"))}var g=this._subscriptions[k];if(!g){return}var j=false;if(!h){delete this._subscriptions[k];j=true}else{var l=g.indexOf(h);if(l===-1){return}g.splice(l,1);if(!g.length){delete this._subscriptions[k];j=true}}if(!j||!this._ws||this._ws.readyState!==b.OPEN){return}var i={type:"unsub",path:k};return this._send(i,false)};c.prototype._onMessage=function(h){var g=this;this._beat();d(h.data,function(n,p){if(n){return g.onError(n)}var k=null;if(p.statusCode&&p.statusCode>=400&&p.statusCode<=599){k=new Error(p.payload.message||p.payload.error);k.statusCode=p.statusCode;k.data=p.payload;k.headers=p.headers;k.path=p.path}if(p.type==="ping"){return g._send({type:"ping"},false)}if(p.type==="update"){return g.onUpdate(p.message)}if(p.type==="pub"){var j=g._subscriptions[p.path];if(j){for(var l=0;l<j.length;++l){j[l](p.message)}}return}var m=g._requests[p.id];if(!m){return g.onError(new Error("Received response for unknown request"))}var o=m.callback;clearTimeout(m.timeout);delete g._requests[p.id];if(!o){return}if(p.type==="request"){return o(k,p.payload,p.statusCode,p.headers)}if(p.type==="message"){return o(k,p.message)}if(p.type==="hello"){g.id=p.socket;if(p.heartbeat){g._heartbeatTimeout=p.heartbeat.interval+p.heartbeat.timeout;g._beat()}return o(k)}if(p.type==="sub"){return o(k)}return g.onError(new Error("Received unknown response type: "+p.type))})};c.prototype._beat=function(){var g=this;if(!this._heartbeatTimeout){return}clearTimeout(this._heartbeat);this._heartbeat=setTimeout(function(){g._ws.close()},this._heartbeatTimeout)};return{Client:c}});