(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){exports.nes=b()}else{a.nes=b()}}}})(this,function(){var c=function(g,f){f=f||{};this._url=g;this._settings=f;this._heartbeatTimeout=false;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this._heartbeat=null;this.onError=console.error;this.onConnect=e;this.onDisconnect=e;this.onUpdate=e};c.prototype.connect=function(f,g){if(typeof f==="function"){g=arguments[0];f={}}if(f.reconnect!==false){this._reconnection={wait:0,delay:f.delay||1000,maxDelay:f.maxDelay||5000,retries:f.retries||Infinity,settings:{auth:f.auth,timeout:f.timeout}}}else{this._reconnection=null}this._connect(f,true,g)};c.prototype._connect=function(i,h,m){var g=this;var k=false;var l=function(){k=true;g._ws.close();m(new Error("Connection timed out"));g._cleanup();if(h){return g._reconnect()}};var j=(i.timeout?setTimeout(l,i.timeout):null);var f=new a(this._url,this._settings.ws);this._ws=f;f.onopen=function(){clearTimeout(j);if(!k){k=true;return g._hello(i.auth,function(n){if(n){g.disconnect();return m(n)}g.onConnect();return m()})}};f.onerror=function(n){clearTimeout(j);if(!k){k=true;return m(n)}return g.onError(n)};f.onclose=function(){g._cleanup();g.onDisconnect(!!g._reconnection);g._reconnect()};f.onmessage=function(n){return g._onMessage(n)}};c.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===a.OPEN||this._ws.readyState===a.CONNECTING){this._ws.close()}};c.prototype._cleanup=function(){var f=this._ws;if(!f){return}this._ws=null;f.onopen=null;f.onclose=null;f.onerror=e;f.onmessage=null;clearTimeout(this._heartbeat);var h=new Error("Request failed - server disconnected");var k=Object.keys(this._requests);for(var j=0,g=k.length;j<g;++j){var n=k[j];var l=this._requests[n];var m=l.callback;clearTimeout(l.timeout);delete this._requests[n];m(h)}};c.prototype._reconnect=function(){var f=this;if(this._reconnection){if(this._reconnection.retries<1){return}--this._reconnection.retries;this._reconnection.wait+=this._reconnection.delay;var g=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!f._reconnection){return}f._connect(f._reconnection.settings,false,function(h){if(h){f.onError(h);f._cleanup();return f._reconnect()}})},g)}};c.prototype.request=function(f,h){if(typeof f==="string"){f={method:"GET",path:f}}var g={type:"request",method:f.method||"GET",path:f.path,headers:f.headers,payload:f.payload};return this._send(g,true,h)};c.prototype.message=function(g,h){var f={type:"message",message:g};return this._send(f,true,h)};c.prototype._send=function(h,f,i){var g=this;i=i||e;if(!this._ws||this._ws.readyState!==a.OPEN){return i(new Error("Failed to send message - server disconnected"))}h.id=++g._ids;d(h,function(k,l){if(k){return i(k)}if(f){var j={callback:i,timeout:null};if(g._settings.timeout){j.timeout=setTimeout(function(){j.callback=null;j.timeout=null;return i(new Error("Request timed out"))},g._settings.timeout)}g._requests[h.id]=j}try{g._ws.send(l)}catch(k){if(f){clearTimeout(g._requests[h.id].timeout);delete g._requests[h.id]}return i(k)}})};c.prototype._hello=function(h,i){var g={type:"hello"};if(h){g.auth=h}var f=this.subscriptions();if(f.length){g.subs=f}return this._send(g,true,i)};c.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};c.prototype.subscribe=function(i,g){if(!i||i[0]!=="/"){return g(new Error("Invalid path"))}var f=this._subscriptions[i];if(f){if(f.indexOf(g)===-1){f.push(g)}return}this._subscriptions[i]=[g];if(!this._ws||this._ws.readyState!==a.OPEN){return}var h={type:"sub",path:i};return this._send(h,false,function(j){return g(j)})};c.prototype.unsubscribe=function(j,g){if(!j||j[0]!=="/"){return g(new Error("Invalid path"))}var f=this._subscriptions[j];if(!f){return}var i=false;if(!g){delete this._subscriptions[j];i=true}else{var k=f.indexOf(g);if(k===-1){return}f.splice(k,1);if(!f.length){delete this._subscriptions[j];i=true}}if(!i||!this._ws||this._ws.readyState!==a.OPEN){return}var h={type:"unsub",path:j};return this._send(h,false)};c.prototype._onMessage=function(g){var f=this;this._beat();b(g.data,function(j,l){if(j){return f.onError(j)}var h=null;if(l.statusCode&&l.statusCode>=400&&l.statusCode<=599){h=new Error(l.payload.message||l.payload.error);h.statusCode=l.statusCode;h.data=l.payload;h.headers=l.headers}if(l.type==="ping"){return f._send({type:"ping"},false)}if(l.type==="update"){return f.onUpdate(l.message)}if(l.type==="pub"){return f._notifyHandlers(l.path,null,l.message)}if(l.type==="sub"){return f._notifyHandlers(l.path,h)}var i=f._requests[l.id];if(!i){return f.onError(new Error("Received response for unknown request"))}var k=i.callback;clearTimeout(i.timeout);delete f._requests[l.id];if(!k){return}if(l.type==="request"){return k(h,l.payload,l.statusCode,l.headers)}if(l.type==="message"){return k(h,l.message)}if(l.type==="hello"){if(l.heartbeat){f._heartbeatTimeout=l.heartbeat.interval+l.heartbeat.timeout;f._beat()}return k(h)}return f.onError(new Error("Received unknown response type: "+l.type))})};c.prototype._beat=function(){var f=this;if(!f._heartbeatTimeout){return}clearTimeout(this._heartbeat);this._heartbeat=setTimeout(function(){f._ws.close()},f._heartbeatTimeout)};c.prototype._notifyHandlers=function(l,k,j){var g=this._subscriptions[l];if(g){if(k){delete this._subscriptions[l]}for(var h=0,f=g.length;h<f;++h){g[h](k,j)}}};var e=function(){};var a=(typeof WebSocket==="undefined"?require("ws"):WebSocket);var b=function(i,g){var j=null;var f=null;try{j=JSON.parse(i)}catch(h){f=h}return g(f,j)};var d=function(j,h){var g=null;var f=null;try{g=JSON.stringify(j)}catch(i){f=i}return h(f,g)};return{Client:c}});