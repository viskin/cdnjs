"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?exports.nes=t():e.nes=t()}("undefined"!=typeof window?window:global,function(){var e="2",t=function(){},n=function(e,t){var n=null,o=null;try{n=JSON.parse(e)}catch(s){o=new r(s,"protocol")}return t(o,n)},o=function(e,t){var n=null,o=null;try{n=JSON.stringify(e)}catch(s){o=new r(s,"user")}return t(o,n)},r=function(e,t){return"string"==typeof e&&(e=new Error(e)),e.type=t,e},s={1e3:"Normal closure",1001:"Going away",1002:"Protocol error",1003:"Unsupported data",1004:"Reserved",1005:"No status received",1006:"Abnormal closure",1007:"Invalid frame payload data",1008:"Policy violation",1009:"Message too big",1010:"Mandatory extension",1011:"Internal server error",1015:"TLS handshake"},i=function(e,n){n=n||{},this._url=e,this._settings=n,this._heartbeatTimeout=!1,this._ws=null,this._reconnection=null,this._ids=0,this._requests={},this._subscriptions={},this._heartbeat=null,this._packets=[],this.onError=function(e){return console.error(e)},this.onConnect=t,this.onDisconnect=t,this.onUpdate=t,this.id=null};return i.WebSocket="undefined"==typeof WebSocket?null:WebSocket,i.prototype.connect=function(e,t){"function"==typeof e&&(t=arguments[0],e={}),e.reconnect!==!1?this._reconnection={wait:0,delay:e.delay||1e3,maxDelay:e.maxDelay||5e3,retries:e.retries||1/0,settings:{auth:e.auth,timeout:e.timeout}}:this._reconnection=null,this._connect(e,!0,t)},i.prototype._connect=function(e,t,n){var o=this,u=!1,a=function(){return u=!0,o._ws.close(),o._cleanup(),n(new r("Connection timed out","timeout")),t?o._reconnect():void 0},c=e.timeout?setTimeout(a,e.timeout):null,l=new i.WebSocket(this._url,this._settings.ws);this._ws=l,l.onopen=function(){return clearTimeout(c),u?void 0:(u=!0,o._hello(e.auth,function(e){return e?(e.path&&delete o._subscriptions[e.path],o.disconnect(),n(e)):(o.onConnect(),n())}))},l.onerror=function(e){clearTimeout(c);var t=new r("Socket error","ws");return u?o.onError(t):(u=!0,n(t))},l.onclose=function(e){o._cleanup();var t={code:e.code,explanation:s[e.code]||"Unknown",reason:e.reason,wasClean:e.wasClean};o.onDisconnect(!!(o._reconnection&&o._reconnection.retries>=1),t),o._reconnect()},l.onmessage=function(e){return o._onMessage(e)}},i.prototype.overrideReconnectionAuth=function(e){return this._reconnection?(this._reconnection.settings.auth=e,!0):!1},i.prototype.disconnect=function(){this._reconnection=null,this._ws&&(this._ws.readyState!==i.WebSocket.OPEN&&this._ws.readyState!==i.WebSocket.CONNECTING||this._ws.close())},i.prototype._cleanup=function(){var e=this._ws;if(e){this._ws=null,this._packets=[],this.id=null,e.onopen=null,e.onclose=null,e.onerror=t,e.onmessage=null,clearTimeout(this._heartbeat);for(var n=new r("Request failed - server disconnected","disconnect"),o=Object.keys(this._requests),s=0;s<o.length;++s){var i=o[s],u=this._requests[i],a=u.callback;clearTimeout(u.timeout),delete this._requests[i],a(n)}}},i.prototype._reconnect=function(){var e=this;if(this._reconnection){if(this._reconnection.retries<1)return void this.disconnect();--this._reconnection.retries,this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var t=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){e._reconnection&&e._connect(e._reconnection.settings,!1,function(t){return t?(e.onError(t),e._cleanup(),e._reconnect()):void 0})},t)}},i.prototype.request=function(e,t){"string"==typeof e&&(e={method:"GET",path:e});var n={type:"request",method:e.method||"GET",path:e.path,headers:e.headers,payload:e.payload};return this._send(n,!0,t)},i.prototype.message=function(e,t){var n={type:"message",message:e};return this._send(n,!0,t)},i.prototype._send=function(e,n,s){var u=this;return s=s||t,this._ws&&this._ws.readyState===i.WebSocket.OPEN?(e.id=++this._ids,void o(e,function(t,o){if(t)return s(t);if(!n)try{return u._ws.send(o)}catch(t){return s(new r(t,"ws"))}var i={callback:s,timeout:null};u._settings.timeout&&(i.timeout=setTimeout(function(){return i.callback=null,i.timeout=null,s(new r("Request timed out","timeout"))},u._settings.timeout)),u._requests[e.id]=i;try{u._ws.send(o)}catch(t){return clearTimeout(u._requests[e.id].timeout),delete u._requests[e.id],s(new r(t,"ws"))}})):s(new r("Failed to send message - server disconnected","disconnect"))},i.prototype._hello=function(t,n){var o={type:"hello",version:e};t&&(o.auth=t);var r=this.subscriptions();return r.length&&(o.subs=r),this._send(o,!0,n)},i.prototype.subscriptions=function(){return Object.keys(this._subscriptions)},i.prototype.subscribe=function(e,t,n){var o=this;if(!e||"/"!==e[0])return n(new r("Invalid path","user"));var s=this._subscriptions[e];if(s)return-1===s.indexOf(t)&&s.push(t),n();if(this._subscriptions[e]=[t],!this._ws||this._ws.readyState!==i.WebSocket.OPEN)return n();var u={type:"sub",path:e};return this._send(u,!0,function(t){return t&&delete o._subscriptions[e],n(t)})},i.prototype.unsubscribe=function(e,t,n){if(!e||"/"!==e[0])return n(new r("Invalid path","user"));var o=this._subscriptions[e];if(!o)return n();var s=!1;if(t){var u=o.indexOf(t);if(-1===u)return n();o.splice(u,1),o.length||(delete this._subscriptions[e],s=!0)}else delete this._subscriptions[e],s=!0;if(!s||!this._ws||this._ws.readyState!==i.WebSocket.OPEN)return n();var a={type:"unsub",path:e};return this._send(a,!0,function(e){return n()})},i.prototype._onMessage=function(e){var t=this;this._beat();var o=e.data,s=o[0];if("{"!==s){if(this._packets.push(o.slice(1)),"!"!==s)return;o=this._packets.join(""),this._packets=[]}this._packets.length&&(this._packets=[],this.onError(new r("Received an incomplete message","protocol"))),n(o,function(e,n){if(e)return t.onError(e);var o=null;if(n.statusCode&&n.statusCode>=400&&n.statusCode<=599&&(o=new r(n.payload.message||n.payload.error,"server"),o.statusCode=n.statusCode,o.data=n.payload,o.headers=n.headers,o.path=n.path),"ping"===n.type)return t._send({type:"ping"},!1);if("update"===n.type)return t.onUpdate(n.message);if("pub"!==n.type&&"revoke"!==n.type){var s=t._requests[n.id];if(!s)return t.onError(new r("Received response for unknown request","protocol"));var i=s.callback;if(clearTimeout(s.timeout),delete t._requests[n.id],i)return"request"===n.type?i(o,n.payload,n.statusCode,n.headers):"message"===n.type?i(o,n.message):"hello"===n.type?(t.id=n.socket,n.heartbeat&&(t._heartbeatTimeout=n.heartbeat.interval+n.heartbeat.timeout,t._beat()),i(o)):"sub"===n.type||"unsub"===n.type?i(o):t.onError(new r("Received unknown response type: "+n.type,"protocol"))}else{var u=t._subscriptions[n.path];if("revoke"===n.type&&delete t._subscriptions[n.path],u&&void 0!==n.message){var a={};"revoke"===n.type&&(a.revoked=!0);for(var c=0;c<u.length;++c)u[c](n.message,a)}}})},i.prototype._beat=function(){var e=this;this._heartbeatTimeout&&(clearTimeout(this._heartbeat),this._heartbeat=setTimeout(function(){e.onError(new r("Disconnecting due to heartbeat timeout","timeout")),e._ws.close()},this._heartbeatTimeout))},{Client:i}});
//# sourceMappingURL=client.min.js.map