"use strict";function _typeof(obj){return obj&&typeof Symbol!=="undefined"&&obj.constructor===Symbol?"symbol":typeof obj}(function(root,factory){if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"&&(typeof module==="undefined"?"undefined":_typeof(module))==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"){exports.nes=factory()}else{root.nes=factory()}})(undefined,function(){var ignore=function ignore(){};var WS=typeof WebSocket==="undefined"?require("ws"):WebSocket;var parse=function parse(message,next){var obj=null;var error=null;try{obj=JSON.parse(message)}catch(err){error=err}return next(error,obj)};var stringify=function stringify(message,next){var string=null;var error=null;try{string=JSON.stringify(message)}catch(err){error=err}return next(error,string)};var Client=function Client(url,options){options=options||{};this._url=url;this._settings=options;this._heartbeatTimeout=false;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this._heartbeat=null;this.onError=console.error;this.onConnect=ignore;this.onDisconnect=ignore;this.onUpdate=ignore;this.id=null};Client.prototype.connect=function(options,callback){if(typeof options==="function"){callback=arguments[0];options={}}if(options.reconnect!==false){this._reconnection={wait:0,delay:options.delay||1e3,maxDelay:options.maxDelay||5e3,retries:options.retries||Infinity,settings:{auth:options.auth,timeout:options.timeout}}}else{this._reconnection=null}this._connect(options,true,callback)};Client.prototype._connect=function(options,initial,callback){var _this=this;var sentCallback=false;var timeoutHandler=function timeoutHandler(){sentCallback=true;_this._ws.close();callback(new Error("Connection timed out"));_this._cleanup();if(initial){return _this._reconnect()}};var timeout=options.timeout?setTimeout(timeoutHandler,options.timeout):null;var ws=new WS(this._url,this._settings.ws);this._ws=ws;ws.onopen=function(){clearTimeout(timeout);if(!sentCallback){sentCallback=true;return _this._hello(options.auth,function(err){if(err){_this.disconnect();return callback(err)}_this.onConnect();return callback()})}};ws.onerror=function(err){clearTimeout(timeout);if(!sentCallback){sentCallback=true;return callback(err)}return _this.onError(err)};ws.onclose=function(){_this._cleanup();_this.onDisconnect(!!_this._reconnection);_this._reconnect()};ws.onmessage=function(message){return _this._onMessage(message)}};Client.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===WS.OPEN||this._ws.readyState===WS.CONNECTING){this._ws.close()}};Client.prototype._cleanup=function(){var ws=this._ws;if(!ws){return}this._ws=null;this.id=null;ws.onopen=null;ws.onclose=null;ws.onerror=ignore;ws.onmessage=null;clearTimeout(this._heartbeat);var error=new Error("Request failed - server disconnected");var ids=Object.keys(this._requests);for(var i=0;i<ids.length;++i){var id=ids[i];var request=this._requests[id];var callback=request.callback;clearTimeout(request.timeout);delete this._requests[id];callback(error)}};Client.prototype._reconnect=function(){var _this2=this;if(this._reconnection){if(this._reconnection.retries<1){return}--this._reconnection.retries;this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var timeout=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!_this2._reconnection){return}_this2._connect(_this2._reconnection.settings,false,function(err){if(err){_this2.onError(err);_this2._cleanup();return _this2._reconnect()}})},timeout)}};Client.prototype.request=function(options,callback){if(typeof options==="string"){options={method:"GET",path:options}}var request={type:"request",method:options.method||"GET",path:options.path,headers:options.headers,payload:options.payload};return this._send(request,true,callback)};Client.prototype.message=function(message,callback){var request={type:"message",message:message};return this._send(request,true,callback)};Client.prototype._send=function(request,track,callback){var _this3=this;callback=callback||ignore;if(!this._ws||this._ws.readyState!==WS.OPEN){return callback(new Error("Failed to send message - server disconnected"))}request.id=++this._ids;stringify(request,function(err,encoded){if(err){return callback(err)}if(track){(function(){var record={callback:callback,timeout:null};if(_this3._settings.timeout){record.timeout=setTimeout(function(){record.callback=null;record.timeout=null;return callback(new Error("Request timed out"))},_this3._settings.timeout)}_this3._requests[request.id]=record})()}try{_this3._ws.send(encoded)}catch(err){if(track){clearTimeout(_this3._requests[request.id].timeout);delete _this3._requests[request.id]}return callback(err)}})};Client.prototype._hello=function(auth,callback){var request={type:"hello"};if(auth){request.auth=auth}var subs=this.subscriptions();if(subs.length){request.subs=subs}return this._send(request,true,callback)};Client.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};Client.prototype.subscribe=function(path,handler){if(!path||path[0]!=="/"){return handler(new Error("Invalid path"))}var subs=this._subscriptions[path];if(subs){if(subs.indexOf(handler)===-1){subs.push(handler)}return}this._subscriptions[path]=[handler];if(!this._ws||this._ws.readyState!==WS.OPEN){return}var request={type:"sub",path:path};return this._send(request,false,function(err){return handler(err)})};Client.prototype.unsubscribe=function(path,handler){if(!path||path[0]!=="/"){return handler(new Error("Invalid path"))}var subs=this._subscriptions[path];if(!subs){return}var sync=false;if(!handler){delete this._subscriptions[path];sync=true}else{var pos=subs.indexOf(handler);if(pos===-1){return}subs.splice(pos,1);if(!subs.length){delete this._subscriptions[path];sync=true}}if(!sync||!this._ws||this._ws.readyState!==WS.OPEN){return}var request={type:"unsub",path:path};return this._send(request,false)};Client.prototype._onMessage=function(message){var _this4=this;this._beat();parse(message.data,function(err,update){if(err){return _this4.onError(err)}var error=null;if(update.statusCode&&update.statusCode>=400&&update.statusCode<=599){error=new Error(update.payload.message||update.payload.error);error.statusCode=update.statusCode;error.data=update.payload;error.headers=update.headers}if(update.type==="ping"){return _this4._send({type:"ping"},false)}if(update.type==="update"){return _this4.onUpdate(update.message)}if(update.type==="pub"){return _this4._notifyHandlers(update.path,null,update.message)}if(update.type==="sub"){return _this4._notifyHandlers(update.path,error)}var request=_this4._requests[update.id];if(!request){return _this4.onError(new Error("Received response for unknown request"))}var callback=request.callback;clearTimeout(request.timeout);delete _this4._requests[update.id];if(!callback){return}if(update.type==="request"){return callback(error,update.payload,update.statusCode,update.headers)}if(update.type==="message"){return callback(error,update.message)}if(update.type==="hello"){_this4.id=update.socket;if(update.heartbeat){_this4._heartbeatTimeout=update.heartbeat.interval+update.heartbeat.timeout;_this4._beat()}return callback(error)}return _this4.onError(new Error("Received unknown response type: "+update.type))})};Client.prototype._beat=function(){var _this5=this;if(!this._heartbeatTimeout){return}clearTimeout(this._heartbeat);this._heartbeat=setTimeout(function(){_this5._ws.close()},this._heartbeatTimeout)};Client.prototype._notifyHandlers=function(path,err,message){var handlers=this._subscriptions[path];if(handlers){if(err){delete this._subscriptions[path]}for(var i=0;i<handlers.length;++i){handlers[i](err,message)}}};return{Client:Client}});
