!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.nes=t():e.nes=t()}(this,function(){var e=function(e,n){n=n||{},this._url=e,this._settings=n,this._heartbeatTimeout=!1,this._ws=null,this._reconnection=null,this._ids=0,this._requests={},this._subscriptions={},this._heartbeat=null,this.onError=console.error,this.onConnect=t,this.onDisconnect=t,this.onUpdate=t};e.prototype.connect=function(e,t){"function"==typeof e&&(t=arguments[0],e={}),this._reconnection=e.reconnect!==!1?{wait:0,delay:e.delay||1e3,maxDelay:e.maxDelay||5e3,retries:e.retries||1/0,settings:{auth:e.auth,timeout:e.timeout}}:null,this._connect(e,!0,t)},e.prototype._connect=function(e,t,r){var s=this,o=!1,i=function(){return o=!0,s._ws.close(),r(new Error("Connection timed out")),s._cleanup(),t?s._reconnect():void 0},u=e.timeout?setTimeout(i,e.timeout):null,a=new n(this._url,this._settings.ws);this._ws=a,a.onopen=function(){return clearTimeout(u),o?void 0:(o=!0,s._hello(e.auth,function(e){return e?(s.disconnect(),r(e)):(s.onConnect(),r())}))},a.onerror=function(e){return clearTimeout(u),o?s.onError(e):(o=!0,r(e))},a.onclose=function(){s._cleanup(),s.onDisconnect(!!s._reconnection),s._reconnect()},a.onmessage=function(e){return s._onMessage(e)}},e.prototype.disconnect=function(){this._reconnection=null,this._ws&&(this._ws.readyState===n.OPEN||this._ws.readyState===n.CONNECTING)&&this._ws.close()},e.prototype._cleanup=function(){var e=this._ws;if(e){this._ws=null,e.onopen=null,e.onclose=null,e.onerror=t,e.onmessage=null,clearTimeout(this._heartbeat);for(var n=new Error("Request failed - server disconnected"),r=Object.keys(this._requests),s=0,o=r.length;o>s;++s){var i=r[s],u=this._requests[i],a=u.callback;clearTimeout(u.timeout),delete this._requests[i],a(n)}}},e.prototype._reconnect=function(){var e=this;if(this._reconnection){if(this._reconnection.retries<1)return;--this._reconnection.retries,this._reconnection.wait+=this._reconnection.delay;var t=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){e._reconnection&&e._connect(e._reconnection.settings,!1,function(t){return t?(e.onError(t),e._cleanup(),e._reconnect()):void 0})},t)}},e.prototype.request=function(e,t){"string"==typeof e&&(e={method:"GET",path:e});var n={type:"request",method:e.method||"GET",path:e.path,headers:e.headers,payload:e.payload};return this._send(n,!0,t)},e.prototype.message=function(e,t){var n={type:"message",message:e};return this._send(n,!0,t)},e.prototype._send=function(e,r,o){var i=this;return o=o||t,this._ws&&this._ws.readyState===n.OPEN?(e.id=++i._ids,void s(e,function(t,n){if(t)return o(t);if(r){var s={callback:o,timeout:null};i._settings.timeout&&(s.timeout=setTimeout(function(){return s.callback=null,s.timeout=null,o(new Error("Request timed out"))},i._settings.timeout)),i._requests[e.id]=s}try{i._ws.send(n)}catch(t){return r&&(clearTimeout(i._requests[e.id].timeout),delete i._requests[e.id]),o(t)}})):o(new Error("Failed to send message - server disconnected"))},e.prototype._hello=function(e,t){var n={type:"hello"};e&&(n.auth=e);var r=this.subscriptions();return r.length&&(n.subs=r),this._send(n,!0,t)},e.prototype.subscriptions=function(){return Object.keys(this._subscriptions)},e.prototype.subscribe=function(e,t){if(!e||"/"!==e[0])return t(new Error("Invalid path"));var r=this._subscriptions[e];if(r)return void(-1===r.indexOf(t)&&r.push(t));if(this._subscriptions[e]=[t],this._ws&&this._ws.readyState===n.OPEN){var s={type:"sub",path:e};return this._send(s,!1,function(e){return t(e)})}},e.prototype.unsubscribe=function(e,t){if(!e||"/"!==e[0])return t(new Error("Invalid path"));var r=this._subscriptions[e];if(r){var s=!1;if(t){var o=r.indexOf(t);if(-1===o)return;r.splice(o,1),r.length||(delete this._subscriptions[e],s=!0)}else delete this._subscriptions[e],s=!0;if(s&&this._ws&&this._ws.readyState===n.OPEN){var i={type:"unsub",path:e};return this._send(i,!1)}}},e.prototype._onMessage=function(e){var t=this;this._beat(),r(e.data,function(e,n){if(e)return t.onError(e);var r=null;if(n.statusCode&&n.statusCode>=400&&n.statusCode<=599&&(r=new Error(n.payload.message||n.payload.error),r.statusCode=n.statusCode,r.data=n.payload,r.headers=n.headers),"ping"===n.type)return t._send({type:"ping"},!1);if("update"===n.type)return t.onUpdate(n.message);if("pub"===n.type)return t._notifyHandlers(n.path,null,n.message);if("sub"===n.type)return t._notifyHandlers(n.path,r);var s=t._requests[n.id];if(!s)return t.onError(new Error("Received response for unknown request"));var o=s.callback;return clearTimeout(s.timeout),delete t._requests[n.id],o?"request"===n.type?o(r,n.payload,n.statusCode,n.headers):"message"===n.type?o(r,n.message):"hello"===n.type?(n.heartbeat&&(t._heartbeatTimeout=n.heartbeat.interval+n.heartbeat.timeout,t._beat()),o(r)):t.onError(new Error("Received unknown response type: "+n.type)):void 0})},e.prototype._beat=function(){var e=this;e._heartbeatTimeout&&(clearTimeout(this._heartbeat),this._heartbeat=setTimeout(function(){e._ws.close()},e._heartbeatTimeout))},e.prototype._notifyHandlers=function(e,t,n){var r=this._subscriptions[e];if(r){t&&delete this._subscriptions[e];for(var s=0,o=r.length;o>s;++s)r[s](t,n)}};var t=function(){},n="undefined"==typeof WebSocket?require("ws"):WebSocket,r=function(e,t){var n=null,r=null;try{n=JSON.parse(e)}catch(s){r=s}return t(r,n)},s=function(e,t){var n=null,r=null;try{n=JSON.stringify(e)}catch(s){r=s}return t(r,n)};return{Client:e}});