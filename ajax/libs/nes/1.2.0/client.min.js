"use strict";function _typeof(a){return a&&typeof Symbol!=="undefined"&&a.constructor===Symbol?"symbol":typeof a}(function(a,b){if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"&&(typeof module==="undefined"?"undefined":_typeof(module))==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"){exports.nes=b()}else{a.nes=b()}}}})(undefined,function(){var e=function e(){};var a=typeof WebSocket==="undefined"?require("ws"):WebSocket;var c=function c(i,g){var j=null;var f=null;try{j=JSON.parse(i)}catch(h){f=h}return g(f,j)};var d=function d(j,h){var g=null;var f=null;try{g=JSON.stringify(j)}catch(i){f=i}return h(f,g)};var b=function b(g,f){f=f||{};this._url=g;this._settings=f;this._heartbeatTimeout=false;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this._heartbeat=null;this.onError=console.error;this.onConnect=e;this.onDisconnect=e;this.onUpdate=e;this.id=null};b.prototype.connect=function(f,g){if(typeof f==="function"){g=arguments[0];f={}}if(f.reconnect!==false){this._reconnection={wait:0,delay:f.delay||1000,maxDelay:f.maxDelay||5000,retries:f.retries||Infinity,settings:{auth:f.auth,timeout:f.timeout}}}else{this._reconnection=null}this._connect(f,true,g)};b.prototype._connect=function(h,g,m){var l=this;var j=false;var k=function k(){j=true;l._ws.close();m(new Error("Connection timed out"));l._cleanup();if(g){return l._reconnect()}};var i=h.timeout?setTimeout(k,h.timeout):null;var f=new a(this._url,this._settings.ws);this._ws=f;f.onopen=function(){clearTimeout(i);if(!j){j=true;return l._hello(h.auth,function(n){if(n){l.disconnect();return m(n)}l.onConnect();return m()})}};f.onerror=function(n){clearTimeout(i);if(!j){j=true;return m(n)}return l.onError(n)};f.onclose=function(){l._cleanup();l.onDisconnect(!!l._reconnection);l._reconnect()};f.onmessage=function(n){return l._onMessage(n)}};b.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===a.OPEN||this._ws.readyState===a.CONNECTING){this._ws.close()}};b.prototype._cleanup=function(){var f=this._ws;if(!f){return}this._ws=null;this.id=null;f.onopen=null;f.onclose=null;f.onerror=e;f.onmessage=null;clearTimeout(this._heartbeat);var g=new Error("Request failed - server disconnected");var j=Object.keys(this._requests);for(var h=0;h<j.length;++h){var m=j[h];var k=this._requests[m];var l=k.callback;clearTimeout(k.timeout);delete this._requests[m];l(g)}};b.prototype._reconnect=function(){var f=this;if(this._reconnection){if(this._reconnection.retries<1){return}--this._reconnection.retries;this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var g=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!f._reconnection){return}f._connect(f._reconnection.settings,false,function(h){if(h){f.onError(h);f._cleanup();return f._reconnect()}})},g)}};b.prototype.request=function(f,h){if(typeof f==="string"){f={method:"GET",path:f}}var g={type:"request",method:f.method||"GET",path:f.path,headers:f.headers,payload:f.payload};return this._send(g,true,h)};b.prototype.message=function(g,h){var f={type:"message",message:g};return this._send(f,true,h)};b.prototype._send=function(h,f,i){var g=this;i=i||e;if(!this._ws||this._ws.readyState!==a.OPEN){return i(new Error("Failed to send message - server disconnected"))}h.id=++this._ids;d(h,function(j,k){if(j){return i(j)}if(f){(function(){var l={callback:i,timeout:null};if(g._settings.timeout){l.timeout=setTimeout(function(){l.callback=null;l.timeout=null;return i(new Error("Request timed out"))},g._settings.timeout)}g._requests[h.id]=l})()}try{g._ws.send(k)}catch(j){if(f){clearTimeout(g._requests[h.id].timeout);delete g._requests[h.id]}return i(j)}})};b.prototype._hello=function(h,i){var g={type:"hello"};if(h){g.auth=h}var f=this.subscriptions();if(f.length){g.subs=f}return this._send(g,true,i)};b.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};b.prototype.subscribe=function(i,g){if(!i||i[0]!=="/"){return g(new Error("Invalid path"))}var f=this._subscriptions[i];if(f){if(f.indexOf(g)===-1){f.push(g)}return}this._subscriptions[i]=[g];if(!this._ws||this._ws.readyState!==a.OPEN){return}var h={type:"sub",path:i};return this._send(h,false,function(j){return g(j)})};b.prototype.unsubscribe=function(j,g){if(!j||j[0]!=="/"){return g(new Error("Invalid path"))}var f=this._subscriptions[j];if(!f){return}var i=false;if(!g){delete this._subscriptions[j];i=true}else{var k=f.indexOf(g);if(k===-1){return}f.splice(k,1);if(!f.length){delete this._subscriptions[j];i=true}}if(!i||!this._ws||this._ws.readyState!==a.OPEN){return}var h={type:"unsub",path:j};return this._send(h,false)};b.prototype._onMessage=function(g){var f=this;this._beat();c(g.data,function(j,l){if(j){return f.onError(j)}var h=null;if(l.statusCode&&l.statusCode>=400&&l.statusCode<=599){h=new Error(l.payload.message||l.payload.error);h.statusCode=l.statusCode;h.data=l.payload;h.headers=l.headers}if(l.type==="ping"){return f._send({type:"ping"},false)}if(l.type==="update"){return f.onUpdate(l.message)}if(l.type==="pub"){return f._notifyHandlers(l.path,null,l.message)}if(l.type==="sub"){return f._notifyHandlers(l.path,h)}var i=f._requests[l.id];if(!i){return f.onError(new Error("Received response for unknown request"))}var k=i.callback;clearTimeout(i.timeout);delete f._requests[l.id];if(!k){return}if(l.type==="request"){return k(h,l.payload,l.statusCode,l.headers)}if(l.type==="message"){return k(h,l.message)}if(l.type==="hello"){f.id=l.socket;if(l.heartbeat){f._heartbeatTimeout=l.heartbeat.interval+l.heartbeat.timeout;f._beat()}return k(h)}return f.onError(new Error("Received unknown response type: "+l.type))})};b.prototype._beat=function(){var f=this;if(!this._heartbeatTimeout){return}clearTimeout(this._heartbeat);this._heartbeat=setTimeout(function(){f._ws.close()},this._heartbeatTimeout)};b.prototype._notifyHandlers=function(k,j,h){var f=this._subscriptions[k];if(f){if(j){delete this._subscriptions[k]}for(var g=0;g<f.length;++g){f[g](j,h)}}};return{Client:b}});