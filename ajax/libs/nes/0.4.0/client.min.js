(function(a,b){if(typeof exports==="object"&&typeof module==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if(typeof exports==="object"){exports.nes=b()}else{a.nes=b()}}}})(this,function(){var f=function(){};var a=(typeof WebSocket==="undefined"?require("ws"):WebSocket);var d=function(h,g){this._url=h;this._settings=g;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this.onError=console.error;this.onConnect=f;this.onDisconnect=f;this.onBroadcast=f};d.prototype.connect=function(g,h){if(typeof g==="function"){h=arguments[0];g={}}if(g.reconnect!==false){this._reconnection={wait:0,delay:g.delay||1000,maxDelay:g.maxDelay||5000,auth:g.auth}}else{this._reconnection=null}this._connect(g.auth,h)};d.prototype._connect=function(i,k){var h=this;var g=new a(this._url,this._settings);this._ws=g;var j=false;g.onopen=function(){if(!j){j=true;return h._hello(i,function(l){if(l){h.disconnect();return k(l)}h.onConnect();return k()})}};g.onerror=function(l){if(!j){j=true;return k(l)}return h.onError(l)};g.onclose=function(){return h._onClose()};g.onmessage=function(l){return h._onMessage(l)}};d.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===a.OPEN||this._ws.readyState===a.CONNECTING){this._ws.close()}};d.prototype._onClose=function(){this._ws=null;var h=new Error("Request failed - server disconnected");var k=Object.keys(this._requests);for(var j=0,g=k.length;j<g;++j){var m=k[j];var l=this._requests[m];delete this._requests[m];l(h)}this.onDisconnect(!!this._reconnection);this._reconnect()};d.prototype._reconnect=function(){var g=this;if(this._reconnection){this._reconnection.wait+=this._reconnection.delay;var h=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!g._reconnection){return}g._connect(g._reconnection.auth,function(i){if(i){g.onError(i);return g._reconnect()}})},h)}};d.prototype.request=function(g,i){if(typeof g==="string"){g={method:"GET",path:g}}var h={type:"request",method:g.method||"GET",path:g.path,headers:g.headers,payload:g.payload};return this._send(h,true,i)};d.prototype.message=function(h,i){var g={type:"message",message:h};return this._send(g,true,i)};d.prototype._send=function(i,g,j){var h=this;j=j||f;if(!this._ws||this._ws.readyState!==a.OPEN){return j(new Error("Failed to send message - server disconnected"))}i.id=++h._ids;e(i,function(k,l){if(k){return j(k)}if(g){h._requests[i.id]=j}try{h._ws.send(l)}catch(k){if(g){delete h._requests[i.id]}return j(k)}})};d.prototype._hello=function(i,j){var h={type:"hello"};if(i){h.auth=i}var g=this.subscriptions();if(g.length){h.subs=g}return this._send(h,true,j)};d.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};d.prototype.subscribe=function(k,i){var g=this;if(!k||k[0]!=="/"){return i(new Error("Invalid path"))}var h=this._subscriptions[k];if(h){if(h.indexOf(i)===-1){h.push(i)}return}this._subscriptions[k]=[i];if(!this._ws||this._ws.readyState!==a.OPEN){return}var j={type:"sub",path:k};return this._send(j,false,function(l){return i(l)})};d.prototype.unsubscribe=function(l,i){var g=this;if(!l||l[0]!=="/"){return i(new Error("Invalid path"))}var h=this._subscriptions[l];if(!h){return}var k=false;if(!i){delete this._subscriptions[l];k=true}else{var m=h.indexOf(i);if(m===-1){return}h.splice(m,1);if(!h.length){delete this._subscriptions[l];k=true}}if(!k||!this._ws||this._ws.readyState!==a.OPEN){return}var j={type:"unsub",path:l};return this._send(j,false)};d.prototype._onMessage=function(h){var g=this;c(h.data,function(j,l){if(j){return g.onError(j)}var i=null;if(l.statusCode&&l.statusCode>=400&&l.statusCode<=599){i=new Error(l.payload.message||l.payload.error);i.statusCode=l.statusCode;i.data=l.payload;i.headers=l.headers}if(l.type==="broadcast"){return g.onBroadcast(l.message)}if(l.type==="pub"){return g._notifyHandlers(l.path,null,l.message)}if(l.type==="sub"){return g._notifyHandlers(l.path,i)}var k=g._requests[l.id];delete g._requests[l.id];if(!k){return g.onError(new Error("Received response for missing request"))}if(l.type==="request"){return k(i,l.payload,l.statusCode,l.headers)}if(l.type==="message"){return k(i,l.message)}if(l.type==="hello"){return k(i)}return g.onError(new Error("Received unknown response type: "+l.type))})};d.prototype._notifyHandlers=function(m,l,k){var h=this._subscriptions[m];if(h){if(l){delete this._subscriptions[m]}for(var j=0,g=h.length;j<g;++j){h[j](l,k)}}};var c=function(j,h){var k=null;var g=null;try{k=JSON.parse(j)}catch(i){g=i}return h(g,k)};var e=function(k,i){var h=null;var g=null;try{h=JSON.stringify(k)}catch(j){g=j}return i(g,h)};var b={Client:d};return b});