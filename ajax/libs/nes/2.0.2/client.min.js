"use strict";function _typeof(a){return a&&typeof Symbol!=="undefined"&&a.constructor===Symbol?"symbol":typeof a}(function(a,b){if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"&&(typeof module==="undefined"?"undefined":_typeof(module))==="object"){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"){exports.nes=b()}else{a.nes=b()}}}})(undefined,function(){var a="2";var e=function e(){};var c=function c(i,g){var j=null;var f=null;try{j=JSON.parse(i)}catch(h){f=h}return g(f,j)};var d=function d(j,h){var g=null;var f=null;try{g=JSON.stringify(j)}catch(i){f=i}return h(f,g)};var b=function b(g,f){f=f||{};this._url=g;this._settings=f;this._heartbeatTimeout=false;this._ws=null;this._reconnection=null;this._ids=0;this._requests={};this._subscriptions={};this._heartbeat=null;this.onError=function(h){return console.error(h)};this.onConnect=e;this.onDisconnect=e;this.onUpdate=e;this.id=null};b.WebSocket=typeof WebSocket==="undefined"?null:WebSocket;b.prototype.connect=function(f,g){if(typeof f==="function"){g=arguments[0];f={}}if(f.reconnect!==false){this._reconnection={wait:0,delay:f.delay||1000,maxDelay:f.maxDelay||5000,retries:f.retries||Infinity,settings:{auth:f.auth,timeout:f.timeout}}}else{this._reconnection=null}this._connect(f,true,g)};b.prototype._connect=function(h,g,m){var l=this;var j=false;var k=function k(){j=true;l._ws.close();m(new Error("Connection timed out"));l._cleanup();if(g){return l._reconnect()}};var i=h.timeout?setTimeout(k,h.timeout):null;var f=new b.WebSocket(this._url,this._settings.ws);this._ws=f;f.onopen=function(){clearTimeout(i);if(!j){j=true;return l._hello(h.auth,function(n){if(n){if(n.path){delete l._subscriptions[n.path]}l.disconnect();return m(n)}l.onConnect();return m()})}};f.onerror=function(n){clearTimeout(i);if(!j){j=true;return m(n)}return l.onError(n)};f.onclose=function(){l._cleanup();l.onDisconnect(!!l._reconnection);l._reconnect()};f.onmessage=function(n){return l._onMessage(n)}};b.prototype.disconnect=function(){this._reconnection=null;if(!this._ws){return}if(this._ws.readyState===b.WebSocket.OPEN||this._ws.readyState===b.WebSocket.CONNECTING){this._ws.close()}};b.prototype._cleanup=function(){var f=this._ws;if(!f){return}this._ws=null;this.id=null;f.onopen=null;f.onclose=null;f.onerror=e;f.onmessage=null;clearTimeout(this._heartbeat);var g=new Error("Request failed - server disconnected");var j=Object.keys(this._requests);for(var h=0;h<j.length;++h){var m=j[h];var k=this._requests[m];var l=k.callback;clearTimeout(k.timeout);delete this._requests[m];l(g)}};b.prototype._reconnect=function(){var f=this;if(this._reconnection){if(this._reconnection.retries<1){return}--this._reconnection.retries;this._reconnection.wait=this._reconnection.wait+this._reconnection.delay;var g=Math.min(this._reconnection.wait,this._reconnection.maxDelay);setTimeout(function(){if(!f._reconnection){return}f._connect(f._reconnection.settings,false,function(h){if(h){f.onError(h);f._cleanup();return f._reconnect()}})},g)}};b.prototype.request=function(f,h){if(typeof f==="string"){f={method:"GET",path:f}}var g={type:"request",method:f.method||"GET",path:f.path,headers:f.headers,payload:f.payload};return this._send(g,true,h)};b.prototype.message=function(g,h){var f={type:"message",message:g};return this._send(f,true,h)};b.prototype._send=function(h,f,i){var g=this;i=i||e;if(!this._ws||this._ws.readyState!==b.WebSocket.OPEN){return i(new Error("Failed to send message - server disconnected"))}h.id=++this._ids;d(h,function(k,l){if(k){return i(k)}if(!f){try{return g._ws.send(l)}catch(k){return i(k)}}var j={callback:i,timeout:null};if(g._settings.timeout){j.timeout=setTimeout(function(){j.callback=null;j.timeout=null;return i(new Error("Request timed out"))},g._settings.timeout)}g._requests[h.id]=j;try{g._ws.send(l)}catch(k){clearTimeout(g._requests[h.id].timeout);delete g._requests[h.id];return i(k)}})};b.prototype._hello=function(h,i){var g={type:"hello",version:a};if(h){g.auth=h}var f=this.subscriptions();if(f.length){g.subs=f}return this._send(g,true,i)};b.prototype.subscriptions=function(){return Object.keys(this._subscriptions)};b.prototype.subscribe=function(j,h,k){var g=this;if(!j||j[0]!=="/"){return k(new Error("Invalid path"))}var f=this._subscriptions[j];if(f){if(f.indexOf(h)===-1){f.push(h)}return k()}this._subscriptions[j]=[h];if(!this._ws||this._ws.readyState!==b.WebSocket.OPEN){return k()}var i={type:"sub",path:j};return this._send(i,true,function(l){if(l){delete g._subscriptions[j]}return k(l)})};b.prototype.unsubscribe=function(j,g){if(!j||j[0]!=="/"){return g(new Error("Invalid path"))}var f=this._subscriptions[j];if(!f){return}var i=false;if(!g){delete this._subscriptions[j];i=true}else{var k=f.indexOf(g);if(k===-1){return}f.splice(k,1);if(!f.length){delete this._subscriptions[j];i=true}}if(!i||!this._ws||this._ws.readyState!==b.WebSocket.OPEN){return}var h={type:"unsub",path:j};return this._send(h,false)};b.prototype._onMessage=function(g){var f=this;this._beat();c(g.data,function(m,o){if(m){return f.onError(m)}var j=null;if(o.statusCode&&o.statusCode>=400&&o.statusCode<=599){j=new Error(o.payload.message||o.payload.error);j.statusCode=o.statusCode;j.data=o.payload;j.headers=o.headers;j.path=o.path}if(o.type==="ping"){return f._send({type:"ping"},false)}if(o.type==="update"){return f.onUpdate(o.message)}if(o.type==="pub"){var h=f._subscriptions[o.path];if(h){for(var k=0;k<h.length;++k){h[k](o.message)}}return}var l=f._requests[o.id];if(!l){return f.onError(new Error("Received response for unknown request"))}var n=l.callback;clearTimeout(l.timeout);delete f._requests[o.id];if(!n){return}if(o.type==="request"){return n(j,o.payload,o.statusCode,o.headers)}if(o.type==="message"){return n(j,o.message)}if(o.type==="hello"){f.id=o.socket;if(o.heartbeat){f._heartbeatTimeout=o.heartbeat.interval+o.heartbeat.timeout;f._beat()}return n(j)}if(o.type==="sub"){return n(j)}return f.onError(new Error("Received unknown response type: "+o.type))})};b.prototype._beat=function(){var f=this;if(!this._heartbeatTimeout){return}clearTimeout(this._heartbeat);this._heartbeat=setTimeout(function(){f._ws.close()},this._heartbeatTimeout)};return{Client:b}});