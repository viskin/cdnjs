!function(e){"use strict";"function"==typeof define&&define.amd?define("jquery.sheetrock",["jquery"],e):e(window.jQuery)}(function(e){"use strict";e.fn.sheetrock=function(e,t){return e.target=this,e=v(e),e&&(S(t)&&null!==t?o(e,t):s(e)),this};var t="https://spreadsheets.google.com/tq",n={loaded:{},failed:{},offset:{}},r={},a=0,s=function(t){e.fn.sheetrock.promise=e.fn.sheetrock.promise.pipe(function(){return l(t)}).pipe(function(){return i(t)})},o=function(e,t){c(e),p.call(e,t),d.call(e)},l=function(t){var n={sql:"select * limit 1",dataHandler:m,userCallback:e.noop,target:!1};return-1===t.sql.indexOf("%")||b(t)?e.Deferred().resolve():(x("Prefetching column labels."),i(e.extend({},t,n)))},i=function(t){c(t),t.callback="sheetrock_callback_"+a,a+=1;var n={data:u(t),context:t,url:t.server,dataType:"jsonp",cache:!0,jsonp:!1,jsonpCallback:t.callback};return x(n,t.debug),e.ajax(n).promise().done(p).fail(f).always(d)},u=function(e){var t={key:e.key,gid:e.gid,tqx:"responseHandler:"+e.callback};return e.sql&&(t.tq=j(e.sql,b(e))),t},c=function(t){t.loading.show(),e.fn.sheetrock.working=!0},d=function(){this.loading.hide(),e.fn.sheetrock.working=!1,this.userCallback(this)},f=function(){n.failed[this.requestID]=!0,x("Request failed.")},h=function(t,n){y(t,n)&&e.each(t[n],function(e,t){y(t,"detailed_message")?x(t.detailed_message):y(t,"message")&&x(t.message)})},p=function(e){if(h(e,"warnings"),h(e,"errors"),x(e,this.debug),y(e,"status","table")&&y(e.table,"cols","rows")){var t=g.call(this,e);this.dataHandler.call(t,e)}else f.call(this,e)},g=function(t){var r=this;return r.parsed={},r.parsed.last=r.chunkSize?Math.min(t.table.rows.length,r.chunkSize):t.table.rows.length,n.loaded[r.requestID]=!r.chunkSize||r.parsed.last<r.chunkSize,r.parsed.header=e.map(t.table.cols,I).length?1:0,r.parsed.labels=r.labels&&r.labels.length===t.table.cols.length?r.labels:e.map(t.table.cols,z),r},k=function(t){var n=this,r=n.target;e.extend(n,{thead:n.rowGroups?e("<thead/>").appendTo(r):r,tbody:n.rowGroups?e("<tbody/>").appendTo(r):r}),n.offset||n.headersOff||(n.parsed.header||!n.headers)&&n.thead.append(n.rowHandler({num:0,cells:_(n.parsed.labels)})),e.each(t.table.rows,function(t,r){if(y(r,"c")&&t<n.parsed.last){var a=w(n.offset+t+1+n.parsed.header-n.headers),s={num:a,cells:{}};(a||!n.headersOff)&&(e.each(r.c,function(e,t){var r=n.formatting?C(t):!1,a=t&&y(t,"v")?t.v:"";a instanceof Array&&(a=y(t,"f")?t.f:a.join("")),a=n.cellHandler(a),s.cells[n.parsed.labels[e]]=r?O(a,"span",r):a}),s.num?n.tbody.append(n.rowHandler(s)):n.thead.append(n.rowHandler(s)))}})},m=function(t){var n={};e.each(t.table.cols,function(e,t){n[t.id]=z(t)}),r[this.key+"_"+this.gid]=n},b=function(t){return e.isEmptyObject(t.columns)?r[t.key+"_"+t.gid]||!1:t.columns},v=function(t){return t=e.extend({},e.fn.sheetrock.options,t),t.key=D(t.url),t.gid=H(t.url),t.requestID=t.key+"_"+t.gid+"_"+t.sql,t.chunkSize=t.target.length?w(t.chunkSize):0,t.headers=w(t.headers),t.loading=R(t.loading),t.resetStatus&&(n.loaded[t.requestID]=!1,n.failed[t.requestID]=!1,n.offset[t.requestID]=0,x("Resetting request status.")),t.offset=n.offset[t.requestID]||0,t.chunkSize&&t.target&&(t.sql+=" limit "+(t.chunkSize+1),t.sql+=" offset "+t.offset,n.offset[t.requestID]=t.offset+t.chunkSize),t.target.length||t.dataHandler!==k?n.loaded[t.requestID]?x("No more rows to load!"):n.failed[t.requestID]?x("A previous request for this resource failed."):t.url?t.key?t.gid?(x(t,t.debug),t):x("Could not find a gid in the provided URL."):x("Could not find a key in the provided URL."):x("No spreadsheet URL provided."):x("No element targeted or data handler provided.")},q=function(e){return e.toString().replace(/^ +/,"").replace(/ +$/,"")},w=function(e){return Math.max(0,parseInt(e,10)||0)},y=function(e){for(var t=1;t<arguments.length;t+=1)if(!S(e[arguments[t]]))return!1;return!0},S=function(){for(var e=0;e<arguments.length;e+=1)if("undefined"==typeof arguments[e])return!1;return!0},x=function(e,t){return t=S(t,console)?t:!0,t&&console.log&&console.log(e),!1},D=function(e){var t=new RegExp("key=([^&#]+)","i");if(t.test(e))return e.match(t)[1];var n=new RegExp("spreadsheets/d/([^/#]+)","i");return n.test(e)?e.match(n)[1]:!1},H=function(e){var t=new RegExp("gid=([^/&#]+)","i");return t.test(e)?e.match(t)[1]:!1},I=function(e){return y(e,"label")?e.label.replace(/\s/g,""):null},z=function(e){return I(e)||e.id},j=function(t,n){return e.each(n,function(e,n){t=t.replace(new RegExp("%"+n+"%","g"),e)}),t},R=function(t){return!t||t instanceof e?t:e(t)},_=function(t){var n={};return e.each(t,function(e,t){n[t]=t}),n},C=function(e){return e&&y(e,"p")&&y(e.p,"style")?e.p.style:!1},E=function(e){var t,n="",r=e.num?"td":"th";for(t in e.cells)y(e.cells,t)&&(n+=O(e.cells[t],r,""));return O(n,"tr","")},O=function(e,t,n){var r=n?' style="'+n+'"':"";return"<"+t+r+">"+e+"</"+t+">"};e.fn.sheetrock.options={url:"",sql:"",server:t,chunkSize:0,columns:{},labels:[],rowHandler:E,cellHandler:q,dataHandler:k,userCallback:e.noop,loading:e(),headers:0,headersOff:!1,rowGroups:!0,formatting:!1,resetStatus:!1,debug:!1},e.fn.sheetrock.working=!1,e.fn.sheetrock.promise=e.Deferred().resolve(),e.fn.sheetrock.version="0.1.10"});