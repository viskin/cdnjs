!function(e){"use strict";"function"==typeof define&&define.amd?define("jquery.sheetrock",["jquery"],e):e(window.jQuery)}(function(e){"use strict";e.fn.sheetrock=function(e,t){return e.target=this,e=b(e),e&&(H(t)&&null!==t?o(e,t):s(e)),this};var t={"new":{endpoint:"https://docs.google.com/spreadsheets/d/%key%/gviz/tq",keyFormat:new RegExp("spreadsheets/d/([^/#]+)","i")},legacy:{endpoint:"https://spreadsheets.google.com/tq?key=%key%",keyFormat:new RegExp("key=([^&#]+)","i")}},n={loaded:{},failed:{},offset:{}},r={},a=0,s=function(t){e.fn.sheetrock.promise=e.fn.sheetrock.promise.pipe(function(){return l(t)}).pipe(function(){return i(t)})},o=function(e,t){c(e),p.call(e,t),d.call(e)},l=function(t){var n={sql:"select * limit 1",dataHandler:m,userCallback:e.noop,target:!1};return-1===t.sql.indexOf("%")||v(t)?e.Deferred().resolve():(S("Prefetching column labels."),i(e.extend({},t,n)))},i=function(t){c(t),t.callback="sheetrock_callback_"+a,a+=1;var n={data:u(t),context:t,url:t.server,dataType:"jsonp",cache:!0,jsonp:!1,jsonpCallback:t.callback};return S(n,t.debug),e.ajax(n).promise().done(p).fail(f).always(d)},u=function(e){var t={gid:e.gid,tqx:"responseHandler:"+e.callback};return e.sql&&(t.tq=R(e.sql,v(e))),t},c=function(t){t.loading.show(),e.fn.sheetrock.working=!0},d=function(){this.loading.hide(),e.fn.sheetrock.working=!1,this.userCallback(this)},f=function(e){n.failed[this.requestID]=!0,S("Request failed."),this.errorHandler.call(this,e)},h=function(t,n){w(t,n)&&e.each(t[n],function(e,t){w(t,"detailed_message")?S(t.detailed_message):w(t,"message")&&S(t.message)})},p=function(e){if(h(e,"warnings"),h(e,"errors"),S(e,this.debug),w(e,"status","table")&&w(e.table,"cols","rows")){var t=g.call(this,e);this.dataHandler.call(t,e)}else f.call(this,e)},g=function(t){var r=this;return r.parsed={},r.parsed.last=r.chunkSize?Math.min(t.table.rows.length,r.chunkSize):t.table.rows.length,n.loaded[r.requestID]=!r.chunkSize||r.parsed.last<r.chunkSize,r.parsed.header=e.map(t.table.cols,I).length?1:0,r.parsed.labels=r.labels&&r.labels.length===t.table.cols.length?r.labels:e.map(t.table.cols,j),r},k=function(t){var n=this,r=n.target;e.extend(n,{thead:n.rowGroups?e("<thead/>").appendTo(r):r,tbody:n.rowGroups?e("<tbody/>").appendTo(r):r}),n.offset||n.headersOff||(n.parsed.header||!n.headers)&&n.thead.append(n.rowHandler({num:0,cells:C(n.parsed.labels)})),e.each(t.table.rows,function(t,r){if(w(r,"c")&&t<n.parsed.last){var a=q(n.offset+t+1+n.parsed.header-n.headers),s={num:a,cells:{}};(a||!n.headersOff)&&(e.each(r.c,function(e,t){var r=n.formatting?E(t):!1,a=t&&w(t,"v")?t.v:"";a instanceof Array&&(a=w(t,"f")?t.f:a.join("")),a=n.cellHandler(a),s.cells[n.parsed.labels[e]]=r?F(a,"span",r):a}),s.num?n.tbody.append(n.rowHandler(s)):n.thead.append(n.rowHandler(s)))}})},m=function(t){var n={};e.each(t.table.cols,function(e,t){n[t.id]=j(t)}),r[this.key+"_"+this.gid]=n},v=function(t){return e.isEmptyObject(t.columns)?r[t.key+"_"+t.gid]||!1:t.columns},b=function(t){return t=e.extend({},e.fn.sheetrock.options,t),t.type=x(t.url),t.key=D(t.url,t.type),t.gid=z(t.url),t.server=t.server.length?t.server:t.type.endpoint,t.server=t.server.replace("%key%",t.key),t.requestID=t.key+"_"+t.gid+"_"+t.sql,t.chunkSize=t.target.length?q(t.chunkSize):0,t.headers=q(t.headers),t.loading=_(t.loading),t.resetStatus&&(n.loaded[t.requestID]=!1,n.failed[t.requestID]=!1,n.offset[t.requestID]=0,S("Resetting request status.")),t.offset=n.offset[t.requestID]||0,t.chunkSize&&t.target&&(t.sql+=" limit "+(t.chunkSize+1),t.sql+=" offset "+t.offset,n.offset[t.requestID]=t.offset+t.chunkSize),t.target.length||t.dataHandler!==k?n.loaded[t.requestID]?S("No more rows to load!"):n.failed[t.requestID]?S("A previous request for this resource failed."):t.url?t.key?t.gid?(S(t,t.debug),t):S("Could not find a gid in the provided URL."):S("Could not find a key in the provided URL."):S("No spreadsheet URL provided."):S("No element targeted or data handler provided.")},y=function(e){return e.toString().replace(/^ +/,"").replace(/ +$/,"")},q=function(e){return Math.max(0,parseInt(e,10)||0)},w=function(e){for(var t=1;t<arguments.length;t+=1)if(!H(e[arguments[t]]))return!1;return!0},H=function(){for(var e=0;e<arguments.length;e+=1)if("undefined"==typeof arguments[e])return!1;return!0},S=function(e,t){return t=H(t,console)?t:!0,t&&console.log&&console.log(e),!1},x=function(n){var r;return e.each(t,function(e,t){return t.keyFormat.test(n)?(r=t,!1):void 0}),r||t.new},D=function(e,t){return t?e.match(t.keyFormat)[1]:!1},z=function(e){var t=new RegExp("gid=([^/&#]+)","i");return t.test(e)?e.match(t)[1]:!1},I=function(e){return w(e,"label")?e.label.replace(/\s/g,""):null},j=function(e){return I(e)||e.id},R=function(t,n){return e.each(n,function(e,n){t=t.replace(new RegExp("%"+n+"%","g"),e)}),t},_=function(t){return!t||t instanceof e?t:e(t)},C=function(t){var n={};return e.each(t,function(e,t){n[t]=t}),n},E=function(e){return e&&w(e,"p")&&w(e.p,"style")?e.p.style:!1},O=function(e){var t,n="",r=e.num?"td":"th";for(t in e.cells)w(e.cells,t)&&(n+=F(e.cells[t],r,""));return F(n,"tr","")},F=function(e,t,n){var r=n?' style="'+n+'"':"";return"<"+t+r+">"+e+"</"+t+">"};e.fn.sheetrock.options={url:"",sql:"",server:"",chunkSize:0,columns:{},labels:[],rowHandler:O,cellHandler:y,dataHandler:k,errorHandler:e.noop,userCallback:e.noop,loading:e(),headers:0,headersOff:!1,rowGroups:!0,formatting:!1,resetStatus:!1,debug:!1},e.fn.sheetrock.working=!1,e.fn.sheetrock.promise=e.Deferred().resolve(),e.fn.sheetrock.version="0.2.0"});