define(function(require,exports,module){var syn=require("./synthetic");require("./typeable"),require("./browsers");var h=syn.helpers,formElExp=/input|textarea/i,getSelection=function(el){var real,r,start;if(void 0!==el.selectionStart)return document.activeElement&&document.activeElement!==el&&el.selectionStart===el.selectionEnd&&0===el.selectionStart?{start:el.value.length,end:el.value.length}:{start:el.selectionStart,end:el.selectionEnd};try{if("input"===el.nodeName.toLowerCase())return real=h.getWindow(el).document.selection.createRange(),r=el.createTextRange(),r.setEndPoint("EndToStart",real),start=r.text.length,{start:start,end:start+real.text.length};real=h.getWindow(el).document.selection.createRange(),r=real.duplicate();var r2=real.duplicate(),r3=real.duplicate();r2.collapse(),r3.collapse(!1),r2.moveStart("character",-1),r3.moveStart("character",-1),r.moveToElementText(el),r.setEndPoint("EndToEnd",real),start=r.text.length-real.text.length;var end=r.text.length;return 0!==start&&""===r2.text&&(start+=2),0!==end&&""===r3.text&&(end+=2),{start:start,end:end}}catch(e){var prop=formElExp.test(el.nodeName)?"value":"textContent";return{start:el[prop].length,end:el[prop].length}}},getFocusable=function(el){for(var document=h.getWindow(el).document,res=[],els=document.getElementsByTagName("*"),len=els.length,i=0;len>i;i++)syn.isFocusable(els[i])&&els[i]!==document.documentElement&&res.push(els[i]);return res},textProperty=function(){var el=document.createElement("span");return null!=el.textContent?"textContent":"innerText"}(),getText=function(el){return formElExp.test(el.nodeName)?el.value:el[textProperty]},setText=function(el,value){formElExp.test(el.nodeName)?el.value=value:el[textProperty]=value};h.extend(syn,{keycodes:{"\b":8,"	":9,"\r":13,shift:16,ctrl:17,alt:18,"pause-break":19,caps:20,escape:27,"num-lock":144,"scroll-lock":145,print:44,"page-up":33,"page-down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46," ":32,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,subtract:109,decimal:110,divide:111,";":186,"=":187,",":188,dash:189,"-":189,period:190,".":190,"forward-slash":191,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222,"left window key":91,"right window key":92,"select key":93,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123},selectText:function(el,start,end){if(el.setSelectionRange)end?(el.selectionStart=start,el.selectionEnd=end):(syn.__tryFocus(el),el.setSelectionRange(start,start));else if(el.createTextRange){var r=el.createTextRange();r.moveStart("character",start),end=end||start,r.moveEnd("character",end-el.value.length),r.select()}},getText:function(el){if(syn.typeable.test(el)){var sel=getSelection(el);return el.value.substring(sel.start,sel.end)}var win=syn.helpers.getWindow(el);return win.getSelection?win.getSelection().toString():win.document.getSelection?win.document.getSelection().toString():win.document.selection.createRange().text},getSelection:getSelection}),h.extend(syn.key,{data:function(key){if(syn.key.browser[key])return syn.key.browser[key];for(var kind in syn.key.kinds)if(h.inArray(key,syn.key.kinds[kind])>-1)return syn.key.browser[kind];return syn.key.browser.character},isSpecial:function(keyCode){for(var specials=syn.key.kinds.special,i=0;i<specials.length;i++)if(syn.keycodes[specials[i]]===keyCode)return specials[i]},options:function(key,event){var keyData=syn.key.data(key);if(!keyData[event])return null;var charCode=keyData[event][0],keyCode=keyData[event][1],result={};return"key"===keyCode?result.keyCode=syn.keycodes[key]:"char"===keyCode?result.keyCode=key.charCodeAt(0):result.keyCode=keyCode,"char"===charCode?result.charCode=key.charCodeAt(0):null!==charCode&&(result.charCode=charCode),result.keyCode?result.which=result.keyCode:result.which=result.charCode,result},kinds:{special:["shift","ctrl","alt","caps"],specialChars:["\b"],navigation:["page-up","page-down","end","home","left","up","right","down","insert","delete"],"function":["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12"]},getDefault:function(key){if(syn.key.defaults[key])return syn.key.defaults[key];for(var kind in syn.key.kinds)if(h.inArray(key,syn.key.kinds[kind])>-1&&syn.key.defaults[kind])return syn.key.defaults[kind];return syn.key.defaults.character},defaults:{character:function(options,scope,key,force,sel){if(/num\d+/.test(key)&&(key=key.match(/\d+/)[0]),force||!syn.support.keyCharacters&&syn.typeable.test(this)){var current=getText(this),before=current.substr(0,sel.start),after=current.substr(sel.end),character=key;setText(this,before+character+after);var charLength="\n"===character&&syn.support.textareaCarriage?2:character.length;syn.selectText(this,before.length+charLength)}},c:function(options,scope,key,force,sel){syn.key.ctrlKey?syn.key.clipboard=syn.getText(this):syn.key.defaults.character.apply(this,arguments)},v:function(options,scope,key,force,sel){syn.key.ctrlKey?syn.key.defaults.character.call(this,options,scope,syn.key.clipboard,!0,sel):syn.key.defaults.character.apply(this,arguments)},a:function(options,scope,key,force,sel){syn.key.ctrlKey?syn.selectText(this,0,getText(this).length):syn.key.defaults.character.apply(this,arguments)},home:function(){syn.onParents(this,function(el){return el.scrollHeight!==el.clientHeight?(el.scrollTop=0,!1):void 0})},end:function(){syn.onParents(this,function(el){return el.scrollHeight!==el.clientHeight?(el.scrollTop=el.scrollHeight,!1):void 0})},"page-down":function(){syn.onParents(this,function(el){if(el.scrollHeight!==el.clientHeight){var ch=el.clientHeight;return el.scrollTop+=ch,!1}})},"page-up":function(){syn.onParents(this,function(el){if(el.scrollHeight!==el.clientHeight){var ch=el.clientHeight;return el.scrollTop-=ch,!1}})},"\b":function(options,scope,key,force,sel){if(!syn.support.backspaceWorks&&syn.typeable.test(this)){var current=getText(this),before=current.substr(0,sel.start),after=current.substr(sel.end);sel.start===sel.end&&sel.start>0?(setText(this,before.substring(0,before.length-1)+after),syn.selectText(this,sel.start-1)):(setText(this,before+after),syn.selectText(this,sel.start))}},"delete":function(options,scope,key,force,sel){if(!syn.support.backspaceWorks&&syn.typeable.test(this)){var current=getText(this),before=current.substr(0,sel.start),after=current.substr(sel.end);sel.start===sel.end&&sel.start<=getText(this).length-1?setText(this,before+after.substring(1)):setText(this,before+after),syn.selectText(this,sel.start)}},"\r":function(options,scope,key,force,sel){var nodeName=this.nodeName.toLowerCase();if("input"===nodeName&&syn.trigger(this,"change",{}),!syn.support.keypressSubmits&&"input"===nodeName){var form=syn.closest(this,"form");form&&syn.trigger(form,"submit",{})}syn.support.keyCharacters||"textarea"!==nodeName||syn.key.defaults.character.call(this,options,scope,"\n",void 0,sel),syn.support.keypressOnAnchorClicks||"a"!==nodeName||syn.trigger(this,"click",{})},"	":function(options,scope){for(var el,firstNotIndexed,focusEls=getFocusable(this),current=null,i=0,orders=[];i<focusEls.length;i++)orders.push([focusEls[i],i]);var sort=function(order1,order2){var el1=order1[0],el2=order2[0],tab1=syn.tabIndex(el1)||0,tab2=syn.tabIndex(el2)||0;return tab1===tab2?order1[1]-order2[1]:0===tab1?1:0===tab2?-1:tab1-tab2};for(orders.sort(sort),i=0;i<orders.length;i++)el=orders[i][0],this===el&&(syn.key.shiftKey?(current=orders[i-1][0],current||(current=orders[focusEls.length-1][0])):(current=orders[i+1][0],current||(current=orders[0][0])));return current?syn.__tryFocus(current):current=firstNotIndexed,current},left:function(options,scope,key,force,sel){syn.typeable.test(this)&&(syn.key.shiftKey?syn.selectText(this,0===sel.start?0:sel.start-1,sel.end):syn.selectText(this,0===sel.start?0:sel.start-1))},right:function(options,scope,key,force,sel){syn.typeable.test(this)&&(syn.key.shiftKey?syn.selectText(this,sel.start,sel.end+1>getText(this).length?getText(this).length:sel.end+1):syn.selectText(this,sel.end+1>getText(this).length?getText(this).length:sel.end+1))},up:function(){/select/i.test(this.nodeName)&&(this.selectedIndex=this.selectedIndex?this.selectedIndex-1:0)},down:function(){/select/i.test(this.nodeName)&&(syn.changeOnBlur(this,"selectedIndex",this.selectedIndex),this.selectedIndex=this.selectedIndex+1)},shift:function(){return null},ctrl:function(){return null}}}),h.extend(syn.create,{keydown:{setup:function(type,options,element){-1!==h.inArray(options,syn.key.kinds.special)&&(syn.key[options+"Key"]=element)}},keypress:{setup:function(type,options,element){syn.support.keyCharacters&&!syn.support.keysOnNotFocused&&syn.__tryFocus(element)}},keyup:{setup:function(type,options,element){-1!==h.inArray(options,syn.key.kinds.special)&&(syn.key[options+"Key"]=null)}},key:{options:function(type,options,element){return options="object"!=typeof options?{character:options}:options,options=h.extend({},options),options.character&&(h.extend(options,syn.key.options(options.character,type)),delete options.character),options=h.extend({ctrlKey:!!syn.key.ctrlKey,altKey:!!syn.key.altKey,shiftKey:!!syn.key.shiftKey,metaKey:!!syn.key.metaKey},options)},event:function(type,options,element){var event,doc=h.getWindow(element).document||document;if(doc.createEvent){try{event=doc.createEvent("KeyEvents"),event.initKeyEvent(type,!0,!0,window,options.ctrlKey,options.altKey,options.shiftKey,options.metaKey,options.keyCode,options.charCode)}catch(e){event=h.createBasicStandardEvent(type,options,doc)}return event.synthetic=!0,event}try{event=h.createEventObject.apply(this,arguments),h.extend(event,options)}catch(e){}return event}}});var convert={enter:"\r",backspace:"\b",tab:"	",space:" "};h.extend(syn.init.prototype,{_key:function(element,options,callback){if(/-up$/.test(options)&&-1!==h.inArray(options.replace("-up",""),syn.key.kinds.special))return syn.trigger(element,"keyup",options.replace("-up","")),callback(!0,element);var defaultResult,activeElement=h.getWindow(element).document.activeElement,caret=syn.typeable.test(element)&&getSelection(element),key=convert[options]||options,runDefaults=syn.trigger(element,"keydown",key),getDefault=syn.key.getDefault,prevent=syn.key.browser.prevent,keypressOptions=syn.key.options(key,"keypress");return runDefaults?keypressOptions?(activeElement!==h.getWindow(element).document.activeElement&&(element=h.getWindow(element).document.activeElement),runDefaults=syn.trigger(element,"keypress",keypressOptions),runDefaults&&(defaultResult=getDefault(key).call(element,keypressOptions,h.getWindow(element),key,void 0,caret))):defaultResult=getDefault(key).call(element,keypressOptions,h.getWindow(element),key,void 0,caret):keypressOptions&&-1===h.inArray("keypress",prevent.keydown)&&(activeElement!==h.getWindow(element).document.activeElement&&(element=h.getWindow(element).document.activeElement),syn.trigger(element,"keypress",keypressOptions)),defaultResult&&defaultResult.nodeName&&(element=defaultResult),null!==defaultResult?syn.schedule(function(){syn.support.oninput&&syn.trigger(element,"input",syn.key.options(key,"input")),syn.trigger(element,"keyup",syn.key.options(key,"keyup")),callback(runDefaults,element)},1):callback(runDefaults,element),element},_type:function(element,options,callback){var parts=(options+"").match(/(\[[^\]]+\])|([^\[])/g),self=this,runNextPart=function(runDefaults,el){var part=parts.shift();return part?(el=el||element,part.length>1&&(part=part.substr(1,part.length-2)),void self._key(el,part,runNextPart)):void callback(runDefaults,el)};runNextPart()}})});