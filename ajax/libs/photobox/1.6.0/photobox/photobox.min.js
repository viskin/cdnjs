/*!
	photobox v1.6.0
	(c) 2012 Yair Even Or <http://dropthebit.com>

	Uses jQuery-mousewheel Version: 3.0.6
	(c) 2009 Brandon Aaron <http://brandonaaron.net>

	MIT-style license.
*/
(function(c){function N(a){var b,g=j.createElement("p").style,c=["ms","O","Moz","Webkit"];if(""==g[a])return a;a=a[0].toUpperCase()+a.slice(1);for(b=c.length;b--;)if(""==g[c[b]+a])return c[b]+a}function Y(a){a=a.keyCode;var b=d.keys;return 0<=b.close.indexOf(a)&&F()||0<=b.next.indexOf(a)&&A("next")||0<=b.prev.indexOf(a)&&A("prev")||!0}function A(a){if(e.hasClass("hide"))return!1;a="pbPrevBtn"==this.id||"prev"==a?B:y;var b="both"==k.css("clear");C(a,0,b);return!1}function C(a,b,c){if(!a||0>a)a=0;z= a;v=l[a][0];B=(z||(d.loop?l.length:0))-1;y=(z+1)%l.length||(d.loop?0:-1);O();e.addClass("pbLoading").removeClass("error");!d.loop&&a==l.length-1?G.addClass("hide"):G.removeClass("hide");!d.loop&&0==a?H.addClass("hide"):H.removeClass("hide");d.thumbs&&n.changeActive(a,b,c);0<=B&&(P.src=l[B][0]);0<=y&&(Q.src=l[y][0]);d.counter&&I.find(".counter").text("( "+(z+1)+" / "+l.length+" )");d.title&&I.find(".title").text(l[a][1]);r&&e.addClass("hide");d.autoplay&&h.progress.reset();s=new Image;s.onload=function(){var a= function(){f.off(t).css({transition:"0s"});f[0].src=v;f[0].className="prepare";setTimeout(function(){e.removeClass("hide");f.removeAttr("style").prop("class","");setTimeout(function(){f[0].className="";f.on(t,R);r&&R()},0)},50)};e.removeClass("pbLoading").addClass("hide");f.removeClass("zoomable");b?a():(f.on(t,a),r&&a())};s.onerror=function(){e.removeClass("pbLoading").addClass("error");f[0].src=S;s.onerror=null};s.src=v;D.save()}function R(){f.off(t);f.addClass("zoomable");m&&d.autoplay&&h.play(); "function"==typeof J.callback&&J.callback()}function Z(a,b){var g=f.data("zoom")||1,d=f[0].getBoundingClientRect(),g=g+b/10;0.1>g&&(g=0.1);f.data("zoom",g).css({transform:"scale("+g+")"});if(d.height>p.clientHeight||d.width>p.clientWidth)c(j).on("mousemove.photobox",$);else c(j).off("mousemove.photobox"),f[0].style[T]="50% 50%";return!1}function $(a){var b=100*((a.clientY/p.clientHeight*(p.clientHeight+200)-100)/p.clientHeight);a=(100*(a.clientX/p.clientWidth)).toFixed(2)+"% "+b.toFixed(2)+"%";f[0].style[T]= a}function O(){clearTimeout(h.autoPlayTimer);c(j).off("mousemove.photobox");s.onload=function(){};s.src=P.src=Q.src=v}function F(){function a(){""!=e[0].className&&(e.removeClass("show hide"),f.removeAttr("class").removeAttr("style").off().data("zoom",1),aa&&setTimeout(function(){e.hide()},200))}O();E.prototype.setup();D.clear();e.removeClass("on").addClass("hide");f.on(t,a);r&&a();setTimeout(a,500)}function K(a){var b=a||u.event,g=[].slice.call(arguments,1),d=0,e=0,f=0;a=c.event.fix(b);a.type="mousewheel"; b.wheelDelta&&(d=b.wheelDelta/120);b.detail&&(d=-b.detail/3);f=d;void 0!==b.axis&&b.axis===b.HORIZONTAL_AXIS&&(f=0,e=-1*d);void 0!==b.wheelDeltaY&&(f=b.wheelDeltaY/120);void 0!==b.wheelDeltaX&&(e=-1*b.wheelDeltaX/120);g.unshift(a,d,e,f);return(c.event.dispatch||c.event.handle).apply(this,g)}var j=document,u=window,E,w=[],J,d,l=[],z=-1,v,B,y,n,p,h,t="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",r=!("placeholder"in j.createElement("input")),aa=!!u.ActiveXObject,U="ontouchend"in j,L,M,q=c(),S="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",T=N("transformOrigin"),ba=N("transition"),s={},P=new Image,Q=new Image,f,H,G,I,m,k,ca={loop:!0,thumbs:!0,counter:!0,title:!0,autoplay:!1,time:3E3,history:!0,hideFlash:!0,keys:{close:"27, 88, 67",prev:"37, 80",next:"39, 78"}},e=c('<div id="pbOverlay">').hide().append(c('<div class="pbLoader"><b></b><b></b><b></b></div>'),H=c('<div id="pbPrevBtn" class="prevNext"><b></b></div>').on("click",A),G=c('<div id="pbNextBtn" class="prevNext"><b></b></div>').on("click", A),imageWrap=c('<div class="imageWrap">').append(f=c("<img>"))[0],c('<div id="pbCloseBtn">').append("<b>\u00d7</b>").on("click",F)[0],m=c('<div id="pbAutoplayBtn">').append(c('<div class="pbProgress">')),I=c('<div id="pbCaption">').append('<div class="title"></div><div class="counter">',k=c("<div>").addClass("pbThumbs")));c(j).ready(function(){r&&e.addClass("msie");m.on("click",h.toggle);k.on("click","a",n.click);U&&k.css("overflow","auto");e.on("click","img",function(a){a.stopPropagation()});c(j.body).prepend(c(e)); p=j.documentElement});c.fn.photobox=function(a,b,g){"string"!=typeof a&&(a="a");b=c.extend({},ca,b||{});a=new E(b,this,a);a.callback=g;w.push(a);D.load();return this};E=function(a,b,g){this.options=c.extend({},a);this.target=g;this.selector=c(b||j);this.thumbsList=null;a=this.imageLinksFilter(b.find(g));this.imageLinks=a[0];this.images=a[1];this.init()};var V=u.MutationObserver||u.WebKitMutationObserver,da=u.addEventListener;E.prototype={init:function(){var a=this;this.selector.data("_photobox",this); this.options.thumbs&&(this.thumbsList=n.generate(this.imageLinks));this.selector.on("click.photobox",this.target,function(b){b.preventDefault();a.open(this)});this.observerTimeout=null;1==this.selector[0].nodeType&&this.observeDOM(this.selector[0],function(){clearTimeout(this.observerTimeout);this.observerTimeout=setTimeout(function(){var b=a.imageLinksFilter(a.selector.find(a.target));a.imageLinks=b[0];a.images=b[1];a.thumbsList=n.generate(a.imageLinks)},50)})},open:function(a){a=c.inArray(a,this.imageLinks); if(-1==a)return!1;d=this.options;l=this.images;J=this;this.setup(1);return C(a,!0)},imageLinksFilter:function(a){var b=[];return[a.filter(function(){var a=this.firstElementChild||this.children[0];if(!a||!a.tagName||"img"!=a.tagName.toLowerCase())return!1;b.push([this.href,a.getAttribute("alt")||a.getAttribute("title")]);return!0}),b]},observeDOM:function(a,b){V?(new V(function(a){(a[0].addedNodes.length||a[0].removedNodes.length)&&b()})).observe(a,{childList:!0,subtree:!0}):da&&(a.addEventListener("DOMNodeInserted", b,!1),a.addEventListener("DOMNodeRemoved",b,!1))},setup:function(a){var b=a?"on":"off";a?(f[0].src=S,f.css({transition:"0s"}).removeAttr("style"),e.show(),k.html(this.thumbsList),e[d.thumbs?"addClass":"removeClass"]("thumbs"),d.thumbs&&(q.removeAttr("class"),c(u).on("resize.photobox",n.calc),n.calc()),2>this.images.length?e.removeClass("thumbs hasArrows hasCounter hasAutoplay"):(e.addClass("hasArrows hasCounter"),1E3<d.time?(e.addClass("hasAutoplay"),d.autoplay?h.progress.start():h.pause()):e.removeClass("hasAutoplay")), e.on(t,function(){e.off(t).addClass("on")}).addClass("show"),r&&e.trigger("MSTransitionEnd")):c(u).off("resize.photobox");d.hideFlash&&c.each(["object","embed"],function(b,d){c(d).each(function(){a&&(this._photobox=this.style.visibility);this.style.visibility=a?"hidden":this._photobox})});c(j)[b]({"keydown.photobox":Y,"mousewheel.photobox":Z})}};n={generate:function(a){var b=c("<ul>"),d,e=[],f,h;for(f=a.toArray().length;f--;)d=a[f],h=d.children[0].title||d.children[0].alt||"",e.push('<li><a href="'+ d.href+'"><img src="'+d.children[0].src+'" alt="" title="'+h+'" /></a></li>');b.html(e.reverse().join(""));return b},click:function(a){a.preventDefault();q.removeClass("active");q=c(this).parent().addClass("active");a=c(this.parentNode).index();return C(a,0,1)},changeActiveTimeout:null,changeActive:function(a,b,c){q.index();q.removeClass("active");q=k.find("li").eq(a).addClass("active");c||(clearTimeout(this.changeActiveTimeout),this.changeActiveTimeout=setTimeout(function(){var a=q[0].offsetLeft+ q[0].clientWidth/2-p.clientWidth/2;b&&k.delay(800);!b&&k.stop();k.animate({scrollLeft:a},500,"swing")},200))},calc:function(){L=k[0].clientWidth;M=k[0].firstChild.clientWidth;var a=M>L?"on":"off";!U&&k[a]("mousemove",n.move)},move:function(a){k[0].scrollLeft=a.pageX*(M/L)-500}};h={autoPlayTimer:!1,play:function(){h.autoPlayTimer=setTimeout(function(){C(y)},d.time);h.progress.start();m.removeClass("play");h.setTitle("Click to stop autoplay");d.autoplay=!0},pause:function(){clearTimeout(h.autoPlayTimer); h.progress.reset();m.addClass("play");h.setTitle("Click to resume autoplay");d.autoplay=!1},progress:{reset:function(){m.find("div").removeAttr("style");setTimeout(function(){m.removeClass("playing")},200)},start:function(){r||m.find("div").css(ba,d.time+"ms");m.addClass("playing")}},setTitle:function(a){a&&m.prop("title",a+" (every "+d.time/1E3+" seconds)")},toggle:function(a){a.stopPropagation();h[d.autoplay?"pause":"play"]()}};var D={save:function(){"pushState"in window.history&&(decodeURIComponent(window.location.hash.slice(1))!= v&&d.history)&&window.history.pushState("photobox",j.title+"-"+l[z][1],window.location.pathname+window.location.search+"#"+encodeURIComponent(v))},load:function(){if(d&&!d.history)return!1;var a=decodeURIComponent(window.location.hash.slice(1)),b,c;if(!a&&e.hasClass("show"))F();else for(b=0;b<w.length;b++)for(c in w[b].images)if(w[b].images[c][0]==a)return w[b].open(w[b].imageLinks[c]),!0},clear:function(){"pushState"in window.history&&window.history.pushState("photobox",j.title,window.location.pathname+ window.location.search)}},W=window.onpopstate;window.onpopstate=function(a){W&&W.apply(this,arguments);"photobox"==a.state&&D.load()};var x=["DOMMouseScroll","mousewheel"];if(c.event.fixHooks)for(var X=x.length;X;)c.event.fixHooks[x[--X]]=c.event.mouseHooks;c.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=x.length;a;)this.addEventListener(x[--a],K,!1);else this.onmousewheel=K},teardown:function(){if(this.removeEventListener)for(var a=x.length;a;)this.removeEventListener(x[--a], K,!1);else this.onmousewheel=null}};c.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);