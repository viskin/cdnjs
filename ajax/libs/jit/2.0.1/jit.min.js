!function(){this.$jit=function(w){w=w||window;for(var k in $jit)$jit[k].$extend&&(w[k]=$jit[k])},$jit.version="2.0.1";var $=function(d){return document.getElementById(d)};$.empty=function(){},$.extend=function(original,extended){for(var key in extended||{})original[key]=extended[key];return original},$.lambda=function(value){return"function"==typeof value?value:function(){return value}},$.time=Date.now||function(){return+new Date},$.splat=function(obj){var type=$.type(obj);return type?"array"!=type?[obj]:obj:[]},$.type=function(elem){var type=$.type.s.call(elem).match(/^\[object\s(.*)\]$/)[1].toLowerCase();return"object"!=type?type:elem&&elem.$$family?elem.$$family:elem&&9==elem.nodeType?"htmldocument":elem&&elem.nodeName&&1==elem.nodeType?"element":type},$.type.s=Object.prototype.toString,$.each=function(iterable,fn){var type=$.type(iterable);if("object"==type)for(var key in iterable)fn(iterable[key],key);else for(var i=0,l=iterable.length;l>i;i++)fn(iterable[i],i)},$.indexOf=function(array,item){if(array.indexOf)return array.indexOf(item);for(var i=0,l=array.length;l>i;i++)if(array[i]===item)return i;return-1},$.map=function(array,f){var ans=[];return $.each(array,function(elem,i){ans.push(f(elem,i))}),ans},$.reduce=function(array,f,opt){var l=array.length;if(0==l)return opt;for(var acum=3==arguments.length?opt:array[--l];l--;)acum=f(acum,array[l]);return acum},$.merge=function(){for(var mix={},i=0,l=arguments.length;l>i;i++){var object=arguments[i];if("object"==$.type(object))for(var key in object){var op=object[key],mp=mix[key];mix[key]=mp&&"object"==$.type(op)&&"object"==$.type(mp)?$.merge(mp,op):$.unlink(op)}}return mix},$.unlink=function(object){var unlinked;switch($.type(object)){case"object":unlinked={};for(var p in object)unlinked[p]=$.unlink(object[p]);break;case"array":unlinked=[];for(var i=0,l=object.length;l>i;i++)unlinked[i]=$.unlink(object[i]);break;default:return object}return unlinked},$.zip=function(){if(0===arguments.length)return[];for(var j=0,ans=[],l=arguments.length,ml=arguments[0].length;ml>j;j++){for(var i=0,row=[];l>i;i++)row.push(arguments[i][j]);ans.push(row)}return ans},$.rgbToHex=function(srcArray,array){if(srcArray.length<3)return null;if(4==srcArray.length&&0==srcArray[3]&&!array)return"transparent";for(var hex=[],i=0;3>i;i++){var bit=(srcArray[i]-0).toString(16);hex.push(1==bit.length?"0"+bit:bit)}return array?hex:"#"+hex.join("")},$.hexToRgb=function(hex){if(7!=hex.length){if(hex=hex.match(/^#?(\w{1,2})(\w{1,2})(\w{1,2})$/),hex.shift(),3!=hex.length)return null;for(var rgb=[],i=0;3>i;i++){var value=hex[i];1==value.length&&(value+=value),rgb.push(parseInt(value,16))}return rgb}return hex=parseInt(hex.slice(1),16),[hex>>16,hex>>8&255,255&hex]},$.destroy=function(elem){$.clean(elem),elem.parentNode&&elem.parentNode.removeChild(elem),elem.clearAttributes&&elem.clearAttributes()},$.clean=function(elem){for(var ch=elem.childNodes,i=0,l=ch.length;l>i;i++)$.destroy(ch[i])},$.addEvent=function(obj,type,fn){obj.addEventListener?obj.addEventListener(type,fn,!1):obj.attachEvent("on"+type,fn)},$.addEvents=function(obj,typeObj){for(var type in typeObj)$.addEvent(obj,type,typeObj[type])},$.hasClass=function(obj,klass){return(" "+obj.className+" ").indexOf(" "+klass+" ")>-1},$.addClass=function(obj,klass){$.hasClass(obj,klass)||(obj.className=obj.className+" "+klass)},$.removeClass=function(obj,klass){obj.className=obj.className.replace(new RegExp("(^|\\s)"+klass+"(?:\\s|$)"),"$1")},$.getPos=function(elem){function getOffsets(elem){for(var position={x:0,y:0};elem&&!isBody(elem);)position.x+=elem.offsetLeft,position.y+=elem.offsetTop,elem=elem.offsetParent;return position}function getScrolls(elem){for(var position={x:0,y:0};elem&&!isBody(elem);)position.x+=elem.scrollLeft,position.y+=elem.scrollTop,elem=elem.parentNode;return position}function isBody(element){return/^(?:body|html)$/i.test(element.tagName)}var offset=getOffsets(elem),scroll=getScrolls(elem);return{x:offset.x-scroll.x,y:offset.y-scroll.y}},$.getDir=function(elem){var element=document.getElementById(elem)||document.body;if(element.currentStyle)var dir=element.currentStyle.direction;else if(window.getComputedStyle)var dir=document.defaultView.getComputedStyle(element,null).getPropertyValue("direction");return dir},$.event={get:function(e,win){return win=win||window,e||win.event},getWheel:function(e){return e.wheelDelta?e.wheelDelta/120:-(e.detail||0)/3},isRightClick:function(e){return 3==e.which||2==e.button},getPos:function(e,win){win=win||window,e=e||win.event;var doc=win.document;doc=doc.documentElement||doc.body,e.touches&&e.touches.length&&(e=e.touches[0]);var page={x:e.pageX||e.clientX+doc.scrollLeft,y:e.pageY||e.clientY+doc.scrollTop};return page},stop:function(e){e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1}},$jit.util=$jit.id=$;var Class=function(properties){properties=properties||{};var klass=function(){for(var key in this)"function"!=typeof this[key]&&(this[key]=$.unlink(this[key]));if(this.constructor=klass,Class.prototyping)return this;var instance=this.initialize?this.initialize.apply(this,arguments):this;return this.$$family="class",instance};for(var mutator in Class.Mutators)properties[mutator]&&(properties=Class.Mutators[mutator](properties,properties[mutator]),delete properties[mutator]);return $.extend(klass,this),klass.constructor=Class,klass.prototype=properties,klass};Class.Mutators={Implements:function(self,klasses){return $.each($.splat(klasses),function(klass){Class.prototyping=klass;var instance="function"==typeof klass?new klass:klass;for(var prop in instance)prop in self||(self[prop]=instance[prop]);delete Class.prototyping}),self}},$.extend(Class,{inherit:function(object,properties){for(var key in properties){var override=properties[key],previous=object[key],type=$.type(override);previous&&"function"==type?override!=previous&&Class.override(object,key,override):object[key]="object"==type?$.merge(previous,override):override}return object},override:function(object,name,method){var parent=Class.prototyping;parent&&object[name]!=parent[name]&&(parent=null);var override=function(){var previous=this.parent;this.parent=parent?parent[name]:object[name];var value=method.apply(this,arguments);return this.parent=previous,value};object[name]=override}}),Class.prototype.implement=function(){var proto=this.prototype;return $.each(Array.prototype.slice.call(arguments||[]),function(properties){Class.inherit(proto,properties)}),this},$jit.Class=Class,$jit.json={prune:function(tree,maxLevel){this.each(tree,function(elem,i){i==maxLevel&&elem.children&&(delete elem.children,elem.children=[])})},getParent:function(tree,id){if(tree.id==id)return!1;var ch=tree.children;if(ch&&ch.length>0)for(var i=0;i<ch.length;i++){if(ch[i].id==id)return tree;var ans=this.getParent(ch[i],id);if(ans)return ans}return!1},getSubtree:function(tree,id){if(tree.id==id)return tree;for(var i=0,ch=tree.children;ch&&i<ch.length;i++){var t=this.getSubtree(ch[i],id);if(null!=t)return t}return null},eachLevel:function(tree,initLevel,toLevel,action){if(toLevel>=initLevel){if(action(tree,initLevel),!tree.children)return;for(var i=0,ch=tree.children;i<ch.length;i++)this.eachLevel(ch[i],initLevel+1,toLevel,action)}},each:function(tree,action){this.eachLevel(tree,0,Number.MAX_VALUE,action)}},$jit.Trans={$extend:!0,linear:function(p){return p}};var Trans=$jit.Trans;!function(){var makeTrans=function(transition,params){return params=$.splat(params),$.extend(transition,{easeIn:function(pos){return transition(pos,params)},easeOut:function(pos){return 1-transition(1-pos,params)},easeInOut:function(pos){return.5>=pos?transition(2*pos,params)/2:(2-transition(2*(1-pos),params))/2}})},transitions={Pow:function(p,x){return Math.pow(p,x[0]||6)},Expo:function(p){return Math.pow(2,8*(p-1))},Circ:function(p){return 1-Math.sin(Math.acos(p))},Sine:function(p){return 1-Math.sin((1-p)*Math.PI/2)},Back:function(p,x){return x=x[0]||1.618,Math.pow(p,2)*((x+1)*p-x)},Bounce:function(p){for(var value,a=0,b=1;1;a+=b,b/=2)if(p>=(7-4*a)/11){value=b*b-Math.pow((11-6*a-11*p)/4,2);break}return value},Elastic:function(p,x){return Math.pow(2,10*--p)*Math.cos(20*p*Math.PI*(x[0]||1)/3)}};$.each(transitions,function(val,key){Trans[key]=makeTrans(val)}),$.each(["Quad","Cubic","Quart","Quint"],function(elem,i){Trans[elem]=makeTrans(function(p){return Math.pow(p,[i+2])})})}();var Animation=new Class({initialize:function(options){this.setOptions(options)},setOptions:function(options){var opt={duration:2500,fps:40,transition:Trans.Quart.easeInOut,compute:$.empty,complete:$.empty,link:"ignore"};return this.opt=$.merge(opt,options||{}),this},step:function(){var time=$.time(),opt=this.opt;if(time<this.time+opt.duration){var delta=opt.transition((time-this.time)/opt.duration);opt.compute(delta)}else this.timer=clearInterval(this.timer),opt.compute(1),opt.complete()},start:function(){return this.check()?(this.time=0,this.startTimer(),this):this},startTimer:function(){var that=this,fps=this.opt.fps;return this.timer?!1:(this.time=$.time()-this.time,this.timer=setInterval(function(){that.step()},Math.round(1e3/fps)),!0)},pause:function(){return this.stopTimer(),this},resume:function(){return this.startTimer(),this},stopTimer:function(){return this.timer?(this.time=$.time()-this.time,this.timer=clearInterval(this.timer),!0):!1},check:function(){return this.timer?"cancel"==this.opt.link?(this.stopTimer(),!0):!1:!0}}),Options=function(){for(var args=arguments,i=0,l=args.length,ans={};l>i;i++){var opt=Options[args[i]];opt.$extend?$.extend(ans,opt):ans[args[i]]=opt}return ans};Options.AreaChart={$extend:!0,animate:!0,labelOffset:3,type:"stacked",Tips:{enable:!1,onShow:$.empty,onHide:$.empty},Events:{enable:!1,onClick:$.empty},selectOnHover:!0,showAggregates:!0,showLabels:!0,filterOnClick:!1,restoreOnRightClick:!1},Options.Margin={$extend:!1,top:0,left:0,right:0,bottom:0},Options.Canvas={$extend:!0,injectInto:"id",type:"2D",width:!1,height:!1,useCanvas:!1,withLabels:!0,background:!1,Scene:{Lighting:{enable:!1,ambient:[1,1,1],directional:{direction:{x:-100,y:-100,z:-100},color:[.5,.3,.1]}}}},Options.Tree={$extend:!0,orientation:"left",subtreeOffset:8,siblingOffset:5,indent:10,multitree:!1,align:"center",levelSpacing:"even"},Options.Node={$extend:!1,overridable:!1,type:"circle",color:"#ccb",alpha:1,dim:3,height:20,width:90,autoHeight:!1,autoWidth:!1,lineWidth:1,transform:!0,align:"center",angularWidth:1,span:1,CanvasStyles:{}},Options.Edge={$extend:!1,overridable:!1,type:"line",color:"#ccb",lineWidth:1,dim:15,alpha:1,epsilon:7,CanvasStyles:{}},Options.Fx={$extend:!0,fps:40,duration:2500,transition:$jit.Trans.Quart.easeInOut,clearCanvas:!0},Options.Label={$extend:!1,overridable:!1,type:"HTML",style:" ",size:10,family:"sans-serif",textAlign:"center",textBaseline:"alphabetic",color:"#fff"},Options.Tips={$extend:!1,enable:!1,type:"auto",offsetX:20,offsetY:20,force:!1,onShow:$.empty,onHide:$.empty},Options.NodeStyles={$extend:!1,enable:!1,type:"auto",stylesHover:!1,stylesClick:!1},Options.Events={$extend:!1,enable:!1,enableForEdges:!1,type:"auto",onClick:$.empty,onRightClick:$.empty,onMouseMove:$.empty,onMouseEnter:$.empty,onMouseLeave:$.empty,onDragStart:$.empty,onDragMove:$.empty,onDragCancel:$.empty,onDragEnd:$.empty,onTouchStart:$.empty,onTouchMove:$.empty,onTouchEnd:$.empty,onTouchCancel:$.empty,onMouseWheel:$.empty},Options.Navigation={$extend:!1,enable:!1,type:"auto",panning:!1,zooming:!1},Options.Controller={$extend:!0,onBeforeCompute:$.empty,onAfterCompute:$.empty,onCreateLabel:$.empty,onPlaceLabel:$.empty,onComplete:$.empty,onBeforePlotLine:$.empty,onAfterPlotLine:$.empty,onBeforePlotNode:$.empty,onAfterPlotNode:$.empty,onBeforeRemoveNode:$.empty,request:!1};var ExtrasInitializer={initialize:function(className,viz){this.viz=viz,this.canvas=viz.canvas,this.config=viz.config[className],this.nodeTypes=viz.fx.nodeTypes;var type=this.config.type;this.dom="auto"==type?"Native"!=viz.config.Label.type:"Native"!=type,this.labelContainer=this.dom&&viz.labels.getLabelContainer(),this.isEnabled()&&this.initializePost()},initializePost:$.empty,setAsProperty:$.lambda(!1),isEnabled:function(){return this.config.enable},isLabel:function(e,win,group){e=$.event.get(e,win);var labelContainer=this.labelContainer,target=e.target||e.srcElement,related=e.relatedTarget;return group?related&&related==this.viz.canvas.getCtx().canvas&&!!target&&this.isDescendantOf(target,labelContainer):this.isDescendantOf(target,labelContainer)},isDescendantOf:function(elem,par){for(;elem&&elem.parentNode;){if(elem.parentNode==par)return elem;elem=elem.parentNode}return!1}},EventsInterface={onMouseUp:$.empty,onMouseDown:$.empty,onMouseMove:$.empty,onMouseOver:$.empty,onMouseOut:$.empty,onMouseWheel:$.empty,onTouchStart:$.empty,onTouchMove:$.empty,onTouchEnd:$.empty,onTouchCancel:$.empty},MouseEventsManager=new Class({initialize:function(viz){this.viz=viz,this.canvas=viz.canvas,this.node=!1,this.edge=!1,this.registeredObjects=[],this.attachEvents()},attachEvents:function(){var htmlCanvas=this.canvas.getElement(),that=this;htmlCanvas.oncontextmenu=$.lambda(!1),$.addEvents(htmlCanvas,{mouseup:function(e,win){var event=$.event.get(e,win);that.handleEvent("MouseUp",e,win,that.makeEventObject(e,win),$.event.isRightClick(event))},mousedown:function(e,win){var event=$.event.get(e,win);that.handleEvent("MouseDown",e,win,that.makeEventObject(e,win),$.event.isRightClick(event))},mousemove:function(e,win){that.handleEvent("MouseMove",e,win,that.makeEventObject(e,win))},mouseover:function(e,win){that.handleEvent("MouseOver",e,win,that.makeEventObject(e,win))},mouseout:function(e,win){that.handleEvent("MouseOut",e,win,that.makeEventObject(e,win))},touchstart:function(e,win){that.handleEvent("TouchStart",e,win,that.makeEventObject(e,win))},touchmove:function(e,win){that.handleEvent("TouchMove",e,win,that.makeEventObject(e,win))},touchend:function(e,win){that.handleEvent("TouchEnd",e,win,that.makeEventObject(e,win))}});var handleMouseWheel=function(e,win){var event=$.event.get(e,win),wheel=$.event.getWheel(event);that.handleEvent("MouseWheel",e,win,wheel)};document.getBoxObjectFor||null!=window.mozInnerScreenX?htmlCanvas.addEventListener("DOMMouseScroll",handleMouseWheel,!1):$.addEvent(htmlCanvas,"mousewheel",handleMouseWheel)},register:function(obj){this.registeredObjects.push(obj)},handleEvent:function(){for(var args=Array.prototype.slice.call(arguments),type=args.shift(),i=0,regs=this.registeredObjects,l=regs.length;l>i;i++)regs[i]["on"+type].apply(regs[i],args)},makeEventObject:function(e,win){var that=this,graph=this.viz.graph,fx=this.viz.fx,ntypes=fx.nodeTypes,etypes=fx.edgeTypes;return{pos:!1,node:!1,edge:!1,contains:!1,getNodeCalled:!1,getEdgeCalled:!1,getPos:function(){var canvas=that.viz.canvas,s=canvas.getSize(),p=canvas.getPos(),ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,pos=$.event.getPos(e,win);return this.pos={x:1*(pos.x-p.x-s.width/2-ox)/sx,y:1*(pos.y-p.y-s.height/2-oy)/sy},this.pos},getNode:function(){if(this.getNodeCalled)return this.node;this.getNodeCalled=!0;for(var id in graph.nodes){var n=graph.nodes[id],geom=n&&ntypes[n.getData("type")],contains=geom&&geom.contains&&geom.contains.call(fx,n,this.getPos());if(contains)return this.contains=contains,that.node=this.node=n}return that.node=this.node=!1},getEdge:function(){if(this.getEdgeCalled)return this.edge;this.getEdgeCalled=!0;var hashset={};for(var id in graph.edges){var edgeFrom=graph.edges[id];hashset[id]=!0;for(var edgeId in edgeFrom)if(!(edgeId in hashset)){var e=edgeFrom[edgeId],geom=e&&etypes[e.getData("type")],contains=geom&&geom.contains&&geom.contains.call(fx,e,this.getPos());if(contains)return this.contains=contains,that.edge=this.edge=e}}return that.edge=this.edge=!1},getContains:function(){return this.getNodeCalled?this.contains:(this.getNode(),this.contains)}}}}),Extras={initializeExtras:function(){var mem=new MouseEventsManager(this),that=this;$.each(["NodeStyles","Tips","Navigation","Events"],function(k){var obj=new Extras.Classes[k](k,that);obj.isEnabled()&&mem.register(obj),obj.setAsProperty()&&(that[k.toLowerCase()]=obj)})}};Extras.Classes={},Extras.Classes.Events=new Class({Implements:[ExtrasInitializer,EventsInterface],initializePost:function(){this.fx=this.viz.fx,this.ntypes=this.viz.fx.nodeTypes,this.etypes=this.viz.fx.edgeTypes,this.hovered=!1,this.pressed=!1,this.touched=!1,this.touchMoved=!1,this.moved=!1},setAsProperty:$.lambda(!0),onMouseUp:function(e,win,event,isRightClick){var evt=$.event.get(e,win);this.moved||(isRightClick?this.config.onRightClick(this.hovered,event,evt):this.config.onClick(this.pressed,event,evt)),this.pressed&&(this.moved?this.config.onDragEnd(this.pressed,event,evt):this.config.onDragCancel(this.pressed,event,evt),this.pressed=this.moved=!1)},onMouseOut:function(e,win,event){var label,evt=$.event.get(e,win);if(this.dom&&(label=this.isLabel(e,win,!0)))return this.config.onMouseLeave(this.viz.graph.getNode(label.id),event,evt),void(this.hovered=!1);for(var rt=evt.relatedTarget,canvasWidget=this.canvas.getElement();rt&&rt.parentNode;){if(canvasWidget==rt.parentNode)return;rt=rt.parentNode}this.hovered&&(this.config.onMouseLeave(this.hovered,event,evt),this.hovered=!1)},onMouseOver:function(e,win,event){var label,evt=$.event.get(e,win);this.dom&&(label=this.isLabel(e,win,!0))&&(this.hovered=this.viz.graph.getNode(label.id),this.config.onMouseEnter(this.hovered,event,evt))},onMouseMove:function(e,win,event){var evt=$.event.get(e,win);if(this.pressed)return this.moved=!0,void this.config.onDragMove(this.pressed,event,evt);if(this.dom)this.config.onMouseMove(this.hovered,event,evt);else{if(this.hovered){var hn=this.hovered,geom=hn.nodeFrom?this.etypes[hn.getData("type")]:this.ntypes[hn.getData("type")],contains=geom&&geom.contains&&geom.contains.call(this.fx,hn,event.getPos());if(contains)return void this.config.onMouseMove(hn,event,evt);this.config.onMouseLeave(hn,event,evt),this.hovered=!1}(this.hovered=event.getNode()||this.config.enableForEdges&&event.getEdge())?this.config.onMouseEnter(this.hovered,event,evt):this.config.onMouseMove(!1,event,evt)}},onMouseWheel:function(e,win,delta){this.config.onMouseWheel(delta,$.event.get(e,win))},onMouseDown:function(e,win,event){var label,evt=$.event.get(e,win);this.dom?(label=this.isLabel(e,win))&&(this.pressed=this.viz.graph.getNode(label.id)):this.pressed=event.getNode()||this.config.enableForEdges&&event.getEdge(),this.pressed&&this.config.onDragStart(this.pressed,event,evt)},onTouchStart:function(e,win,event){var label,evt=$.event.get(e,win);this.touched=this.dom&&(label=this.isLabel(e,win))?this.viz.graph.getNode(label.id):event.getNode()||this.config.enableForEdges&&event.getEdge(),this.touched&&this.config.onTouchStart(this.touched,event,evt)},onTouchMove:function(e,win,event){var evt=$.event.get(e,win);this.touched&&(this.touchMoved=!0,this.config.onTouchMove(this.touched,event,evt))},onTouchEnd:function(e,win,event){var evt=$.event.get(e,win);this.touched&&(this.touchMoved?this.config.onTouchEnd(this.touched,event,evt):this.config.onTouchCancel(this.touched,event,evt),this.touched=this.touchMoved=!1)}}),Extras.Classes.Tips=new Class({Implements:[ExtrasInitializer,EventsInterface],initializePost:function(){if(document.body){var tip=$("_tooltip")||document.createElement("div");tip.id="_tooltip",tip.className="tip",$.extend(tip.style,{position:"absolute",display:"none",zIndex:13e3}),document.body.appendChild(tip),this.tip=tip,this.node=!1}},setAsProperty:$.lambda(!0),onMouseOut:function(e,win){$.event.get(e,win);if(this.dom&&this.isLabel(e,win,!0))return void this.hide(!0);for(var rt=e.relatedTarget,canvasWidget=this.canvas.getElement();rt&&rt.parentNode;){if(canvasWidget==rt.parentNode)return;rt=rt.parentNode}this.hide(!1)},onMouseOver:function(e,win){var label;this.dom&&(label=this.isLabel(e,win,!1))&&(this.node=this.viz.graph.getNode(label.id),this.config.onShow(this.tip,this.node,label))},onMouseMove:function(e,win,opt){if(this.dom&&this.isLabel(e,win)&&this.setTooltipPosition($.event.getPos(e,win)),!this.dom){var node=opt.getNode();if(!node)return void this.hide(!0);(this.config.force||!this.node||this.node.id!=node.id)&&(this.node=node,this.config.onShow(this.tip,node,opt.getContains())),this.setTooltipPosition($.event.getPos(e,win))}},setTooltipPosition:function(pos){var tip=this.tip,style=tip.style,cont=this.config;style.display="";var elem="CSS1Compat"===document.compatMode&&document.documentElement||document.body||document.documentElement,view={width:elem.clientWidth,height:elem.clientHeight,x:window.pageXOffset||document.documentElement&&document.documentElement.scrollLeft||document.body&&document.body.scrollLeft||0,y:window.pageYOffset||document.documentElement&&document.documentElement.scrollTop||document.body&&document.body.scrollTop||0},obj={width:tip.offsetWidth,height:tip.offsetHeight},x=cont.offsetX,y=cont.offsetY;style.top=(pos.y+obj.height+y>view.height+view.y?pos.y-obj.height-y:pos.y+y)+"px",style.left=(pos.x+obj.width+x>view.width+view.x?pos.x-obj.width-x:pos.x+x)+"px"},hide:function(triggerCallback){this.tip.style.display="none",triggerCallback&&this.config.onHide()}}),Extras.Classes.NodeStyles=new Class({Implements:[ExtrasInitializer,EventsInterface],initializePost:function(){this.fx=this.viz.fx,this.types=this.viz.fx.nodeTypes,this.nStyles=this.config,this.nodeStylesOnHover=this.nStyles.stylesHover,this.nodeStylesOnClick=this.nStyles.stylesClick,this.hoveredNode=!1,this.fx.nodeFxAnimation=new Animation,this.down=!1,this.move=!1},onMouseOut:function(e,win){if(this.down=this.move=!1,this.hoveredNode){this.dom&&this.isLabel(e,win,!0)&&this.toggleStylesOnHover(this.hoveredNode,!1);for(var rt=e.relatedTarget,canvasWidget=this.canvas.getElement();rt&&rt.parentNode;){if(canvasWidget==rt.parentNode)return;rt=rt.parentNode}this.toggleStylesOnHover(this.hoveredNode,!1),this.hoveredNode=!1}},onMouseOver:function(e,win){var label;if(this.dom&&(label=this.isLabel(e,win,!0))){var node=this.viz.graph.getNode(label.id);if(node.selected)return;this.hoveredNode=node,this.toggleStylesOnHover(this.hoveredNode,!0)}},onMouseDown:function(e,win,event,isRightClick){if(!isRightClick){var label;this.dom&&(label=this.isLabel(e,win))?this.down=this.viz.graph.getNode(label.id):this.dom||(this.down=event.getNode()),this.move=!1}},onMouseUp:function(e,win,event,isRightClick){isRightClick||(this.move||this.onClick(event.getNode()),this.down=this.move=!1)},getRestoredStyles:function(node,type){var restoredStyles={},nStyles=this["nodeStylesOn"+type];for(var prop in nStyles)restoredStyles[prop]=node.styles["$"+prop];return restoredStyles},toggleStylesOnHover:function(node,set){this.nodeStylesOnHover&&this.toggleStylesOn("Hover",node,set)},toggleStylesOnClick:function(node,set){this.nodeStylesOnClick&&this.toggleStylesOn("Click",node,set)},toggleStylesOn:function(type,node,set){{var viz=this.viz;this.nStyles}if(set){var that=this;node.styles||(node.styles=$.merge(node.data,{}));for(var s in this["nodeStylesOn"+type]){var $s="$"+s;$s in node.styles||(node.styles[$s]=node.getData(s))}viz.fx.nodeFx($.extend({elements:{id:node.id,properties:that["nodeStylesOn"+type]},transition:Trans.Quart.easeOut,duration:300,fps:40},this.config))}else{var restoredStyles=this.getRestoredStyles(node,type);viz.fx.nodeFx($.extend({elements:{id:node.id,properties:restoredStyles},transition:Trans.Quart.easeOut,duration:300,fps:40},this.config))}},onClick:function(node){if(node){var nStyles=this.nodeStylesOnClick;nStyles&&(node.selected?(this.toggleStylesOnClick(node,!1),delete node.selected):(this.viz.graph.eachNode(function(n){if(n.selected){for(var s in nStyles)n.setData(s,n.styles["$"+s],"end");delete n.selected}}),this.toggleStylesOnClick(node,!0),node.selected=!0,delete node.hovered,this.hoveredNode=!1))}},onMouseMove:function(e,win,event){if(this.down&&(this.move=!0),!this.dom||!this.isLabel(e,win)){var nStyles=this.nodeStylesOnHover;if(nStyles&&!this.dom){if(this.hoveredNode){var geom=this.types[this.hoveredNode.getData("type")],contains=geom&&geom.contains&&geom.contains.call(this.fx,this.hoveredNode,event.getPos());if(contains)return}var node=event.getNode();if(!this.hoveredNode&&!node)return;if(node.hovered)return;node&&!node.selected?(this.fx.nodeFxAnimation.stopTimer(),this.viz.graph.eachNode(function(n){if(n.hovered&&!n.selected){for(var s in nStyles)n.setData(s,n.styles["$"+s],"end");delete n.hovered}}),node.hovered=!0,this.hoveredNode=node,this.toggleStylesOnHover(node,!0)):this.hoveredNode&&!this.hoveredNode.selected&&(this.fx.nodeFxAnimation.stopTimer(),this.toggleStylesOnHover(this.hoveredNode,!1),delete this.hoveredNode.hovered,this.hoveredNode=!1)}}}}),Extras.Classes.Navigation=new Class({Implements:[ExtrasInitializer,EventsInterface],initializePost:function(){this.pos=!1,this.pressed=!1},onMouseWheel:function(e,win,scroll){if(this.config.zooming){$.event.stop($.event.get(e,win));var val=this.config.zooming/1e3,ans=1+scroll*val;this.canvas.scale(ans,ans)}},onMouseDown:function(e,win,eventInfo){if(this.config.panning&&(e.preventDefault?e.preventDefault():e.returnValue=!1,$.addClass(this.canvas.getElement(),"grabbing"),"avoid nodes"!=this.config.panning||!(this.dom?this.isLabel(e,win):eventInfo.getNode()||eventInfo.getEdge()))){this.pressed=!0,this.pos=eventInfo.getPos();var canvas=this.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY;this.pos.x*=sx,this.pos.x+=ox,this.pos.y*=sy,this.pos.y+=oy}},onMouseMove:function(e,win,eventInfo){if(this.config.panning&&this.pressed&&("avoid nodes"!=this.config.panning||(this.dom?!this.isLabel(e,win):!eventInfo.getNode()))){var thispos=this.pos,currentPos=eventInfo.getPos(),canvas=this.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY;currentPos.x*=sx,currentPos.y*=sy,currentPos.x+=ox,currentPos.y+=oy;var x=currentPos.x-thispos.x,y=currentPos.y-thispos.y;this.pos=currentPos,this.canvas.translate(1*x/sx,1*y/sy)}},onMouseUp:function(e,win,eventInfo,isRightClick){this.config.panning&&($.removeClass(this.canvas.getElement(),"grabbing"),this.pressed=!1)}});var Canvas;!function(){function $E(tag,props){var elem=document.createElement(tag);for(var p in props)"object"==typeof props[p]?$.extend(elem[p],props[p]):elem[p]=props[p];return"canvas"==tag&&!supportsCanvas&&G_vmlCanvasManager&&(elem=G_vmlCanvasManager.initElement(document.body.appendChild(elem))),elem}var canvasType=typeof HTMLCanvasElement,supportsCanvas="object"==canvasType||"function"==canvasType;$jit.Canvas=Canvas=new Class({canvases:[],pos:!1,element:!1,labelContainer:!1,translateOffsetX:0,translateOffsetY:0,scaleOffsetX:1,scaleOffsetY:1,initialize:function(viz,opt){this.viz=viz,this.opt=this.config=opt;var id="string"==$.type(opt.injectInto)?opt.injectInto:opt.injectInto.id,type=opt.type,idLabel=id+"-label",wrapper=$(id),width=opt.width||wrapper.offsetWidth,height=opt.height||wrapper.offsetHeight;this.id=id;var canvasOptions={injectInto:id,width:width,height:height};this.element=$E("div",{id:id+"-canvaswidget",style:{position:"relative",width:width+"px",height:height+"px"}}),this.labelContainer=this.createLabelContainer(opt.Label.type,idLabel,canvasOptions),this.canvases.push(new Canvas.Base[type]({config:$.extend({idSuffix:"-canvas"},canvasOptions),plot:function(base){viz.fx.plot()},resize:function(){viz.refresh()}}));var back=opt.background;if(back){var backCanvas=new Canvas.Background[back.type](viz,$.extend(back,canvasOptions));this.canvases.push(new Canvas.Base[type](backCanvas))}for(var len=this.canvases.length;len--;)this.element.appendChild(this.canvases[len].canvas),len>0&&this.canvases[len].plot();this.element.appendChild(this.labelContainer),wrapper.appendChild(this.element);var timer=null,that=this;$.addEvent(window,"scroll",function(){clearTimeout(timer),timer=setTimeout(function(){that.getPos(!0)},500)})},getCtx:function(i){return this.canvases[i||0].getCtx()},getConfig:function(){return this.opt},getElement:function(){return this.element},getSize:function(i){return this.canvases[i||0].getSize()},resize:function(width,height){this.getPos(!0),this.translateOffsetX=this.translateOffsetY=0,this.scaleOffsetX=this.scaleOffsetY=1;for(var i=0,l=this.canvases.length;l>i;i++)this.canvases[i].resize(width,height);var style=this.element.style;style.width=width+"px",style.height=height+"px",this.labelContainer&&(this.labelContainer.style.width=width+"px")},translate:function(x,y,disablePlot){this.translateOffsetX+=x*this.scaleOffsetX,this.translateOffsetY+=y*this.scaleOffsetY;for(var i=0,l=this.canvases.length;l>i;i++)this.canvases[i].translate(x,y,disablePlot)},scale:function(x,y,disablePlot){var px=this.scaleOffsetX*x,py=this.scaleOffsetY*y,dx=this.translateOffsetX*(x-1)/px,dy=this.translateOffsetY*(y-1)/py;this.scaleOffsetX=px,this.scaleOffsetY=py;for(var i=0,l=this.canvases.length;l>i;i++)this.canvases[i].scale(x,y,!0);this.translate(dx,dy,!1)},getZoom:function(){return new Complex(this.scaleOffsetX,this.scaleOffsetY)},setZoom:function(x,y,disablePlot){var cur=this.getZoom(),px=x/cur.x,py=y/cur.y;this.scale(px,py,disablePlot)},getPos:function(force){return force||!this.pos?this.pos=$.getPos(this.getElement()):this.pos},clear:function(i){this.canvases[i||0].clear()},path:function(type,action){var ctx=this.canvases[0].getCtx();ctx.beginPath(),action(ctx),ctx[type](),ctx.closePath()},createLabelContainer:function(type,idLabel,dim){var NS="http://www.w3.org/2000/svg";if("HTML"==type||"Native"==type)return $E("div",{id:idLabel,style:{overflow:"visible",position:"absolute",top:0,left:0,width:dim.width+"px",height:0}});if("SVG"==type){var svgContainer=document.createElementNS(NS,"svg:svg");svgContainer.setAttribute("width",dim.width),svgContainer.setAttribute("height",dim.height);var style=svgContainer.style;style.position="absolute",style.left=style.top="0px";var labelContainer=document.createElementNS(NS,"svg:g");return labelContainer.setAttribute("width",dim.width),labelContainer.setAttribute("height",dim.height),labelContainer.setAttribute("x",0),labelContainer.setAttribute("y",0),labelContainer.setAttribute("id",idLabel),svgContainer.appendChild(labelContainer),svgContainer}}}),Canvas.Base={},Canvas.Base["2D"]=new Class({translateOffsetX:0,translateOffsetY:0,scaleOffsetX:1,scaleOffsetY:1,initialize:function(viz){this.viz=viz,this.opt=viz.config,this.size=!1,this.createCanvas(),this.translateToCenter()},createCanvas:function(){var opt=this.opt,width=opt.width,height=opt.height;this.canvas=$E("canvas",{id:opt.injectInto+opt.idSuffix,width:width,height:height,style:{position:"absolute",top:0,left:0,width:width+"px",height:height+"px"}})},getCtx:function(){return this.ctx?this.ctx:this.ctx=this.canvas.getContext("2d")},getSize:function(){if(this.size)return this.size;var canvas=this.canvas;return this.size={width:canvas.width,height:canvas.height}},translateToCenter:function(ps){var size=this.getSize(),width=ps?size.width-ps.width-2*this.translateOffsetX:size.width;height=ps?size.height-ps.height-2*this.translateOffsetY:size.height;var ctx=this.getCtx();ps&&ctx.scale(1/this.scaleOffsetX,1/this.scaleOffsetY),ctx.translate(width/2,height/2)},resize:function(width,height){var size=this.getSize(),canvas=this.canvas,styles=canvas.style;this.size=!1,canvas.width=width,canvas.height=height,styles.width=width+"px",styles.height=height+"px",supportsCanvas?this.translateToCenter():this.translateToCenter(size),this.translateOffsetX=this.translateOffsetY=0,this.scaleOffsetX=this.scaleOffsetY=1,this.clear(),this.viz.resize(width,height,this)},translate:function(x,y,disablePlot){var sx=this.scaleOffsetX,sy=this.scaleOffsetY;this.translateOffsetX+=x*sx,this.translateOffsetY+=y*sy,this.getCtx().translate(x,y),!disablePlot&&this.plot()},scale:function(x,y,disablePlot){this.scaleOffsetX*=x,this.scaleOffsetY*=y,this.getCtx().scale(x,y),!disablePlot&&this.plot()},clear:function(){
var size=this.getSize(),ox=this.translateOffsetX,oy=this.translateOffsetY,sx=this.scaleOffsetX,sy=this.scaleOffsetY;this.getCtx().clearRect(1*(-size.width/2-ox)/sx,1*(-size.height/2-oy)/sy,1*size.width/sx,1*size.height/sy)},plot:function(){this.clear(),this.viz.plot(this)}}),Canvas.Background={},Canvas.Background.Circles=new Class({initialize:function(viz,options){this.viz=viz,this.config=$.merge({idSuffix:"-bkcanvas",levelDistance:100,numberOfCircles:6,CanvasStyles:{},offset:0},options)},resize:function(width,height,base){this.plot(base)},plot:function(base){var ctx=(base.canvas,base.getCtx()),conf=this.config,styles=conf.CanvasStyles;for(var s in styles)ctx[s]=styles[s];for(var n=conf.numberOfCircles,rho=conf.levelDistance,i=1;n>=i;i++)ctx.beginPath(),ctx.arc(0,0,rho*i,0,2*Math.PI,!1),ctx.stroke(),ctx.closePath()}})}();var Polar=function(theta,rho){this.theta=theta||0,this.rho=rho||0};$jit.Polar=Polar,Polar.prototype={getc:function(simple){return this.toComplex(simple)},getp:function(){return this},set:function(v){v=v.getp(),this.theta=v.theta,this.rho=v.rho},setc:function(x,y){this.rho=Math.sqrt(x*x+y*y),this.theta=Math.atan2(y,x),this.theta<0&&(this.theta+=2*Math.PI)},setp:function(theta,rho){this.theta=theta,this.rho=rho},clone:function(){return new Polar(this.theta,this.rho)},toComplex:function(simple){var x=Math.cos(this.theta)*this.rho,y=Math.sin(this.theta)*this.rho;return simple?{x:x,y:y}:new Complex(x,y)},add:function(polar){return new Polar(this.theta+polar.theta,this.rho+polar.rho)},scale:function(number){return new Polar(this.theta,this.rho*number)},equals:function(c){return this.theta==c.theta&&this.rho==c.rho},$add:function(polar){return this.theta=this.theta+polar.theta,this.rho+=polar.rho,this},$madd:function(polar){return this.theta=(this.theta+polar.theta)%(2*Math.PI),this.rho+=polar.rho,this},$scale:function(number){return this.rho*=number,this},isZero:function(){var almostZero=1e-4,abs=Math.abs;return abs(this.theta)<almostZero&&abs(this.rho)<almostZero},interpolate:function(elem,delta){var sum,pi=Math.PI,pi2=2*pi,ch=function(t){var a=0>t?t%pi2+pi2:t%pi2;return a},tt=this.theta,et=elem.theta,diff=Math.abs(tt-et);sum=ch(diff==pi?tt>et?et+(tt-pi2-et)*delta:et-pi2+(tt-et)*delta:diff>=pi?tt>et?et+(tt-pi2-et)*delta:et-pi2+(tt-(et-pi2))*delta:et+(tt-et)*delta);var r=(this.rho-elem.rho)*delta+elem.rho;return{theta:sum,rho:r}}};var $P=function(a,b){return new Polar(a,b)};Polar.KER=$P(0,0);var Complex=function(x,y){this.x=x||0,this.y=y||0};$jit.Complex=Complex,Complex.prototype={getc:function(){return this},getp:function(simple){return this.toPolar(simple)},set:function(c){c=c.getc(!0),this.x=c.x,this.y=c.y},setc:function(x,y){this.x=x,this.y=y},setp:function(theta,rho){this.x=Math.cos(theta)*rho,this.y=Math.sin(theta)*rho},clone:function(){return new Complex(this.x,this.y)},toPolar:function(simple){var rho=this.norm(),atan=Math.atan2(this.y,this.x);return 0>atan&&(atan+=2*Math.PI),simple?{theta:atan,rho:rho}:new Polar(atan,rho)},norm:function(){return Math.sqrt(this.squaredNorm())},squaredNorm:function(){return this.x*this.x+this.y*this.y},add:function(pos){return new Complex(this.x+pos.x,this.y+pos.y)},prod:function(pos){return new Complex(this.x*pos.x-this.y*pos.y,this.y*pos.x+this.x*pos.y)},conjugate:function(){return new Complex(this.x,-this.y)},scale:function(factor){return new Complex(this.x*factor,this.y*factor)},equals:function(c){return this.x==c.x&&this.y==c.y},$add:function(pos){return this.x+=pos.x,this.y+=pos.y,this},$prod:function(pos){var x=this.x,y=this.y;return this.x=x*pos.x-y*pos.y,this.y=y*pos.x+x*pos.y,this},$conjugate:function(){return this.y=-this.y,this},$scale:function(factor){return this.x*=factor,this.y*=factor,this},$div:function(pos){var x=this.x,y=this.y,sq=pos.squaredNorm();return this.x=x*pos.x+y*pos.y,this.y=y*pos.x-x*pos.y,this.$scale(1/sq)},isZero:function(){var almostZero=1e-4,abs=Math.abs;return abs(this.x)<almostZero&&abs(this.y)<almostZero}};var $C=function(a,b){return new Complex(a,b)};Complex.KER=$C(0,0),Complex.IM=$C(0,1),$jit.Graph=new Class({initialize:function(opt,Node,Edge,Label){var innerOptions={klass:Complex,Node:{}};this.Node=Node,this.Edge=Edge,this.Label=Label,this.opt=$.merge(innerOptions,opt||{}),this.nodes={},this.edges={};var that=this;this.nodeList={};for(var p in Accessors)that.nodeList[p]=function(p){return function(){var args=Array.prototype.slice.call(arguments);that.eachNode(function(n){n[p].apply(n,args)})}}(p)},getNode:function(id){return this.hasNode(id)?this.nodes[id]:!1},get:function(id){return this.getNode(id)},getByName:function(name){for(var id in this.nodes){var n=this.nodes[id];if(n.name==name)return n}return!1},getAdjacence:function(id,id2){return id in this.edges?this.edges[id][id2]:!1},addNode:function(obj){if(!this.nodes[obj.id]){var edges=this.edges[obj.id]={};this.nodes[obj.id]=new Graph.Node($.extend({id:obj.id,name:obj.name,data:$.merge(obj.data||{},{}),adjacencies:edges},this.opt.Node),this.opt.klass,this.Node,this.Edge,this.Label)}return this.nodes[obj.id]},addAdjacence:function(obj,obj2,data){if(this.hasNode(obj.id)||this.addNode(obj),this.hasNode(obj2.id)||this.addNode(obj2),obj=this.nodes[obj.id],obj2=this.nodes[obj2.id],!obj.adjacentTo(obj2)){var adjsObj=this.edges[obj.id]=this.edges[obj.id]||{},adjsObj2=this.edges[obj2.id]=this.edges[obj2.id]||{};return adjsObj[obj2.id]=adjsObj2[obj.id]=new Graph.Adjacence(obj,obj2,data,this.Edge,this.Label),adjsObj[obj2.id]}return this.edges[obj.id][obj2.id]},removeNode:function(id){if(this.hasNode(id)){delete this.nodes[id];var adjs=this.edges[id];for(var to in adjs)delete this.edges[to][id];delete this.edges[id]}},removeAdjacence:function(id1,id2){delete this.edges[id1][id2],delete this.edges[id2][id1]},hasNode:function(id){return id in this.nodes},empty:function(){this.nodes={},this.edges={}}});var Accessors,Graph=$jit.Graph;!function(){var getDataInternal=function(prefix,prop,type,force,prefixConfig){var data;type=type||"current",prefix="$"+(prefix?prefix+"-":""),"current"==type?data=this.data:"start"==type?data=this.startData:"end"==type&&(data=this.endData);var dollar=prefix+prop;return force?data[dollar]:this.Config.overridable?dollar in data?data[dollar]:dollar in this.data?this.data[dollar]:prefixConfig[prop]||0:prefixConfig[prop]||0},setDataInternal=function(prefix,prop,value,type){type=type||"current",prefix="$"+(prefix?prefix+"-":"");var data;"current"==type?data=this.data:"start"==type?data=this.startData:"end"==type&&(data=this.endData),data[prefix+prop]=value},removeDataInternal=function(prefix,properties){prefix="$"+(prefix?prefix+"-":"");var that=this;$.each(properties,function(prop){var pref=prefix+prop;delete that.data[pref],delete that.endData[pref],delete that.startData[pref]})};Accessors={getData:function(prop,type,force){return getDataInternal.call(this,"",prop,type,force,this.Config)},setData:function(prop,value,type){setDataInternal.call(this,"",prop,value,type)},setDataset:function(types,obj){types=$.splat(types);for(var attr in obj)for(var i=0,val=$.splat(obj[attr]),l=types.length;l>i;i++)this.setData(attr,val[i],types[i])},removeData:function(){removeDataInternal.call(this,"",Array.prototype.slice.call(arguments))},getCanvasStyle:function(prop,type,force){return getDataInternal.call(this,"canvas",prop,type,force,this.Config.CanvasStyles)},setCanvasStyle:function(prop,value,type){setDataInternal.call(this,"canvas",prop,value,type)},setCanvasStyles:function(types,obj){types=$.splat(types);for(var attr in obj)for(var i=0,val=$.splat(obj[attr]),l=types.length;l>i;i++)this.setCanvasStyle(attr,val[i],types[i])},removeCanvasStyle:function(){removeDataInternal.call(this,"canvas",Array.prototype.slice.call(arguments))},getLabelData:function(prop,type,force){return getDataInternal.call(this,"label",prop,type,force,this.Label)},setLabelData:function(prop,value,type){setDataInternal.call(this,"label",prop,value,type)},setLabelDataset:function(types,obj){types=$.splat(types);for(var attr in obj)for(var i=0,val=$.splat(obj[attr]),l=types.length;l>i;i++)this.setLabelData(attr,val[i],types[i])},removeLabelData:function(){removeDataInternal.call(this,"label",Array.prototype.slice.call(arguments))}}}(),Graph.Node=new Class({initialize:function(opt,klass,Node,Edge,Label){var innerOptions={id:"",name:"",data:{},startData:{},endData:{},adjacencies:{},selected:!1,drawn:!1,exist:!1,angleSpan:{begin:0,end:0},pos:new klass,startPos:new klass,endPos:new klass};$.extend(this,$.extend(innerOptions,opt)),this.Config=this.Node=Node,this.Edge=Edge,this.Label=Label},adjacentTo:function(node){return node.id in this.adjacencies},adjacentWithDirectionTo:function(node){var areNeighbors=node.id in this.adjacencies;if(!areNeighbors)return!1;var direction=this.adjacencies[node.id].data.$direction;return direction[0]===this.id},getAdjacency:function(id){return this.adjacencies[id]},getPos:function(type){return type=type||"current","current"==type?this.pos:"end"==type?this.endPos:"start"==type?this.startPos:void 0},setPos:function(value,type){type=type||"current";var pos;"current"==type?pos=this.pos:"end"==type?pos=this.endPos:"start"==type&&(pos=this.startPos),pos.set(value)}}),Graph.Node.implement(Accessors),Graph.Adjacence=new Class({initialize:function(nodeFrom,nodeTo,data,Edge,Label){this.nodeFrom=nodeFrom,this.nodeTo=nodeTo,this.data=data||{},this.startData={},this.endData={},this.Config=this.Edge=Edge,this.Label=Label}}),Graph.Adjacence.implement(Accessors),Graph.Util={filter:function(param){if(!param||"string"!=$.type(param))return function(){return!0};var props=param.split(" ");return function(elem){for(var i=0;i<props.length;i++)if(elem[props[i]])return!1;return!0}},getNode:function(graph,id){return graph.nodes[id]},eachNode:function(graph,action,flags){var filter=this.filter(flags);for(var i in graph.nodes)filter(graph.nodes[i])&&action(graph.nodes[i])},each:function(graph,action,flags){this.eachNode(graph,action,flags)},eachAdjacency:function(node,action,flags){var adj=node.adjacencies,filter=this.filter(flags);for(var id in adj){var a=adj[id];if(filter(a)){if(a.nodeFrom!=node){var tmp=a.nodeFrom;a.nodeFrom=a.nodeTo,a.nodeTo=tmp}action(a,id)}}},computeLevels:function(graph,id,startDepth,flags){startDepth=startDepth||0;var filter=this.filter(flags);this.eachNode(graph,function(elem){elem._flag=!1,elem._depth=-1},flags);var root=graph.getNode(id);root._depth=startDepth;for(var queue=[root];0!=queue.length;){var node=queue.pop();node._flag=!0,this.eachAdjacency(node,function(adj){var n=adj.nodeTo;0==n._flag&&filter(n)&&!adj._hiding&&(n._depth<0&&(n._depth=node._depth+1+startDepth),queue.unshift(n))},flags)}},eachBFS:function(graph,id,action,flags){var filter=this.filter(flags);this.clean(graph);for(var queue=[graph.getNode(id)];0!=queue.length;){var node=queue.pop();if(!node)return;node._flag=!0,action(node,node._depth),this.eachAdjacency(node,function(adj){var n=adj.nodeTo;0==n._flag&&filter(n)&&!adj._hiding&&(n._flag=!0,queue.unshift(n))},flags)}},eachLevel:function(node,levelBegin,levelEnd,action,flags){var d=node._depth,filter=this.filter(flags),that=this,shouldContinue=!0;levelEnd=levelEnd===!1?Number.MAX_VALUE-d:levelEnd,function loopLevel(node,levelBegin,levelEnd){if(shouldContinue){var ret,d=node._depth;d>=levelBegin&&levelEnd>=d&&filter(node)&&(ret=action(node,d)),"undefined"!=typeof ret&&(shouldContinue=ret),shouldContinue&&levelEnd>d&&that.eachAdjacency(node,function(adj){var n=adj.nodeTo;n._depth>d&&loopLevel(n,levelBegin,levelEnd)})}}(node,levelBegin+d,levelEnd+d)},eachSubgraph:function(node,action,flags){this.eachLevel(node,0,!1,action,flags)},eachSubnode:function(node,action,flags){this.eachLevel(node,1,1,action,flags)},anySubnode:function(node,cond,flags){var flag=!1;cond=cond||$.lambda(!0);var c="string"==$.type(cond)?function(n){return n[cond]}:cond;return this.eachSubnode(node,function(elem){c(elem)&&(flag=!0)},flags),flag},getSubnodes:function(node,level,flags){var ans=[];level=level||0;var levelStart,levelEnd;return"array"==$.type(level)?(levelStart=level[0],levelEnd=level[1]):(levelStart=level,levelEnd=Number.MAX_VALUE-node._depth),this.eachLevel(node,levelStart,levelEnd,function(n){ans.push(n)},flags),ans},getParents:function(node){var ans=[];return this.eachAdjacency(node,function(adj){var n=adj.nodeTo;n._depth<node._depth&&ans.push(n)}),ans},isDescendantOf:function(node,id){if(node.id==id)return!0;for(var pars=this.getParents(node),ans=!1,i=0;!ans&&i<pars.length;i++)ans=ans||this.isDescendantOf(pars[i],id);return ans},clean:function(graph){this.eachNode(graph,function(elem){elem._flag=!1})},getClosestNodeToOrigin:function(graph,prop,flags){return this.getClosestNodeToPos(graph,Polar.KER,prop,flags)},getClosestNodeToPos:function(graph,pos,prop,flags){var node=null;prop=prop||"current",pos=pos&&pos.getc(!0)||Complex.KER;var distance=function(a,b){var d1=a.x-b.x,d2=a.y-b.y;return d1*d1+d2*d2};return this.eachNode(graph,function(elem){node=null==node||distance(elem.getPos(prop).getc(!0),pos)<distance(node.getPos(prop).getc(!0),pos)?elem:node},flags),node}},$.each(["get","getNode","each","eachNode","computeLevels","eachBFS","clean","getClosestNodeToPos","getClosestNodeToOrigin"],function(m){Graph.prototype[m]=function(){return Graph.Util[m].apply(Graph.Util,[this].concat(Array.prototype.slice.call(arguments)))}}),$.each(["eachAdjacency","eachLevel","eachSubgraph","eachSubnode","anySubnode","getSubnodes","getParents","isDescendantOf"],function(m){Graph.Node.prototype[m]=function(){return Graph.Util[m].apply(Graph.Util,[this].concat(Array.prototype.slice.call(arguments)))}}),Graph.Op={options:{type:"nothing",duration:2e3,hideLabels:!0,fps:30},initialize:function(viz){this.viz=viz},removeNode:function(node,opt){var i,that,nodeObj,viz=this.viz,options=$.merge(this.options,viz.controller,opt),n=$.splat(node);switch(options.type){case"nothing":for(i=0;i<n.length;i++)options.onBeforeRemoveNode(viz.graph.getNode(n[i])),viz.graph.removeNode(n[i]);break;case"replot":this.removeNode(n,{type:"nothing"}),viz.labels.clearLabels(),viz.refresh(!0);break;case"fade:seq":case"fade":for(that=this,i=0;i<n.length;i++)nodeObj=viz.graph.getNode(n[i]),nodeObj.setData("alpha",0,"end");viz.fx.animate($.merge(options,{modes:["node-property:alpha"],onComplete:function(){that.removeNode(n,{type:"nothing"}),viz.labels.clearLabels(),viz.reposition(),viz.fx.animate($.merge(options,{modes:["linear"]}))}}));break;case"fade:con":for(that=this,i=0;i<n.length;i++)nodeObj=viz.graph.getNode(n[i]),nodeObj.setData("alpha",0,"end"),nodeObj.ignore=!0;viz.reposition(),viz.fx.animate($.merge(options,{modes:["node-property:alpha","linear"],onComplete:function(){that.removeNode(n,{type:"nothing"}),options.onComplete&&options.onComplete()}}));break;case"iter":that=this,viz.fx.sequence({condition:function(){return 0!=n.length},step:function(){that.removeNode(n.shift(),{type:"nothing"}),viz.labels.clearLabels()},onComplete:function(){options.onComplete&&options.onComplete()},duration:Math.ceil(options.duration/n.length)});break;default:this.doError()}},removeEdge:function(vertex,opt){var i,that,adj,viz=this.viz,options=$.merge(this.options,viz.controller,opt),v="string"==$.type(vertex[0])?[vertex]:vertex;switch(options.type){case"nothing":for(i=0;i<v.length;i++)viz.graph.removeAdjacence(v[i][0],v[i][1]);break;case"replot":this.removeEdge(v,{type:"nothing"}),viz.refresh(!0);break;case"fade:seq":case"fade":for(that=this,i=0;i<v.length;i++)adj=viz.graph.getAdjacence(v[i][0],v[i][1]),adj&&adj.setData("alpha",0,"end");viz.fx.animate($.merge(options,{modes:["edge-property:alpha"],onComplete:function(){that.removeEdge(v,{type:"nothing"}),viz.reposition(),viz.fx.animate($.merge(options,{modes:["linear"]}))}}));break;case"fade:con":for(that=this,i=0;i<v.length;i++)adj=viz.graph.getAdjacence(v[i][0],v[i][1]),adj&&(adj.setData("alpha",0,"end"),adj.ignore=!0);viz.reposition(),viz.fx.animate($.merge(options,{modes:["edge-property:alpha","linear"],onComplete:function(){that.removeEdge(v,{type:"nothing"}),options.onComplete&&options.onComplete()}}));break;case"iter":that=this,viz.fx.sequence({condition:function(){return 0!=v.length},step:function(){that.removeEdge(v.shift(),{type:"nothing"}),viz.labels.clearLabels()},onComplete:function(){options.onComplete()},duration:Math.ceil(options.duration/v.length)});break;default:this.doError()}},sum:function(json,opt){var graph,viz=this.viz,options=$.merge(this.options,viz.controller,opt),root=viz.root;switch(viz.root=opt.id||viz.root,options.type){case"nothing":graph=viz.construct(json),graph.eachNode(function(elem){elem.eachAdjacency(function(adj){viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data)})});break;case"replot":viz.refresh(!0),this.sum(json,{type:"nothing"}),viz.refresh(!0);break;case"fade:seq":case"fade":case"fade:con":that=this,graph=viz.construct(json);var fadeEdges=this.preprocessSum(graph),modes=fadeEdges?["node-property:alpha","edge-property:alpha"]:["node-property:alpha"];viz.reposition(),"fade:con"!=options.type?viz.fx.animate($.merge(options,{modes:["linear"],onComplete:function(){viz.fx.animate($.merge(options,{modes:modes,onComplete:function(){options.onComplete()}}))}})):(viz.graph.eachNode(function(elem){elem.id!=root&&elem.pos.isZero()&&(elem.pos.set(elem.endPos),elem.startPos.set(elem.endPos))}),viz.fx.animate($.merge(options,{modes:["linear"].concat(modes)})));break;default:this.doError()}},morph:function(json,opt,extraModes){extraModes=extraModes||{};var graph,viz=this.viz,options=$.merge(this.options,viz.controller,opt),root=viz.root;switch(viz.root=opt.id||viz.root,options.type){case"nothing":graph=viz.construct(json),graph.eachNode(function(elem){var nodeExists=viz.graph.hasNode(elem.id);if(elem.eachAdjacency(function(adj){var adjExists=!!viz.graph.getAdjacence(adj.nodeFrom.id,adj.nodeTo.id);if(viz.graph.addAdjacence(adj.nodeFrom,adj.nodeTo,adj.data),adjExists){var addedAdj=viz.graph.getAdjacence(adj.nodeFrom.id,adj.nodeTo.id);for(var prop in adj.data||{})addedAdj.data[prop]=adj.data[prop]}}),nodeExists){var addedNode=viz.graph.getNode(elem.id);for(var prop in elem.data||{})addedNode.data[prop]=elem.data[prop]}}),viz.graph.eachNode(function(elem){elem.eachAdjacency(function(adj){graph.getAdjacence(adj.nodeFrom.id,adj.nodeTo.id)||viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id)}),graph.hasNode(elem.id)||viz.graph.removeNode(elem.id)});break;case"replot":viz.labels.clearLabels(!0),this.morph(json,{type:"nothing"}),viz.refresh(!0),viz.refresh(!0);break;case"fade:seq":case"fade":case"fade:con":that=this,graph=viz.construct(json);var nodeModes="node-property"in extraModes&&$.map($.splat(extraModes["node-property"]),function(n){return"$"+n});viz.graph.eachNode(function(elem){var graphNode=graph.getNode(elem.id);if(graphNode){var graphNodeData=graphNode.data;for(var prop in graphNodeData)nodeModes&&$.indexOf(nodeModes,prop)>-1?elem.endData[prop]=graphNodeData[prop]:elem.data[prop]=graphNodeData[prop]}else elem.setData("alpha",1),elem.setData("alpha",1,"start"),elem.setData("alpha",0,"end"),elem.ignore=!0}),viz.graph.eachNode(function(elem){elem.ignore||elem.eachAdjacency(function(adj){if(!adj.nodeFrom.ignore&&!adj.nodeTo.ignore){var nodeFrom=graph.getNode(adj.nodeFrom.id),nodeTo=graph.getNode(adj.nodeTo.id);if(nodeFrom.adjacentTo(nodeTo))adj.data.$direction&&adj.data.$direction[0]===nodeFrom.id&&(nodeFrom.adjacentWithDirectionTo(nodeTo)||(adj._reversing=!0));else{var adj=viz.graph.getAdjacence(nodeFrom.id,nodeTo.id);fadeEdges=!0,adj.setData("alpha",1),adj.setData("alpha",1,"start"),adj.setData("alpha",0,"end"),adj._hiding=!0}}})});var fadeEdges=this.preprocessSum(graph),modes=fadeEdges?["node-property:alpha","edge-property:alpha"]:["node-property:alpha"];modes[0]=modes[0]+("node-property"in extraModes?":"+$.splat(extraModes["node-property"]).join(":"):""),modes[1]=(modes[1]||"edge-property:alpha")+("edge-property"in extraModes?":"+$.splat(extraModes["edge-property"]).join(":"):""),"label-property"in extraModes&&modes.push("label-property:"+$.splat(extraModes["label-property"]).join(":")),viz.reposition?viz.reposition():viz.compute("end"),this._updateDirectedEdges(),viz.graph.eachNode(function(elem){elem.id!=root&&elem.pos.getp().equals(Polar.KER)&&(elem.pos.set(elem.endPos),elem.startPos.set(elem.endPos))}),viz.fx.animate($.merge(options,{modes:[extraModes.position||"polar"].concat(modes),onComplete:function(){viz.graph.eachNode(function(elem){elem.ignore&&viz.graph.removeNode(elem.id)}),viz.graph.eachNode(function(elem){elem.eachAdjacency(function(adj){adj.ignore&&viz.graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id)})}),options.onComplete()}}))}},_updateDirectedEdges:function(){var graph=this.viz.graph;graph.eachNode(function(node){node.eachAdjacency(function(adj){var isDirectedEdge=adj.data.$direction;if((!isDirectedEdge||adj.nodeFrom.id===adj.data.$direction[0])&&(adj._hiding&&graph.removeAdjacence(adj.nodeFrom.id,adj.nodeTo.id),adj._reversing)){var from=adj.nodeFrom.id,to=adj.nodeTo.id,edge1=graph.edges[from][to],edge2=graph.edges[to][from];edge1.data.$direction=[to,from],edge2.data.$direction=[to,from],adj._reversing=void 0}})})},contract:function(node,opt){var viz=this.viz;!node.collapsed&&node.anySubnode($.lambda(!0))&&(opt=$.merge(this.options,viz.config,opt||{},{modes:["node-property:alpha:span","linear"]}),node.collapsed=!0,function subn(n){n.eachSubnode(function(ch){ch.ignore=!0,ch.setData("alpha",0,"animate"==opt.type?"end":"current"),subn(ch)})}(node),"animate"==opt.type?(viz.compute("end"),viz.rotated&&viz.rotate(viz.rotated,"none",{property:"end"}),function subn(n){n.eachSubnode(function(ch){ch.setPos(node.getPos("end"),"end"),subn(ch)})}(node),viz.fx.animate(opt)):"replot"==opt.type&&viz.refresh())},expand:function(node,opt){if("collapsed"in node){var viz=this.viz;opt=$.merge(this.options,viz.config,opt||{},{modes:["node-property:alpha:span","linear"]}),delete node.collapsed,function subn(n){n.eachSubnode(function(ch){delete ch.ignore,ch.setData("alpha",1,"animate"==opt.type?"end":"current"),subn(ch)})}(node),"animate"==opt.type?(viz.compute("end"),viz.rotated&&viz.rotate(viz.rotated,"none",{property:"end"}),viz.fx.animate(opt)):"replot"==opt.type&&viz.refresh()}},preprocessSum:function(graph){var viz=this.viz;graph.eachNode(function(elem){if(!viz.graph.hasNode(elem.id)){viz.graph.addNode(elem);var n=viz.graph.getNode(elem.id);n.setData("alpha",0),n.setData("alpha",0,"start"),n.setData("alpha",1,"end")}});var fadeEdges=!1;return graph.eachNode(function(elem){elem.eachAdjacency(function(adj){var nodeFrom=viz.graph.getNode(adj.nodeFrom.id),nodeTo=viz.graph.getNode(adj.nodeTo.id);if(!nodeFrom.adjacentTo(nodeTo)){var adj=viz.graph.addAdjacence(nodeFrom,nodeTo,adj.data);nodeFrom.startAlpha==nodeFrom.endAlpha&&nodeTo.startAlpha==nodeTo.endAlpha&&(fadeEdges=!0,adj.setData("alpha",0),adj.setData("alpha",0,"start"),adj.setData("alpha",1,"end"))}})}),fadeEdges}};var NodeHelper={none:{render:$.empty,contains:$.lambda(!1)},circle:{render:function(type,pos,radius,canvas){var ctx=canvas.getCtx();ctx.beginPath(),ctx.arc(pos.x,pos.y,radius,0,2*Math.PI,!0),ctx.closePath(),ctx[type]()},contains:function(npos,pos,radius){var diffx=npos.x-pos.x,diffy=npos.y-pos.y,diff=diffx*diffx+diffy*diffy;return radius*radius>=diff}},ellipse:{render:function(type,pos,width,height,canvas){var ctx=canvas.getCtx(),scalex=1,scaley=1,scaleposx=1,scaleposy=1,radius=0;width>height?(radius=width/2,scaley=height/width,scaleposy=width/height):(radius=height/2,scalex=width/height,scaleposx=height/width),ctx.save(),ctx.scale(scalex,scaley),ctx.beginPath(),ctx.arc(pos.x*scaleposx,pos.y*scaleposy,radius,0,2*Math.PI,!0),ctx.closePath(),ctx[type](),ctx.restore()},contains:function(npos,pos,width,height){var radius=0,scalex=1,scaley=1,diffx=0,diffy=0,diff=0;return width>height?(radius=width/2,scaley=height/width):(radius=height/2,scalex=width/height),diffx=(npos.x-pos.x)*(1/scalex),diffy=(npos.y-pos.y)*(1/scaley),diff=diffx*diffx+diffy*diffy,radius*radius>=diff}},square:{render:function(type,pos,dim,canvas){canvas.getCtx()[type+"Rect"](pos.x-dim,pos.y-dim,2*dim,2*dim)},contains:function(npos,pos,dim){return Math.abs(pos.x-npos.x)<=dim&&Math.abs(pos.y-npos.y)<=dim}},rectangle:{render:function(type,pos,width,height,canvas){canvas.getCtx()[type+"Rect"](pos.x-width/2,pos.y-height/2,width,height)},contains:function(npos,pos,width,height){return Math.abs(pos.x-npos.x)<=width/2&&Math.abs(pos.y-npos.y)<=height/2}},triangle:{render:function(type,pos,dim,canvas){var ctx=canvas.getCtx(),c1x=pos.x,c1y=pos.y-dim,c2x=c1x-dim,c2y=pos.y+dim,c3x=c1x+dim,c3y=c2y;ctx.beginPath(),ctx.moveTo(c1x,c1y),ctx.lineTo(c2x,c2y),ctx.lineTo(c3x,c3y),ctx.closePath(),ctx[type]()},contains:function(npos,pos,dim){return NodeHelper.circle.contains(npos,pos,dim)}},star:{render:function(type,pos,dim,canvas){var ctx=canvas.getCtx(),pi5=Math.PI/5;ctx.save(),ctx.translate(pos.x,pos.y),ctx.beginPath(),ctx.moveTo(dim,0);for(var i=0;9>i;i++)ctx.rotate(pi5),i%2==0?ctx.lineTo(dim/.525731*.200811,0):ctx.lineTo(dim,0);ctx.closePath(),ctx[type](),ctx.restore()},contains:function(npos,pos,dim){return NodeHelper.circle.contains(npos,pos,dim)}}},EdgeHelper={line:{render:function(from,to,canvas){var ctx=canvas.getCtx();ctx.beginPath(),ctx.moveTo(from.x,from.y),ctx.lineTo(to.x,to.y),ctx.stroke()},contains:function(posFrom,posTo,pos,epsilon){var min=Math.min,max=Math.max,minPosX=min(posFrom.x,posTo.x)-epsilon,maxPosX=max(posFrom.x,posTo.x)+epsilon,minPosY=min(posFrom.y,posTo.y)-epsilon,maxPosY=max(posFrom.y,posTo.y)+epsilon;if(pos.x>=minPosX&&pos.x<=maxPosX&&pos.y>=minPosY&&pos.y<=maxPosY){if(Math.abs(posTo.x-posFrom.x)<=epsilon)return!0;var dist=(posTo.y-posFrom.y)/(posTo.x-posFrom.x)*(pos.x-posFrom.x)+posFrom.y;return Math.abs(dist-pos.y)<=epsilon}return!1}},arrow:{render:function(from,to,dim,swap,canvas,arrowPosition){var ctx=canvas.getCtx();if(swap){var tmp=from;from=to,to=tmp}var vect=new Complex(to.x-from.x,to.y-from.y);vect.$scale(dim/vect.norm());var posVect;switch(arrowPosition){case"end":posVect=vect;break;case"center":posVect=new Complex((to.x-from.x)/2,(to.y-from.y)/2)}var intermediatePoint=new Complex(to.x-posVect.x,to.y-posVect.y),normal=new Complex(-vect.y/2,vect.x/2),endPoint=intermediatePoint.add(vect),v1=intermediatePoint.add(normal),v2=intermediatePoint.$add(normal.$scale(-1));ctx.beginPath(),ctx.moveTo(from.x,from.y),ctx.lineTo(to.x,to.y),ctx.stroke(),ctx.beginPath(),ctx.moveTo(v1.x,v1.y),ctx.moveTo(v1.x,v1.y),ctx.lineTo(v2.x,v2.y),ctx.lineTo(endPoint.x,endPoint.y),ctx.closePath(),ctx.fill()},contains:function(posFrom,posTo,pos,epsilon){return EdgeHelper.line.contains(posFrom,posTo,pos,epsilon)}},hyperline:{render:function(from,to,r,canvas){function computeArcThroughTwoPoints(p1,p2){var aDen=p1.x*p2.y-p1.y*p2.x,bDen=aDen,sq1=p1.squaredNorm(),sq2=p2.squaredNorm();if(0==aDen)return{x:0,y:0,ratio:-1};var a=(p1.y*sq2-p2.y*sq1+p1.y-p2.y)/aDen,b=(p2.x*sq1-p1.x*sq2+p2.x-p1.x)/bDen,x=-a/2,y=-b/2,squaredRatio=(a*a+b*b)/4-1;if(0>squaredRatio)return{x:0,y:0,ratio:-1};var ratio=Math.sqrt(squaredRatio),out={x:x,y:y,ratio:ratio>1e3?-1:ratio,a:a,b:b};return out}function sense(angleBegin,angleEnd){return angleEnd>angleBegin?angleBegin+Math.PI>angleEnd?!1:!0:angleEnd+Math.PI>angleBegin?!0:!1}var ctx=canvas.getCtx(),centerOfCircle=computeArcThroughTwoPoints(from,to);if(centerOfCircle.a>1e3||centerOfCircle.b>1e3||centerOfCircle.ratio<0)ctx.beginPath(),ctx.moveTo(from.x*r,from.y*r),ctx.lineTo(to.x*r,to.y*r),ctx.stroke();else{var angleBegin=Math.atan2(to.y-centerOfCircle.y,to.x-centerOfCircle.x),angleEnd=Math.atan2(from.y-centerOfCircle.y,from.x-centerOfCircle.x),sense=sense(angleBegin,angleEnd);ctx.beginPath(),ctx.arc(centerOfCircle.x*r,centerOfCircle.y*r,centerOfCircle.ratio*r,angleBegin,angleEnd,sense),ctx.stroke()}},contains:$.lambda(!1)}};Graph.Plot={initialize:function(viz,klass){this.viz=viz,this.config=viz.config,this.node=viz.config.Node,this.edge=viz.config.Edge,this.animation=new Animation,this.nodeTypes=new klass.Plot.NodeTypes,this.edgeTypes=new klass.Plot.EdgeTypes,this.labels=viz.labels},nodeHelper:NodeHelper,edgeHelper:EdgeHelper,Interpolator:{map:{border:"color",color:"color",width:"number",height:"number",dim:"number",alpha:"number",lineWidth:"number",angularWidth:"number",span:"number",valueArray:"array-number",dimArray:"array-number",vertices:"polygon"},canvas:{globalAlpha:"number",fillStyle:"color",strokeStyle:"color",lineWidth:"number",shadowBlur:"number",shadowColor:"color",shadowOffsetX:"number",shadowOffsetY:"number",miterLimit:"number"},label:{size:"number",color:"color"},compute:function(from,to,delta){return from+(to-from)*delta},moebius:function(elem,props,delta,vector){var v=vector.scale(-delta);if(v.norm()<1){var x=v.x,y=v.y,ans=elem.startPos.getc().moebiusTransformation(v);elem.pos.setc(ans.x,ans.y),v.x=x,v.y=y}},linear:function(elem,props,delta){var from=elem.startPos.getc(!0),to=elem.endPos.getc(!0);elem.pos.setc(this.compute(from.x,to.x,delta),this.compute(from.y,to.y,delta))},polar:function(elem,props,delta){var from=elem.startPos.getp(!0),to=elem.endPos.getp(),ans=to.interpolate(from,delta);elem.pos.setp(ans.theta,ans.rho)},number:function(elem,prop,delta,getter,setter){var from=elem[getter](prop,"start"),to=elem[getter](prop,"end");elem[setter](prop,this.compute(from,to,delta))},color:function(elem,prop,delta,getter,setter){var from=$.hexToRgb(elem[getter](prop,"start")),to=$.hexToRgb(elem[getter](prop,"end")),comp=this.compute,val=$.rgbToHex([parseInt(comp(from[0],to[0],delta)),parseInt(comp(from[1],to[1],delta)),parseInt(comp(from[2],to[2],delta))]);elem[setter](prop,val)},"array-number":function(elem,prop,delta,getter,setter){for(var from=elem[getter](prop,"start"),to=elem[getter](prop,"end"),cur=[],i=0,l=from.length;l>i;i++){var fromi=from[i],toi=to[i];if(fromi.length){for(var j=0,len=fromi.length,curi=[];len>j;j++)curi.push(this.compute(fromi[j],toi[j],delta));cur.push(curi)}else cur.push(this.compute(fromi,toi,delta))}elem[setter](prop,cur)},node:function(elem,props,delta,map,getter,setter){if(map=this[map],props)for(var len=props.length,i=0;len>i;i++){var pi=props[i];this[map[pi]](elem,pi,delta,getter,setter)}else for(var pi in map)this[map[pi]](elem,pi,delta,getter,setter)},edge:function(elem,props,delta,mapKey,getter,setter){var adjs=elem.adjacencies;for(var id in adjs)this.node(adjs[id],props,delta,mapKey,getter,setter)},"node-property":function(elem,props,delta){this.node(elem,props,delta,"map","getData","setData")},"edge-property":function(elem,props,delta){this.edge(elem,props,delta,"map","getData","setData")},"label-property":function(elem,props,delta){this.node(elem,props,delta,"label","getLabelData","setLabelData")},"node-style":function(elem,props,delta){this.node(elem,props,delta,"canvas","getCanvasStyle","setCanvasStyle")},"edge-style":function(elem,props,delta){this.edge(elem,props,delta,"canvas","getCanvasStyle","setCanvasStyle")},polygon:function(elem,prop,delta,getter,setter){var from=elem[getter](prop,"start"),to=elem[getter](prop,"end"),cur=[];if("undefined"==typeof from.offset)if(0===from)from=$.map(to,function(){return new $jit.Complex(0,0)}),from.offset=0;else{for(0==from.length&&from.push(new $jit.Complex(0,0));from.length<to.length;)from.push(from[0]);for(;from.length>to.length;)to.push(to[0]||new $jit.Complex(0,0));if(0==from.length)return;for(var l=from.length,minDist=1e300,offset=0;l>offset;offset++){for(var d=0,i=0;l>i;i++)d+=Geometry.dist2(from[(offset+i)%l],to[i]);minDist>d&&(from.offset=offset,minDist=d)}}for(var i=0,l=from.length;l>i;i++){var fromi=from[(i+from.offset)%l],toi=to[i];cur.push(new $jit.Complex(this.compute(fromi.x,toi.x,delta),this.compute(fromi.y,toi.y,delta)))}elem[setter](prop,cur)}},sequence:function(options){var that=this;options=$.merge({condition:$.lambda(!1),step:$.empty,onComplete:$.empty,duration:200},options||{});var interval=setInterval(function(){options.condition()?options.step():(clearInterval(interval),options.onComplete()),that.viz.refresh(!0)},options.duration)},prepare:function(modes){var graph=this.viz.graph,accessors={
"node-property":{getter:"getData",setter:"setData"},"edge-property":{getter:"getData",setter:"setData"},"node-style":{getter:"getCanvasStyle",setter:"setCanvasStyle"},"edge-style":{getter:"getCanvasStyle",setter:"setCanvasStyle"}},m={};if("array"==$.type(modes))for(var i=0,len=modes.length;len>i;i++){var elems=modes[i].split(":");m[elems.shift()]=elems}else for(var p in modes)"position"==p?m[modes.position]=[]:m[p]=$.splat(modes[p]);return graph.eachNode(function(node){node.startPos.set(node.pos),$.each(["node-property","node-style"],function(p){if(p in m)for(var prop=m[p],i=0,l=prop.length;l>i;i++)node[accessors[p].setter](prop[i],node[accessors[p].getter](prop[i]),"start")}),$.each(["edge-property","edge-style"],function(p){if(p in m){var prop=m[p];node.eachAdjacency(function(adj){for(var i=0,l=prop.length;l>i;i++)adj[accessors[p].setter](prop[i],adj[accessors[p].getter](prop[i]),"start")})}})}),m},animate:function(opt,versor){opt=$.merge(this.viz.config,opt||{});var that=this,viz=this.viz,graph=viz.graph,interp=this.Interpolator,animation="nodefx"===opt.type?this.nodeFxAnimation:this.animation,m=this.prepare(opt.modes);opt.hideLabels&&this.labels.hideLabels(!0),animation.setOptions($.extend(opt,{$animating:!1,compute:function(delta){graph.eachNode(function(node){for(var p in m)interp[p](node,m[p],delta,versor)}),that.plot(opt,this.$animating,delta),this.$animating=!0},complete:function(){opt.hideLabels&&that.labels.hideLabels(!1),that.plot(opt),opt.onComplete()}})).start()},nodeFx:function(opt){void 0==this.nodeFxAnimation&&(this.nodeFxAnimation=new Animation);var viz=this.viz,graph=viz.graph,animation=this.nodeFxAnimation,options=$.merge(this.viz.config,{elements:{id:!1,properties:{}},reposition:!1});opt=$.merge(options,opt||{},{onBeforeCompute:$.empty,onAfterCompute:$.empty}),animation.stopTimer();var props=opt.elements.properties;if(opt.elements.id){var ids=$.splat(opt.elements.id);$.each(ids,function(id){var n=graph.getNode(id);if(n)for(var prop in props)n.setData(prop,props[prop],"end")})}else graph.eachNode(function(n){for(var prop in props)n.setData(prop,props[prop],"end")});var propnames=[];for(var prop in props)propnames.push(prop);var modes=["node-property:"+propnames.join(":")];opt.reposition&&(modes.push("linear"),viz.compute("end")),this.animate($.merge(opt,{modes:modes,type:"nodefx"}))},plot:function(opt,animating){var viz=this.viz,aGraph=viz.graph,canvas=viz.canvas,id=viz.root,that=this,opt=(canvas.getCtx(),Math.min,opt||this.viz.controller);opt.clearCanvas&&canvas.clear();var root=aGraph.getNode(id);if(root){var T=!!root.visited;aGraph.eachNode(function(node){var nodeAlpha=node.getData("alpha");node.eachAdjacency(function(adj){var nodeTo=adj.nodeTo;!!nodeTo.visited===T&&node.drawn&&nodeTo.drawn&&(!animating&&opt.onBeforePlotLine(adj),that.plotLine(adj,canvas,animating),!animating&&opt.onAfterPlotLine(adj))}),node.drawn&&(!animating&&opt.onBeforePlotNode(node),that.plotNode(node,canvas,animating),!animating&&opt.onAfterPlotNode(node)),!that.labelsHidden&&opt.withLabels&&(node.drawn&&nodeAlpha>=.95?that.labels.plotLabel(canvas,node,opt):that.labels.hideLabel(node,!1)),node.visited=!T})}},plotTree:function(node,opt,animating){var that=this,viz=this.viz,canvas=viz.canvas,nodeAlpha=(this.config,canvas.getCtx(),node.getData("alpha"));node.eachSubnode(function(elem){if(opt.plotSubtree(node,elem)&&elem.exist&&elem.drawn){var adj=node.getAdjacency(elem.id);!animating&&opt.onBeforePlotLine(adj),that.plotLine(adj,canvas,animating),!animating&&opt.onAfterPlotLine(adj),that.plotTree(elem,opt,animating)}}),node.drawn?(!animating&&opt.onBeforePlotNode(node),this.plotNode(node,canvas,animating),!animating&&opt.onAfterPlotNode(node),!opt.hideLabels&&opt.withLabels&&nodeAlpha>=.95?this.labels.plotLabel(canvas,node,opt):this.labels.hideLabel(node,!1)):this.labels.hideLabel(node,!0)},plotNode:function(node,canvas,animating){var f=node.getData("type"),ctxObj=this.node.CanvasStyles;if("none"!=f){var width=node.getData("lineWidth"),color=node.getData("color"),alpha=node.getData("alpha"),ctx=canvas.getCtx();ctx.save(),ctx.lineWidth=width,ctx.fillStyle=ctx.strokeStyle=color,ctx.globalAlpha=alpha;for(var s in ctxObj)ctx[s]=node.getCanvasStyle(s);this.nodeTypes[f].render.call(this,node,canvas,animating),ctx.restore()}},plotLine:function(adj,canvas,animating){var f=adj.getData("type"),ctxObj=this.edge.CanvasStyles;if("none"!=f){var width=adj.getData("lineWidth"),color=adj.getData("color"),ctx=canvas.getCtx(),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;ctx.save(),ctx.lineWidth=width,ctx.fillStyle=ctx.strokeStyle=color,ctx.globalAlpha=Math.min(nodeFrom.getData("alpha"),nodeTo.getData("alpha"),adj.getData("alpha"));for(var s in ctxObj)ctx[s]=adj.getCanvasStyle(s);this.edgeTypes[f].render.call(this,adj,canvas,animating),ctx.restore()}}},Graph.Plot3D=$.merge(Graph.Plot,{Interpolator:{linear:function(elem,props,delta){var from=elem.startPos.getc(!0),to=elem.endPos.getc(!0);elem.pos.setc(this.compute(from.x,to.x,delta),this.compute(from.y,to.y,delta),this.compute(from.z,to.z,delta))}},plotNode:function(node,canvas){"none"!=node.getData("type")&&this.plotElement(node,canvas,{getAlpha:function(){return node.getData("alpha")}})},plotLine:function(adj,canvas){"none"!=adj.getData("type")&&this.plotElement(adj,canvas,{getAlpha:function(){return Math.min(adj.nodeFrom.getData("alpha"),adj.nodeTo.getData("alpha"),adj.getData("alpha"))}})},plotElement:function(elem,canvas,opt){var gl=canvas.getCtx(),viewMatrix=new Matrix4,lighting=canvas.config.Scene.Lighting,wcanvas=canvas.canvases[0],program=wcanvas.program,camera=wcanvas.camera;if(elem.geometry||(elem.geometry=new(O3D[elem.getData("type")])),elem.geometry.update(elem),!elem.webGLVertexBuffer){for(var vertices=[],faces=[],normals=[],vertexIndex=0,geom=elem.geometry,i=0,vs=geom.vertices,fs=geom.faces,fsl=fs.length;fsl>i;i++){var face=fs[i],v1=vs[face.a],v2=vs[face.b],v3=vs[face.c],v4=face.d?vs[face.d]:!1,n=face.normal;vertices.push(v1.x,v1.y,v1.z),vertices.push(v2.x,v2.y,v2.z),vertices.push(v3.x,v3.y,v3.z),v4&&vertices.push(v4.x,v4.y,v4.z),normals.push(n.x,n.y,n.z),normals.push(n.x,n.y,n.z),normals.push(n.x,n.y,n.z),v4&&normals.push(n.x,n.y,n.z),faces.push(vertexIndex,vertexIndex+1,vertexIndex+2),v4?(faces.push(vertexIndex,vertexIndex+2,vertexIndex+3),vertexIndex+=4):vertexIndex+=3}elem.webGLVertexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,elem.webGLVertexBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW),elem.webGLFaceBuffer=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,elem.webGLFaceBuffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(faces),gl.STATIC_DRAW),elem.webGLFaceCount=faces.length,elem.webGLNormalBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,elem.webGLNormalBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(normals),gl.STATIC_DRAW)}viewMatrix.multiply(camera.matrix,elem.geometry.matrix),gl.uniformMatrix4fv(program.viewMatrix,!1,viewMatrix.flatten()),gl.uniformMatrix4fv(program.projectionMatrix,!1,camera.projectionMatrix.flatten());var normalMatrix=Matrix4.makeInvert(viewMatrix);normalMatrix.$transpose(),gl.uniformMatrix4fv(program.normalMatrix,!1,normalMatrix.flatten());var color=$.hexToRgb(elem.getData("color"));if(color.push(opt.getAlpha()),gl.uniform4f(program.color,color[0]/255,color[1]/255,color[2]/255,color[3]),gl.uniform1i(program.enableLighting,lighting.enable),lighting.enable){if(lighting.ambient){var acolor=lighting.ambient;gl.uniform3f(program.ambientColor,acolor[0],acolor[1],acolor[2])}if(lighting.directional){var dir=lighting.directional,color=dir.color,pos=dir.direction,vd=new Vector3(pos.x,pos.y,pos.z).normalize().$scale(-1);gl.uniform3f(program.lightingDirection,vd.x,vd.y,vd.z),gl.uniform3f(program.directionalColor,color[0],color[1],color[2])}}gl.bindBuffer(gl.ARRAY_BUFFER,elem.webGLVertexBuffer),gl.vertexAttribPointer(program.position,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,elem.webGLNormalBuffer),gl.vertexAttribPointer(program.normal,3,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,elem.webGLFaceBuffer),gl.drawElements(gl.TRIANGLES,elem.webGLFaceCount,gl.UNSIGNED_SHORT,0)}}),Graph.Label={},Graph.Label.Native=new Class({initialize:function(viz){this.viz=viz},plotLabel:function(canvas,node,controller){{var ctx=canvas.getCtx();node.pos.getc(!0)}ctx.font=node.getLabelData("style")+" "+node.getLabelData("size")+"px "+node.getLabelData("family"),ctx.textAlign=node.getLabelData("textAlign"),ctx.fillStyle=ctx.strokeStyle=node.getLabelData("color"),ctx.textBaseline=node.getLabelData("textBaseline"),this.renderLabel(canvas,node,controller)},renderLabel:function(canvas,node,controller){var ctx=canvas.getCtx(),pos=node.pos.getc(!0);ctx.fillText(node.name,pos.x,pos.y+node.getData("height")/2)},hideLabel:function(node,show){node=$.splat(node);var al=show?!1:!0;$.each(node,function(n){n._hideLabel=al})},hideLabels:$.empty}),Graph.Label.DOM=new Class({labelsHidden:!1,labelContainer:!1,labels:{},getLabelContainer:function(){return this.labelContainer?this.labelContainer:this.labelContainer=document.getElementById(this.viz.config.labelContainer)},getLabel:function(id){return id in this.labels&&null!=this.labels[id]?this.labels[id]:this.labels[id]=document.getElementById(id)},hideLabels:function(hide){var container=this.getLabelContainer();container.style.display=hide?"none":"",this.labelsHidden=hide},clearLabels:function(force){for(var id in this.labels)(force||!this.viz.graph.hasNode(id))&&(this.disposeLabel(id),delete this.labels[id])},disposeLabel:function(id){var elem=this.getLabel(id);elem&&elem.parentNode&&elem.parentNode.removeChild(elem)},hideLabel:function(node,show){node=$.splat(node);var lab,st=show?"":"none",that=this;$.each(node,function(n){lab=that.getLabel(n.id),lab&&(lab.style.display=st)})},fitsInCanvas:function(pos,canvas){var size=canvas.getSize();if(pos.w&&pos.h){if(pos.x>=size.width||pos.x<-pos.w||pos.y>=size.height||pos.y<-pos.h)return!1}else if(pos.x>=size.width||pos.x<0||pos.y>=size.height||pos.y<0)return!1;return!0}}),Graph.Label.HTML=new Class({Implements:Graph.Label.DOM,plotLabel:function(canvas,node,controller){var id=node.id,tag=this.getLabel(id);if(!tag&&!(tag=document.getElementById(id))){tag=document.createElement("div");var container=this.getLabelContainer();tag.id=id,tag.className="node",tag.style.position="absolute",controller.onCreateLabel(tag,node),container.appendChild(tag),this.labels[node.id]=tag}this.placeLabel(tag,node,controller)}}),Graph.Label.SVG=new Class({Implements:Graph.Label.DOM,plotLabel:function(canvas,node,controller){var id=node.id,tag=this.getLabel(id);if(!tag&&!(tag=document.getElementById(id))){var ns="http://www.w3.org/2000/svg";tag=document.createElementNS(ns,"svg:text");var tspan=document.createElementNS(ns,"svg:tspan");tag.appendChild(tspan);var container=this.getLabelContainer();tag.setAttribute("id",id),tag.setAttribute("class","node"),container.appendChild(tag),controller.onCreateLabel(tag,node),this.labels[node.id]=tag}this.placeLabel(tag,node,controller)}}),Graph.Geom=new Class({initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=viz.config.Node,this.edge=viz.config.Edge},translate:function(pos,prop){prop=$.splat(prop),this.viz.graph.eachNode(function(elem){$.each(prop,function(p){elem.getPos(p).$add(pos)})})},setRightLevelToShow:function(node,canvas,callback){var level=this.getRightLevelToShow(node,canvas),fx=this.viz.labels,opt=$.merge({execShow:!0,execHide:!0,onHide:$.empty,onShow:$.empty},callback||{});node.eachLevel(0,this.config.levelsToShow,function(n){var d=n._depth-node._depth;d>level?(opt.onHide(n),opt.execHide&&(n.drawn=!1,n.exist=!1,fx.hideLabel(n,!1))):(opt.onShow(n),opt.execShow&&(n.exist=!0))}),node.drawn=!0},getRightLevelToShow:function(node,canvas){var config=this.config,level=config.levelsToShow,constrained=config.constrained;if(!constrained)return level;for(;!this.treeFitsInCanvas(node,canvas,level)&&level>1;)level--;return level}});var Loader={construct:function(json){var isGraph="array"==$.type(json),ans=new Graph(this.graphOptions,this.config.Node,this.config.Edge,this.config.Label);return isGraph?function(ans,json){for(var getNode=function(id){for(var i=0,l=json.length;l>i;i++)if(json[i].id==id)return json[i];var newNode={id:id,name:id};return ans.addNode(newNode)},i=0,l=json.length;l>i;i++){ans.addNode(json[i]);var adj=json[i].adjacencies;if(adj)for(var j=0,lj=adj.length;lj>j;j++){var node=adj[j],data={};"string"!=typeof adj[j]&&(data=$.merge(node.data,{}),node=node.nodeTo),ans.addAdjacence(json[i],getNode(node),data)}}}(ans,json):function(ans,json){if(ans.addNode(json),json.children)for(var i=0,ch=json.children;i<ch.length;i++)ans.addAdjacence(json,ch[i]),arguments.callee(ans,ch[i])}(ans,json),ans},loadJSON:function(json,i){this.json=json,this.labels&&this.labels.clearLabels&&this.labels.clearLabels(!0),this.graph=this.construct(json),this.root="array"!=$.type(json)?json.id:json[i?i:0].id},toJSON:function(type){if(type=type||"tree","tree"==type){var ans={},rootNode=this.graph.getNode(this.root),ans=function recTree(node){var ans={};ans.id=node.id,ans.name=node.name,ans.data=node.data;var ch=[];return node.eachSubnode(function(n){ch.push(recTree(n))}),ans.children=ch,ans}(rootNode);return ans}var ans=[],T=!!this.graph.getNode(this.root).visited;return this.graph.eachNode(function(node){var ansNode={};ansNode.id=node.id,ansNode.name=node.name,ansNode.data=node.data;var adjs=[];node.eachAdjacency(function(adj){var nodeTo=adj.nodeTo;if(!!nodeTo.visited===T){var ansAdj={};ansAdj.nodeTo=nodeTo.id,ansAdj.data=adj.data,adjs.push(ansAdj)}}),ansNode.adjacencies=adjs,ans.push(ansNode),node.visited=!T}),ans}},Layouts=$jit.Layouts={},NodeDim={label:null,compute:function(graph,prop,opt){this.initializeLabel(opt);var label=this.label,style=label.style;graph.eachNode(function(n){var autoWidth=n.getData("autoWidth"),autoHeight=n.getData("autoHeight");if(autoWidth||autoHeight){delete n.data.$width,delete n.data.$height,delete n.data.$dim;var width=n.getData("width"),height=n.getData("height");style.width=autoWidth?"auto":width+"px",style.height=autoHeight?"auto":height+"px",label.innerHTML=n.name;var offsetWidth=label.offsetWidth,offsetHeight=label.offsetHeight,type=n.getData("type");if(-1===$.indexOf(["circle","square","triangle","star"],type))n.setData("width",offsetWidth),n.setData("height",offsetHeight);else{var dim=offsetWidth>offsetHeight?offsetWidth:offsetHeight;n.setData("width",dim),n.setData("height",dim),n.setData("dim",dim)}}})},initializeLabel:function(opt){this.label||(this.label=document.createElement("div"),document.body.appendChild(this.label)),this.setLabelStyles(opt)},setLabelStyles:function(opt){$.extend(this.label.style,{visibility:"hidden",position:"absolute",width:"auto",height:"auto"}),this.label.className="jit-autoadjust-label"}};Layouts.Tree=function(){function getBoundaries(graph,config,level,orn,prop){var dim=config.Node,multitree=config.multitree;if(dim.overridable){var w=-1,h=-1;return graph.eachNode(function(n){if(n._depth==level&&(!multitree||"$orn"in n.data&&n.data.$orn==orn)){var dw=n.getData("width",prop),dh=n.getData("height",prop);w=dw>w?dw:w,h=dh>h?dh:h}}),{width:0>w?dim.width:w,height:0>h?dim.height:h}}return dim}function movetree(node,prop,val,orn){var p="left"==orn||"right"==orn?"y":"x";node.getPos(prop)[p]+=val}function moveextent(extent,val){var ans=[];return $.each(extent,function(elem){elem=slice.call(elem),elem[0]+=val,elem[1]+=val,ans.push(elem)}),ans}function merge(ps,qs){if(0==ps.length)return qs;if(0==qs.length)return ps;var p=ps.shift(),q=qs.shift();return[[p[0],q[1]]].concat(merge(ps,qs))}function mergelist(ls,def){if(def=def||[],0==ls.length)return def;var ps=ls.pop();return mergelist(ls,merge(ps,def))}function fit(ext1,ext2,subtreeOffset,siblingOffset,i){if(ext1.length<=i||ext2.length<=i)return 0;var p=ext1[i][1],q=ext2[i][0];return Math.max(fit(ext1,ext2,subtreeOffset,siblingOffset,++i)+subtreeOffset,p-q+siblingOffset)}function fitlistl(es,subtreeOffset,siblingOffset){function $fitlistl(acc,es,i){if(es.length<=i)return[];var e=es[i],ans=fit(acc,e,subtreeOffset,siblingOffset,0);return[ans].concat($fitlistl(merge(acc,moveextent(e,ans)),es,++i))}return $fitlistl([],es,0)}function fitlistr(es,subtreeOffset,siblingOffset){function $fitlistr(acc,es,i){if(es.length<=i)return[];var e=es[i],ans=-fit(e,acc,subtreeOffset,siblingOffset,0);return[ans].concat($fitlistr(merge(moveextent(e,ans),acc),es,++i))}es=slice.call(es);var ans=$fitlistr([],es.reverse(),0);return ans.reverse()}function fitlist(es,subtreeOffset,siblingOffset,align){var esl=fitlistl(es,subtreeOffset,siblingOffset),esr=fitlistr(es,subtreeOffset,siblingOffset);"left"==align?esr=esl:"right"==align&&(esl=esr);for(var i=0,ans=[];i<esl.length;i++)ans[i]=(esl[i]+esr[i])/2;return ans}function design(graph,node,prop,config,orn){function $design(node,maxsize,acum){var sval=node.getData(s,prop),notsval=maxsize||node.getData(nots,prop),trees=[],extents=[],chmaxsize=!1,chacum=notsval+config.levelDistance;node.eachSubnode(function(n){if(n.exist&&(!multitree||"$orn"in n.data&&n.data.$orn==orn)){"even"==config.levelSpacing?chmaxsize||(chmaxsize=getBoundaries(graph,config,n._depth,orn,prop)):chmaxsize={width:n.getData("width"),height:n.getData("height")};var s=$design(n,chmaxsize[nots],acum+chacum);trees.push(s.tree),extents.push(s.extent)}});for(var positions=fitlist(extents,subtreeOffset,siblingOffset,align),i=0,pextents=[];i<trees.length;i++)movetree(trees[i],prop,positions[i],orn),pextents.push(moveextent(extents[i],positions[i]));var resultextent=[[-sval/2,sval/2]].concat(mergelist(pextents));return node.getPos(prop)[p]=0,node.getPos(prop)[notp]="top"==orn||"left"==orn?acum:-acum,{tree:node,extent:resultextent}}var multitree=config.multitree,auxp=["x","y"],auxs=["width","height"],ind=+("left"==orn||"right"==orn),p=auxp[ind],notp=auxp[1-ind],s=(config.Node,auxs[ind]),nots=auxs[1-ind],siblingOffset=config.siblingOffset,subtreeOffset=config.subtreeOffset,align=config.align;$design(node,!1,0)}var slice=Array.prototype.slice;return new Class({compute:function(property,computeLevels){var prop=property||"start",node=this.graph.getNode(this.root);$.extend(node,{drawn:!0,exist:!0,selected:!0}),NodeDim.compute(this.graph,prop,this.config),!computeLevels&&"_depth"in node||this.graph.computeLevels(this.root,0,"ignore"),this.computePositions(node,prop)},computePositions:function(node,prop){var config=this.config,multitree=config.multitree,align=config.align,indent="center"!==align&&config.indent,orn=config.orientation,orns=multitree?["top","right","bottom","left"]:[orn],that=this;$.each(orns,function(orn){design(that.graph,node,prop,that.config,orn,prop);var i=["x","y"][+("left"==orn||"right"==orn)];!function red(node){node.eachSubnode(function(n){n.exist&&(!multitree||"$orn"in n.data&&n.data.$orn==orn)&&(n.getPos(prop)[i]+=node.getPos(prop)[i],indent&&(n.getPos(prop)[i]+="left"==align?indent:-indent),red(n))})}(node)})}})}(),$jit.ST=function(){function getNodesToHide(node){if(node=node||this.clickedNode,!this.config.constrained)return[];var Geom=this.geom,graph=this.graph,canvas=this.canvas,level=node._depth,nodeArray=[];graph.eachNode(function(n){n.exist&&!n.selected&&(n.isDescendantOf(node.id)?n._depth<=level&&nodeArray.push(n):nodeArray.push(n))});var leafLevel=Geom.getRightLevelToShow(node,canvas);node.eachLevel(leafLevel,leafLevel,function(n){n.exist&&!n.selected&&nodeArray.push(n)});for(var i=0;i<nodesInPath.length;i++){var n=this.graph.getNode(nodesInPath[i]);n.isDescendantOf(node.id)||nodeArray.push(n)}return nodeArray}function getNodesToShow(node){var nodeArray=[],config=this.config;return node=node||this.clickedNode,this.clickedNode.eachLevel(0,config.levelsToShow,function(n){!config.multitree||"$orn"in n.data||!n.anySubnode(function(ch){return ch.exist&&!ch.drawn})?n.drawn&&!n.anySubnode("drawn")&&nodeArray.push(n):nodeArray.push(n)}),nodeArray}var nodesInPath=[];return new Class({Implements:[Loader,Extras,Layouts.Tree],initialize:function(controller){var $ST=$jit.ST,config={levelsToShow:2,levelDistance:30,constrained:!0,Node:{type:"rectangle"},duration:700,offsetX:0,offsetY:0};this.controller=this.config=$.merge(Options("Canvas","Fx","Tree","Node","Edge","Controller","Tips","NodeStyles","Events","Navigation","Label"),config,controller);var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Complex},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new $ST.Label[canvasConfig.Label.type](this),this.fx=new $ST.Plot(this,$ST),this.op=new $ST.Op(this),this.group=new $ST.Group(this),this.geom=new $ST.Geom(this),this.clickedNode=null,this.initializeExtras()},plot:function(){this.fx.plot(this.controller)},switchPosition:function(pos,method,onComplete){var Geom=this.geom,Plot=this.fx,that=this;Plot.busy||(Plot.busy=!0,this.contract({onComplete:function(){Geom.switchOrientation(pos),that.compute("end",!1),Plot.busy=!1,"animate"==method?that.onClick(that.clickedNode.id,onComplete):"replot"==method&&that.select(that.clickedNode.id,onComplete)}},pos))},switchAlignment:function(align,method,onComplete){this.config.align=align,"animate"==method?this.select(this.clickedNode.id,onComplete):"replot"==method&&this.onClick(this.clickedNode.id,onComplete)},addNodeInPath:function(id){nodesInPath.push(id),this.select(this.clickedNode&&this.clickedNode.id||this.root)},clearNodesInPath:function(id){nodesInPath.length=0,this.select(this.clickedNode&&this.clickedNode.id||this.root)},refresh:function(){this.reposition(),this.select(this.clickedNode&&this.clickedNode.id||this.root)},reposition:function(){if(this.graph.computeLevels(this.root,0,"ignore"),this.geom.setRightLevelToShow(this.clickedNode,this.canvas),this.graph.eachNode(function(n){n.exist&&(n.drawn=!0)}),this.compute("end"),this.clickedNode){var offset={x:this.canvas.translateOffsetX+this.config.offsetX||0,y:this.canvas.translateOffsetY+this.config.offsetY||0};this.geom.translate(this.clickedNode.endPos.add(offset).$scale(-1),"end")}},requestNodes:function(node,onComplete){var handler=$.merge(this.controller,onComplete),lev=this.config.levelsToShow;if(handler.request){var leaves=[],d=node._depth;node.eachLevel(0,lev,function(n){n.drawn&&!n.anySubnode()&&(leaves.push(n),n._level=lev-(n._depth-d))}),this.group.requestNodes(leaves,handler)}else handler.onComplete()},contract:function(onComplete,switched){var orn=this.config.orientation,Geom=this.geom,Group=this.group;switched&&Geom.switchOrientation(switched);var nodes=getNodesToHide.call(this);switched&&Geom.switchOrientation(orn),Group.contract(nodes,$.merge(this.controller,onComplete))},move:function(node,onComplete){this.compute("end",!1);var move=onComplete.Move,offset={x:move.offsetX,y:move.offsetY};move.enable?this.geom.translate(node.endPos.add(offset).$scale(-1),"end"):this.geom.translate($C(offset.x,offset.y).$scale(-1),"end"),this.fx.animate($.merge(this.controller,{modes:["linear"]},onComplete))},expand:function(node,onComplete){var nodeArray=getNodesToShow.call(this,node);this.group.expand(nodeArray,$.merge(this.controller,onComplete))},selectPath:function(node){function path(node){if(null!=node&&!node.selected){node.selected=!0,$.each(that.group.getSiblings([node])[node.id],function(n){n.exist=!0,n.drawn=!0});var parents=node.getParents();parents=parents.length>0?parents[0]:null,path(parents)}}var that=this;this.graph.eachNode(function(n){n.selected=!1});for(var i=0,ns=[node.id].concat(nodesInPath);i<ns.length;i++)path(this.graph.getNode(ns[i]))},setRoot:function(id,method,onComplete){function $setRoot(){if(this.config.multitree&&clickedNode.data.$orn){var orn=clickedNode.data.$orn,opp={left:"right",right:"left",top:"bottom",bottom:"top"}[orn];rootNode.data.$orn=opp,function tag(rootNode){rootNode.eachSubnode(function(n){n.id!=id&&(n.data.$orn=opp,tag(n))})}(rootNode),delete clickedNode.data.$orn}this.root=id,this.clickedNode=clickedNode,this.graph.computeLevels(this.root,0,"ignore"),this.geom.setRightLevelToShow(clickedNode,canvas,{execHide:!1,onShow:function(node){node.drawn||(node.drawn=!0,node.setData("alpha",1,"end"),node.setData("alpha",0),node.pos.setc(clickedNode.pos.x,clickedNode.pos.y))}}),this.compute("end"),this.busy=!0,this.fx.animate({modes:["linear","node-property:alpha"],onComplete:function(){that.busy=!1,that.onClick(id,{onComplete:function(){onComplete&&onComplete.onComplete()}})}})}if(!this.busy){this.busy=!0;var that=this,canvas=this.canvas,rootNode=this.graph.getNode(this.root),clickedNode=this.graph.getNode(id);delete rootNode.data.$orns,"animate"==method?($setRoot.call(this),that.selectPath(clickedNode)):"replot"==method&&($setRoot.call(this),this.select(this.root))}},addSubtree:function(subtree,method,onComplete){"replot"==method?this.op.sum(subtree,$.extend({type:"replot"},onComplete||{})):"animate"==method&&this.op.sum(subtree,$.extend({type:"fade:seq"},onComplete||{}))},removeSubtree:function(id,removeRoot,method,onComplete){var node=this.graph.getNode(id),subids=[];node.eachLevel(+!removeRoot,!1,function(n){subids.push(n.id)}),"replot"==method?this.op.removeNode(subids,$.extend({type:"replot"},onComplete||{})):"animate"==method&&this.op.removeNode(subids,$.extend({type:"fade:seq"},onComplete||{}))},select:function(id,onComplete){var group=this.group,geom=this.geom,node=this.graph.getNode(id),canvas=this.canvas,complete=(this.graph.getNode(this.root),$.merge(this.controller,onComplete)),that=this;complete.onBeforeCompute(node),this.selectPath(node),this.clickedNode=node,this.requestNodes(node,{onComplete:function(){group.hide(group.prepare(getNodesToHide.call(that)),complete),geom.setRightLevelToShow(node,canvas),that.compute("current"),that.graph.eachNode(function(n){var pos=n.pos.getc(!0);n.startPos.setc(pos.x,pos.y),n.endPos.setc(pos.x,pos.y),n.visited=!1});var offset={x:complete.offsetX,y:complete.offsetY};that.geom.translate(node.endPos.add(offset).$scale(-1),["start","current","end"]),group.show(getNodesToShow.call(that)),that.plot(),complete.onAfterCompute(that.clickedNode),complete.onComplete()}})},onClick:function(id,options){var canvas=this.canvas,that=this,Geom=this.geom,config=this.config,innerController={Move:{enable:!0,offsetX:canvas.translateOffsetX+config.offsetX||0,offsetY:canvas.translateOffsetY+config.offsetY||0},setRightLevelToShowConfig:!1,onBeforeRequest:$.empty,onBeforeContract:$.empty,onBeforeMove:$.empty,onBeforeExpand:$.empty},complete=$.merge(this.controller,innerController,options);if(!this.busy){this.busy=!0;var node=this.graph.getNode(id);this.selectPath(node,this.clickedNode),this.clickedNode=node,complete.onBeforeCompute(node),complete.onBeforeRequest(node),this.requestNodes(node,{onComplete:function(){complete.onBeforeContract(node),that.contract({onComplete:function(){Geom.setRightLevelToShow(node,canvas,complete.setRightLevelToShowConfig),complete.onBeforeMove(node),that.move(node,{Move:complete.Move,onComplete:function(){complete.onBeforeExpand(node),that.expand(node,{onComplete:function(){that.busy=!1,complete.onAfterCompute(id),complete.onComplete()}})}})}})}})}}})}(),$jit.ST.$extend=!0,$jit.ST.Op=new Class({Implements:Graph.Op}),$jit.ST.Group=new Class({initialize:function(viz){this.viz=viz,this.canvas=viz.canvas,this.config=viz.config,this.animation=new Animation,this.nodes=null},requestNodes:function(nodes,controller){var counter=0,len=nodes.length,nodeSelected={},complete=function(){controller.onComplete()},viz=this.viz;0==len&&complete();for(var i=0;len>i;i++)nodeSelected[nodes[i].id]=nodes[i],controller.request(nodes[i].id,nodes[i]._level,{onComplete:function(nodeId,data){data&&data.children&&(data.id=nodeId,viz.op.sum(data,{type:"nothing"})),++counter==len&&(viz.graph.computeLevels(viz.root,0),complete())}})},contract:function(nodes,controller){var that=(this.viz,this);nodes=this.prepare(nodes),this.animation.setOptions($.merge(controller,{$animating:!1,compute:function(delta){1==delta&&(delta=.99),that.plotStep(1-delta,controller,this.$animating),this.$animating="contract"},complete:function(){that.hide(nodes,controller)}})).start()},hide:function(nodes,controller){for(var i=(this.viz,0);i<nodes.length;i++){nodes[i].eachLevel(1,!1,function(elem){elem.exist&&$.extend(elem,{drawn:!1,exist:!1})})}controller.onComplete()},expand:function(nodes,controller){var that=this;this.show(nodes),this.animation.setOptions($.merge(controller,{$animating:!1,compute:function(delta){that.plotStep(delta,controller,this.$animating),this.$animating="expand"},complete:function(){that.plotStep(void 0,controller,!1),controller.onComplete()}})).start()},show:function(nodes){var config=this.config;this.prepare(nodes),$.each(nodes,function(n){if(config.multitree&&!("$orn"in n.data)){delete n.data.$orns;var orns=" ";n.eachSubnode(function(ch){"$orn"in ch.data&&orns.indexOf(ch.data.$orn)<0&&ch.exist&&!ch.drawn&&(orns+=ch.data.$orn+" ")}),n.data.$orns=orns}n.eachLevel(0,config.levelsToShow,function(n){n.exist&&(n.drawn=!0)})})},prepare:function(nodes){return this.nodes=this.getNodesWithChildren(nodes),this.nodes},getNodesWithChildren:function(nodes){{var ans=[],config=this.config;this.viz.root}nodes.sort(function(a,b){return(a._depth<=b._depth)-(a._depth>=b._depth)});for(var i=0;i<nodes.length;i++)if(nodes[i].anySubnode("exist")){for(var j=i+1,desc=!1;!desc&&j<nodes.length;j++)(!config.multitree||"$orn"in nodes[j].data)&&(desc=desc||nodes[i].isDescendantOf(nodes[j].id));desc||ans.push(nodes[i])}return ans},plotStep:function(delta,controller,animating){var i,node,viz=this.viz,config=this.config,canvas=viz.canvas,ctx=canvas.getCtx(),nodes=this.nodes,nds={};for(i=0;i<nodes.length;i++){node=nodes[i],nds[node.id]=[];var root=config.multitree&&!("$orn"in node.data),orns=root&&node.data.$orns;node.eachSubgraph(function(n){root&&orns&&orns.indexOf(n.data.$orn)>0&&n.drawn?(n.drawn=!1,nds[node.id].push(n)):root&&orns||!n.drawn||(n.drawn=!1,nds[node.id].push(n))}),node.drawn=!0}nodes.length>0&&viz.fx.plot();for(i in nds)$.each(nds[i],function(n){n.drawn=!0});for(i=0;i<nodes.length;i++)node=nodes[i],ctx.save(),viz.fx.plotSubtree(node,controller,delta,animating),ctx.restore()},getSiblings:function(nodes){var siblings={};return $.each(nodes,function(n){var par=n.getParents();if(0==par.length)siblings[n.id]=[n];else{var ans=[];par[0].eachSubnode(function(sn){ans.push(sn)}),siblings[n.id]=ans}}),siblings}}),$jit.ST.Geom=new Class({Implements:Graph.Geom,switchOrientation:function(orn){this.config.orientation=orn},dispatch:function(){var args=Array.prototype.slice.call(arguments),s=args.shift(),len=args.length,val=function(a){return"function"==typeof a?a():a};if(2==len)return val("top"==s||"bottom"==s?args[0]:args[1]);if(4==len)switch(s){case"top":return val(args[0]);case"right":return val(args[1]);case"bottom":return val(args[2]);case"left":return val(args[3])}return void 0},getSize:function(n,invert){var data=n.data,config=this.config,siblingOffset=config.siblingOffset,s=config.multitree&&"$orn"in data&&data.$orn||config.orientation,w=n.getData("width")+siblingOffset,h=n.getData("height")+siblingOffset;return invert?this.dispatch(s,w,h):this.dispatch(s,h,w)},getTreeBaseSize:function(node,level,leaf){var size=this.getSize(node,!0),baseHeight=0,that=this;return leaf(level,node)?size:0===level?0:(node.eachSubnode(function(elem){baseHeight+=that.getTreeBaseSize(elem,level-1,leaf)}),(size>baseHeight?size:baseHeight)+this.config.subtreeOffset)},getEdge:function(node,type,s){var $C=function(a,b){return function(){return node.pos.add(new Complex(a,b))}},dim=this.node,w=node.getData("width"),h=node.getData("height");if("begin"==type){if("center"==dim.align)return this.dispatch(s,$C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));

if("left"==dim.align)return this.dispatch(s,$C(0,h),$C(0,0),$C(0,0),$C(w,0));if("right"==dim.align)return this.dispatch(s,$C(0,0),$C(-w,0),$C(0,-h),$C(0,0));throw"align: not implemented"}if("end"==type){if("center"==dim.align)return this.dispatch(s,$C(0,-h/2),$C(w/2,0),$C(0,h/2),$C(-w/2,0));if("left"==dim.align)return this.dispatch(s,$C(0,0),$C(w,0),$C(0,h),$C(0,0));if("right"==dim.align)return this.dispatch(s,$C(0,-h),$C(0,0),$C(0,0),$C(-w,0));throw"align: not implemented"}},getScaledTreePosition:function(node,scale){var dim=this.node,w=node.getData("width"),h=node.getData("height"),s=this.config.multitree&&"$orn"in node.data&&node.data.$orn||this.config.orientation,$C=function(a,b){return function(){return node.pos.add(new Complex(a,b)).$scale(1-scale)}};if("left"==dim.align)return this.dispatch(s,$C(0,h),$C(0,0),$C(0,0),$C(w,0));if("center"==dim.align)return this.dispatch(s,$C(0,h/2),$C(-w/2,0),$C(0,-h/2),$C(w/2,0));if("right"==dim.align)return this.dispatch(s,$C(0,0),$C(-w,0),$C(0,-h),$C(0,0));throw"align: not implemented"},treeFitsInCanvas:function(node,canvas,level){var csize=canvas.getSize(),s=this.config.multitree&&"$orn"in node.data&&node.data.$orn||this.config.orientation,size=this.dispatch(s,csize.width,csize.height),baseSize=this.getTreeBaseSize(node,level,function(level,node){return 0===level||!node.anySubnode()});return size>baseSize}}),$jit.ST.Plot=new Class({Implements:Graph.Plot,plotSubtree:function(node,opt,scale,animating){var viz=this.viz,canvas=viz.canvas,config=viz.config;if(scale=Math.min(Math.max(.001,scale),1),scale>=0){node.drawn=!1;var ctx=canvas.getCtx(),diff=viz.geom.getScaledTreePosition(node,scale);ctx.translate(diff.x,diff.y),ctx.scale(scale,scale)}this.plotTree(node,$.merge(opt,{withLabels:!0,hideLabels:!!scale,plotSubtree:function(n,ch){var root=config.multitree&&!("$orn"in node.data),orns=root&&node.getData("orns");return!root||orns.indexOf(node.getData("orn"))>-1}}),animating),scale>=0&&(node.drawn=!0)},getAlignedPos:function(pos,width,height){var square,orn,nconfig=this.node;if("center"==nconfig.align)square={x:pos.x-width/2,y:pos.y-height/2};else if("left"==nconfig.align)orn=this.config.orientation,square="bottom"==orn||"top"==orn?{x:pos.x-width/2,y:pos.y}:{x:pos.x,y:pos.y-height/2};else{if("right"!=nconfig.align)throw"align: not implemented";orn=this.config.orientation,square="bottom"==orn||"top"==orn?{x:pos.x-width/2,y:pos.y-height}:{x:pos.x-width,y:pos.y-height/2}}return square},getOrientation:function(adj){var config=this.config,orn=config.orientation;if(config.multitree){var nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo;orn="$orn"in nodeFrom.data&&nodeFrom.data.$orn||"$orn"in nodeTo.data&&nodeTo.data.$orn}return orn}}),$jit.ST.Label={},$jit.ST.Label.Native=new Class({Implements:Graph.Label.Native,renderLabel:function(canvas,node,controller){var ctx=canvas.getCtx(),coord=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),pos=this.viz.fx.getAlignedPos(coord,width,height);ctx.fillText(node.name,pos.x+width/2,pos.y+height/2)}}),$jit.ST.Label.DOM=new Class({Implements:Graph.Label.DOM,placeLabel:function(tag,node,controller){var labelPos,orn,pos=node.pos.getc(!0),config=this.viz.config,dim=config.Node,canvas=this.viz.canvas,w=node.getData("width"),h=node.getData("height"),radius=canvas.getSize(),ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,posx=pos.x*sx+ox,posy=pos.y*sy+oy;if("center"==dim.align)labelPos={x:Math.round(posx-w/2+radius.width/2),y:Math.round(posy-h/2+radius.height/2)};else if("left"==dim.align)orn=config.orientation,labelPos="bottom"==orn||"top"==orn?{x:Math.round(posx-w/2+radius.width/2),y:Math.round(posy+radius.height/2)}:{x:Math.round(posx+radius.width/2),y:Math.round(posy-h/2+radius.height/2)};else{if("right"!=dim.align)throw"align: not implemented";orn=config.orientation,labelPos="bottom"==orn||"top"==orn?{x:Math.round(posx-w/2+radius.width/2),y:Math.round(posy-h+radius.height/2)}:{x:Math.round(posx-w+radius.width/2),y:Math.round(posy-h/2+radius.height/2)}}labelPos.w=w,labelPos.h=h;var style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),$jit.ST.Label.SVG=new Class({Implements:[$jit.ST.Label.DOM,Graph.Label.SVG],initialize:function(viz){this.viz=viz}}),$jit.ST.Label.HTML=new Class({Implements:[$jit.ST.Label.DOM,Graph.Label.HTML],initialize:function(viz){this.viz=viz}}),$jit.ST.Plot.NodeTypes=new Class({none:{render:$.empty,contains:$.lambda(!1)},circle:{render:function(node,canvas){var dim=node.getData("dim"),pos=this.getAlignedPos(node.pos.getc(!0),dim,dim),dim2=dim/2;this.nodeHelper.circle.render("fill",{x:pos.x+dim2,y:pos.y+dim2},dim2,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=this.getAlignedPos(node.pos.getc(!0),dim,dim),dim2=dim/2;return this.nodeHelper.circle.contains({x:npos.x+dim2,y:npos.y+dim2},pos,dim2)}},square:{render:function(node,canvas){var dim=node.getData("dim"),dim2=dim/2,pos=this.getAlignedPos(node.pos.getc(!0),dim,dim);this.nodeHelper.square.render("fill",{x:pos.x+dim2,y:pos.y+dim2},dim2,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=this.getAlignedPos(node.pos.getc(!0),dim,dim),dim2=dim/2;return this.nodeHelper.square.contains({x:npos.x+dim2,y:npos.y+dim2},pos,dim2)}},ellipse:{render:function(node,canvas){var width=node.getData("width"),height=node.getData("height"),pos=this.getAlignedPos(node.pos.getc(!0),width,height);this.nodeHelper.ellipse.render("fill",{x:pos.x+width/2,y:pos.y+height/2},width,height,canvas)},contains:function(node,pos){var width=node.getData("width"),height=node.getData("height"),npos=this.getAlignedPos(node.pos.getc(!0),width,height);return this.nodeHelper.ellipse.contains({x:npos.x+width/2,y:npos.y+height/2},pos,width,height)}},rectangle:{render:function(node,canvas){var width=node.getData("width"),height=node.getData("height"),pos=this.getAlignedPos(node.pos.getc(!0),width,height);this.nodeHelper.rectangle.render("fill",{x:pos.x+width/2,y:pos.y+height/2},width,height,canvas)},contains:function(node,pos){var width=node.getData("width"),height=node.getData("height"),npos=this.getAlignedPos(node.pos.getc(!0),width,height);return this.nodeHelper.rectangle.contains({x:npos.x+width/2,y:npos.y+height/2},pos,width,height)}}}),$jit.ST.Plot.EdgeTypes=new Class({none:$.empty,line:{render:function(adj,canvas){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,from=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),to=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn);this.edgeHelper.line.render(from,to,canvas)},contains:function(adj,pos){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,from=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),to=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn);return this.edgeHelper.line.contains(from,to,pos,this.edge.epsilon)}},arrow:{render:function(adj,canvas){var orn=this.getOrientation(adj),node=adj.nodeFrom,child=adj.nodeTo,rel=node._depth<child._depth,dim=adj.getData("dim"),from=this.viz.geom.getEdge(rel?node:child,"begin",orn),to=this.viz.geom.getEdge(rel?child:node,"end",orn),direction=adj.data.$direction,inv=direction&&direction.length>1&&direction[0]!=node.id;this.edgeHelper.arrow.render(from,to,dim,inv,canvas)},contains:function(adj,pos){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,from=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),to=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn);return this.edgeHelper.arrow.contains(from,to,pos,this.edge.epsilon)}},"quadratic:begin":{render:function(adj,canvas){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,begin=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),end=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn),dim=adj.getData("dim"),ctx=canvas.getCtx();switch(ctx.beginPath(),ctx.moveTo(begin.x,begin.y),orn){case"left":ctx.quadraticCurveTo(begin.x+dim,begin.y,end.x,end.y);break;case"right":ctx.quadraticCurveTo(begin.x-dim,begin.y,end.x,end.y);break;case"top":ctx.quadraticCurveTo(begin.x,begin.y+dim,end.x,end.y);break;case"bottom":ctx.quadraticCurveTo(begin.x,begin.y-dim,end.x,end.y)}ctx.stroke()}},"quadratic:end":{render:function(adj,canvas){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,begin=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),end=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn),dim=adj.getData("dim"),ctx=canvas.getCtx();switch(ctx.beginPath(),ctx.moveTo(begin.x,begin.y),orn){case"left":ctx.quadraticCurveTo(end.x-dim,end.y,end.x,end.y);break;case"right":ctx.quadraticCurveTo(end.x+dim,end.y,end.x,end.y);break;case"top":ctx.quadraticCurveTo(end.x,end.y-dim,end.x,end.y);break;case"bottom":ctx.quadraticCurveTo(end.x,end.y+dim,end.x,end.y)}ctx.stroke()}},bezier:{render:function(adj,canvas){var orn=this.getOrientation(adj),nodeFrom=adj.nodeFrom,nodeTo=adj.nodeTo,rel=nodeFrom._depth<nodeTo._depth,begin=this.viz.geom.getEdge(rel?nodeFrom:nodeTo,"begin",orn),end=this.viz.geom.getEdge(rel?nodeTo:nodeFrom,"end",orn),dim=adj.getData("dim"),ctx=canvas.getCtx();switch(ctx.beginPath(),ctx.moveTo(begin.x,begin.y),orn){case"left":ctx.bezierCurveTo(begin.x+dim,begin.y,end.x-dim,end.y,end.x,end.y);break;case"right":ctx.bezierCurveTo(begin.x-dim,begin.y,end.x+dim,end.y,end.x,end.y);break;case"top":ctx.bezierCurveTo(begin.x,begin.y+dim,end.x,end.y-dim,end.x,end.y);break;case"bottom":ctx.bezierCurveTo(begin.x,begin.y-dim,end.x,end.y+dim,end.x,end.y)}ctx.stroke()}}}),$jit.ST.Plot.NodeTypes.implement({"areachart-stacked":{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,stringArray=node.getData("stringArray"),dimArray=node.getData("dimArray"),valArray=node.getData("valueArray"),valLeft=$.reduce(valArray,function(x,y){return x+y[0]},0),valRight=$.reduce(valArray,function(x,y){return x+y[1]},0),colorArray=node.getData("colorArray"),colorLength=colorArray.length,config=node.getData("config"),gradient=node.getData("gradient"),showLabels=config.showLabels,aggregates=config.showAggregates,label=config.Label,prev=node.getData("prev"),ctx=canvas.getCtx(),border=node.getData("border");if(colorArray&&dimArray&&stringArray){for(var i=0,l=dimArray.length,acumLeft=0,acumRight=0,valAcum=0;l>i;i++){if(ctx.fillStyle=ctx.strokeStyle=colorArray[i%colorLength],ctx.save(),gradient&&(dimArray[i][0]>0||dimArray[i][1]>0)){var h1=acumLeft+dimArray[i][0],h2=acumRight+dimArray[i][1],alpha=Math.atan((h2-h1)/width),delta=55,linear=ctx.createLinearGradient(x+width/2,y-(h1+h2)/2,x+width/2+delta*Math.sin(alpha),y-(h1+h2)/2+delta*Math.cos(alpha)),color=$.rgbToHex($.map($.hexToRgb(colorArray[i%colorLength].slice(1)),function(v){return.85*v>>0}));linear.addColorStop(0,colorArray[i%colorLength]),linear.addColorStop(1,color),ctx.fillStyle=linear}if(ctx.beginPath(),ctx.moveTo(x,y-acumLeft),ctx.lineTo(x+width,y-acumRight),ctx.lineTo(x+width,y-acumRight-dimArray[i][1]),ctx.lineTo(x,y-acumLeft-dimArray[i][0]),ctx.lineTo(x,y-acumLeft),ctx.fill(),ctx.restore(),border){var strong=border.name==stringArray[i],perc=strong?.7:.8,color=$.rgbToHex($.map($.hexToRgb(colorArray[i%colorLength].slice(1)),function(v){return v*perc>>0}));ctx.strokeStyle=color,ctx.lineWidth=strong?4:1,ctx.save(),ctx.beginPath(),0===border.index?(ctx.moveTo(x,y-acumLeft),ctx.lineTo(x,y-acumLeft-dimArray[i][0])):(ctx.moveTo(x+width,y-acumRight),ctx.lineTo(x+width,y-acumRight-dimArray[i][1])),ctx.stroke(),ctx.restore()}acumLeft+=dimArray[i][0]||0,acumRight+=dimArray[i][1]||0,dimArray[i][0]>0&&(valAcum+=valArray[i][0]||0)}if(prev&&"Native"==label.type){ctx.save(),ctx.beginPath(),ctx.fillStyle=ctx.strokeStyle=label.color,ctx.font=label.style+" "+label.size+"px "+label.family,ctx.textAlign="center",ctx.textBaseline="middle";var aggValue=aggregates(node.name,valLeft,valRight,node,valAcum);aggValue!==!1&&ctx.fillText(aggValue!==!0?aggValue:valAcum,x,y-acumLeft-config.labelOffset-label.size/2,width);var labValue=showLabels(node.name,valLeft,valRight,node);labValue!==!1&&ctx.fillText(labValue!==!0?labValue:node.name,x,y+label.size/2+config.labelOffset),ctx.restore()}}},contains:function(node,mpos){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,dimArray=node.getData("dimArray"),rx=mpos.x-x;if(mpos.x<x||mpos.x>x+width||mpos.y>y||mpos.y<y-height)return!1;for(var i=0,l=dimArray.length,lAcum=y,rAcum=y;l>i;i++){var dimi=dimArray[i];lAcum-=dimi[0],rAcum-=dimi[1];var intersec=lAcum+(rAcum-lAcum)*rx/width;if(mpos.y>=intersec){var index=+(rx>width/2);return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i][index],index:index}}}return!1}}}),$jit.AreaChart=new Class({st:null,colors:["#416D9C","#70A35E","#EBB056","#C74243","#83548B","#909291","#557EAA"],selected:{},busy:!1,initialize:function(opt){this.controller=this.config=$.merge(Options("Canvas","Margin","Label","AreaChart"),{Label:{type:"Native"}},opt);var showLabels=this.config.showLabels,typeLabels=$.type(showLabels),showAggregates=this.config.showAggregates,typeAggregates=$.type(showAggregates);this.config.showLabels="function"==typeLabels?showLabels:$.lambda(showLabels),this.config.showAggregates="function"==typeAggregates?showAggregates:$.lambda(showAggregates),this.initializeViz()},initializeViz:function(){var config=this.config,that=this,nodeType=config.type.split(":")[0],nodeLabels={},delegate=new $jit.ST({injectInto:config.injectInto,width:config.width,height:config.height,orientation:"bottom",levelDistance:0,siblingOffset:0,subtreeOffset:0,withLabels:"Native"!=config.Label.type,useCanvas:config.useCanvas,Label:{type:config.Label.type},Node:{overridable:!0,type:"areachart-"+nodeType,align:"left",width:1,height:1},Edge:{type:"none"},Tips:{enable:config.Tips.enable,type:"Native",force:!0,onShow:function(tip,node,contains){var elem=contains;config.Tips.onShow(tip,elem,node)}},Events:{enable:!0,type:"Native",onClick:function(node,eventInfo,evt){if(config.filterOnClick||config.Events.enable){var elem=eventInfo.getContains();elem&&config.filterOnClick&&that.filter(elem.name),config.Events.enable&&config.Events.onClick(elem,eventInfo,evt)}},onRightClick:function(node,eventInfo,evt){config.restoreOnRightClick&&that.restore()},onMouseMove:function(node,eventInfo,evt){if(config.selectOnHover)if(node){var elem=eventInfo.getContains();that.select(node.id,elem.name,elem.index)}else that.select(!1,!1,!1)}},onCreateLabel:function(domElement,node){var labelConf=config.Label,valueArray=node.getData("valueArray"),acumLeft=$.reduce(valueArray,function(x,y){return x+y[0]},0),acumRight=$.reduce(valueArray,function(x,y){return x+y[1]},0);if(node.getData("prev")){var nlbs={wrapper:document.createElement("div"),aggregate:document.createElement("div"),label:document.createElement("div")},wrapper=nlbs.wrapper,label=nlbs.label,aggregate=nlbs.aggregate,wrapperStyle=wrapper.style,labelStyle=label.style,aggregateStyle=aggregate.style;nodeLabels[node.id]=nlbs,wrapper.appendChild(label),wrapper.appendChild(aggregate),config.showLabels(node.name,acumLeft,acumRight,node)||(label.style.display="none"),config.showAggregates(node.name,acumLeft,acumRight,node)||(aggregate.style.display="none"),wrapperStyle.position="relative",wrapperStyle.overflow="visible",wrapperStyle.fontSize=labelConf.size+"px",wrapperStyle.fontFamily=labelConf.family,wrapperStyle.color=labelConf.color,wrapperStyle.textAlign="center",aggregateStyle.position=labelStyle.position="absolute",domElement.style.width=node.getData("width")+"px",domElement.style.height=node.getData("height")+"px",label.innerHTML=node.name,domElement.appendChild(wrapper)}},onPlaceLabel:function(domElement,node){if(node.getData("prev")){{var labels=nodeLabels[node.id],wrapperStyle=labels.wrapper.style,labelStyle=labels.label.style,aggregateStyle=labels.aggregate.style,width=node.getData("width"),dimArray=(node.getData("height"),node.getData("dimArray")),valArray=node.getData("valueArray"),acumLeft=$.reduce(valArray,function(x,y){return x+y[0]},0),acumRight=$.reduce(valArray,function(x,y){return x+y[1]},0),font=parseInt(wrapperStyle.fontSize,10);domElement.style}if(dimArray&&valArray){labelStyle.display=config.showLabels(node.name,acumLeft,acumRight,node)?"":"none";var aggValue=config.showAggregates(node.name,acumLeft,acumRight,node);aggregateStyle.display=aggValue!==!1?"":"none",wrapperStyle.width=aggregateStyle.width=labelStyle.width=domElement.style.width=width+"px",aggregateStyle.left=labelStyle.left=-width/2+"px";for(var i=0,l=valArray.length,acum=0,leftAcum=0;l>i;i++)dimArray[i][0]>0&&(acum+=valArray[i][0],leftAcum+=dimArray[i][0]);aggregateStyle.top=-font-config.labelOffset+"px",labelStyle.top=config.labelOffset+leftAcum+"px",domElement.style.top=parseInt(domElement.style.top,10)-leftAcum+"px",domElement.style.height=wrapperStyle.height=leftAcum+"px",labels.aggregate.innerHTML=aggValue!==!0?aggValue:acum}}}}),size=delegate.canvas.getSize(),margin=config.Margin;delegate.config.offsetY=-size.height/2+margin.bottom+(config.showLabels&&config.labelOffset+config.Label.size),delegate.config.offsetX=(margin.right-margin.left)/2,this.delegate=delegate,this.canvas=this.delegate.canvas},loadJSON:function(json){for(var prefix=$.time(),ch=[],delegate=this.delegate,name=$.splat(json.label),color=$.splat(json.color||this.colors),config=this.config,gradient=!!config.type.split(":")[1],animate=config.animate,i=0,values=json.values,l=values.length;l-1>i;i++){var val=values[i],prev=values[i-1],next=values[i+1],valLeft=$.splat(values[i].values),valRight=$.splat(values[i+1].values),valArray=$.zip(valLeft,valRight);ch.push({id:prefix+val.label,name:val.label,data:{value:valArray,$valueArray:valArray,$colorArray:color,$stringArray:name,$next:next.label,$prev:prev?prev.label:!1,$config:config,$gradient:gradient},children:[]})}var root={id:prefix+"$root",name:"",data:{$type:"none",$width:1,$height:1},children:ch};delegate.loadJSON(root),this.normalizeDims(),delegate.compute(),delegate.select(delegate.root),animate&&delegate.fx.animate({modes:["node-property:height:dimArray"],duration:1500})},updateJSON:function(json,onComplete){if(!this.busy){this.busy=!0;for(var delegate=this.delegate,graph=delegate.graph,labels=json.label&&$.splat(json.label),values=json.values,animate=this.config.animate,that=this,hashValues={},i=0,l=values.length;l>i;i++)hashValues[values[i].label]=values[i];graph.eachNode(function(n){var v=hashValues[n.name],stringArray=n.getData("stringArray"),valArray=n.getData("valueArray"),next=n.getData("next");v&&(v.values=$.splat(v.values),$.each(valArray,function(a,i){a[0]=v.values[i],labels&&(stringArray[i]=labels[i])}),n.setData("valueArray",valArray)),next&&(v=hashValues[next],v&&$.each(valArray,function(a,i){a[1]=v.values[i]}))}),this.normalizeDims(),delegate.compute(),delegate.select(delegate.root),animate&&delegate.fx.animate({modes:["node-property:height:dimArray"],duration:1500,onComplete:function(){that.busy=!1,onComplete&&onComplete.onComplete()}})}},filter:function(filters,callback){if(!this.busy){this.busy=!0,this.config.Tips.enable&&this.delegate.tips.hide(),this.select(!1,!1,!1);var args=$.splat(filters),rt=this.delegate.graph.getNode(this.delegate.root),that=this;this.normalizeDims(),rt.eachAdjacency(function(adj){var n=adj.nodeTo,dimArray=n.getData("dimArray","end"),stringArray=n.getData("stringArray");n.setData("dimArray",$.map(dimArray,function(d,i){return $.indexOf(args,stringArray[i])>-1?d:[0,0]}),"end")}),this.delegate.fx.animate({modes:["node-property:dimArray"],duration:1500,onComplete:function(){that.busy=!1,callback&&callback.onComplete()}})}},restore:function(callback){if(!this.busy){this.busy=!0,this.config.Tips.enable&&this.delegate.tips.hide(),this.select(!1,!1,!1),this.normalizeDims();var that=this;this.delegate.fx.animate({modes:["node-property:height:dimArray"],duration:1500,onComplete:function(){that.busy=!1,callback&&callback.onComplete()}})}},select:function(id,name,index){if(this.config.selectOnHover){var s=this.selected;if(s.id!=id||s.name!=name||s.index!=index){if(s.id=id,s.name=name,s.index=index,this.delegate.graph.eachNode(function(n){n.setData("border",!1)}),id){var n=this.delegate.graph.getNode(id);n.setData("border",s);var link=0===index?"prev":"next";link=n.getData(link),link&&(n=this.delegate.graph.getByName(link),n&&n.setData("border",{name:name,index:1-index}))}this.delegate.plot()}}},getLegend:function(){var n,legend={};this.delegate.graph.getNode(this.delegate.root).eachAdjacency(function(adj){n=adj.nodeTo});var colors=n.getData("colorArray"),len=colors.length;return $.each(n.getData("stringArray"),function(s,i){legend[s]=colors[i%len]}),legend},getMaxValue:function(){var maxValue=0;return this.delegate.graph.eachNode(function(n){var valArray=n.getData("valueArray"),acumLeft=0,acumRight=0;$.each(valArray,function(v){acumLeft+=+v[0],acumRight+=+v[1]});var acum=acumRight>acumLeft?acumRight:acumLeft;maxValue=maxValue>acum?maxValue:acum}),maxValue},normalizeDims:function(){var root=this.delegate.graph.getNode(this.delegate.root),l=0;root.eachAdjacency(function(){l++});var maxValue=this.getMaxValue()||1,size=this.delegate.canvas.getSize(),config=this.config,margin=config.Margin,labelOffset=config.labelOffset+config.Label.size,fixedDim=(size.width-(margin.left+margin.right))/l,animate=config.animate,height=size.height-(margin.top+margin.bottom)-(config.showAggregates&&labelOffset)-(config.showLabels&&labelOffset);this.delegate.graph.eachNode(function(n){var acumLeft=0,acumRight=0,animateValue=[];$.each(n.getData("valueArray"),function(v){acumLeft+=+v[0],acumRight+=+v[1],animateValue.push([0,0])});var acum=acumRight>acumLeft?acumRight:acumLeft;if(n.setData("width",fixedDim),animate){n.setData("height",acum*height/maxValue,"end"),n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return[n[0]*height/maxValue,n[1]*height/maxValue]}),"end");var dimArray=n.getData("dimArray");dimArray||n.setData("dimArray",animateValue)}else n.setData("height",acum*height/maxValue),n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return[n[0]*height/maxValue,n[1]*height/maxValue]}))})}}),Options.BarChart={$extend:!0,animate:!0,type:"stacked",labelOffset:3,barsOffset:0,hoveredColor:"#9fd4ff",orientation:"horizontal",showAggregates:!0,showLabels:!0,Tips:{enable:!1,onShow:$.empty,onHide:$.empty},Events:{enable:!1,onClick:$.empty}},$jit.ST.Plot.NodeTypes.implement({"barchart-stacked":{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,dimArray=node.getData("dimArray"),valueArray=node.getData("valueArray"),colorArray=node.getData("colorArray"),colorLength=colorArray.length,stringArray=node.getData("stringArray"),ctx=canvas.getCtx(),opt={},border=node.getData("border"),gradient=node.getData("gradient"),config=node.getData("config"),horz="horizontal"==config.orientation,aggregates=config.showAggregates,showLabels=config.showLabels,label=config.Label;if(colorArray&&dimArray&&stringArray){for(var i=0,l=dimArray.length,acum=0,valAcum=0;l>i;i++){if(ctx.fillStyle=ctx.strokeStyle=colorArray[i%colorLength],gradient){var linear;linear=horz?ctx.createLinearGradient(x+acum+dimArray[i]/2,y,x+acum+dimArray[i]/2,y+height):ctx.createLinearGradient(x,y-acum-dimArray[i]/2,x+width,y-acum-dimArray[i]/2);var color=$.rgbToHex($.map($.hexToRgb(colorArray[i%colorLength].slice(1)),function(v){return.5*v>>0}));linear.addColorStop(0,color),linear.addColorStop(.5,colorArray[i%colorLength]),linear.addColorStop(1,color),ctx.fillStyle=linear}horz?ctx.fillRect(x+acum,y,dimArray[i],height):ctx.fillRect(x,y-acum-dimArray[i],width,dimArray[i]),border&&border.name==stringArray[i]&&(opt.acum=acum,opt.dimValue=dimArray[i]),acum+=dimArray[i]||0,valAcum+=valueArray[i]||0}if(border&&(ctx.save(),ctx.lineWidth=2,ctx.strokeStyle=border.color,horz?ctx.strokeRect(x+opt.acum+1,y+1,opt.dimValue-2,height-2):ctx.strokeRect(x+1,y-opt.acum-opt.dimValue+1,width-2,opt.dimValue-2),ctx.restore()),"Native"==label.type){ctx.save(),ctx.fillStyle=ctx.strokeStyle=label.color,ctx.font=label.style+" "+label.size+"px "+label.family,ctx.textBaseline="middle";var aggValue=aggregates(node.name,valAcum,node);aggValue!==!1&&(aggValue=aggValue!==!0?aggValue:valAcum,horz?(ctx.textAlign="right",ctx.fillText(aggValue,x+acum-config.labelOffset,y+height/2)):(ctx.textAlign="center",ctx.fillText(aggValue,x+width/2,y-height-label.size/2-config.labelOffset))),showLabels(node.name,valAcum,node)&&(horz?(ctx.textAlign="center",ctx.translate(x-config.labelOffset-label.size/2,y+height/2),ctx.rotate(Math.PI/2),ctx.fillText(node.name,0,0)):(ctx.textAlign="center",ctx.fillText(node.name,x+width/2,y+label.size/2+config.labelOffset))),ctx.restore()}}},contains:function(node,mpos){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,dimArray=node.getData("dimArray"),config=node.getData("config"),horz=(mpos.x-x,"horizontal"==config.orientation);if(horz){if(mpos.x<x||mpos.x>x+width||mpos.y>y+height||mpos.y<y)return!1}else if(mpos.x<x||mpos.x>x+width||mpos.y>y||mpos.y<y-height)return!1;for(var i=0,l=dimArray.length,acum=horz?x:y;l>i;i++){var dimi=dimArray[i];if(horz){acum+=dimi;var intersec=acum;if(mpos.x<=intersec)return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i],label:node.name}}else{acum-=dimi;var intersec=acum;if(mpos.y>=intersec)return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i],label:node.name}}}return!1}},"barchart-grouped":{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,dimArray=node.getData("dimArray"),valueArray=node.getData("valueArray"),valueLength=valueArray.length,colorArray=node.getData("colorArray"),colorLength=colorArray.length,stringArray=node.getData("stringArray"),ctx=canvas.getCtx(),opt={},border=node.getData("border"),gradient=node.getData("gradient"),config=node.getData("config"),horz="horizontal"==config.orientation,aggregates=config.showAggregates,showLabels=config.showLabels,label=config.Label,fixedDim=(horz?height:width)/valueLength;if(colorArray&&dimArray&&stringArray){for(var i=0,l=valueLength,acum=0,valAcum=0;l>i;i++){if(ctx.fillStyle=ctx.strokeStyle=colorArray[i%colorLength],gradient){var linear;linear=horz?ctx.createLinearGradient(x+dimArray[i]/2,y+fixedDim*i,x+dimArray[i]/2,y+fixedDim*(i+1)):ctx.createLinearGradient(x+fixedDim*i,y-dimArray[i]/2,x+fixedDim*(i+1),y-dimArray[i]/2);var color=$.rgbToHex($.map($.hexToRgb(colorArray[i%colorLength].slice(1)),function(v){return.5*v>>0}));linear.addColorStop(0,color),linear.addColorStop(.5,colorArray[i%colorLength]),linear.addColorStop(1,color),ctx.fillStyle=linear}horz?ctx.fillRect(x,y+fixedDim*i,dimArray[i],fixedDim):ctx.fillRect(x+fixedDim*i,y-dimArray[i],fixedDim,dimArray[i]),border&&border.name==stringArray[i]&&(opt.acum=fixedDim*i,opt.dimValue=dimArray[i]),acum+=dimArray[i]||0,valAcum+=valueArray[i]||0}if(border&&(ctx.save(),ctx.lineWidth=2,ctx.strokeStyle=border.color,horz?ctx.strokeRect(x+1,y+opt.acum+1,opt.dimValue-2,fixedDim-2):ctx.strokeRect(x+opt.acum+1,y-opt.dimValue+1,fixedDim-2,opt.dimValue-2),ctx.restore()),"Native"==label.type){ctx.save(),ctx.fillStyle=ctx.strokeStyle=label.color,ctx.font=label.style+" "+label.size+"px "+label.family,ctx.textBaseline="middle";var aggValue=aggregates(node.name,valAcum,node);aggValue!==!1&&(aggValue=aggValue!==!0?aggValue:valAcum,horz?(ctx.textAlign="right",ctx.fillText(aggValue,x+Math.max.apply(null,dimArray)-config.labelOffset,y+height/2)):(ctx.textAlign="center",ctx.fillText(aggValue,x+width/2,y-Math.max.apply(null,dimArray)-label.size/2-config.labelOffset)));var labValue=showLabels(node.name,valAcum,node);labValue!==!1&&(labValue=labValue!==!0?labValue:node.name,horz?(ctx.textAlign="center",ctx.translate(x-config.labelOffset-label.size/2,y+height/2),ctx.rotate(Math.PI/2),ctx.fillText(labValue,0,0)):(ctx.textAlign="center",ctx.fillText(labValue,x+width/2,y+label.size/2+config.labelOffset))),ctx.restore()}}},contains:function(node,mpos){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),algnPos=this.getAlignedPos(pos,width,height),x=algnPos.x,y=algnPos.y,dimArray=node.getData("dimArray"),len=dimArray.length,config=node.getData("config"),horz=(mpos.x-x,"horizontal"==config.orientation),fixedDim=(horz?height:width)/len;if(horz){if(mpos.x<x||mpos.x>x+width||mpos.y>y+height||mpos.y<y)return!1}else if(mpos.x<x||mpos.x>x+width||mpos.y>y||mpos.y<y-height)return!1;for(var i=0,l=dimArray.length;l>i;i++){var dimi=dimArray[i];if(horz){var limit=y+fixedDim*i;if(mpos.x<=x+dimi&&mpos.y>=limit&&mpos.y<=limit+fixedDim)return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i],label:node.name}}else{var limit=x+fixedDim*i;if(mpos.x>=limit&&mpos.x<=limit+fixedDim&&mpos.y>=y-dimi)return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i],label:node.name}}}return!1}}}),$jit.BarChart=new Class({st:null,colors:["#416D9C","#70A35E","#EBB056","#C74243","#83548B","#909291","#557EAA"],selected:{},busy:!1,initialize:function(opt){this.controller=this.config=$.merge(Options("Canvas","Margin","Label","BarChart"),{Label:{type:"Native"}},opt);var showLabels=this.config.showLabels,typeLabels=$.type(showLabels),showAggregates=this.config.showAggregates,typeAggregates=$.type(showAggregates);this.config.showLabels="function"==typeLabels?showLabels:$.lambda(showLabels),this.config.showAggregates="function"==typeAggregates?showAggregates:$.lambda(showAggregates),this.initializeViz()},initializeViz:function(){var config=this.config,that=this,nodeType=config.type.split(":")[0],horz="horizontal"==config.orientation,nodeLabels={},delegate=new $jit.ST({injectInto:config.injectInto,width:config.width,height:config.height,orientation:horz?"left":"bottom",levelDistance:0,siblingOffset:config.barsOffset,subtreeOffset:0,withLabels:"Native"!=config.Label.type,useCanvas:config.useCanvas,Label:{type:config.Label.type},Node:{overridable:!0,type:"barchart-"+nodeType,align:"left",width:1,height:1},Edge:{type:"none"},Tips:{enable:config.Tips.enable,type:"Native",force:!0,onShow:function(tip,node,contains){var elem=contains;config.Tips.onShow(tip,elem,node)}},Events:{enable:!0,type:"Native",onClick:function(node,eventInfo,evt){if(config.Events.enable){var elem=eventInfo.getContains();config.Events.onClick(elem,eventInfo,evt)}},onMouseMove:function(node,eventInfo,evt){if(config.hoveredColor)if(node){var elem=eventInfo.getContains();that.select(node.id,elem.name,elem.index)}else that.select(!1,!1,!1)}},onCreateLabel:function(domElement,node){var labelConf=config.Label,valueArray=node.getData("valueArray"),acum=$.reduce(valueArray,function(x,y){return x+y},0),nlbs={wrapper:document.createElement("div"),aggregate:document.createElement("div"),label:document.createElement("div")},wrapper=nlbs.wrapper,label=nlbs.label,aggregate=nlbs.aggregate,wrapperStyle=wrapper.style,labelStyle=label.style,aggregateStyle=aggregate.style;nodeLabels[node.id]=nlbs,wrapper.appendChild(label),wrapper.appendChild(aggregate),config.showLabels(node.name,acum,node)||(labelStyle.display="none"),config.showAggregates(node.name,acum,node)||(aggregateStyle.display="none"),wrapperStyle.position="relative",
wrapperStyle.overflow="visible",wrapperStyle.fontSize=labelConf.size+"px",wrapperStyle.fontFamily=labelConf.family,wrapperStyle.color=labelConf.color,wrapperStyle.textAlign="center",aggregateStyle.position=labelStyle.position="absolute",domElement.style.width=node.getData("width")+"px",domElement.style.height=node.getData("height")+"px",aggregateStyle.left=labelStyle.left="0px",label.innerHTML=node.name,domElement.appendChild(wrapper)},onPlaceLabel:function(domElement,node){if(nodeLabels[node.id]){{var labels=nodeLabels[node.id],wrapperStyle=labels.wrapper.style,labelStyle=labels.label.style,aggregateStyle=labels.aggregate.style,grouped="grouped"==config.type.split(":")[0],horz="horizontal"==config.orientation,dimArray=node.getData("dimArray"),valArray=node.getData("valueArray"),width=grouped&&horz?Math.max.apply(null,dimArray):node.getData("width"),height=grouped&&!horz?Math.max.apply(null,dimArray):node.getData("height"),font=parseInt(wrapperStyle.fontSize,10);domElement.style}if(dimArray&&valArray){wrapperStyle.width=aggregateStyle.width=labelStyle.width=domElement.style.width=width+"px";for(var i=0,l=valArray.length,acum=0;l>i;i++)dimArray[i]>0&&(acum+=valArray[i]);labelStyle.display=config.showLabels(node.name,acum,node)?"":"none";var aggValue=config.showAggregates(node.name,acum,node);aggregateStyle.display=aggValue!==!1?"":"none","horizontal"==config.orientation?(aggregateStyle.textAlign="right",labelStyle.textAlign="left",labelStyle.textIndex=aggregateStyle.textIndent=config.labelOffset+"px",aggregateStyle.top=labelStyle.top=(height-font)/2+"px",domElement.style.height=wrapperStyle.height=height+"px"):(aggregateStyle.top=-font-config.labelOffset+"px",labelStyle.top=config.labelOffset+height+"px",domElement.style.top=parseInt(domElement.style.top,10)-height+"px",domElement.style.height=wrapperStyle.height=height+"px"),labels.aggregate.innerHTML=aggValue!==!0?aggValue:acum}}}}),size=delegate.canvas.getSize(),margin=config.Margin;horz?(delegate.config.offsetX=size.width/2-margin.left-(config.showLabels&&config.labelOffset+config.Label.size),delegate.config.offsetY=(margin.bottom-margin.top)/2):(delegate.config.offsetY=-size.height/2+margin.bottom+(config.showLabels&&config.labelOffset+config.Label.size),delegate.config.offsetX=(margin.right-margin.left)/2),this.delegate=delegate,this.canvas=this.delegate.canvas},loadJSON:function(json){if(!this.busy){this.busy=!0;for(var prefix=$.time(),ch=[],delegate=this.delegate,name=$.splat(json.label),color=$.splat(json.color||this.colors),config=this.config,gradient=!!config.type.split(":")[1],animate=config.animate,horz="horizontal"==config.orientation,that=this,i=0,values=json.values,l=values.length;l>i;i++){var val=values[i],valArray=$.splat(values[i].values);"undefined"==typeof val.id&&(val.id=val.label),ch.push({id:prefix+val.id,name:val.label,data:{value:valArray,$valueArray:valArray,$colorArray:color,$stringArray:name,$gradient:gradient,$config:config},children:[]})}var root={id:prefix+"$root",name:"",data:{$type:"none",$width:1,$height:1},children:ch};delegate.loadJSON(root),this.normalizeDims(),delegate.compute(),delegate.select(delegate.root),animate?delegate.fx.animate(horz?{modes:["node-property:width:dimArray"],duration:1500,onComplete:function(){that.busy=!1}}:{modes:["node-property:height:dimArray"],duration:1500,onComplete:function(){that.busy=!1}}):this.busy=!1}},updateJSON:function(json,onComplete){if(!this.busy){this.busy=!0,this.select(!1,!1,!1);var delegate=this.delegate,graph=delegate.graph,values=json.values,animate=this.config.animate,that=this,horz="horizontal"==this.config.orientation;$.each(values,function(v){var n=graph.getByName(v.label);n&&(n.setData("valueArray",$.splat(v.values)),json.label&&n.setData("stringArray",$.splat(json.label)))}),this.normalizeDims(),delegate.compute(),delegate.select(delegate.root),animate&&delegate.fx.animate(horz?{modes:["node-property:width:dimArray"],duration:1500,onComplete:function(){that.busy=!1,onComplete&&onComplete.onComplete()}}:{modes:["node-property:height:dimArray"],duration:1500,onComplete:function(){that.busy=!1,onComplete&&onComplete.onComplete()}})}},select:function(id,name){if(this.config.hoveredColor){var s=this.selected;(s.id!=id||s.name!=name)&&(s.id=id,s.name=name,s.color=this.config.hoveredColor,this.delegate.graph.eachNode(function(n){id==n.id?n.setData("border",s):n.setData("border",!1)}),this.delegate.plot())}},getLegend:function(){var n,legend={};this.delegate.graph.getNode(this.delegate.root).eachAdjacency(function(adj){n=adj.nodeTo});var colors=n.getData("colorArray"),len=colors.length;return $.each(n.getData("stringArray"),function(s,i){legend[s]=colors[i%len]}),legend},getMaxValue:function(){var maxValue=0,stacked="stacked"==this.config.type.split(":")[0];return this.delegate.graph.eachNode(function(n){var valArray=n.getData("valueArray"),acum=0;valArray&&(stacked?$.each(valArray,function(v){acum+=+v}):acum=Math.max.apply(null,valArray),maxValue=maxValue>acum?maxValue:acum)}),maxValue},setBarType:function(type){this.config.type=type,this.delegate.config.Node.type="barchart-"+type.split(":")[0]},normalizeDims:function(){var root=this.delegate.graph.getNode(this.delegate.root),l=0;root.eachAdjacency(function(){l++});var maxValue=this.getMaxValue()||1,size=this.delegate.canvas.getSize(),config=this.config,margin=config.Margin,marginWidth=margin.left+margin.right,marginHeight=margin.top+margin.bottom,horz="horizontal"==config.orientation,fixedDim=(size[horz?"height":"width"]-(horz?marginHeight:marginWidth)-(l-1)*config.barsOffset)/l,animate=config.animate,height=size[horz?"width":"height"]-(horz?marginWidth:marginHeight)-(!horz&&config.showAggregates&&config.Label.size+config.labelOffset)-(config.showLabels&&config.Label.size+config.labelOffset),dim1=horz?"height":"width",dim2=horz?"width":"height";this.delegate.graph.eachNode(function(n){var acum=0,animateValue=[];if($.each(n.getData("valueArray"),function(v){acum+=+v,animateValue.push(0)}),n.setData(dim1,fixedDim),animate){n.setData(dim2,acum*height/maxValue,"end"),n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return n*height/maxValue}),"end");var dimArray=n.getData("dimArray");dimArray||n.setData("dimArray",animateValue)}else n.setData(dim2,acum*height/maxValue),n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return n*height/maxValue}))})}}),Options.PieChart={$extend:!0,animate:!0,offset:25,sliceOffset:0,labelOffset:3,type:"stacked",hoveredColor:"#9fd4ff",Events:{enable:!1,onClick:$.empty},Tips:{enable:!1,onShow:$.empty,onHide:$.empty},showLabels:!0,resizeLabels:!1,updateHeights:!1},Layouts.Radial=new Class({compute:function(property){var prop=$.splat(property||["current","start","end"]);NodeDim.compute(this.graph,prop,this.config),this.graph.computeLevels(this.root,0,"ignore");var lengthFunc=this.createLevelDistanceFunc();this.computeAngularWidths(prop),this.computePositions(prop,lengthFunc)},computePositions:function(property,getLength){for(var propArray=property,graph=this.graph,root=graph.getNode(this.root),parent=this.parent,i=(this.config,0),l=propArray.length;l>i;i++){var pi=propArray[i];root.setPos($P(0,0),pi),root.setData("span",2*Math.PI,pi)}root.angleSpan={begin:0,end:2*Math.PI},graph.eachBFS(this.root,function(elem){var angleSpan=elem.angleSpan.end-elem.angleSpan.begin,angleInit=elem.angleSpan.begin,len=getLength(elem),totalAngularWidths=0,subnodes=[],maxDim={};elem.eachSubnode(function(sib){totalAngularWidths+=sib._treeAngularWidth;for(var i=0,l=propArray.length;l>i;i++){var pi=propArray[i],dim=sib.getData("dim",pi);maxDim[pi]=pi in maxDim?dim>maxDim[pi]?dim:maxDim[pi]:dim}subnodes.push(sib)},"ignore"),parent&&parent.id==elem.id&&subnodes.length>0&&subnodes[0].dist&&subnodes.sort(function(a,b){return(a.dist>=b.dist)-(a.dist<=b.dist)});for(var k=0,ls=subnodes.length;ls>k;k++){var child=subnodes[k];if(!child._flag){for(var angleProportion=child._treeAngularWidth/totalAngularWidths*angleSpan,theta=angleInit+angleProportion/2,i=0,l=propArray.length;l>i;i++){var pi=propArray[i];child.setPos($P(theta,len),pi),child.setData("span",angleProportion,pi),child.setData("dim-quotient",child.getData("dim",pi)/maxDim[pi],pi)}child.angleSpan={begin:angleInit,end:angleInit+angleProportion},angleInit+=angleProportion}}},"ignore")},setAngularWidthForNodes:function(prop){this.graph.eachBFS(this.root,function(elem,i){var diamValue=elem.getData("angularWidth",prop[0])||5;elem._angularWidth=diamValue/i},"ignore")},setSubtreesAngularWidth:function(){var that=this;this.graph.eachNode(function(elem){that.setSubtreeAngularWidth(elem)},"ignore")},setSubtreeAngularWidth:function(elem){var that=this,nodeAW=elem._angularWidth,sumAW=0;elem.eachSubnode(function(child){that.setSubtreeAngularWidth(child),sumAW+=child._treeAngularWidth},"ignore"),elem._treeAngularWidth=Math.max(nodeAW,sumAW)},computeAngularWidths:function(prop){this.setAngularWidthForNodes(prop),this.setSubtreesAngularWidth()}}),$jit.Sunburst=new Class({Implements:[Loader,Extras,Layouts.Radial],initialize:function(controller){var $Sunburst=$jit.Sunburst,config={interpolation:"linear",levelDistance:100,Node:{type:"multipie",height:0},Edge:{type:"none"},Label:{textAlign:"start",textBaseline:"middle"}};this.controller=this.config=$.merge(Options("Canvas","Node","Edge","Fx","Tips","NodeStyles","Events","Navigation","Controller","Label"),config,controller);var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Polar,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new $Sunburst.Label[canvasConfig.Label.type](this),this.fx=new $Sunburst.Plot(this,$Sunburst),this.op=new $Sunburst.Op(this),this.json=null,this.root=null,this.rotated=null,this.busy=!1,this.initializeExtras()},createLevelDistanceFunc:function(){var ld=this.config.levelDistance;return function(elem){return(elem._depth+1)*ld}},refresh:function(){this.compute(),this.plot()},reposition:function(){this.compute("end")},rotate:function(node,method,opt){var theta=node.getPos(opt.property||"current").getp(!0).theta;this.rotated=node,this.rotateAngle(-theta,method,opt)},rotateAngle:function(theta,method,opt){var options=$.merge(this.config,opt||{},{modes:["polar"]}),prop=opt.property||("animate"===method?"end":"current");"animate"===method&&this.fx.animation.pause(),this.graph.eachNode(function(n){var p=n.getPos(prop);p.theta+=theta,p.theta<0&&(p.theta+=2*Math.PI)}),"animate"==method?this.fx.animate(options):"replot"==method&&(this.fx.plot(),this.busy=!1)},plot:function(){this.fx.plot()}}),$jit.Sunburst.$extend=!0,function(Sunburst){Sunburst.Op=new Class({Implements:Graph.Op}),Sunburst.Plot=new Class({Implements:Graph.Plot}),Sunburst.Label={},Sunburst.Label.Native=new Class({Implements:Graph.Label.Native,initialize:function(viz){this.viz=viz,this.label=viz.config.Label,this.config=viz.config},renderLabel:function(canvas,node,controller){var span=node.getData("span");if(!(span<Math.PI/2&&Math.tan(span)*this.config.levelDistance*node._depth<10)){var ctx=canvas.getCtx(),measure=ctx.measureText(node.name);if(node.id==this.viz.root)var x=-measure.width/2,y=0,thetap=0;else{var indent=5,clone=(controller.levelDistance-indent,node.pos.clone());clone.rho+=indent;var p=clone.getp(!0),ct=clone.getc(!0),x=ct.x,y=ct.y,pi=Math.PI,cond=p.theta>pi/2&&p.theta<3*pi/2,thetap=cond?p.theta+pi:p.theta;cond?(x-=Math.abs(Math.cos(p.theta)*measure.width),y+=Math.sin(p.theta)*measure.width):node.id==this.viz.root&&(x-=measure.width/2)}ctx.save(),ctx.translate(x,y),ctx.rotate(thetap),ctx.fillText(node.name,0,0),ctx.restore()}}}),Sunburst.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),viz=this.viz,canvas=this.viz.canvas,radius=canvas.getSize(),labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y);var bb=tag.getBBox();if(bb){var x=tag.getAttribute("x"),y=tag.getAttribute("y"),p=node.pos.getp(!0),pi=Math.PI,cond=p.theta>pi/2&&p.theta<3*pi/2;cond?(tag.setAttribute("x",x-bb.width),tag.setAttribute("y",y-bb.height)):node.id==viz.root&&tag.setAttribute("x",x-bb.width/2);var thetap=cond?p.theta+pi:p.theta;node._depth&&tag.setAttribute("transform","rotate("+360*thetap/(2*pi)+" "+x+" "+y+")")}controller.onPlaceLabel(tag,node)}}),Sunburst.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.clone(),canvas=this.viz.canvas,height=node.getData("height"),ldist=(height||0==node._depth?height:this.viz.config.levelDistance)/2,radius=canvas.getSize();pos.rho+=ldist,pos=pos.getc(!0);var labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),Sunburst.Plot.NodeTypes=new Class({none:{render:$.empty,contains:$.lambda(!1),anglecontains:function(node,pos){var span=node.getData("span")/2,theta=node.pos.theta,begin=theta-span,end=theta+span;0>begin&&(begin+=2*Math.PI);var atan=Math.atan2(pos.y,pos.x);return 0>atan&&(atan+=2*Math.PI),begin>end?atan>begin&&atan<=2*Math.PI||end>atan:atan>begin&&end>atan}},pie:{render:function(node,canvas){var span=node.getData("span")/2,theta=node.pos.theta,begin=theta-span,end=theta+span,polarNode=node.pos.getp(!0),polar=new Polar(polarNode.rho,begin),p1coord=polar.getc(!0);polar.theta=end;var p2coord=polar.getc(!0),ctx=canvas.getCtx();ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(p1coord.x,p1coord.y),ctx.moveTo(0,0),ctx.lineTo(p2coord.x,p2coord.y),ctx.moveTo(0,0),ctx.arc(0,0,polarNode.rho*node.getData("dim-quotient"),begin,end,!1),ctx.fill()},contains:function(node,pos){if(this.nodeTypes.none.anglecontains.call(this,node,pos)){var rho=Math.sqrt(pos.x*pos.x+pos.y*pos.y),ld=this.config.levelDistance,d=node._depth;return ld*d>=rho}return!1}},multipie:{render:function(node,canvas){var height=node.getData("height"),ldist=height?height:this.config.levelDistance,span=node.getData("span")/2,theta=node.pos.theta,begin=theta-span,end=theta+span,polarNode=node.pos.getp(!0),polar=new Polar(polarNode.rho,begin),p1coord=polar.getc(!0);polar.theta=end;var p2coord=polar.getc(!0);polar.rho+=ldist;var p3coord=polar.getc(!0);polar.theta=begin;var p4coord=polar.getc(!0),ctx=canvas.getCtx();ctx.moveTo(0,0),ctx.beginPath(),ctx.arc(0,0,polarNode.rho,begin,end,!1),ctx.arc(0,0,polarNode.rho+ldist,end,begin,!0),ctx.moveTo(p1coord.x,p1coord.y),ctx.lineTo(p4coord.x,p4coord.y),ctx.moveTo(p2coord.x,p2coord.y),ctx.lineTo(p3coord.x,p3coord.y),ctx.fill(),node.collapsed&&(ctx.save(),ctx.lineWidth=2,ctx.moveTo(0,0),ctx.beginPath(),ctx.arc(0,0,polarNode.rho+ldist+5,end-.01,begin+.01,!0),ctx.stroke(),ctx.restore())},contains:function(node,pos){if(this.nodeTypes.none.anglecontains.call(this,node,pos)){var rho=Math.sqrt(pos.x*pos.x+pos.y*pos.y),height=node.getData("height"),ldist=height?height:this.config.levelDistance,ld=this.config.levelDistance,d=node._depth;return rho>=ld*d&&ld*d+ldist>=rho}return!1}},"gradient-multipie":{render:function(node,canvas){var ctx=canvas.getCtx(),height=node.getData("height"),ldist=height?height:this.config.levelDistance,radialGradient=ctx.createRadialGradient(0,0,node.getPos().rho,0,0,node.getPos().rho+ldist),colorArray=$.hexToRgb(node.getData("color")),ans=[];$.each(colorArray,function(i){ans.push(parseInt(.5*i,10))});var endColor=$.rgbToHex(ans);radialGradient.addColorStop(0,endColor),radialGradient.addColorStop(1,node.getData("color")),ctx.fillStyle=radialGradient,this.nodeTypes.multipie.render.call(this,node,canvas)},contains:function(node,pos){return this.nodeTypes.multipie.contains.call(this,node,pos)}},"gradient-pie":{render:function(node,canvas){var ctx=canvas.getCtx(),radialGradient=ctx.createRadialGradient(0,0,0,0,0,node.getPos().rho),colorArray=$.hexToRgb(node.getData("color")),ans=[];$.each(colorArray,function(i){ans.push(parseInt(.5*i,10))});var endColor=$.rgbToHex(ans);radialGradient.addColorStop(1,endColor),radialGradient.addColorStop(0,node.getData("color")),ctx.fillStyle=radialGradient,this.nodeTypes.pie.render.call(this,node,canvas)},contains:function(node,pos){return this.nodeTypes.pie.contains.call(this,node,pos)}}}),Sunburst.Plot.EdgeTypes=new Class({none:$.empty,line:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);this.edgeHelper.line.render(from,to,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.line.contains(from,to,pos,this.edge.epsilon)}},arrow:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),dim=adj.getData("dim"),direction=adj.data.$direction,inv=direction&&direction.length>1&&direction[0]!=adj.nodeFrom.id;this.edgeHelper.arrow.render(from,to,dim,inv,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.arrow.contains(from,to,pos,this.edge.epsilon)}},hyperline:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(),to=adj.nodeTo.pos.getc(),dim=Math.max(from.norm(),to.norm());this.edgeHelper.hyperline.render(from.$scale(1/dim),to.$scale(1/dim),dim,canvas)},contains:$.lambda(!1)}})}($jit.Sunburst),$jit.Sunburst.Plot.NodeTypes.implement({"piechart-stacked":{render:function(node,canvas){var dimArray=(node.pos.getp(!0),node.getData("dimArray")),valueArray=node.getData("valueArray"),colorArray=node.getData("colorArray"),colorLength=colorArray.length,stringArray=node.getData("stringArray"),span=node.getData("span")/2,theta=node.pos.theta,begin=theta-span,end=theta+span,polar=new Polar,ctx=canvas.getCtx(),opt={},gradient=node.getData("gradient"),border=node.getData("border"),config=node.getData("config"),showLabels=config.showLabels,resizeLabels=config.resizeLabels,label=config.Label,xpos=config.sliceOffset*Math.cos((begin+end)/2),ypos=config.sliceOffset*Math.sin((begin+end)/2);if(colorArray&&dimArray&&stringArray){for(var i=0,l=dimArray.length,acum=0,valAcum=0;l>i;i++){var dimi=dimArray[i],colori=colorArray[i%colorLength];if(!(0>=dimi)){if(ctx.fillStyle=ctx.strokeStyle=colori,gradient&&dimi){var radialGradient=ctx.createRadialGradient(xpos,ypos,acum+config.sliceOffset,xpos,ypos,acum+dimi+config.sliceOffset),colorRgb=$.hexToRgb(colori),ans=$.map(colorRgb,function(i){return.8*i>>0}),endColor=$.rgbToHex(ans);radialGradient.addColorStop(0,colori),radialGradient.addColorStop(.5,colori),radialGradient.addColorStop(1,endColor),ctx.fillStyle=radialGradient}polar.rho=acum+config.sliceOffset,polar.theta=begin;{polar.getc(!0)}polar.theta=end;{polar.getc(!0)}polar.rho+=dimi;{polar.getc(!0)}polar.theta=begin;{polar.getc(!0)}ctx.beginPath(),ctx.arc(xpos,ypos,acum+.01,begin,end,!1),ctx.arc(xpos,ypos,acum+dimi+.01,end,begin,!0),ctx.fill(),border&&border.name==stringArray[i]&&(opt.acum=acum,opt.dimValue=dimArray[i],opt.begin=begin,opt.end=end),acum+=dimi||0,valAcum+=valueArray[i]||0}}if(border){ctx.save(),ctx.globalCompositeOperation="source-over",ctx.lineWidth=2,ctx.strokeStyle=border.color;ctx.beginPath(),ctx.arc(xpos,ypos,opt.acum+.01+1,opt.begin,opt.end,!1),ctx.arc(xpos,ypos,opt.acum+opt.dimValue+.01-1,opt.end,opt.begin,!0),ctx.closePath(),ctx.stroke(),ctx.restore()}if(showLabels&&"Native"==label.type){ctx.save(),ctx.fillStyle=ctx.strokeStyle=label.color;var scale=resizeLabels?node.getData("normalizedDim"):1,fontSize=label.size*scale>>0;fontSize=+resizeLabels>fontSize?+resizeLabels:fontSize,ctx.font=label.style+" "+fontSize+"px "+label.family,ctx.textBaseline="middle",ctx.textAlign="center",polar.rho=acum+config.labelOffset+config.sliceOffset,polar.theta=node.pos.theta;var cart=polar.getc(!0);ctx.fillText(node.name,cart.x,cart.y),ctx.restore()}}},contains:function(node,pos){if(this.nodeTypes.none.anglecontains.call(this,node,pos)){var rho=Math.sqrt(pos.x*pos.x+pos.y*pos.y),ld=this.config.levelDistance,d=node._depth,config=node.getData("config");if(rho<=ld*d+config.sliceOffset)for(var dimArray=node.getData("dimArray"),i=0,l=dimArray.length,acum=config.sliceOffset;l>i;i++){var dimi=dimArray[i];if(rho>=acum&&acum+dimi>=rho)return{name:node.getData("stringArray")[i],color:node.getData("colorArray")[i],value:node.getData("valueArray")[i],label:node.name};acum+=dimi}return!1}return!1}}}),$jit.PieChart=new Class({sb:null,colors:["#416D9C","#70A35E","#EBB056","#C74243","#83548B","#909291","#557EAA"],selected:{},busy:!1,initialize:function(opt){this.controller=this.config=$.merge(Options("Canvas","PieChart","Label"),{Label:{type:"Native"}},opt),this.initializeViz()},initializeViz:function(){var config=this.config,that=this,nodeType=config.type.split(":")[0],delegate=new $jit.Sunburst({injectInto:config.injectInto,width:config.width,height:config.height,useCanvas:config.useCanvas,withLabels:"Native"!=config.Label.type,Label:{type:config.Label.type},Node:{overridable:!0,type:"piechart-"+nodeType,width:1,height:1},Edge:{type:"none"},Tips:{enable:config.Tips.enable,type:"Native",force:!0,onShow:function(tip,node,contains){var elem=contains;config.Tips.onShow(tip,elem,node)}},Events:{enable:!0,type:"Native",onClick:function(node,eventInfo,evt){if(config.Events.enable){var elem=eventInfo.getContains();config.Events.onClick(elem,eventInfo,evt)}},onMouseMove:function(node,eventInfo,evt){if(config.hoveredColor)if(node){var elem=eventInfo.getContains();that.select(node.id,elem.name,elem.index)}else that.select(!1,!1,!1)}},onCreateLabel:function(domElement,node){var labelConf=config.Label;if(config.showLabels){var style=domElement.style;style.fontSize=labelConf.size+"px",style.fontFamily=labelConf.family,style.color=labelConf.color,style.textAlign="center",domElement.innerHTML=node.name}},onPlaceLabel:function(domElement,node){if(config.showLabels){var pos=node.pos.getp(!0),dimArray=node.getData("dimArray"),span=node.getData("span")/2,theta=node.pos.theta,begin=theta-span,end=theta+span,polar=new Polar,resizeLabels=(config.showLabels,config.resizeLabels),label=config.Label;if(dimArray){for(var i=0,l=dimArray.length,acum=0;l>i;i++)acum+=dimArray[i];var scale=resizeLabels?node.getData("normalizedDim"):1,fontSize=label.size*scale>>0;fontSize=+resizeLabels>fontSize?+resizeLabels:fontSize,domElement.style.fontSize=fontSize+"px",polar.rho=acum+config.labelOffset+config.sliceOffset,polar.theta=(begin+end)/2;var pos=polar.getc(!0),radius=that.canvas.getSize(),labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)};domElement.style.left=labelPos.x+"px",domElement.style.top=labelPos.y+"px"}}}}),size=delegate.canvas.getSize(),min=Math.min;delegate.config.levelDistance=min(size.width,size.height)/2-config.offset-config.sliceOffset,this.delegate=delegate,this.canvas=this.delegate.canvas,this.canvas.getCtx().globalCompositeOperation="lighter"},loadJSON:function(json){for(var prefix=$.time(),ch=[],delegate=this.delegate,name=$.splat(json.label),nameLength=name.length,color=$.splat(json.color||this.colors),colorLength=color.length,config=this.config,gradient=!!config.type.split(":")[1],animate=config.animate,mono=1==nameLength,i=0,values=json.values,l=values.length;l>i;i++){var val=values[i],valArray=$.splat(val.values);ch.push({id:prefix+val.label,name:val.label,data:{value:valArray,$valueArray:valArray,$colorArray:mono?$.splat(color[i%colorLength]):color,$stringArray:name,$gradient:gradient,$config:config,$angularWidth:$.reduce(valArray,function(x,y){return x+y})},children:[]})}var root={id:prefix+"$root",name:"",data:{$type:"none",$width:1,$height:1},children:ch};delegate.loadJSON(root),this.normalizeDims(),delegate.refresh(),animate&&delegate.fx.animate({modes:["node-property:dimArray"],duration:1500})},updateJSON:function(json,onComplete){if(!this.busy){this.busy=!0;var delegate=this.delegate,graph=delegate.graph,values=json.values,animate=this.config.animate,that=this;$.each(values,function(v){var n=graph.getByName(v.label),vals=$.splat(v.values);n&&(n.setData("valueArray",vals),n.setData("angularWidth",$.reduce(vals,function(x,y){return x+y})),json.label&&n.setData("stringArray",$.splat(json.label)))}),this.normalizeDims(),animate?(delegate.compute("end"),delegate.fx.animate({modes:["node-property:dimArray:span","linear"],duration:1500,onComplete:function(){that.busy=!1,onComplete&&onComplete.onComplete()}})):delegate.refresh()}},select:function(id,name){if(this.config.hoveredColor){var s=this.selected;(s.id!=id||s.name!=name)&&(s.id=id,s.name=name,s.color=this.config.hoveredColor,this.delegate.graph.eachNode(function(n){id==n.id?n.setData("border",s):n.setData("border",!1)}),this.delegate.plot())}},getLegend:function(){var n,legend={};this.delegate.graph.getNode(this.delegate.root).eachAdjacency(function(adj){n=adj.nodeTo});var colors=n.getData("colorArray"),len=colors.length;return $.each(n.getData("stringArray"),function(s,i){legend[s]=colors[i%len]}),legend},getMaxValue:function(){var maxValue=0;return this.delegate.graph.eachNode(function(n){var valArray=n.getData("valueArray"),acum=0;$.each(valArray,function(v){acum+=+v}),maxValue=maxValue>acum?maxValue:acum}),maxValue},normalizeDims:function(){var root=this.delegate.graph.getNode(this.delegate.root),l=0;root.eachAdjacency(function(){l++});var maxValue=this.getMaxValue()||1,config=this.config,animate=config.animate,rho=this.delegate.config.levelDistance;this.delegate.graph.eachNode(function(n){var acum=0,animateValue=[];$.each(n.getData("valueArray"),function(v){acum+=+v,animateValue.push(1)});var stat=1==animateValue.length&&!config.updateHeights;if(animate){n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return stat?rho:n*rho/maxValue}),"end");var dimArray=n.getData("dimArray");dimArray||n.setData("dimArray",animateValue)}else n.setData("dimArray",$.map(n.getData("valueArray"),function(n){return stat?rho:n*rho/maxValue}));n.setData("normalizedDim",acum/maxValue)})}}),Layouts.TM={},Layouts.TM.SliceAndDice=new Class({compute:function(prop){var root=this.graph.getNode(this.clickedNode&&this.clickedNode.id||this.root);this.controller.onBeforeCompute(root);var size=this.canvas.getSize(),config=this.config,width=size.width,height=size.height;this.graph.computeLevels(this.root,0,"ignore"),root.getPos(prop).setc(-width/2,-height/2),root.setData("width",width,prop),root.setData("height",height+config.titleHeight,prop),this.computePositions(root,root,this.layout.orientation,prop),this.controller.onAfterCompute(root)},computePositions:function(par,ch,orn,prop){var totalArea=0;par.eachSubnode(function(n){totalArea+=n.getData("area",prop)});var otherSize,size,dim,pos,pos2,posth,pos2th,config=this.config,width=(config.offset,par.getData("width",prop)),height=Math.max(par.getData("height",prop)-config.titleHeight,0),fact=par==ch?1:ch.getData("area",prop)/totalArea,horizontal="h"==orn;horizontal?(orn="v",otherSize=height,size=width*fact,dim="height",pos="y",pos2="x",posth=config.titleHeight,pos2th=0):(orn="h",otherSize=height*fact,size=width,dim="width",pos="x",pos2="y",posth=0,pos2th=config.titleHeight);var cpos=ch.getPos(prop);ch.setData("width",size,prop),ch.setData("height",otherSize,prop);var offsetSize=0,tm=this;ch.eachSubnode(function(n){var p=n.getPos(prop);p[pos]=offsetSize+cpos[pos]+posth,p[pos2]=cpos[pos2]+pos2th,tm.computePositions(ch,n,orn,prop),offsetSize+=n.getData(dim,prop)})}}),Layouts.TM.Area={compute:function(prop){prop=prop||"current";var root=this.graph.getNode(this.clickedNode&&this.clickedNode.id||this.root);this.controller.onBeforeCompute(root);var config=this.config,size=this.canvas.getSize(),width=size.width,height=size.height,offst=config.offset,offwdth=width-offst,offhght=height-offst;this.graph.computeLevels(this.root,0,"ignore"),root.getPos(prop).setc(-width/2,-height/2),root.setData("width",width,prop),root.setData("height",height,prop);var coord={top:-height/2+config.titleHeight+offst/2,left:-width/2+offst/2,width:offwdth,height:offhght-config.titleHeight};this.computePositions(root,coord,prop),this.controller.onAfterCompute(root)},computeDim:function(tail,initElem,w,coord,comp,prop){if(tail.length+initElem.length==1){var l=1==tail.length?tail:initElem;return void this.layoutLast(l,w,coord,prop)}if(tail.length>=2&&0==initElem.length&&(initElem=[tail.shift()]),0==tail.length)return void(initElem.length>0&&this.layoutRow(initElem,w,coord,prop));var c=tail[0];if(comp(initElem,w)>=comp([c].concat(initElem),w))this.computeDim(tail.slice(1),initElem.concat([c]),w,coord,comp,prop);else{var newCoords=this.layoutRow(initElem,w,coord,prop);this.computeDim(tail,[],newCoords.dim,newCoords,comp,prop)}},worstAspectRatio:function(ch,w){if(!ch||0==ch.length)return Number.MAX_VALUE;for(var areaSum=0,maxArea=0,minArea=Number.MAX_VALUE,i=0,l=ch.length;l>i;i++){var area=ch[i]._area;areaSum+=area,minArea=area>minArea?minArea:area,maxArea=maxArea>area?maxArea:area}var sqw=w*w,sqAreaSum=areaSum*areaSum;return Math.max(sqw*maxArea/sqAreaSum,sqAreaSum/(sqw*minArea))},avgAspectRatio:function(ch,w){if(!ch||0==ch.length)return Number.MAX_VALUE;for(var arSum=0,i=0,l=ch.length;l>i;i++){var area=ch[i]._area,h=area/w;arSum+=w>h?w/h:h/w}return arSum/l},layoutLast:function(ch,w,coord,prop){var child=ch[0];child.getPos(prop).setc(coord.left,coord.top),child.setData("width",coord.width,prop),child.setData("height",coord.height,prop)}},Layouts.TM.Squarified=new Class({Implements:Layouts.TM.Area,computePositions:function(node,coord,prop){var config=this.config,max=Math.max;this.layout.orientation=coord.width>=coord.height?"h":"v";var ch=node.getSubnodes([1,1],"ignore");if(ch.length>0){this.processChildrenLayout(node,ch,coord,prop);for(var i=0,l=ch.length;l>i;i++){var chi=ch[i],offst=config.offset,height=max(chi.getData("height",prop)-offst-config.titleHeight,0),width=max(chi.getData("width",prop)-offst,0),chipos=chi.getPos(prop);coord={width:width,height:height,top:chipos.y+config.titleHeight+offst/2,left:chipos.x+offst/2},this.computePositions(chi,coord,prop)}}},processChildrenLayout:function(par,ch,coord,prop){var i,parentArea=coord.width*coord.height,l=ch.length,totalChArea=0,chArea=[];for(i=0;l>i;i++)chArea[i]=parseFloat(ch[i].getData("area",prop)),totalChArea+=chArea[i];for(i=0;l>i;i++)ch[i]._area=parentArea*chArea[i]/totalChArea;var minimumSideValue=this.layout.horizontal()?coord.height:coord.width;ch.sort(function(a,b){var diff=b._area-a._area;return diff?diff:b.id==a.id?0:b.id<a.id?1:-1});var initElem=[ch[0]],tail=ch.slice(1);this.squarify(tail,initElem,minimumSideValue,coord,prop)},squarify:function(tail,initElem,w,coord,prop){this.computeDim(tail,initElem,w,coord,this.worstAspectRatio,prop)},layoutRow:function(ch,w,coord,prop){return this.layout.horizontal()?this.layoutV(ch,w,coord,prop):this.layoutH(ch,w,coord,prop)},layoutV:function(ch,w,coord,prop){var totalArea=0,rnd=function(x){return x};$.each(ch,function(elem){totalArea+=elem._area});for(var width=rnd(totalArea/w)||0,top=0,i=0,l=ch.length;l>i;i++){var h=rnd(ch[i]._area/width)||0,chi=ch[i],posx="rtl"===$.getDir()?-1*coord.left-width:coord.left;chi.getPos(prop).setc(posx,coord.top+top),chi.setData("width",width,prop),chi.setData("height",h,prop),top+=h}var ans={height:coord.height,width:coord.width-width,top:coord.top,left:coord.left+width};return ans.dim=Math.min(ans.width,ans.height),ans.dim!=ans.height&&this.layout.change(),ans},layoutH:function(ch,w,coord,prop){var totalArea=0;$.each(ch,function(elem){totalArea+=elem._area});for(var height=totalArea/w||0,top=coord.top,left=0,i=0,l=ch.length;l>i;i++){var chi=ch[i],w=chi._area/height||0,posx="rtl"===$.getDir()?-1*(coord.left+left)-w:coord.left+left;

chi.getPos(prop).setc(posx,top),chi.setData("width",w,prop),chi.setData("height",height,prop),left+=w}var ans={height:coord.height-height,width:coord.width,top:coord.top+height,left:coord.left};return ans.dim=Math.min(ans.width,ans.height),ans.dim!=ans.width&&this.layout.change(),ans},layoutLast:function(ch,w,coord,prop){var child=ch[0],posx="rtl"===$.getDir()?-1*coord.left-coord.width:coord.left;child.getPos(prop).setc(posx,coord.top),child.setData("width",coord.width,prop),child.setData("height",coord.height,prop)}}),Layouts.TM.Strip=new Class({Implements:Layouts.TM.Area,computePositions:function(node,coord,prop){var ch=node.getSubnodes([1,1],"ignore"),config=this.config,max=Math.max;if(ch.length>0){this.processChildrenLayout(node,ch,coord,prop);for(var i=0,l=ch.length;l>i;i++){var chi=ch[i],offst=config.offset,height=max(chi.getData("height",prop)-offst-config.titleHeight,0),width=max(chi.getData("width",prop)-offst,0),chipos=chi.getPos(prop);coord={width:width,height:height,top:chipos.y+config.titleHeight+offst/2,left:chipos.x+offst/2},this.computePositions(chi,coord,prop)}}},processChildrenLayout:function(par,ch,coord,prop){var i,parentArea=coord.width*coord.height,l=ch.length,totalChArea=0,chArea=[];for(i=0;l>i;i++)chArea[i]=+ch[i].getData("area",prop),totalChArea+=chArea[i];for(i=0;l>i;i++)ch[i]._area=parentArea*chArea[i]/totalChArea;var side=this.layout.horizontal()?coord.width:coord.height,initElem=[ch[0]],tail=ch.slice(1);this.stripify(tail,initElem,side,coord,prop)},stripify:function(tail,initElem,w,coord,prop){this.computeDim(tail,initElem,w,coord,this.avgAspectRatio,prop)},layoutRow:function(ch,w,coord,prop){return this.layout.horizontal()?this.layoutH(ch,w,coord,prop):this.layoutV(ch,w,coord,prop)},layoutV:function(ch,w,coord,prop){var totalArea=0;$.each(ch,function(elem){totalArea+=elem._area});for(var width=totalArea/w||0,top=0,i=0,l=ch.length;l>i;i++){var chi=ch[i],h=chi._area/width||0;chi.getPos(prop).setc(coord.left,coord.top+(w-h-top)),chi.setData("width",width,prop),chi.setData("height",h,prop),top+=h}return{height:coord.height,width:coord.width-width,top:coord.top,left:coord.left+width,dim:w}},layoutH:function(ch,w,coord,prop){var totalArea=0;$.each(ch,function(elem){totalArea+=elem._area});for(var height=totalArea/w||0,top=coord.height-height,left=0,i=0,l=ch.length;l>i;i++){var chi=ch[i],s=chi._area/height||0;chi.getPos(prop).setc(coord.left+left,coord.top+top),chi.setData("width",s,prop),chi.setData("height",height,prop),left+=s}return{height:coord.height-height,width:coord.width,top:coord.top,left:coord.left,dim:w}}}),Layouts.TM.Voronoi=new Class({Implements:Layouts.TM.Area,compute:function(prop){this.controller.onBeforeCompute(root);var root=this.graph.getNode(this.clickedNode&&this.clickedNode.id||this.root),size=this.canvas.getSize(),config=this.config,offset=config.offset,width=size.width,height=size.height;this.graph.computeLevels(this.root,0,0),root.getPos(prop).setc(-5,-5),root.histoPos||(root.histoPos=[]),root.histoPos[0]=$C(0,0);var bound=[$C(.5*-width,.5*-height),$C(.5*width,.5*-height),$C(.5*width,.5*height),$C(.5*-width,.5*height)];bound=Geometry.offsetConvex(bound,.5*-offset),root.setData("vertices",bound,prop),root.setData("width",0,prop),root.setData("height",0,prop),bound=Geometry.offsetConvex(bound,1.5*-offset),this.computePositions(root,bound,prop,0),this.controller.onAfterCompute(root)},computePositions:function(node,bound,prop,level){var sites,polygons,me=this,chs=node.getSubnodes([1,1],"ignore"),config=this.config,offset=config.offset,historyPosition=node.histoPos[level]||c(0,0);node.setData("width",0,prop),node.setData("height",0,prop),node.getPos(prop).setc(historyPosition.x,historyPosition.y),chs.length>0&&(chs[0].histoPos&&chs[0].histoPos[level+1]||(sites=$jit.util.map(chs,function(ch){var pt=Geometry.randPointInPolygon(bound);return ch.data&&ch.data.$area&&(pt.area=ch.data.$area),pt}),sites=me[me.config.centroidType](sites,bound),$jit.util.each(sites,function(p,i){chs[i].histoPos||(chs[i].histoPos=[]),chs[i].histoPos[level+1]=p})),sites=$jit.util.map(chs,function(ch){return ch.histoPos[level+1]}),polygons=Geometry.voronoi(sites,bound),$jit.util.each(chs,function(ch,i){var vertices=polygons[i],newBoundary=vertices.slice(0);Geometry.area(vertices)<0&&vertices.reverse(),offset&&(newBoundary=Geometry.offsetConvex(vertices,2*-offset),vertices=Geometry.offsetConvex(vertices,.5*-offset),ch.offset=offset),ch.setData("vertices",vertices,prop),me.computePositions(ch,newBoundary,prop,level+1)}))},centroid:function(sites,bound){for(var polygons,tdist=2;tdist>.001;)polygons=Geometry.voronoi(sites,bound),tdist=0,sites=polygons.map(function(p,j){var c=Geometry.centroid(p);return tdist+=Geometry.dist2(c,sites[j]),c});return sites},doLayoutPressure:function(){var me=this,root=me.graph.getNode(me.clickedNode&&me.clickedNode.id||me.root);root.eachNode(function(){})},weightedCentroid:function(sites,bound){var polygons,adjust,pascal=[],tdist=2,totalArea=Geometry.area(bound),totalWeight=0;$.each(sites,function(site,i){totalWeight+=site.area}),adjust=totalArea/totalWeight,polygons=Geometry.voronoi(sites,bound),$.each(polygons,function(p,i){pascal[i]=sites[i].area*adjust/Geometry.area(p)});var s=0,s2=0;for($.each(pascal,function(p,i){s+=p,s2+=p*p}),console.log("from "+(s2-s*s/pascal.length)/pascal.length);tdist>.001;)polygons=Geometry.voronoi(sites,bound),$.each(polygons,function(p,i){pascal[i]=sites[i].area*adjust/Geometry.area(p)}),tdist=0,sites=polygons.map(function(p,j){var c=$C(0,0),totalW=0;return $.each(p,function(v,i){var poly=[sites[j],v,p[i+1]||p[0]],targetPascal=v.attached?pascal[v.attached[0]]:1,w=Geometry.area(poly)*Math.exp(2*(pascal[j]-targetPascal));totalW+=w,c.$add(v.add(poly[2]).scale(.5*w))}),c.$scale(1/totalW),c.area=sites[j].area,tdist+=Geometry.dist(c,sites[j]),c});var s=0,s2=0;return $.each(pascal,function(p,i){s+=p,s2+=p*p}),console.log("to "+(s2-s*s/pascal.length)/pascal.length),sites},byArea:function(sites,bound){sites=this.centroid(sites,bound);var polygons,pressure,polygons,tw=0,iter=0;for($jit.util.each(sites,function(s){tw+=s.area}),tw=Geometry.area(bound)/tw;100>iter;iter++){polygons=Geometry.voronoi(sites,bound);for(var j=0;j<sites.length;j++)if(0==polygons[j].length){sites=polygons.map(function(p,j){return Geometry.centroid(p)});break}pressure=polygons.map(function(p,ind){return p.area*tw/(Geometry.area(p)+1e-10)}),polygons=Geometry.voronoi(sites,bound),sites=polygons.map(function(p,ind){var totalPressure,po=$C(sites[ind].x,sites[ind].y);return po.area=sites[ind].area,totalPressure=$C(0,0),$jit.util.each(p,function(v,i){var targetPressure=(v.attached?v.attached:-1,v.attached?pressure[v.attached[0]]:1),start=v,stop=p[i+1]||p[0],pr=pressure[ind]-targetPressure,dx=stop.x-start.x,dy=stop.y-start.y;totalPressure.x+=dy*pr,totalPressure.y-=dx*pr}),po.x+=totalPressure.x/10,po.y+=totalPressure.y/10,po.tp=totalPressure,po})}return sites}}),Layouts.Icicle=new Class({compute:function(posType){posType=posType||"current";var root=this.graph.getNode(this.root),config=this.config,size=this.canvas.getSize(),width=size.width,height=size.height,levelsToShow=(config.offset,config.constrained?config.levelsToShow:Number.MAX_VALUE);this.controller.onBeforeCompute(root),Graph.Util.computeLevels(this.graph,root.id,0,"ignore");var treeDepth=0;Graph.Util.eachLevel(root,0,!1,function(n,d){d>treeDepth&&(treeDepth=d)});var startNode=this.graph.getNode(this.clickedNode&&this.clickedNode.id||root.id),maxDepth=Math.min(treeDepth,levelsToShow-1),initialDepth=startNode._depth;this.layout.horizontal()?this.computeSubtree(startNode,-width/2,-height/2,width/(maxDepth+1),height,initialDepth,maxDepth,posType):this.computeSubtree(startNode,-width/2,-height/2,width,height/(maxDepth+1),initialDepth,maxDepth,posType)},computeSubtree:function(root,x,y,width,height,initialDepth,maxDepth,posType){root.getPos(posType).setc(x,y),root.setData("width",width,posType),root.setData("height",height,posType);var nodeLength,totalDim=0,children=Graph.Util.getSubnodes(root,[1,1],"ignore");if(children.length){$.each(children,function(e){totalDim+=e.getData("dim")});for(var i=0,l=children.length;l>i;i++)this.layout.horizontal()?(nodeLength=height*children[i].getData("dim")/totalDim,this.computeSubtree(children[i],x+width,y,width,nodeLength,initialDepth,maxDepth,posType),y+=nodeLength):(nodeLength=width*children[i].getData("dim")/totalDim,this.computeSubtree(children[i],x,y+height,nodeLength,height,initialDepth,maxDepth,posType),x+=nodeLength)}}}),$jit.Icicle=new Class({Implements:[Loader,Extras,Layouts.Icicle],layout:{orientation:"h",vertical:function(){return"v"==this.orientation},horizontal:function(){return"h"==this.orientation},change:function(){this.orientation=this.vertical()?"h":"v"}},initialize:function(controller){var config={animate:!1,orientation:"h",offset:2,levelsToShow:Number.MAX_VALUE,constrained:!1,Node:{type:"rectangle",overridable:!0},Edge:{type:"none"},Label:{type:"Native"},duration:700,fps:45},opts=Options("Canvas","Node","Edge","Fx","Tips","NodeStyles","Events","Navigation","Controller","Label");this.controller=this.config=$.merge(opts,config,controller),this.layout.orientation=this.config.orientation;var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Complex,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge,this.config.Label),this.labels=new $jit.Icicle.Label[this.config.Label.type](this),this.fx=new $jit.Icicle.Plot(this,$jit.Icicle),this.op=new $jit.Icicle.Op(this),this.group=new $jit.Icicle.Group(this),this.clickedNode=null,this.initializeExtras()},refresh:function(){var labelType=this.config.Label.type;if("Native"!=labelType){var that=this;this.graph.eachNode(function(n){that.labels.hideLabel(n,!1)})}this.compute(),this.plot()},plot:function(){this.fx.plot(this.config)},enter:function(node){if(!this.busy){this.busy=!0;var that=this,config=this.config,callback={onComplete:function(){config.request&&that.compute(),config.animate?(that.graph.nodeList.setDataset(["current","end"],{alpha:[1,0]}),Graph.Util.eachSubgraph(node,function(n){n.setData("alpha",1,"end")},"ignore"),that.fx.animate({duration:500,modes:["node-property:alpha"],onComplete:function(){that.clickedNode=node,that.compute("end"),that.fx.animate({modes:["linear","node-property:width:height"],duration:1e3,onComplete:function(){that.busy=!1,that.clickedNode=node}})}})):(that.clickedNode=node,that.busy=!1,that.refresh())}};config.request?this.requestNodes(node,callback):callback.onComplete()}},out:function(){if(!this.busy){var callback,that=this,GUtil=Graph.Util,config=this.config,graph=this.graph,parents=GUtil.getParents(graph.getNode(this.clickedNode&&this.clickedNode.id||this.root)),parent=parents[0],clickedNode=parent,previousClickedNode=this.clickedNode;if(this.busy=!0,this.events.hoveredNode=!1,!parent)return void(this.busy=!1);callback={onComplete:function(){that.clickedNode=parent,config.request?that.requestNodes(parent,{onComplete:function(){that.compute(),that.plot(),that.busy=!1}}):(that.compute(),that.plot(),that.busy=!1)}},config.animate?(this.clickedNode=clickedNode,this.compute("end"),this.clickedNode=previousClickedNode,this.fx.animate({modes:["linear","node-property:width:height"],duration:1e3,onComplete:function(){that.clickedNode=clickedNode,graph.nodeList.setDataset(["current","end"],{alpha:[0,1]}),GUtil.eachSubgraph(previousClickedNode,function(node){node.setData("alpha",1)},"ignore"),that.fx.animate({duration:500,modes:["node-property:alpha"],onComplete:function(){callback.onComplete()}})}})):callback.onComplete()}},requestNodes:function(node,onComplete){var handler=$.merge(this.controller,onComplete),levelsToShow=this.config.constrained?this.config.levelsToShow:Number.MAX_VALUE;if(handler.request){var leaves=[],d=node._depth;Graph.Util.eachLevel(node,0,levelsToShow,function(n){n.drawn&&!Graph.Util.anySubnode(n)&&(leaves.push(n),n._level=n._depth-d)}),this.group.requestNodes(leaves,handler)}else handler.onComplete()}}),$jit.Icicle.Op=new Class({Implements:Graph.Op}),$jit.Icicle.Group=new Class({initialize:function(viz){this.viz=viz,this.canvas=viz.canvas,this.config=viz.config},requestNodes:function(nodes,controller){var counter=0,len=nodes.length,nodeSelected={},complete=function(){controller.onComplete()},viz=this.viz;0==len&&complete();for(var i=0;len>i;i++)nodeSelected[nodes[i].id]=nodes[i],controller.request(nodes[i].id,nodes[i]._level,{onComplete:function(nodeId,data){data&&data.children&&(data.id=nodeId,viz.op.sum(data,{type:"nothing"})),++counter==len&&(Graph.Util.computeLevels(viz.graph,viz.root,0),complete())}})}}),$jit.Icicle.Plot=new Class({Implements:Graph.Plot,plot:function(opt,animating){opt=opt||this.viz.controller;var viz=this.viz,graph=viz.graph,root=graph.getNode(viz.clickedNode&&viz.clickedNode.id||viz.root),initialDepth=root._depth;viz.canvas.clear(),this.plotTree(root,$.merge(opt,{withLabels:!0,hideLabels:!1,plotSubtree:function(root,node){return!viz.config.constrained||node._depth-initialDepth<viz.config.levelsToShow}}),animating)}}),$jit.Icicle.Label={},$jit.Icicle.Label.Native=new Class({Implements:Graph.Label.Native,renderLabel:function(canvas,node,controller){var ctx=canvas.getCtx(),width=node.getData("width"),height=node.getData("height"),size=node.getLabelData("size"),m=ctx.measureText(node.name);if(!(1.5*size>height||width<m.width)){var pos=node.pos.getc(!0);ctx.fillText(node.name,pos.x+width/2,pos.y+height/2)}}}),$jit.Icicle.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,radius=canvas.getSize(),labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y),controller.onPlaceLabel(tag,node)}}),$jit.Icicle.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,radius=canvas.getSize(),labelPos={x:Math.round(pos.x+radius.width/2),y:Math.round(pos.y+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display="",controller.onPlaceLabel(tag,node)}}),$jit.Icicle.Plot.NodeTypes=new Class({none:{render:$.empty},rectangle:{render:function(node,canvas,animating){var config=this.viz.config,offset=config.offset,width=node.getData("width"),height=node.getData("height"),border=node.getData("border"),pos=node.pos.getc(!0),posx=pos.x+offset/2,posy=pos.y+offset/2,ctx=canvas.getCtx();if(!(2>width-offset||2>height-offset)){if(config.cushion){var color=node.getData("color"),lg=ctx.createRadialGradient(posx+(width-offset)/2,posy+(height-offset)/2,1,posx+(width-offset)/2,posy+(height-offset)/2,height>width?height:width),colorGrad=$.rgbToHex($.map($.hexToRgb(color),function(r){return.3*r>>0}));lg.addColorStop(0,color),lg.addColorStop(1,colorGrad),ctx.fillStyle=lg}border&&(ctx.strokeStyle=border,ctx.lineWidth=3),ctx.fillRect(posx,posy,Math.max(0,width-offset),Math.max(0,height-offset)),border&&ctx.strokeRect(pos.x,pos.y,width,height)}},contains:function(node,pos){if(this.viz.clickedNode&&!$jit.Graph.Util.isDescendantOf(node,this.viz.clickedNode.id))return!1;var npos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");return this.nodeHelper.rectangle.contains({x:npos.x+width/2,y:npos.y+height/2},pos,width,height)}}}),$jit.Icicle.Plot.EdgeTypes=new Class({none:$.empty});var QuadTreeNode=new Class({com:[0,0],children:[null,null,null,null],hasChildren:!1,mass:null,fItem:null}),QuadTreeNodeFactory=new Class({maxNodes:5e4,nodes:null,setup:function(){this.nodes=new Array},getQuadTreeNode:function(){return this.nodes.length>0?this.nodes.pop():new QuadTreeNode},reclaim:function(n){n.mass=0,n.com[0]=0,n.com[1]=0,n.fItem=null,n.hasChildren=!1,n.children=[null,null,null,null],this.nodes.length<this.maxNodes&&this.nodes.push(n)}}),NBodyForce=new Class({pnames:["GravitationalConstant","Distance","BarnesHutTheta"],DEFAULT_GRAV_CONSTANT:-1,DEFAULT_MIN_GRAV_CONSTANT:-10,DEFAULT_MAX_GRAV_CONSTANT:10,DEFAULT_DISTANCE:-1,DEFAULT_MIN_DISTANCE:-1,DEFAULT_MAX_DISTANCE:500,DEFAULT_THETA:.9,DEFAULT_MIN_THETA:0,DEFAULT_MAX_THETA:1,GRAVITATIONAL_CONST:0,MIN_DISTANCE:1,BARNES_HUT_THETA:2,xMin:null,xMax:null,yMin:null,yMax:null,params:null,minValues:null,maxValues:null,factory:null,root:null,setup:function(){this.params=[this.DEFAULT_GRAV_CONSTANT,this.DEFAULT_DISTANCE,this.DEFAULT_THETA],this.minValues=[this.DEFAULT_MIN_GRAV_CONSTANT,this.DEFAULT_MIN_DISTANCE,this.DEFAULT_MIN_THETA],this.maxValues=[this.DEFAULT_MAX_GRAV_CONSTANT,this.DEFAULT_MAX_DISTANCE,this.DEFAULT_MAX_THETA],this.factory=new QuadTreeNodeFactory,this.factory.setup(),this.root=this.factory.getQuadTreeNode()},setBounds:function(xMin,yMin,xMax,yMax){this.xMin=xMin,this.yMin=yMin,this.xMax=xMax,this.yMax=yMax},insertHelper:function(p,n,x1,y1,x2,y2){var x=p.location[0],y=p.location[1],splitx=(x1+x2)/2,splity=(y1+y2)/2,i=(x>=splitx?1:0)+(y>=splity?2:0);null==n.children[i]&&(n.children[i]=this.factory.getQuadTreeNode(),n.hasChildren=!0),1==i||3==i?x1=splitx:x2=splitx,i>1?y1=splity:y2=splity,this.insert(p,n.children[i],x1,y1,x2,y2)},isSameLocation:function(fItem1,fItem2){var dx=Math.abs(fItem1.location[0]-fItem2.location[0]),dy=Math.abs(fItem1.location[1]-fItem2.location[1]);return.01>dx&&.01>dy},insert:function(p,n,x1,y1,x2,y2){if(n.hasChildren)this.insertHelper(p,n,x1,y1,x2,y2);else if(null!=n.fItem)if(this.isSameLocation(n.fItem,p))this.insertHelper(p,n,x1,y1,x2,y2);else{var v=n.fItem;n.fItem=null,this.insertHelper(v,n,x1,y1,x2,y2),this.insertHelper(p,n,x1,y1,x2,y2)}else n.fItem=p},calcMass:function(n){var xcom=0,ycom=0;if(n.mass=0,n.hasChildren)for(var i=0;i<n.children.length;i++)null!=n.children[i]&&(this.calcMass(n.children[i]),n.mass+=n.children[i].mass,xcom+=n.children[i].mass*n.children[i].com[0],ycom+=n.children[i].mass*n.children[i].com[1]);null!=n.fItem&&(n.mass+=n.fItem.mass,xcom+=n.fItem.mass*n.fItem.location[0],ycom+=n.fItem.mass*n.fItem.location[1]),n.com[0]=xcom/n.mass,n.com[1]=ycom/n.mass},insertRoot:function(fItem){this.insert(fItem,this.root,this.xMin,this.yMin,this.xMax,this.yMax)},clearHelper:function(n){for(var i=0;i<n.children.length;i++)null!=n.children[i]&&this.clearHelper(n.children[i]);this.factory.reclaim(n)},clear:function(){this.clearHelper(this.root),this.root=this.factory.getQuadTreeNode()},init:function(fSim){this.clear();for(var x1=Number.MAX_VALUE,y1=Number.MAX_VALUE,x2=Number.MIN_VALUE,y2=Number.MIN_VALUE,i=0;i<fSim.items.length;i++){var x=fSim.items[i].location[0],y=fSim.items[i].location[1];x1>x&&(x1=x),y1>y&&(y1=y),x>x2&&(x2=x),y>y2&&(y2=y)}var dx=x2-x1,dy=y2-y1;dx>dy?y2=y1+dx:x2=x1+dy,this.setBounds(x1,y1,x2,y2);for(var i=0;i<fSim.items.length;i++)this.insertRoot(fSim.items[i]);this.calcMass(this.root)},getForce:function(fItem){this.forceHelper(fItem,this.root,this.xMin,this.yMin,this.xMax,this.yMax)},forceHelper:function(item,n,x1,y1,x2,y2){var dx=n.com[0]-item.location[0],dy=n.com[1]-item.location[1],r=Math.sqrt(dx*dx+dy*dy),same=!1;0==r&&(dx=(Math.random()-.5)/50,dy=(Math.random()-.5)/50,r=Math.sqrt(dx*dx+dy*dy),same=!0);var minDist=this.params[this.MIN_DISTANCE]>0&&r>this.params[this.MIN_DISTANCE];if(!n.hasChildren&&n.fItem!=item||!same&&(x2-x1)/r<this.params[this.BARNES_HUT_THETA]){if(minDist)return;var v=this.params[this.GRAVITATIONAL_CONST]*item.mass*n.mass/(r*r*r);item.force[0]+=v*dx,item.force[1]+=v*dy}else if(n.hasChildren){for(var splitx=(x1+x2)/2,splity=(y1+y2)/2,i=0;i<n.children.length;i++)null!=n.children[i]&&this.forceHelper(item,n.children[i],1==i||3==i?splitx:x1,i>1?splity:y1,1==i||3==i?x2:splitx,i>1?y2:splity);if(minDist)return;if(null!=n.fItem&&n.fItem!=item){var v=this.params[this.GRAVITATIONAL_CONST]*item.mass*n.fItem.mass/(r*r*r);item.force[0]+=v*dx,item.force[1]+=v*dy}}}}),SpringForce=new Class({pnames:["SpringCoefficient","DefaultSpringLength"],DEFAULT_SPRING_COEFF:1e-4,DEFAULT_MAX_SPRING_COEFF:.001,DEFAULT_MIN_SPRING_COEFF:1e-5,DEFAULT_SPRING_LENGTH:50,DEFAULT_MIN_SPRING_LENGTH:0,DEFAULT_MAX_SPRING_LENGTH:200,SPRING_COEFF:0,SPRING_LENGTH:1,params:null,minValues:null,maxValues:null,setup:function(){this.params=[this.DEFAULT_SPRING_COEFF,this.DEFAULT_SPRING_LENGTH],this.minValues=[this.DEFAULT_MIN_SPRING_COEFF,this.DEFAULT_MIN_SPRING_LENGTH],this.maxValues=[this.DEFAULT_MAX_SPRING_COEFF,this.DEFAULT_MAX_SPRING_LENGTH]},getForce:function(s){var fItem1=s.item1,fItem2=s.item2,length=s.length<0?this.params[this.SPRING_LENGTH]:s.length,x1=fItem1.location[0],y1=fItem1.location[1],x2=fItem2.location[0],y2=fItem2.location[1],dx=x2-x1,dy=y2-y1,r=Math.sqrt(dx*dx+dy*dy);0==r&&(dx=(Math.random()-.5)/50,dy=(Math.random()-.5)/50,r=Math.sqrt(dx*dx+dy*dy));var d=r-length,coeff=(s.coeff<0?this.params[this.SPRING_COEFF]:s.coeff)*d/r;fItem1.force[0]+=coeff*dx,fItem1.force[1]+=coeff*dy,fItem2.force[0]+=-coeff*dx,fItem2.force[1]+=-coeff*dy},init:function(){}}),DragForce=new Class({pnames:["DragCoefficient"],DEFAULT_DRAG_COEFF:.01,DEFAULT_MIN_DRAG_COEFF:0,DEFAULT_MAX_DRAG_COEFF:.1,DRAG_COEFF:0,params:null,minValues:null,maxValues:null,setup:function(){this.params=[this.DEFAULT_DRAG_COEFF],this.minValues=[this.DEFAULT_MIN_DRAG_COEFF],this.maxValues=[this.DEFAULT_MAX_DRAG_COEFF]},getForce:function(fItem){fItem.force[0]-=this.params[this.DRAG_COEFF]*fItem.velocity[0],fItem.force[1]-=this.params[this.DRAG_COEFF]*fItem.velocity[1]},init:function(){}}),RungeKuttaIntegrator=new Class({integrate:function(sim,timestep){for(var vx,vy,v,coeff,k,l,speedLimit=sim.speedLimit,i=0;i<sim.items.length;i++){var item=sim.items[i];coeff=timestep/item.mass,k=item.k,l=item.l,item.plocation[0]=item.location[0],item.plocation[1]=item.location[1],k[0][0]=timestep*item.velocity[0],k[0][1]=timestep*item.velocity[1],l[0][0]=coeff*item.force[0],l[0][1]=coeff*item.force[1],item.location[0]+=.5*k[0][0],item.location[1]+=.5*k[0][1]}sim.accumulate();for(var i=0;i<sim.items.length;i++){var item=sim.items[i];coeff=timestep/item.mass,k=item.k,l=item.l,vx=item.velocity[0]+.5*l[0][0],vy=item.velocity[1]+.5*l[0][1],v=Math.sqrt(vx*vx+vy*vy),v>speedLimit&&(vx=speedLimit*vx/v,vy=speedLimit*vy/v),k[1][0]=timestep*vx,k[1][1]=timestep*vy,l[1][0]=coeff*item.force[0],l[1][1]=coeff*item.force[1],item.location[0]=item.plocation[0]+.5*k[1][0],item.location[1]=item.plocation[1]+.5*k[1][1]}sim.accumulate();for(var i=0;i<sim.items.length;i++){var item=sim.items[i];coeff=timestep/item.mass,k=item.k,l=item.l,vx=item.velocity[0]+.5*l[1][0],vy=item.velocity[1]+.5*l[1][1],v=Math.sqrt(vx*vx+vy*vy),v>speedLimit&&(vx=speedLimit*vx/v,vy=speedLimit*vy/v),k[2][0]=timestep*vx,k[2][1]=timestep*vy,l[2][0]=coeff*item.force[0],l[2][1]=coeff*item.force[1],item.location[0]=item.plocation[0]+.5*k[2][0],item.location[1]=item.plocation[1]+.5*k[2][1]}sim.accumulate();for(var i=0;i<sim.items.length;i++){var item=sim.items[i];coeff=timestep/item.mass,k=item.k,l=item.l;var p=item.plocation;vx=item.velocity[0]+l[2][0],vy=item.velocity[1]+l[2][1],v=Math.sqrt(vx*vx+vy*vy),v>speedLimit&&(vx=speedLimit*vx/v,vy=speedLimit*vy/v),k[3][0]=timestep*vx,k[3][1]=timestep*vy,l[3][0]=coeff*item.force[0],l[3][1]=coeff*item.force[1],item.location[0]=p[0]+(k[0][0]+k[3][0])/6+(k[1][0]+k[2][0])/3,item.location[1]=p[1]+(k[0][1]+k[3][1])/6+(k[1][1]+k[2][1])/3,vx=(l[0][0]+l[3][0])/6+(l[1][0]+l[2][0])/3,vy=(l[0][1]+l[3][1])/6+(l[1][1]+l[2][1])/3,v=Math.sqrt(vx*vx+vy*vy),v>speedLimit&&(vx=speedLimit*vx/v,vy=speedLimit*vy/v),item.velocity[0]+=vx,item.velocity[1]+=vy}}}),ForceSimulator=new Class({speedLimit:1,iflen:0,sflen:0,integrator:null,items:null,springs:null,iforces:null,sforces:null,setup:function(){this.items=new Array,this.springs=new Array,this.iforces=new Array,this.sforces=new Array,this.integrator=new RungeKuttaIntegrator},accumulate:function(){for(var i=0;i<this.iforces.length;i++)this.iforces[i].init(this);for(var i=0;i<this.sforces.length;i++)this.sforces[i].init(this);for(var i=0;i<this.items.length;i++){this.items[i].force[0]=0,this.items[i].force[1]=0;for(var j=0;j<this.iforces.length;j++)this.iforces[j].getForce(this.items[i])}for(var i=0;i<this.springs.length;i++)for(var j=0;j<this.sforces.length;j++)this.sforces[j].getForce(this.springs[i])},runSimulator:function(timestep){this.accumulate(),this.integrator.integrate(this,timestep)},addForce:function(f,itemForce){itemForce?(this.iforces.push(f),this.iflen++):(this.sforces.push(f),this.sflen++)},addItem:function(fItem){this.items.push(fItem)},addSpring:function(spring){this.springs.push(spring)}}),Spring=new Class({item1:null,item2:null,coeff:null,length:null,setup:function(fItem1,fItem2,coeff,len){this.item1=fItem1,this.item2=fItem2,this.coeff=coeff,this.length=len}}),ForceItem=new Class({mass:1,force:null,velocity:null,location:null,plocation:null,k:[[0,0],[0,0],[0,0],[0,0]],l:[[0,0],[0,0],[0,0],[0,0]],setup:function(){this.force=new Array,this.velocity=new Array,this.location=new Array,this.plocation=new Array},init:function(xLoc,yLoc){this.force[0]=0,this.force[1]=0,this.velocity[0]=0,this.velocity[1]=0,this.location[0]=xLoc,this.location[1]=yLoc,this.plocation[0]=0,this.plocation[1]=0}});Layouts.ForceDirected=new Class({getOptions:function(random){var s=this.canvas.getSize(),w=s.width,h=s.height,count=0;this.graph.eachNode(function(n){count++});var k2=w*h/count,k=Math.sqrt(k2),l=this.config.levelDistance;return{width:w-l,height:h-l,tstart:.1*w,nodef:function(x){return k2/(x||1)},edgef:function(x){return k*(x-l)}}},compute:function(property,incremental){this.computeFast(property,incremental)},computeFast:function(property,incremental){var sim=new ForceSimulator;sim.setup();var nbody=new NBodyForce;nbody.setup();var spring=new SpringForce;spring.setup();var drag=new DragForce;drag.setup(),sim.addForce(nbody,!0),sim.addForce(spring,!1),sim.addForce(drag,!0);var timestep=1e3,prop=$.splat(property||["current","start","end"]),opt=this.getOptions(),adjDone=[];NodeDim.compute(this.graph,prop,this.config),this.graph.computeLevels(this.root,0,"ignore"),this.graph.eachNode(function(n){$.each(prop,function(p){var pos=n.getPos(p);pos.x=opt.width/2,pos.y=opt.height/2,n.forceItem=new ForceItem,n.forceItem.setup(),n.forceItem.init(pos.x,pos.y),sim.addItem(n.forceItem),n.disp={},$.each(prop,function(p){n.disp[p]=$C(0,0)})})}),this.graph.eachNode(function(n){n.eachAdjacency(function(adj){if(void 0===adjDone[adj.nodeTo.id]){var s=new Spring;s.setup(adj.nodeFrom.forceItem,adj.nodeTo.forceItem,-1,-1),sim.addSpring(s),adjDone[adj.nodeFrom.id]=[],adjDone[adj.nodeFrom.id][adj.nodeTo.id]=!0}})});var times=(Math.ceil(this.config.iterations/incremental.iter),this.config.iterations),i=0,graph=this.graph;!function iter(){for(var total=incremental.iter,j=0;total>j;j++){opt.t=opt.tstart,times&&(opt.t*=1-i++/(times-1)),timestep*=1-i/times;var step=timestep+50;if(sim.runSimulator(step),times&&i>=times){var x2=opt.width/2,y2=opt.height/2;graph.eachNode(function(n){$.each(prop,function(p){var x=n.forceItem.location[0],y=n.forceItem.location[1],disp=(2*n.getData("dim"),2*n.getData("dim"),n.disp[p]),pos=(disp.norm()||1,n.getPos(p));pos.x=x,pos.y=y})}),incremental.onComplete();var maxX=-Number.MAX_VALUE,minX=Number.MAX_VALUE,maxY=-Number.MAX_VALUE,minY=Number.MAX_VALUE;graph.eachNode(function(n){$.each(prop,function(p){var l=n.getPos(p);l.x>maxX&&(maxX=l.x),l.x<minX&&(minX=l.x),l.y>maxY&&(maxY=l.y),l.y<minY&&(minY=l.y)})});var lh,lw;lw=Math.ceil(0>maxX?Math.floor(Math.abs(minX))-Math.floor(Math.abs(maxX)):minX>=0?maxX-minX:maxX+Math.abs(minX)),lh=Math.ceil(0>maxY?Math.floor(Math.abs(minY))-Math.floor(Math.abs(maxY)):minY>=0?maxY-minY:maxY+Math.abs(minY));var x2=opt.width/2,y2=opt.height/2;return void graph.eachNode(function(n){$.each(prop,function(p){var l=n.getPos(p),pad=n.getData("dim");l.x=0>minX?(l.x+Math.abs(minX))*(opt.width/lw)-opt.width/2:(l.x-minX)*(opt.width/lw)-opt.width/2,l.x<=-x2+pad&&(l.x=-x2+2*pad),l.x>=x2-pad&&(l.x=x2-2*pad),l.y=0>minY?(l.y+Math.abs(minY))*(opt.height/lh)-opt.height/2:(l.y-minY)*(opt.height/lh)-opt.height/2,l.y<=-y2+pad&&(l.y=-y2+2*pad),l.y>=y2-pad&&(l.y=y2-2*pad)})})}}incremental.onStep(Math.round(i/(times-1)*100)),setTimeout(iter,1)}()}}),$jit.ForceDirected=new Class({Implements:[Loader,Extras,Layouts.ForceDirected],initialize:function(controller){var $ForceDirected=$jit.ForceDirected,config={iterations:50,levelDistance:50};this.controller=this.config=$.merge(Options("Canvas","Node","Edge","Fx","Tips","NodeStyles","Events","Navigation","Controller","Label"),config,controller);var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Complex,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new $ForceDirected.Label[canvasConfig.Label.type](this),this.fx=new $ForceDirected.Plot(this,$ForceDirected),this.op=new $ForceDirected.Op(this),this.json=null,this.busy=!1,this.initializeExtras()},refresh:function(){this.compute(),this.plot()},reposition:function(){this.compute("end")},computeIncremental:function(opt){opt=$.merge({iter:20,property:"end",onStep:$.empty,onComplete:$.empty},opt||{}),this.config.onBeforeCompute(this.graph.getNode(this.root)),this.compute(opt.property,opt)},computePrefuse:function(opt){opt=$.merge({iter:20,property:"end",onStep:$.empty,onComplete:$.empty},opt||{}),this.config.onBeforeCompute(this.graph.getNode(this.root)),this.computeFast(opt.property,opt)},plot:function(){this.fx.plot()},animate:function(opt){this.fx.animate($.merge({modes:["linear"]},opt||{}))}}),$jit.ForceDirected.$extend=!0,function(ForceDirected){ForceDirected.Op=new Class({Implements:Graph.Op}),ForceDirected.Plot=new Class({Implements:Graph.Plot}),ForceDirected.Label={},ForceDirected.Label.Native=new Class({Implements:Graph.Label.Native}),ForceDirected.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y),controller.onPlaceLabel(tag,node)}}),ForceDirected.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),ForceDirected.Plot.NodeTypes=new Class({none:{render:$.empty,contains:$.lambda(!1)},circle:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.circle.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.circle.contains(npos,pos,dim)}},ellipse:{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");

this.nodeHelper.ellipse.render("fill",pos,width,height,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");return this.nodeHelper.ellipse.contains(npos,pos,width,height)}},square:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.square.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.square.contains(npos,pos,dim)}},rectangle:{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");this.nodeHelper.rectangle.render("fill",pos,width,height,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");return this.nodeHelper.rectangle.contains(npos,pos,width,height)}},triangle:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.triangle.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.triangle.contains(npos,pos,dim)}},star:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.star.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.star.contains(npos,pos,dim)}}}),ForceDirected.Plot.EdgeTypes=new Class({none:$.empty,line:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);this.edgeHelper.line.render(from,to,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.line.contains(from,to,pos,this.edge.epsilon)}},arrow:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),dim=adj.getData("dim"),direction=adj.data.$direction,inv=direction&&direction.length>1&&direction[0]!=adj.nodeFrom.id;this.edgeHelper.arrow.render(from,to,dim,inv,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.arrow.contains(from,to,pos,this.edge.epsilon)}}})}($jit.ForceDirected),$jit.TM={};var TM=$jit.TM;$jit.TM.$extend=!0,TM.Base={layout:{orientation:"h",vertical:function(){return"v"==this.orientation},horizontal:function(){return"h"==this.orientation},change:function(){this.orientation=this.vertical()?"h":"v"}},initialize:function(controller){var config={orientation:"h",titleHeight:13,offset:2,levelsToShow:0,labelsToShow:[0,-1],constrained:!1,animate:!1,Node:{type:"rectangle",overridable:!0,width:3,height:3,color:"#444",props:"node-property:width:height"},Label:{textAlign:"center",textBaseline:"top"},Edge:{type:"none"},duration:700,fps:45};this.controller=this.config=$.merge(Options("Canvas","Node","Edge","Fx","Controller","Tips","NodeStyles","Events","Navigation","Label"),config,controller),this.layout.orientation=this.config.orientation;var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Complex,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new TM.Label[canvasConfig.Label.type](this),this.fx=new TM.Plot(this),this.op=new TM.Op(this),this.group=new TM.Group(this),this.geom=new TM.Geom(this),this.clickedNode=null,this.busy=!1,this.initializeExtras()},refresh:function(){if(!this.busy){this.busy=!0;var that=this;if(this.config.animate)this.compute("end"),this.geom.setRightLevelToShow(this.graph.getNode(this.clickedNode&&this.clickedNode.id||this.root)),this.fx.animate($.merge(this.config,{modes:["linear",this.config.Node.props],onComplete:function(){that.busy=!1}}));else{var labelType=this.config.Label.type;"Native"!=labelType&&this.graph.eachNode(function(n){that.labels.hideLabel(n,!1)}),this.busy=!1,this.compute(),this.geom.setRightLevelToShow(this.graph.getNode(this.clickedNode&&this.clickedNode.id||this.root)),this.plot()}}},plot:function(){this.fx.plot()},leaf:function(n){return 0==n.getSubnodes([1,1],"ignore").length},enter:function(n){if(!this.busy){this.busy=!0;var that=this,config=this.config,graph=this.graph,clickedNode=n,previousClickedNode=this.clickedNode,callback={onComplete:function(){that.geom.setRightLevelToShow(n),config.request&&that.compute(),config.animate?(graph.nodeList.setData("alpha",0,"end"),n.eachSubgraph(function(n){n.setData("alpha",1,"end"),n.selected=!1},"ignore"),clickedNode.selected=!0,that.fx.animate({duration:that.config.duration/3,modes:["node-property:alpha"],onComplete:function(){that.clickedNode=clickedNode,that.compute("end"),that.clickedNode=previousClickedNode,that.fx.animate({duration:2*that.config.duration/3,modes:["linear",that.config.Node.props],onComplete:function(){that.busy=!1,that.clickedNode=clickedNode,that.geom.setRightLevelToShow(clickedNode)}})}})):(that.busy=!1,that.clickedNode=n,that.refresh())}};this.geom.setRightLevelToShow(n),config.request?this.requestNodes(clickedNode,callback):callback.onComplete()}},out:function(){if(!this.busy){this.busy=!0,this.events.hoveredNode=!1;var that=this,config=this.config,graph=this.graph,parents=graph.getNode(this.clickedNode&&this.clickedNode.id||this.root).getParents(),parent=parents[0],clickedNode=parent,previousClickedNode=this.clickedNode;if(!parent)return void(this.busy=!1);parent.selected=!0;var callback={onComplete:function(){previousClickedNode.selected=!1,that.clickedNode=parent,config.request?that.requestNodes(parent,{onComplete:function(){that.compute(),that.plot(),that.busy=!1}}):(that.compute(),that.plot(),that.busy=!1),that.geom.setRightLevelToShow(parent),that.plot()}};this.geom.setRightLevelToShow(parent),config.animate?(this.clickedNode=clickedNode,this.compute("end"),this.clickedNode=previousClickedNode,this.fx.animate({duration:2*this.config.duration/3,modes:["linear",this.config.Node.props],onComplete:function(){that.clickedNode=clickedNode,clickedNode.eachSubgraph(function(n){n.setDataset(["current","end"],{alpha:[0,1]})},"ignore"),previousClickedNode.eachSubgraph(function(node){node.setData("alpha",1)},"ignore"),that.geom.setRightLevelToShow(parent),that.fx.animate({duration:that.config.duration/3,modes:["node-property:alpha"],onComplete:function(){callback.onComplete()}})}})):callback.onComplete()}},requestNodes:function(node,onComplete){var handler=$.merge(this.controller,onComplete),lev=this.config.levelsToShow;if(handler.request){var leaves=[],d=node._depth;node.eachLevel(0,lev,function(n){var nodeLevel=lev-(n._depth-d);n.drawn&&!n.anySubnode()&&nodeLevel>0&&(leaves.push(n),n._level=nodeLevel)}),this.group.requestNodes(leaves,handler)}else handler.onComplete()},reposition:function(){this.compute("end")}},TM.Op=new Class({Implements:Graph.Op,initialize:function(viz){this.viz=viz}}),TM.Geom=new Class({Implements:Graph.Geom,getRightLevelToShow:function(){return this.viz.config.levelsToShow},setRightLevelToShow:function(node){var level=this.getRightLevelToShow(),labelRange=this.viz.config.labelsToShow,fx=this.viz.labels,dump={};node.eachLevel(0,!1,function(n){var d=n._depth-node._depth;n._hideLabel=labelRange[0]>=0&&d<labelRange[0]||labelRange[1]>=0&&d>labelRange[1],level>0&&d>level?(n.drawn=!1,n.exist=!1,n.ignore=!0,fx.hideLabel(n,!1)):(n.drawn=!0,n.exist=!0,delete n.ignore),dump[n.name]=n._hideLabel}),node.drawn=!0,delete node.ignore}}),TM.Group=new Class({initialize:function(viz){this.viz=viz,this.canvas=viz.canvas,this.config=viz.config},requestNodes:function(nodes,controller){var counter=0,len=nodes.length,nodeSelected={},complete=function(){controller.onComplete()},viz=this.viz;0==len&&complete();for(var i=0;len>i;i++)nodeSelected[nodes[i].id]=nodes[i],controller.request(nodes[i].id,nodes[i]._level,{onComplete:function(nodeId,data){data&&data.children&&(data.id=nodeId,viz.op.sum(data,{type:"nothing"})),++counter==len&&(viz.graph.computeLevels(viz.root,0),complete())}})}}),TM.Plot=new Class({Implements:Graph.Plot,initialize:function(viz){this.viz=viz,this.config=viz.config,this.node=this.config.Node,this.edge=this.config.Edge,this.animation=new Animation,this.nodeTypes=new TM.Plot.NodeTypes,this.edgeTypes=new TM.Plot.EdgeTypes,this.labels=viz.labels},plot:function(opt,animating){var viz=this.viz,graph=viz.graph;viz.canvas.clear(),this.plotTree(graph.getNode(viz.clickedNode&&viz.clickedNode.id||viz.root),$.merge(viz.config,opt||{},{withLabels:!0,hideLabels:!1,plotSubtree:function(n,ch){return n.anySubnode("exist")}}),animating)}}),TM.Label={},TM.Label.Native=new Class({Implements:Graph.Label.Native,initialize:function(viz){this.config=viz.config,this.leaf=viz.leaf},renderLabel:function(canvas,node,controller){if(!node._hideLabel&&(this.leaf(node)||this.config.titleHeight)){var pos=node.pos.getc(!0),ctx=canvas.getCtx(),width=node.getData("width"),x=(node.getData("height"),pos.x+width/2),y=pos.y;isNaN(width)||0===width?ctx.fillText(node.name,x,y):ctx.fillText(node.name,x,y,width)}}}),TM.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz,this.leaf=viz.leaf,this.config=viz.config},placeLabel:function(tag,node,controller){controller=controller||this.viz.controller;var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y),(node._hideLabel||!this.leaf(node)&&!this.config.titleHeight)&&(tag.style.display="none"),controller.onPlaceLabel(tag,node)}}),TM.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz,this.leaf=viz.leaf,this.config=viz.config},placeLabel:function(tag,node,controller){controller=controller||this.viz.controller;var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.width=Math.max(0,node.getData("width")*sx)+"px",style.height=Math.max(0,node.getData("height")*sy)+"px",style.zIndex=100*node._depth,style.display="",(node._hideLabel||!this.leaf(node)&&!this.config.titleHeight)&&(tag.style.display="none"),controller.onPlaceLabel(tag,node)}}),TM.Plot.NodeTypes=new Class({none:{render:$.empty},rectangle:{render:function(node,canvas,animating){var leaf=this.viz.leaf(node),config=this.config,offst=config.offset,titleHeight=config.titleHeight,pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height"),border=node.getData("border"),ctx=canvas.getCtx(),posx=pos.x+offst/2,posy=pos.y+offst/2;if(!(offst>=width||offst>=height))if(leaf){if(config.cushion){var lg=ctx.createRadialGradient(posx+(width-offst)/2,posy+(height-offst)/2,1,posx+(width-offst)/2,posy+(height-offst)/2,height>width?height:width),color=node.getData("color"),colorGrad=$.rgbToHex($.map($.hexToRgb(color),function(r){return.2*r>>0}));lg.addColorStop(0,color),lg.addColorStop(1,colorGrad),ctx.fillStyle=lg}ctx.fillRect(posx,posy,width-offst,height-offst),border&&(ctx.save(),ctx.strokeStyle=border,ctx.strokeRect(posx,posy,width-offst,height-offst),ctx.restore())}else titleHeight>0&&(ctx.fillRect(pos.x+offst/2,pos.y+offst/2,width-offst,titleHeight-offst),border&&(ctx.save(),ctx.strokeStyle=border,ctx.strokeRect(pos.x+offst/2,pos.y+offst/2,width-offst,height-offst),ctx.restore()))},contains:function(node,pos){if(this.viz.clickedNode&&!node.isDescendantOf(this.viz.clickedNode.id)||node.ignore)return!1;var npos=node.pos.getc(!0),width=node.getData("width"),leaf=this.viz.leaf(node),height=leaf?node.getData("height"):this.config.titleHeight;return this.nodeHelper.rectangle.contains({x:npos.x+width/2,y:npos.y+height/2},pos,width,height)}}}),TM.Plot.EdgeTypes=new Class({none:$.empty}),TM.SliceAndDice=new Class({Implements:[Loader,Extras,TM.Base,Layouts.TM.SliceAndDice]}),TM.Squarified=new Class({Implements:[Loader,Extras,TM.Base,Layouts.TM.Squarified]}),TM.Strip=new Class({Implements:[Loader,Extras,TM.Base,Layouts.TM.Strip]}),$jit.RGraph=new Class({Implements:[Loader,Extras,Layouts.Radial],initialize:function(controller){var $RGraph=$jit.RGraph,config={interpolation:"linear",levelDistance:100};this.controller=this.config=$.merge(Options("Canvas","Node","Edge","Fx","Controller","Tips","NodeStyles","Events","Navigation","Label"),config,controller);var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Polar,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new $RGraph.Label[canvasConfig.Label.type](this),this.fx=new $RGraph.Plot(this,$RGraph),this.op=new $RGraph.Op(this),this.json=null,this.root=null,this.busy=!1,this.parent=!1,this.initializeExtras()},createLevelDistanceFunc:function(){var ld=this.config.levelDistance;return function(elem){return(elem._depth+1)*ld}},refresh:function(){this.compute(),this.plot()},reposition:function(){this.compute("end")},plot:function(){this.fx.plot()},getNodeAndParentAngle:function(id){var theta=!1,n=this.graph.getNode(id),ps=n.getParents(),p=ps.length>0?ps[0]:!1;if(p){var posParent=p.pos.getc(),posChild=n.pos.getc(),newPos=posParent.add(posChild.scale(-1));theta=Math.atan2(newPos.y,newPos.x),0>theta&&(theta+=2*Math.PI)}return{parent:p,theta:theta}},tagChildren:function(par,id){if(par.angleSpan){var adjs=[];par.eachAdjacency(function(elem){adjs.push(elem.nodeTo)},"ignore");for(var len=adjs.length,i=0;len>i&&id!=adjs[i].id;i++);for(var j=(i+1)%len,k=0;id!=adjs[j].id;j=(j+1)%len)adjs[j].dist=k++}},onClick:function(id,opt){if(this.root!=id&&!this.busy){this.busy=!0,this.root=id;var that=this;this.controller.onBeforeCompute(this.graph.getNode(id));var obj=this.getNodeAndParentAngle(id);this.tagChildren(obj.parent,id),this.parent=obj.parent,this.compute("end");var thetaDiff=obj.theta-obj.parent.endPos.theta;this.graph.eachNode(function(elem){elem.endPos.set(elem.endPos.getp().add($P(thetaDiff,0)))});var mode=this.config.interpolation;opt=$.merge({onComplete:$.empty},opt||{}),this.fx.animate($.merge({hideLabels:!0,modes:[mode]},opt,{onComplete:function(){that.busy=!1,opt.onComplete()}}))}}}),$jit.RGraph.$extend=!0,function(RGraph){RGraph.Op=new Class({Implements:Graph.Op}),RGraph.Plot=new Class({Implements:Graph.Plot}),RGraph.Label={},RGraph.Label.Native=new Class({Implements:Graph.Label.Native}),RGraph.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y),controller.onPlaceLabel(tag,node)}}),RGraph.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),labelPos={x:Math.round(pos.x*sx+ox+radius.width/2),y:Math.round(pos.y*sy+oy+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),RGraph.Plot.NodeTypes=new Class({none:{render:$.empty,contains:$.lambda(!1)},circle:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.circle.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.circle.contains(npos,pos,dim)}},ellipse:{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");this.nodeHelper.ellipse.render("fill",pos,width,height,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");return this.nodeHelper.ellipse.contains(npos,pos,width,height)}},square:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.square.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.square.contains(npos,pos,dim)}},rectangle:{render:function(node,canvas){var pos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");this.nodeHelper.rectangle.render("fill",pos,width,height,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),width=node.getData("width"),height=node.getData("height");return this.nodeHelper.rectangle.contains(npos,pos,width,height)}},triangle:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.triangle.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.triangle.contains(npos,pos,dim)}},star:{render:function(node,canvas){var pos=node.pos.getc(!0),dim=node.getData("dim");this.nodeHelper.star.render("fill",pos,dim,canvas)},contains:function(node,pos){var npos=node.pos.getc(!0),dim=node.getData("dim");return this.nodeHelper.star.contains(npos,pos,dim)}}}),RGraph.Plot.EdgeTypes=new Class({none:$.empty,line:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);this.edgeHelper.line.render(from,to,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.line.contains(from,to,pos,this.edge.epsilon)}},arrow:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),dim=adj.getData("dim"),direction=adj.data.$direction,inv=direction&&direction.length>1&&direction[0]!=adj.nodeFrom.id,arrowPosition=this.edge.arrowPosition||"end";this.edgeHelper.arrow.render(from,to,dim,inv,canvas,arrowPosition)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0);return this.edgeHelper.arrow.contains(from,to,pos,this.edge.epsilon)}}})}($jit.RGraph),Complex.prototype.moebiusTransformation=function(c){var num=this.add(c),den=c.$conjugate().$prod(this);return den.x++,num.$div(den)},Graph.Util.moebiusTransformation=function(graph,pos,prop,startPos,flags){this.eachNode(graph,function(elem){for(var i=0;i<prop.length;i++){var p=pos[i].scale(-1),property=startPos?startPos:prop[i];elem.getPos(prop[i]).set(elem.getPos(property).getc().moebiusTransformation(p))}},flags)},$jit.Hypertree=new Class({Implements:[Loader,Extras,Layouts.Radial],initialize:function(controller){var $Hypertree=$jit.Hypertree,config={radius:"auto",offset:0,Edge:{type:"hyperline"},duration:1500,fps:35};this.controller=this.config=$.merge(Options("Canvas","Node","Edge","Fx","Tips","NodeStyles","Events","Navigation","Controller","Label"),config,controller);var canvasConfig=this.config;canvasConfig.useCanvas?(this.canvas=canvasConfig.useCanvas,this.config.labelContainer=this.canvas.id+"-label"):(canvasConfig.background&&(canvasConfig.background=$.merge({type:"Circles"},canvasConfig.background)),this.canvas=new Canvas(this,canvasConfig),this.config.labelContainer=("string"==typeof canvasConfig.injectInto?canvasConfig.injectInto:canvasConfig.injectInto.id)+"-label"),this.graphOptions={klass:Polar,Node:{selected:!1,exist:!0,drawn:!0}},this.graph=new Graph(this.graphOptions,this.config.Node,this.config.Edge),this.labels=new $Hypertree.Label[canvasConfig.Label.type](this),this.fx=new $Hypertree.Plot(this,$Hypertree),this.op=new $Hypertree.Op(this),this.json=null,this.root=null,this.busy=!1,this.initializeExtras()},createLevelDistanceFunc:function(){var r=this.getRadius(),depth=0,max=Math.max,config=this.config;this.graph.eachNode(function(node){depth=max(node._depth,depth)},"ignore"),depth++;for(var genDistFunc=function(a){return function(node){node.scale=r;for(var d=node._depth+1,acum=0,pow=Math.pow;d;)acum+=pow(a,d--);return acum-config.offset}},i=.51;1>=i;i+=.01){var valSeries=(1-Math.pow(i,depth))/(1-i);if(valSeries>=2)return genDistFunc(i-.01)}return genDistFunc(.75)},getRadius:function(){var rad=this.config.radius;if("auto"!==rad)return rad;var s=this.canvas.getSize();return Math.min(s.width,s.height)/2},refresh:function(reposition){reposition?(this.reposition(),this.graph.eachNode(function(node){node.startPos.rho=node.pos.rho=node.endPos.rho,node.startPos.theta=node.pos.theta=node.endPos.theta})):this.compute(),this.plot()},reposition:function(){this.compute("end");var vector=this.graph.getNode(this.root).pos.getc().scale(-1);Graph.Util.moebiusTransformation(this.graph,[vector],["end"],"end","ignore"),this.graph.eachNode(function(node){node.ignore&&(node.endPos.rho=node.pos.rho,node.endPos.theta=node.pos.theta)})},plot:function(){this.fx.plot()},onClick:function(id,opt){var pos=this.graph.getNode(id).pos.getc(!0);this.move(pos,opt)},move:function(pos,opt){var versor=$C(pos.x,pos.y);if(this.busy===!1&&versor.norm()<1){this.busy=!0;var root=this.graph.getClosestNodeToPos(versor),that=this;this.graph.computeLevels(root.id,0),this.controller.onBeforeCompute(root),opt=$.merge({onComplete:$.empty},opt||{}),this.fx.animate($.merge({modes:["moebius"],hideLabels:!0},opt,{onComplete:function(){that.busy=!1,opt.onComplete()}}),versor)}}}),$jit.Hypertree.$extend=!0,function(Hypertree){Hypertree.Op=new Class({Implements:Graph.Op}),Hypertree.Plot=new Class({Implements:Graph.Plot}),Hypertree.Label={},Hypertree.Label.Native=new Class({Implements:Graph.Label.Native,initialize:function(viz){this.viz=viz},renderLabel:function(canvas,node,controller){var ctx=canvas.getCtx(),coord=node.pos.getc(!0),s=this.viz.getRadius();ctx.fillText(node.name,coord.x*s,coord.y*s)}}),Hypertree.Label.SVG=new Class({Implements:Graph.Label.SVG,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),r=this.viz.getRadius(),labelPos={x:Math.round(pos.x*sx*r+ox+radius.width/2),y:Math.round(pos.y*sy*r+oy+radius.height/2)};tag.setAttribute("x",labelPos.x),tag.setAttribute("y",labelPos.y),controller.onPlaceLabel(tag,node)}}),Hypertree.Label.HTML=new Class({Implements:Graph.Label.HTML,initialize:function(viz){this.viz=viz},placeLabel:function(tag,node,controller){var pos=node.pos.getc(!0),canvas=this.viz.canvas,ox=canvas.translateOffsetX,oy=canvas.translateOffsetY,sx=canvas.scaleOffsetX,sy=canvas.scaleOffsetY,radius=canvas.getSize(),r=this.viz.getRadius(),labelPos={x:Math.round(pos.x*sx*r+ox+radius.width/2),y:Math.round(pos.y*sy*r+oy+radius.height/2)},style=tag.style;style.left=labelPos.x+"px",style.top=labelPos.y+"px",style.display=this.fitsInCanvas(labelPos,canvas)?"":"none",controller.onPlaceLabel(tag,node)}}),Hypertree.Plot.NodeTypes=new Class({none:{render:$.empty,contains:$.lambda(!1)},circle:{render:function(node,canvas){var nconfig=this.node,dim=node.getData("dim"),p=node.pos.getc();dim=nconfig.transform?dim*(1-p.squaredNorm()):dim,p.$scale(node.scale),dim>.2&&this.nodeHelper.circle.render("fill",p,dim,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.circle.contains(npos,pos,dim)}},ellipse:{render:function(node,canvas){var pos=node.pos.getc().$scale(node.scale),width=node.getData("width"),height=node.getData("height");this.nodeHelper.ellipse.render("fill",pos,width,height,canvas)},contains:function(node,pos){var width=node.getData("width"),height=node.getData("height"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.circle.contains(npos,pos,width,height)}},square:{render:function(node,canvas){var nconfig=this.node,dim=node.getData("dim"),p=node.pos.getc();dim=nconfig.transform?dim*(1-p.squaredNorm()):dim,p.$scale(node.scale),dim>.2&&this.nodeHelper.square.render("fill",p,dim,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.square.contains(npos,pos,dim)}},rectangle:{render:function(node,canvas){var nconfig=this.node,width=node.getData("width"),height=node.getData("height"),pos=node.pos.getc();width=nconfig.transform?width*(1-pos.squaredNorm()):width,height=nconfig.transform?height*(1-pos.squaredNorm()):height,pos.$scale(node.scale),width>.2&&height>.2&&this.nodeHelper.rectangle.render("fill",pos,width,height,canvas)},contains:function(node,pos){var width=node.getData("width"),height=node.getData("height"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.rectangle.contains(npos,pos,width,height)}},triangle:{render:function(node,canvas){var nconfig=this.node,dim=node.getData("dim"),p=node.pos.getc();dim=nconfig.transform?dim*(1-p.squaredNorm()):dim,p.$scale(node.scale),dim>.2&&this.nodeHelper.triangle.render("fill",p,dim,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.triangle.contains(npos,pos,dim)}},star:{render:function(node,canvas){var nconfig=this.node,dim=node.getData("dim"),p=node.pos.getc();dim=nconfig.transform?dim*(1-p.squaredNorm()):dim,p.$scale(node.scale),dim>.2&&this.nodeHelper.star.render("fill",p,dim,canvas)},contains:function(node,pos){var dim=node.getData("dim"),npos=node.pos.getc().$scale(node.scale);return this.nodeHelper.star.contains(npos,pos,dim)}}}),Hypertree.Plot.EdgeTypes=new Class({none:$.empty,line:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),r=adj.nodeFrom.scale;this.edgeHelper.line.render({x:from.x*r,y:from.y*r},{x:to.x*r,y:to.y*r},canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),r=adj.nodeFrom.scale;this.edgeHelper.line.contains({x:from.x*r,y:from.y*r},{x:to.x*r,y:to.y*r},pos,this.edge.epsilon)}},arrow:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),r=adj.nodeFrom.scale,dim=adj.getData("dim"),direction=adj.data.$direction,inv=direction&&direction.length>1&&direction[0]!=adj.nodeFrom.id;this.edgeHelper.arrow.render({x:from.x*r,y:from.y*r},{x:to.x*r,y:to.y*r},dim,inv,canvas)},contains:function(adj,pos){var from=adj.nodeFrom.pos.getc(!0),to=adj.nodeTo.pos.getc(!0),r=adj.nodeFrom.scale;this.edgeHelper.arrow.contains({x:from.x*r,y:from.y*r},{x:to.x*r,y:to.y*r},pos,this.edge.epsilon)}},hyperline:{render:function(adj,canvas){var from=adj.nodeFrom.pos.getc(),to=adj.nodeTo.pos.getc(),dim=this.viz.getRadius();this.edgeHelper.hyperline.render(from,to,dim,canvas)},contains:$.lambda(!1)}})}($jit.Hypertree)}();