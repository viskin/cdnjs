(function(d,e){d.support.htmlMenuitem=("HTMLMenuItemElement" in window);d.support.htmlCommand=("HTMLCommandElement" in window);var q=null,c=false,a=false,o=d(window),i=0,h={},m={},l={},j={selector:null,appendTo:null,trigger:"right",autoHide:false,ignoreRightClick:false,delay:200,determinePosition:function(s){if(d.ui&&d.ui.position){s.css("display","block").position({my:"center top",at:"center bottom",of:this,offset:"0 5",collision:"fit"}).css("display","none")}else{var t=this.offset();t.top+=this.outerHeight();t.left+=this.outerWidth()/2-s.outerWidth()/2;s.css(t)}},position:function(u,B,z){var w=this,v;if(!B&&!z){u.determinePosition.call(this,u.$menu);return}else{if(B==="maintain"&&z==="maintain"){v=u.$menu.position()}else{var A=u.$trigger.parents().andSelf().filter(function(){return d(this).css("position")=="fixed"}).length;if(A){z-=o.scrollTop();B-=o.scrollLeft()}v={top:z,left:B}}}var s=o.scrollTop()+o.height(),C=o.scrollLeft()+o.width(),D=u.$menu.height(),t=u.$menu.width();if(v.top+D>s){v.top-=D}if(v.left+t>C){v.left-=t}u.$menu.css(v)},positionSubmenu:function(s){if(d.ui&&d.ui.position){s.css("display","block").position({my:"left top",at:"right top",of:this,collision:"fit"}).css("display","")}else{var t=this.offset();t.top+=0;t.left+=this.outerWidth();s.css(t)}},zIndex:1,animation:{duration:50,show:"slideDown",hide:"slideUp"},events:{show:d.noop,hide:d.noop},callback:null,items:{}},k={timer:null,pageX:null,pageY:null},f=function(u){var t=0,s=u;while(true){t=Math.max(t,parseInt(s.css("z-index"),10)||0);s=s.parent();if(!s||!s.length||s.prop("nodeName").toLowerCase()=="body"){break}}return t},r={abortevent:function(s){s.preventDefault();s.stopImmediatePropagation()},contextmenu:function(t){var s=d(this);t.preventDefault();t.stopImmediatePropagation();if(a){a=false;return}if(!s.hasClass("context-menu-disabled")){q=s;if(t.data.build){d.extend(true,t.data,j,t.data.build(q,t)||{});g.create(t.data)}g.show.call(s,t.data,t.pageX,t.pageY)}},click:function(s){s.preventDefault();s.stopImmediatePropagation();d(this).trigger(jQuery.Event("contextmenu",{data:s.data,pageX:s.pageX,pageY:s.pageY}))},mousedown:function(t){var s=d(this);if(q&&q.length&&!q.is(s)){q.data("contextMenu").$menu.trigger("contextmenu:hide")}if(t.button==2){q=s.data("contextMenuActive",true)}},mouseup:function(t){var s=d(this);if(s.data("contextMenuActive")&&q&&q.length&&q.is(s)&&!s.hasClass("context-menu-disabled")){t.preventDefault();t.stopImmediatePropagation();q=s;s.trigger(jQuery.Event("contextmenu",{data:t.data,pageX:t.pageX,pageY:t.pageY}))}s.removeData("contextMenuActive")},mouseenter:function(u){var t=d(this),s=d(u.relatedTarget),v=d(document);if(s.is(".context-menu-list")||s.closest(".context-menu-list").length){return}if(q&&q.length){return}k.pageX=u.pageX;k.pageY=u.pageY;k.data=u.data;v.on("mousemove.contextMenuShow",r.mousemove);k.timer=setTimeout(function(){k.timer=null;v.off("mousemove.contextMenuShow");q=t;t.trigger(jQuery.Event("contextmenu",{data:k.data,pageX:k.pageX,pageY:k.pageY}))},u.data.delay)},mousemove:function(s){k.pageX=s.pageX;k.pageY=s.pageY},mouseleave:function(t){var s=d(t.relatedTarget);if(s.is(".context-menu-list")||s.closest(".context-menu-list").length){return}try{clearTimeout(k.timer)}catch(t){}k.timer=null},ignoreRightClick:function(s){if(s.button==2){a=true}},layerClick:function(u){var t=d(this),s=t.data("contextMenuRoot");u.preventDefault();u.stopImmediatePropagation();t.remove();s.$menu.trigger("contextmenu:hide")},keyStop:function(t,s){if(!s.isInput){t.preventDefault()}t.stopPropagation()},key:function(x){var v=q.data("contextMenu")||{},t=v.$menu.children(),y;switch(x.keyCode){case 9:case 38:r.keyStop(x,v);if(v.isInput){if(x.keyCode==9&&x.shiftKey){x.preventDefault();v.$selected&&v.$selected.find("input, textarea, select").blur();v.$menu.trigger("prevcommand");return}else{if(x.keyCode==38&&v.$selected.find("input, textarea, select").prop("type")=="checkbox"){x.preventDefault();return}}}else{if(x.keyCode!=9||x.shiftKey){v.$menu.trigger("prevcommand");return}}case 9:case 40:r.keyStop(x,v);if(v.isInput){if(x.keyCode==9){x.preventDefault();v.$selected&&v.$selected.find("input, textarea, select").blur();v.$menu.trigger("nextcommand");return}else{if(x.keyCode==40&&v.$selected.find("input, textarea, select").prop("type")=="checkbox"){x.preventDefault();return}}}else{v.$menu.trigger("nextcommand");return}break;case 37:r.keyStop(x,v);if(v.isInput||!v.$selected||!v.$selected.length){break}if(!v.$selected.parent().hasClass("context-menu-root")){var w=v.$selected.parent().parent();v.$selected.trigger("contextmenu:blur");v.$selected=w;return}break;case 39:r.keyStop(x,v);if(v.isInput||!v.$selected||!v.$selected.length){break}var u=v.$selected.data("contextMenu")||{};if(u.$menu&&v.$selected.hasClass("context-menu-submenu")){v.$selected=null;u.$selected=null;u.$menu.trigger("nextcommand");return}break;case 35:case 36:if(v.$selected&&v.$selected.find("input, textarea, select").length){return}else{(v.$selected&&v.$selected.parent()||v.$menu).children(":not(.disabled, .not-selectable)")[x.keyCode==36?"first":"last"]().trigger("contextmenu:focus");x.preventDefault();return}break;case 13:r.keyStop(x,v);if(v.isInput){if(v.$selected&&!v.$selected.is("textarea, select")){x.preventDefault();return}break}v.$selected&&v.$selected.trigger("mouseup");return;case 32:case 33:case 34:r.keyStop(x,v);return;case 27:r.keyStop(x,v);v.$menu.trigger("contextmenu:hide");return;default:var s=(String.fromCharCode(x.keyCode)).toUpperCase();if(v.accesskeys[s]){v.accesskeys[s].$node.trigger(v.accesskeys[s].$menu?"contextmenu:focus":"mouseup");return}break}x.stopPropagation();v.$selected&&v.$selected.trigger(x)},prevItem:function(w){w.stopPropagation();var v=d(this).data("contextMenu")||{};if(v.$selected){var s=v.$selected;v=v.$selected.parent().data("contextMenu")||{};v.$selected=s}var u=v.$menu.children(),t=!v.$selected||!v.$selected.prev().length?u.last():v.$selected.prev(),y=t;while(t.hasClass("disabled")||t.hasClass("not-selectable")){if(t.prev().length){t=t.prev()}else{t=u.last()}if(t.is(y)){return}}if(v.$selected){r.itemMouseleave.call(v.$selected.get(0),w)}r.itemMouseenter.call(t.get(0),w);var x=t.find("input, textarea, select");if(x.length){x.focus()}},nextItem:function(w){w.stopPropagation();var v=d(this).data("contextMenu")||{};if(v.$selected){var s=v.$selected;v=v.$selected.parent().data("contextMenu")||{};v.$selected=s}var u=v.$menu.children(),t=!v.$selected||!v.$selected.next().length?u.first():v.$selected.next(),y=t;while(t.hasClass("disabled")||t.hasClass("not-selectable")){if(t.next().length){t=t.next()}else{t=u.first()}if(t.is(y)){return}}if(v.$selected){r.itemMouseleave.call(v.$selected.get(0),w)}r.itemMouseenter.call(t.get(0),w);var x=t.find("input, textarea, select");if(x.length){x.focus()}},focusInput:function(w){var v=d(this).closest(".context-menu-item"),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;s.$selected=t.$selected=v;s.isInput=t.isInput=true},blurInput:function(w){var v=d(this).closest(".context-menu-item"),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;s.isInput=t.isInput=false},menuMouseenter:function(t){var s=d(this).data().contextMenuRoot;s.hovering=true},menuMouseleave:function(t){var s=d(this).data().contextMenuRoot;if(s.$layer&&s.$layer.is(t.relatedTarget)){s.hovering=false}},itemMouseenter:function(w){var v=d(this),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;s.hovering=true;if(w&&s.$layer&&s.$layer.is(w.relatedTarget)){w.preventDefault();w.stopImmediatePropagation()}(t.$menu?t:s).$menu.children(".hover").trigger("contextmenu:blur");if(v.hasClass("disabled")||v.hasClass("not-selectable")){t.$selected=null;return}v.trigger("contextmenu:focus")},itemMouseleave:function(w){var v=d(this),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;if(s!==t&&s.$layer&&s.$layer.is(w.relatedTarget)){s.$selected&&s.$selected.trigger("contextmenu:blur");w.preventDefault();w.stopImmediatePropagation();s.$selected=t.$selected=t.$node;return}v.trigger("contextmenu:blur")},itemClick:function(x){var w=d(this),v=w.data(),u=v.contextMenu,s=v.contextMenuRoot,t=v.contextMenuKey,y;if(!u.items[t]||w.hasClass("disabled")){return}x.preventDefault();x.stopImmediatePropagation();if(d.isFunction(s.callbacks[t])){y=s.callbacks[t]}else{if(d.isFunction(s.callback)){y=s.callback}else{return}}if(y.call(s.$trigger,t,s)!==false){s.$menu.trigger("contextmenu:hide")}else{g.update.call(s.$trigger,s)}},inputClick:function(s){s.stopImmediatePropagation()},hideMenu:function(t){var s=d(this).data("contextMenuRoot");g.hide.call(s.$trigger,s)},focusItem:function(w){w.stopPropagation();var v=d(this),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;v.addClass("hover").siblings(".hover").trigger("contextmenu:blur");t.$selected=s.$selected=v;if(t.$node){s.positionSubmenu.call(t.$node,t.$menu)}},blurItem:function(w){w.stopPropagation();var v=d(this),u=v.data(),t=u.contextMenu,s=u.contextMenuRoot;v.removeClass("hover");t.$selected=null}},g={show:function(u,s,A){var v=d(this),w,t={};d("#context-menu-layer").trigger("mousedown");if(u.events.show.call(v,u)===false){q=null;return}u.$trigger=v;g.update.call(v,u);u.position.call(v,u,s,A);if(u.zIndex){t.zIndex=f(v)+u.zIndex}g.layer.call(u.$menu,u,t.zIndex);u.$menu.find("ul").css("zIndex",t.zIndex+1);u.$menu.css(t)[u.animation.show](u.animation.duration);v.data("contextMenu",u);d(document).off("keydown.contextMenu").on("keydown.contextMenu",r.key);if(u.autoHide){var z=v.position();z.right=z.left+v.outerWidth();z.bottom=z.top+this.outerHeight();d(document).on("mousemove.contextMenuAutoHide",function(x){if(u.$layer&&!u.hovering&&(!(x.pageX>=z.left&&x.pageX<=z.right)||!(x.pageY>=z.top&&x.pageY<=z.bottom))){u.$layer.trigger("mousedown")}})}},hide:function(s){var u=d(this);if(!s){s=u.data("contextMenu")||{}}if(s.events&&s.events.hide.call(u,s)===false){return}if(s.$layer){try{s.$layer.remove();delete s.$layer}catch(t){s.$layer=null}}q=null;s.$menu.find(".hover").trigger("contextmenu:blur");s.$selected=null;d(document).off(".contextMenuAutoHide").off("keydown.contextMenu");s.$menu&&s.$menu[s.animation.hide](s.animation.duration);if(s.build){s.$menu.remove();d.each(s,function(v,w){switch(v){case"ns":case"selector":case"build":case"trigger":case"ignoreRightClick":return true;default:s[v]=e;try{delete s[v]}catch(x){}return true}})}},create:function(t,s){if(s===e){s=t}t.$menu=d('<ul class="context-menu-list '+(t.className||"")+'"></ul>').data({contextMenu:t,contextMenuRoot:s});d.each(["callbacks","commands","inputs"],function(v,u){t[u]={};if(!s[u]){s[u]={}}});s.accesskeys||(s.accesskeys={});d.each(t.items,function(w,x){var B=d('<li class="context-menu-item '+(x.className||"")+'"></li>'),u=null,A=null;x.$node=B.data({contextMenu:t,contextMenuRoot:s,contextMenuKey:w});if(x.accesskey){var y=n(x.accesskey);for(var v=0,z;z=y[v];v++){if(!s.accesskeys[z]){s.accesskeys[z]=x;x._name=x.name.replace(new RegExp("("+z+")","i"),'<span class="context-menu-accesskey">$1</span>');break}}}if(typeof x=="string"){B.addClass("context-menu-separator not-selectable")}else{if(x.type&&l[x.type]){l[x.type].call(B,x,t,s);d.each([t,s],function(D,C){C.commands[w]=x;if(d.isFunction(x.callback)){C.callbacks[w]=x.callback}})}else{if(x.type=="html"){B.addClass("context-menu-html not-selectable")}else{if(x.type){u=d("<label></label>").appendTo(B);d("<span></span>").html(x._name||x.name).appendTo(u);B.addClass("context-menu-input");t.hasTypes=true;d.each([t,s],function(D,C){C.commands[w]=x;C.inputs[w]=x})}else{if(x.items){x.type="sub"}}}switch(x.type){case"text":A=d('<input type="text" value="1" name="context-menu-input-'+w+'" value="">').val(x.value||"").appendTo(u);break;case"textarea":A=d('<textarea name="context-menu-input-'+w+'"></textarea>').val(x.value||"").appendTo(u);if(x.height){A.height(x.height)}break;case"checkbox":A=d('<input type="checkbox" value="1" name="context-menu-input-'+w+'" value="">').val(x.value||"").prop("checked",!!x.selected).prependTo(u);break;case"radio":A=d('<input type="radio" value="1" name="context-menu-input-'+x.radio+'" value="">').val(x.value||"").prop("checked",!!x.selected).prependTo(u);break;case"select":A=d('<select name="context-menu-input-'+w+'">').appendTo(u);if(x.options){d.each(x.options,function(C,D){d("<option></option>").val(C).text(D).appendTo(A)});A.val(x.selected)}break;case"sub":d("<span></span>").html(x._name||x.name).appendTo(B);x.appendTo=x.$node;g.create(x,s);B.data("contextMenu",x).addClass("context-menu-submenu");x.callback=null;break;case"html":d(x.html).appendTo(B);break;default:d.each([t,s],function(D,C){C.commands[w]=x;if(d.isFunction(x.callback)){C.callbacks[w]=x.callback}});d("<span></span>").html(x._name||x.name||"").appendTo(B);break}if(x.type&&x.type!="sub"&&x.type!="html"){A.on("focus",r.focusInput).on("blur",r.blurInput);if(x.events){A.on(x.events)}}if(x.icon){B.addClass("icon icon-"+x.icon)}}}x.$input=A;x.$label=u;B.appendTo(t.$menu);if(!t.hasTypes){if(d.browser.msie){B.on("selectstart.disableTextSelect",r.abortevent)}else{if(!d.browser.mozilla){B.on("mousedown.disableTextSelect",r.abortevent)}}}});if(!t.$node){t.$menu.css("display","none").addClass("context-menu-root")}t.$menu.appendTo(t.appendTo||document.body)},update:function(t,s){var u=this;if(s===e){s=t;t.$menu.find("ul").andSelf().css({position:"static",display:"block"}).each(function(){var v=d(this);v.width(v.css("position","absolute").width()).css("position","static")}).css({position:"",display:""})}t.$menu.children().each(function(){var v=d(this),w=v.data("contextMenuKey"),y=t.items[w],x=(d.isFunction(y.disabled)&&y.disabled.call(u,w,s))||y.disabled===true;v[x?"addClass":"removeClass"]("disabled");if(y.type){v.find("input, select, textarea").prop("disabled",x);switch(y.type){case"text":case"textarea":y.$input.val(y.value||"");break;case"checkbox":case"radio":y.$input.val(y.value||"").prop("checked",!!y.selected);break;case"select":y.$input.val(y.selected||"");break}}if(y.$menu){g.update.call(u,y,s)}})},layer:function(s,t){return s.$layer=d('<div id="context-menu-layer" style="position:fixed; z-index:'+t+'; top:0; left:0; opacity: 0; filter: alpha(opacity=0); background-color: #000;"></div>').css({height:o.height(),width:o.width(),display:"block"}).data("contextMenuRoot",s).insertBefore(this).on("mousedown",r.layerClick)}};function n(x){var v=x.split(/\s+/),w=[];for(var u=0,s;s=v[u];u++){s=s[0].toUpperCase();w.push(s)}return w}d.fn.contextMenu=function(s){if(s===e){this.first().trigger("contextmenu")}else{if(s.x&&s.y){this.first().trigger(jQuery.Event("contextmenu",{pageX:s.x,pageY:s.y}))}else{if(s==="hide"){var t=this.data("contextMenu").$menu;t&&t.trigger("contextmenu:hide")}else{if(s){this.removeClass("context-menu-disabled")}else{if(!s){this.addClass("context-menu-disabled")}}}}}return this};d.contextMenu=function(s,t){if(typeof s!="string"){t=s;s="create"}if(typeof t=="string"){t={selector:t}}else{if(t===e){t={}}}var w=d.extend(true,{},j,t||{}),u=u=d(document);switch(s){case"create":if(!w.selector){throw new Error("No selector specified")}if(w.selector.match(/.context-menu-(list|item|input)($|\s)/)){throw new Error('Cannot bind to selector "'+w.selector+'" as it contains a reserved className')}if(!w.build&&(!w.items||d.isEmptyObject(w.items))){throw new Error("No Items sepcified")}i++;w.ns=".contextMenu"+i;h[w.selector]=w.ns;m[w.ns]=w;if(!c){u.on({"contextmenu:hide.contextMenu":r.hideMenu,"prevcommand.contextMenu":r.prevItem,"nextcommand.contextMenu":r.nextItem,"contextmenu.contextMenu":r.abortevent,"mouseenter.contextMenu":r.menuMouseenter,"mouseleave.contextMenu":r.menuMouseleave},".context-menu-list").on("mouseup.contextMenu",".context-menu-input",r.inputClick).on({"mouseup.contextMenu":r.itemClick,"contextmenu:focus.contextMenu":r.focusItem,"contextmenu:blur.contextMenu":r.blurItem,"contextmenu.contextMenu":r.abortevent,"mouseenter.contextMenu":r.itemMouseenter,"mouseleave.contextMenu":r.itemMouseleave},".context-menu-item");c=true}u.on("contextmenu"+w.ns,w.selector,w,r.contextmenu);switch(w.trigger){case"hover":u.on("mouseenter"+w.ns,w.selector,w,r.mouseenter).on("mouseleave"+w.ns,w.selector,w,r.mouseleave);break;case"left":u.on("click"+w.ns,w.selector,w,r.click);break}if(w.trigger!="hover"&&w.ignoreRightClick){u.on("mousedown"+w.ns,w.selector,r.ignoreRightClick)}if(!w.build){g.create(w)}break;case"destroy":if(!w.selector){u.off(".contextMenu .contextMenuAutoHide");d.each(h,function(x,y){u.off(y)});h={};m={};i=0;c=false;d(".context-menu-list").remove()}else{if(h[w.selector]){try{if(m[h[w.selector]].$menu){m[h[w.selector]].$menu.remove()}delete m[h[w.selector]]}catch(v){m[h[w.selector]]=null}u.off(h[w.selector])}}break;case"html5":if((!d.support.htmlCommand&&!d.support.htmlMenuitem)||(typeof t=="boolean"&&t)){d('menu[type="context"]').each(function(){if(this.id){d.contextMenu({selector:"[contextmenu="+this.id+"]",items:d.contextMenu.fromMenu(this)})}}).css("display","none")}break;default:throw new Error('Unknown operation "'+s+'"')}return this};d.contextMenu.setInputValues=function(s,t){if(t===e){t={}}d.each(s.inputs,function(u,v){switch(v.type){case"text":case"textarea":v.value=t[u]||"";break;case"checkbox":v.selected=t[u]?true:false;break;case"radio":v.selected=(t[v.radio]||"")==v.value?true:false;break;case"select":v.selected=t[u]||"";break}})};d.contextMenu.getInputValues=function(s,t){if(t===e){t={}}d.each(s.inputs,function(u,v){switch(v.type){case"text":case"textarea":case"select":t[u]=v.$input.val();break;case"checkbox":t[u]=v.$input.prop("checked");break;case"radio":if(v.$input.prop("checked")){t[v.radio]=v.value}break}});return t};function p(s){return(s.id&&d('label[for="'+s.id+'"]').val())||s.name}function b(u,t,s){if(!s){s=0}t.each(function(){var v=d(this),y=this,z=this.nodeName.toLowerCase(),w,x;if(z=="label"&&v.find("input, textarea, select").length){w=v.text();v=v.children().first();y=v.get(0);z=y.nodeName.toLowerCase()}switch(z){case"menu":x={name:v.attr("label"),items:{}};b(x.items,v.children(),s);break;case"a":case"button":x={name:v.text(),disabled:!!v.attr("disabled"),callback:(function(){return function(){v.click()}})()};break;case"menuitem":case"command":switch(v.attr("type")){case e:case"command":case"menuitem":x={name:v.attr("label"),disabled:!!v.attr("disabled"),callback:(function(){return function(){v.click()}})()};break;case"checkbox":x={type:"checkbox",disabled:!!v.attr("disabled"),name:v.attr("label"),selected:!!v.attr("checked")};break;case"radio":x={type:"radio",disabled:!!v.attr("disabled"),name:v.attr("label"),radio:v.attr("radiogroup"),value:v.attr("id"),selected:!!v.attr("checked")};break;default:x=e}break;case"hr":x="-------";break;case"input":switch(v.attr("type")){case"text":x={type:"text",name:w||p(y),disabled:!!v.attr("disabled"),value:v.val()};break;case"checkbox":x={type:"checkbox",name:w||p(y),disabled:!!v.attr("disabled"),selected:!!v.attr("checked")};break;case"radio":x={type:"radio",name:w||p(y),disabled:!!v.attr("disabled"),radio:!!v.attr("name"),value:v.val(),selected:!!v.attr("checked")};break;default:x=e;break}break;case"select":x={type:"select",name:w||p(y),disabled:!!v.attr("disabled"),selected:v.val(),options:{}};v.children().each(function(){x.options[this.value]=d(this).text()});break;case"textarea":x={type:"textarea",name:w||p(y),disabled:!!v.attr("disabled"),value:v.val()};break;case"label":break;default:x={type:"html",html:v.clone(true)};break}if(x){s++;u["key"+s]=x}})}d.contextMenu.fromMenu=function(t){var u=d(t),s={};b(s,u.children());return s};d.contextMenu.defaults=j;d.contextMenu.types=l})(jQuery);